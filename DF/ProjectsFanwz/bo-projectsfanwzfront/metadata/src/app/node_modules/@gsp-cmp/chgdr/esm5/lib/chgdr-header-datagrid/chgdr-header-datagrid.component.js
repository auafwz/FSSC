/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { ChangeDetectorRef, Component, EventEmitter, HostBinding, Injector, Input, Output, TemplateRef, ViewChild } from '@angular/core';
import { DialogComponent } from '@farris/ui-dialog';
import { MessagerService } from '@farris/ui-messager';
import { NotifyService } from '@farris/ui-notify';
import { ChgdrService } from '../service/chgdr.service';
import { ChangeDataQueryResult } from '../model/change-data-query-result';
import { ErrorUtil } from '../util/error.util';
import { tap } from 'rxjs/operators';
import { forkJoin, of } from 'rxjs';
import { MapUtil } from '../util/map.util';
import { ChgdrInnerService } from '../service/chgdr-inner.service';
var ChgdrHeaderDatagridComponent = /** @class */ (function () {
    function ChgdrHeaderDatagridComponent(chgdrService, messageService, notifyService, ref, chgdrInnerService, injector) {
        this.chgdrService = chgdrService;
        this.messageService = messageService;
        this.notifyService = notifyService;
        this.ref = ref;
        this.chgdrInnerService = chgdrInnerService;
        this.injector = injector;
        this.baseCls = true;
        this.showDataId = true;
        this.headers = [];
        this.dataCodeFields = [];
        this.pageChanged = new EventEmitter();
        this.pageSizeChanged = new EventEmitter();
    }
    /**
     * @return {?}
     */
    ChgdrHeaderDatagridComponent.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        this.resetColumnAndData(null, []);
    };
    /**
     * @param {?} changes
     * @return {?}
     */
    ChgdrHeaderDatagridComponent.prototype.ngOnChanges = /**
     * @param {?} changes
     * @return {?}
     */
    function (changes) {
        var _this = this;
        if (!changes.chgdrs) {
            //如果chgdrs没有更新，则直接返回
            return;
        }
        /** @type {?} */
        var prevEntityId = this.getEntityId(changes.chgdrs.previousValue);
        /** @type {?} */
        var curEntityId = this.getEntityId(changes.chgdrs.currentValue);
        /** @type {?} */
        var requests = [
            this.updateChgdrConfigHandler(curEntityId),
            this.updateDataCodeFields(prevEntityId, curEntityId)
        ];
        forkJoin(requests).subscribe((/**
         * @param {?} data
         * @return {?}
         */
        function (data) {
            /** @type {?} */
            var chgdrDatas = changes.chgdrs.currentValue;
            if (!!chgdrDatas) {
                _this.formatHeaders(chgdrDatas.headers);
            }
            //如果业务实体变更，则重置列信息
            if (curEntityId != null && curEntityId != prevEntityId) {
                _this.resetColumnAndData(curEntityId, chgdrDatas.headers);
            }
            else {
                _this.headers = chgdrDatas.headers;
            }
        }), (/**
         * @param {?} err
         * @return {?}
         */
        function (err) {
            console.error("获取BE【" + curEntityId + "】的配置的业务变更日志的业务编号失败：", err);
            _this.messageService.error("获取业务编号配置失败：" + ErrorUtil.getErrorMessage(err));
        }));
    };
    /** 更新业务实体元数据 */
    /**
     * 更新业务实体元数据
     * @private
     * @param {?} entityId
     * @return {?}
     */
    ChgdrHeaderDatagridComponent.prototype.updateChgdrConfigHandler = /**
     * 更新业务实体元数据
     * @private
     * @param {?} entityId
     * @return {?}
     */
    function (entityId) {
        var _this = this;
        if (entityId) {
            return this.chgdrInnerService.getChgdrConfigHandler(entityId).pipe(tap((/**
             * @param {?} data
             * @return {?}
             */
            function (data) { return _this.chgdrConfigHandler = data; })));
        }
        else {
            return of(this.chgdrConfigHandler);
        }
    };
    /**
     * 更新dataCodeField数据
     * @param prevEntityId 原BeId
     * @param curEntityId 当前BeId
     */
    /**
     * 更新dataCodeField数据
     * @param {?} prevEntityId 原BeId
     * @param {?} curEntityId 当前BeId
     * @return {?}
     */
    ChgdrHeaderDatagridComponent.prototype.updateDataCodeFields = /**
     * 更新dataCodeField数据
     * @param {?} prevEntityId 原BeId
     * @param {?} curEntityId 当前BeId
     * @return {?}
     */
    function (prevEntityId, curEntityId) {
        var _this = this;
        if (curEntityId != null && curEntityId != prevEntityId) {
            //只有发生变更时才更新
            return this.chgdrService.getRootEntityDataCodeFields(curEntityId).pipe(tap((/**
             * @param {?} data
             * @return {?}
             */
            function (data) { return _this.dataCodeFields = data || []; })));
        }
        else {
            //否则直接返回当前值
            return of(this.dataCodeFields);
        }
    };
    /**
     * 格式化headers。主要是解析其中的dataCode，将其转为Object
     * 使用dataCodeObj存放dataCode解析后的结果
     * dataCodeObj属性在ChangeDataHeader中不存在，此处通过强制赋值使用，并且只限于该处使用。
     */
    /**
     * 格式化headers。主要是解析其中的dataCode，将其转为Object
     * 使用dataCodeObj存放dataCode解析后的结果
     * dataCodeObj属性在ChangeDataHeader中不存在，此处通过强制赋值使用，并且只限于该处使用。
     * @private
     * @param {?} headers
     * @return {?}
     */
    ChgdrHeaderDatagridComponent.prototype.formatHeaders = /**
     * 格式化headers。主要是解析其中的dataCode，将其转为Object
     * 使用dataCodeObj存放dataCode解析后的结果
     * dataCodeObj属性在ChangeDataHeader中不存在，此处通过强制赋值使用，并且只限于该处使用。
     * @private
     * @param {?} headers
     * @return {?}
     */
    function (headers) {
        var _this = this;
        if (!headers) {
            return;
        }
        headers.forEach((/**
         * @param {?} header
         * @return {?}
         */
        function (header) {
            /** @type {?} */
            var dataCodeObj;
            _this.formatDataCodeMap(header.dataCode);
            if (header.dataCode && header.dataCode.size == 1 && header.dataCode.has("_$dataCode")) {
                //兼容老数据
                //老数据dataCode为自由文本
                dataCodeObj = {};
                if (_this.dataCodeFields && _this.dataCodeFields.length > 0) {
                    dataCodeObj[_this.dataCodeFields[0].fieldLabelId] = header.dataCode.get("_$dataCode");
                }
            }
            else {
                dataCodeObj = MapUtil.convertMapToObject(header.dataCode);
            }
            ((/** @type {?} */ (header))).dataCodeObj = dataCodeObj;
        }));
    };
    /** 格式化业务主键Map */
    /**
     * 格式化业务主键Map
     * @private
     * @param {?} dataCode
     * @return {?}
     */
    ChgdrHeaderDatagridComponent.prototype.formatDataCodeMap = /**
     * 格式化业务主键Map
     * @private
     * @param {?} dataCode
     * @return {?}
     */
    function (dataCode) {
        var _this = this;
        if (!dataCode || !this.chgdrConfigHandler) {
            return;
        }
        Array.from(dataCode.keys()).forEach((/**
         * @param {?} fieldLabelId
         * @return {?}
         */
        function (fieldLabelId) {
            /** @type {?} */
            var value = dataCode.get(fieldLabelId);
            /** @type {?} */
            var formatedValue = _this.chgdrConfigHandler.formatMainObjectFieldValue(value, fieldLabelId);
            dataCode.set(fieldLabelId, formatedValue);
        }));
    };
    /**
     * @private
     * @param {?} chgdrs
     * @return {?}
     */
    ChgdrHeaderDatagridComponent.prototype.getEntityId = /**
     * @private
     * @param {?} chgdrs
     * @return {?}
     */
    function (chgdrs) {
        if (!chgdrs || !chgdrs.headers || chgdrs.headers.length == 0) {
            return null;
        }
        else {
            return chgdrs.headers[0].entityId;
        }
    };
    /**
     * @private
     * @param {?} entityId
     * @param {?} headers
     * @return {?}
     */
    ChgdrHeaderDatagridComponent.prototype.resetColumnAndData = /**
     * @private
     * @param {?} entityId
     * @param {?} headers
     * @return {?}
     */
    function (entityId, headers) {
        /** @type {?} */
        var columns = [
            { field: 'userName', width: 130, title: '用户' },
            { field: 'changeTime', width: 130, title: '时间', formatter: { type: 'datetime', options: { format: 'yyyy年MM月dd日 HH:mm:ss' } } },
            { field: 'operateType.name', width: 60, title: '操作类型' },
            { field: 'dataId', width: 130, title: '技术主键', visible: this.showDataId }
        ];
        //{field: 'dataCode', width: 130, title: '业务编号'},
        // {field: 'reason', width: 130, title: '变更原因'},
        this.dataCodeFields.forEach((/**
         * @param {?} field
         * @return {?}
         */
        function (field) {
            /** @type {?} */
            var column = {
                field: "dataCodeObj." + field.fieldLabelId,
                title: field.fieldName,
                width: 130
            };
            columns.push(column);
        }));
        /** @type {?} */
        var opColumn = { title: '操作', width: 130, template: this.opCell, halign: 'center', align: 'center' };
        columns.push(opColumn);
        //因为datagrid不允许同时变更data和column，因此手动触发脏检查避免出错
        //先在空数据的基础上变更列
        this.headers = [];
        this.ref.detectChanges();
        this.columns = columns;
        this.ref.detectChanges();
        //在重新赋值数据
        this.headers = headers;
    };
    /**
     * @param {?} $event
     * @return {?}
     */
    ChgdrHeaderDatagridComponent.prototype.onPageChanged = /**
     * @param {?} $event
     * @return {?}
     */
    function ($event) {
        this.pageChanged.emit($event);
    };
    /**
     * @param {?} $event
     * @return {?}
     */
    ChgdrHeaderDatagridComponent.prototype.onPageSizeChanged = /**
     * @param {?} $event
     * @return {?}
     */
    function ($event) {
        this.pageSizeChanged.emit($event);
    };
    /**
     * @param {?} ctx
     * @return {?}
     */
    ChgdrHeaderDatagridComponent.prototype.showChangeDetail = /**
     * @param {?} ctx
     * @return {?}
     */
    function (ctx) {
        var _this = this;
        /** @type {?} */
        var header = ctx.rowData;
        if (!header) {
            return;
        }
        this.chgdrService.getChangeData(header.id, header.changeTime).subscribe((/**
         * @param {?} data
         * @return {?}
         */
        function (data) {
            if (!data) {
                _this.notifyService.error("未找到编号为【" + header.id + "】的变更日志");
            }
            else {
                _this.currentChgdrData = data;
                _this.chgdrInfoDialog.show();
            }
        }), (/**
         * @param {?} error
         * @return {?}
         */
        function (error) {
            console.error("查询业务变更日志出错", error);
            _this.messageService.error("查询业务变更日志出错：" + ErrorUtil.getErrorMessage(error));
        }));
    };
    ChgdrHeaderDatagridComponent.decorators = [
        { type: Component, args: [{
                    selector: 'lib-chgdr-header-datagrid',
                    template: "<farris-datagrid #chgdrGrid idField=\"id\" [columns]=\"columns\" [data]=\"headers\"\n  showLineNumber=\"true\" [fit]=\"true\" [fitColumns]=\"true\" \n  [pagination]=\"true\" [pageSize]=\"20\" [showPageList]=\"false\" [pageIndex]=\"chgdrs.pageIndex\" [total]=\"chgdrs.total\"\n  (pageChanged)=\"onPageChanged($event)\" (pageSizeChanged)=\"onPageSizeChanged($event)\"\n>\n</farris-datagrid>\n<ng-template #opCell let-ctx>\n  <a href=\"javascript: void(0);\" (click)=\"showChangeDetail(ctx)\">\u53D8\u66F4\u8BE6\u60C5</a>\n</ng-template>\n\n<!-- \u67E5\u770B\u53D8\u66F4\u65E5\u5FD7\u7684\u5F39\u7A97 -->\n<farris-dialog #chgdrInfoDialog\n  title=\"\u53D8\u66F4\u65E5\u5FD7\u8BE6\u60C5\"\n  [width]=\"1100\"\n  [height]=\"600\"\n  [showMaxButton]=\"true\"\n  [resizable]=\"true\"\n  [showButtons]=\"false\"\n>\n  <chgdr-data-viewer [data]=\"currentChgdrData\"></chgdr-data-viewer>\n</farris-dialog>",
                    styles: [""]
                }] }
    ];
    /** @nocollapse */
    ChgdrHeaderDatagridComponent.ctorParameters = function () { return [
        { type: ChgdrService },
        { type: MessagerService },
        { type: NotifyService },
        { type: ChangeDetectorRef },
        { type: ChgdrInnerService },
        { type: Injector }
    ]; };
    ChgdrHeaderDatagridComponent.propDecorators = {
        baseCls: [{ type: HostBinding, args: ['class.f-utils-fill',] }],
        chgdrs: [{ type: Input }],
        showDataId: [{ type: Input }],
        pageChanged: [{ type: Output }],
        pageSizeChanged: [{ type: Output }],
        opCell: [{ type: ViewChild, args: ['opCell',] }],
        chgdrInfoDialog: [{ type: ViewChild, args: ["chgdrInfoDialog",] }]
    };
    return ChgdrHeaderDatagridComponent;
}());
export { ChgdrHeaderDatagridComponent };
if (false) {
    /** @type {?} */
    ChgdrHeaderDatagridComponent.prototype.baseCls;
    /** @type {?} */
    ChgdrHeaderDatagridComponent.prototype.chgdrs;
    /** @type {?} */
    ChgdrHeaderDatagridComponent.prototype.showDataId;
    /** @type {?} */
    ChgdrHeaderDatagridComponent.prototype.headers;
    /** @type {?} */
    ChgdrHeaderDatagridComponent.prototype.dataCodeFields;
    /**
     * @type {?}
     * @private
     */
    ChgdrHeaderDatagridComponent.prototype.chgdrConfigHandler;
    /** @type {?} */
    ChgdrHeaderDatagridComponent.prototype.pageChanged;
    /** @type {?} */
    ChgdrHeaderDatagridComponent.prototype.pageSizeChanged;
    /** @type {?} */
    ChgdrHeaderDatagridComponent.prototype.opCell;
    /** @type {?} */
    ChgdrHeaderDatagridComponent.prototype.chgdrInfoDialog;
    /** @type {?} */
    ChgdrHeaderDatagridComponent.prototype.columns;
    /** @type {?} */
    ChgdrHeaderDatagridComponent.prototype.currentChgdrData;
    /**
     * @type {?}
     * @private
     */
    ChgdrHeaderDatagridComponent.prototype.chgdrService;
    /**
     * @type {?}
     * @private
     */
    ChgdrHeaderDatagridComponent.prototype.messageService;
    /**
     * @type {?}
     * @private
     */
    ChgdrHeaderDatagridComponent.prototype.notifyService;
    /**
     * @type {?}
     * @private
     */
    ChgdrHeaderDatagridComponent.prototype.ref;
    /**
     * @type {?}
     * @private
     */
    ChgdrHeaderDatagridComponent.prototype.chgdrInnerService;
    /**
     * @type {?}
     * @private
     */
    ChgdrHeaderDatagridComponent.prototype.injector;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hnZHItaGVhZGVyLWRhdGFncmlkLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0Bnc3AtY21wL2NoZ2RyLyIsInNvdXJjZXMiOlsibGliL2NoZ2RyLWhlYWRlci1kYXRhZ3JpZC9jaGdkci1oZWFkZXItZGF0YWdyaWQuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsU0FBUyxFQUFFLFlBQVksRUFBRSxXQUFXLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBVSxNQUFNLEVBQWlCLFdBQVcsRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFaEssT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ3BELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN0RCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDbEQsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBRXhELE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLG1DQUFtQyxDQUFDO0FBRTFFLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUUvQyxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDckMsT0FBTyxFQUFFLFFBQVEsRUFBRSxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDcEMsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBSzNDLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLGdDQUFnQyxDQUFDO0FBR25FO0lBMEJFLHNDQUFvQixZQUEwQixFQUNwQyxjQUErQixFQUMvQixhQUE0QixFQUM1QixHQUFzQixFQUN0QixpQkFBb0MsRUFDcEMsUUFBa0I7UUFMUixpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUNwQyxtQkFBYyxHQUFkLGNBQWMsQ0FBaUI7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LEVBQUUsMkJBQTJCO29CQUNyQywyNEJBQXFEOztpQkFFdEQ7Ozs7Z0JBcEJRLFlBQVk7Z0JBRlosZUFBZTtnQkFDZixhQUFhO2dCQUpiLGlCQUFpQjtnQkFrQmpCLGlCQUFpQjtnQkFsQndDLFFBQVE7OzswQkEyQnZFLFdBQVcsU0FBQyxvQkFBb0I7eUJBQ2hDLEtBQUs7NkJBQ0wsS0FBSzs4QkFJTCxNQUFNO2tDQUVOLE1BQU07eUJBSU4sU0FBUyxTQUFDLFFBQVE7a0NBQ2xCLFNBQVMsU0FBQyxpQkFBaUI7O0lBOEs5QixtQ0FBQztDQUFBLEFBak1ELElBaU1DO1NBNUxZLDRCQUE0Qjs7O0lBQ3ZDLCtDQUFrRDs7SUFDbEQsOENBQXVDOztJQUN2QyxrREFBb0M7O0lBQ3BDLCtDQUFpQzs7SUFDakMsc0RBQXlDOzs7OztJQUN6QywwREFBK0M7O0lBQy9DLG1EQUN1RDs7SUFDdkQsdURBQzJEOztJQUczRCw4Q0FBOEM7O0lBQzlDLHVEQUNpQzs7SUFFakMsK0NBQWU7O0lBRWYsd0RBQW1DOzs7OztJQUV2QixvREFBa0M7Ozs7O0lBQzVDLHNEQUF1Qzs7Ozs7SUFDdkMscURBQW9DOzs7OztJQUNwQywyQ0FBOEI7Ozs7O0lBQzlCLHlEQUE0Qzs7Ozs7SUFDNUMsZ0RBQTBCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ2hhbmdlRGV0ZWN0b3JSZWYsIENvbXBvbmVudCwgRXZlbnRFbWl0dGVyLCBIb3N0QmluZGluZywgSW5qZWN0b3IsIElucHV0LCBPbkluaXQsIE91dHB1dCwgU2ltcGxlQ2hhbmdlcywgVGVtcGxhdGVSZWYsIFZpZXdDaGlsZCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBEYXRhQ29sdW1uIH0gZnJvbSAnQGZhcnJpcy91aS1jb21tb24vY29sdW1uJztcclxuaW1wb3J0IHsgRGlhbG9nQ29tcG9uZW50IH0gZnJvbSAnQGZhcnJpcy91aS1kaWFsb2cnO1xyXG5pbXBvcnQgeyBNZXNzYWdlclNlcnZpY2UgfSBmcm9tICdAZmFycmlzL3VpLW1lc3NhZ2VyJztcclxuaW1wb3J0IHsgTm90aWZ5U2VydmljZSB9IGZyb20gJ0BmYXJyaXMvdWktbm90aWZ5JztcclxuaW1wb3J0IHsgQ2hnZHJTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZS9jaGdkci5zZXJ2aWNlJztcclxuaW1wb3J0IHsgQ2hhbmdlRGF0YUhlYWRlciB9IGZyb20gJy4uL21vZGVsL2NoYW5nZS1kYXRhLWhlYWRlcic7XHJcbmltcG9ydCB7IENoYW5nZURhdGFRdWVyeVJlc3VsdCB9IGZyb20gJy4uL21vZGVsL2NoYW5nZS1kYXRhLXF1ZXJ5LXJlc3VsdCc7XHJcbmltcG9ydCB7IE9wZXJhdGVUeXBlIH0gZnJvbSAnLi4vbW9kZWwvb3BlcmF0ZS10eXBlJztcclxuaW1wb3J0IHsgRXJyb3JVdGlsIH0gZnJvbSAnLi4vdXRpbC9lcnJvci51dGlsJztcclxuaW1wb3J0IHsgQ2hnTG9nQ29uZmlnRmllbGQgfSBmcm9tICcuLi9tb2RlbC9jaGdkci1jb25maWctZmllbGQnO1xyXG5pbXBvcnQgeyB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IGZvcmtKb2luLCBvZiB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBNYXBVdGlsIH0gZnJvbSAnLi4vdXRpbC9tYXAudXRpbCc7XHJcbmltcG9ydCB7IENoZ2RyTWV0YWRhdGFTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZS9jaGdkci1tZXRhZGF0YS5zZXJ2aWNlJztcclxuaW1wb3J0IHsgR1NQQnVzaW5lc3NFbnRpdHkgfSBmcm9tICdAZ3NwLWJlZi9nc3AtYmUtbWV0YWRhdGEnO1xyXG5pbXBvcnQgeyBHU1BNZXRhZGF0YVJUU2VydmljZSB9IGZyb20gJ0Bnc3AtbGNtL21ldGFkYXRhcnQtc2VsZWN0b3InO1xyXG5pbXBvcnQgeyBHU1BDb21tb25FbGVtZW50IH0gZnJvbSAnQGdzcC1iZWYvZ3NwLWNtLW1ldGFkYXRhJztcclxuaW1wb3J0IHsgQ2hnZHJJbm5lclNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlL2NoZ2RyLWlubmVyLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBDaGdkckNvbmZpZ0hhbmRsZXIgfSBmcm9tICcuLi9zZXJ2aWNlL2NoZ2RyLWNvbmZpZy1oYW5kbGVyJztcclxuXHJcbkBDb21wb25lbnQoe1xyXG4gIHNlbGVjdG9yOiAnbGliLWNoZ2RyLWhlYWRlci1kYXRhZ3JpZCcsXHJcbiAgdGVtcGxhdGVVcmw6ICcuL2NoZ2RyLWhlYWRlci1kYXRhZ3JpZC5jb21wb25lbnQuaHRtbCcsXHJcbiAgc3R5bGVVcmxzOiBbJy4vY2hnZHItaGVhZGVyLWRhdGFncmlkLmNvbXBvbmVudC5jc3MnXVxyXG59KVxyXG5leHBvcnQgY2xhc3MgQ2hnZHJIZWFkZXJEYXRhZ3JpZENvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCB7XHJcbiAgQEhvc3RCaW5kaW5nKCdjbGFzcy5mLXV0aWxzLWZpbGwnKSBiYXNlQ2xzID0gdHJ1ZTtcclxuICBASW5wdXQoKSBjaGdkcnM6IENoYW5nZURhdGFRdWVyeVJlc3VsdDtcclxuICBASW5wdXQoKSBzaG93RGF0YUlkOiBib29sZWFuID0gdHJ1ZTtcclxuICBoZWFkZXJzOiBDaGFuZ2VEYXRhSGVhZGVyW10gPSBbXTtcclxuICBkYXRhQ29kZUZpZWxkczogQ2hnTG9nQ29uZmlnRmllbGRbXSA9IFtdO1xyXG4gIHByaXZhdGUgY2hnZHJDb25maWdIYW5kbGVyOiBDaGdkckNvbmZpZ0hhbmRsZXI7XHJcbiAgQE91dHB1dCgpXHJcbiAgcGFnZUNoYW5nZWQ6IEV2ZW50RW1pdHRlcjxudW1iZXI+ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xyXG4gIEBPdXRwdXQoKVxyXG4gIHBhZ2VTaXplQ2hhbmdlZDogRXZlbnRFbWl0dGVyPG51bWJlcj4gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XHJcblxyXG4gIC8vIOiOt+WPluWumuS5ieeahOWNleWFg+agvOaooeadv1xyXG4gIEBWaWV3Q2hpbGQoJ29wQ2VsbCcpIG9wQ2VsbDogVGVtcGxhdGVSZWY8YW55PjtcclxuICBAVmlld0NoaWxkKFwiY2hnZHJJbmZvRGlhbG9nXCIpXHJcbiAgY2hnZHJJbmZvRGlhbG9nOiBEaWFsb2dDb21wb25lbnQ7XHJcblxyXG4gIGNvbHVtbnM6IGFueVtdO1xyXG5cclxuICBjdXJyZW50Q2hnZHJEYXRhOiBDaGFuZ2VEYXRhSGVhZGVyO1xyXG5cclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGNoZ2RyU2VydmljZTogQ2hnZHJTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSBtZXNzYWdlU2VydmljZTogTWVzc2FnZXJTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSBub3RpZnlTZXJ2aWNlOiBOb3RpZnlTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSByZWY6IENoYW5nZURldGVjdG9yUmVmLFxyXG4gICAgcHJpdmF0ZSBjaGdkcklubmVyU2VydmljZTogQ2hnZHJJbm5lclNlcnZpY2UsXHJcbiAgICBwcml2YXRlIGluamVjdG9yOiBJbmplY3Rvcikge1xyXG4gIH1cclxuXHJcbiAgbmdPbkluaXQoKSB7XHJcbiAgICB0aGlzLnJlc2V0Q29sdW1uQW5kRGF0YShudWxsLCBbXSk7XHJcbiAgfVxyXG5cclxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKTogdm9pZCB7XHJcbiAgICBpZiAoIWNoYW5nZXMuY2hnZHJzKSB7XHJcbiAgICAgIC8v5aaC5p6cY2hnZHJz5rKh5pyJ5pu05paw77yM5YiZ55u05o6l6L+U5ZueXHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBsZXQgcHJldkVudGl0eUlkID0gdGhpcy5nZXRFbnRpdHlJZChjaGFuZ2VzLmNoZ2Rycy5wcmV2aW91c1ZhbHVlKTtcclxuICAgIGxldCBjdXJFbnRpdHlJZCA9IHRoaXMuZ2V0RW50aXR5SWQoY2hhbmdlcy5jaGdkcnMuY3VycmVudFZhbHVlKTtcclxuICAgIGxldCByZXF1ZXN0cyA9IFtcclxuICAgICAgdGhpcy51cGRhdGVDaGdkckNvbmZpZ0hhbmRsZXIoY3VyRW50aXR5SWQpLFxyXG4gICAgICB0aGlzLnVwZGF0ZURhdGFDb2RlRmllbGRzKHByZXZFbnRpdHlJZCwgY3VyRW50aXR5SWQpXHJcbiAgICBdXHJcbiAgICBmb3JrSm9pbihyZXF1ZXN0cykuc3Vic2NyaWJlKGRhdGEgPT4ge1xyXG4gICAgICBsZXQgY2hnZHJEYXRhczogQ2hhbmdlRGF0YVF1ZXJ5UmVzdWx0ID0gY2hhbmdlcy5jaGdkcnMuY3VycmVudFZhbHVlO1xyXG4gICAgICBpZiAoISFjaGdkckRhdGFzKSB7XHJcbiAgICAgICAgdGhpcy5mb3JtYXRIZWFkZXJzKGNoZ2RyRGF0YXMuaGVhZGVycyk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8v5aaC5p6c5Lia5Yqh5a6e5L2T5Y+Y5pu077yM5YiZ6YeN572u5YiX5L+h5oGvXHJcbiAgICAgIGlmIChjdXJFbnRpdHlJZCAhPSBudWxsICYmIGN1ckVudGl0eUlkICE9IHByZXZFbnRpdHlJZCkge1xyXG4gICAgICAgIHRoaXMucmVzZXRDb2x1bW5BbmREYXRhKGN1ckVudGl0eUlkLCBjaGdkckRhdGFzLmhlYWRlcnMpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHRoaXMuaGVhZGVycyA9IGNoZ2RyRGF0YXMuaGVhZGVycztcclxuICAgICAgfVxyXG4gICAgfSwgZXJyID0+IHtcclxuICAgICAgY29uc29sZS5lcnJvcihcIuiOt+WPlkJF44CQXCIgKyBjdXJFbnRpdHlJZCArIFwi44CR55qE6YWN572u55qE5Lia5Yqh5Y+Y5pu05pel5b+X55qE5Lia5Yqh57yW5Y+35aSx6LSl77yaXCIsIGVycik7XHJcbiAgICAgIHRoaXMubWVzc2FnZVNlcnZpY2UuZXJyb3IoXCLojrflj5bkuJrliqHnvJblj7fphY3nva7lpLHotKXvvJpcIiArIEVycm9yVXRpbC5nZXRFcnJvck1lc3NhZ2UoZXJyKSk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKiDmm7TmlrDkuJrliqHlrp7kvZPlhYPmlbDmja4gKi9cclxuICBwcml2YXRlIHVwZGF0ZUNoZ2RyQ29uZmlnSGFuZGxlcihlbnRpdHlJZDogc3RyaW5nKSB7XHJcbiAgICBpZiAoZW50aXR5SWQpIHtcclxuICAgICAgcmV0dXJuIHRoaXMuY2hnZHJJbm5lclNlcnZpY2UuZ2V0Q2hnZHJDb25maWdIYW5kbGVyKGVudGl0eUlkKS5waXBlKHRhcChkYXRhID0+IHRoaXMuY2hnZHJDb25maWdIYW5kbGVyID0gZGF0YSkpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuIG9mKHRoaXMuY2hnZHJDb25maWdIYW5kbGVyKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOabtOaWsGRhdGFDb2RlRmllbGTmlbDmja5cclxuICAgKiBAcGFyYW0gcHJldkVudGl0eUlkIOWOn0JlSWRcclxuICAgKiBAcGFyYW0gY3VyRW50aXR5SWQg5b2T5YmNQmVJZFxyXG4gICAqL1xyXG4gIHVwZGF0ZURhdGFDb2RlRmllbGRzKHByZXZFbnRpdHlJZDogc3RyaW5nLCBjdXJFbnRpdHlJZDogc3RyaW5nKSB7XHJcbiAgICBpZiAoY3VyRW50aXR5SWQgIT0gbnVsbCAmJiBjdXJFbnRpdHlJZCAhPSBwcmV2RW50aXR5SWQpIHtcclxuICAgICAgLy/lj6rmnInlj5HnlJ/lj5jmm7Tml7bmiY3mm7TmlrBcclxuICAgICAgcmV0dXJuIHRoaXMuY2hnZHJTZXJ2aWNlLmdldFJvb3RFbnRpdHlEYXRhQ29kZUZpZWxkcyhjdXJFbnRpdHlJZCkucGlwZSh0YXAoZGF0YSA9PiB0aGlzLmRhdGFDb2RlRmllbGRzID0gZGF0YSB8fCBbXSkpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgLy/lkKbliJnnm7TmjqXov5Tlm57lvZPliY3lgLxcclxuICAgICAgcmV0dXJuIG9mKHRoaXMuZGF0YUNvZGVGaWVsZHMpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5qC85byP5YyWaGVhZGVyc+OAguS4u+imgeaYr+ino+aekOWFtuS4reeahGRhdGFDb2Rl77yM5bCG5YW26L2s5Li6T2JqZWN0XHJcbiAgICog5L2/55SoZGF0YUNvZGVPYmrlrZjmlL5kYXRhQ29kZeino+aekOWQjueahOe7k+aenFxyXG4gICAqIGRhdGFDb2RlT2Jq5bGe5oCn5ZyoQ2hhbmdlRGF0YUhlYWRlcuS4reS4jeWtmOWcqO+8jOatpOWkhOmAmui/h+W8uuWItui1i+WAvOS9v+eUqO+8jOW5tuS4lOWPqumZkOS6juivpeWkhOS9v+eUqOOAglxyXG4gICAqL1xyXG4gIHByaXZhdGUgZm9ybWF0SGVhZGVycyhoZWFkZXJzOiBDaGFuZ2VEYXRhSGVhZGVyW10pIHtcclxuICAgIGlmICghaGVhZGVycykge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBoZWFkZXJzLmZvckVhY2goaGVhZGVyID0+IHtcclxuICAgICAgbGV0IGRhdGFDb2RlT2JqOiBhbnk7XHJcbiAgICAgIHRoaXMuZm9ybWF0RGF0YUNvZGVNYXAoaGVhZGVyLmRhdGFDb2RlKTtcclxuICAgICAgaWYgKGhlYWRlci5kYXRhQ29kZSAmJiBoZWFkZXIuZGF0YUNvZGUuc2l6ZSA9PSAxICYmIGhlYWRlci5kYXRhQ29kZS5oYXMoXCJfJGRhdGFDb2RlXCIpKSB7XHJcbiAgICAgICAgLy/lhbzlrrnogIHmlbDmja5cclxuICAgICAgICAvL+iAgeaVsOaNrmRhdGFDb2Rl5Li66Ieq55Sx5paH5pysXHJcbiAgICAgICAgZGF0YUNvZGVPYmogPSB7fTtcclxuICAgICAgICBpZiAodGhpcy5kYXRhQ29kZUZpZWxkcyAmJiB0aGlzLmRhdGFDb2RlRmllbGRzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgIGRhdGFDb2RlT2JqW3RoaXMuZGF0YUNvZGVGaWVsZHNbMF0uZmllbGRMYWJlbElkXSA9IGhlYWRlci5kYXRhQ29kZS5nZXQoXCJfJGRhdGFDb2RlXCIpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBkYXRhQ29kZU9iaiA9IE1hcFV0aWwuY29udmVydE1hcFRvT2JqZWN0KGhlYWRlci5kYXRhQ29kZSk7XHJcbiAgICAgIH1cclxuICAgICAgKDxhbnk+aGVhZGVyKS5kYXRhQ29kZU9iaiA9IGRhdGFDb2RlT2JqO1xyXG4gICAgfSlcclxuICB9XHJcblxyXG4gIC8qKiDmoLzlvI/ljJbkuJrliqHkuLvplK5NYXAgKi9cclxuICBwcml2YXRlIGZvcm1hdERhdGFDb2RlTWFwKGRhdGFDb2RlOiBNYXA8c3RyaW5nLCBzdHJpbmc+KTogdm9pZCB7XHJcbiAgICBpZiAoIWRhdGFDb2RlIHx8ICF0aGlzLmNoZ2RyQ29uZmlnSGFuZGxlcikge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBBcnJheS5mcm9tKGRhdGFDb2RlLmtleXMoKSkuZm9yRWFjaChmaWVsZExhYmVsSWQgPT4ge1xyXG4gICAgICBsZXQgdmFsdWUgPSBkYXRhQ29kZS5nZXQoZmllbGRMYWJlbElkKTtcclxuICAgICAgbGV0IGZvcm1hdGVkVmFsdWUgPSB0aGlzLmNoZ2RyQ29uZmlnSGFuZGxlci5mb3JtYXRNYWluT2JqZWN0RmllbGRWYWx1ZSh2YWx1ZSwgZmllbGRMYWJlbElkKTtcclxuICAgICAgZGF0YUNvZGUuc2V0KGZpZWxkTGFiZWxJZCwgZm9ybWF0ZWRWYWx1ZSk7XHJcbiAgICB9KVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXRFbnRpdHlJZChjaGdkcnM6IENoYW5nZURhdGFRdWVyeVJlc3VsdCk6IHN0cmluZyB7XHJcbiAgICBpZiAoIWNoZ2RycyB8fCAhY2hnZHJzLmhlYWRlcnMgfHwgY2hnZHJzLmhlYWRlcnMubGVuZ3RoID09IDApIHtcclxuICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4gY2hnZHJzLmhlYWRlcnNbMF0uZW50aXR5SWQ7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHJlc2V0Q29sdW1uQW5kRGF0YShlbnRpdHlJZDogc3RyaW5nLCBoZWFkZXJzOiBDaGFuZ2VEYXRhSGVhZGVyW10pIHtcclxuICAgIGxldCBjb2x1bW5zOiBhbnlbXSA9IFtcclxuICAgICAgeyBmaWVsZDogJ3VzZXJOYW1lJywgd2lkdGg6IDEzMCwgdGl0bGU6ICfnlKjmiLcnIH0sXHJcbiAgICAgIHsgZmllbGQ6ICdjaGFuZ2VUaW1lJywgd2lkdGg6IDEzMCwgdGl0bGU6ICfml7bpl7QnLCBmb3JtYXR0ZXI6IHsgdHlwZTogJ2RhdGV0aW1lJywgb3B0aW9uczogeyBmb3JtYXQ6ICd5eXl55bm0TU3mnIhkZOaXpSBISDptbTpzcycgfSB9IH0sXHJcbiAgICAgIHsgZmllbGQ6ICdvcGVyYXRlVHlwZS5uYW1lJywgd2lkdGg6IDYwLCB0aXRsZTogJ+aTjeS9nOexu+WeiycgfSxcclxuICAgICAgeyBmaWVsZDogJ2RhdGFJZCcsIHdpZHRoOiAxMzAsIHRpdGxlOiAn5oqA5pyv5Li76ZSuJywgdmlzaWJsZTogdGhpcy5zaG93RGF0YUlkIH1dO1xyXG4gICAgLy97ZmllbGQ6ICdkYXRhQ29kZScsIHdpZHRoOiAxMzAsIHRpdGxlOiAn5Lia5Yqh57yW5Y+3J30sXHJcbiAgICAvLyB7ZmllbGQ6ICdyZWFzb24nLCB3aWR0aDogMTMwLCB0aXRsZTogJ+WPmOabtOWOn+WboCd9LFxyXG4gICAgdGhpcy5kYXRhQ29kZUZpZWxkcy5mb3JFYWNoKChmaWVsZCkgPT4ge1xyXG4gICAgICBsZXQgY29sdW1uOiBEYXRhQ29sdW1uID0ge1xyXG4gICAgICAgIGZpZWxkOiBcImRhdGFDb2RlT2JqLlwiICsgZmllbGQuZmllbGRMYWJlbElkLFxyXG4gICAgICAgIHRpdGxlOiBmaWVsZC5maWVsZE5hbWUsXHJcbiAgICAgICAgd2lkdGg6IDEzMFxyXG4gICAgICB9O1xyXG4gICAgICBjb2x1bW5zLnB1c2goY29sdW1uKTtcclxuICAgIH0pXHJcbiAgICBsZXQgb3BDb2x1bW4gPSB7IHRpdGxlOiAn5pON5L2cJywgd2lkdGg6IDEzMCwgdGVtcGxhdGU6IHRoaXMub3BDZWxsLCBoYWxpZ246ICdjZW50ZXInLCBhbGlnbjogJ2NlbnRlcicgfTtcclxuICAgIGNvbHVtbnMucHVzaChvcENvbHVtbik7XHJcblxyXG4gICAgLy/lm6DkuLpkYXRhZ3JpZOS4jeWFgeiuuOWQjOaXtuWPmOabtGRhdGHlkoxjb2x1bW7vvIzlm6DmraTmiYvliqjop6blj5HohI/mo4Dmn6Xpgb/lhY3lh7rplJlcclxuICAgIC8v5YWI5Zyo56m65pWw5o2u55qE5Z+656GA5LiK5Y+Y5pu05YiXXHJcbiAgICB0aGlzLmhlYWRlcnMgPSBbXTtcclxuICAgIHRoaXMucmVmLmRldGVjdENoYW5nZXMoKTtcclxuICAgIHRoaXMuY29sdW1ucyA9IGNvbHVtbnM7XHJcbiAgICB0aGlzLnJlZi5kZXRlY3RDaGFuZ2VzKCk7XHJcbiAgICAvL+WcqOmHjeaWsOi1i+WAvOaVsOaNrlxyXG4gICAgdGhpcy5oZWFkZXJzID0gaGVhZGVycztcclxuICB9XHJcblxyXG4gIG9uUGFnZUNoYW5nZWQoJGV2ZW50KSB7XHJcbiAgICB0aGlzLnBhZ2VDaGFuZ2VkLmVtaXQoJGV2ZW50KTtcclxuICB9XHJcblxyXG4gIG9uUGFnZVNpemVDaGFuZ2VkKCRldmVudCkge1xyXG4gICAgdGhpcy5wYWdlU2l6ZUNoYW5nZWQuZW1pdCgkZXZlbnQpO1xyXG4gIH1cclxuXHJcbiAgc2hvd0NoYW5nZURldGFpbChjdHgpIHtcclxuICAgIGxldCBoZWFkZXI6IENoYW5nZURhdGFIZWFkZXIgPSBjdHgucm93RGF0YTtcclxuICAgIGlmICghaGVhZGVyKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIHRoaXMuY2hnZHJTZXJ2aWNlLmdldENoYW5nZURhdGEoaGVhZGVyLmlkLCBoZWFkZXIuY2hhbmdlVGltZSkuc3Vic2NyaWJlKGRhdGEgPT4ge1xyXG4gICAgICBpZiAoIWRhdGEpIHtcclxuICAgICAgICB0aGlzLm5vdGlmeVNlcnZpY2UuZXJyb3IoXCLmnKrmib7liLDnvJblj7fkuLrjgJBcIiArIGhlYWRlci5pZCArIFwi44CR55qE5Y+Y5pu05pel5b+XXCIpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHRoaXMuY3VycmVudENoZ2RyRGF0YSA9IGRhdGE7XHJcbiAgICAgICAgdGhpcy5jaGdkckluZm9EaWFsb2cuc2hvdygpO1xyXG4gICAgICB9XHJcbiAgICB9LCBlcnJvciA9PiB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoXCLmn6Xor6LkuJrliqHlj5jmm7Tml6Xlv5flh7rplJlcIiwgZXJyb3IpO1xyXG4gICAgICB0aGlzLm1lc3NhZ2VTZXJ2aWNlLmVycm9yKFwi5p+l6K+i5Lia5Yqh5Y+Y5pu05pel5b+X5Ye66ZSZ77yaXCIgKyBFcnJvclV0aWwuZ2V0RXJyb3JNZXNzYWdlKGVycm9yKSk7XHJcbiAgICB9KVxyXG4gIH1cclxuXHJcbn1cclxuIl19