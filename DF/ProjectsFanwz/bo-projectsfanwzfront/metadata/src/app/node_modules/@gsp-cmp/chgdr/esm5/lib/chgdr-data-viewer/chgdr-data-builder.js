/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { ChgdrData, ChgdrDataRowNode, ChangeColumnItem, ChgdrDataEntityNode, DataCodeField } from './chgdr-data';
var ChgdrDataBuilder = /** @class */ (function () {
    function ChgdrDataBuilder() {
    }
    /**
     * @param {?} data
     * @param {?} handler
     * @return {?}
     */
    ChgdrDataBuilder.prototype.buildChgdrData = /**
     * @param {?} data
     * @param {?} handler
     * @return {?}
     */
    function (data, handler) {
        var _this = this;
        this.handler = handler;
        //初始化变更日志基本信息
        /** @type {?} */
        var chgdrData = new ChgdrData();
        chgdrData.entityName = this.handler.getBeName();
        chgdrData.operateType = data.operateType;
        chgdrData.userName = data.userName;
        chgdrData.dataId = data.dataId;
        chgdrData.dataCode = data.dataCode;
        chgdrData.dataCodes = this.buildDataCodes(data.dataCode, this.handler.getMainObjectCode());
        chgdrData.reason = data.reason;
        chgdrData.changeTime = data.changeTime;
        chgdrData.entityNodes = [];
        //分层组织变更日志行
        /** @type {?} */
        var rowNodes = [];
        !!data.rows && data.rows.forEach((/**
         * @param {?} row
         * @return {?}
         */
        function (row) {
            if (!row) {
                return;
            }
            /** @type {?} */
            var rowNode = new ChgdrDataRowNode();
            rowNode.id = row.id;
            rowNode.parentDataId = row.parentDataId;
            rowNode.dataId = row.dataId;
            rowNode.dataCode = row.dataCode;
            rowNode.dataCodes = _this.buildDataCodes(row.dataCode, row.entityCode);
            rowNode.entityCode = row.entityCode;
            rowNode.entityName = _this.handler.getEntityNameOrDefault(row.entityCode);
            rowNode.operateType = row.operateType;
            rowNode.entityNodes = [];
            //组织列的变更信息
            /** @type {?} */
            var changeColumnKeys = _this.extractChangeColumnKeys(row);
            /** @type {?} */
            var columnValueChanges = [];
            changeColumnKeys.forEach((/**
             * @param {?} key
             * @return {?}
             */
            function (key) {
                /** @type {?} */
                var column = new ChangeColumnItem();
                column.fieldLabel = key;
                column.fieldName = _this.handler.getEntityFieldNameOrDefault(row.entityCode, key);
                column.oldValue = _this.handler.formatFieldValue(row.oldContent.get(key), row.entityCode, key);
                column.newValue = _this.handler.formatFieldValue(row.newContent.get(key), row.entityCode, key);
                /** @type {?} */
                var ele = _this.handler.getElement(row.entityCode, key);
                if (ele) {
                    //判断是否是关联字段
                    column.hasAssociation = ele.ObjectType == "Association" && ele.IsUdt == false;
                    column.isAssociationRefField = ele.IsRefElement;
                    /** @type {?} */
                    var parentElement = _this.handler.getParentElement(row.entityCode, key);
                    if (parentElement) {
                        column.belongFieldLabelId = parentElement.LabelID;
                    }
                }
                columnValueChanges.push(column);
            }));
            //变更值排序
            _this.handler.sort(columnValueChanges, row.entityCode, (/**
             * @param {?} column
             * @return {?}
             */
            function (column) { return column.fieldLabel; }));
            //合并关联带出字段
            /** @type {?} */
            var columnMap = new Map();
            columnValueChanges.forEach((/**
             * @param {?} column
             * @return {?}
             */
            function (column) {
                columnMap.set(column.fieldLabel, column);
            }));
            //1. 移除所有关联带出字段，并附加到其所属关联字段的children属性上
            columnValueChanges = columnValueChanges.filter((/**
             * @param {?} column
             * @return {?}
             */
            function (column) {
                if (column.isAssociationRefField) {
                    /** @type {?} */
                    var parentColumn = columnMap.get(column.belongFieldLabelId);
                    if (parentColumn) {
                        //找到父级字段则添加为父
                        parentColumn.children.push(column);
                        return false;
                    }
                    else {
                        return true;
                    }
                }
                else {
                    return true;
                }
            }));
            //2. 转换关联字段，将其子级的变更值拼接作为其变更值
            columnValueChanges = columnValueChanges.map((/**
             * @param {?} column
             * @return {?}
             */
            function (column) {
                if (column.hasAssociation && column.children.length > 0) {
                    //如果是关联字段，且存在关联带出字段
                    /** @type {?} */
                    var virtualColumn = Object.assign(new ChangeColumnItem(), column);
                    virtualColumn.originalColumnItem = column;
                    virtualColumn.oldValue = column.children.map((/**
                     * @param {?} child
                     * @return {?}
                     */
                    function (child) { return child.oldValue; })).join(";");
                    virtualColumn.newValue = column.children.map((/**
                     * @param {?} child
                     * @return {?}
                     */
                    function (child) { return child.newValue; })).join(";");
                    return virtualColumn;
                }
                else {
                    return column;
                }
            }));
            rowNode.changes = columnValueChanges;
            rowNodes.push(rowNode);
        }));
        /**
         * dataId与变更行的Map
         * @type {?}
         */
        var dataIdRowMap = new Map();
        rowNodes.forEach((/**
         * @param {?} node
         * @return {?}
         */
        function (node) { return dataIdRowMap.set(node.dataId, node); }));
        rowNodes.forEach((/**
         * @param {?} node
         * @return {?}
         */
        function (node) {
            if (!node.parentDataId) {
                //根节点
                /** @type {?} */
                var entityNode = _this.genChgdrDataEntityNode(node.entityCode, node.entityName);
                entityNode.rows.push(node);
                chgdrData.entityNodes.push(entityNode);
                return;
            }
            /** @type {?} */
            var parentRowNode = dataIdRowMap.get(node.parentDataId);
            if (!!parentRowNode) {
                //上级节点存在的节点
                /** @type {?} */
                var entityNode = parentRowNode.entityNodes.find((/**
                 * @param {?} en
                 * @return {?}
                 */
                function (en) { return en.entityCode == node.entityCode; }));
                if (!entityNode) {
                    entityNode = _this.genChgdrDataEntityNode(node.entityCode, node.entityName);
                    parentRowNode.entityNodes.push(entityNode);
                }
                entityNode.rows.push(node);
            }
            else {
                //上级节点不存在的节点
                //TODO 上级节点不存在的节点是否需要构造完整的上级结构？
                /** @type {?} */
                var entityNode = _this.genChgdrDataEntityNode(node.entityCode, node.entityName);
                entityNode.rows.push(node);
                chgdrData.entityNodes.push(entityNode);
            }
        }));
        return chgdrData;
    };
    /**
     * @private
     * @param {?} dataCode
     * @param {?} entityCode
     * @return {?}
     */
    ChgdrDataBuilder.prototype.buildDataCodes = /**
     * @private
     * @param {?} dataCode
     * @param {?} entityCode
     * @return {?}
     */
    function (dataCode, entityCode) {
        var _this = this;
        /** @type {?} */
        var dataCodes = [];
        dataCode && dataCode.forEach((/**
         * @param {?} value
         * @param {?} key
         * @return {?}
         */
        function (value, key) {
            /** @type {?} */
            var dataCodeField = new DataCodeField();
            if (key == "_$dataCode") {
                dataCodeField.fieldLabelId = "dataCode";
                dataCodeField.fieldName = "业务编号";
                dataCodeField.fieldValue = value;
            }
            else {
                dataCodeField.fieldLabelId = key;
                dataCodeField.fieldName = _this.handler.getEntityFieldNameOrDefault(entityCode, key);
                dataCodeField.fieldValue = _this.handler.formatFieldValue(value, entityCode, key);
            }
            dataCodes.push(dataCodeField);
        }));
        //业务编号排序
        this.handler.sort(dataCodes, entityCode, (/**
         * @param {?} dataCode
         * @return {?}
         */
        function (dataCode) { return dataCode.fieldLabelId; }));
        return dataCodes;
    };
    /** 得到新旧内容中所有的key */
    /**
     * 得到新旧内容中所有的key
     * @private
     * @param {?} row
     * @return {?}
     */
    ChgdrDataBuilder.prototype.extractChangeColumnKeys = /**
     * 得到新旧内容中所有的key
     * @private
     * @param {?} row
     * @return {?}
     */
    function (row) {
        /** @type {?} */
        var keysSet = new Set();
        row.oldContent && row.oldContent.forEach((/**
         * @param {?} value
         * @param {?} key
         * @return {?}
         */
        function (value, key) { return keysSet.add(key); }));
        row.newContent && row.newContent.forEach((/**
         * @param {?} value
         * @param {?} key
         * @return {?}
         */
        function (value, key) { return keysSet.add(key); }));
        /** @type {?} */
        var keys = Array.from(keysSet.keys());
        return keys;
    };
    /**
     * @private
     * @param {?} entityCode
     * @param {?} entityName
     * @return {?}
     */
    ChgdrDataBuilder.prototype.genChgdrDataEntityNode = /**
     * @private
     * @param {?} entityCode
     * @param {?} entityName
     * @return {?}
     */
    function (entityCode, entityName) {
        /** @type {?} */
        var node = new ChgdrDataEntityNode();
        node.entityCode = entityCode;
        node.entityName = entityName;
        node.rows = [];
        return node;
    };
    return ChgdrDataBuilder;
}());
export { ChgdrDataBuilder };
if (false) {
    /**
     * @type {?}
     * @private
     */
    ChgdrDataBuilder.prototype.handler;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hnZHItZGF0YS1idWlsZGVyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGdzcC1jbXAvY2hnZHIvIiwic291cmNlcyI6WyJsaWIvY2hnZHItZGF0YS12aWV3ZXIvY2hnZHItZGF0YS1idWlsZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFNQSxPQUFPLEVBQUUsU0FBUyxFQUFFLGdCQUFnQixFQUFFLGdCQUFnQixFQUFFLG1CQUFtQixFQUFFLGFBQWEsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUdqSDtJQUFBO0lBNEtBLENBQUM7Ozs7OztJQXpLRyx5Q0FBYzs7Ozs7SUFBZCxVQUFlLElBQXNCLEVBQUUsT0FBMkI7UUFBbEUsaUJBK0hDO1FBOUhHLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDOzs7WUFFbkIsU0FBUyxHQUFHLElBQUksU0FBUyxFQUFFO1FBQy9CLFNBQVMsQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLEVBQUUsQ0FBQztRQUNoRCxTQUFTLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUM7UUFDekMsU0FBUyxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDO1FBQ25DLFNBQVMsQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQztRQUMvQixTQUFTLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUM7UUFDbkMsU0FBUyxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxpQkFBaUIsRUFBRSxDQUFDLENBQUM7UUFDM0YsU0FBUyxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDO1FBQy9CLFNBQVMsQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQztRQUN2QyxTQUFTLENBQUMsV0FBVyxHQUFHLEVBQUUsQ0FBQzs7O1lBR3ZCLFFBQVEsR0FB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LENBQUM7SUFDaEIsQ0FBQzs7Ozs7OztJQUdPLGlEQUFzQjs7Ozs7O0lBQTlCLFVBQStCLFVBQWtCLEVBQUUsVUFBa0I7O1lBQzdELElBQUksR0FBRyxJQUFJLG1CQUFtQixFQUFFO1FBQ3BDLElBQUksQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDO1FBQzdCLElBQUksQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDO1FBQzdCLElBQUksQ0FBQyxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQ2YsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUVMLHVCQUFDO0FBQUQsQ0FBQyxBQTVLRCxJQTRLQzs7Ozs7OztJQTNLRyxtQ0FBb0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBpc1RvZGF5LCBmb3JtYXQgfSBmcm9tICdkYXRlLWZucyc7XHJcbmltcG9ydCB7IEdTUEJ1c2luZXNzRW50aXR5IH0gZnJvbSAnQGdzcC1iZWYvZ3NwLWJlLW1ldGFkYXRhJztcclxuaW1wb3J0IHsgSUdTUENvbW1vbk9iamVjdCwgSUdTUENvbW1vbkVsZW1lbnQsIEdTUEFzc29jaWF0aW9uLCBHU1BDb21tb25FbGVtZW50LCBHU1BFbGVtZW50RGF0YVR5cGUsIEdTUEVsZW1lbnRPYmplY3RUeXBlLCBHU1BFbnVtVmFsdWUgfSBmcm9tICdAZ3NwLWJlZi9nc3AtY20tbWV0YWRhdGEnO1xyXG5pbXBvcnQgeyBDaGFuZ2VEYXRhSGVhZGVyIH0gZnJvbSAnLi4vbW9kZWwvY2hhbmdlLWRhdGEtaGVhZGVyJztcclxuaW1wb3J0IHsgQ2hhbmdlRGF0YVJvdyB9IGZyb20gJy4uL21vZGVsL2NoYW5nZS1kYXRhLXJvdyc7XHJcbmltcG9ydCB7IE1hcFV0aWwgfSBmcm9tICcuLi91dGlsL21hcC51dGlsJztcclxuaW1wb3J0IHsgQ2hnZHJEYXRhLCBDaGdkckRhdGFSb3dOb2RlLCBDaGFuZ2VDb2x1bW5JdGVtLCBDaGdkckRhdGFFbnRpdHlOb2RlLCBEYXRhQ29kZUZpZWxkIH0gZnJvbSAnLi9jaGdkci1kYXRhJztcclxuaW1wb3J0IHsgQ2hnZHJDb25maWdIYW5kbGVyIH0gZnJvbSAnLi4vc2VydmljZS9jaGdkci1jb25maWctaGFuZGxlcic7XHJcblxyXG5leHBvcnQgY2xhc3MgQ2hnZHJEYXRhQnVpbGRlciB7XHJcbiAgICBwcml2YXRlIGhhbmRsZXI6IENoZ2RyQ29uZmlnSGFuZGxlcjtcclxuXHJcbiAgICBidWlsZENoZ2RyRGF0YShkYXRhOiBDaGFuZ2VEYXRhSGVhZGVyLCBoYW5kbGVyOiBDaGdkckNvbmZpZ0hhbmRsZXIpOiBDaGdkckRhdGEge1xyXG4gICAgICAgIHRoaXMuaGFuZGxlciA9IGhhbmRsZXI7XHJcbiAgICAgICAgLy/liJ3lp4vljJblj5jmm7Tml6Xlv5fln7rmnKzkv6Hmga9cclxuICAgICAgICBsZXQgY2hnZHJEYXRhID0gbmV3IENoZ2RyRGF0YSgpO1xyXG4gICAgICAgIGNoZ2RyRGF0YS5lbnRpdHlOYW1lID0gdGhpcy5oYW5kbGVyLmdldEJlTmFtZSgpO1xyXG4gICAgICAgIGNoZ2RyRGF0YS5vcGVyYXRlVHlwZSA9IGRhdGEub3BlcmF0ZVR5cGU7XHJcbiAgICAgICAgY2hnZHJEYXRhLnVzZXJOYW1lID0gZGF0YS51c2VyTmFtZTtcclxuICAgICAgICBjaGdkckRhdGEuZGF0YUlkID0gZGF0YS5kYXRhSWQ7XHJcbiAgICAgICAgY2hnZHJEYXRhLmRhdGFDb2RlID0gZGF0YS5kYXRhQ29kZTtcclxuICAgICAgICBjaGdkckRhdGEuZGF0YUNvZGVzID0gdGhpcy5idWlsZERhdGFDb2RlcyhkYXRhLmRhdGFDb2RlLCB0aGlzLmhhbmRsZXIuZ2V0TWFpbk9iamVjdENvZGUoKSk7XHJcbiAgICAgICAgY2hnZHJEYXRhLnJlYXNvbiA9IGRhdGEucmVhc29uO1xyXG4gICAgICAgIGNoZ2RyRGF0YS5jaGFuZ2VUaW1lID0gZGF0YS5jaGFuZ2VUaW1lO1xyXG4gICAgICAgIGNoZ2RyRGF0YS5lbnRpdHlOb2RlcyA9IFtdO1xyXG5cclxuICAgICAgICAvL+WIhuWxgue7hOe7h+WPmOabtOaXpeW/l+ihjFxyXG4gICAgICAgIGxldCByb3dOb2RlczogQ2hnZHJEYXRhUm93Tm9kZVtdID0gW107XHJcbiAgICAgICAgISFkYXRhLnJvd3MgJiYgZGF0YS5yb3dzLmZvckVhY2gocm93ID0+IHtcclxuICAgICAgICAgICAgaWYgKCFyb3cpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBsZXQgcm93Tm9kZSA9IG5ldyBDaGdkckRhdGFSb3dOb2RlKCk7XHJcbiAgICAgICAgICAgIHJvd05vZGUuaWQgPSByb3cuaWQ7XHJcbiAgICAgICAgICAgIHJvd05vZGUucGFyZW50RGF0YUlkID0gcm93LnBhcmVudERhdGFJZDtcclxuICAgICAgICAgICAgcm93Tm9kZS5kYXRhSWQgPSByb3cuZGF0YUlkO1xyXG4gICAgICAgICAgICByb3dOb2RlLmRhdGFDb2RlID0gcm93LmRhdGFDb2RlO1xyXG4gICAgICAgICAgICByb3dOb2RlLmRhdGFDb2RlcyA9IHRoaXMuYnVpbGREYXRhQ29kZXMocm93LmRhdGFDb2RlLCByb3cuZW50aXR5Q29kZSk7XHJcbiAgICAgICAgICAgIHJvd05vZGUuZW50aXR5Q29kZSA9IHJvdy5lbnRpdHlDb2RlO1xyXG4gICAgICAgICAgICByb3dOb2RlLmVudGl0eU5hbWUgPSB0aGlzLmhhbmRsZXIuZ2V0RW50aXR5TmFtZU9yRGVmYXVsdChyb3cuZW50aXR5Q29kZSk7XHJcbiAgICAgICAgICAgIHJvd05vZGUub3BlcmF0ZVR5cGUgPSByb3cub3BlcmF0ZVR5cGU7XHJcbiAgICAgICAgICAgIHJvd05vZGUuZW50aXR5Tm9kZXMgPSBbXTtcclxuXHJcbiAgICAgICAgICAgIC8v57uE57uH5YiX55qE5Y+Y5pu05L+h5oGvXHJcbiAgICAgICAgICAgIGxldCBjaGFuZ2VDb2x1bW5LZXlzOiBzdHJpbmdbXSA9IHRoaXMuZXh0cmFjdENoYW5nZUNvbHVtbktleXMocm93KTtcclxuICAgICAgICAgICAgbGV0IGNvbHVtblZhbHVlQ2hhbmdlczogQ2hhbmdlQ29sdW1uSXRlbVtdID0gW107XHJcbiAgICAgICAgICAgIGNoYW5nZUNvbHVtbktleXMuZm9yRWFjaCgoa2V5KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBsZXQgY29sdW1uID0gbmV3IENoYW5nZUNvbHVtbkl0ZW0oKTtcclxuICAgICAgICAgICAgICAgIGNvbHVtbi5maWVsZExhYmVsID0ga2V5O1xyXG4gICAgICAgICAgICAgICAgY29sdW1uLmZpZWxkTmFtZSA9IHRoaXMuaGFuZGxlci5nZXRFbnRpdHlGaWVsZE5hbWVPckRlZmF1bHQocm93LmVudGl0eUNvZGUsIGtleSk7XHJcbiAgICAgICAgICAgICAgICBjb2x1bW4ub2xkVmFsdWUgPSB0aGlzLmhhbmRsZXIuZm9ybWF0RmllbGRWYWx1ZShyb3cub2xkQ29udGVudC5nZXQoa2V5KSwgcm93LmVudGl0eUNvZGUsIGtleSk7XHJcbiAgICAgICAgICAgICAgICBjb2x1bW4ubmV3VmFsdWUgPSB0aGlzLmhhbmRsZXIuZm9ybWF0RmllbGRWYWx1ZShyb3cubmV3Q29udGVudC5nZXQoa2V5KSwgcm93LmVudGl0eUNvZGUsIGtleSk7XHJcblxyXG4gICAgICAgICAgICAgICAgbGV0IGVsZTogSUdTUENvbW1vbkVsZW1lbnQgPSB0aGlzLmhhbmRsZXIuZ2V0RWxlbWVudChyb3cuZW50aXR5Q29kZSwga2V5KTtcclxuICAgICAgICAgICAgICAgIGlmIChlbGUpIHtcclxuICAgICAgICAgICAgICAgICAgICAvL+WIpOaWreaYr+WQpuaYr+WFs+iBlOWtl+autVxyXG4gICAgICAgICAgICAgICAgICAgIGNvbHVtbi5oYXNBc3NvY2lhdGlvbiA9IGVsZS5PYmplY3RUeXBlID09IFwiQXNzb2NpYXRpb25cIiAmJiBlbGUuSXNVZHQgPT0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgY29sdW1uLmlzQXNzb2NpYXRpb25SZWZGaWVsZCA9IGVsZS5Jc1JlZkVsZW1lbnQ7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IHBhcmVudEVsZW1lbnQgPSB0aGlzLmhhbmRsZXIuZ2V0UGFyZW50RWxlbWVudChyb3cuZW50aXR5Q29kZSwga2V5KTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAocGFyZW50RWxlbWVudCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb2x1bW4uYmVsb25nRmllbGRMYWJlbElkID0gcGFyZW50RWxlbWVudC5MYWJlbElEO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBjb2x1bW5WYWx1ZUNoYW5nZXMucHVzaChjb2x1bW4pO1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAvL+WPmOabtOWAvOaOkuW6j1xyXG4gICAgICAgICAgICB0aGlzLmhhbmRsZXIuc29ydChjb2x1bW5WYWx1ZUNoYW5nZXMsIHJvdy5lbnRpdHlDb2RlLCAoY29sdW1uKT0+Y29sdW1uLmZpZWxkTGFiZWwpO1xyXG5cclxuICAgICAgICAgICAgLy/lkIjlubblhbPogZTluKblh7rlrZfmrrVcclxuICAgICAgICAgICAgbGV0IGNvbHVtbk1hcDogTWFwPHN0cmluZywgQ2hhbmdlQ29sdW1uSXRlbT4gPSBuZXcgTWFwKCk7XHJcbiAgICAgICAgICAgIGNvbHVtblZhbHVlQ2hhbmdlcy5mb3JFYWNoKChjb2x1bW4pID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbHVtbk1hcC5zZXQoY29sdW1uLmZpZWxkTGFiZWwsIGNvbHVtbik7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAvLzEuIOenu+mZpOaJgOacieWFs+iBlOW4puWHuuWtl+aute+8jOW5tumZhOWKoOWIsOWFtuaJgOWxnuWFs+iBlOWtl+auteeahGNoaWxkcmVu5bGe5oCn5LiKXHJcbiAgICAgICAgICAgIGNvbHVtblZhbHVlQ2hhbmdlcyA9IGNvbHVtblZhbHVlQ2hhbmdlcy5maWx0ZXIoKGNvbHVtbikgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGNvbHVtbi5pc0Fzc29jaWF0aW9uUmVmRmllbGQpIHtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgcGFyZW50Q29sdW1uOiBDaGFuZ2VDb2x1bW5JdGVtID0gY29sdW1uTWFwLmdldChjb2x1bW4uYmVsb25nRmllbGRMYWJlbElkKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAocGFyZW50Q29sdW1uKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8v5om+5Yiw54i257qn5a2X5q615YiZ5re75Yqg5Li654i2XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudENvbHVtbi5jaGlsZHJlbi5wdXNoKGNvbHVtbik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgLy8yLiDovazmjaLlhbPogZTlrZfmrrXvvIzlsIblhbblrZDnuqfnmoTlj5jmm7TlgLzmi7zmjqXkvZzkuLrlhbblj5jmm7TlgLxcclxuICAgICAgICAgICAgY29sdW1uVmFsdWVDaGFuZ2VzID0gY29sdW1uVmFsdWVDaGFuZ2VzLm1hcDxDaGFuZ2VDb2x1bW5JdGVtPihjb2x1bW4gPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGNvbHVtbi5oYXNBc3NvY2lhdGlvbiAmJiBjb2x1bW4uY2hpbGRyZW4ubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIC8v5aaC5p6c5piv5YWz6IGU5a2X5q6177yM5LiU5a2Y5Zyo5YWz6IGU5bim5Ye65a2X5q61XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IHZpcnR1YWxDb2x1bW46IENoYW5nZUNvbHVtbkl0ZW0gPSBPYmplY3QuYXNzaWduKG5ldyBDaGFuZ2VDb2x1bW5JdGVtKCksIGNvbHVtbik7XHJcbiAgICAgICAgICAgICAgICAgICAgdmlydHVhbENvbHVtbi5vcmlnaW5hbENvbHVtbkl0ZW0gPSBjb2x1bW47XHJcbiAgICAgICAgICAgICAgICAgICAgdmlydHVhbENvbHVtbi5vbGRWYWx1ZSA9IGNvbHVtbi5jaGlsZHJlbi5tYXAoY2hpbGQgPT4gY2hpbGQub2xkVmFsdWUpLmpvaW4oXCI7XCIpO1xyXG4gICAgICAgICAgICAgICAgICAgIHZpcnR1YWxDb2x1bW4ubmV3VmFsdWUgPSBjb2x1bW4uY2hpbGRyZW4ubWFwKGNoaWxkID0+IGNoaWxkLm5ld1ZhbHVlKS5qb2luKFwiO1wiKTtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmlydHVhbENvbHVtbjtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbHVtbjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICByb3dOb2RlLmNoYW5nZXMgPSBjb2x1bW5WYWx1ZUNoYW5nZXM7XHJcblxyXG4gICAgICAgICAgICByb3dOb2Rlcy5wdXNoKHJvd05vZGUpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICAvKiogZGF0YUlk5LiO5Y+Y5pu06KGM55qETWFwICovXHJcbiAgICAgICAgbGV0IGRhdGFJZFJvd01hcDogTWFwPHN0cmluZywgQ2hnZHJEYXRhUm93Tm9kZT4gPSBuZXcgTWFwKCk7XHJcbiAgICAgICAgcm93Tm9kZXMuZm9yRWFjaChub2RlID0+IGRhdGFJZFJvd01hcC5zZXQobm9kZS5kYXRhSWQsIG5vZGUpKTtcclxuXHJcbiAgICAgICAgcm93Tm9kZXMuZm9yRWFjaChub2RlID0+IHtcclxuICAgICAgICAgICAgaWYgKCFub2RlLnBhcmVudERhdGFJZCkge1xyXG4gICAgICAgICAgICAgICAgLy/moLnoioLngrlcclxuICAgICAgICAgICAgICAgIGxldCBlbnRpdHlOb2RlID0gdGhpcy5nZW5DaGdkckRhdGFFbnRpdHlOb2RlKG5vZGUuZW50aXR5Q29kZSwgbm9kZS5lbnRpdHlOYW1lKTtcclxuICAgICAgICAgICAgICAgIGVudGl0eU5vZGUucm93cy5wdXNoKG5vZGUpO1xyXG4gICAgICAgICAgICAgICAgY2hnZHJEYXRhLmVudGl0eU5vZGVzLnB1c2goZW50aXR5Tm9kZSk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgbGV0IHBhcmVudFJvd05vZGUgPSBkYXRhSWRSb3dNYXAuZ2V0KG5vZGUucGFyZW50RGF0YUlkKTtcclxuICAgICAgICAgICAgaWYgKCEhcGFyZW50Um93Tm9kZSkge1xyXG4gICAgICAgICAgICAgICAgLy/kuIrnuqfoioLngrnlrZjlnKjnmoToioLngrlcclxuICAgICAgICAgICAgICAgIGxldCBlbnRpdHlOb2RlID0gcGFyZW50Um93Tm9kZS5lbnRpdHlOb2Rlcy5maW5kKGVuID0+IGVuLmVudGl0eUNvZGUgPT0gbm9kZS5lbnRpdHlDb2RlKTtcclxuICAgICAgICAgICAgICAgIGlmICghZW50aXR5Tm9kZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGVudGl0eU5vZGUgPSB0aGlzLmdlbkNoZ2RyRGF0YUVudGl0eU5vZGUobm9kZS5lbnRpdHlDb2RlLCBub2RlLmVudGl0eU5hbWUpO1xyXG4gICAgICAgICAgICAgICAgICAgIHBhcmVudFJvd05vZGUuZW50aXR5Tm9kZXMucHVzaChlbnRpdHlOb2RlKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVudGl0eU5vZGUucm93cy5wdXNoKG5vZGUpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgLy/kuIrnuqfoioLngrnkuI3lrZjlnKjnmoToioLngrlcclxuICAgICAgICAgICAgICAgIC8vVE9ETyDkuIrnuqfoioLngrnkuI3lrZjlnKjnmoToioLngrnmmK/lkKbpnIDopoHmnoTpgKDlrozmlbTnmoTkuIrnuqfnu5PmnoTvvJ9cclxuICAgICAgICAgICAgICAgIGxldCBlbnRpdHlOb2RlID0gdGhpcy5nZW5DaGdkckRhdGFFbnRpdHlOb2RlKG5vZGUuZW50aXR5Q29kZSwgbm9kZS5lbnRpdHlOYW1lKTtcclxuICAgICAgICAgICAgICAgIGVudGl0eU5vZGUucm93cy5wdXNoKG5vZGUpO1xyXG4gICAgICAgICAgICAgICAgY2hnZHJEYXRhLmVudGl0eU5vZGVzLnB1c2goZW50aXR5Tm9kZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KVxyXG5cclxuICAgICAgICByZXR1cm4gY2hnZHJEYXRhO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgYnVpbGREYXRhQ29kZXMoZGF0YUNvZGU6IE1hcDxzdHJpbmcsIHN0cmluZz4sIGVudGl0eUNvZGU6IHN0cmluZyk6IERhdGFDb2RlRmllbGRbXSB7XHJcbiAgICAgICAgbGV0IGRhdGFDb2RlczogRGF0YUNvZGVGaWVsZFtdID0gW107XHJcbiAgICAgICAgZGF0YUNvZGUgJiYgZGF0YUNvZGUuZm9yRWFjaCgodmFsdWUsIGtleSkgPT4ge1xyXG4gICAgICAgICAgICBsZXQgZGF0YUNvZGVGaWVsZDogRGF0YUNvZGVGaWVsZCA9IG5ldyBEYXRhQ29kZUZpZWxkKCk7XHJcbiAgICAgICAgICAgIGlmIChrZXkgPT0gXCJfJGRhdGFDb2RlXCIpIHtcclxuICAgICAgICAgICAgICAgIGRhdGFDb2RlRmllbGQuZmllbGRMYWJlbElkID0gXCJkYXRhQ29kZVwiO1xyXG4gICAgICAgICAgICAgICAgZGF0YUNvZGVGaWVsZC5maWVsZE5hbWUgPSBcIuS4muWKoee8luWPt1wiO1xyXG4gICAgICAgICAgICAgICAgZGF0YUNvZGVGaWVsZC5maWVsZFZhbHVlID0gdmFsdWU7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBkYXRhQ29kZUZpZWxkLmZpZWxkTGFiZWxJZCA9IGtleTtcclxuICAgICAgICAgICAgICAgIGRhdGFDb2RlRmllbGQuZmllbGROYW1lID0gdGhpcy5oYW5kbGVyLmdldEVudGl0eUZpZWxkTmFtZU9yRGVmYXVsdChlbnRpdHlDb2RlLCBrZXkpO1xyXG4gICAgICAgICAgICAgICAgZGF0YUNvZGVGaWVsZC5maWVsZFZhbHVlID0gdGhpcy5oYW5kbGVyLmZvcm1hdEZpZWxkVmFsdWUodmFsdWUsIGVudGl0eUNvZGUsIGtleSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZGF0YUNvZGVzLnB1c2goZGF0YUNvZGVGaWVsZCk7XHJcbiAgICAgICAgfSlcclxuXHJcbiAgICAgICAgLy/kuJrliqHnvJblj7fmjpLluo9cclxuICAgICAgICB0aGlzLmhhbmRsZXIuc29ydChkYXRhQ29kZXMsIGVudGl0eUNvZGUsIChkYXRhQ29kZSk9PmRhdGFDb2RlLmZpZWxkTGFiZWxJZCk7XHJcblxyXG4gICAgICAgIHJldHVybiBkYXRhQ29kZXM7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqIOW+l+WIsOaWsOaXp+WGheWuueS4reaJgOacieeahGtleSAqL1xyXG4gICAgcHJpdmF0ZSBleHRyYWN0Q2hhbmdlQ29sdW1uS2V5cyhyb3c6IENoYW5nZURhdGFSb3cpOiBzdHJpbmdbXSB7XHJcbiAgICAgICAgbGV0IGtleXNTZXQ6IFNldDxzdHJpbmc+ID0gbmV3IFNldCgpO1xyXG4gICAgICAgIHJvdy5vbGRDb250ZW50ICYmIHJvdy5vbGRDb250ZW50LmZvckVhY2goKHZhbHVlLCBrZXkpID0+IGtleXNTZXQuYWRkKGtleSkpO1xyXG4gICAgICAgIHJvdy5uZXdDb250ZW50ICYmIHJvdy5uZXdDb250ZW50LmZvckVhY2goKHZhbHVlLCBrZXkpID0+IGtleXNTZXQuYWRkKGtleSkpO1xyXG4gICAgICAgIGNvbnN0IGtleXM6IHN0cmluZ1tdID0gQXJyYXkuZnJvbShrZXlzU2V0LmtleXMoKSk7XHJcbiAgICAgICAgcmV0dXJuIGtleXM7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIHByaXZhdGUgZ2VuQ2hnZHJEYXRhRW50aXR5Tm9kZShlbnRpdHlDb2RlOiBzdHJpbmcsIGVudGl0eU5hbWU6IHN0cmluZyk6IENoZ2RyRGF0YUVudGl0eU5vZGUge1xyXG4gICAgICAgIGxldCBub2RlID0gbmV3IENoZ2RyRGF0YUVudGl0eU5vZGUoKTtcclxuICAgICAgICBub2RlLmVudGl0eUNvZGUgPSBlbnRpdHlDb2RlO1xyXG4gICAgICAgIG5vZGUuZW50aXR5TmFtZSA9IGVudGl0eU5hbWU7XHJcbiAgICAgICAgbm9kZS5yb3dzID0gW107XHJcbiAgICAgICAgcmV0dXJuIG5vZGU7XHJcbiAgICB9XHJcblxyXG59Il19