/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable, Injector } from '@angular/core';
import { HttpService, SessionService } from '@ecp-caf/caf-common';
import { of } from 'rxjs';
import { map, tap } from 'rxjs/operators';
import { OperateType } from '../model/operate-type';
import { MapUtil } from '../util/map.util';
import * as i0 from "@angular/core";
import * as i1 from "@ecp-caf/caf-common";
/** @type {?} */
const ServerIP = '/';
/** @type {?} */
const chgdrUrl = `${ServerIP}api/runtime/chgdr/v1.0`;
export class ChgdrService {
    /**
     * @param {?} http
     * @param {?} sessionService
     * @param {?} injector
     */
    constructor(http, sessionService, injector) {
        this.http = http;
        this.sessionService = sessionService;
        this.injector = injector;
        this.rootDataCodeFieldsMap = new Map();
    }
    /**
     * @param {?} currentQueryParam
     * @return {?}
     */
    queryChangeDataHeader(currentQueryParam) {
        /** @type {?} */
        let obj = Object.assign({}, currentQueryParam);
        if (currentQueryParam.dataCode) {
            obj.dataCode = MapUtil.convertMapToObject(currentQueryParam.dataCode);
        }
        /** @type {?} */
        let json = JSON.stringify(obj);
        /** @type {?} */
        let queryParam = encodeURIComponent(json);
        /** @type {?} */
        let url = `${chgdrUrl}?queryParam=${queryParam}`;
        return this.http.get(url).pipe(map((/**
         * @param {?} data
         * @return {?}
         */
        data => {
            if (!data) {
                return data;
            }
            /** @type {?} */
            let queryResult = (/** @type {?} */ ((/** @type {?} */ (data))));
            queryResult && queryResult.headers && queryResult.headers.forEach((/**
             * @param {?} header
             * @return {?}
             */
            header => {
                //TODO 待删，兼容老数据格式
                if (typeof header.dataCode == "string") {
                    header.dataCode = JSON.parse(header.dataCode);
                }
                header.dataCode = MapUtil.convertObjectToMap(header.dataCode);
                header.changeTime = this.toDate(header.changeTime);
                header.operateType = OperateType.parse(header.operateType);
            }));
            return queryResult;
        })));
    }
    /**
     * @param {?} beId
     * @return {?}
     */
    getRootEntityDataCodeFields(beId) {
        if (!beId) {
            return of([]);
        }
        if (this.rootDataCodeFieldsMap.has(beId)) {
            //直接从缓存中获取
            return of(this.rootDataCodeFieldsMap.get(beId));
        }
        else {
            //获取结果并存入缓存
            /** @type {?} */
            let url = `${chgdrUrl}/rootDataCodeFields?beId=${beId}`;
            return ((/** @type {?} */ ((/** @type {?} */ ((this.http.get(url)))))))
                .pipe(tap((/**
             * @param {?} data
             * @return {?}
             */
            data => this.rootDataCodeFieldsMap.set(beId, data))));
        }
    }
    /**
     * 将字符串或数字转为Date
     * @private
     * @param {?} date
     * @return {?}
     */
    toDate(date) {
        if (typeof date == "string") {
            return new Date(date);
        }
        else if (typeof date == "number") {
            return new Date(date);
        }
        else {
            return date;
        }
    }
    /**
     * @param {?} id
     * @param {?} changeTime
     * @return {?}
     */
    getChangeData(id, changeTime) {
        /** @type {?} */
        let json = JSON.stringify(changeTime);
        /** @type {?} */
        let queryParam = encodeURIComponent(json);
        /** @type {?} */
        let url = `${chgdrUrl}/${id}?changeTime=${queryParam}`;
        return this.http.get(url).pipe(map((/**
         * @param {?} data
         * @return {?}
         */
        data => {
            if (!data) {
                return data;
            }
            /** @type {?} */
            let sh = (/** @type {?} */ ((/** @type {?} */ (data))));
            //TODO 待删，兼容老数据格式
            if (typeof sh.dataCode == "string") {
                sh.dataCode = JSON.parse(sh.dataCode);
            }
            sh.dataCode = MapUtil.convertObjectToMap(sh.dataCode);
            sh.changeTime = this.toDate(sh.changeTime);
            sh.operateType = OperateType.parse(sh.operateType);
            sh.rows = sh.rows || [];
            sh.rows.forEach((/**
             * @param {?} row
             * @return {?}
             */
            row => {
                if (!row) {
                    return;
                }
                row.operateType = OperateType.parse(row.operateType);
                //TODO 待删，兼容老数据格式
                if (typeof row.dataCode == "string") {
                    row.dataCode = JSON.parse(row.dataCode);
                }
                row.dataCode = MapUtil.convertObjectToMap(row.dataCode);
                row.oldContent = (/** @type {?} */ (MapUtil.convertObjectToMap(row.oldContent))) || new Map();
                row.newContent = (/** @type {?} */ (MapUtil.convertObjectToMap(row.newContent))) || new Map();
            }));
            return sh;
        })));
    }
}
ChgdrService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
/** @nocollapse */
ChgdrService.ctorParameters = () => [
    { type: HttpService },
    { type: SessionService },
    { type: Injector }
];
/** @nocollapse */ ChgdrService.ngInjectableDef = i0.defineInjectable({ factory: function ChgdrService_Factory() { return new ChgdrService(i0.inject(i1.HttpService), i0.inject(i1.SessionService), i0.inject(i0.INJECTOR)); }, token: ChgdrService, providedIn: "root" });
if (false) {
    /**
     * @type {?}
     * @private
     */
    ChgdrService.prototype.rootDataCodeFieldsMap;
    /**
     * @type {?}
     * @private
     */
    ChgdrService.prototype.http;
    /**
     * @type {?}
     * @private
     */
    ChgdrService.prototype.sessionService;
    /**
     * @type {?}
     * @private
     */
    ChgdrService.prototype.injector;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hnZHIuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0Bnc3AtY21wL2NoZ2RyLyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2UvY2hnZHIuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDckQsT0FBTyxFQUFFLFdBQVcsRUFBRSxjQUFjLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUNsRSxPQUFPLEVBQWMsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3RDLE9BQU8sRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFLMUMsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQ3BELE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQzs7OztNQUVyQyxRQUFRLEdBQUcsR0FBRzs7TUFDZCxRQUFRLEdBQUcsR0FBRyxRQUFRLHdCQUF3QjtBQUtwRCxNQUFNLE9BQU8sWUFBWTs7Ozs7O0lBR3ZCLFlBQW9CLElBQWlCLEVBQzNCLGNBQThCLEVBQzlCLFFBQWtCO1FBRlIsU0FBSSxHQUFKLElBQUksQ0FBYTtRQUMzQixtQkFBYyxHQUFkLGNBQWMsQ0FBZ0I7UUFDOUIsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUpwQiwwQkFBcUIsR0FBcUMsSUFBSSxHQUFHLEVBQUUsQ0FBQztJQUk1QyxDQUFDOzs7OztJQUUxQixxQkFBcUIsQ0FBQyxpQkFBdUM7O1lBQzlELEdBQUcsR0FBUSxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxpQkFBaUIsQ0FBQztRQUNuRCxJQUFJLGlCQUFpQixDQUFDLFFBQVEsRUFBRTtZQUM5QixHQUFHLENBQUMsUUFBUSxHQUFHLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQyxpQkFBaUIsQ0FBQyxRQUFRLENBQUMsQ0FBQztTQUN2RTs7WUFFRyxJQUFJLEdBQUcs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RyxDQUFDLFFBQVEsQ0FBQyxDQUFDO2dCQUN4RCxHQUFHLENBQUMsVUFBVSxHQUFHLG1CQUFxQixPQUFPLENBQUMsa0JBQWtCLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxFQUFBLElBQUksSUFBSSxHQUFHLEVBQUUsQ0FBQztnQkFDOUYsR0FBRyxDQUFDLFVBQVUsR0FBRyxtQkFBcUIsT0FBTyxDQUFDLGtCQUFrQixDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsRUFBQSxJQUFJLElBQUksR0FBRyxFQUFFLENBQUM7WUFDaEcsQ0FBQyxFQUFDLENBQUM7WUFDSCxPQUFPLEVBQUUsQ0FBQztRQUNaLENBQUMsRUFBQyxDQUFDLENBQUM7SUFDTixDQUFDOzs7WUFsR0YsVUFBVSxTQUFDO2dCQUNWLFVBQVUsRUFBRSxNQUFNO2FBQ25COzs7O1lBZlEsV0FBVztZQUFFLGNBQWM7WUFEZixRQUFROzs7Ozs7OztJQWtCM0IsNkNBQTRFOzs7OztJQUVoRSw0QkFBeUI7Ozs7O0lBQ25DLHNDQUFzQzs7Ozs7SUFDdEMsZ0NBQTBCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgSW5qZWN0b3IgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEh0dHBTZXJ2aWNlLCBTZXNzaW9uU2VydmljZSB9IGZyb20gJ0BlY3AtY2FmL2NhZi1jb21tb24nO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgb2YgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IG1hcCwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgQ2hhbmdlRGF0YUhlYWRlciB9IGZyb20gJy4uL21vZGVsL2NoYW5nZS1kYXRhLWhlYWRlcic7XG5pbXBvcnQgeyBDaGFuZ2VEYXRhUXVlcnlQYXJhbSB9IGZyb20gJy4uL21vZGVsL2NoYW5nZS1kYXRhLXF1ZXJ5LXBhcmFtJztcbmltcG9ydCB7IENoYW5nZURhdGFRdWVyeVJlc3VsdCB9IGZyb20gJy4uL21vZGVsL2NoYW5nZS1kYXRhLXF1ZXJ5LXJlc3VsdCc7XG5pbXBvcnQgeyBDaGdMb2dDb25maWdGaWVsZCB9IGZyb20gJy4uL21vZGVsL2NoZ2RyLWNvbmZpZy1maWVsZCc7XG5pbXBvcnQgeyBPcGVyYXRlVHlwZSB9IGZyb20gJy4uL21vZGVsL29wZXJhdGUtdHlwZSc7XG5pbXBvcnQgeyBNYXBVdGlsIH0gZnJvbSAnLi4vdXRpbC9tYXAudXRpbCc7XG5cbmNvbnN0IFNlcnZlcklQID0gJy8nO1xuY29uc3QgY2hnZHJVcmwgPSBgJHtTZXJ2ZXJJUH1hcGkvcnVudGltZS9jaGdkci92MS4wYDtcblxuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgQ2hnZHJTZXJ2aWNlIHtcbiAgcHJpdmF0ZSByb290RGF0YUNvZGVGaWVsZHNNYXA6IE1hcDxzdHJpbmcsIENoZ0xvZ0NvbmZpZ0ZpZWxkW10+ID0gbmV3IE1hcCgpO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgaHR0cDogSHR0cFNlcnZpY2UsXG4gICAgcHJpdmF0ZSBzZXNzaW9uU2VydmljZTogU2Vzc2lvblNlcnZpY2UsXG4gICAgcHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IpIHsgfVxuXG4gIHB1YmxpYyBxdWVyeUNoYW5nZURhdGFIZWFkZXIoY3VycmVudFF1ZXJ5UGFyYW06IENoYW5nZURhdGFRdWVyeVBhcmFtKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBsZXQgb2JqOiBhbnkgPSBPYmplY3QuYXNzaWduKHt9LCBjdXJyZW50UXVlcnlQYXJhbSk7XG4gICAgaWYgKGN1cnJlbnRRdWVyeVBhcmFtLmRhdGFDb2RlKSB7XG4gICAgICBvYmouZGF0YUNvZGUgPSBNYXBVdGlsLmNvbnZlcnRNYXBUb09iamVjdChjdXJyZW50UXVlcnlQYXJhbS5kYXRhQ29kZSk7XG4gICAgfVxuXG4gICAgbGV0IGpzb24gPSBKU09OLnN0cmluZ2lmeShvYmopO1xuICAgIGxldCBxdWVyeVBhcmFtID0gZW5jb2RlVVJJQ29tcG9uZW50KGpzb24pO1xuICAgIGxldCB1cmwgPSBgJHtjaGdkclVybH0/cXVlcnlQYXJhbT0ke3F1ZXJ5UGFyYW19YDtcbiAgICByZXR1cm4gdGhpcy5odHRwLmdldCh1cmwpLnBpcGUobWFwKGRhdGEgPT4ge1xuICAgICAgaWYgKCFkYXRhKSB7XG4gICAgICAgIHJldHVybiBkYXRhO1xuICAgICAgfVxuICAgICAgbGV0IHF1ZXJ5UmVzdWx0OiBDaGFuZ2VEYXRhUXVlcnlSZXN1bHQgPSA8Q2hhbmdlRGF0YVF1ZXJ5UmVzdWx0Pjx1bmtub3duPmRhdGE7XG4gICAgICBxdWVyeVJlc3VsdCAmJiBxdWVyeVJlc3VsdC5oZWFkZXJzICYmIHF1ZXJ5UmVzdWx0LmhlYWRlcnMuZm9yRWFjaChoZWFkZXIgPT4ge1xuICAgICAgICAvL1RPRE8g5b6F5Yig77yM5YW85a656ICB5pWw5o2u5qC85byPXG4gICAgICAgIGlmICh0eXBlb2YgaGVhZGVyLmRhdGFDb2RlID09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgICBoZWFkZXIuZGF0YUNvZGUgPSBKU09OLnBhcnNlKGhlYWRlci5kYXRhQ29kZSk7XG4gICAgICAgIH1cblxuICAgICAgICBoZWFkZXIuZGF0YUNvZGUgPSBNYXBVdGlsLmNvbnZlcnRPYmplY3RUb01hcChoZWFkZXIuZGF0YUNvZGUpO1xuICAgICAgICBoZWFkZXIuY2hhbmdlVGltZSA9IHRoaXMudG9EYXRlKGhlYWRlci5jaGFuZ2VUaW1lKTtcbiAgICAgICAgaGVhZGVyLm9wZXJhdGVUeXBlID0gT3BlcmF0ZVR5cGUucGFyc2UoaGVhZGVyLm9wZXJhdGVUeXBlKTtcbiAgICAgIH0pXG4gICAgICByZXR1cm4gcXVlcnlSZXN1bHQ7XG4gICAgfSkpO1xuICB9XG5cbiAgcHVibGljIGdldFJvb3RFbnRpdHlEYXRhQ29kZUZpZWxkcyhiZUlkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPENoZ0xvZ0NvbmZpZ0ZpZWxkW10+IHtcbiAgICBpZiAoIWJlSWQpIHtcbiAgICAgIHJldHVybiBvZihbXSk7XG4gICAgfVxuICAgIGlmICh0aGlzLnJvb3REYXRhQ29kZUZpZWxkc01hcC5oYXMoYmVJZCkpIHtcbiAgICAgIC8v55u05o6l5LuO57yT5a2Y5Lit6I635Y+WXG4gICAgICByZXR1cm4gb2YodGhpcy5yb290RGF0YUNvZGVGaWVsZHNNYXAuZ2V0KGJlSWQpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy/ojrflj5bnu5PmnpzlubblrZjlhaXnvJPlrZhcbiAgICAgIGxldCB1cmwgPSBgJHtjaGdkclVybH0vcm9vdERhdGFDb2RlRmllbGRzP2JlSWQ9JHtiZUlkfWA7XG4gICAgICByZXR1cm4gKDxPYnNlcnZhYmxlPENoZ0xvZ0NvbmZpZ0ZpZWxkW10+Pjx1bmtub3duPih0aGlzLmh0dHAuZ2V0KHVybCkpKVxuICAgICAgICAucGlwZSh0YXAoZGF0YSA9PiB0aGlzLnJvb3REYXRhQ29kZUZpZWxkc01hcC5zZXQoYmVJZCwgZGF0YSkpKTtcbiAgICB9XG4gIH1cblxuICAvKiog5bCG5a2X56ym5Liy5oiW5pWw5a2X6L2s5Li6RGF0ZSAqL1xuICBwcml2YXRlIHRvRGF0ZShkYXRlOiBhbnkpOiBEYXRlIHtcbiAgICBpZiAodHlwZW9mIGRhdGUgPT0gXCJzdHJpbmdcIikge1xuICAgICAgcmV0dXJuIG5ldyBEYXRlKGRhdGUpO1xuICAgIH0gZWxzZSBpZiAodHlwZW9mIGRhdGUgPT0gXCJudW1iZXJcIikge1xuICAgICAgcmV0dXJuIG5ldyBEYXRlKGRhdGUpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gZGF0ZTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgZ2V0Q2hhbmdlRGF0YShpZDogc3RyaW5nLCBjaGFuZ2VUaW1lOiBEYXRlKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBsZXQganNvbiA9IEpTT04uc3RyaW5naWZ5KGNoYW5nZVRpbWUpO1xuICAgIGxldCBxdWVyeVBhcmFtID0gZW5jb2RlVVJJQ29tcG9uZW50KGpzb24pO1xuICAgIGxldCB1cmwgPSBgJHtjaGdkclVybH0vJHtpZH0/Y2hhbmdlVGltZT0ke3F1ZXJ5UGFyYW19YDtcbiAgICByZXR1cm4gdGhpcy5odHRwLmdldCh1cmwpLnBpcGUobWFwKGRhdGEgPT4ge1xuICAgICAgaWYgKCFkYXRhKSB7XG4gICAgICAgIHJldHVybiBkYXRhO1xuICAgICAgfVxuICAgICAgbGV0IHNoOiBDaGFuZ2VEYXRhSGVhZGVyID0gPENoYW5nZURhdGFIZWFkZXI+PHVua25vd24+ZGF0YTtcbiAgICAgIC8vVE9ETyDlvoXliKDvvIzlhbzlrrnogIHmlbDmja7moLzlvI9cbiAgICAgIGlmICh0eXBlb2Ygc2guZGF0YUNvZGUgPT0gXCJzdHJpbmdcIikge1xuICAgICAgICBzaC5kYXRhQ29kZSA9IEpTT04ucGFyc2Uoc2guZGF0YUNvZGUpO1xuICAgICAgfVxuICAgICAgc2guZGF0YUNvZGUgPSBNYXBVdGlsLmNvbnZlcnRPYmplY3RUb01hcChzaC5kYXRhQ29kZSk7XG4gICAgICBzaC5jaGFuZ2VUaW1lID0gdGhpcy50b0RhdGUoc2guY2hhbmdlVGltZSk7XG4gICAgICBzaC5vcGVyYXRlVHlwZSA9IE9wZXJhdGVUeXBlLnBhcnNlKHNoLm9wZXJhdGVUeXBlKTtcblxuICAgICAgc2gucm93cyA9IHNoLnJvd3MgfHwgW107XG5cbiAgICAgIHNoLnJvd3MuZm9yRWFjaChyb3cgPT4ge1xuICAgICAgICBpZiAoIXJvdykge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICByb3cub3BlcmF0ZVR5cGUgPSBPcGVyYXRlVHlwZS5wYXJzZShyb3cub3BlcmF0ZVR5cGUpO1xuICAgICAgICAvL1RPRE8g5b6F5Yig77yM5YW85a656ICB5pWw5o2u5qC85byPXG4gICAgICAgIGlmICh0eXBlb2Ygcm93LmRhdGFDb2RlID09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgICByb3cuZGF0YUNvZGUgPSBKU09OLnBhcnNlKHJvdy5kYXRhQ29kZSk7XG4gICAgICAgIH1cbiAgICAgICAgcm93LmRhdGFDb2RlID0gTWFwVXRpbC5jb252ZXJ0T2JqZWN0VG9NYXAocm93LmRhdGFDb2RlKTtcbiAgICAgICAgcm93Lm9sZENvbnRlbnQgPSA8TWFwPHN0cmluZywgc3RyaW5nPj5NYXBVdGlsLmNvbnZlcnRPYmplY3RUb01hcChyb3cub2xkQ29udGVudCkgfHwgbmV3IE1hcCgpO1xuICAgICAgICByb3cubmV3Q29udGVudCA9IDxNYXA8c3RyaW5nLCBzdHJpbmc+Pk1hcFV0aWwuY29udmVydE9iamVjdFRvTWFwKHJvdy5uZXdDb250ZW50KSB8fCBuZXcgTWFwKCk7XG4gICAgICB9KTtcbiAgICAgIHJldHVybiBzaDtcbiAgICB9KSk7XG4gIH1cbn1cbiJdfQ==