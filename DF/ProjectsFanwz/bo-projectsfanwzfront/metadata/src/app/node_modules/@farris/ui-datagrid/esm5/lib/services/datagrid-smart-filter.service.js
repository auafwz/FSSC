/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { Subject } from 'rxjs';
import { ColumnFilterType } from '../types/data-column';
import { BooleanFilterControl, DateFilterControl, EnumFilterControl, NumberFilterControl, TextFilterControl } from '../plugins/smart-filter/controlData/filter-control.options';
var DatagridSmartFilterService = /** @class */ (function () {
    function DatagridSmartFilterService() {
        this.conditions = [];
        this.controlData = [];
        this.filterChanged = new Subject();
        this.removeFilter = new Subject();
        this.clearAllFilter = new Subject();
    }
    /**
     * @param {?} col
     * @return {?}
     */
    DatagridSmartFilterService.prototype.getColumnFilterData = /**
     * @param {?} col
     * @return {?}
     */
    function (col) {
        /** @type {?} */
        var filterControlData = {
            controltype: 'text',
        };
        if (col.filter !== undefined) {
            if (typeof col.filter === 'boolean') {
                if (col.formatter) {
                    if (typeof col.formatter === 'object' && Object.keys(col.formatter).length) {
                        /** @type {?} */
                        var options = col.formatter['options'];
                        switch (col.formatter['type']) {
                            case 'number':
                                return NumberFilterControl(col);
                            case 'enum':
                                return EnumFilterControl(col, options);
                            case 'boolean':
                                return BooleanFilterControl(col);
                            case 'datetime':
                                /** @type {?} */
                                var tye = 'datetime';
                                /** @type {?} */
                                var fmt = 'yyyy-MM-dd';
                                /** @type {?} */
                                var returnFmt = 'yyyy-MM-dd';
                                if (options && options.format) {
                                    fmt = options.format;
                                    if (fmt.indexOf('HH:') == -1) {
                                        tye = 'date';
                                    }
                                    else {
                                        returnFmt += ' HH:mm';
                                        if (fmt.indexOf('ss') > -1) {
                                            returnFmt += ':ss';
                                        }
                                    }
                                }
                                else {
                                    tye = 'date';
                                }
                                filterControlData = {
                                    controltype: 'flexibleDate',
                                    dateFormat: fmt,
                                    single: false,
                                    showType: 3,
                                    showTime: tye === 'datetime'
                                };
                                break;
                            default:
                                return TextFilterControl(col);
                        }
                    }
                }
                return filterControlData;
            }
            else {
                switch (col.filter.type) {
                    case ColumnFilterType.enum:
                        return EnumFilterControl(col, col.filter.options);
                    case ColumnFilterType.date:
                    case ColumnFilterType.datetime:
                        return DateFilterControl(col, col.filter.options);
                    case ColumnFilterType.number:
                        return NumberFilterControl(col);
                    case ColumnFilterType.boolean:
                        return BooleanFilterControl(col);
                }
            }
        }
        return filterControlData;
    };
    /**
     * @param {?} e
     * @return {?}
     */
    DatagridSmartFilterService.prototype.filterConditionChanged = /**
     * @param {?} e
     * @return {?}
     */
    function (e) {
        var _a, _b;
        /** @type {?} */
        var items = e.conditions;
        if (!this.conditions || !this.conditions.length) {
            (_a = this.conditions).push.apply(_a, tslib_1.__spread(items));
            this.controlData.push(tslib_1.__assign({}, e.controlData));
        }
        else {
            /// TODO, CONTROLDATA 的索引与conditions 的索引很可能不是1个
            this.conditions = this.conditions.filter((/**
             * @param {?} n
             * @return {?}
             */
            function (n) { return n.FilterField !== items[0].FilterField; }));
            if (items.length === 1) {
                this.conditions.push(tslib_1.__assign({}, items[0]));
            }
            else {
                (_b = this.conditions).push.apply(_b, tslib_1.__spread(items));
            }
            if (e.controlData) {
                /** @type {?} */
                var ctrlIdx = this.controlData.findIndex((/**
                 * @param {?} n
                 * @return {?}
                 */
                function (n) { return n.labelCode === e.controlData.labelCode; }));
                if (ctrlIdx > -1) {
                    this.controlData[ctrlIdx] = tslib_1.__assign({}, e.controlData);
                }
                else {
                    this.controlData.push(tslib_1.__assign({}, e.controlData));
                }
            }
        }
        this.filterChanged.next({ conditions: tslib_1.__spread(this.conditions), controlData: tslib_1.__spread(this.controlData) });
    };
    /**
     * @param {?} e
     * @param {?=} emitRemove
     * @return {?}
     */
    DatagridSmartFilterService.prototype.removeCondition = /**
     * @param {?} e
     * @param {?=} emitRemove
     * @return {?}
     */
    function (e, emitRemove) {
        if (emitRemove === void 0) { emitRemove = false; }
        if (this.conditions && this.conditions.length) {
            this.conditions = this.conditions.filter((/**
             * @param {?} n
             * @return {?}
             */
            function (n) { return n.FilterField !== e.labelCode; }));
            this.controlData = this.controlData.filter((/**
             * @param {?} n
             * @return {?}
             */
            function (n) { return n.labelCode !== e.labelCode; }));
        }
        this.filterChanged.next({ conditions: tslib_1.__spread(this.conditions), controlData: tslib_1.__spread(this.controlData) });
        if (emitRemove) {
            this.removeFilter.next(e);
        }
    };
    /**
     * @return {?}
     */
    DatagridSmartFilterService.prototype.clearAll = /**
     * @return {?}
     */
    function () {
        this.conditions = [];
        this.controlData = [];
        this.clearAllFilter.next(null);
    };
    DatagridSmartFilterService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    DatagridSmartFilterService.ctorParameters = function () { return []; };
    return DatagridSmartFilterService;
}());
export { DatagridSmartFilterService };
if (false) {
    /**
     * @type {?}
     * @private
     */
    DatagridSmartFilterService.prototype.conditions;
    /**
     * @type {?}
     * @private
     */
    DatagridSmartFilterService.prototype.controlData;
    /** @type {?} */
    DatagridSmartFilterService.prototype.filterChanged;
    /** @type {?} */
    DatagridSmartFilterService.prototype.removeFilter;
    /** @type {?} */
    DatagridSmartFilterService.prototype.clearAllFilter;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YWdyaWQtc21hcnQtZmlsdGVyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL3VpLWRhdGFncmlkLyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2VzL2RhdGFncmlkLXNtYXJ0LWZpbHRlci5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQy9CLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBRXhELE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxpQkFBaUIsRUFBRSxpQkFBaUIsRUFDM0QsbUJBQW1CLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSw0REFBNEQsQ0FBQztBQUVuSDtJQVVJO1FBUlEsZUFBVSxHQUFVLEVBQUUsQ0FBQztRQUN2QixnQkFBVyxHQUFRLEVBQUUsQ0FBQztRQUU5QixrQkFBYSxHQUFHLElBQUksT0FBTyxFQUFFLENBQUM7UUFFOUIsaUJBQVksR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFDO1FBQzdCLG1CQUFjLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQztJQUVmLENBQUM7Ozs7O0lBR2pCLHdEQUFtQjs7OztJQUFuQixVQUFvQixHQUFROztZQUNwQixpQkFBaUIsR0FBUTtZQUN6QixXQUFXLEVBQUUsTUFBTTtTQUN0QjtRQUNELElBQUksR0FBRyxDQUFDLE1BQU0sS0FBSyxTQUFTLEVBQUU7WUFDMUIsSUFBSSxPQUFPLEdBQUcsQ0FBQyxNQUFNLEtBQUssU0FBUyxFQUFFO2dCQUNqQyxJQUFJLEdBQUcsQ0FBQyxTQUFTLEVBQUU7b0JBQ2YsSUFBSSxPQUFPLEdBQUcsQ0FBQyxTQUFTLEtBQUssUUFBUSxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDLE1BQU0sRUFBRTs7NEJBQ2xFLE9B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VUFBVSxDQUFDLE1BQU07Ozs7WUFBQyxVQUFBLENBQUMsSUFBSSxPQUFBLENBQUMsQ0FBQyxXQUFXLEtBQUssQ0FBQyxDQUFDLFNBQVMsRUFBN0IsQ0FBNkIsRUFBQyxDQUFDO1lBQzdFLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNOzs7O1lBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxDQUFDLENBQUMsU0FBUyxLQUFLLENBQUMsQ0FBQyxTQUFTLEVBQTNCLENBQTJCLEVBQUMsQ0FBQztTQUNoRjtRQUNELElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLEVBQUMsVUFBVSxtQkFBTSxJQUFJLENBQUMsVUFBVSxDQUFDLEVBQUUsV0FBVyxtQkFBTSxJQUFJLENBQUMsV0FBVyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ2pHLElBQUksVUFBVSxFQUFFO1lBQ1osSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDN0I7SUFDTCxDQUFDOzs7O0lBRUQsNkNBQVE7OztJQUFSO1FBQ0ksSUFBSSxDQUFDLFVBQVUsR0FBRyxFQUFFLENBQUM7UUFDckIsSUFBSSxDQUFDLFdBQVcsR0FBRyxFQUFFLENBQUM7UUFDdEIsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDbkMsQ0FBQzs7Z0JBNUhKLFVBQVU7Ozs7SUE2SFgsaUNBQUM7Q0FBQSxBQTdIRCxJQTZIQztTQTVIWSwwQkFBMEI7Ozs7OztJQUNuQyxnREFBK0I7Ozs7O0lBQy9CLGlEQUE4Qjs7SUFFOUIsbURBQThCOztJQUU5QixrREFBNkI7O0lBQzdCLG9EQUErQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBDb2x1bW5GaWx0ZXJUeXBlIH0gZnJvbSAnLi4vdHlwZXMvZGF0YS1jb2x1bW4nO1xyXG5cclxuaW1wb3J0IHsgQm9vbGVhbkZpbHRlckNvbnRyb2wsIERhdGVGaWx0ZXJDb250cm9sLCBFbnVtRmlsdGVyQ29udHJvbCxcclxuICAgICAgICBOdW1iZXJGaWx0ZXJDb250cm9sLCBUZXh0RmlsdGVyQ29udHJvbCB9IGZyb20gJy4uL3BsdWdpbnMvc21hcnQtZmlsdGVyL2NvbnRyb2xEYXRhL2ZpbHRlci1jb250cm9sLm9wdGlvbnMnO1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgRGF0YWdyaWRTbWFydEZpbHRlclNlcnZpY2Uge1xyXG4gICAgcHJpdmF0ZSBjb25kaXRpb25zOiBhbnlbXSA9IFtdO1xyXG4gICAgcHJpdmF0ZSBjb250cm9sRGF0YTogYW55ID0gW107XHJcblxyXG4gICAgZmlsdGVyQ2hhbmdlZCA9IG5ldyBTdWJqZWN0KCk7XHJcblxyXG4gICAgcmVtb3ZlRmlsdGVyID0gbmV3IFN1YmplY3QoKTtcclxuICAgIGNsZWFyQWxsRmlsdGVyID0gbmV3IFN1YmplY3QoKTtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcigpIHsgfVxyXG5cclxuXHJcbiAgICBnZXRDb2x1bW5GaWx0ZXJEYXRhKGNvbDogYW55KSB7XHJcbiAgICAgICAgbGV0IGZpbHRlckNvbnRyb2xEYXRhOiBhbnkgPSB7XHJcbiAgICAgICAgICAgIGNvbnRyb2x0eXBlOiAndGV4dCcsXHJcbiAgICAgICAgfTtcclxuICAgICAgICBpZiAoY29sLmZpbHRlciAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgIGlmICh0eXBlb2YgY29sLmZpbHRlciA9PT0gJ2Jvb2xlYW4nKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoY29sLmZvcm1hdHRlcikge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgY29sLmZvcm1hdHRlciA9PT0gJ29iamVjdCcgJiYgT2JqZWN0LmtleXMoY29sLmZvcm1hdHRlcikubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG9wdGlvbnM6IGFueSA9IGNvbC5mb3JtYXR0ZXJbJ29wdGlvbnMnXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChjb2wuZm9ybWF0dGVyWyd0eXBlJ10pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ251bWJlcic6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIE51bWJlckZpbHRlckNvbnRyb2woY29sKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2VudW0nOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBFbnVtRmlsdGVyQ29udHJvbChjb2wsIG9wdGlvbnMpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnYm9vbGVhbic6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEJvb2xlYW5GaWx0ZXJDb250cm9sKGNvbCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdkYXRldGltZSc6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHR5ZSA9ICdkYXRldGltZSc7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGZtdCA9ICd5eXl5LU1NLWRkJztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgcmV0dXJuRm10ID0gJ3l5eXktTU0tZGQnO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMuZm9ybWF0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZtdCA9IG9wdGlvbnMuZm9ybWF0O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm10LmluZGV4T2YoJ0hIOicpID09IC0xKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eWUgPSAnZGF0ZSc7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm5GbXQgKz0gJyBISDptbSc7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm10LmluZGV4T2YoJ3NzJykgPiAtMSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybkZtdCArPSAnOnNzJztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5ZSA9ICdkYXRlJztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsdGVyQ29udHJvbERhdGEgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2x0eXBlOiAnZmxleGlibGVEYXRlJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0ZUZvcm1hdDogZm10LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaW5nbGU6IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaG93VHlwZTogMyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hvd1RpbWU6IHR5ZSA9PT0gJ2RhdGV0aW1lJ1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBUZXh0RmlsdGVyQ29udHJvbChjb2wpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZpbHRlckNvbnRyb2xEYXRhO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgc3dpdGNoIChjb2wuZmlsdGVyLnR5cGUpIHtcclxuICAgICAgICAgICAgICAgICAgICBjYXNlIENvbHVtbkZpbHRlclR5cGUuZW51bTpcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEVudW1GaWx0ZXJDb250cm9sKGNvbCwgY29sLmZpbHRlci5vcHRpb25zKTtcclxuICAgICAgICAgICAgICAgICAgICBjYXNlIENvbHVtbkZpbHRlclR5cGUuZGF0ZTpcclxuICAgICAgICAgICAgICAgICAgICBjYXNlIENvbHVtbkZpbHRlclR5cGUuZGF0ZXRpbWU6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBEYXRlRmlsdGVyQ29udHJvbChjb2wsIGNvbC5maWx0ZXIub3B0aW9ucyk7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSBDb2x1bW5GaWx0ZXJUeXBlLm51bWJlcjpcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIE51bWJlckZpbHRlckNvbnRyb2woY29sKTtcclxuICAgICAgICAgICAgICAgICAgICBjYXNlIENvbHVtbkZpbHRlclR5cGUuYm9vbGVhbjpcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEJvb2xlYW5GaWx0ZXJDb250cm9sKGNvbCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBmaWx0ZXJDb250cm9sRGF0YTtcclxuICAgIH1cclxuXHJcblxyXG5cclxuICAgIGZpbHRlckNvbmRpdGlvbkNoYW5nZWQoZToge2NvbmRpdGlvbnM6IGFueVtdLCBjb250cm9sRGF0YTogYW55fSkge1xyXG4gICAgICAgIGNvbnN0IGl0ZW1zID0gZS5jb25kaXRpb25zO1xyXG5cclxuICAgICAgICBpZiAoIXRoaXMuY29uZGl0aW9ucyB8fCAhdGhpcy5jb25kaXRpb25zLmxlbmd0aCkge1xyXG4gICAgICAgICAgICB0aGlzLmNvbmRpdGlvbnMucHVzaCguLi5pdGVtcyk7XHJcbiAgICAgICAgICAgIHRoaXMuY29udHJvbERhdGEucHVzaCh7Li4uZS5jb250cm9sRGF0YX0pO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIC8vLyBUT0RPLCBDT05UUk9MREFUQSDnmoTntKLlvJXkuI5jb25kaXRpb25zIOeahOe0ouW8leW+iOWPr+iDveS4jeaYrzHkuKpcclxuXHJcbiAgICAgICAgICAgIHRoaXMuY29uZGl0aW9ucyA9IHRoaXMuY29uZGl0aW9ucy5maWx0ZXIobiA9PiBuLkZpbHRlckZpZWxkICE9PSBpdGVtc1swXS5GaWx0ZXJGaWVsZCk7XHJcbiAgICAgICAgICAgIGlmIChpdGVtcy5sZW5ndGggPT09IDEpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuY29uZGl0aW9ucy5wdXNoKHsgLi4uaXRlbXNbMF0gfSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmNvbmRpdGlvbnMucHVzaCguLi5pdGVtcyk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChlLmNvbnRyb2xEYXRhKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBjdHJsSWR4ID0gdGhpcy5jb250cm9sRGF0YS5maW5kSW5kZXgobiA9PiBuLmxhYmVsQ29kZSA9PT0gZS5jb250cm9sRGF0YS5sYWJlbENvZGUpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGN0cmxJZHggPiAtMSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY29udHJvbERhdGFbY3RybElkeF0gPSB7Li4uZS5jb250cm9sRGF0YX07XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY29udHJvbERhdGEucHVzaCh7Li4uZS5jb250cm9sRGF0YX0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLmZpbHRlckNoYW5nZWQubmV4dCh7Y29uZGl0aW9uczogWy4uLnRoaXMuY29uZGl0aW9uc10sIGNvbnRyb2xEYXRhOiBbLi4udGhpcy5jb250cm9sRGF0YV0gfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcmVtb3ZlQ29uZGl0aW9uKGUsIGVtaXRSZW1vdmUgPSBmYWxzZSkge1xyXG4gICAgICAgIGlmICh0aGlzLmNvbmRpdGlvbnMgJiYgdGhpcy5jb25kaXRpb25zLmxlbmd0aCkge1xyXG4gICAgICAgICAgICB0aGlzLmNvbmRpdGlvbnMgPSB0aGlzLmNvbmRpdGlvbnMuZmlsdGVyKG4gPT4gbi5GaWx0ZXJGaWVsZCAhPT0gZS5sYWJlbENvZGUpO1xyXG4gICAgICAgICAgICB0aGlzLmNvbnRyb2xEYXRhID0gdGhpcy5jb250cm9sRGF0YS5maWx0ZXIobiA9PiBuLmxhYmVsQ29kZSAhPT0gZS5sYWJlbENvZGUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmZpbHRlckNoYW5nZWQubmV4dCh7Y29uZGl0aW9uczogWy4uLnRoaXMuY29uZGl0aW9uc10sIGNvbnRyb2xEYXRhOiBbLi4udGhpcy5jb250cm9sRGF0YV0gfSk7XHJcbiAgICAgICAgaWYgKGVtaXRSZW1vdmUpIHtcclxuICAgICAgICAgICAgdGhpcy5yZW1vdmVGaWx0ZXIubmV4dChlKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgY2xlYXJBbGwoKSB7XHJcbiAgICAgICAgdGhpcy5jb25kaXRpb25zID0gW107XHJcbiAgICAgICAgdGhpcy5jb250cm9sRGF0YSA9IFtdO1xyXG4gICAgICAgIHRoaXMuY2xlYXJBbGxGaWx0ZXIubmV4dChudWxsKTtcclxuICAgIH1cclxufVxyXG4iXX0=