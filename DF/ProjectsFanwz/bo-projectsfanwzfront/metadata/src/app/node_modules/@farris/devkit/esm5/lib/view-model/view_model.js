import { Injectable } from '@angular/core';
import { MetadataUtil } from '../metadata/index';
import { NG_COMMAND } from './decorators';
import { of, Subject, from, EMPTY } from 'rxjs';
import { concatMap, tap, every } from 'rxjs/operators';
/**
 * ViewModel是界面层访问应用层的入口。
 *
 * ### 定义ViewModel
 *
 * 定义ViewModel需要以下几个步骤：
 *
 * 1、定义的ViewModel需要继承ViewModel基类
 * 2、使用NgViewModel关联相关对象，比如：绑定数据（SinmpleDemoBindingData）、表单（SimpleDemoForm）、
 *    状态机（SimpleDemoStateMachine）等，但所有这些关联都是可选的，用不到或者自己单独实现时，不指定即可。
 * 3、同时我们需要传递一个injector给基类的构造函数，在ViewModel实例化时，会从injector获取NgViewModel声明的各个类型的实例。
 *
 * 下面我们来定义一个简单的ViewModel，代码如下：
 * ```ts
 * import { Injector, Injectable } from '@angular/core';
 * import { NgViewModel, ViewModel } from '@farris/devkit';
 *
 * @Injectable()
 * @NgViewModel({
 *   children: [],
 *   binding: SimpleDemoBindingData,
 *   form: SimpleDemoForm,
 *   stateMachine: SimpleDemoStateMachine,
 * })
 * class SimpleDemoViewModel extends ViewModel {
 *    constructor(injector: Injector) {
 *      super(injector);
 *    }
 *    @NgCommand({
 *      name: 'formLoad',
 *      params: {
 *        dataId: '1'
 *      }
 *    })
 *    public formLoad() {}
 * }
 * export { SimpleDemoViewModel };
 * ```
 *
 * 通过组件的构造函数，我们将ViewModel注入进组件
 * ```ts
 * @Component({
 *   selector: 'app-simple-demo',
 *   templateUrl: './simple-demo.component.html'
 * })
 * class SimpleDemoComponent implements OnInit {
 *
 *   public viewModel: SimpleDemoViewModel;
 *
 *   constructor(viewModel: SimpleDemoViewModel) {
 *     this.viewModel = viewModel;
 *   }
 * }
 * ```
 *
 * ### 组件模板中使用ViewModel
 *
 * 我们可以在模板中绑定NgViewModel中指定的 BindingData、Form、StateMachine的实例。
 * ```html
 * * <!--绑定数据-->
 * <p>{{viewModel.bindingData.name}}</p>
 *
 * <!--绑定表单-->
 * <form [formGroup]="viewModel.form">
 *   <input type="text" formControlName="name">
 * </form>
 *
 * <!--绑定状态机-->
 * <button type="button" [disabled]="!viewModel.stateMachine.canAdd">新增 </button>
 * * ```
 *
 * 我们在模板中绑定绑定viewModel的一个方法作为事件处理，这个方法可以是普通的方法，也可以是用NgCommand注解修饰过的。
 * ```html
 * <button type="button" (click)="viewModel.add()">新增 </button>
 * ```
 *
 * ### 组合的ViewModle
 *
 * 当界面比较复杂时，我们对界面按一定的粒度进行拆分，拆分出来的各个组成部分分别对应一个ViewModel，这样就形成了一个ViewModel树。
 * 我们在父的ViewModel的NgViewModel注解中通过在children属性中声明它的子ViewModel，将它们关联起来。
 * 假设我们有一个左列表右卡片的界面，我们可以为左列表、右卡片分别定义一个ViewModel，然后在页面的ViewModel中，将它们组合起来，
 * 代码如下：
 * ```ts
 * @Injectable()
 *  @NgViewModel({
 *  children: [LeftListViewModel, RightCardViewModel],
 *    binding: NestedDemoBindingData,
 * })
 * class NestedDemoViewModel extends ViewModel {
 *   constructor(injector: Injector) {
 *     super(injector);
 *   }
 * }
 * export { NestedDemoViewModel };
 * ```
 */
var ViewModel = /** @class */ (function () {
    /**
     * kendogrid option
     */
    // constructor(metadata?: IContextMetadata) {
    //   if (!this.bindingPath && metadata && metadata.bindingTo) {
    //     this.bindingPath = metadata.bindingTo;
    //   }
    // }
    function ViewModel() {
        /**
         * 界面验证信息
         */
        this.verifyInformations = [];
        this.verifycationChanged = new Subject();
    }
    Object.defineProperty(ViewModel.prototype, "expression", {
        /**
         * 表达式服务
         */
        get: function () {
            return this.frameContext.expressionManager;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ViewModel.prototype, "expressionResult", {
        /**
         * 表达式结果
         */
        get: function () {
            return this.frameContext.expressionResult;
        },
        enumerable: true,
        configurable: true
    });
    ViewModel.prototype.setMetadata = function (metadata) {
        if (!this.bindingPath && metadata && metadata.bindingTo) {
            this.bindingPath = metadata.bindingTo;
        }
    };
    /**
     * 初始化
     */
    ViewModel.prototype.init = function (context) {
        var _this = this;
        if (!this.name) {
            this.name = context.metadata.viewModelCode || this.constructor.name;
        }
        this.frameContext = context;
        this.bindingData = context.bindingData;
        this.uiState = context.uiState;
        this.form = context.form;
        this.stateMachine = context.stateMachine;
        this.buildCommands(context);
        this.entityValueChangingListeners = new Map();
        this.entityValueChangedListeners = new Map();
        // 为bindingData赋值值变化监听器
        if (this.bindingData) {
            this.bindingData.setValueChangeInvokerFactory(function (paths) {
                return function (preValue, value, entityChanged, primaryValue) {
                    var plainPath = '/' + paths.join('/');
                    var command;
                    if (entityChanged === false) {
                        command = _this.entityValueChangingListeners[plainPath];
                    }
                    else {
                        command = _this.entityValueChangedListeners[plainPath];
                    }
                    if (!!command) {
                        var change_1 = {
                            paths: paths,
                            preValue: preValue,
                            value: value,
                            id: primaryValue,
                            changed: entityChanged
                        };
                        var commands = command.split(';').filter(function (p) { return p; });
                        var valueChangeSuccess_1 = true;
                        return from(commands).pipe(concatMap(function (item) {
                            if (!valueChangeSuccess_1) {
                                return EMPTY;
                            }
                            return _this[item](change_1).pipe(tap(function (result) {
                                valueChangeSuccess_1 = result;
                            }));
                        }), every(function (result) { return result; }));
                        // return this[command](change).pipe(map(result => {
                        //   return result === false ? false : true;
                        // }));
                    }
                    else {
                        return of(true);
                    }
                };
            });
        }
        this.initListeners();
    };
    /**
     * 绑定命令
     */
    ViewModel.prototype.buildCommands = function (context) {
        var _this = this;
        var ngCommands = context.metadata.commands || MetadataUtil.getPropsMetadatasByName(this.constructor, NG_COMMAND);
        this.metadatas = ngCommands;
        this.keybindingMap = new Map();
        Object.keys(ngCommands).forEach(function (propertyName) {
            var ngCommand = ngCommands[propertyName];
            // 注册快捷键
            if (ngCommand.keyBinding) {
                _this.keybindingMap.set(propertyName, ngCommand.keyBinding);
            }
            Object.defineProperty(_this, propertyName, {
                value: function (data) {
                    // 获取命令处理上下文
                    var targetContext = context;
                    if (ngCommand.frameId) {
                        targetContext = context.appContext.getFrameContext(ngCommand.frameId);
                    }
                    var command = {
                        name: ngCommand.name,
                        params: ngCommand.params,
                        paramDescriptions: ngCommand.paramDescriptions,
                        eventParam: data || null
                    };
                    return targetContext.commandBus.dispatch(command);
                }
            });
        });
    };
    /**
     * 从Form获取监听器
     */
    ViewModel.prototype.initListeners = function () {
        var _this = this;
        var extractPath = function (bindingBasePath, bindingPath) {
            return '/' + bindingBasePath.split('/').concat(bindingPath.split('.')).filter(function (item) { return item.length > 0; }).join('/');
        };
        if (this.form) {
            var valueChangingListeners_1 = this.form.getEntityValueChangingListeners();
            Object.keys(valueChangingListeners_1).forEach(function (bindingPath) {
                var plainPath = extractPath(_this.bindingPath, bindingPath);
                _this.entityValueChangingListeners[plainPath] = valueChangingListeners_1[bindingPath];
            });
            var valueChangedListeners_1 = this.form.getEntityValueChangedListeners();
            Object.keys(valueChangedListeners_1).forEach(function (bindingPath) {
                var plainPath = extractPath(_this.bindingPath, bindingPath);
                _this.entityValueChangedListeners[plainPath] = valueChangedListeners_1[bindingPath];
            });
        }
    };
    ViewModel.prototype.bindToParent = function (parent) {
        var _this = this;
        if (parent) {
            if (parent.verifycationChanged) {
                parent.verifycationChanged.subscribe(function (verifyInformations) {
                    _this.verifycationChanged.next(verifyInformations);
                });
            }
        }
    };
    /**
     * 合并审批及表单表达式并计算结果
     * @param expression 表达式
     * @returns
     */
    ViewModel.prototype.transform = function (expression) {
        if (Array.isArray(expression)) {
            var wfConf = expression.find(function (item) { return item && item.source === 'wf'; });
            if (wfConf && wfConf.value) {
                return this.transform(wfConf.value);
            }
            else {
                return this.transform(expression[0]);
            }
        }
        else {
            if (typeof expression === 'boolean') {
                return expression;
            }
            else if (typeof expression === 'string') {
                return new Function('ctx', "return " + expression).apply(this.frameContext, [this]);
            }
            else {
                // 表达式result
                return expression;
            }
        }
    };
    ViewModel.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    ViewModel.ctorParameters = function () { return []; };
    return ViewModel;
}());
export { ViewModel };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlld19tb2RlbC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL3ZpZXctbW9kZWwvdmlld19tb2RlbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFZLE1BQU0sZUFBZSxDQUFDO0FBQ3JELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUVqRCxPQUFPLEVBQUUsVUFBVSxFQUF5QixNQUFNLGNBQWMsQ0FBQztBQU1qRSxPQUFPLEVBQWMsRUFBRSxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzVELE9BQU8sRUFBTyxTQUFTLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBcUMsTUFBTSxnQkFBZ0IsQ0FBQztBQUsvRjs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0ErRkc7QUFDSDtJQXNFRTs7T0FFRztJQUVILDZDQUE2QztJQUM3QywrREFBK0Q7SUFDL0QsNkNBQTZDO0lBQzdDLE1BQU07SUFDTixJQUFJO0lBQ0o7UUE5Q0E7O1dBRUc7UUFDSSx1QkFBa0IsR0FBVSxFQUFFLENBQUM7UUFFL0Isd0JBQW1CLEdBQUcsSUFBSSxPQUFPLEVBQVMsQ0FBQztJQXlDbEMsQ0FBQztJQXJDakIsc0JBQVcsaUNBQVU7UUFIckI7O1dBRUc7YUFDSDtZQUNFLE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxpQkFBaUIsQ0FBQztRQUM3QyxDQUFDOzs7T0FBQTtJQUlELHNCQUFXLHVDQUFnQjtRQUgzQjs7V0FFRzthQUNIO1lBQ0UsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLGdCQUFnQixDQUFDO1FBQzVDLENBQUM7OztPQUFBO0lBK0JNLCtCQUFXLEdBQWxCLFVBQW1CLFFBQTBCO1FBQzND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UUFBUSxFQUFFO2dCQUN6QyxPQUFPLElBQUksUUFBUSxDQUFDLEtBQUssRUFBRSxZQUFVLFVBQVksQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQzthQUNyRjtpQkFBTTtnQkFDTCxZQUFZO2dCQUNaLE9BQU8sVUFBVSxDQUFDO2FBQ25CO1NBQ0Y7SUFDSCxDQUFDOztnQkEvT0YsVUFBVTs7OztJQWdQWCxnQkFBQztDQUFBLEFBaFBELElBZ1BDO0FBRUQsT0FBTyxFQUFFLFNBQVMsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgSW5qZWN0b3IgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgTWV0YWRhdGFVdGlsIH0gZnJvbSAnLi4vbWV0YWRhdGEvaW5kZXgnO1xyXG5pbXBvcnQgeyBDb21tYW5kIH0gZnJvbSAnLi4vY29tbWFuZC9pbmRleCc7XHJcbmltcG9ydCB7IE5HX0NPTU1BTkQsIE5nQ29tbWFuZCwgS2V5YmluZGluZyB9IGZyb20gJy4vZGVjb3JhdG9ycyc7XHJcbmltcG9ydCB7IEJpbmRpbmdEYXRhLCBFbnRpdHlWYWx1ZUNoYW5nZSB9IGZyb20gJy4uL2JpbmRpbmctZGF0YS9pbmRleCc7XHJcbmltcG9ydCB7IFVJU3RhdGUgfSBmcm9tICcuLi91aS1zdGF0ZS9pbmRleCc7XHJcbmltcG9ydCB7IEZvcm0gfSBmcm9tICcuLi9mb3JtL2luZGV4JztcclxuaW1wb3J0IHsgU3RhdGVNYWNoaW5lIH0gZnJvbSAnLi4vc3RhdGUtbWFjaGluZS9pbmRleCc7XHJcbmltcG9ydCB7IEZyYW1lQ29udGV4dCB9IGZyb20gJy4uL2ZyYW1lL2luZGV4JztcclxuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgb2YsIFN1YmplY3QsIGZyb20sIEVNUFRZIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IG1hcCwgY29uY2F0TWFwLCB0YXAsIGV2ZXJ5LCBkZWJvdW5jZVRpbWUsIHN3aXRjaE1hcCwgdGFrZUxhc3QgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IEV4cHJlc3Npb25NYW5hZ2VyLCBFeHByZXNzaW9uUmVzdWx0IH0gZnJvbSAnLi4vZXhwcmVzc2lvbi9pbmRleCc7XHJcbmltcG9ydCB7IElDb250ZXh0TWV0YWRhdGEgfSBmcm9tICcuLi9hcHAvYXBwX21ldGFkYXRhJztcclxuaW1wb3J0IHsgSW52b2tlT25WYWx1ZUNoYW5nZSB9IGZyb20gJy4uL2JpbmRpbmctZGF0YS90eXBlcyc7XHJcblxyXG4vKipcclxuICogVmlld01vZGVs5piv55WM6Z2i5bGC6K6/6Zeu5bqU55So5bGC55qE5YWl5Y+j44CCXHJcbiAqXHJcbiAqICMjIyDlrprkuYlWaWV3TW9kZWxcclxuICpcclxuICog5a6a5LmJVmlld01vZGVs6ZyA6KaB5Lul5LiL5Yeg5Liq5q2l6aqk77yaXHJcbiAqXHJcbiAqIDHjgIHlrprkuYnnmoRWaWV3TW9kZWzpnIDopoHnu6fmib9WaWV3TW9kZWzln7rnsbtcclxuICogMuOAgeS9v+eUqE5nVmlld01vZGVs5YWz6IGU55u45YWz5a+56LGh77yM5q+U5aaC77ya57uR5a6a5pWw5o2u77yIU2lubXBsZURlbW9CaW5kaW5nRGF0Ye+8ieOAgeihqOWNle+8iFNpbXBsZURlbW9Gb3Jt77yJ44CBXHJcbiAqICAgIOeKtuaAgeacuu+8iFNpbXBsZURlbW9TdGF0ZU1hY2hpbmXvvInnrYnvvIzkvYbmiYDmnInov5nkupvlhbPogZTpg73mmK/lj6/pgInnmoTvvIznlKjkuI3liLDmiJbogIXoh6rlt7HljZXni6zlrp7njrDml7bvvIzkuI3mjIflrprljbPlj6/jgIJcclxuICogM+OAgeWQjOaXtuaIkeS7rOmcgOimgeS8oOmAkuS4gOS4qmluamVjdG9y57uZ5Z+657G755qE5p6E6YCg5Ye95pWw77yM5ZyoVmlld01vZGVs5a6e5L6L5YyW5pe277yM5Lya5LuOaW5qZWN0b3Lojrflj5ZOZ1ZpZXdNb2RlbOWjsOaYjueahOWQhOS4quexu+Wei+eahOWunuS+i+OAglxyXG4gKlxyXG4gKiDkuIvpnaLmiJHku6zmnaXlrprkuYnkuIDkuKrnroDljZXnmoRWaWV3TW9kZWzvvIzku6PnoIHlpoLkuIvvvJpcclxuICogYGBgdHNcclxuICogaW1wb3J0IHsgSW5qZWN0b3IsIEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuICogaW1wb3J0IHsgTmdWaWV3TW9kZWwsIFZpZXdNb2RlbCB9IGZyb20gJ0BmYXJyaXMvZGV2a2l0JztcclxuICpcclxuICogQEluamVjdGFibGUoKVxyXG4gKiBATmdWaWV3TW9kZWwoe1xyXG4gKiAgIGNoaWxkcmVuOiBbXSxcclxuICogICBiaW5kaW5nOiBTaW1wbGVEZW1vQmluZGluZ0RhdGEsXHJcbiAqICAgZm9ybTogU2ltcGxlRGVtb0Zvcm0sXHJcbiAqICAgc3RhdGVNYWNoaW5lOiBTaW1wbGVEZW1vU3RhdGVNYWNoaW5lLFxyXG4gKiB9KVxyXG4gKiBjbGFzcyBTaW1wbGVEZW1vVmlld01vZGVsIGV4dGVuZHMgVmlld01vZGVsIHtcclxuICogICAgY29uc3RydWN0b3IoaW5qZWN0b3I6IEluamVjdG9yKSB7XHJcbiAqICAgICAgc3VwZXIoaW5qZWN0b3IpO1xyXG4gKiAgICB9XHJcbiAqICAgIEBOZ0NvbW1hbmQoe1xyXG4gKiAgICAgIG5hbWU6ICdmb3JtTG9hZCcsXHJcbiAqICAgICAgcGFyYW1zOiB7XHJcbiAqICAgICAgICBkYXRhSWQ6ICcxJ1xyXG4gKiAgICAgIH1cclxuICogICAgfSlcclxuICogICAgcHVibGljIGZvcm1Mb2FkKCkge31cclxuICogfVxyXG4gKiBleHBvcnQgeyBTaW1wbGVEZW1vVmlld01vZGVsIH07XHJcbiAqIGBgYFxyXG4gKlxyXG4gKiDpgJrov4fnu4Tku7bnmoTmnoTpgKDlh73mlbDvvIzmiJHku6zlsIZWaWV3TW9kZWzms6jlhaXov5vnu4Tku7ZcclxuICogYGBgdHNcclxuICogQENvbXBvbmVudCh7XHJcbiAqICAgc2VsZWN0b3I6ICdhcHAtc2ltcGxlLWRlbW8nLFxyXG4gKiAgIHRlbXBsYXRlVXJsOiAnLi9zaW1wbGUtZGVtby5jb21wb25lbnQuaHRtbCdcclxuICogfSlcclxuICogY2xhc3MgU2ltcGxlRGVtb0NvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCB7XHJcbiAqXHJcbiAqICAgcHVibGljIHZpZXdNb2RlbDogU2ltcGxlRGVtb1ZpZXdNb2RlbDtcclxuICpcclxuICogICBjb25zdHJ1Y3Rvcih2aWV3TW9kZWw6IFNpbXBsZURlbW9WaWV3TW9kZWwpIHtcclxuICogICAgIHRoaXMudmlld01vZGVsID0gdmlld01vZGVsO1xyXG4gKiAgIH1cclxuICogfVxyXG4gKiBgYGBcclxuICpcclxuICogIyMjIOe7hOS7tuaooeadv+S4reS9v+eUqFZpZXdNb2RlbFxyXG4gKlxyXG4gKiDmiJHku6zlj6/ku6XlnKjmqKHmnb/kuK3nu5HlrppOZ1ZpZXdNb2RlbOS4reaMh+WumueahCBCaW5kaW5nRGF0YeOAgUZvcm3jgIFTdGF0ZU1hY2hpbmXnmoTlrp7kvovjgIJcclxuICogYGBgaHRtbFxyXG4gKiAqIDwhLS3nu5HlrprmlbDmja4tLT5cclxuICogPHA+e3t2aWV3TW9kZWwuYmluZGluZ0RhdGEubmFtZX19PC9wPlxyXG4gKlxyXG4gKiA8IS0t57uR5a6a6KGo5Y2VLS0+XHJcbiAqIDxmb3JtIFtmb3JtR3JvdXBdPVwidmlld01vZGVsLmZvcm1cIj5cclxuICogICA8aW5wdXQgdHlwZT1cInRleHRcIiBmb3JtQ29udHJvbE5hbWU9XCJuYW1lXCI+XHJcbiAqIDwvZm9ybT5cclxuICpcclxuICogPCEtLee7keWumueKtuaAgeacui0tPlxyXG4gKiA8YnV0dG9uIHR5cGU9XCJidXR0b25cIiBbZGlzYWJsZWRdPVwiIXZpZXdNb2RlbC5zdGF0ZU1hY2hpbmUuY2FuQWRkXCI+5paw5aKeIDwvYnV0dG9uPlxyXG4gKiAqIGBgYFxyXG4gKlxyXG4gKiDmiJHku6zlnKjmqKHmnb/kuK3nu5Hlrprnu5Hlrpp2aWV3TW9kZWznmoTkuIDkuKrmlrnms5XkvZzkuLrkuovku7blpITnkIbvvIzov5nkuKrmlrnms5Xlj6/ku6XmmK/mma7pgJrnmoTmlrnms5XvvIzkuZ/lj6/ku6XmmK/nlKhOZ0NvbW1hbmTms6jop6Pkv67ppbDov4fnmoTjgIJcclxuICogYGBgaHRtbFxyXG4gKiA8YnV0dG9uIHR5cGU9XCJidXR0b25cIiAoY2xpY2spPVwidmlld01vZGVsLmFkZCgpXCI+5paw5aKeIDwvYnV0dG9uPlxyXG4gKiBgYGBcclxuICpcclxuICogIyMjIOe7hOWQiOeahFZpZXdNb2RsZVxyXG4gKlxyXG4gKiDlvZPnlYzpnaLmr5TovoPlpI3mnYLml7bvvIzmiJHku6zlr7nnlYzpnaLmjInkuIDlrprnmoTnspLluqbov5vooYzmi4bliIbvvIzmi4bliIblh7rmnaXnmoTlkITkuKrnu4TmiJDpg6jliIbliIbliKvlr7nlupTkuIDkuKpWaWV3TW9kZWzvvIzov5nmoLflsLHlvaLmiJDkuobkuIDkuKpWaWV3TW9kZWzmoJHjgIJcclxuICog5oiR5Lus5Zyo54i255qEVmlld01vZGVs55qETmdWaWV3TW9kZWzms6jop6PkuK3pgJrov4flnKhjaGlsZHJlbuWxnuaAp+S4reWjsOaYjuWug+eahOWtkFZpZXdNb2RlbO+8jOWwhuWug+S7rOWFs+iBlOi1t+adpeOAglxyXG4gKiDlgYforr7miJHku6zmnInkuIDkuKrlt6bliJfooajlj7PljaHniYfnmoTnlYzpnaLvvIzmiJHku6zlj6/ku6XkuLrlt6bliJfooajjgIHlj7PljaHniYfliIbliKvlrprkuYnkuIDkuKpWaWV3TW9kZWzvvIznhLblkI7lnKjpobXpnaLnmoRWaWV3TW9kZWzkuK3vvIzlsIblroPku6znu4TlkIjotbfmnaXvvIxcclxuICog5Luj56CB5aaC5LiL77yaXHJcbiAqIGBgYHRzXHJcbiAqIEBJbmplY3RhYmxlKClcclxuICogIEBOZ1ZpZXdNb2RlbCh7XHJcbiAqICBjaGlsZHJlbjogW0xlZnRMaXN0Vmlld01vZGVsLCBSaWdodENhcmRWaWV3TW9kZWxdLFxyXG4gKiAgICBiaW5kaW5nOiBOZXN0ZWREZW1vQmluZGluZ0RhdGEsXHJcbiAqIH0pXHJcbiAqIGNsYXNzIE5lc3RlZERlbW9WaWV3TW9kZWwgZXh0ZW5kcyBWaWV3TW9kZWwge1xyXG4gKiAgIGNvbnN0cnVjdG9yKGluamVjdG9yOiBJbmplY3Rvcikge1xyXG4gKiAgICAgc3VwZXIoaW5qZWN0b3IpO1xyXG4gKiAgIH1cclxuICogfVxyXG4gKiBleHBvcnQgeyBOZXN0ZWREZW1vVmlld01vZGVsIH07XHJcbiAqIGBgYFxyXG4gKi9cclxuQEluamVjdGFibGUoKVxyXG5jbGFzcyBWaWV3TW9kZWwge1xyXG5cclxuICBwdWJsaWMgbmFtZTogc3RyaW5nO1xyXG5cclxuICBwdWJsaWMgZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQ7XHJcblxyXG4gIC8qKlxyXG4gICAqIOe7keWumuaVsOaNrlxyXG4gICAqL1xyXG4gIHB1YmxpYyBiaW5kaW5nRGF0YTogQmluZGluZ0RhdGE7XHJcblxyXG4gIC8qKlxyXG4gICAqIOe7keWumui3r+W+hFxyXG4gICAqIOW9ouWmgu+8mi8o5qC55a6e5L2TKe+8jC9lZHVz77yI5LuO6KGo77yJ77yML2VkdXMvZ3JhZGVz77yI5LuO5LuO6KGo77yJXHJcbiAgICovXHJcbiAgcHVibGljIGJpbmRpbmdQYXRoOiBzdHJpbmc7XHJcblxyXG4gIC8qKlxyXG4gICAqIOeVjOmdoueKtuaAgVxyXG4gICAqL1xyXG4gIHB1YmxpYyB1aVN0YXRlOiBVSVN0YXRlO1xyXG5cclxuICAvKipcclxuICAgKiDooajljZXlrprkuYlcclxuICAgKi9cclxuICBwdWJsaWMgZm9ybTogRm9ybTtcclxuXHJcbiAgLyoqXHJcbiAgICog54q25oCB5py6XHJcbiAgICovXHJcbiAgcHVibGljIHN0YXRlTWFjaGluZTogU3RhdGVNYWNoaW5lO1xyXG5cclxuICAvKipcclxuICAgKiDnlYzpnaLpqozor4Hkv6Hmga9cclxuICAgKi9cclxuICBwdWJsaWMgdmVyaWZ5SW5mb3JtYXRpb25zOiBhbnlbXSA9IFtdO1xyXG5cclxuICBwdWJsaWMgdmVyaWZ5Y2F0aW9uQ2hhbmdlZCA9IG5ldyBTdWJqZWN0PGFueVtdPigpO1xyXG4gIC8qKlxyXG4gICAqIOihqOi+vuW8j+acjeWKoVxyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXQgZXhwcmVzc2lvbigpOiBFeHByZXNzaW9uTWFuYWdlciB7XHJcbiAgICByZXR1cm4gdGhpcy5mcmFtZUNvbnRleHQuZXhwcmVzc2lvbk1hbmFnZXI7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOihqOi+vuW8j+e7k+aenFxyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXQgZXhwcmVzc2lvblJlc3VsdCgpOiBFeHByZXNzaW9uUmVzdWx0IHtcclxuICAgIHJldHVybiB0aGlzLmZyYW1lQ29udGV4dC5leHByZXNzaW9uUmVzdWx0O1xyXG4gIH1cclxuICAvKipcclxuICAgKiDlv6vmjbfplK7mmKDlsIRcclxuICAgKi9cclxuICBwdWJsaWMga2V5YmluZGluZ01hcDogTWFwPHN0cmluZywgS2V5YmluZGluZz47XHJcblxyXG4gIC8qKlxyXG4gICAqIOWAvOWPmOWMluWJjeebkeWQrOWZqFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZW50aXR5VmFsdWVDaGFuZ2luZ0xpc3RlbmVyczogTWFwPHN0cmluZywgc3RyaW5nPjtcclxuXHJcbiAgLyoqXHJcbiAgICog5YC85Y+Y5YyW5ZCO55uR5ZCs5ZmoXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBlbnRpdHlWYWx1ZUNoYW5nZWRMaXN0ZW5lcnM6IE1hcDxzdHJpbmcsIHN0cmluZz47XHJcbiAgLyoqXHJcbiAgICog5YWD5pWw5o2uXHJcbiAgICovXHJcbiAgcHVibGljIG1ldGFkYXRhczogeyBbcHJvcE5hbWU6IHN0cmluZ106IE5nQ29tbWFuZCB9O1xyXG5cclxuICAvKipcclxuICAgKiBrZW5kb2dyaWQgb3B0aW9uXHJcbiAgICovXHJcblxyXG4gIC8vIGNvbnN0cnVjdG9yKG1ldGFkYXRhPzogSUNvbnRleHRNZXRhZGF0YSkge1xyXG4gIC8vICAgaWYgKCF0aGlzLmJpbmRpbmdQYXRoICYmIG1ldGFkYXRhICYmIG1ldGFkYXRhLmJpbmRpbmdUbykge1xyXG4gIC8vICAgICB0aGlzLmJpbmRpbmdQYXRoID0gbWV0YWRhdGEuYmluZGluZ1RvO1xyXG4gIC8vICAgfVxyXG4gIC8vIH1cclxuICBjb25zdHJ1Y3RvcigpIHsgfVxyXG5cclxuICBwdWJsaWMgc2V0TWV0YWRhdGEobWV0YWRhdGE6IElDb250ZXh0TWV0YWRhdGEpIHtcclxuICAgIGlmICghdGhpcy5iaW5kaW5nUGF0aCAmJiBtZXRhZGF0YSAmJiBtZXRhZGF0YS5iaW5kaW5nVG8pIHtcclxuICAgICAgdGhpcy5iaW5kaW5nUGF0aCA9IG1ldGFkYXRhLmJpbmRpbmdUbztcclxuICAgIH1cclxuICB9XHJcbiAgLyoqXHJcbiAgICog5Yid5aeL5YyWXHJcbiAgICovXHJcbiAgcHVibGljIGluaXQoY29udGV4dDogRnJhbWVDb250ZXh0KSB7XHJcbiAgICBpZiAoIXRoaXMubmFtZSkge1xyXG4gICAgICB0aGlzLm5hbWUgPSBjb250ZXh0Lm1ldGFkYXRhLnZpZXdNb2RlbENvZGUgfHwgdGhpcy5jb25zdHJ1Y3Rvci5uYW1lO1xyXG4gICAgfVxyXG4gICAgdGhpcy5mcmFtZUNvbnRleHQgPSBjb250ZXh0O1xyXG4gICAgdGhpcy5iaW5kaW5nRGF0YSA9IGNvbnRleHQuYmluZGluZ0RhdGE7XHJcbiAgICB0aGlzLnVpU3RhdGUgPSBjb250ZXh0LnVpU3RhdGU7XHJcbiAgICB0aGlzLmZvcm0gPSBjb250ZXh0LmZvcm07XHJcbiAgICB0aGlzLnN0YXRlTWFjaGluZSA9IGNvbnRleHQuc3RhdGVNYWNoaW5lO1xyXG4gICAgdGhpcy5idWlsZENvbW1hbmRzKGNvbnRleHQpO1xyXG4gICAgdGhpcy5lbnRpdHlWYWx1ZUNoYW5naW5nTGlzdGVuZXJzID0gbmV3IE1hcDxzdHJpbmcsIHN0cmluZz4oKTtcclxuICAgIHRoaXMuZW50aXR5VmFsdWVDaGFuZ2VkTGlzdGVuZXJzID0gbmV3IE1hcDxzdHJpbmcsIHN0cmluZz4oKTtcclxuICAgIC8vIOS4umJpbmRpbmdEYXRh6LWL5YC85YC85Y+Y5YyW55uR5ZCs5ZmoXHJcbiAgICBpZiAodGhpcy5iaW5kaW5nRGF0YSkge1xyXG4gICAgICB0aGlzLmJpbmRpbmdEYXRhLnNldFZhbHVlQ2hhbmdlSW52b2tlckZhY3RvcnkoKHBhdGhzOiBzdHJpbmdbXSk6IEludm9rZU9uVmFsdWVDaGFuZ2UgPT4ge1xyXG4gICAgICAgIHJldHVybiAocHJlVmFsdWUsIHZhbHVlLCBlbnRpdHlDaGFuZ2VkOiBib29sZWFuLCBwcmltYXJ5VmFsdWU/OiBhbnkpOiBPYnNlcnZhYmxlPGJvb2xlYW4+ID0+IHtcclxuICAgICAgICAgIGNvbnN0IHBsYWluUGF0aCA9ICcvJyArIHBhdGhzLmpvaW4oJy8nKTtcclxuICAgICAgICAgIGxldCBjb21tYW5kOiBzdHJpbmc7XHJcbiAgICAgICAgICBpZiAoZW50aXR5Q2hhbmdlZCA9PT0gZmFsc2UpIHtcclxuICAgICAgICAgICAgY29tbWFuZCA9IHRoaXMuZW50aXR5VmFsdWVDaGFuZ2luZ0xpc3RlbmVyc1twbGFpblBhdGhdO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgY29tbWFuZCA9IHRoaXMuZW50aXR5VmFsdWVDaGFuZ2VkTGlzdGVuZXJzW3BsYWluUGF0aF07XHJcbiAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgaWYgKCEhY29tbWFuZCkge1xyXG4gICAgICAgICAgICBjb25zdCBjaGFuZ2U6IEVudGl0eVZhbHVlQ2hhbmdlID0ge1xyXG4gICAgICAgICAgICAgIHBhdGhzOiBwYXRocyxcclxuICAgICAgICAgICAgICBwcmVWYWx1ZTogcHJlVmFsdWUsXHJcbiAgICAgICAgICAgICAgdmFsdWU6IHZhbHVlLFxyXG4gICAgICAgICAgICAgIGlkOiBwcmltYXJ5VmFsdWUsXHJcbiAgICAgICAgICAgICAgY2hhbmdlZDogZW50aXR5Q2hhbmdlZFxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICBjb25zdCBjb21tYW5kcyA9IGNvbW1hbmQuc3BsaXQoJzsnKS5maWx0ZXIocCA9PiBwKTtcclxuICAgICAgICAgICAgbGV0IHZhbHVlQ2hhbmdlU3VjY2VzcyA9IHRydWU7XHJcbiAgICAgICAgICAgIHJldHVybiBmcm9tKGNvbW1hbmRzKS5waXBlKFxyXG4gICAgICAgICAgICAgIGNvbmNhdE1hcChpdGVtID0+IHtcclxuICAgICAgICAgICAgICAgIGlmICghdmFsdWVDaGFuZ2VTdWNjZXNzKSB7XHJcbiAgICAgICAgICAgICAgICAgIHJldHVybiBFTVBUWTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzW2l0ZW1dKGNoYW5nZSkucGlwZShcclxuICAgICAgICAgICAgICAgICAgdGFwKChyZXN1bHQ6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhbHVlQ2hhbmdlU3VjY2VzcyA9IHJlc3VsdDtcclxuICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICAgICAgZXZlcnkoKHJlc3VsdDogYW55KSA9PiByZXN1bHQpXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgIC8vIHJldHVybiB0aGlzW2NvbW1hbmRdKGNoYW5nZSkucGlwZShtYXAocmVzdWx0ID0+IHtcclxuICAgICAgICAgICAgLy8gICByZXR1cm4gcmVzdWx0ID09PSBmYWxzZSA/IGZhbHNlIDogdHJ1ZTtcclxuICAgICAgICAgICAgLy8gfSkpO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuIG9mKHRydWUpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICB0aGlzLmluaXRMaXN0ZW5lcnMoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOe7keWumuWRveS7pFxyXG4gICAqL1xyXG4gIHB1YmxpYyBidWlsZENvbW1hbmRzKGNvbnRleHQ6IEZyYW1lQ29udGV4dCkge1xyXG4gICAgY29uc3QgbmdDb21tYW5kczoge1xyXG4gICAgICBbY29tbWFuZE5hbWU6IHN0cmluZ106IE5nQ29tbWFuZFxyXG4gICAgfSA9IGNvbnRleHQubWV0YWRhdGEuY29tbWFuZHMgfHwgTWV0YWRhdGFVdGlsLmdldFByb3BzTWV0YWRhdGFzQnlOYW1lKHRoaXMuY29uc3RydWN0b3IsIE5HX0NPTU1BTkQpO1xyXG4gICAgdGhpcy5tZXRhZGF0YXMgPSBuZ0NvbW1hbmRzO1xyXG4gICAgdGhpcy5rZXliaW5kaW5nTWFwID0gbmV3IE1hcDxzdHJpbmcsIEtleWJpbmRpbmc+KCk7XHJcbiAgICBPYmplY3Qua2V5cyhuZ0NvbW1hbmRzKS5mb3JFYWNoKChwcm9wZXJ0eU5hbWU6IHN0cmluZykgPT4ge1xyXG4gICAgICBjb25zdCBuZ0NvbW1hbmQ6IE5nQ29tbWFuZCA9IG5nQ29tbWFuZHNbcHJvcGVydHlOYW1lXTtcclxuICAgICAgLy8g5rOo5YaM5b+r5o236ZSuXHJcbiAgICAgIGlmIChuZ0NvbW1hbmQua2V5QmluZGluZykge1xyXG4gICAgICAgIHRoaXMua2V5YmluZGluZ01hcC5zZXQocHJvcGVydHlOYW1lLCBuZ0NvbW1hbmQua2V5QmluZGluZyk7XHJcbiAgICAgIH1cclxuICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsIHByb3BlcnR5TmFtZSwge1xyXG4gICAgICAgIHZhbHVlOiAoZGF0YTogYW55KSA9PiB7XHJcbiAgICAgICAgICAvLyDojrflj5blkb3ku6TlpITnkIbkuIrkuIvmlodcclxuICAgICAgICAgIGxldCB0YXJnZXRDb250ZXh0ID0gY29udGV4dDtcclxuICAgICAgICAgIGlmIChuZ0NvbW1hbmQuZnJhbWVJZCkge1xyXG4gICAgICAgICAgICB0YXJnZXRDb250ZXh0ID0gY29udGV4dC5hcHBDb250ZXh0LmdldEZyYW1lQ29udGV4dChuZ0NvbW1hbmQuZnJhbWVJZCk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBjb25zdCBjb21tYW5kOiBDb21tYW5kID0ge1xyXG4gICAgICAgICAgICBuYW1lOiBuZ0NvbW1hbmQubmFtZSxcclxuICAgICAgICAgICAgcGFyYW1zOiBuZ0NvbW1hbmQucGFyYW1zLFxyXG4gICAgICAgICAgICBwYXJhbURlc2NyaXB0aW9uczogbmdDb21tYW5kLnBhcmFtRGVzY3JpcHRpb25zLFxyXG4gICAgICAgICAgICBldmVudFBhcmFtOiBkYXRhIHx8IG51bGxcclxuICAgICAgICAgIH07XHJcbiAgICAgICAgICByZXR1cm4gdGFyZ2V0Q29udGV4dC5jb21tYW5kQnVzLmRpc3BhdGNoKGNvbW1hbmQpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOS7jkZvcm3ojrflj5bnm5HlkKzlmahcclxuICAgKi9cclxuICBwcml2YXRlIGluaXRMaXN0ZW5lcnMoKSB7XHJcbiAgICBjb25zdCBleHRyYWN0UGF0aCA9IChiaW5kaW5nQmFzZVBhdGg6IHN0cmluZywgYmluZGluZ1BhdGg6IHN0cmluZyk6IHN0cmluZyA9PiB7XHJcbiAgICAgIHJldHVybiAnLycgKyBiaW5kaW5nQmFzZVBhdGguc3BsaXQoJy8nKS5jb25jYXQoYmluZGluZ1BhdGguc3BsaXQoJy4nKSkuZmlsdGVyKChpdGVtKSA9PiBpdGVtLmxlbmd0aCA+IDApLmpvaW4oJy8nKTtcclxuICAgIH07XHJcblxyXG4gICAgaWYgKHRoaXMuZm9ybSkge1xyXG4gICAgICBjb25zdCB2YWx1ZUNoYW5naW5nTGlzdGVuZXJzID0gdGhpcy5mb3JtLmdldEVudGl0eVZhbHVlQ2hhbmdpbmdMaXN0ZW5lcnMoKTtcclxuICAgICAgT2JqZWN0LmtleXModmFsdWVDaGFuZ2luZ0xpc3RlbmVycykuZm9yRWFjaCgoYmluZGluZ1BhdGgpID0+IHtcclxuICAgICAgICBjb25zdCBwbGFpblBhdGggPSBleHRyYWN0UGF0aCh0aGlzLmJpbmRpbmdQYXRoLCBiaW5kaW5nUGF0aCk7XHJcbiAgICAgICAgdGhpcy5lbnRpdHlWYWx1ZUNoYW5naW5nTGlzdGVuZXJzW3BsYWluUGF0aF0gPSB2YWx1ZUNoYW5naW5nTGlzdGVuZXJzW2JpbmRpbmdQYXRoXTtcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBjb25zdCB2YWx1ZUNoYW5nZWRMaXN0ZW5lcnMgPSB0aGlzLmZvcm0uZ2V0RW50aXR5VmFsdWVDaGFuZ2VkTGlzdGVuZXJzKCk7XHJcbiAgICAgIE9iamVjdC5rZXlzKHZhbHVlQ2hhbmdlZExpc3RlbmVycykuZm9yRWFjaCgoYmluZGluZ1BhdGgpID0+IHtcclxuICAgICAgICBjb25zdCBwbGFpblBhdGggPSBleHRyYWN0UGF0aCh0aGlzLmJpbmRpbmdQYXRoLCBiaW5kaW5nUGF0aCk7XHJcbiAgICAgICAgdGhpcy5lbnRpdHlWYWx1ZUNoYW5nZWRMaXN0ZW5lcnNbcGxhaW5QYXRoXSA9IHZhbHVlQ2hhbmdlZExpc3RlbmVyc1tiaW5kaW5nUGF0aF07XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHVibGljIGJpbmRUb1BhcmVudChwYXJlbnQ6IFZpZXdNb2RlbCkge1xyXG4gICAgaWYgKHBhcmVudCkge1xyXG4gICAgICBpZiAocGFyZW50LnZlcmlmeWNhdGlvbkNoYW5nZWQpIHtcclxuICAgICAgICBwYXJlbnQudmVyaWZ5Y2F0aW9uQ2hhbmdlZC5zdWJzY3JpYmUodmVyaWZ5SW5mb3JtYXRpb25zID0+IHtcclxuICAgICAgICAgIHRoaXMudmVyaWZ5Y2F0aW9uQ2hhbmdlZC5uZXh0KHZlcmlmeUluZm9ybWF0aW9ucyk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcbiAgLyoqXHJcbiAgICog5ZCI5bm25a6h5om55Y+K6KGo5Y2V6KGo6L6+5byP5bm26K6h566X57uT5p6cXHJcbiAgICogQHBhcmFtIGV4cHJlc3Npb24g6KGo6L6+5byPXHJcbiAgICogQHJldHVybnMgXHJcbiAgICovXHJcbiAgcHVibGljIHRyYW5zZm9ybShleHByZXNzaW9uOiBzdHJpbmcgfCBib29sZWFuIHwgQXJyYXk8YW55Pik6IGFueSB7XHJcbiAgICBpZiAoQXJyYXkuaXNBcnJheShleHByZXNzaW9uKSkge1xyXG4gICAgICBjb25zdCB3ZkNvbmYgPSBleHByZXNzaW9uLmZpbmQoaXRlbSA9PiBpdGVtICYmIGl0ZW0uc291cmNlID09PSAnd2YnKTtcclxuICAgICAgaWYgKHdmQ29uZiAmJiB3ZkNvbmYudmFsdWUpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy50cmFuc2Zvcm0od2ZDb25mLnZhbHVlKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICByZXR1cm4gdGhpcy50cmFuc2Zvcm0oZXhwcmVzc2lvblswXSk7XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGlmICh0eXBlb2YgZXhwcmVzc2lvbiA9PT0gJ2Jvb2xlYW4nKSB7XHJcbiAgICAgICAgcmV0dXJuIGV4cHJlc3Npb247XHJcbiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGV4cHJlc3Npb24gPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBGdW5jdGlvbignY3R4JywgYHJldHVybiAke2V4cHJlc3Npb259YCkuYXBwbHkodGhpcy5mcmFtZUNvbnRleHQsIFt0aGlzXSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgLy8g6KGo6L6+5byPcmVzdWx0XHJcbiAgICAgICAgcmV0dXJuIGV4cHJlc3Npb247XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcbn1cclxuXHJcbmV4cG9ydCB7IFZpZXdNb2RlbCB9O1xyXG4iXX0=