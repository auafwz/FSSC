/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { BehaviorSubject } from 'rxjs';
import { map } from 'rxjs/operators';
/**
 * @template T
 */
var /**
 * @template T
 */
BaseDataFacadeService = /** @class */ (function () {
    function BaseDataFacadeService(_initState) {
        this._initState = _initState;
        this._state = this._initState;
        this.store = new BehaviorSubject(this._state);
        this.state$ = this.store.asObservable();
        this.data$ = this.state$.pipe(map((/**
         * @param {?} state
         * @return {?}
         */
        function (state) { return state.data; })));
    }
    /**
     * @private
     * @param {?} data
     * @return {?}
     */
    BaseDataFacadeService.prototype.initData = /**
     * @private
     * @param {?} data
     * @return {?}
     */
    function (data) {
        var _this = this;
        return data.map((/**
         * @param {?} d
         * @return {?}
         */
        function (d) {
            /** @type {?} */
            var _id = d[_this._state.idField];
            /** @type {?} */
            var disable = (/**
             * @return {?}
             */
            function () {
                return _this.disableExpress ? _this.disableExpress(d) : false;
            });
            return {
                id: _id,
                data: d,
                disabled: disable(),
            };
        }));
    };
    /**
     * @protected
     * @param {?} state
     * @return {?}
     */
    BaseDataFacadeService.prototype.updateState = /**
     * @protected
     * @param {?} state
     * @return {?}
     */
    function (state) {
        /** @type {?} */
        var newState = tslib_1.__assign({}, this._state, state);
        this.store.next(this._state = newState);
    };
    /**
     * @param {?} state
     * @return {?}
     */
    BaseDataFacadeService.prototype.initState = /**
     * @param {?} state
     * @return {?}
     */
    function (state) {
        this.updateState(state);
    };
    /**
     * @param {?} id
     * @return {?}
     */
    BaseDataFacadeService.prototype.isSelect = /**
     * @param {?} id
     * @return {?}
     */
    function (id) {
        var _this = this;
        if (this._state.selections && this._state.selections.length) {
            return this._state.selections.find((/**
             * @param {?} item
             * @return {?}
             */
            function (item) { return !!item ? item[_this._state.idField] == id : false; })) !== undefined;
        }
        return false;
    };
    /**
     * @param {?} data
     * @param {?=} selectValues
     * @param {?=} separator
     * @return {?}
     */
    BaseDataFacadeService.prototype.loadData = /**
     * @param {?} data
     * @param {?=} selectValues
     * @param {?=} separator
     * @return {?}
     */
    function (data, selectValues, separator) {
        var _this = this;
        if (selectValues === void 0) { selectValues = ''; }
        if (separator === void 0) { separator = ','; }
        if (data) {
            if (selectValues) {
                /** @type {?} */
                var selectedItems = selectValues.split(separator).map((/**
                 * @param {?} val
                 * @return {?}
                 */
                function (val) {
                    return data.find((/**
                     * @param {?} d
                     * @return {?}
                     */
                    function (d) { return d[_this._state.valueField] + '' == val; }));
                }));
                this._state.selections = selectedItems.filter((/**
                 * @param {?} e
                 * @return {?}
                 */
                function (e) { return !!e; }));
            }
            else {
                this._state.selections = [];
            }
            /** @type {?} */
            var _data = this.initData(data);
            this.updateState(tslib_1.__assign({}, this._state, { data: _data }));
        }
        else {
            this.updateState({ data: [], selections: [] });
        }
    };
    /**
     * @return {?}
     */
    BaseDataFacadeService.prototype.getSelections = /**
     * @return {?}
     */
    function () {
        return this._state.selections;
    };
    /**
     * @param {?} selectValues
     * @param {?=} separator
     * @return {?}
     */
    BaseDataFacadeService.prototype.setSelections = /**
     * @param {?} selectValues
     * @param {?=} separator
     * @return {?}
     */
    function (selectValues, separator) {
        var _this = this;
        if (separator === void 0) { separator = ','; }
        if (selectValues) {
            /** @type {?} */
            var selectedItems = [];
            if (this._state.multiSelect) {
                selectedItems = selectValues.split(separator).map((/**
                 * @param {?} val
                 * @return {?}
                 */
                function (val) {
                    return _this._state.data.find((/**
                     * @param {?} d
                     * @return {?}
                     */
                    function (d) { return d.data[_this._state.valueField] + '' == val; }));
                })).map((/**
                 * @param {?} n
                 * @return {?}
                 */
                function (n) {
                    return n ? n.data : '';
                })).filter((/**
                 * @param {?} n
                 * @return {?}
                 */
                function (n) { return n; }));
            }
            else {
                selectedItems = [this._state.data.find((/**
                     * @param {?} d
                     * @return {?}
                     */
                    function (d) { return d.data[_this._state.valueField] + '' == selectValues; }))];
            }
            this.updateState({ selections: selectedItems });
        }
    };
    /**
     * @return {?}
     */
    BaseDataFacadeService.prototype.selectAll = /**
     * @return {?}
     */
    function () {
        this.updateState({ selections: this._state.data.map((/**
             * @param {?} n
             * @return {?}
             */
            function (n) { return n.data; })) });
    };
    /**
     * @return {?}
     */
    BaseDataFacadeService.prototype.unSelectAll = /**
     * @return {?}
     */
    function () {
        this.clearSelections();
    };
    /**
     * @param {?} data
     * @param {?=} index
     * @return {?}
     */
    BaseDataFacadeService.prototype.selectItem = /**
     * @param {?} data
     * @param {?=} index
     * @return {?}
     */
    function (data, index) {
        /** @type {?} */
        var idfield = this._state.idField;
        /** @type {?} */
        var selections = this.getSelections();
        /** @type {?} */
        var id = data[idfield];
        if (!this._state.multiSelect) {
            if (!this.isSelect(id)) {
                selections = [data];
            }
        }
        else {
            if (!this.isSelect(id)) {
                selections.push(data);
            }
        }
        /** @type {?} */
        var items = this.cloneArray(selections);
        this.updateState({ selections: items });
    };
    /**
     * @param {?} data
     * @return {?}
     */
    BaseDataFacadeService.prototype.unSelectItem = /**
     * @param {?} data
     * @return {?}
     */
    function (data) {
        /** @type {?} */
        var idfield = this._state.idField;
        /** @type {?} */
        var selections = this.getSelections();
        /** @type {?} */
        var id = data[idfield];
        if (!this._state.multiSelect) {
            selections = [];
        }
        else {
            selections = selections.filter((/**
             * @param {?} n
             * @return {?}
             */
            function (n) { return n[idfield] != id; }));
        }
        /** @type {?} */
        var items = this.cloneArray(selections);
        this.updateState({ selections: items });
    };
    /**
     * @return {?}
     */
    BaseDataFacadeService.prototype.clearSelections = /**
     * @return {?}
     */
    function () {
        this.updateState({ selections: [] });
    };
    /**
     * @private
     * @param {?} arr
     * @return {?}
     */
    BaseDataFacadeService.prototype.cloneArray = /**
     * @private
     * @param {?} arr
     * @return {?}
     */
    function (arr) {
        if (arr && arr.length) {
            return arr.map((/**
             * @param {?} n
             * @return {?}
             */
            function (n) { return n; }));
        }
        return arr;
    };
    return BaseDataFacadeService;
}());
/**
 * @template T
 */
export { BaseDataFacadeService };
if (false) {
    /**
     * @type {?}
     * @protected
     */
    BaseDataFacadeService.prototype._state;
    /** @type {?} */
    BaseDataFacadeService.prototype.disableExpress;
    /** @type {?} */
    BaseDataFacadeService.prototype.store;
    /** @type {?} */
    BaseDataFacadeService.prototype.state$;
    /** @type {?} */
    BaseDataFacadeService.prototype.data$;
    /**
     * @type {?}
     * @private
     */
    BaseDataFacadeService.prototype._initState;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzZS1kYXRhLmZhY2FkZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy91aS1jb21tb24vIiwic291cmNlcyI6WyJsaWIvc2VydmljZS9iYXNlLWRhdGEuZmFjYWRlLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFDQSxPQUFPLEVBQUUsZUFBZSxFQUFjLE1BQU0sTUFBTSxDQUFDO0FBQ25ELE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQzs7OztBQUVyQzs7OztJQVNJLCtCQUFvQixVQUFhO1FBQWIsZUFBVSxHQUFWLFVBQVUsQ0FBRztRQVJ2QixXQUFNLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQztRQUcxQixVQUFLLEdBQUksSUFBSSxlQUFlLENBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQzdDLFdBQU0sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFlBQVksRUFBRSxDQUFDO1FBRTVDLFVBQUssR0FBb0IsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRzs7OztRQUFDLFVBQUMsS0FBUSxJQUFLLE9BQUEsS0FBSyxDQUFDLElBQUksRUFBVixDQUFVLEVBQUMsQ0FBQyxDQUFDO0lBR3pFLENBQUM7Ozs7OztJQUVPLHdDQUFROzs7OztJQUFoQixVQUFpQixJQUFTO1FBQTFCLGlCQVlDO1FBWEcsT0FBTyxJQUFJLENBQUMsR0FBRzs7OztRQUFDLFVBQUEsQ0FBQzs7Z0JBQ1AsR0FBRyxHQUFHLENBQUMsQ0FBQyxLQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQzs7Z0JBQzVCLE9BQU87OztZQUFHO2dCQUNaLE9BQU8sS0FBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsS0FBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDO1lBQ2hFLENBQUMsQ0FBQTtZQUNELE9BQU87Z0JBQ0gsRUFBRSxFQUFFLEdBQUc7Z0JBQ1AsSUFBSSxFQUFFLENBQUM7Z0JBQ1AsUUFBUSxFQUFFLE9BQU8sRUFBRTthQUN0QixDQUFDO1FBQ04sQ0FBQyxFQUFDLENBQUM7SUFDUCxDQUFDOzs7Ozs7SUFFUywyQ0FBVzs7Ozs7SUFBckIsVUFBc0IsS0FBVTs7WUFDdEIsUUFBUSx3QkFBTyxJQUFJLENBQUMsTUFBTSxFQUFLLEtBQUssQ0FBQztRQUMzQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxHQUFHLFFBQVEsQ0FBQyxDQUFDO0lBQzVDLENBQUM7Ozs7O0lBRUQseUNBQVM7Ozs7SUFBVCxVQUFVLEtBQVU7UUFDaEIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUM1QixDQUFDOzs7OztJQUVELHdDQUFROzs7O0lBQVIsVUFBUyxFQUFPO1FBQWhCLGlCQUtDO1FBSkcsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxNQUFNLEVBQUU7WUFDekQsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxJQUFJOzs7O1lBQUMsVUFBQSxJQUFJLElBQUksT0FBQSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssRUFBaEQsQ0FBZ0QsRUFBQyxLQUFLLFNBQVMsQ0FBQztTQUM5RztRQUNELE9BQU8sS0FBSyxDQUFDO0lBQ2pCLENBQUM7Ozs7Ozs7SUFHRCx3Q0FBUTs7Ozs7O0lBQVIsVUFBUyxJQUFTLEVBQUUsWUFBeUIsRUFBRSxTQUFlO1FBQTlELGlCQWVDO1FBZm1CLDZCQUFBLEVBQUEsaUJBQXlCO1FBQUUsMEJBQUEsRUFBQSxlQUFlO1FBQzFELElBQUksSUFBSSxFQUFFO1lBQ04sSUFBSSxZQUFZLEVBQUU7O29CQUNSLGFBQWEsR0FBRyxZQUFZLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDLEdBQUc7Ozs7Z0JBQUUsVUFBQSxHQUFHO29CQUN4RCxPQUFPLElBQUksQ0FBQyxJQUFJOzs7O29CQUFDLFVBQUEsQ0FBQyxJQUFJLE9BQUEsQ0FBQyxDQUFDLEtBQUksQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLEdBQUcsRUFBRSxJQUFJLEdBQUcsRUFBckMsQ0FBcUMsRUFBQyxDQUFDO2dCQUNqRSxDQUFDLEVBQUM7Z0JBQ0YsSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLEdBQUcsYUFBYSxDQUFDLE1BQU07Ozs7Z0JBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxDQUFDLENBQUMsQ0FBQyxFQUFILENBQUcsRUFBQyxDQUFDO2FBQzNEO2lCQUFNO2dCQUNILElBQUksQ0FBQyxNQUFNLENBQUMsVUFBVSxHQUFHLEVBQUUsQ0FBQzthQUMvQjs7Z0JBQ0ssS0FBSyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDO1lBQ2pDLElBQUksQ0FBQyxXQUFXLHNCQUFLLElBQUksQ0FBQyxNQUFNLElBQUUsSUFBSSxFQUFFLEtBQUssSUFBRSxDQUFDO1NBQ25EO2FBQU07WUFDSCxJQUFJLENBQUMsV0FBVyxDQUFDLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRSxVQUFVLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQztTQUNsRDtJQUNMLENBQUM7Ozs7SUFFRCw2Q0FBYTs7O0lBQWI7UUFDSSxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDO0lBQ2xDLENBQUM7Ozs7OztJQUVELDZDQUFhOzs7OztJQUFiLFVBQWMsWUFBb0IsRUFBRSxTQUFlO1FBQW5ELGlCQWNDO1FBZG1DLDBCQUFBLEVBQUEsZUFBZTtRQUMvQyxJQUFJLFlBQVksRUFBRTs7Z0JBQ1YsYUFBYSxHQUFHLEVBQUU7WUFDdEIsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLFdBQVcsRUFBRTtnQkFDekIsYUFBYSxHQUFHLFlBQVksQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUMsR0FBRzs7OztnQkFBRSxVQUFBLEdBQUc7b0JBQ2xELE9BQU8sS0FBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSTs7OztvQkFBQyxVQUFBLENBQUMsSUFBSSxPQUFBLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsR0FBRyxFQUFFLElBQUksR0FBRyxFQUExQyxDQUEwQyxFQUFDLENBQUM7Z0JBQ2xGLENBQUMsRUFBQyxDQUFDLEdBQUc7Ozs7Z0JBQUUsVUFBQSxDQUFDO29CQUNMLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7Z0JBQzNCLENBQUMsRUFBQyxDQUFDLE1BQU07Ozs7Z0JBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxDQUFDLEVBQUQsQ0FBQyxFQUFDLENBQUM7YUFDckI7aUJBQU07Z0JBQ0gsYUFBYSxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSTs7OztvQkFBQyxVQUFBLENBQUMsSUFBSSxPQUFBLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsR0FBRyxFQUFFLElBQUksWUFBWSxFQUFuRCxDQUFtRCxFQUFDLENBQUMsQ0FBQzthQUNyRztZQUNELElBQUksQ0FBQyxXQUFXLENBQUMsRUFBQyxVQUFVLEVBQUUsYUFBYSxFQUFFLENBQUMsQ0FBQztTQUNsRDtJQUNMLENBQUM7Ozs7SUFFRCx5Q0FBUzs7O0lBQVQ7UUFDSSxJQUFJLENBQUMsV0FBVyxDQUFDLEVBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUc7Ozs7WUFBQyxVQUFBLENBQUMsSUFBSSxPQUFBLENBQUMsQ0FBQyxJQUFJLEVBQU4sQ0FBTSxFQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQ3ZFLENBQUM7Ozs7SUFFRCwyQ0FBVzs7O0lBQVg7UUFDSSxJQUFJLENBQUMsZUFBZSxFQUFFLENBQUM7SUFDM0IsQ0FBQzs7Ozs7O0lBRUQsMENBQVU7Ozs7O0lBQVYsVUFBVyxJQUFTLEVBQUUsS0FBYzs7WUFDMUIsT0FBTyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTzs7WUFDL0IsVUFBVSxHQUFHLElBQUksQ0FBQyxhQUFhLEVBQUU7O1lBRS9CLEVBQUUsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDO1FBQ3hCLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLFdBQVcsRUFBRTtZQUMxQixJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsRUFBRTtnQkFDcEIsVUFBVSxHQUFHLENBQUUsSUFBSSxDQUFFLENBQUM7YUFDekI7U0FDSjthQUFNO1lBQ0gsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLEVBQUU7Z0JBQ3BCLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDekI7U0FDSjs7WUFFSyxLQUFLLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUM7UUFFekMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxFQUFDLFVBQVUsRUFBRSxLQUFLLEVBQUMsQ0FBQyxDQUFDO0lBQzFDLENBQUM7Ozs7O0lBRUQsNENBQVk7Ozs7SUFBWixVQUFhLElBQVM7O1lBQ1osT0FBTyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTzs7WUFDL0IsVUFBVSxHQUFHLElBQUksQ0FBQyxhQUFhLEVBQUU7O1lBQy9CLEVBQUUsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDO1FBQ3hCLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLFdBQVcsRUFBRTtZQUMxQixVQUFVLEdBQUcsRUFBRSxDQUFDO1NBQ25CO2FBQU07WUFDSCxVQUFVLEdBQUcsVUFBVSxDQUFDLE1BQU07Ozs7WUFBQyxVQUFBLENBQUMsSUFBSSxPQUFBLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLEVBQWhCLENBQWdCLEVBQUMsQ0FBRTtTQUMxRDs7WUFFSyxLQUFLLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUM7UUFDekMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxFQUFDLFVBQVUsRUFBRSxLQUFLLEVBQUMsQ0FBQyxDQUFDO0lBQzFDLENBQUM7Ozs7SUFFRCwrQ0FBZTs7O0lBQWY7UUFDSSxJQUFJLENBQUMsV0FBVyxDQUFDLEVBQUMsVUFBVSxFQUFFLEVBQUUsRUFBQyxDQUFDLENBQUM7SUFDdkMsQ0FBQzs7Ozs7O0lBRU8sMENBQVU7Ozs7O0lBQWxCLFVBQW1CLEdBQVU7UUFDekIsSUFBSSxHQUFHLElBQUksR0FBRyxDQUFDLE1BQU0sRUFBRTtZQUNuQixPQUFPLEdBQUcsQ0FBQyxHQUFHOzs7O1lBQUUsVUFBQSxDQUFDLElBQUksT0FBQSxDQUFDLEVBQUQsQ0FBQyxFQUFDLENBQUM7U0FDM0I7UUFFRCxPQUFPLEdBQUcsQ0FBQztJQUNmLENBQUM7SUFDTCw0QkFBQztBQUFELENBQUMsQUFySUQsSUFxSUM7Ozs7Ozs7Ozs7SUFwSUcsdUNBQW1DOztJQUNuQywrQ0FBa0M7O0lBRWxDLHNDQUFzRDs7SUFDdEQsdUNBQTRDOztJQUU1QyxzQ0FBeUU7Ozs7O0lBRTdELDJDQUFxQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEZhcnJpc0RhdGFTdGF0ZSB9IGZyb20gJy4vZmFycmlzLWRhdGFpdGVtJztcclxuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0LCBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IG1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuXHJcbmV4cG9ydCBjbGFzcyBCYXNlRGF0YUZhY2FkZVNlcnZpY2U8VCBleHRlbmRzIEZhcnJpc0RhdGFTdGF0ZT4ge1xyXG4gICAgcHJvdGVjdGVkIF9zdGF0ZSA9IHRoaXMuX2luaXRTdGF0ZTtcclxuICAgIGRpc2FibGVFeHByZXNzOiAoaXRlbSkgPT4gYm9vbGVhbjtcclxuXHJcbiAgICByZWFkb25seSBzdG9yZSAgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PFQ+KHRoaXMuX3N0YXRlKTtcclxuICAgIHJlYWRvbmx5IHN0YXRlJCA9IHRoaXMuc3RvcmUuYXNPYnNlcnZhYmxlKCk7XHJcblxyXG4gICAgZGF0YSQ6IE9ic2VydmFibGU8YW55PiA9IHRoaXMuc3RhdGUkLnBpcGUobWFwKChzdGF0ZTogVCkgPT4gc3RhdGUuZGF0YSkpO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgX2luaXRTdGF0ZTogVCkge1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgaW5pdERhdGEoZGF0YTogYW55KSB7XHJcbiAgICAgICAgcmV0dXJuIGRhdGEubWFwKGQgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBfaWQgPSBkW3RoaXMuX3N0YXRlLmlkRmllbGRdO1xyXG4gICAgICAgICAgICBjb25zdCBkaXNhYmxlID0gKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZGlzYWJsZUV4cHJlc3MgPyB0aGlzLmRpc2FibGVFeHByZXNzKGQpIDogZmFsc2U7XHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICBpZDogX2lkLFxyXG4gICAgICAgICAgICAgICAgZGF0YTogZCxcclxuICAgICAgICAgICAgICAgIGRpc2FibGVkOiBkaXNhYmxlKCksXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIHVwZGF0ZVN0YXRlKHN0YXRlOiBhbnkpIHtcclxuICAgICAgICBjb25zdCBuZXdTdGF0ZSA9IHsuLi50aGlzLl9zdGF0ZSwgLi4uc3RhdGV9O1xyXG4gICAgICAgIHRoaXMuc3RvcmUubmV4dCh0aGlzLl9zdGF0ZSA9IG5ld1N0YXRlKTtcclxuICAgIH1cclxuXHJcbiAgICBpbml0U3RhdGUoc3RhdGU6IGFueSkge1xyXG4gICAgICAgIHRoaXMudXBkYXRlU3RhdGUoc3RhdGUpO1xyXG4gICAgfVxyXG5cclxuICAgIGlzU2VsZWN0KGlkOiBhbnkpIHtcclxuICAgICAgICBpZiAodGhpcy5fc3RhdGUuc2VsZWN0aW9ucyAmJiB0aGlzLl9zdGF0ZS5zZWxlY3Rpb25zLmxlbmd0aCkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5fc3RhdGUuc2VsZWN0aW9ucy5maW5kKGl0ZW0gPT4gISFpdGVtID8gaXRlbVt0aGlzLl9zdGF0ZS5pZEZpZWxkXSA9PSBpZCA6IGZhbHNlKSAhPT0gdW5kZWZpbmVkO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIGxvYWREYXRhKGRhdGE6IGFueSwgc2VsZWN0VmFsdWVzOiBzdHJpbmcgPSAnJywgc2VwYXJhdG9yID0gJywnKSB7XHJcbiAgICAgICAgaWYgKGRhdGEpIHtcclxuICAgICAgICAgICAgaWYgKHNlbGVjdFZhbHVlcykge1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgc2VsZWN0ZWRJdGVtcyA9IHNlbGVjdFZhbHVlcy5zcGxpdChzZXBhcmF0b3IpLm1hcCggdmFsID0+IHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGF0YS5maW5kKGQgPT4gZFt0aGlzLl9zdGF0ZS52YWx1ZUZpZWxkXSArICcnID09IHZhbCk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIHRoaXMuX3N0YXRlLnNlbGVjdGlvbnMgPSBzZWxlY3RlZEl0ZW1zLmZpbHRlcihlID0+ICEhZSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLl9zdGF0ZS5zZWxlY3Rpb25zID0gW107XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY29uc3QgX2RhdGEgPSB0aGlzLmluaXREYXRhKGRhdGEpO1xyXG4gICAgICAgICAgICB0aGlzLnVwZGF0ZVN0YXRlKHsuLi50aGlzLl9zdGF0ZSwgZGF0YTogX2RhdGF9KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLnVwZGF0ZVN0YXRlKHsgZGF0YTogW10sIHNlbGVjdGlvbnM6IFtdIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBnZXRTZWxlY3Rpb25zKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9zdGF0ZS5zZWxlY3Rpb25zO1xyXG4gICAgfVxyXG5cclxuICAgIHNldFNlbGVjdGlvbnMoc2VsZWN0VmFsdWVzOiBzdHJpbmcsIHNlcGFyYXRvciA9ICcsJykge1xyXG4gICAgICAgIGlmIChzZWxlY3RWYWx1ZXMpIHtcclxuICAgICAgICAgICAgbGV0IHNlbGVjdGVkSXRlbXMgPSBbXTtcclxuICAgICAgICAgICAgaWYgKHRoaXMuX3N0YXRlLm11bHRpU2VsZWN0KSB7XHJcbiAgICAgICAgICAgICAgICBzZWxlY3RlZEl0ZW1zID0gc2VsZWN0VmFsdWVzLnNwbGl0KHNlcGFyYXRvcikubWFwKCB2YWwgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9zdGF0ZS5kYXRhLmZpbmQoZCA9PiBkLmRhdGFbdGhpcy5fc3RhdGUudmFsdWVGaWVsZF0gKyAnJyA9PSB2YWwpO1xyXG4gICAgICAgICAgICAgICAgfSkubWFwKCBuID0+IHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbiA/IG4uZGF0YSA6ICcnO1xyXG4gICAgICAgICAgICAgICAgfSkuZmlsdGVyKG4gPT4gbik7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBzZWxlY3RlZEl0ZW1zID0gW3RoaXMuX3N0YXRlLmRhdGEuZmluZChkID0+IGQuZGF0YVt0aGlzLl9zdGF0ZS52YWx1ZUZpZWxkXSArICcnID09IHNlbGVjdFZhbHVlcyldO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMudXBkYXRlU3RhdGUoe3NlbGVjdGlvbnM6IHNlbGVjdGVkSXRlbXMgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHNlbGVjdEFsbCgpIHtcclxuICAgICAgICB0aGlzLnVwZGF0ZVN0YXRlKHtzZWxlY3Rpb25zOiB0aGlzLl9zdGF0ZS5kYXRhLm1hcChuID0+IG4uZGF0YSkgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgdW5TZWxlY3RBbGwoKSB7XHJcbiAgICAgICAgdGhpcy5jbGVhclNlbGVjdGlvbnMoKTtcclxuICAgIH1cclxuXHJcbiAgICBzZWxlY3RJdGVtKGRhdGE6IGFueSwgaW5kZXg/OiBudW1iZXIpIHtcclxuICAgICAgICBjb25zdCBpZGZpZWxkID0gdGhpcy5fc3RhdGUuaWRGaWVsZDtcclxuICAgICAgICBsZXQgc2VsZWN0aW9ucyA9IHRoaXMuZ2V0U2VsZWN0aW9ucygpO1xyXG5cclxuICAgICAgICBjb25zdCBpZCA9IGRhdGFbaWRmaWVsZF07XHJcbiAgICAgICAgaWYgKCF0aGlzLl9zdGF0ZS5tdWx0aVNlbGVjdCkge1xyXG4gICAgICAgICAgICBpZiAoIXRoaXMuaXNTZWxlY3QoaWQpKSB7XHJcbiAgICAgICAgICAgICAgICBzZWxlY3Rpb25zID0gWyBkYXRhIF07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBpZiAoIXRoaXMuaXNTZWxlY3QoaWQpKSB7XHJcbiAgICAgICAgICAgICAgICBzZWxlY3Rpb25zLnB1c2goZGF0YSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IGl0ZW1zID0gdGhpcy5jbG9uZUFycmF5KHNlbGVjdGlvbnMpO1xyXG5cclxuICAgICAgICB0aGlzLnVwZGF0ZVN0YXRlKHtzZWxlY3Rpb25zOiBpdGVtc30pO1xyXG4gICAgfVxyXG5cclxuICAgIHVuU2VsZWN0SXRlbShkYXRhOiBhbnkpIHtcclxuICAgICAgICBjb25zdCBpZGZpZWxkID0gdGhpcy5fc3RhdGUuaWRGaWVsZDtcclxuICAgICAgICBsZXQgc2VsZWN0aW9ucyA9IHRoaXMuZ2V0U2VsZWN0aW9ucygpO1xyXG4gICAgICAgIGNvbnN0IGlkID0gZGF0YVtpZGZpZWxkXTtcclxuICAgICAgICBpZiAoIXRoaXMuX3N0YXRlLm11bHRpU2VsZWN0KSB7XHJcbiAgICAgICAgICAgIHNlbGVjdGlvbnMgPSBbXTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBzZWxlY3Rpb25zID0gc2VsZWN0aW9ucy5maWx0ZXIobiA9PiBuW2lkZmllbGRdICE9IGlkKSA7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBpdGVtcyA9IHRoaXMuY2xvbmVBcnJheShzZWxlY3Rpb25zKTtcclxuICAgICAgICB0aGlzLnVwZGF0ZVN0YXRlKHtzZWxlY3Rpb25zOiBpdGVtc30pO1xyXG4gICAgfVxyXG5cclxuICAgIGNsZWFyU2VsZWN0aW9ucygpIHtcclxuICAgICAgICB0aGlzLnVwZGF0ZVN0YXRlKHtzZWxlY3Rpb25zOiBbXX0pO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgY2xvbmVBcnJheShhcnI6IGFueVtdKSB7XHJcbiAgICAgICAgaWYgKGFyciAmJiBhcnIubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBhcnIubWFwKCBuID0+IG4pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIGFycjtcclxuICAgIH1cclxufVxyXG4iXX0=