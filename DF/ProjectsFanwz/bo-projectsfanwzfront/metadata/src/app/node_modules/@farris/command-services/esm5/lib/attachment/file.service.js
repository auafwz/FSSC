import { Injectable, Optional } from '@angular/core';
import { forkJoin, Subject } from 'rxjs';
import { FrameContext, BindingPathConverter } from '@farris/devkit';
import { FormNotifyService } from '../form-notify.service';
import { AttachmentDataService } from './attachment-data.service';
import { LanguageService } from '../languag.service';
import { EntityService } from '../entity-services/index';
import { ListDataService, SubListDataService } from '../data-services/index';
import { FormLoadingService } from '../form-loading/form-loading.service';
import { debounceTime, tap } from 'rxjs/operators';
/**
 * 附件上传
 * @summary
 * fileExtend：命名文件上传或预览组件传递过来的数据；
 * fileExtendFieldPath：命名附件UDT的字段路径；
 * attachmentInfo：命名附件UDT所需的信息；
 */
var FileService = /** @class */ (function () {
    /**
     * 构造函数
     */
    function FileService(frameContext, attachDataService, entityService, subListDataService, notifyService, languageService, listDataService, formLoadingService) {
        var _this = this;
        this.frameContext = frameContext;
        this.attachDataService = attachDataService;
        this.entityService = entityService;
        this.subListDataService = subListDataService;
        this.notifyService = notifyService;
        this.languageService = languageService;
        this.listDataService = listDataService;
        this.formLoadingService = formLoadingService;
        this.subject = new Subject();
        this.subject.pipe(debounceTime(500)).subscribe(function (data) {
            _this.process(data.fileInfoFieldPath, data.configs);
        });
        this.attachmentInfos = [];
    }
    // #region 上传文件
    /**
     * 批量添加附件行
     */
    FileService.prototype.addFileRows = function (fileInfoFieldPath) {
        var attachmentInfos = this.getAttachmentInfosToAddFromContext();
        if (attachmentInfos.length === 0) {
            this.notifyService.info('请先上传附件');
        }
        return this.attachDataService.updateRows(fileInfoFieldPath, attachmentInfos);
    };
    /**
     * 批量添加带附件类型的附件行
     * @param fileInfoFieldPath 附件udt字段
     * @param configs 附件扩展信息配置
     * @description configs配置如{"billId":"{UISTATE~/root/billId}","rowId":"{UISTATE~/root/rowId}","attachmentType":"xueli"}
     */
    FileService.prototype.addFileRowsWithConfigs = function (fileInfoFieldPath, configs) {
        var attachmentInfos = this.getAttachmentInfosToAddFromContext();
        if (attachmentInfos.length === 0) {
            this.notifyService.info('请先上传附件');
        }
        // let mapFields = null;
        // if (typeof configs === 'string') {
        //   // 去掉首尾空格
        //   configs = configs.trim();
        // }
        // if (configs.startsWith('{') && configs.endsWith('}')) {
        //   try {
        //     mapFields = JSON.parse(configs);
        //   } catch {
        //     throw new Error('附件扩展信息配置不是合法的json字符串。');
        //   }
        // } else {
        //   throw new Error('附件扩展信息配置不是合法的json字符串。');
        // }
        this.attachmentInfos = this.attachmentInfos.concat(attachmentInfos);
        this.subject.next({ fileInfoFieldPath: fileInfoFieldPath, configs: configs });
        //return this.attachDataService.updateRowsWithConfigs(fileInfoFieldPath, attachmentInfos, mapFields);
    };
    FileService.prototype.process = function (fileInfoFieldPath, configs) {
        var _this = this;
        if (this.attachmentInfos && this.attachmentInfos.length > 0) {
            var attachmentInfos_1 = this.attachmentInfos.concat([]);
            var mapFields = null;
            if (typeof configs === 'string') {
                // 去掉首尾空格
                configs = configs.trim();
            }
            if (configs.startsWith('{') && configs.endsWith('}')) {
                try {
                    mapFields = JSON.parse(configs);
                }
                catch (_a) {
                    throw new Error('附件扩展信息配置不是合法的json字符串。');
                }
            }
            else {
                throw new Error('附件扩展信息配置不是合法的json字符串。');
            }
            this.attachDataService.updateRowsWithConfigs(fileInfoFieldPath, attachmentInfos_1, mapFields).pipe(tap(function () {
                _this.attachmentInfos = _this.attachmentInfos.filter(function (item) { return !attachmentInfos_1.find(function (attachmentInfo) { return attachmentInfo.attachmentId === item.attachmentId; }); });
                if (_this.attachmentInfos.length > 0) {
                    _this.process(fileInfoFieldPath, configs);
                }
            })).subscribe();
        }
    };
    /**
     * 获取要添加的附件信息数组
     */
    FileService.prototype.getAttachmentInfosToAddFromContext = function () {
        var fileExtends = this.getFileExtendsFromContext();
        var attachmentInfos = this.convertToAttachmentInfos(fileExtends);
        return attachmentInfos;
    };
    /**
     * 将附件上传组件返回的附件信息转换为服务器端需要的格式
     */
    FileService.prototype.convertToAttachmentInfos = function (fileExtends) {
        if (!fileExtends) {
            return [];
        }
        var attachmentInfos = [];
        fileExtends.forEach(function (fUploadOutPut) {
            var attachmentInfo = {
                attachmentId: fUploadOutPut.extend.metadataId,
                fileName: fUploadOutPut.extend.fileName,
            };
            attachmentInfos.push(attachmentInfo);
        });
        return attachmentInfos;
    };
    // #endregion
    // #region 删除文件
    /**
     * 删除附件行
     */
    FileService.prototype.removeFileRows = function (fileInfoFieldPath) {
        var _this = this;
        var dataIds = this.getDataIdsToRemoveFromContext(fileInfoFieldPath);
        if (dataIds.length === 0) {
            this.notifyService.info('请选择要删除的附件');
        }
        var isSublist = fileInfoFieldPath.split('/').filter(function (p) { return p; }).length >= 2;
        var removeObservables = [];
        if (isSublist) {
            dataIds.forEach(function (dataId) {
                var removeObservable;
                removeObservable = _this.subListDataService.removeWithoutConfirm(dataId);
                removeObservables.push(removeObservable);
            });
            return forkJoin(removeObservables);
        }
        else {
            return this.listDataService.removeRows(dataIds, false, null, false);
        }
    };
    /**
     * 获取要删除的数据
     */
    FileService.prototype.getDataIdsToRemoveFromContext = function (fileExtendFieldPath) {
        var _this = this;
        // 从上下文中获取要处理的附件信息数组
        var fileExtends = this.getFileExtendsFromContext();
        // 将附件数组转换为对应的数据id
        var dataIds = [];
        fileExtends.forEach(function (fileExtend) {
            // 上传删除和预览删除传递过来的fileId的key可能不一致，要做兼容
            var fileId = fileExtend.extend.metadataId;
            var dataId = _this.convertFileIdToDataId(fileId, fileExtendFieldPath);
            dataIds.push(dataId);
        });
        return dataIds;
    };
    /**
     * 根据路径获取附件字段值数组
     * @param fieldPath 字段路径
     */
    FileService.prototype.convertFileIdToDataId = function (fileId, fileExtendFieldPath) {
        // 解析路径
        var fileBindingPath = BindingPathConverter.toBindingPathArray(fileExtendFieldPath);
        var fileFieldName = fileBindingPath.pop();
        var fileListBindingPath = fileBindingPath;
        // 获取附件id数组
        var entityListData = this.entityService.getEntityListData(fileListBindingPath);
        var targetEntityData = entityListData.find(function (entityData) {
            if (entityData[fileFieldName]) {
                var attachmentId = entityData[fileFieldName]['attachmentId'];
                if (attachmentId === fileId) {
                    return true;
                }
            }
        });
        return targetEntityData.id;
    };
    // #endregion
    // #region 其他工具方法
    /**
     * 从上下文中获取要处理的附件信息数组
     * @summary
     * 为了统一单个和多个附件的处理方式，统一包装为数组
     */
    FileService.prototype.getFileExtendsFromContext = function () {
        var commandContext = this['context'];
        var eventParam = commandContext.eventParam;
        if (!eventParam) {
            return [];
        }
        var fileExtends;
        if (Array.isArray(eventParam) === false) {
            fileExtends = [eventParam];
        }
        else {
            fileExtends = eventParam.concat([]);
        }
        return fileExtends;
    };
    FileService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    FileService.ctorParameters = function () { return [
        { type: FrameContext },
        { type: AttachmentDataService },
        { type: EntityService },
        { type: SubListDataService },
        { type: FormNotifyService },
        { type: LanguageService },
        { type: ListDataService },
        { type: FormLoadingService, decorators: [{ type: Optional }] }
    ]; };
    return FileService;
}());
export { FileService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL2F0dGFjaG1lbnQvZmlsZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3JELE9BQU8sRUFBYyxRQUFRLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRXJELE9BQU8sRUFBRSxZQUFZLEVBQWtCLG9CQUFvQixFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDcEYsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFFM0QsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDbEUsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3JELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUN6RCxPQUFPLEVBQUUsZUFBZSxFQUFFLGtCQUFrQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDN0UsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sc0NBQXNDLENBQUM7QUFDMUUsT0FBTyxFQUFFLFlBQVksRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUVuRDs7Ozs7O0dBTUc7QUFDSDtJQUlFOztPQUVHO0lBQ0gscUJBQ1UsWUFBMEIsRUFDMUIsaUJBQXdDLEVBQ3hDLGFBQTRCLEVBQzVCLGtCQUFzQyxFQUN0QyxhQUFnQyxFQUNoQyxlQUFnQyxFQUNoQyxlQUFnQyxFQUNwQixrQkFBc0M7UUFSNUQsaUJBZUM7UUFkUyxpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQixzQkFBaUIsR0FBakIsaUJBQWlCLENBQXVCO1FBQ3hDLGtCQUFhLEdBQWIsYUFBYSxDQUFlO1FBQzVCLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FB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QUVILE9BQU8sZ0JBQWdCLENBQUMsRUFBRSxDQUFDO0lBQzdCLENBQUM7SUFFRCxhQUFhO0lBR2IsaUJBQWlCO0lBRWpCOzs7O09BSUc7SUFDSywrQ0FBeUIsR0FBakM7UUFFRSxJQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFtQixDQUFDO1FBQ3pELElBQU0sVUFBVSxHQUFHLGNBQWMsQ0FBQyxVQUFVLENBQUM7UUFDN0MsSUFBSSxDQUFDLFVBQVUsRUFBRTtZQUNmLE9BQU8sRUFBRSxDQUFDO1NBQ1g7UUFFRCxJQUFJLFdBQWtCLENBQUM7UUFDdkIsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxLQUFLLEtBQUssRUFBRTtZQUN2QyxXQUFXLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQztTQUM1QjthQUFNO1lBQ0wsV0FBVyxHQUFHLFVBQVUsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7U0FDckM7UUFFRCxPQUFPLFdBQWtDLENBQUM7SUFDNUMsQ0FBQzs7Z0JBNU5GLFVBQVU7Ozs7Z0JBakJGLFlBQVk7Z0JBR1oscUJBQXFCO2dCQUVyQixhQUFhO2dCQUNJLGtCQUFrQjtnQkFMbkMsaUJBQWlCO2dCQUdqQixlQUFlO2dCQUVmLGVBQWU7Z0JBQ2Ysa0JBQWtCLHVCQXlCdEIsUUFBUTs7SUErTWIsa0JBQUM7Q0FBQSxBQTlORCxJQThOQztBQUVELE9BQU8sRUFBRSxXQUFXLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIE9wdGlvbmFsIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IE9ic2VydmFibGUsIGZvcmtKb2luLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IEZVcGxvYWRGaWxlRXh0ZW5kIH0gZnJvbSAnQGZhcnJpcy9leHRlbmQtZmlsZS11cGxvYWQnO1xyXG5pbXBvcnQgeyBGcmFtZUNvbnRleHQsIENvbW1hbmRDb250ZXh0LCBCaW5kaW5nUGF0aENvbnZlcnRlciB9IGZyb20gJ0BmYXJyaXMvZGV2a2l0JztcclxuaW1wb3J0IHsgRm9ybU5vdGlmeVNlcnZpY2UgfSBmcm9tICcuLi9mb3JtLW5vdGlmeS5zZXJ2aWNlJztcclxuaW1wb3J0IHsgQXR0YWNobWVudEluZm8gfSBmcm9tICcuL3R5cGVzJztcclxuaW1wb3J0IHsgQXR0YWNobWVudERhdGFTZXJ2aWNlIH0gZnJvbSAnLi9hdHRhY2htZW50LWRhdGEuc2VydmljZSc7XHJcbmltcG9ydCB7IExhbmd1YWdlU2VydmljZSB9IGZyb20gJy4uL2xhbmd1YWcuc2VydmljZSc7XHJcbmltcG9ydCB7IEVudGl0eVNlcnZpY2UgfSBmcm9tICcuLi9lbnRpdHktc2VydmljZXMvaW5kZXgnO1xyXG5pbXBvcnQgeyBMaXN0RGF0YVNlcnZpY2UsIFN1Ykxpc3REYXRhU2VydmljZSB9IGZyb20gJy4uL2RhdGEtc2VydmljZXMvaW5kZXgnO1xyXG5pbXBvcnQgeyBGb3JtTG9hZGluZ1NlcnZpY2UgfSBmcm9tICcuLi9mb3JtLWxvYWRpbmcvZm9ybS1sb2FkaW5nLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBkZWJvdW5jZVRpbWUsIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuXHJcbi8qKlxyXG4gKiDpmYTku7bkuIrkvKBcclxuICogQHN1bW1hcnlcclxuICogZmlsZUV4dGVuZO+8muWRveWQjeaWh+S7tuS4iuS8oOaIlumihOiniOe7hOS7tuS8oOmAkui/h+adpeeahOaVsOaNru+8m1xyXG4gKiBmaWxlRXh0ZW5kRmllbGRQYXRo77ya5ZG95ZCN6ZmE5Lu2VURU55qE5a2X5q616Lev5b6E77ybXHJcbiAqIGF0dGFjaG1lbnRJbmZv77ya5ZG95ZCN6ZmE5Lu2VURU5omA6ZyA55qE5L+h5oGv77ybXHJcbiAqL1xyXG5ASW5qZWN0YWJsZSgpXHJcbmNsYXNzIEZpbGVTZXJ2aWNlIHtcclxuICBwcml2YXRlIHN1YmplY3Q6IFN1YmplY3Q8eyBmaWxlSW5mb0ZpZWxkUGF0aDogc3RyaW5nLCBjb25maWdzOiBzdHJpbmcgfT47XHJcbiAgcHJpdmF0ZSBhdHRhY2htZW50SW5mb3M6IEF0dGFjaG1lbnRJbmZvW107XHJcbiAgLyoqXHJcbiAgICog5p6E6YCg5Ye95pWwXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0LFxyXG4gICAgcHJpdmF0ZSBhdHRhY2hEYXRhU2VydmljZTogQXR0YWNobWVudERhdGFTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSBlbnRpdHlTZXJ2aWNlOiBFbnRpdHlTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSBzdWJMaXN0RGF0YVNlcnZpY2U6IFN1Ykxpc3REYXRhU2VydmljZSxcclxuICAgIHByaXZhdGUgbm90aWZ5U2VydmljZTogRm9ybU5vdGlmeVNlcnZpY2UsXHJcbiAgICBwcml2YXRlIGxhbmd1YWdlU2VydmljZTogTGFuZ3VhZ2VTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSBsaXN0RGF0YVNlcnZpY2U6IExpc3REYXRhU2VydmljZSxcclxuICAgIEBPcHRpb25hbCgpIHByaXZhdGUgZm9ybUxvYWRpbmdTZXJ2aWNlOiBGb3JtTG9hZGluZ1NlcnZpY2VcclxuICApIHtcclxuICAgIHRoaXMuc3ViamVjdCA9IG5ldyBTdWJqZWN0PHsgZmlsZUluZm9GaWVsZFBhdGg6IHN0cmluZywgY29uZmlnczogc3RyaW5nIH0+KCk7XHJcbiAgICB0aGlzLnN1YmplY3QucGlwZShkZWJvdW5jZVRpbWUoNTAwKSkuc3Vic2NyaWJlKChkYXRhOiB7IGZpbGVJbmZvRmllbGRQYXRoOiBzdHJpbmcsIGNvbmZpZ3M6IHN0cmluZyB9KSA9PiB7XHJcbiAgICAgIHRoaXMucHJvY2VzcyhkYXRhLmZpbGVJbmZvRmllbGRQYXRoLCBkYXRhLmNvbmZpZ3MpO1xyXG4gICAgfSk7XHJcbiAgICB0aGlzLmF0dGFjaG1lbnRJbmZvcyA9IFtdO1xyXG4gIH1cclxuXHJcbiAgLy8gI3JlZ2lvbiDkuIrkvKDmlofku7ZcclxuXHJcbiAgLyoqXHJcbiAgICog5om56YeP5re75Yqg6ZmE5Lu26KGMXHJcbiAgICovXHJcbiAgcHVibGljIGFkZEZpbGVSb3dzKGZpbGVJbmZvRmllbGRQYXRoOiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IGF0dGFjaG1lbnRJbmZvcyA9IHRoaXMuZ2V0QXR0YWNobWVudEluZm9zVG9BZGRGcm9tQ29udGV4dCgpO1xyXG4gICAgaWYgKGF0dGFjaG1lbnRJbmZvcy5sZW5ndGggPT09IDApIHtcclxuICAgICAgdGhpcy5ub3RpZnlTZXJ2aWNlLmluZm8oJ+ivt+WFiOS4iuS8oOmZhOS7ticpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHRoaXMuYXR0YWNoRGF0YVNlcnZpY2UudXBkYXRlUm93cyhmaWxlSW5mb0ZpZWxkUGF0aCwgYXR0YWNobWVudEluZm9zKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5om56YeP5re75Yqg5bim6ZmE5Lu257G75Z6L55qE6ZmE5Lu26KGMXHJcbiAgICogQHBhcmFtIGZpbGVJbmZvRmllbGRQYXRoIOmZhOS7tnVkdOWtl+autVxyXG4gICAqIEBwYXJhbSBjb25maWdzIOmZhOS7tuaJqeWxleS/oeaBr+mFjee9riBcclxuICAgKiBAZGVzY3JpcHRpb24gY29uZmlnc+mFjee9ruWmgntcImJpbGxJZFwiOlwie1VJU1RBVEV+L3Jvb3QvYmlsbElkfVwiLFwicm93SWRcIjpcIntVSVNUQVRFfi9yb290L3Jvd0lkfVwiLFwiYXR0YWNobWVudFR5cGVcIjpcInh1ZWxpXCJ9XHJcbiAgICovXHJcbiAgcHVibGljIGFkZEZpbGVSb3dzV2l0aENvbmZpZ3MoZmlsZUluZm9GaWVsZFBhdGg6IHN0cmluZywgY29uZmlnczogc3RyaW5nKSB7XHJcbiAgICBjb25zdCBhdHRhY2htZW50SW5mb3MgPSB0aGlzLmdldEF0dGFjaG1lbnRJbmZvc1RvQWRkRnJvbUNvbnRleHQoKTtcclxuICAgIGlmIChhdHRhY2htZW50SW5mb3MubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgIHRoaXMubm90aWZ5U2VydmljZS5pbmZvKCfor7flhYjkuIrkvKDpmYTku7YnKTtcclxuICAgIH1cclxuICAgIC8vIGxldCBtYXBGaWVsZHMgPSBudWxsO1xyXG4gICAgLy8gaWYgKHR5cGVvZiBjb25maWdzID09PSAnc3RyaW5nJykge1xyXG4gICAgLy8gICAvLyDljrvmjonpppblsL7nqbrmoLxcclxuICAgIC8vICAgY29uZmlncyA9IGNvbmZpZ3MudHJpbSgpO1xyXG4gICAgLy8gfVxyXG4gICAgLy8gaWYgKGNvbmZpZ3Muc3RhcnRzV2l0aCgneycpICYmIGNvbmZpZ3MuZW5kc1dpdGgoJ30nKSkge1xyXG4gICAgLy8gICB0cnkge1xyXG4gICAgLy8gICAgIG1hcEZpZWxkcyA9IEpTT04ucGFyc2UoY29uZmlncyk7XHJcbiAgICAvLyAgIH0gY2F0Y2gge1xyXG4gICAgLy8gICAgIHRocm93IG5ldyBFcnJvcign6ZmE5Lu25omp5bGV5L+h5oGv6YWN572u5LiN5piv5ZCI5rOV55qEanNvbuWtl+espuS4suOAgicpO1xyXG4gICAgLy8gICB9XHJcbiAgICAvLyB9IGVsc2Uge1xyXG4gICAgLy8gICB0aHJvdyBuZXcgRXJyb3IoJ+mZhOS7tuaJqeWxleS/oeaBr+mFjee9ruS4jeaYr+WQiOazleeahGpzb27lrZfnrKbkuLLjgIInKTtcclxuICAgIC8vIH1cclxuICAgIHRoaXMuYXR0YWNobWVudEluZm9zID0gdGhpcy5hdHRhY2htZW50SW5mb3MuY29uY2F0KGF0dGFjaG1lbnRJbmZvcyk7XHJcbiAgICB0aGlzLnN1YmplY3QubmV4dCh7IGZpbGVJbmZvRmllbGRQYXRoLCBjb25maWdzIH0pO1xyXG4gICAgLy9yZXR1cm4gdGhpcy5hdHRhY2hEYXRhU2VydmljZS51cGRhdGVSb3dzV2l0aENvbmZpZ3MoZmlsZUluZm9GaWVsZFBhdGgsIGF0dGFjaG1lbnRJbmZvcywgbWFwRmllbGRzKTtcclxuICB9XHJcbiAgcHJpdmF0ZSBwcm9jZXNzKGZpbGVJbmZvRmllbGRQYXRoOiBzdHJpbmcsIGNvbmZpZ3M6IHN0cmluZykge1xyXG4gICAgaWYgKHRoaXMuYXR0YWNobWVudEluZm9zICYmIHRoaXMuYXR0YWNobWVudEluZm9zLmxlbmd0aCA+IDApIHtcclxuICAgICAgY29uc3QgYXR0YWNobWVudEluZm9zID0gdGhpcy5hdHRhY2htZW50SW5mb3MuY29uY2F0KFtdKTtcclxuICAgICAgbGV0IG1hcEZpZWxkcyA9IG51bGw7XHJcbiAgICAgIGlmICh0eXBlb2YgY29uZmlncyA9PT0gJ3N0cmluZycpIHtcclxuICAgICAgICAvLyDljrvmjonpppblsL7nqbrmoLxcclxuICAgICAgICBjb25maWdzID0gY29uZmlncy50cmltKCk7XHJcbiAgICAgIH1cclxuICAgICAgaWYgKGNvbmZpZ3Muc3RhcnRzV2l0aCgneycpICYmIGNvbmZpZ3MuZW5kc1dpdGgoJ30nKSkge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICBtYXBGaWVsZHMgPSBKU09OLnBhcnNlKGNvbmZpZ3MpO1xyXG4gICAgICAgIH0gY2F0Y2gge1xyXG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCfpmYTku7bmianlsZXkv6Hmga/phY3nva7kuI3mmK/lkIjms5XnmoRqc29u5a2X56ym5Liy44CCJyk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcign6ZmE5Lu25omp5bGV5L+h5oGv6YWN572u5LiN5piv5ZCI5rOV55qEanNvbuWtl+espuS4suOAgicpO1xyXG4gICAgICB9XHJcbiAgICAgIHRoaXMuYXR0YWNoRGF0YVNlcnZpY2UudXBkYXRlUm93c1dpdGhDb25maWdzKGZpbGVJbmZvRmllbGRQYXRoLCBhdHRhY2htZW50SW5mb3MsIG1hcEZpZWxkcykucGlwZShcclxuICAgICAgICB0YXAoKCkgPT4ge1xyXG4gICAgICAgICAgdGhpcy5hdHRhY2htZW50SW5mb3MgPSB0aGlzLmF0dGFjaG1lbnRJbmZvcy5maWx0ZXIoaXRlbSA9PiAhYXR0YWNobWVudEluZm9zLmZpbmQoYXR0YWNobWVudEluZm8gPT4gYXR0YWNobWVudEluZm8uYXR0YWNobWVudElkID09PSBpdGVtLmF0dGFjaG1lbnRJZCkpO1xyXG4gICAgICAgICAgaWYgKHRoaXMuYXR0YWNobWVudEluZm9zLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgdGhpcy5wcm9jZXNzKGZpbGVJbmZvRmllbGRQYXRoLCBjb25maWdzKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KVxyXG4gICAgICApLnN1YnNjcmliZSgpO1xyXG4gICAgfVxyXG5cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluimgea3u+WKoOeahOmZhOS7tuS/oeaBr+aVsOe7hFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0QXR0YWNobWVudEluZm9zVG9BZGRGcm9tQ29udGV4dCgpOiBBdHRhY2htZW50SW5mb1tdIHtcclxuICAgIGNvbnN0IGZpbGVFeHRlbmRzID0gdGhpcy5nZXRGaWxlRXh0ZW5kc0Zyb21Db250ZXh0KCk7XHJcbiAgICBjb25zdCBhdHRhY2htZW50SW5mb3MgPSB0aGlzLmNvbnZlcnRUb0F0dGFjaG1lbnRJbmZvcyhmaWxlRXh0ZW5kcyk7XHJcbiAgICByZXR1cm4gYXR0YWNobWVudEluZm9zO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5bCG6ZmE5Lu25LiK5Lyg57uE5Lu26L+U5Zue55qE6ZmE5Lu25L+h5oGv6L2s5o2i5Li65pyN5Yqh5Zmo56uv6ZyA6KaB55qE5qC85byPXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBjb252ZXJ0VG9BdHRhY2htZW50SW5mb3MoZmlsZUV4dGVuZHM6IEZVcGxvYWRGaWxlRXh0ZW5kW10pOiBBdHRhY2htZW50SW5mb1tdIHtcclxuICAgIGlmICghZmlsZUV4dGVuZHMpIHtcclxuICAgICAgcmV0dXJuIFtdO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGF0dGFjaG1lbnRJbmZvczogQXR0YWNobWVudEluZm9bXSA9IFtdO1xyXG4gICAgZmlsZUV4dGVuZHMuZm9yRWFjaCgoZlVwbG9hZE91dFB1dDogRlVwbG9hZEZpbGVFeHRlbmQpID0+IHtcclxuICAgICAgY29uc3QgYXR0YWNobWVudEluZm86IEF0dGFjaG1lbnRJbmZvID0ge1xyXG4gICAgICAgIGF0dGFjaG1lbnRJZDogZlVwbG9hZE91dFB1dC5leHRlbmQubWV0YWRhdGFJZCxcclxuICAgICAgICBmaWxlTmFtZTogZlVwbG9hZE91dFB1dC5leHRlbmQuZmlsZU5hbWUsXHJcbiAgICAgIH07XHJcbiAgICAgIGF0dGFjaG1lbnRJbmZvcy5wdXNoKGF0dGFjaG1lbnRJbmZvKTtcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIGF0dGFjaG1lbnRJbmZvcztcclxuICB9XHJcblxyXG4gIC8vICNlbmRyZWdpb25cclxuXHJcblxyXG4gIC8vICNyZWdpb24g5Yig6Zmk5paH5Lu2XHJcblxyXG4gIC8qKlxyXG4gICAqIOWIoOmZpOmZhOS7tuihjFxyXG4gICAqL1xyXG4gIHB1YmxpYyByZW1vdmVGaWxlUm93cyhmaWxlSW5mb0ZpZWxkUGF0aDogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIGNvbnN0IGRhdGFJZHMgPSB0aGlzLmdldERhdGFJZHNUb1JlbW92ZUZyb21Db250ZXh0KGZpbGVJbmZvRmllbGRQYXRoKTtcclxuICAgIGlmIChkYXRhSWRzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICB0aGlzLm5vdGlmeVNlcnZpY2UuaW5mbygn6K+36YCJ5oup6KaB5Yig6Zmk55qE6ZmE5Lu2Jyk7XHJcbiAgICB9XHJcbiAgICBjb25zdCBpc1N1Ymxpc3QgPSBmaWxlSW5mb0ZpZWxkUGF0aC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApLmxlbmd0aCA+PSAyO1xyXG4gICAgY29uc3QgcmVtb3ZlT2JzZXJ2YWJsZXM6IE9ic2VydmFibGU8YW55PltdID0gW107XHJcbiAgICBpZiAoaXNTdWJsaXN0KSB7XHJcbiAgICAgIGRhdGFJZHMuZm9yRWFjaCgoZGF0YUlkOiBzdHJpbmcpID0+IHtcclxuICAgICAgICBsZXQgcmVtb3ZlT2JzZXJ2YWJsZTtcclxuICAgICAgICByZW1vdmVPYnNlcnZhYmxlID0gdGhpcy5zdWJMaXN0RGF0YVNlcnZpY2UucmVtb3ZlV2l0aG91dENvbmZpcm0oZGF0YUlkKTtcclxuICAgICAgICByZW1vdmVPYnNlcnZhYmxlcy5wdXNoKHJlbW92ZU9ic2VydmFibGUpO1xyXG4gICAgICB9KTtcclxuICAgICAgcmV0dXJuIGZvcmtKb2luKHJlbW92ZU9ic2VydmFibGVzKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiB0aGlzLmxpc3REYXRhU2VydmljZS5yZW1vdmVSb3dzKGRhdGFJZHMsIGZhbHNlLCBudWxsLCBmYWxzZSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDojrflj5bopoHliKDpmaTnmoTmlbDmja5cclxuICAgKi9cclxuICBwcml2YXRlIGdldERhdGFJZHNUb1JlbW92ZUZyb21Db250ZXh0KGZpbGVFeHRlbmRGaWVsZFBhdGg6IHN0cmluZyk6IHN0cmluZ1tdIHtcclxuXHJcbiAgICAvLyDku47kuIrkuIvmlofkuK3ojrflj5bopoHlpITnkIbnmoTpmYTku7bkv6Hmga/mlbDnu4RcclxuICAgIGNvbnN0IGZpbGVFeHRlbmRzID0gdGhpcy5nZXRGaWxlRXh0ZW5kc0Zyb21Db250ZXh0KCk7XHJcblxyXG4gICAgLy8g5bCG6ZmE5Lu25pWw57uE6L2s5o2i5Li65a+55bqU55qE5pWw5o2uaWRcclxuICAgIGNvbnN0IGRhdGFJZHM6IHN0cmluZ1tdID0gW107XHJcbiAgICBmaWxlRXh0ZW5kcy5mb3JFYWNoKChmaWxlRXh0ZW5kOiBGVXBsb2FkRmlsZUV4dGVuZCkgPT4ge1xyXG5cclxuICAgICAgLy8g5LiK5Lyg5Yig6Zmk5ZKM6aKE6KeI5Yig6Zmk5Lyg6YCS6L+H5p2l55qEZmlsZUlk55qEa2V55Y+v6IO95LiN5LiA6Ie077yM6KaB5YGa5YW85a65XHJcbiAgICAgIGNvbnN0IGZpbGVJZCA9IGZpbGVFeHRlbmQuZXh0ZW5kLm1ldGFkYXRhSWQ7XHJcbiAgICAgIGNvbnN0IGRhdGFJZCA9IHRoaXMuY29udmVydEZpbGVJZFRvRGF0YUlkKGZpbGVJZCwgZmlsZUV4dGVuZEZpZWxkUGF0aCk7XHJcbiAgICAgIGRhdGFJZHMucHVzaChkYXRhSWQpO1xyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gZGF0YUlkcztcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOagueaNrui3r+W+hOiOt+WPlumZhOS7tuWtl+auteWAvOaVsOe7hFxyXG4gICAqIEBwYXJhbSBmaWVsZFBhdGgg5a2X5q616Lev5b6EXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBjb252ZXJ0RmlsZUlkVG9EYXRhSWQoZmlsZUlkOiBzdHJpbmcsIGZpbGVFeHRlbmRGaWVsZFBhdGg6IHN0cmluZyk6IHN0cmluZyB7XHJcblxyXG4gICAgLy8g6Kej5p6Q6Lev5b6EXHJcbiAgICBjb25zdCBmaWxlQmluZGluZ1BhdGggPSBCaW5kaW5nUGF0aENvbnZlcnRlci50b0JpbmRpbmdQYXRoQXJyYXkoZmlsZUV4dGVuZEZpZWxkUGF0aCk7XHJcbiAgICBjb25zdCBmaWxlRmllbGROYW1lID0gZmlsZUJpbmRpbmdQYXRoLnBvcCgpO1xyXG4gICAgY29uc3QgZmlsZUxpc3RCaW5kaW5nUGF0aCA9IGZpbGVCaW5kaW5nUGF0aDtcclxuXHJcbiAgICAvLyDojrflj5bpmYTku7ZpZOaVsOe7hFxyXG4gICAgY29uc3QgZW50aXR5TGlzdERhdGEgPSB0aGlzLmVudGl0eVNlcnZpY2UuZ2V0RW50aXR5TGlzdERhdGEoZmlsZUxpc3RCaW5kaW5nUGF0aCk7XHJcbiAgICBjb25zdCB0YXJnZXRFbnRpdHlEYXRhID0gZW50aXR5TGlzdERhdGEuZmluZCgoZW50aXR5RGF0YTogYW55KSA9PiB7XHJcbiAgICAgIGlmIChlbnRpdHlEYXRhW2ZpbGVGaWVsZE5hbWVdKSB7XHJcbiAgICAgICAgY29uc3QgYXR0YWNobWVudElkID0gZW50aXR5RGF0YVtmaWxlRmllbGROYW1lXVsnYXR0YWNobWVudElkJ107XHJcbiAgICAgICAgaWYgKGF0dGFjaG1lbnRJZCA9PT0gZmlsZUlkKSB7XHJcbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG5cclxuICAgIHJldHVybiB0YXJnZXRFbnRpdHlEYXRhLmlkO1xyXG4gIH1cclxuXHJcbiAgLy8gI2VuZHJlZ2lvblxyXG5cclxuXHJcbiAgLy8gI3JlZ2lvbiDlhbbku5blt6Xlhbfmlrnms5VcclxuXHJcbiAgLyoqXHJcbiAgICog5LuO5LiK5LiL5paH5Lit6I635Y+W6KaB5aSE55CG55qE6ZmE5Lu25L+h5oGv5pWw57uEXHJcbiAgICogQHN1bW1hcnlcclxuICAgKiDkuLrkuobnu5/kuIDljZXkuKrlkozlpJrkuKrpmYTku7bnmoTlpITnkIbmlrnlvI/vvIznu5/kuIDljIXoo4XkuLrmlbDnu4RcclxuICAgKi9cclxuICBwcml2YXRlIGdldEZpbGVFeHRlbmRzRnJvbUNvbnRleHQoKTogRlVwbG9hZEZpbGVFeHRlbmRbXSB7XHJcblxyXG4gICAgY29uc3QgY29tbWFuZENvbnRleHQgPSB0aGlzWydjb250ZXh0J10gYXMgQ29tbWFuZENvbnRleHQ7XHJcbiAgICBjb25zdCBldmVudFBhcmFtID0gY29tbWFuZENvbnRleHQuZXZlbnRQYXJhbTtcclxuICAgIGlmICghZXZlbnRQYXJhbSkge1xyXG4gICAgICByZXR1cm4gW107XHJcbiAgICB9XHJcblxyXG4gICAgbGV0IGZpbGVFeHRlbmRzOiBhbnlbXTtcclxuICAgIGlmIChBcnJheS5pc0FycmF5KGV2ZW50UGFyYW0pID09PSBmYWxzZSkge1xyXG4gICAgICBmaWxlRXh0ZW5kcyA9IFtldmVudFBhcmFtXTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGZpbGVFeHRlbmRzID0gZXZlbnRQYXJhbS5jb25jYXQoW10pO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBmaWxlRXh0ZW5kcyBhcyBGVXBsb2FkRmlsZUV4dGVuZFtdO1xyXG4gIH1cclxuICAvLyAjZW5kcmVnaW9uXHJcbn1cclxuXHJcbmV4cG9ydCB7IEZpbGVTZXJ2aWNlIH07XHJcbiJdfQ==