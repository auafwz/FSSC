/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { of } from 'rxjs';
import { switchMap } from 'rxjs/operators';
/**
 * 检查帮助输入框值变化后返回的查询结果
 * @param {?=} data
 * @return {?}
 */
function checkSearchResult(data = null) {
    if (this.searchOnServer) {
        // this._searchResult = data;
        // this.showDialog();
        this.isShow = true;
    }
    else {
        this.setModelValue(this.displayText);
        this.runDictPickedEvent(null);
    }
}
/**
 * @return {?}
 */
export function onTextChanged() {
    /** @type {?} */
    const self = this;
    /** @type {?} */
    const isPending = (/**
     * @return {?}
     */
    () => {
        return this.lookupUtils.rts.getFormState('lookup.pending');
    });
    /** @type {?} */
    const searchData = (/**
     * @param {?} e
     * @return {?}
     */
    (e) => {
        if (this.isTextChange && this.displayText && (!this.nosearch || e.originalEvent) && !isPending()) {
            this.lookupUtils.pendingStart();
            this.dictPickingSubscription = this.dictPicking({
                instance: this
            }).pipe(switchMap((/**
             * @param {?} pr
             * @return {?}
             */
            (pr) => {
                /** @type {?} */
                let o = true;
                if (pr === undefined || pr === null) {
                    o = true;
                }
                if (typeof pr === 'boolean') {
                    o = pr;
                }
                if (typeof pr === 'object') {
                    if (pr.showDialog === undefined) {
                        o = true;
                    }
                    else {
                        o = pr.showDialog;
                    }
                    if (pr.data) {
                        /** 保存帮助前传递的数据 */
                        this.customData = pr.data;
                    }
                }
                if (o) {
                    return this.httpMgr.getData({
                        search: {
                            field: '*',
                            value: this.displayText
                        }
                    }, 'search');
                }
                else {
                    return of({ SHOWDIALOG: o, MESSAGE: pr.message || '' });
                }
            }))).subscribe((/**
             * @param {?} data
             * @return {?}
             */
            (data) => {
                this.closeLoading();
                this.lookupUtils.pendingEnd();
                if (data.hasOwnProperty('SHOWDIALOG')) {
                    if (data.SHOWDIALOG && data.MESSAGE) {
                        this.notifyService.warning(data.MESSAGE);
                    }
                    return;
                }
                if (data.items && data.items.length === 1) {
                    /** @type {?} */
                    let rowdata = data.items[0];
                    if (this.isTree()) {
                        /** @type {?} */
                        const leafNode = this.treeNodeHelper.getLeafNode(rowdata);
                        if (Array.isArray(leafNode)) {
                            checkSearchResult.bind(self, data)();
                            return;
                        }
                        else {
                            rowdata = leafNode.data;
                        }
                    }
                    if (!this.singleSelect) {
                        rowdata = [rowdata];
                    }
                    this.selectItem(rowdata);
                }
                else {
                    checkSearchResult.bind(self, data)();
                }
            }), (/**
             * @param {?} err
             * @return {?}
             */
            (err) => {
                this.closeLoading();
                this.lookupUtils.pendingEnd();
                this.messagerService.error(err ? err.Message : err);
            }));
        }
    });
    /** @type {?} */
    let inputBlurHandler = null;
    if (this.inputGroup && this.inputGroup.textbox && !this.nosearch) {
        this.lookupUtils.setActiveLookupInstance(this);
        inputBlurHandler = this.render2.listen(this.inputGroup.textbox.nativeElement, 'blur', searchData);
    }
    if (this.inputGroup) {
        this.inputGroup.enterHandle.subscribe(searchData);
        this.inputGroup.keydownHandle.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        (e) => {
            /** @type {?} */
            let canOpen = false;
            if (e.code === 'ArrowRight') {
                if (this.editable) {
                    canOpen = !e.target.value || e.target.selectionStart === e.target.value.length;
                }
                else {
                    canOpen = true;
                }
            }
            else {
                canOpen = e.code === this.shortcutKey.open;
            }
            if (canOpen) {
                e.stopPropagation();
                e.preventDefault();
                this.showDialog();
            }
        }));
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib24tdGV4dC1jaGFuZ2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL3VpLWxvb2t1cC8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy9vbi10ZXh0LWNoYW5nZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFTLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNqQyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7Ozs7OztBQU0zQyxTQUFTLGlCQUFpQixDQUFDLElBQUksR0FBRyxJQUFJO0lBQ2xDLElBQUksSUFBSSxDQUFDLGNBQWMsRUFBRTtRQUNyQiw2QkFBNkI7UUFDN0IscUJBQXFCO1FBQ3JCLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDO0tBQ3RCO1NBQU07UUFDSCxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUNyQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLENBQUM7S0FDakM7QUFDTCxDQUFDOzs7O0FBRUQsTUFBTSxVQUFVLGFBQWE7O1VBRW5CLElBQUksR0FBRyxJQUFJOztVQUVYLFNBQVM7OztJQUFHLEdBQUcsRUFBRTtRQUNuQixPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO0lBQy9ELENBQUMsQ0FBQTs7VUFFSyxVQUFVOzs7O0lBQUcsQ0FBQyxDQUFDLEVBQUUsRUFBRTtRQUNyQixJQUFJLElBQUksQ0FBQyxZQUFZLElBQUksSUFBSSxDQUFDLFdBQVcsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsSUFBSSxDQUFDLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsRUFBRTtZQUM5RixJQUFJLENBQUMsV0FBVyxDQUFDLFlBQVksRUFBRSxDQUFDO1lBRWhDLElBQUksQ0FBQyx1QkFBdUIsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFD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QUFDLElBQUksS0FBSyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQzthQUM5QztZQUNELElBQUksT0FBTyxFQUFFO2dCQUNULENBQUMsQ0FBQyxlQUFlLEVBQUUsQ0FBQztnQkFDcEIsQ0FBQyxDQUFDLGNBQWMsRUFBRSxDQUFDO2dCQUNuQixJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7YUFDckI7UUFDTCxDQUFDLEVBQUMsQ0FBQztLQUNOO0FBRUwsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEVNUFRZLCBvZiB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBzd2l0Y2hNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IExvb2t1cEdyaWRSZXN1bHQsIFBpY2tpbmdSZXN1bHQgfSBmcm9tICcuLi9sb29rdXAtZ3JpZC1vcHRpb25zJztcclxuXHJcblxyXG5cclxuIC8qKiDmo4Dmn6XluK7liqnovpPlhaXmoYblgLzlj5jljJblkI7ov5Tlm57nmoTmn6Xor6Lnu5PmnpwgKi9cclxuZnVuY3Rpb24gY2hlY2tTZWFyY2hSZXN1bHQoZGF0YSA9IG51bGwpIHtcclxuICAgIGlmICh0aGlzLnNlYXJjaE9uU2VydmVyKSB7XHJcbiAgICAgICAgLy8gdGhpcy5fc2VhcmNoUmVzdWx0ID0gZGF0YTtcclxuICAgICAgICAvLyB0aGlzLnNob3dEaWFsb2coKTtcclxuICAgICAgICB0aGlzLmlzU2hvdyA9IHRydWU7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAgIHRoaXMuc2V0TW9kZWxWYWx1ZSh0aGlzLmRpc3BsYXlUZXh0KTtcclxuICAgICAgICB0aGlzLnJ1bkRpY3RQaWNrZWRFdmVudChudWxsKTtcclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIG9uVGV4dENoYW5nZWQoKSB7XHJcblxyXG4gICAgY29uc3Qgc2VsZiA9IHRoaXM7XHJcblxyXG4gICAgY29uc3QgaXNQZW5kaW5nID0gKCkgPT4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmxvb2t1cFV0aWxzLnJ0cy5nZXRGb3JtU3RhdGUoJ2xvb2t1cC5wZW5kaW5nJyk7XHJcbiAgICB9O1xyXG5cclxuICAgIGNvbnN0IHNlYXJjaERhdGEgPSAoZSkgPT4ge1xyXG4gICAgICAgIGlmICh0aGlzLmlzVGV4dENoYW5nZSAmJiB0aGlzLmRpc3BsYXlUZXh0ICYmICghdGhpcy5ub3NlYXJjaCB8fCBlLm9yaWdpbmFsRXZlbnQpICYmICFpc1BlbmRpbmcoKSkge1xyXG4gICAgICAgICAgICB0aGlzLmxvb2t1cFV0aWxzLnBlbmRpbmdTdGFydCgpO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5kaWN0UGlja2luZ1N1YnNjcmlwdGlvbiA9IHRoaXMuZGljdFBpY2tpbmcoe1xyXG4gICAgICAgICAgICAgICAgaW5zdGFuY2U6IHRoaXNcclxuICAgICAgICAgICAgfSkucGlwZShcclxuICAgICAgICAgICAgICAgIHN3aXRjaE1hcCgocHI6IFBpY2tpbmdSZXN1bHQpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgbyA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHByID09PSB1bmRlZmluZWQgfHwgcHIgPT09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbyA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHByID09PSAnYm9vbGVhbicpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbyA9IHByO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBwciA9PT0gJ29iamVjdCcpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHByLnNob3dEaWFsb2cgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbyA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvID0gcHIuc2hvd0RpYWxvZztcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHByLmRhdGEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8qKiDkv53lrZjluK7liqnliY3kvKDpgJLnmoTmlbDmja4gKi9cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY3VzdG9tRGF0YSA9IHByLmRhdGE7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChvKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmh0dHBNZ3IuZ2V0RGF0YShcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWFyY2g6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmllbGQ6ICcqJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHRoaXMuZGlzcGxheVRleHRcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3NlYXJjaCdcclxuICAgICAgICAgICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gb2YoeyBTSE9XRElBTE9HOiBvLCBNRVNTQUdFOiAgcHIubWVzc2FnZSB8fCAnJyB9KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICApLnN1YnNjcmliZShcclxuICAgICAgICAgICAgICAgIChkYXRhOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmNsb3NlTG9hZGluZygpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMubG9va3VwVXRpbHMucGVuZGluZ0VuZCgpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChkYXRhLmhhc093blByb3BlcnR5KCdTSE9XRElBTE9HJykpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGEuU0hPV0RJQUxPRyAmJiBkYXRhLk1FU1NBR0UpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubm90aWZ5U2VydmljZS53YXJuaW5nKGRhdGEuTUVTU0FHRSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChkYXRhLml0ZW1zICYmIGRhdGEuaXRlbXMubGVuZ3RoID09PSAxKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCByb3dkYXRhID0gZGF0YS5pdGVtc1swXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuaXNUcmVlKCkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGxlYWZOb2RlID0gdGhpcy50cmVlTm9kZUhlbHBlci5nZXRMZWFmTm9kZShyb3dkYXRhKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGxlYWZOb2RlKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoZWNrU2VhcmNoUmVzdWx0LmJpbmQoc2VsZiwgZGF0YSkoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJvd2RhdGEgPSBsZWFmTm9kZS5kYXRhO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5zaW5nbGVTZWxlY3QpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJvd2RhdGEgPSBbIHJvd2RhdGEgXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdEl0ZW0ocm93ZGF0YSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2hlY2tTZWFyY2hSZXN1bHQuYmluZChzZWxmLCBkYXRhKSgpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0sIChlcnI6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY2xvc2VMb2FkaW5nKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb29rdXBVdGlscy5wZW5kaW5nRW5kKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNzYWdlclNlcnZpY2UuZXJyb3IoZXJyID8gZXJyLk1lc3NhZ2UgOiBlcnIpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcblxyXG4gICAgbGV0IGlucHV0Qmx1ckhhbmRsZXIgPSBudWxsO1xyXG5cclxuICAgIGlmICh0aGlzLmlucHV0R3JvdXAgJiYgdGhpcy5pbnB1dEdyb3VwLnRleHRib3ggJiYgIXRoaXMubm9zZWFyY2gpIHtcclxuICAgICAgICB0aGlzLmxvb2t1cFV0aWxzLnNldEFjdGl2ZUxvb2t1cEluc3RhbmNlKHRoaXMpO1xyXG4gICAgICAgIGlucHV0Qmx1ckhhbmRsZXIgPSB0aGlzLnJlbmRlcjIubGlzdGVuKHRoaXMuaW5wdXRHcm91cC50ZXh0Ym94Lm5hdGl2ZUVsZW1lbnQsICdibHVyJywgc2VhcmNoRGF0YSApO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICh0aGlzLmlucHV0R3JvdXApIHtcclxuICAgICAgICB0aGlzLmlucHV0R3JvdXAuZW50ZXJIYW5kbGUuc3Vic2NyaWJlKCBzZWFyY2hEYXRhKTtcclxuXHJcbiAgICAgICAgdGhpcy5pbnB1dEdyb3VwLmtleWRvd25IYW5kbGUuc3Vic2NyaWJlKChlOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgbGV0IGNhbk9wZW4gPSBmYWxzZTtcclxuICAgICAgICAgICAgaWYgKGUuY29kZSA9PT0gJ0Fycm93UmlnaHQnKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5lZGl0YWJsZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNhbk9wZW4gPSAhZS50YXJnZXQudmFsdWUgfHwgZS50YXJnZXQuc2VsZWN0aW9uU3RhcnQgPT09IGUudGFyZ2V0LnZhbHVlLmxlbmd0aDtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FuT3BlbiA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBjYW5PcGVuID0gZS5jb2RlID09PSB0aGlzLnNob3J0Y3V0S2V5Lm9wZW47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGNhbk9wZW4pIHtcclxuICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XHJcbiAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNob3dEaWFsb2coKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxufVxyXG4iXX0=