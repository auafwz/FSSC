import * as tslib_1 from "tslib";
import { Injectable } from "@angular/core";
import { Expression } from "../expression/index";
import { EventHandler } from "./event_handler";
var BindingDataLoadEventHandler = /** @class */ (function (_super) {
    tslib_1.__extends(BindingDataLoadEventHandler, _super);
    function BindingDataLoadEventHandler() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    BindingDataLoadEventHandler.prototype.filter = function (event) {
        var _this = this;
        // 过滤第一次空load
        if ((!event.path || event.path.length === 0) && event.value && Array.isArray(event.value) && event.value.length === 0) {
            return null;
        }
        // 数据加载完成后需要计算当前绑定路径下的只读、必填、校验表达式
        if (this.expressionObjects && this.expressionObjects.length > 0) {
            var expressions = this.expressionObjects.filter(function (expressionObject) {
                if (expressionObject.ns !== event.ns || (expressionObject.type !== Expression.ExpressionType.Readonly && expressionObject.type !== Expression.ExpressionType.Visible && expressionObject.type !== Expression.ExpressionType.Required && expressionObject.type !== Expression.ExpressionType.Validate)) {
                    return false;
                }
                var result = _this.analysis(event, expressionObject);
                if (!result) {
                    return false;
                }
                return (result.distance === 0 && result.isSameTable) || (result.eventFromParent && event.path.length === 2); // 当前表或从从表
            });
            return expressions;
        }
        else {
            return null;
        }
    };
    /**
     * 发布事件
     * @param event event
     */
    BindingDataLoadEventHandler.prototype.dispatch = function (event) {
        var _this = this;
        var expressions = this.filter(event);
        if (expressions && expressions.length > 0) {
            expressions.forEach(function (expressionObject) {
                var entityContext = _this.buildEntityContext(event, expressionObject);
                var context = _this.buildContext(expressionObject, event, entityContext);
                var result = _this.perform(expressionObject, context);
                if (result === undefined && !_this.isValidateOrRequiredExpression(expressionObject)) {
                    return;
                }
                expressionObject.result = _this.convertBooleanTypeExpressionResult(expressionObject, result);
                ;
                if (expressionObject.id) {
                    _this.expressionResult.set(expressionObject.id, expressionObject.result);
                }
                _this.effect(event, expressionObject);
            });
        }
    };
    /**
     * 获取子表事件行
     * @param paths
     * @param event
     * @returns
     */
    BindingDataLoadEventHandler.prototype.getCurrentRowByEvent = function (paths, event) {
        return this.getCurrentRowByPaths(paths);
    };
    BindingDataLoadEventHandler.decorators = [
        { type: Injectable }
    ];
    return BindingDataLoadEventHandler;
}(EventHandler));
export { BindingDataLoadEventHandler };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmluZGluZ19kYXRhX2xvYWRfZXZlbnRfaGFuZGxlci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL2V2ZW50LWhhbmRsZXIvYmluZGluZ19kYXRhX2xvYWRfZXZlbnRfaGFuZGxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDakQsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBRS9DO0lBQ2lELHVEQUFZO0lBRDdEOztJQXVEQSxDQUFDO0lBckRRLDRDQUFNLEdBQWIsVUFBYyxLQUEyQjtRQUF6QyxpQkFxQkM7UUFwQkMsYUFBYTtRQUNiLElBQUksQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFJLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLEtBQUssQ0FBQyxDQUFDLElBQUksS0FBSyxDQUFDLEtBQUssSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsSUFBSSxLQUFLLENBQUMsS0FBSyxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7WUFDckgsT0FBTyxJQUFJLENBQUM7U0FDYjtRQUNELGlDQUFpQztRQUNqQyxJQUFJLElBQUksQ0FBQyxpQkFBaUIsSUFBSSxJQUFJLENBQUMsaUJBQWlCLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUMvRCxJQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsTUFBTSxDQUFDLFVBQUMsZ0JBQTZDO2dCQUM5RixJQUFJLGdCQUFnQixDQUFDLEVBQUUsS0FBSyxLQUFLLENBQUMsRUFBRSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxLQUFLLFVBQVUsQ0FBQyxjQUFjLENBQUMsUUFBUSxJQUFJLGdCQUFnQixDQUFDLElBQUksS0FBSyxVQUFVLENBQUMsY0FBYyxDQUFDLE9BQU8sSUFBSSxnQkFBZ0IsQ0FBQyxJQUFJLEtBQUssVUFBVSxDQUFDLGNBQWMsQ0FBQyxRQUFRLElBQUksZ0JBQWdCLENBQUMsSUFBSSxLQUFLLFVBQVUsQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDLEVBQUU7b0JBQ3JTLE9BQU8sS0FBSyxDQUFDO2lCQUNkO2dCQUNELElBQU0sTUFBTSxHQUFHLEtBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxFQUFFLGdCQUFnQixDQUFDLENBQUM7Z0JBQ3RELElBQUksQ0FBQyxNQUFNLEVBQUU7b0JBQ1gsT0FBTyxLQUFLLENBQUM7aUJBQ2Q7Z0JBQ0QsT0FBTyxDQUFDLE1BQU0sQ0FBQyxRQUFRLEtBQUssQ0FBQyxJQUFJLE1BQU0sQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxlQUFlLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxVQUFVO1lBQ3pILENBQUMsQ0FBQyxDQUFDO1lBQ0gsT0FBTyxXQUFXLENBQUM7U0FDcEI7YUFBTTtZQUNMLE9BQU8sSUFBSSxDQUFDO1NBQ2I7SUFDSCxDQUFDO0lBQ0Q7OztPQUdHO0lBQ0ksOENBQVEsR0FBZixVQUFnQixLQUEyQjtRQUEzQyxpQkFpQkM7UUFoQkMsSUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUN2QyxJQUFJLFdBQVcsSUFBSSxXQUFXLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUN6QyxXQUFXLENBQUMsT0FBTyxDQUFDLFVBQUMsZ0JBQTZDO2dCQUNoRSxJQUFNLGFBQWEsR0FBRyxLQUFJLENBQUMsa0JBQWtCLENBQUMsS0FBSyxFQUFFLGdCQUFnQixDQUFDLENBQUM7Z0JBQ3ZFLElBQU0sT0FBTyxHQUFHLEtBQUksQ0FBQyxZQUFZLENBQUMsZ0JBQWdCLEVBQUUsS0FBSyxFQUFFLGFBQWEsQ0FBQyxDQUFDO2dCQUMxRSxJQUFNLE1BQU0sR0FBRyxLQUFJLENBQUMsT0FBTyxDQUFDLGdCQUFnQixFQUFFLE9BQU8sQ0FBQyxDQUFDO2dCQUN2RCxJQUFJLE1BQU0sS0FBSyxTQUFTLElBQUksQ0FBQyxLQUFJLENBQUMsOEJBQThCLENBQUMsZ0JBQWdCLENBQUMsRUFBRTtvQkFDbEYsT0FBTztpQkFDUjtnQkFDRCxnQkFBZ0IsQ0FBQyxNQUFNLEdBQUcsS0FBSSxDQUFDLGtDQUFrQyxDQUFDLGdCQUFnQixFQUFFLE1BQU0sQ0FBQyxDQUFDO2dCQUFBLENBQUM7Z0JBQzdGLElBQUksZ0JBQWdCLENBQUMsRUFBRSxFQUFFO29CQUN2QixLQUFJLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLGdCQUFnQixDQUFDLEVBQUUsRUFBRSxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsQ0FBQztpQkFDekU7Z0JBQ0QsS0FBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQztZQUN2QyxDQUFDLENBQUMsQ0FBQztTQUNKO0lBQ0gsQ0FBQztJQUNEOzs7OztPQUtHO0lBQ0ksMERBQW9CLEdBQTNCLFVBQTRCLEtBQWUsRUFBRSxLQUEyQjtRQUN0RSxPQUFPLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUMxQyxDQUFDOztnQkF0REYsVUFBVTs7SUF1RFgsa0NBQUM7Q0FBQSxBQXZERCxDQUNpRCxZQUFZLEdBc0Q1RDtTQXREWSwyQkFBMkIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcclxuaW1wb3J0IHsgRXhwcmVzc2lvbiB9IGZyb20gXCIuLi9leHByZXNzaW9uL2luZGV4XCI7XHJcbmltcG9ydCB7IEV2ZW50SGFuZGxlciB9IGZyb20gXCIuL2V2ZW50X2hhbmRsZXJcIjtcclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIEJpbmRpbmdEYXRhTG9hZEV2ZW50SGFuZGxlciBleHRlbmRzIEV2ZW50SGFuZGxlciB7XHJcbiAgcHVibGljIGZpbHRlcihldmVudDogRXhwcmVzc2lvbi5FdmVudEFyZ3MpIHtcclxuICAgIC8vIOi/h+a7pOesrOS4gOasoeepumxvYWRcclxuICAgIGlmICgoIWV2ZW50LnBhdGggfHwgZXZlbnQucGF0aC5sZW5ndGggPT09IDApICYmIGV2ZW50LnZhbHVlICYmIEFycmF5LmlzQXJyYXkoZXZlbnQudmFsdWUpICYmIGV2ZW50LnZhbHVlLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuICAgIC8vIOaVsOaNruWKoOi9veWujOaIkOWQjumcgOimgeiuoeeul+W9k+WJjee7keWumui3r+W+hOS4i+eahOWPquivu+OAgeW/heWhq+OAgeagoemqjOihqOi+vuW8j1xyXG4gICAgaWYgKHRoaXMuZXhwcmVzc2lvbk9iamVjdHMgJiYgdGhpcy5leHByZXNzaW9uT2JqZWN0cy5sZW5ndGggPiAwKSB7XHJcbiAgICAgIGNvbnN0IGV4cHJlc3Npb25zID0gdGhpcy5leHByZXNzaW9uT2JqZWN0cy5maWx0ZXIoKGV4cHJlc3Npb25PYmplY3Q6IEV4cHJlc3Npb24uRXhwcmVzc2lvbk9iamVjdCkgPT4ge1xyXG4gICAgICAgIGlmIChleHByZXNzaW9uT2JqZWN0Lm5zICE9PSBldmVudC5ucyB8fCAoZXhwcmVzc2lvbk9iamVjdC50eXBlICE9PSBFeHByZXNzaW9uLkV4cHJlc3Npb25UeXBlLlJlYWRvbmx5ICYmIGV4cHJlc3Npb25PYmplY3QudHlwZSAhPT0gRXhwcmVzc2lvbi5FeHByZXNzaW9uVHlwZS5WaXNpYmxlICYmIGV4cHJlc3Npb25PYmplY3QudHlwZSAhPT0gRXhwcmVzc2lvbi5FeHByZXNzaW9uVHlwZS5SZXF1aXJlZCAmJiBleHByZXNzaW9uT2JqZWN0LnR5cGUgIT09IEV4cHJlc3Npb24uRXhwcmVzc2lvblR5cGUuVmFsaWRhdGUpKSB7XHJcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMuYW5hbHlzaXMoZXZlbnQsIGV4cHJlc3Npb25PYmplY3QpO1xyXG4gICAgICAgIGlmICghcmVzdWx0KSB7XHJcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiAocmVzdWx0LmRpc3RhbmNlID09PSAwICYmIHJlc3VsdC5pc1NhbWVUYWJsZSkgfHwgKHJlc3VsdC5ldmVudEZyb21QYXJlbnQgJiYgZXZlbnQucGF0aC5sZW5ndGggPT09IDIpOyAvLyDlvZPliY3ooajmiJbku47ku47ooahcclxuICAgICAgfSk7XHJcbiAgICAgIHJldHVybiBleHByZXNzaW9ucztcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gIH1cclxuICAvKipcclxuICAgKiDlj5HluIPkuovku7ZcclxuICAgKiBAcGFyYW0gZXZlbnQgZXZlbnRcclxuICAgKi9cclxuICBwdWJsaWMgZGlzcGF0Y2goZXZlbnQ6IEV4cHJlc3Npb24uRXZlbnRBcmdzKSB7XHJcbiAgICBjb25zdCBleHByZXNzaW9ucyA9IHRoaXMuZmlsdGVyKGV2ZW50KTtcclxuICAgIGlmIChleHByZXNzaW9ucyAmJiBleHByZXNzaW9ucy5sZW5ndGggPiAwKSB7XHJcbiAgICAgIGV4cHJlc3Npb25zLmZvckVhY2goKGV4cHJlc3Npb25PYmplY3Q6IEV4cHJlc3Npb24uRXhwcmVzc2lvbk9iamVjdCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGVudGl0eUNvbnRleHQgPSB0aGlzLmJ1aWxkRW50aXR5Q29udGV4dChldmVudCwgZXhwcmVzc2lvbk9iamVjdCk7XHJcbiAgICAgICAgY29uc3QgY29udGV4dCA9IHRoaXMuYnVpbGRDb250ZXh0KGV4cHJlc3Npb25PYmplY3QsIGV2ZW50LCBlbnRpdHlDb250ZXh0KTtcclxuICAgICAgICBjb25zdCByZXN1bHQgPSB0aGlzLnBlcmZvcm0oZXhwcmVzc2lvbk9iamVjdCwgY29udGV4dCk7XHJcbiAgICAgICAgaWYgKHJlc3VsdCA9PT0gdW5kZWZpbmVkICYmICF0aGlzLmlzVmFsaWRhdGVPclJlcXVpcmVkRXhwcmVzc2lvbihleHByZXNzaW9uT2JqZWN0KSkge1xyXG4gICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBleHByZXNzaW9uT2JqZWN0LnJlc3VsdCA9IHRoaXMuY29udmVydEJvb2xlYW5UeXBlRXhwcmVzc2lvblJlc3VsdChleHByZXNzaW9uT2JqZWN0LCByZXN1bHQpOztcclxuICAgICAgICBpZiAoZXhwcmVzc2lvbk9iamVjdC5pZCkge1xyXG4gICAgICAgICAgdGhpcy5leHByZXNzaW9uUmVzdWx0LnNldChleHByZXNzaW9uT2JqZWN0LmlkLCBleHByZXNzaW9uT2JqZWN0LnJlc3VsdCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuZWZmZWN0KGV2ZW50LCBleHByZXNzaW9uT2JqZWN0KTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluWtkOihqOS6i+S7tuihjFxyXG4gICAqIEBwYXJhbSBwYXRocyBcclxuICAgKiBAcGFyYW0gZXZlbnQgXHJcbiAgICogQHJldHVybnMgXHJcbiAgICovXHJcbiAgcHVibGljIGdldEN1cnJlbnRSb3dCeUV2ZW50KHBhdGhzOiBzdHJpbmdbXSwgZXZlbnQ6IEV4cHJlc3Npb24uRXZlbnRBcmdzKTogbnVsbCB8IHsgW3Byb3A6IHN0cmluZ106IGFueSB9IHtcclxuICAgIHJldHVybiB0aGlzLmdldEN1cnJlbnRSb3dCeVBhdGhzKHBhdGhzKTtcclxuICB9XHJcbn0iXX0=