!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("date-fns"),require("moment"),require("immutable"),require("@angular/forms"),require("validator"),require("@angular/common/http"),require("@angular/router"),require("@farris/expression-engine"),require("bignumber.js"),require("rxjs/operators"),require("rxjs"),require("@angular/core")):"function"==typeof define&&define.amd?define("@farris/devkit",["exports","date-fns","moment","immutable","@angular/forms","validator","@angular/common/http","@angular/router","@farris/expression-engine","bignumber.js","rxjs/operators","rxjs","@angular/core"],e):e((t.farris=t.farris||{},t.farris.devkit={}),t.dateFns,t.moment,t.immutable,t.ng.forms,t.ValidatorJS,t.ng.common.http,t.ng.router,t.expressionEngine,t.bignumber_js,t.rxjs.operators,t.rxjs,t.ng.core)}(this,function(x,i,o,e,a,t,s,p,u,y,l,h,d){"use strict";o=o&&o.hasOwnProperty("default")?o["default"]:o;var n="default"in t?t["default"]:t,r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function c(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}var E=function(){return(E=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)};function f(t,e,n,r){var i,o=arguments.length,a=o<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;0<=s;s--)(i=t[s])&&(a=(o<3?i(a):3<o?i(e,n,a):i(e,n))||a);return 3<o&&a&&Object.defineProperty(e,n,a),a}function g(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)}function v(r,i){var o,a,s,t,p={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return t={next:e(0),"throw":e(1),"return":e(2)},"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(e){return function(t){return function n(t){if(o)throw new TypeError("Generator is already executing.");for(;p;)try{if(o=1,a&&(s=2&t[0]?a["return"]:t[0]?a["throw"]||((s=a["return"])&&s.call(a),0):a.next)&&!(s=s.call(a,t[1])).done)return s;switch(a=0,s&&(t=[2&t[0],s.value]),t[0]){case 0:case 1:s=t;break;case 4:return p.label++,{value:t[1],done:!1};case 5:p.label++,a=t[1],t=[0];continue;case 7:t=p.ops.pop(),p.trys.pop();continue;default:if(!(s=0<(s=p.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){p=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){p.label=t[1];break}if(6===t[0]&&p.label<s[1]){p.label=s[1],s=t;break}if(s&&p.label<s[2]){p.label=s[2],p.ops.push(t);break}s[2]&&p.ops.pop(),p.trys.pop();continue}t=i.call(r,p)}catch(e){t=[6,e],a=0}finally{o=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([e,t])}}}function P(t){var e="function"==typeof Symbol&&Symbol.iterator,n=e&&t[e],r=0;if(n)return n.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&r>=t.length&&(t=void 0),{value:t&&t[r++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function m(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var r,i,o=n.call(t),a=[];try{for(;(void 0===e||0<e--)&&!(r=o.next()).done;)a.push(r.value)}catch(s){i={error:s}}finally{try{r&&!r.done&&(n=o["return"])&&n.call(o)}finally{if(i)throw i.error}}return a}function b(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(m(arguments[e]));return t}var C="__annotations__",I="__parameters__",T="__prop__metadata__";function M(t,e,n,i,o){var a=j(e);function s(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(this instanceof s)return a.call.apply(a,b([this],e)),this;var n=new(s.bind.apply(s,b([void 0],e))),r=function(t){return o&&o.apply(void 0,b([t],e)),(t.hasOwnProperty(C)?t[C]:Object.defineProperty(t,C,{value:[]})[C]).push(n),t};return i&&i(r),r}return n&&(s.prototype=Object.create(n.prototype)),s.prototype.ngMetadataName=t,s.annotationCls=s}function j(i){return function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];if(i){var n=i.apply(void 0,b(t));for(var r in n)this[r]=n[r]}}}function w(t,e,n){var r=j(e);function o(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];if(this instanceof o)return r.apply(this,t),this;var i=new(o.bind.apply(o,b([void 0],t)));return function(t,e){var n=t.constructor,r=n.hasOwnProperty(T)?n[T]:Object.defineProperty(n,T,{value:{}})[T];r[e]=r.hasOwnProperty(e)&&r[e]||[],r[e].unshift(i)}}return n&&(o.prototype=Object.create(n.prototype)),o.prototype.ngMetadataName=t,o.annotationCls=o}var O=(S.getClassMetadatas=function(t){return t[C]},S.getClassMetadataByName=function(t,e){return this.getClassMetadataByNameWithTranslate(t,e,null,null)},S.getClassMetadataByNameWithTranslate=function(t,e,n,r){var i=this.getClassMetadatas(t);if(!i)return null;var o=i.find(function(t){return t.ngMetadataName===e});return this.translateMetadataByName(o,n,r),o},S.getPropsMetadatas=function(t){return t[T]},S.getPropsMetadatasByName=function(t,e){return this.getPropsMetadatasByNameWithTranslate(t,e)},S.getPropsMetadatasByNameWithTranslate=function(t,n,e,r){var i={},o=this.getPropsMetadatas(t);return o&&(Object.keys(o).forEach(function(t){var e=o[t].find(function(t){return t.ngMetadataName===n});e&&(i[t]=e)}),this.translateMetadatasByName(i,e,r)),i},S.translateMetadatasByName=function(e,n,r){var i=this;return Object.keys(e).forEach(function(t){i.translateMetadataByName(e[t],n,r)}),e},S.translateMetadataByName=function(r,i,t){return r&&i&&t&&t.forEach(function(t){var e=r[t];if(e&&e.startsWith("{{")&&e.endsWith("}}")){var n=e.replace("{{","").replace("}}","").trim();r[t]=i.transform(n,null)}}),r},S.getPropMetadatasByName=function(t,e){return null},S.getPropMetadataByName=function(t,e,n){return null},S);function S(){}var N,D=function rp(t,e,n,r,i){this.type=e,this.value=t,this.preValue=r,this.path=n,this.position=i};function V(t,e){return JSON.stringify(t)===JSON.stringify(e)}(N=x.ModifyType||(x.ModifyType={})).Add="ADD",N.AddData="AddData",N.Clone="CLONE",N.Remove="REMOVE",N.RemoveData="RemoveData",N.ValueChange="VALUE_CHANGE",N.Load="LOAD",N.UnChanged="UNCHANGED",N.PaginationInfoChange="PAGINATION_INFO_CHANGE",N.Insert="Insert",N.Update="UPDATE";var F=(Object.defineProperty(R.prototype,"changes",{get:function(){return this.modifications},enumerable:!0,configurable:!0}),R.prototype.append=function(t){switch(t.type){case x.ModifyType.ValueChange:this.appendValueChangeModification(t);break;case x.ModifyType.Add:case x.ModifyType.Insert:case x.ModifyType.Clone:this.appendAddModification(t);break;case x.ModifyType.Remove:this.appendRemoveModification(t);break;case x.ModifyType.Load:}},R.prototype.appendValueChangeModification=function(t){var e=t.value,n=this.findModifyItemsPath(t.path);if(n)n.value=e;else{var r=this.findNewAddItemsPath(t.path);r?r.value=Object.assign({},r.value,e):this.modifications.push(t)}},R.prototype.appendAddModification=function(t){var e=t.value,n=this.findNewAddItemsPath(t.path);n?n.value=n.value.concat(e):this.modifications.push(t)},R.prototype.appendRemoveModification=function(t){var e=t.path,n=Object.keys(t.value)[0],r=t.value[n];this.modifications.forEach(function(t){t.type!==x.ModifyType.Add&&t.type!==x.ModifyType.Insert&&t.type!==x.ModifyType.Clone||!1!==V(t.path,e)&&(t.value=t.value.filter(function(t){return t[n]!==r}))});var i=e.concat(n+":"+r);this.modifications=this.modifications.filter(function(t){if(t.type!==x.ModifyType.ValueChange)return!0;var e=Array.from(t.path);return e.pop(),!V(e,i)}),this.removeDescendantRemoveModifications(t),this.modifications.push(t)},R.prototype.clear=function(){this.modifications=[]},R.prototype.findNewAddItemsPath=function(n){return this.modifications.find(function(t,e){return V(n,t.path)&&(t.type===x.ModifyType.Add||t.type===x.ModifyType.Insert||t.type===x.ModifyType.Clone)})},R.prototype.findModifyItemsPath=function(n){return this.modifications.find(function(t,e){return V(n,t.path)&&t.type===x.ModifyType.ValueChange})},R.prototype.removeDescendantRemoveModifications=function(t){var n=this,r=this.createRemovePathWithId(t);this.modifications=this.modifications.filter(function(t){if(t.type!==x.ModifyType.Remove)return!0;var e=n.createRemovePathWithId(t);return!n.isDescendantPath(r,e)})},R.prototype.createRemovePathWithId=function(t){var e=t.path,n=Object.keys(t.value)[0],r=t.value[n];return e.concat([n+":"+r])},R.prototype.isDescendantPath=function(t,n){if(t.length>n.length)return!1;var r=!0;return t.forEach(function(t,e){t===n[e]||(r=!1)}),r},R);function R(){this.modifications=[]}function B(t){if("object"==typeof t&&null!==t&&"[object Object]"===Object.prototype.toString.call({})){if(null===Object.getPrototypeOf(t))return 1;for(var e=t;null!==Object.getPrototypeOf(e);)e=Object.getPrototypeOf(e);return Object.getPrototypeOf(t)===e}}var _="NgField";var A=w(_,function ip(t){var e={primary:!1,foreign:!1};if(t)switch(typeof t){case"boolean":e.primary=Boolean(t);break;case"string":e.dataField=String(t);break;case"object":e=Object.assign(e,t)}return e}),L="NgList";var k=w(L,function op(t){if(B(t))return t;var e=typeof t;return"string"==e?{dataField:t}:"function"==e?{type:t}:void 0}),$="NgObject";var U=w($,function ap(t){if(B(t))return t;var e=typeof t;return"string"==e?{dataField:t}:"function"==e?{type:t}:void 0}),H="NgDynamic";var K,G=w(H,function sp(t){if(B(t))return t;var e=typeof t;return"string"==e?{dataField:t}:"function"==e?{type:t}:void 0}),z="NgEntity";(K=x.CacheReturnType||(x.CacheReturnType={}))[K.Static=1]="Static",K[K.Promise=2]="Promise";var q=(J.prototype.compare=function(t,e){return t===e},J);function J(){}var W=(Y.prototype.isExpired=function(){return"number"==typeof this.ttl?Date.now().valueOf()>this.createAt.valueOf()+this.ttl:Date.now()>this.ttl.valueOf()},Y);function Y(t,e,n){this.key=t,this.content=e,this.ttl=n,this.createAt=new Date}function Z(h){return function(t,c,e){e===undefined&&(e=Object.getOwnPropertyDescriptor(t,c));var l=t.name||t&&t.constructor&&t.constructor.name,f=e.value;return e.value=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=h&&h.ttl||0,r=h&&h.provider;if(!r)throw new Error("cache provider is not defined.");var i=h&&h.key||undefined;i&&i instanceof Function&&(i=i(this,t));var o=i;if(!o){var a=JSON.stringify(t);o=l+"#"+String(c)+"#"+a}var s=r.get(o);if(!s||n&&!0===s.isExpired()){var p=f.apply(this,t),u=new W(o,p,n);return r.set(u),p}return s&&s.content},e}}var X=(Q.prototype.get=function(t){var e=this.provider.get(t);return!e||this.isCacheObjectExpired(e)?undefined:e.content},Q.prototype.set=function(t,e,n){var r=new W(t,e,n||0);this.provider.set(r)},Q.prototype.isCacheObjectExpired=function(t){return"number"==typeof t.ttl?Date.now().valueOf()>t.createAt.valueOf()+t.ttl:Date.now()>t.ttl.valueOf()},Q);function Q(t){this.provider=t,this.provider=t}var tt=(et.prototype.has=function(e){var n=this;return!(this.store.length<1)&&-1!==this.store.findIndex(function(t){return t&&n.cacheKeyCompare.compare(e,t.key)})},et.prototype.length=function(){return this.store.length},et.prototype.set=function(t){this.store.push(t)},et.prototype.get=function(e){var n=this;return this.store.length<1?undefined:this.store.find(function(t){return n.cacheKeyCompare.compare(e,t.key)})},et.prototype["delete"]=function(e){var n=this;if(!(this.store.length<1)){var t=this.store.findIndex(function(t){return t&&n.cacheKeyCompare.compare(e,t.key)});this.store.splice(t,1)}},et.prototype.clear=function(){this.store.length=0},et.prototype.keys=function(){return this.store.keys()},et.prototype.values=function(){return this.store.values()},et);function et(t){this.store=new Array,this.cacheKeyCompare=t||new q}var nt=(rt.prototype.has=function(t){return this.buffer.has(t)},rt.prototype.length=function(){return this.buffer.size},rt.prototype.set=function(t){this.buffer.set(t.key,t)},rt.prototype.get=function(t){return this.buffer.get(t)},rt.prototype["delete"]=function(t){this.buffer["delete"](t)},rt.prototype.clear=function(){this.buffer.clear()},rt.prototype.keys=function(){return this.buffer.keys()},rt.prototype.values=function(){return this.buffer.values()},rt);function rt(){this.buffer=new Map}var it=(ot.getNgFields=function(t){return O.getPropsMetadatasByName(t,_)},ot.getNgField=function(t,e){return this.getNgFields(t)[e]},ot.getDataField=function(t,e){return this.getNgField(t,e).dataField||e},ot.getNgObjects=function(t){return O.getPropsMetadatasByName(t,$)},ot.getNgDynamic=function(t){return O.getPropsMetadatasByName(t,H)},ot.getNgList=function(t){return O.getPropsMetadatasByName(t,L)},ot.getPrimaryFieldMetadata=function(t){var e=ot.getNgFields(t),n=Object.keys(e).find(function(t){return e[t].primary});if(n){var r=e[n];return r.property=n,r.dataField||(r.dataField=n),r}return undefined},ot.getPrimaryKey=function(t){var e=this.getPrimaryFieldMetadata(t);return e?e.property:""},ot.getValidationMetadata=function(n){var r=ot.getNgFields(n),i={};return Object.keys(r).forEach(function(e){if(!r[e].primary&&!r[e].foreign){var t=r[e].validRules;t&&t.length&&(t.map(function(t){t.property=e,t.targetName=n.name}),i[e]=t)}}),i},ot.getValidationMetadataWithPath=function(t){var i=t.constructor,o=ot.getNgFields(i),a=t.getPaths().path||[],s={};return Object.keys(o).forEach(function(e){if(!o[e].primary&&!o[e].foreign){var t=o[e].validRules;if(t&&t.length){var n=a.concat([]);n.push(e);var r=n.join(".");t.map(function(t){t.property=e,t.targetName=i.name,t.path=r}),s[e]=t}}}),s},f([Z({key:function(t,e){return e[0]},provider:new nt}),g("design:type",Function),g("design:paramtypes",[Object]),g("design:returntype",Object)],ot,"getNgFields",null),f([Z({key:function(t,e){return e[0]},provider:new nt}),g("design:type",Function),g("design:paramtypes",[Object]),g("design:returntype",Object)],ot,"getNgObjects",null),f([Z({key:function(t,e){return e[0]},provider:new nt}),g("design:type",Function),g("design:paramtypes",[Object]),g("design:returntype",Object)],ot,"getNgList",null),f([Z({key:function(t,e){return e[0]},provider:new nt}),g("design:type",Function),g("design:paramtypes",[Object]),g("design:returntype",Object)],ot,"getPrimaryFieldMetadata",null),f([Z({key:function(t,e){return e[0]},provider:new nt}),g("design:type",Function),g("design:paramtypes",[Object]),g("design:returntype",void 0)],ot,"getPrimaryKey",null),f([Z({key:function(t,e){return e[0]},provider:new nt}),g("design:type",Function),g("design:paramtypes",[Object]),g("design:returntype",Object)],ot,"getValidationMetadata",null),f([Z({key:function(t,e){return e[0]},provider:new nt}),g("design:type",Function),g("design:paramtypes",[Object]),g("design:returntype",Object)],ot,"getValidationMetadataWithPath",null),ot);function ot(){}var at=(st.getAllNgProperties=function(t){var e=this.getNgFieldProperties(t),n=this.getNgObjectProperties(t),r=this.getNgDynamicProperties(t),i=this.getNgObjectProperties(t);return Object.assign({},e,n,r,i)},st.getNgEntityMatadata=function(t){return O.getClassMetadataByNameWithTranslate(t,z)},st.getNgFieldProperties=function(t){return O.getPropsMetadatasByName(t,_)},st.getNgObjectProperties=function(t){return O.getPropsMetadatasByName(t,$)},st.getNgDynamicProperties=function(t){return O.getPropsMetadatasByName(t,H)},st.getNgListProperties=function(t){return O.getPropsMetadatasByName(t,L)},st.getPrimaryKeyProperty=function(t){var n,r=st.getNgFieldProperties(t);return Object.keys(r).forEach(function(t){var e=r[t];!0===e.primary&&(n=e)}),n},st);function st(){}var pt="__PARENT_PATH__",ut="__PARENT__";function ct(t,e){return lt.create(t,e)}var lt=(ft.create=function(t,e){var n=new(this.getType(t))(e);return n.constructor=t,n},ft.createType=function(t){var e,n=(c(r,e=zn),r);function r(t){return e.call(this,t)||this}var i=n.prototype;return this.extendProperties(t,i),n},ft.extendProperties=function(t,e){var n=it.getNgFields(t),r=it.getNgObjects(t),i=it.getNgList(t),o=it.getNgDynamic(t);this.extendPlainProperty(e,n),this.extendListProperty(e,i),this.extendObjectProperty(e,r),this.extendDynamicProperty(e,o)},ft.extendPlainProperty=function(t,e){Object.keys(e).forEach(function(r){var i=e[r];Object.defineProperty(t,r,{get:function(){return this.getPropValue(r,i)},set:function(t){var e=this.getPropValue(r,i);if(!1!==this.isPropValueChanged(r,i,t,e)){this.setPropValue(r,i,t);var n=this.preparePropValue(r,i,t);this.emitValueChange(r,i,t,e,n)}}})})},ft.extendListProperty=function(t,u){Object.keys(u).forEach(function(s){var p="__"+s+"__";Object.defineProperty(t,s,{get:function(){var e=this,n=this[p];if(!n){var r=u[s],t=this.createPath(s),i=r.dataField||s,o=this.data[i];if((n=new St)[ut]=this,n[pt]=t,o){var a=o.map(function(t){return ct(r.type,t)});n.loadEntities(a)}n.onListChanged.subscribe(function(t){t&&(n[pt][0]!==t.path[0]&&(t.path=n[pt].concat(t.path)),e.setChanges(t))}),this[p]=n}return n},set:function(t){this[p]=t}})})},ft.extendObjectProperty=function(t,e){Object.keys(e).forEach(function(i){var o=e[i],a="__"+i+"__";Object.defineProperty(t,i,{get:function(){var t=this[a],e=this.createPath(i);if(!t){var n=o.dataField||i,r=this.data[n]||{};t=ft.buildEntity(e,r,this,o),this[a]=t}return t},set:function(t){var e=this.createPath(i),n={path:e,value:t.data,preValue:this[i].data,type:x.ModifyType.ValueChange},r=ft.buildEntity(e,t,this,o);this[a]=r,this.setChanges(n)}})})},ft.extendDynamicProperty=function(t,e){Object.keys(e).forEach(function(i){var o=e[i],a="__"+i+"__";Object.defineProperty(t,i,{get:function(){var t=this[a],e=this.createPath(i);if(!t){var n=o.dataField||i,r=this.data[n]||{};t=ft.buildDynamic(e,r,this,o),this[a]=t}return t},set:function(t){var e=this.createPath(i),n={path:e,value:t.data,preValue:this[i].data,type:x.ModifyType.ValueChange},r=ft.buildDynamic(e,t,this,o);this[a]=r,this.setChanges(n)}})})},ft.getType=function(t){if(this.buffer.has(t))return this.buffer.get(t);var e=this.createType(t);return this.buffer.set(t,e),e},ft.buildEntity=function(t,e,n,r){var i;return(i=e instanceof r.type?e:ct(r.type,e))[ut]=n,i[pt]=t,i.onValueChanged.subscribe(function(t){t&&(t.path=(n[pt]||[]).concat(t.path),n.setChanges(t))}),i},ft.buildDynamic=function(t,e,n,r){var i;return(i=e instanceof r.type?e:function o(t,e){return new t(e)}(r.type,e))[ut]=n,i[pt]=t,i.onValueChanged.subscribe(function(t){t&&(t.path=(n[pt]||[]).concat(t.path),n.setChanges(t))}),i},ft.buffer=new Map,ft);function ft(){}function ht(t,e){var n=lt.create(t,e);return n.constructor=t,n}function yt(n,t){var r=[];return t.forEach(function(t){var e=ht(n,t);r.push(e)}),r}function dt(t,e){return new t(e)}var gt={},vt=(mt.isValidType=function(t){var e=this;return"isValidType"!==t&&"getMessage"!==t&&-1!==Object.keys(this).map(function(t){return e[t]}).indexOf(t)},mt.getMessage=function(t){return(gt[this.CURRENT_LANGUAGE]||gt["zh-CHS"])[t]||""},mt.setCurrentLanguage=function(t){this.CURRENT_LANGUAGE=t},mt.CURRENT_LANGUAGE="zh-CNS",mt.CUSTOM_VALIDATION="customValidation",mt.REQUIRED="required",mt.EQUALS="equals",mt.NOT_EQUALS="notEquals",mt.IS_NUMBER="isNumber",mt.IS_INT="isInt",mt.IS_FLOAT="isFloat",mt.IS_STRING="isString",mt.IS_BOOLEAN="isBoolean",mt.IS_DATE="isDate",mt.IS_DATE_STRING="isDateString",mt.IS_BOOLEAN_STRING="isBooleanString",mt.IS_NUMBER_STRING="isNumberString",mt.IS_EMAIL="isEmail",mt.IS_JSON="isJSON",mt.IS_LOWERCASE="isLowercase",mt.IS_UPPERCASE="isUppercase",mt.RANGE="range",mt.MIN="min",mt.MINVALUE="minValue",mt.MAX="max",mt.MAXVALUE="maxValue",mt.LENGTH="length",mt.MAX_LENGTH="maxLength",mt.MIN_LENGTH="minLength",mt.MIN_DATE="minDate",mt.MAX_DATE="maxDate",mt.EXCLUDE="exclude",mt.MATCHES="matches",mt.FIELD_CONTAINER="fieldContainer",mt);function mt(){}gt["zh-CHS"]={fieldContainer:"$target 第 $value 行",required:"请输入'$property'",equals:"'$property'的值与$constraint1不相等",notEquals:"'$property'的值不能与'$constraint1'相同",isNumber:"'$property'的值不是数字",isInt:"'$property'的值不是整数",isFloat:"'$property'的值不是浮点型数字",isBoolean:"'$property'的值不是布尔值",isDate:"'$property'的值不是有效日期",isEmail:"邮箱地址不正确",min:"'$property'的值不应小于$constraint1",minValue:"'$property'的值不应小于$constraint1",minDate:"'$property'的日期不应早于$constraint1",max:"'$property'的值不应大于$constraint1",maxValue:"'$property'的值不应大于$constraint1",maxDate:"'$property'不应晚于$constraint1",isBooleanString:"'$property'的值不是有效布尔值",isDateString:"'$property'的值不是有效的日期",isLowercase:"'$property'的值应全部为小写字符串",isUppercase:"'$property'的值应全部为大写字符串",length:"'$property'的长度应介于$constraint1~$constraint2之间",range:"'$property'的值应介于$constraint1~$constraint2之间",maxLength:"'$property'的长度不得大于$constraint1",minLength:"'$property'的长度不得小于$constraint1",isNumberString:"'$property'的值不是数字",exclude:"'$property'的值不能包含：$constraint1",matches:"'$property'校验不通过"},gt.en={fieldContainer:"$target row $value",required:"Please input '$property'",equals:"'$property' should equals '$constraint1'",notEquals:"'$property' should not equals '$constraint1'",isNumber:"'$property' should be number",isInt:"'$property' should be integer",isFloat:"'$property' should be float",isBoolean:"'$property' should be boolean",isDate:"'$property' should be date",isEmail:"'$property' should be e-mail address",min:"'$property' should not less than $constraint1",minValue:"'$property' should not less than $constraint1",minDate:"'$property' should not early than $constraint1",max:"'$property' should not bigger than $constraint1",maxValue:"'$property' should not bigger than $constraint1",maxDate:"'$property' should not late than $constraint1",isBooleanString:"'$property' should be boolean string",isDateString:"'$property' should be date string",isLowercase:"'$property' should be lowercase charactor",isUppercase:"'$property' should be uppercase charactor",length:"'$property' length should between $constraint1~$constraint2之间",range:"'$property' value should between $constraint1~$constraint2之间",maxLength:"'$property' should not longer than $constraint1",minLength:"'$property' should not shorter than $constraint1",isNumberString:"'$property' should be number string",exclude:"'$property' should not include $constraint1",matches:"'$property' calibration failed"},gt["zh-CHT"]={fieldContainer:"$target 第 $value 行",required:"請輸入'$property'",equals:"'$property'的值與$constraint1不相等",notEquals:"'$property'的值不能與'$constraint1'相同",isNumber:"'$property'的值不是數字",isInt:"'$property'的值不是整數",isFloat:"'$property'的值不是浮點型數字",isBoolean:"'$property'的值不是佈爾值",isDate:"'$property'的值不是有效日期",isEmail:"郵箱地址不正確",min:"'$property'的值不應小於$constraint1",minValue:"'$property'的值不應小於$constraint1",minDate:"'$property'的日期不應早於$constraint1",max:"'$property'的值不應大於$constraint1",maxValue:"'$property'的值不應大於$constraint1",maxDate:"'$property'不應晚於$constraint1",isBooleanString:"'$property'的值不是有效佈爾值",isDateString:"'$property'的值不是有效的日期",isLowercase:"'$property'的值應全部爲小冩字符串",isUppercase:"'$property'的值應全部爲大冩字符串",length:"'$property'的長度應介於$constraint1~$constraint2之間",range:"'$property'的值應介於$constraint1~$constraint2之間",maxLength:"'$property'的長度不得大於$constraint1",minLength:"'$property'的長度不得小於$constraint1",isNumberString:"'$property'的值不是數字",exclude:"'$property'的值不能包含：$constraint1",matches:"'$property'校驗不通過"};var Et=function pp(){this.isArray=!1,this.index=undefined},bt=(Ct.replaceMessageSpecialTokens=function(t,e,n){var r;return t instanceof Function?r=t(e):"string"==typeof t&&(r=t),r&&e.constraints instanceof Array&&e.constraints.forEach(function(t,e){r=r.replace(new RegExp("\\$constraint"+(e+1),"g"),t)}),r&&n!==undefined&&null!==n&&(r=r.replace(/\$value/g,n)),r=(r=r&&r.replace(/\$property/g,e.property))&&r.replace(/\$target/g,e.targetName)},Ct.prototype.execute=function(h,y,d,e,g,t,v,a){var m=this;!t&&a&&(t=a.form.getValidationRules());var E=it.getValidationMetadataWithPath(h),s=new Map;if(t){for(var n=[],r=h;r&&r!==r.__PARENT__;){var i=r.__PARENT_PATH__?r.__PARENT_PATH__[1]:"";n.push(i),(r=r.__PARENT__)instanceof St&&(r=r.__PARENT__)}var p=n.reverse().join("/");t.forEach(function(e,t){if(t){var n=t.split("/"),r=n.pop(),i=n.join("/");if(p===i){if(E[r]=b(E[r]||[]),e.length){var o="";e.forEach(function(t){t.targetId&&t.targetId.length>o.length&&(o=t.targetId),E[r].push(t)}),E[r].forEach(function(t){t.targetId=o,t.targetName=e[0].targetName,t.property=e[0].property,e[0].frameContext&&(t.frameContext=e[0].frameContext),t.fullPath=e[0].fullPath,t.initialized=!0})}}else s.set(t,e)}})}E&&0<Object.keys(E).length&&Object.keys(E).forEach(function(t){var e=E[t];if(e&&0<e.length){var n=e[0].path;if(n){var r=n.split("."),i=m.getForm(r,a),o=m.getFormControl(r,a);o&&e.forEach(function(t){!0!==t.initialized&&(t.targetId=o.id,t.targetName=i&&i.formGroupName,t.property=o.name||o.defaultI18nValue||"")})}}}),e&&(E=Object.keys(E).filter(function(t){return t===e}).reduce(function(t,e){var n;return Object.assign({},t,((n={})[e]=E[e],n))},{})),Object.keys(E).filter(function(t){return h&&(h.hasOwnProperty(t)||h.constructor.prototype&&h.constructor.prototype.typeName&&h.constructor.prototype.hasOwnProperty(t)||h.__proto__.hasOwnProperty(t))}).forEach(function(t){var e=y;y===undefined&&(e=h[t]);var n=!1,r=m.getMultiLanguageFields(h);r&&0<r.length&&r.includes(t)&&(n=!0);var i=E[t];if(i.length){var o=i[0].property,a=i[0].targetId,s=i[0].frameContext,p=i[0].fullPath,u=Number.isInteger(g)?Ct.replaceMessageSpecialTokens(vt.getMessage(vt.FIELD_CONTAINER),i[0],g+1):i[0].targetName,c=u?u+" - "+o:""+o,l=i.path||t,f=m.generateValidationError(h,e,l,c,g,a,s,p);g!==undefined&&(f.index=g),d.push(f),m.defaultValidations(h,e,i,f,n,v)}}),this.objectValidations(h,d,e,g,s,v,a),this.listValidations(h,d,e,g,s,a)},Ct.prototype.getMultiLanguageFields=function(t){if(t&&t.constructor){var e=it.getNgFields(t.constructor);return Object.keys(e).filter(function(t){return e[t].enableMultiLangInput})}return null},Ct.prototype.stripEmptyErrors=function(t){var e=this;return t.filter(function(t){if(t.children&&(t.children=e.stripEmptyErrors(t.children)),0===Object.keys(t.constraints).length){if(0===t.children.length)return!1;delete t.constraints}return!0})},Ct.prototype.generateValidationError=function(t,e,n,r,i,o,a,s){var p=new Et;return p.target=t,p.value=e,p.property=n,p.propertyName=r,p.field=o,p.index=i,p.children=[],p.constraints={},a&&(p.frameContext=a),p.fullPath=s,p},Ct.prototype.defaultValidations=function(o,a,t,s,n,r){var p=this,u=s.constraints;return t.filter(function(i){var t=p.validator.validateValueByMetadata(o,a,i,n,r);if(t instanceof Promise){var e=t.then(function(t){if(!t){var e=p.createValidationError(o,a,i),n=e.type,r=e.messageString;u[n]=r,s.rule=i}});p.awaitingPromises.push(e)}return!t}).forEach(function(t){var e=p.createValidationError(o,a,t),n=e.type,r=e.messageString;u[n]=r,s.rule=t})},Ct.prototype.listValidations=function(i,o,e,a,s,p){var u=this,c="__ACTUAL_INDEX__",l=it.getNgList(i.constructor);if(l){var t=Object.keys(l);e&&(t=t.filter(function(t){return t===e})),t.forEach(function(t){l[t].type;var e=i[t];if(e){var n=i.getPaths().path||[];n.push(t);var r=u.generateValidationError(i,e.items,n.join("."),t,a);r.isArray=!0,o.push(r),e.items.forEach(function(t,e){var n=t[c]?t[c]:e;u.execute(t,undefined,r.children,undefined,n,s,t.primaryValue,p)})}})}},Ct.prototype.objectValidations=function(n,r,e,i,o,a,s){var p=this,u=it.getNgObjects(n.constructor);if(u&&!(Object.keys(u).length<1)){var t=Object.keys(u);e&&(t=t.filter(function(t){return t===e})),t.forEach(function(t){u[t].type;var e=n[t];e&&p.execute(e,undefined,r,undefined,i,o,a,s)})}},Ct.prototype.createValidationError=function(t,e,n){t.constructor?t.constructor.name:undefined;var r=n.type,i=n.message;if(i=i||vt.getMessage(r),vt.isValidType(r)&&(r===vt.MAXVALUE||r===vt.MINVALUE)&&this.isDateString(e)&&n.constraints&&n.constraints.length){var o=r===vt.MINVALUE?vt.MIN_DATE:vt.MAX_DATE;i=vt.getMessage(o)}return{type:r,messageString:Ct.replaceMessageSpecialTokens(i,n,e),metadata:n}},Ct.prototype.getFrameContext=function(t,e){if(!t||t.length<1||!e)return null;var n=t.concat([]);n.pop();var r=n.join("/");return e.appContext.frameContextManager.getFrameContexts().find(function(t){return t&&t.viewModel&&t.viewModel.bindingPath&&t.viewModel.bindingPath.split("/").filter(function(t){return t}).join("/")===r})||null},Ct.prototype.getForm=function(t,e){if(!t||t.length<1||!e)return null;var n=this.getFrameContext(t,e);return n&&n.form||null},Ct.prototype.getFormControl=function(t,e){if(!t||t.length<1||!e)return null;var n=t.concat([]).pop(),r=this.getFrameContext(t,e);return r&&r.form&&r.form.ngFormControls&&r.form.ngFormControls[n]||null},Ct.prototype.isDateString=function(t){return/\d{4}-(0[1-9]|1[0-2])-(0[1-9]|[1-2][0-9]|3[0-1])(T|\s?)?(([0-2]\d:[0-5]\d)?(:[0-5]\d(?:\.\d+)))?(?:Z|\+[0-2]\d(?:\:[0-5]\d)?)?/g.test(t)},Ct);function Ct(t){this.validator=t,this.awaitingPromises=[]}var xt=(Pt.createDetailedErrorMessage=function(t,o,a){return void 0===o&&(o=[]),void 0===a&&(a=""),t.forEach(function(e){var t=e.target?e.target.constructor.name:"",n=e.propertyName,r=function(t){return"   - 属性 "+a+t+" 验证失败的规则:  \n"+Object.keys(e.constraints).map(function(t){return"        #"+t+": "+e.constraints[t]+"\n"}).join("")};if(a){var i=Number.isInteger(+e.index)?"["+e.index+"]."+n:(a?".":"")+n;e.constraints&&o.push(r(i)),e.children.length&&Pt.createDetailedErrorMessage(e.children,o,a+i)}else o.push("类型为 "+t+" 的实例对象数据验证失败，详细信息：\n"),e.constraints&&o.push(r(n)),e.children.length&&Pt.createDetailedErrorMessage(e.children,o,n)}),o},Pt.convertErrorsToNormalObject=function(t,i){return t.forEach(function(t){var e,r,n=t.propertyName;t.isArray?i[n]=(e=t.children,r={},e.forEach(function(t){var e,n;t.children.length?r[t.index]=Pt.convertErrorsToNormalObject(t.children,t):r[t.index]?r[t.index]=Object.assign({},r[t.index],((e={})[t.propertyName]=t.constraints,e)):r[t.index]=((n={})[t.propertyName]=t.constraints,n)}),r):t.children.length?i[n]=Pt.convertErrorsToNormalObject(t.children,i):i[n]=t.constraints}),i},Pt);function Pt(){}var It=(Tt.formatISO=function(t){if(!0===this.isEmptyDateOrDateString(t))return this.emptyISODateTimeString;var e=this.parse(t);return i.format(e,this.defaultISOFormat)},Tt.format=function(t,e){if(!0===this.isEmptyDateOrDateString(t))return this.emptyISODateTimeString;var n=this.parse(t);return e=e||this.defaultDisplayFormat,i.format(n,e)},Tt.parse=function(t){return!0===this.isEmptyDateOrDateString(t)?null:!0===this.isDate(t)?t:i.parseISO(t)},Tt.isDate=function(t){return i.isDate(t)},Tt.isEmptyDateOrDateString=function(t){return!0===this.isDate(t)?this.isEmptyDate(t):this.isEmptyDateString(t)},Tt.isEmptyDate=function(t){return!t},Tt.isEmptyDateString=function(t){return!t||!0===t.startsWith("0001-01-01")},Tt.isEqual=function(t,e){var n=this.parse(t),r=this.parse(e);return n===r||i.isEqual(n,r)},Tt.compare=function(t,e){var n=this.parse(t),r=this.parse(e);return!0===this.isEqual(n,r)?0:n||!0!==this.isDate(r)?r||!0!==this.isDate(n)?i.compareAsc(n,r):1:-1},Tt.emptyDateTimeString=null,Tt.emptyISODateTimeString=null,Tt.defaultISOFormat="yyyy-MM-dd'T'HH:mm:ssxxx",Tt.defaultDisplayFormat="yyyy-MM-dd HH:mm:ss",Tt.defaultDateFormat="yyyy-MM-dd",Tt.defaultTimeFormat="HH:mm:ss",Tt);function Tt(){}var Mt=(jt.setTranslate=function(t){t&&(this.translate=t)},jt.getCurrentLanguage=function(){return this.translate&&this.translate.getCurrentLanguage()||this.defaultLanguage},jt.defaultLanguage="zh-CHS",jt.translate=null,jt);function jt(){}var wt=(Ot.prototype.validate=function(t,e,n,r,i,o){var a=this,s=[],p=new bt(this);return p.execute(t,n,s,e,i,r,null,o),Promise.all(p.awaitingPromises).then(function(){var t=p.stripEmptyErrors(s);return a.sortValidationErrors(t),a.buildErrors(t)})},Ot.prototype.sortValidationErrors=function(t){var e=this,n=!0;t.forEach(function(t){t.children&&1<t.children.length&&e.sortValidationErrors(t.children),"number"!=typeof t.index&&(n=!1)}),n&&t.sort(function(t,e){return t.index-e.index})},Ot.prototype.verify=function(t,e,n,r,i,o,a){var s=this;void 0===a&&(a=!1);var p=[],u=new bt(this);if(u.execute(t,n,p,e,i,r,null,o),u.awaitingPromises&&0<u.awaitingPromises.length&&!1===a)return Promise.all(u.awaitingPromises).then(function(){var t=u.stripEmptyErrors(p);return s.buildErrors(t)});var c=u.stripEmptyErrors(p);return this.buildErrors(c)},Ot.prototype.validateValueByMetadata=function(e,n,t,r,i){var o,a=t.type,s=[];if(t.constraints?s=t.constraints.map(function(t){return"function"==typeof t?t(e,n):t}):t.constraints=[],vt.isValidType(a)){if(a===vt.MAXVALUE){var p=s[0];return this.isDateString(n)||this.isDate(n)||this.isDateString(p)||this.isDate(p)?!n||-1!==n.indexOf("~")||this[vt.MAX_DATE](It.parse(n),r,new Date(s[0])):this[vt.MAXVALUE](n,r,s[0])}if(a!==vt.MINVALUE)return this[a].apply(this,b([n,r],s));if(null===s[0]||s[0]===undefined)return!0;if(this.isDateString(n)||this.isDate(n))return 0===s[0]||this[vt.MIN_DATE](It.parse(n),r,new Date(s[0]));if(this.isNumber(n))return this[vt.MIN](n,r,s[0])}else if("function"==typeof t.eval){var u=t.bindingPath.split("/").filter(function(t){return t}),c=t.field;0!==u.length&&(c=u.join("/")+"/"+c.split(".").filter(function(t){return t}).join("/"));var l={patch:((o={})[c]=n,o),currentRows:[]},f=e&&"function"==typeof e.getEntityListPath&&e.getEntityListPath();if(4===f.length){var h=f.slice(1,3).reverse();l.currentRows.push({bindingPath:h[1],primaryValue:h[0].split(":")[1]})}if(i){if(0!==t.bindingPath.split("/").filter(function(t){return t}).length){var y=e&&"function"==typeof e.getMainEntityPrimaryValue&&e.getMainEntityPrimaryValue();l.currentRows.push({bindingPath:"/",primaryValue:y})}l.currentRow={bindingPath:t.bindingPath,primaryValue:i}}else y=e&&"function"==typeof e.getMainEntityPrimaryValue&&e.getMainEntityPrimaryValue(),l.currentRows.push({bindingPath:"/",primaryValue:y});var d=t.eval(l);if("require"!==t.type)return d;var g=this.required(n,r);return!d||g}return!0},Ot.prototype.buildErrors=function(t){var e=new Set(xt.createDetailedErrorMessage(t)),n=[];return e.forEach(function(t){n.push(t)}),{isValid:0===t.length,errors:t,message:n.join("")}},Ot.prototype.customValidation=function(t,e){return e},Ot.prototype.isEmptyValue=function(t){return""===t||null===t||t===undefined||"0001-01-01"===t||"0001-01-01 00:00:00"===t||"0001-01-01T00:00:00"===t},Ot.prototype.required=function(t,e){if(e){var n=Mt.getCurrentLanguage();return!(Object.keys(t).length<1)&&(!n||!!t[n])}if("object"==typeof t&&null!==t){if(!Object.keys(t).length)return!1;t=Object.values(t)[0]}return""!==t&&null!==t&&t!==undefined&&"0001-01-01"!==t&&"0001-01-01 00:00:00"!==t&&"0001-01-01T00:00:00"!==t},Ot.prototype.equals=function(t,e){return t===e},Ot.prototype.notEquals=function(t,e){return t!==e},Ot.prototype.isNumber=function(t,e){return void 0===e&&(e={}),t===Infinity||t===-Infinity?e.allowInfinity:Number.isNaN(t)?e.allowNaN:Number.isFinite(t)},Ot.prototype.isInt=function(t){return Number.isInteger(t)},Ot.prototype.isFloat=function(t){return!(!this.isNumber(t)&&!this.isNumberString(t))&&this.validatorJs.isFloat(t)},Ot.prototype.isBoolean=function(t){return t instanceof Boolean||"boolean"==typeof t},Ot.prototype.isString=function(t){return t instanceof String||"string"==typeof t},Ot.prototype.isDate=function(t){return t instanceof Date&&!isNaN(t.getTime())},Ot.prototype.isDateString=function(t){return this.isString(t)&&/\d{4}-(0[1-9]|1[0-2])-(0[1-9]|[1-2][0-9]|3[0-1])(T|\s?)?(([0-2]\d:[0-5]\d)?(:[0-5]\d(?:\.\d+)))?(?:Z|\+[0-2]\d(?:\:[0-5]\d)?)?/g.test(t)&&this.validatorJs.toDate(t)},Ot.prototype.length=function(t,e,n,r){return"string"==typeof t&&this.validatorJs.isLength(t,e,n)},Ot.prototype.minLength=function(t,e,n){if(e){if("object"==typeof t){var r=Object.values(t).filter(function(t){return t&&t.length<n});if(r&&0<r.length)return!1}return!0}return t&&"string"!=typeof t&&(t=t.toString()),!t||"string"==typeof t&&this.length(t,n)},Ot.prototype.maxLength=function(t,e,n){if(e)return!("object"==typeof t&&0<Object.values(t).filter(function(t){return t&&t.length>n}).length);if("object"!=typeof t)return t&&"string"!=typeof t&&(t=t.toString()),!t||"string"==typeof t&&this.length(t,0,n);for(var r in t)if(t.hasOwnProperty(r)&&"string"==typeof t[r]&&!this.length(t[r],0,n))return!1;return!0},Ot.prototype.range=function(t,e,n,r){return"number"==typeof t&&this.isNumber(n)&&this.isNumber(r)&&n<=t&&t<=r},Ot.prototype.dateRange=function(t,e,n,r){if(!t)return!0;if("maxValue"===r||"maxDate"===r){if(this.isYearRange(t)||this.isMonthOrDayRange(t))return this.maxValue(parseInt(this.getRangeValue(t,1)),e,parseInt(n.split(" ")[0]));if(this.isDayTimeRange(t))return!0}else if("minValue"===r||"minDate"===r){if(this.isYearRange(t)||this.isMonthOrDayRange(t))return this.maxValue(parseInt(this.getRangeValue(t,0)),e,parseInt(n.split(" ")[0]));if(this.isDayTimeRange(t))return!0}return!1},Ot.prototype.getRangeValue=function(t,e,n){return void 0===n&&(n="~"),t.split(n)[e]},Ot.prototype.isDateRange=function(t){return"string"!=typeof t&&(t=t.toString()),/(\d{4}|\d{2})/.test(t)},Ot.prototype.isYearRange=function(t){return"string"!=typeof t&&(t=t.toString()),/^\d{4}~\d{4}$/.test(t)},Ot.prototype.isYearMonthRange=function(t){return"string"!=typeof t&&(t=t.toString()),/^\d{4}-\d{2}~\d{4}-\d{2}$/.test(t)},Ot.prototype.isMonthOrDayRange=function(t){return"string"!=typeof t&&(t=t.toString()),/^[0|1|2|3]\d{1}~[0|1|2|3]\d{1}$/.test(t)},Ot.prototype.isDayTimeRange=function(t){return"string"!=typeof t&&(t=t.toString()),/^[0|1|2|3]\d{1} \d{2}:\d{2}:\d{2}~[0|1|2|3]\d{1} \d{2}:\d{2}:\d{2}$/.test(t)},Ot.prototype.min=function(t,e,n){return"number"==typeof t&&"number"==typeof n&&n<=t},Ot.prototype.minValue=function(t,e,n){if(null===t||t===undefined)return!0;if("string"==typeof t&&t.match(/^(-?\d+)(\.\d+)?$/g)){var r=new y.BigNumber(t),i=new y.BigNumber(n);return r.isGreaterThanOrEqualTo(i)}return"number"==typeof t&&"number"==typeof n&&n<=t},Ot.prototype.max=function(t,e,n){return null===t||t===undefined||"number"==typeof t&&"number"==typeof n&&t<=n},Ot.prototype.maxValue=function(t,e,n){if(null===t||t===undefined)return!0;if("string"==typeof t&&t.match(/^(-?\d+)(\.\d+)?$/g)){var r=new y.BigNumber(t),i=new y.BigNumber(n);return r.isLessThanOrEqualTo(i)}return"number"==typeof t&&"number"==typeof n&&t<=n},Ot.prototype.minDate=function(t,e,n){return!t||t&&t.getTime()>=n.getTime()},Ot.prototype.maxDate=function(t,e,n){return null===t||t===undefined||t&&t.getTime()<=n.getTime()},Ot.prototype.isBooleanString=function(t){return"string"==typeof t&&this.validatorJs.isBoolean(t)},Ot.prototype.isNumberString=function(t){return"string"==typeof t&&this.validatorJs.isNumeric(t)},Ot.prototype.contains=function(t,e,n){return"string"==typeof t&&this.validatorJs.contains(t,n)},Ot.prototype.notContains=function(t,e,n){return"string"==typeof t&&!this.validatorJs.contains(t,n)},Ot.prototype.isEmail=function(t){return"string"==typeof t&&this.validatorJs.isEmail(t)},Ot.prototype.isJSON=function(t){return"string"==typeof t&&this.validatorJs.isJSON(t)},Ot.prototype.isLowercase=function(t){return"string"==typeof t&&this.validatorJs.isLowercase(t)},Ot.prototype.isUppercase=function(t){return"string"==typeof t&&this.validatorJs.isUppercase(t)},Ot.prototype.exclude=function(e,n,t){var r=this,i=t.split(""),o=0;return i.forEach(function(t){r.contains(e,n,t)&&o++}),0===o},Ot.prototype.matches=function(t,e,n){return""===(t=null===t||t===undefined?"":t.toString())||this.validatorJs.matches(t,n)},Ot);function Ot(){this.validatorJs=n}var St=(Object.defineProperty(Nt.prototype,"items",{get:function(){return this.rawData},enumerable:!0,configurable:!0}),Object.defineProperty(Nt.prototype,"changes",{get:function(){return this.changeSet.changes},enumerable:!0,configurable:!0}),Nt.prototype[Symbol.iterator]=function(){return v(this,function(t){switch(t.label){case 0:return[5,P(this.items)];case 1:return t.sent(),[2]}})},Nt.prototype.loadEntities=function(t){var e=this;this.clear(),t.forEach(function(t){e.initEntity(t)});var n={path:[],value:t,preValue:undefined,type:x.ModifyType.Load,target:this};this.setChanges(n)},Nt.prototype.clear=function(){this.rawData=[],this.originalData=[]},Nt.prototype.appendNew=function(t,e){void 0===e&&(e=!1);var n=this.initEntity(t,!0),r={path:[],value:[n],preValue:undefined,type:x.ModifyType.Add};return!0===e&&(r.type=x.ModifyType.Clone),this.setChanges(r),n},Nt.prototype.insert=function(t,e){var n=this.initEntity(t,!0),r={path:[],value:[n],preValue:undefined,type:x.ModifyType.Insert,position:e};return this.setChanges(r),n},Nt.prototype.appendEntity=function(t){var e={path:[],value:[this.initEntity(t,!0)],preValue:undefined,type:x.ModifyType.Add};this.setChanges(e)},Nt.prototype.appendEntities=function(t){var e=this,n={path:[],value:t.map(function(t){return e.initEntity(t,!0)}),preValue:undefined,type:x.ModifyType.Add};this.setChanges(n)},Nt.prototype.remove=function(e){var t,n=this.count(),r=this.rawData.findIndex(function(t){return t.primaryValue===e});if(-1===r)return!1;var i=this.rawData[r];this.rawData.splice(r,1);var o={path:[],value:((t={})[i.primaryProperty.dataField]=e,t),preValue:undefined,type:x.ModifyType.Remove};return this.updateIndex(n),this.setChanges(o),!0},Nt.prototype.get=function(e){return this.items.find(function(t){return t.primaryValue===e})},Nt.prototype.setChanges=function(t){this.listChanged.next(t);var e=Object.assign({},t);(t.type===x.ModifyType.Add||t.type===x.ModifyType.Insert||t.type===x.ModifyType.Clone)&&t.value[0]instanceof zn&&(e.value=[t.value[0].data]),this.changeSet.append(e)},Nt.prototype.count=function(){return this.items.length},Nt.prototype.indexOf=function(t){return this.items.indexOf(t)},Nt.prototype.sum=function(n){return 0===this.count()?0:this.items.reduce(function(t,e){return t+e[n]},0)},Nt.prototype.validate=function(){var t=this.getPropertyName();return h.from(this.validator.validate(this[ut],t))},Nt.prototype.toJson=function(){return this.rawData},Nt.prototype.toJSON=function(){var e=[];return this.items.forEach(function(t){e.push(t.toJSON())}),e},Nt.prototype.toArray=function(){return this.items},Nt.prototype.initEntity=function(t,e){var n=this;void 0===e&&(e=!1),t[ut]=this,t[pt]=this[pt],t.onValueChanged.subscribe(function(t){var e={path:t.path,value:t.value,preValue:t.preValue,type:t.type};t.changeSetValue!==undefined&&(e.changeSetValue=t.changeSetValue),n.setChanges(e)});var r=this.rawData.push(t);return this[r-1]=t,e||this.originalData.push(t.toJSON()),t},Nt.prototype.updateIndex=function(t){for(var n=this,e=0;e<t;e++)delete this[e];this.rawData.forEach(function(t,e){n[e]=t})},Nt.prototype.getPropertyName=function(){var t=this[pt];return t&&t.length?t[t.length-1]:undefined},Nt);function Nt(t,e){var n=this;this.__type__="EntityList",this.originalData=[],this.listChanged=new h.Subject,this.changeSet=new F,this.validator=new wt,this.onListChanged=this.listChanged.asObservable(),this.clear(),t&&t.forEach(function(t){n.initEntity(dt(e,t))})}var Dt,Vt,Ft,Rt="BigNumber";(Dt=x.DataChangeType||(x.DataChangeType={}))[Dt.Add=0]="Add",Dt[Dt.Delete=1]="Delete",(Vt=x.HttpMethod||(x.HttpMethod={})).GET="GET",Vt.POST="POST",Vt.PUT="PUT",Vt.DELETE="DELETE",function(t){var e;(e=t.Level||(t.Level={})).Error="Error",e.Info="Info",e.Warning="Warning";var n=function r(t,e){this.bizMessages=t,this.context=e};t.Message=n}(x.BackEndMessage||(x.BackEndMessage={})),(Ft=x.RunMode||(x.RunMode={})).compatible="compatible",Ft.highSpeed="highSpeed";var Bt=new d.InjectionToken("@farris/devkit_run_mode"),_t=(At.setUserSettings=function(t){this.userSettings=t,this.timeZone=undefined,this.timeZoneOffset=undefined},At.getTimeZone=function(){if(this.timeZone!==undefined)return this.timeZone;var t=this.userSettings&&this.userSettings.timeZone||null;return this.timeZone=t},At.getTimeZoneOffset=function(){if(this.timeZoneOffset!==undefined)return this.timeZoneOffset;var t=this.userSettings&&this.userSettings.timeZoneOffset||null;return this.timeZoneOffset=t},At.userSettings=null,At.timeZone=undefined,At.timeZoneOffset=undefined,At);function At(){}var Lt=(kt.zonedTimeToSpecialTimeZoneOffsetTimeString=function(t,e,n){void 0===e&&(e=0),void 0===n&&(n="YYYY-MM-DD HH:mm:ss.SSS");var r=60*e;return o(t).utc().add(r,"m").format(n)},kt.timeZoneOffsetTimeToUtcTimeString=function(t,e,n){return void 0===n&&(n="YYYY-MM-DD HH:mm:ss.SSS"),o(t).utcOffset(e,!0).toISOString()},kt);function kt(){}var $t,Ut,Ht,Kt=(Gt.prototype.getParams=function(t){return this.getAllParams()[t]||{}},Gt.prototype.setParams=function(t,e){var n=this.getAllParams();n[t]=e,this.setAllParams(n)},Gt.prototype.clearParams=function(){throw new Error("Not Implemented")},Gt.prototype.getAllParams=function(){var t=window.sessionStorage.getItem("ROUTER_PARAMS")||"{}";return JSON.parse(t)},Gt.prototype.setAllParams=function(t){t=t||{};var e=JSON.stringify(t);window.sessionStorage.setItem("ROUTER_PARAMS",e)},Gt.prototype.clearAllParams=function(){window.sessionStorage.setItem("ROUTER_PARAMS","{}")},Gt.decorators=[{type:d.Injectable}],Gt);function Gt(){}($t=x.ChangeType||(x.ChangeType={})).Update="Update",$t.Load="Load",$t.Append="Append",$t.Remove="Remove",$t.Swap="Swap",$t.SelectionChanged="SelectionChanged",$t.ValueChanged="ValueChanged",$t.UpdateErrors="UpdateErrors",$t.GlobalSelectionChanged="GlobalSelectionChanged",$t.PaginationInfoChange="PaginationInfoChange",(Ut=x.ViewChangeType||(x.ViewChangeType={}))[Ut.ValueChanged=0]="ValueChanged",(Ht=x.BindingPropertyType||(x.BindingPropertyType={})).Plain="Plain",Ht.Object="Object",Ht.List="List",Ht.Dynamic="Dynamic";var zt=(Object.defineProperty(qt.prototype,"primaryKeyValue",{get:function(){return this.primaryKey?this.getValue(this.primaryKey):""},enumerable:!0,configurable:!0}),qt.prototype.setShowValidationMsg=function(t){this.isShowValidationMsg=t},qt.prototype.getValue=function(t){return this.innerValues.get(t)},qt.prototype.setValue=function(r,i,o,t,a,s,p){var u=this;void 0===o&&(o=!1),void 0===t&&(t=!1);var c=this.getValue(r);if(!this.primaryKey||this.primaryKeyValue||this.primaryKey===r)if(s&&c!==i||(s=function(t,e,n,r){return h.of(!0)}),!0===t)s(c,i,!1,this.primaryKeyValue).subscribe(function(t){if(t){u.innerValues=u.innerValues.set(r,i);var e=u.buildViewChangesContext(r,i,c,a,p);if(u.viewChanges.next(e),!0===o){var n=u.buildChangesContext(r,i,p,a);u.changes.next(n)}s(c,i,!0,u.primaryKeyValue).subscribe()}else n=u.buildChangesContext(r,c,p,a),u.changes.next(n)});else{if(this.innerValues=this.innerValues.set(r,i),!0===o){var e=this.buildChangesContext(r,i,p,a);this.changes.next(e)}s(c,i,!0,this.primaryKeyValue).subscribe()}},qt.prototype.toJSON=function(a){var s=this,p=this.getCurrentLanguage(),u={};return this.properties.forEach(function(t){var e,n=t.name;if(t.type===x.BindingPropertyType.List){var r=s[n];u[n]=r.toJSON(a)}else if(t.type===x.BindingPropertyType.Object){var i=s[n];u[n]=i.toJSON(a)}else if(t.type===x.BindingPropertyType.Dynamic)i=s[n],u[n]=i.toJSON(a);else if(!0===t.enableMultiLangInput)if(a&&!0===a.ignoreMultiLangInput){var o=s.getValue(n);u[n]=o?o[p]:o}else a&&a.useFullMultiLangProperty?(o=s.getValue(n))&&(u[n+"_MULTILANGUAGE"]=o):(o=s.getValue(n),u[n]=o||((e={})[p]=o,e));else u[n]=s.getValue(n)}),u},qt.prototype.getCurrentLanguage=function(){return this.currentLanguage=this.currentLanguage||window.localStorage.getItem("languageCode")||"zh-CHS",this.currentLanguage},qt.prototype.buildChangesContext=function(t,e,n,r,i){return void 0===i&&(i=x.ChangeType.ValueChanged),{type:i,path:[t],value:e,id:this.primaryKeyValue,errors:r,context:n}},qt.prototype.buildViewChangesContext=function(t,e,n,r,i,o){return void 0===o&&(o=x.ViewChangeType.ValueChanged),{type:o,path:[t],value:e,preValue:n,errors:r,context:i}},qt);function qt(){this.__type__="BindingObject",this.isShowValidationMsg=!1,this.unsubscribe=new h.Subject,this.controlMap={},this.innerValues=e.Map(),this.changes=new h.Subject,this.viewChanges=new h.Subject}var Jt=(Wt.getProperties=function(t){var n=[],r=it.getNgFields(t);Object.keys(r).forEach(function(t){var e=r[t];n.push({name:t,type:x.BindingPropertyType.Plain,isPrimaryKey:e.primary,isForeignKey:e.foreign,enableMultiLangInput:e.enableMultiLangInput})});var i=it.getNgObjects(t);Object.keys(i).forEach(function(t){var e=i[t];n.push({name:t,type:x.BindingPropertyType.Object,entityType:e.type})});var o=it.getNgList(t);Object.keys(o).forEach(function(t){var e=o[t];n.push({name:t,type:x.BindingPropertyType.List,entityType:e.type})});var a=it.getNgDynamic(t);return Object.keys(a).forEach(function(t){var e=a[t];n.push({name:t,type:x.BindingPropertyType.Dynamic,entityType:e.type})}),n},Wt.getDynamicProperties=function(e){var n=[];return Object.keys(e).forEach(function(t){e.hasOwnProperty(t)&&(e[t]instanceof Object?n.push({name:t,type:x.BindingPropertyType.Dynamic,entityType:null}):n.push({name:t,type:x.BindingPropertyType.Plain,isPrimaryKey:!1,isForeignKey:!1}))}),n},Wt.getPropertyByName=function(t,e){return t.find(function(t){return t.name===e})},Wt.getPrimaryKey=function(t){var e=t.find(function(t){return!0===t.isPrimaryKey});return e?e.name:""},Wt);function Wt(){}var Yt,Zt=(c(Xt,Yt=zt),Xt);function Xt(t){var e=Yt.call(this)||this;return e.properties=t,e.primaryKey=Jt.getPrimaryKey(t),e}var Qt=(te.create=function(t){return new(this.getType(t))(t)},te.createType=function(t){var e,n=(c(r,e=Rn),r);function r(t){return e.call(this,t)||this}var i=n.prototype;return this.extendProperties(i,t),n},te.extendProperties=function(n,t){t.forEach(function(t){var e=t.name;Object.defineProperty(n,e,{get:function(){return this.currentItem[e]}})})},te.getType=function(t){if(this.provider.has(t))return this.provider.get(t);var e=this.createType(t);return this.provider.set(t,e),e},te.provider=new Map,te);function te(){}var ee=(ne.create=function(t){return Qt.create(t)},ne.extendProperties=function(n,t){t.forEach(function(t){var e=t.name;Object.defineProperty(n,e,{get:function(){return n.currentItem[e]}})})},ne);function ne(){}var re=(ie.create=function(t){return new(this.getType(t))},ie.createType=function(t){var e,n=(c(r,e=zt),r);function r(){return e.call(this)||this}var i=Jt.getPrimaryKey(t);return n.prototype.primaryKey=i,n.prototype.properties=t,this.extendProperties(n.prototype,t),n},ie.extendProperties=function(e,t){var n=this;t.forEach(function(t){t.type===x.BindingPropertyType.List?n.extendListProperty(e,t):t.type===x.BindingPropertyType.Object?n.extendObjectProperty(e,t):t.type===x.BindingPropertyType.Dynamic?n.extendDynamicObjectProperty(e,t):n.extendPlainProperty(e,t)})},ie.extendListProperty=function(t,e){var i=e.name,o=Jt.getProperties(e.entityType),a="_"+i+"_";Object.defineProperty(t,i,{get:function(){var e=this,t=this[a];if(!t){t=ee.create(o),this[a]=t;var n=this.getValue(i);if(n){var r=n.map(function(t){return ie.create(o)});t.load(r)}t.parent=this,t.changes.subscribe(function(t){t.path.unshift(i),e.changes.next(t)})}return t},set:function(t){this[a]=t}})},ie.extendObjectProperty=function(t,e){var n=e.name,r=Jt.getProperties(e.entityType),i="_"+n+"_";Object.defineProperty(t,n,{get:function(){var e=this,t=this[i];return t||(this.getValue(n),t=ie.create(r),(this[i]=t).parent=this,t.changes.subscribe(function(t){t.path.unshift(n),e.changes.next(t)})),t},set:function(t){this[i]=t}})},ie.extendDynamicObjectProperty=function(t,e){t[e.name]=null},ie.extendPlainProperty=function(t,n){var r=n.name;Object.defineProperty(t,r,{get:function(){var t,e;return!0!==n.enableMultiLangInput?e=this.getValue(r):(e=this.getValue(r,!1))?e:(e=this.getValue(r,!1),(t={})[Mt.getCurrentLanguage()]=e,t)},set:function(t){t!==this.getValue(r)&&this.setValue(r,t,!0,!0)}})},ie.getType=function(t){if(this.provider.has(t))return this.provider.get(t);var e=this.createType(t);return this.provider.set(t,e),e},ie.provider=new Map,ie);function ie(){}var oe=(ae.create=function(t){return re.create(t)},ae.createDynamicBindingObject=function(t){var e=Jt.getDynamicProperties(t),n=re.create(e);return this.extendProperties(n,e),n},ae.extendProperties=function(e,t){var n=this;t.forEach(function(t){t.type===x.BindingPropertyType.List?n.extendListProperty(e,t):t.type===x.BindingPropertyType.Object?n.extendObjectProperty(e,t):t.type===x.BindingPropertyType.Dynamic?n.extendDynamicObjectProperty(e,t):n.extendPlainProperty(e,t)})},ae.extendListProperty=function(e,t){var n=t.name,r=Jt.getProperties(t.entityType),i=ee.create(r);i.parent=e,i.changes.subscribe(function(t){t.path.unshift(n),e.changes.next(t)}),Object.defineProperty(e,n,{value:i})},ae.extendObjectProperty=function(e,t){var n=t.name,r=Jt.getProperties(t.entityType),i=this.create(r);i.parent=e,i.changes.subscribe(function(t){t.path.unshift(n),e.changes.next(t)}),Object.defineProperty(e,n,{value:i})},ae.extendDynamicObjectProperty=function(t,e){t[e.name]=null},ae.attachDynamicObjectProperty=function(e,n,t){t.parent=e,t.changes.subscribe(function(t){t.path.unshift(n),e.changes.next(t)}),Object.defineProperty(e,n,{value:t})},ae.extendPlainProperty=function(e,t){var n=t.name;Object.defineProperty(e,n,{get:function(){return e.getValue(n)},set:function(t){t!==e.getValue(n)&&e.setValue(n,t,!0,!0)}})},ae);function ae(){}var se="NgValidateForm";var pe="NgChildForm",ue=w(pe,function(t){return t}),ce="NgChildFormArray",le=w(ce,function(t){return t}),fe="NgFormControl",he=w(fe,function(t){return t}),ye=(de.toBindingPathArray=function(t){return"string"==typeof t?t.split("/").filter(function(t){return""!==t}):t.concat([])},de.toBindingPathString=function(t){return"/"+t.join("/")},de);function de(){}var ge=(ve.isEqual=function(t,e){var n=ye.toBindingPathArray(t),r=ye.toBindingPathArray(e);return n.every(function(t,e){return t===r[e]})},ve.isParent=function(t,e){var n=ye.toBindingPathArray(t),r=ye.toBindingPathArray(e);if(n.length===r.length+1)return this.isAncestor(t,e)},ve.isAncestor=function(t,e){var n=ye.toBindingPathArray(t),r=ye.toBindingPathArray(e);return!(t.length<=r.length)&&r.every(function(t,e){return t===n[e]})},ve);function ve(){}var me=(Ee.getLeafPathString=function(t){return ye.toBindingPathArray(t).pop()},Ee.getParentPathString=function(t){var e=ye.toBindingPathArray(t);return e.pop(),"/"+e.join("/")},Ee);function Ee(){}var be=(Ce.toEntityPathArray=function(t,e){var n=this,r=ye.toBindingPathArray(t),i=[];if(0===r.length)return i;var o=e.list.currentItem;return i.push(this.createPrimaryKeyPath(o.primaryKey,o.primaryKeyValue)),r.forEach(function(t){switch(Jt.getPropertyByName(o.properties,t).type){case x.BindingPropertyType.Plain:i.push(t);break;case x.BindingPropertyType.Object:o=o[t],i.push(t),i.push(n.createPrimaryKeyPath(o.primaryKey,o.primaryKeyValue));break;case x.BindingPropertyType.List:var e=o[t];o=e.currentItem,i.push(t),i.push(n.createPrimaryKeyPath(o.primaryKey,o.primaryKeyValue))}}),i},Ce.createPrimaryKeyPath=function(t,e){return t+":"+e},Ce);function Ce(){}var xe,Pe=function up(){},Ie=(Te.toBindingPathArray=function(t){return t.split(".").filter(function(t){return""!==t})},Te);function Te(){}(xe=x.DataPathNodeType||(x.DataPathNodeType={})).DataId="DataId",xe.PropName="PropName";var Me=function cp(t,e){this.type=t,this.value=e,this.prev=null,this.next=null},je=(we.prototype.unshift=function(t,e){var n=new Me(t,e);n.next=this.head.next,n.prev=this.head,(this.head.next=n).next&&(n.next.prev=n),this.length++},we.prototype.push=function(t,e){var n=this.getTail(),r=new Me(t,e);n.next=r,this.length++},we.prototype.getTail=function(){for(var t=this.head;t.next;)t=t.next;return t},we.prototype.toArray=function(){for(var t=[],e=this.head.next;e;)t.push(e.type+":"+e.value),e=e.next;return t},we.prototype.toString=function(){return"["+this.toArray().join(", ")+"]"},we.prototype.clone=function(){for(var t=new we,e=this.head.next;e;)t.push(e.type,e.value),e=e.next;return t},we);function we(){this.head=new Me(null,null),this.length=0}var Oe,Se=(Ne.createByLongPathFromRoot=function(t,e){var n=new je,r=t;if(!r||0===r.length)return n;for(var i={nodeValue:r.shift(),nodeType:x.DataPathNodeType.DataId,entityTypeInfo:new Ve(e.entityType)};i;){n.push(i.nodeType,i.nodeValue);var o=r.shift();if(!o||!i.entityTypeInfo)break;i=this.getNextPathNodeInfo(i,o)}return n},Ne.getNextPathNodeInfo=function(t,e){var n=t.nodeValue,r=t.nodeType,i=t.entityTypeInfo;if(!e||!i)return null;var o={nodeValue:e,nodeType:null,entityTypeInfo:null};if(r===x.DataPathNodeType.DataId)o.nodeType=x.DataPathNodeType.PropName,o.entityTypeInfo=i;else{var a=i.getPropInfoByName(n);a.group===x.DataPropGroup.List?(o.nodeType=x.DataPathNodeType.DataId,o.entityTypeInfo=a.typeInfo):(o.nodeType=x.DataPathNodeType.PropName,o.entityTypeInfo=a.group===x.DataPropGroup.Object?a.typeInfo:null)}return o},Ne.createByShortPathFromRoot=function(t,e,n){var r=new je,i=t,o=n.list.currentItem,a=new Ve(e.entityType);return r.push(x.DataPathNodeType.DataId,o.primaryKeyValue),i.forEach(function(t){var e=a.getPropInfoByName(t);switch(e.group){case x.DataPropGroup.Plain:r.push(x.DataPathNodeType.PropName,t);break;case x.DataPropGroup.Object:o=o[t],a=e.typeInfo,r.push(x.DataPathNodeType.PropName,t);break;case x.DataPropGroup.List:var n=o[t];o=n.currentItem,a=e.typeInfo,r.push(x.DataPathNodeType.PropName,t),r.push(x.DataPathNodeType.DataId,o.primaryKeyValue)}}),r},Ne);function Ne(){}(Oe=x.DataPropGroup||(x.DataPropGroup={})).Plain="Plain",Oe.Object="Object",Oe.Dynamic="Dynamic",Oe.List="List";var De=function lp(){},Ve=(Object.defineProperty(Fe.prototype,"isValueObject",{get:function(){return!this.primaryKey},enumerable:!0,configurable:!0}),Fe.prototype.getBindingPathByTableName=function(t){var e=this.getFullEntityPath(this,t);return e?(e.splice(0,1),"/"+e.join("/")):null},Fe.prototype.getFullEntityPath=function(t,e,n){if(void 0===n&&(n=[]),t.entityInfo&&(t.entityInfo.nodeCode===e||t.entityInfo.originalCode===e))return n.push(t.entityInfo.nodeCode),n;var r=Array.from(t.propInfoMap.values()).filter(function(t){return t.typeInfo});if(r.length<1)return n=[];t.entityInfo&&n.push(t.entityInfo.nodeCode);for(var i=0;i<r.length;i++){var o=r[i].typeInfo,a=this.getFullEntityPath(o,e);if(a&&!(a.length<1))return n=n.concat(a)}return null},Fe.prototype.getPropInfos=function(){return Array.from(this.propInfoMap.values()).filter(function(t){return!t.isVOField})},Fe.prototype.getPropNames=function(){var e=[];return this.getPropInfos().forEach(function(t){e.push(t.name)}),e},Fe.prototype.getPropInfosByGroup=function(e){return Array.from(this.propInfoMap.values()).filter(function(t){return t.group===e&&!t.isVOField})},Fe.prototype.getPropNamesByGroup=function(t){var e=[];return this.getPropInfosByGroup(t).forEach(function(t){e.push(t.name)}),e},Fe.prototype.getPropInfoByName=function(t){return this.propInfoMap.has(t)?this.propInfoMap.get(t):null},Fe.prototype.getPropInfoByPath=function(t){var e=t.concat([]);if(0===e.length)throw Error("属性路径不能为空");for(var n=this,r=null;n&&0<e.length;){var i=e.shift();if(!(r=n.getPropInfoByName(i)))throw Error("路径"+t+"中存在不正确的节点"+i+"，请检查");n=r.typeInfo,r.group===x.DataPropGroup.Dynamic&&0<e.length&&(n=r=null)}return r},Fe.prototype.getTypeInfoByPath=function(t){if(0===t.length)return this;var e=this.getPropInfoByPath(t);if(!e.typeInfo)throw Error("路径"+t+"无法定位到一个EntityTypeInfo，请检查");return e.typeInfo},Fe.prototype.getPrimaryKeyPropInfo=function(){return this.getPropInfoByName(this.primaryKey)},Fe.prototype.getPropMappingByName=function(t){var e=this.getPropInfoByName(t);return e?e.mapping:""},Fe.prototype.getPropMappingByPath=function(t){var e=this.getPropInfoByPath(t);return e?e.mapping:""},Fe.prototype.checkPropGroup=function(t,e){var n=this.getPropInfoByName(t);return!(!n||n.group!==e)},Fe.prototype.collectPropInfos=function(){var n=this,r=at.getNgFieldProperties(this.type);Object.keys(r).forEach(function(t){var e=r[t];!0===e.primary&&(n.primaryKey=t),!0===e.foreign&&(n.foreignKey=t),n.addPropInfo(x.DataPropGroup.Plain,t,e.dataField,null,e)});var i=at.getNgObjectProperties(this.type);Object.keys(i).forEach(function(t){var e=i[t];n.addPropInfo(x.DataPropGroup.Object,t,e.dataField,e.type,e)});var o=at.getNgDynamicProperties(this.type);Object.keys(o).forEach(function(t){var e=o[t];n.addPropInfo(x.DataPropGroup.Dynamic,t,e.dataField,null,e)});var a=at.getNgListProperties(this.type);Object.keys(a).forEach(function(t){var e=a[t];n.addPropInfo(x.DataPropGroup.List,t,e.dataField,e.type,e)})},Fe.prototype.collectEntityInfos=function(){var t=at.getNgEntityMatadata(this.type);this.entityInfo=t},Fe.prototype.addPropInfo=function(t,e,n,r,i){n=n||e;var o=null;r&&(o=new Fe(r));var a={group:t,name:e,mapping:n,typeInfo:o,metadataInfo:i};this.propInfoMap.set(e,a);var s=i&&i.originalDataField;if(s&&!this.propInfoMap.has(s))this.propInfoMap.set(s,E({},a,{isVOField:!0}));else if(i&&i.type){var p=at.getNgEntityMatadata(i.type);p&&p.originalCode&&this.propInfoMap.set(p.originalCode,E({},a,{isVOField:!0}))}},Fe);function Fe(t){this.type=t,this.primaryKey="",this.foreignKey="",this.propInfoMap=new Map,this.collectEntityInfos(),this.collectPropInfos()}var Re=new d.InjectionToken("@farris/devkit form path token"),Be=new d.InjectionToken("@farris/devkit_back_end_message_handler"),_e=new d.InjectionToken("@farris/message_service_token"),Ae=new d.InjectionToken("@farris/notify_service_token");var Le=(ke.warn=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];this.logable()&&console&&console.warn.apply(console,b([t],e))},ke.error=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];this.logable()&&console&&console.error.apply(console,b([t],e))},ke.log=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];this.logable()&&console&&console.log.apply(console,b([t],e))},ke.logable=function(){return window&&window.localStorage&&"true"===window.localStorage.getItem("__DEVKIT_LOGABLE__")||!1},ke);function ke(){}function $e(t){return t&&"string"==typeof t?t.replace(/[\\]/g,"\\\\").replace(/[\"]/g,'\\"').replace(/[\/]/g,"\\/").replace(/[\b]/g,"\\b").replace(/[\f]/g,"\\f").replace(/[\n]/g,"\\n").replace(/[\r]/g,"\\r").replace(/[\t]/g,"\\t"):t}var Ue=new d.InjectionToken("@farris_resolver_token"),He="ENTITY~",Ke="STATE~",Ge=["SumByProp","CountByProp","AvgByProp","MaxByProp","MinByProp","IsExistRecord","ListContains","ListGreaterThan","ListLessThan","ListStartWith","ListEndWith"],ze=(qe.decorators=[{type:d.Injectable}],qe.ctorParameters=function(){return[{type:d.Injector},{type:Array,decorators:[{type:d.Optional},{type:d.Inject,args:[Ue]}]}]},qe);function qe(t,e){this.injector=t,this.resolvers=e}var Je="NgRepository";var We=(Ye.prototype.count=function(){return this.innerEntitySet.size},Object.defineProperty(Ye.prototype,"entityTypeName",{get:function(){return this.entityType.name},enumerable:!0,configurable:!0}),Ye.prototype.has=function(t){return this.innerEntityMap.has(t)},Ye.prototype.clear=function(){this.innerEntityMap.clear(),this.innerEntitySet.clear(),this.notifyCollectionChanged(new D([],x.ModifyType.Load))},Ye.prototype.reset=function(){this.innerEntityMap.clear(),this.innerEntitySet.clear();var t=new D([],x.ModifyType.Load);t.isReset=!0,this.notifyCollectionChanged(t)},Ye.prototype.toArray=function(){return Array.from(this.innerEntitySet)},Ye.prototype.toJSON=function(){var e=[];return this.toArray().forEach(function(t){e.push(t.toJSON())}),e},Ye.prototype.loadEntities=function(t,e){var n=this;void 0===e&&(e=!1),this.innerEntityMap.forEach(function(t){t.unsubscribe.next(),t.unsubscribe.complete(),t.valueChanged.complete(),t.data=undefined}),this.innerEntityMap.clear(),this.innerEntitySet.clear(),t.forEach(function(t){n.innerEntitySet.add(t),n.innerEntityMap.set(t[n.primaryKey],t),n.listenEntityChangeEvent(t)});var r=new D(t,x.ModifyType.Load);r.entityCreate=e,this.notifyCollectionChanged(r)},Ye.prototype.addEntity=function(t,e){void 0===e&&(e=!1),this.verifyEntityToAdd(t),this.innerEntitySet.add(t),this.innerEntityMap.set(t[this.primaryKey],t),this.listenEntityChangeEvent(t);var n=e?x.ModifyType.Clone:x.ModifyType.Add;this.notifyCollectionChanged(new D([t],n))},Ye.prototype.insertEntity=function(t,e){this.verifyEntityToAdd(t),this.innerEntitySet.add(t),this.innerEntityMap.set(t[this.primaryKey],t),this.listenEntityChangeEvent(t),this.notifyCollectionChanged(new D(t,x.ModifyType.Insert,null,null,e))},Ye.prototype.updateEntity=function(t,e){t.load(e),this.notifyCollectionChanged(new D(e,x.ModifyType.Update,null,null))},Ye.prototype.addEntities=function(t){var e=this;if(t){var n=[];t.forEach(function(t){e.verifyEntityToAdd(t),n.push(t)}),n.forEach(function(t){e.innerEntitySet.add(t),e.innerEntityMap.set(t[e.primaryKey],t),e.listenEntityChangeEvent(t)}),this.notifyCollectionChanged(new D(n,x.ModifyType.Add))}},Ye.prototype.addData=function(t){var e=this;if(t){var n=[];t.forEach(function(t){e.verifyEntityToAdd(t),n.push(t)}),n.forEach(function(t){e.innerEntitySet.add(t),e.innerEntityMap.set(t[e.primaryKey],t),e.listenEntityChangeEvent(t)}),this.notifyCollectionChanged(new D(n,x.ModifyType.AddData))}},Ye.prototype.getEntityById=function(t){return!1===this.innerEntityMap.has(t)?null:this.innerEntityMap.get(t)},Ye.prototype.getEntityByPath=function(t){for(var e=t[0].split(":")[1],n=this.getEntityById(e),r=1;r<t.length&&n;r+=1){var i=t[r];n instanceof zn||n.constructor&&n.constructor.prototype&&"ConcreteEntityPrototype"===n.constructor.prototype.typeName?-1===i.indexOf(":")&&(n=n[t[r]]):n=n.get(t[r].split(":")[1])}return n},Ye.prototype.getEntitiesByPath=function(t){for(var e=t[0].split(":")[1],n=this.getEntityById(e),r=1;r<t.length&&n;r+=2){if(!((n=n[t[r]])instanceof St))throw new Error("路径格式错误");if(r+1<t.length){var i=t[r+1].split(":")[1];n=n.get(i)}}return n},Ye.prototype.getEntities=function(t){return Array.from(this.innerEntitySet).filter(t)},Ye.prototype.getAllEntities=function(){return Array.from(this.innerEntitySet)},Ye.prototype.removeEntityById=function(t){this.verifyEntityToRemove(t);var e=this.innerEntityMap.get(t);return this.innerEntityMap["delete"](t),this.innerEntitySet["delete"](e),this.notifyCollectionChanged(new D([e],x.ModifyType.Remove)),e},Ye.prototype.removeEntitiesByIds=function(t){},Ye.prototype.removeEntities=function(t){var e=this,n=Array.from(this.innerEntitySet).filter(t);return n.forEach(function(t){e.innerEntityMap["delete"](t[e.primaryKey]),e.innerEntitySet["delete"](t)}),this.notifyCollectionChanged(new D(n,x.ModifyType.Remove)),n},Ye.prototype.removeData=function(t){var e=this,n=Array.from(this.innerEntitySet).filter(t);return n.forEach(function(t){e.innerEntityMap["delete"](t[e.primaryKey]),e.innerEntitySet["delete"](t)}),this.notifyCollectionChanged(new D(n,x.ModifyType.RemoveData)),n},Ye.prototype.resetEntities=function(t,e){if(-1===t[0].indexOf(":"))throw new Error("路径格式错误");var n=t[0].split(":")[1],r=this.innerEntityMap.get(n),i=r[t[1]];if(!r)throw new Error("找不到主键为"+n+"的实体");for(var o=2;o<t.length;o+=2){var a=t[o].split(":")[1];if(!(r=i.get(a)))throw new Error("找不到主键为"+n+"的实体");i=r[t[o+1]]}i.clear(),i.loadEntities(e)},Ye.prototype.verifyEntityToAdd=function(t){if(this.has(t[this.primaryKey]))throw new Error("The repository already had an item with the save identity of '"+t[this.primaryKey]+"'");return!0},Ye.prototype.verifyEntityToRemove=function(t){if(!this.has(t))throw new Error("The entity with identity of '"+t+" dose not exsit.'");return!0},Ye.prototype.notifyCollectionChanged=function(t){this.collectionChanged.next(t)},Ye.prototype.listenEntityChangeEvent=function(t){var e=this;t&&t.onValueChanged.subscribe(function(t){return e.changes.next(t)})},Object.defineProperty(Ye.prototype,"pageSize",{get:function(){return this.paginationInfo&&this.paginationInfo.pageSize||0},set:function(t){if("number"!=typeof t||t<0)throw new Error("Invalid parameter:pageSize");var e=this.paginationInfo;this.paginationInfo=Object.assign({},e,{pageSize:t}),this.notifyCollectionChanged(new D(this.paginationInfo,x.ModifyType.PaginationInfoChange))},enumerable:!0,configurable:!0}),Object.defineProperty(Ye.prototype,"totalCount",{get:function(){return this.paginationInfo&&this.paginationInfo.total||0},set:function(t){if("number"!=typeof t||t<0)throw new Error("Invalid parameter:total");var e=this.paginationInfo;this.paginationInfo=Object.assign({},e,{total:t}),this.notifyCollectionChanged(new D(this.paginationInfo,x.ModifyType.PaginationInfoChange))},enumerable:!0,configurable:!0}),Object.defineProperty(Ye.prototype,"pageIndex",{get:function(){return this.paginationInfo&&this.paginationInfo.pageIndex||1},set:function(t){if("number"!=typeof t||t<0)throw new Error("Invalid parameter:pageIndex");var e=this.paginationInfo;this.paginationInfo=Object.assign({},e,{pageIndex:t}),this.notifyCollectionChanged(new D(this.paginationInfo,x.ModifyType.PaginationInfoChange))},enumerable:!0,configurable:!0}),Ye.prototype.updatePaginationInfoByPath=function(t,e){var n=this.paginationInfo,r=e.pageIndex,i=e.pageSize,o=e&&(e.totalCount||e.total)||0,a=Object.assign({},n,{pageIndex:r,pageSize:i,total:o});this.setPaginationConfigByPath(t,a)},Ye.prototype.getPaginationConfigByPath=function(t,e){if(!t||"/"===t)return this.paginationInfo;if("string"!=typeof t)throw new Error("路径必须为字符串！");var n=t.split("/").filter(function(t){return!!t&&0<t.trim().length}).map(function(t){return t.trim()}),r=this.paginationInfo;return n.forEach(function(t){r=r&&r.hasOwnProperty(t)?r[t]:null}),r||(void 0!==e?e:undefined)},Ye.prototype.setPaginationConfigByPath=function(r,t){var e=JSON.stringify(this.paginationInfo);return r&&"/"!==r?(Array.isArray(r)||(r=r.toString().match(/[^/[\]]+/g)||[]),r.slice(0,-1).reduce(function(t,e,n){return Object(t[e])===t[e]?t[e]:t[e]=Math.abs(r[n+1])>>0==+r[n+1]?[]:{}},this.paginationInfo)[r[r.length-1]]=t):this.paginationInfo=t,JSON.stringify(this.paginationInfo)!==e&&this.notifyCollectionChanged(new D(this.paginationInfo,x.ModifyType.PaginationInfoChange)),this.paginationInfo},Ye);function Ye(t){this.innerEntitySet=new Set,this.innerEntityMap=new Map,this.collectionChanged=new h.Subject,this.changes=new h.Subject,this.entityType=t,this.primaryKey=it.getPrimaryKey(this.entityType)||t.prototype.primaryKey}var Ze=(Xe.prototype.createEntity=function(t){return ht(this.entityType,t)},Xe.prototype.createEntities=function(t,e){return yt(this.entityType,t)},Xe.prototype.createEntitiesByPath=function(t,e){var n,r,i,o=t.split("/");if(o.length<3)throw Error("根据path删除实体数据出错了。传入的path["+t+"]格式不对");if(e.length<1)return[];for(var a=2;a<o.length;a+=2){var s=o[a-1];i=o[a],n=(n?n.get(s):this.entityCollection.getEntityById(s))[i];var p=r?r.propEntityType:this.entityType;if(r=Nn.getPropInfo(p,i),!n)throw Error("fpath参数错误，无法找到"+i+"对应的子表。fpath为："+t)}return e.map(function(t){return ht(r.propEntityType,t)})},Xe.prototype.getEntityByPath=function(t){return this.getEntityNodeByPath(t)},Xe.prototype.getEntitiesByPath=function(t){var e=this.getEntityNodeByPath(t);return e.toArray()},Xe.prototype.getEntityNodeByPath=function(t){for(var e=Se.createByLongPathFromRoot(t,this),n=this.entityCollection,r=e.head.next;r;){if(!(n=r.type===x.DataPathNodeType.DataId?n instanceof We==1?n.getEntityById(r.value):n.get(r.value):n[r.value]))throw new Error("找不到"+r.value+"对应的数据节点");r=r.next}return n},Xe.prototype.getPropValueByPath=function(t){var e=t.pop();return this.getEntityByPath(t)[e]},Xe.prototype.setPropValueByPath=function(t,e){var n=t.pop();this.getEntityByPath(t)[n]=e},Xe.prototype.insertEntityBeforeByPath=function(t){throw new Error("Not Implemented")},Xe.prototype.insertEntitiesBeforeByPath=function(){throw new Error("Not Implemented")},Xe.prototype.insertEntityAfterByPath=function(){throw new Error("Not Implemented")},Xe.prototype.insertEntitiesAfterByPath=function(){throw new Error("Not Implemented")},Xe.prototype.appendEntityByPath=function(t,e,n,r){void 0===r&&(r=!1);var i,o,a,s=t.split("/");if(s.length<3)throw Error("根据path删除实体数据出错了。传入的path["+t+"]格式不对");for(var p=2;p<s.length;p+=2){var u=s[p-1];a=s[p],i=(i?i.get(u):this.entityCollection.getEntityById(u))[a];var c=o?o.propEntityType:this.entityType;if(o=Nn.getPropInfo(c,a),!i)throw Error("fpath参数错误，无法找到"+a+"对应的子表。fpath为："+t)}var l=ht(o.propEntityType,e);return i.appendNew(l,r),l},Xe.prototype.insertEntityByPath=function(t,e,n,r){var i,o,a,s=t.split("/");if(s.length<3)throw Error("根据path删除实体数据出错了。传入的path["+t+"]格式不对");for(var p=2;p<s.length;p+=2){var u=s[p-1];a=s[p],i=(i?i.get(u):this.entityCollection.getEntityById(u))[a];var c=o?o.propEntityType:this.entityType;if(o=Nn.getPropInfo(c,a),!i)throw Error("fpath参数错误，无法找到"+a+"对应的子表。fpath为："+t)}var l=ht(o.propEntityType,e);return i.insert(l,r),l},Xe.prototype.appendEntitiesByPath=function(t,e){var n=this.getEntityNodeByPath(t);n instanceof We==1?n.addEntities(e):n.appendEntities(e)},Xe.prototype.removeEntityByPath=function(t,e){var n,r=t.split("/");if(r.length<3)throw Error("根据path删除实体数据出错了。传入的path["+t+"]格式不对");for(var i=2;i<r.length;i+=2){var o=r[i-1],a=r[i];if(!(n=(n?n.get(o):this.entityCollection.getEntityById(o))[a]))throw Error("fpath参数错误，无法找到"+a+"对应的子表。fpath为："+t)}n.remove(e)},Xe.prototype.removeEntitiesByPath=function(t,e){throw new Error("Not Implemented")},Xe.prototype.clearAllEntityChanges=function(){this.entityCollection.toArray().forEach(function(t){t.changes.splice(0,t.changes.length)})},Xe.prototype.clearEntityChangesById=function(t){var e=this.entityCollection.getEntityById(t);e&&e.changes.splice(0,e.changes.length)},Xe.prototype.clearEntityChangesByIds=function(t){var e=this;!t||t.length<0||t.forEach(function(t){e.clearEntityChangesById(t)})},Xe.prototype.checkAllEntityChanges=function(){return this.entityCollection.toArray().some(function(t){return 0<t.changes.length})},Xe.prototype.checkEntityChangesById=function(t){var e=this.entityCollection.getEntityById(t);return!!e&&0<e.changes.length},Xe.prototype.clearEntityChangesByArray=function(t){this.clearEntityChangesByIds(t)},Xe);function Xe(t){this.entityCollection=t,this.entityType=t.entityType}var Qe=(tn.prototype.expandMainEntityConfig=function(){var t=this.entityType.typeName||this.entityType.name;if(this.paginationConfig.hasOwnProperty(t)){var e=this.paginationConfig[t];this.paginationConfig=Object.assign(this.paginationConfig,e)}else this.paginationConfig=Object.assign(this.paginationConfig,{pageSize:this.paginationConfig.pageSize||0})},tn.prototype.removeLasts=function(){var n=this,r=this.entityType.typeName||this.entityType.name;Object.keys(this.paginationConfig).forEach(function(t){if(t!==r&&t.endsWith("s")){var e=t.substring(0,t.length-1);n.paginationConfig[e]=n.paginationConfig[t],delete n.paginationConfig[t]}})},tn.prototype.deleteMainEntityConfig=function(){var t=this.entityType.typeName||this.entityType.name;delete this.paginationConfig[t]},Object.defineProperty(tn.prototype,"pagination",{get:function(){return this.paginationConfig},enumerable:!0,configurable:!0}),tn.prototype.getPaginationConfigByPath=function(t,e){if(!t||"/"===t)return this.paginationConfig;if("string"!=typeof t)throw new Error("路径必须为字符串！");var n=(t=t.substring(1)).split("/").filter(function(t){return!!t&&0<t.trim().length}),r=this.paginationConfig;return n.forEach(function(t){r=r&&r.hasOwnProperty(t)?r[t]:null}),r||(void 0!==e?e:undefined)},tn.prototype.setPaginationConfigByPath=function(r,t){return Array.isArray(r)||(r=r.toString().match(/[^/[\]]+/g)||[]),r.slice(0,-1).reduce(function(t,e,n){return Object(t[e])===t[e]?t[e]:t[e]=Math.abs(r[n+1])>>0==+r[n+1]?[]:{}},this.paginationConfig)[r[r.length-1]]=t,this.paginationConfig},tn.prototype.getNgListProperties=function(o){void 0===o&&(o=0);var a=function(t){var r=it.getNgList(t),i={};return Object.keys(r).length<1||Object.keys(r).forEach(function(t){var e=r[t].dataField;e.endsWith("s")&&(e=e.substring(0,e.length-1)),i[e]={pageSize:o};var n=a(r[t].type);null!==n&&0<Object.keys(n).length&&(i=Object.assign({},i,n))}),i},t=a(this.entityType);return Object.assign({},{pageSize:o},t)},tn.decorators=[{type:d.Injectable}],tn.ctorParameters=function(){return[{type:undefined},{type:undefined}]},tn);function tn(t,e){this.entityType=t,this.paginationConfig=e,null!==this.paginationConfig&&this.paginationConfig!==undefined||(this.paginationConfig=this.getNgListProperties()),this.expandMainEntityConfig(),this.deleteMainEntityConfig(),this.removeLasts()}var en=(nn.prototype.addChange=function(t){this["on"+x.DataChangeType[t.changeType]+"Data"](t)},nn.prototype.addChanges=function(t){var e=this;t.forEach(function(t){return e.addChange(t)})},nn.prototype.clear=function(){this.history.splice(0,this.history.length)},nn.prototype.clearByIds=function(s){this.history=this.history.filter(function(t){var e,n;if(!t.fpath||"/"===t.fpath||!t.fpath.includes("/"))return!s.includes(t.dataId);try{for(var r=P(s),i=r.next();!i.done;i=r.next()){var o=i.value;return!t.fpath.split("/").includes(o)}}catch(a){e={error:a}}finally{try{i&&!i.done&&(n=r["return"])&&n.call(r)}finally{if(e)throw e.error}}})},nn.prototype.isChanged=function(){return 0<this.history.length},nn.prototype.onAddData=function(t){this.history.push(t)},nn.prototype.onDeleteData=function(e){var t=this.history.findIndex(function(t){return t.dataId===e.dataId&&t.changeType===x.DataChangeType.Add});0<=t?this.history.splice(t,1):this.history.push(e)},nn);function nn(){this.history=[]}var rn=(on.prototype.getConditionsByBindingPath=function(t,n){var e=this.sorts.get(t)||[];return e.length<1||"function"==typeof n&&(e=e.map(function(t){var e=n(t.SortType);return{SortField:t.SortField,SortType:e}})),e},on.prototype.addCondition=function(t,e,n){if(e&&n){var r=this.sorts.has(t),i={SortField:e,SortType:n};if(r){var o=this.sorts.get(t)||[],a=o.findIndex(function(t){return t.SortField===e});-1!==a?o[a]=i:o.push(i)}else this.sorts.set(t,[i])}else this.sorts["delete"](t)},on.prototype.removeCondition=function(t,e){throw new Error("not implement!")},on.prototype.setConditions=function(t,e,n){if(e&&n){var r=e.split(",").filter(function(t){return t}),i=n.split(",").filter(function(t){return t});if(r.length!==i.length)throw new Error("arguments error,fields and direction are not match.");var o=[];r.forEach(function(t,e){var n={SortField:t,SortType:i[e]};o.push(n)}),this.sorts.set(t,o)}else this.sorts["delete"](t)},on.prototype.clear=function(){this.sorts.clear()},on);function on(){this.sorts=new Map}var an=(sn.prototype.getFilters=function(t){return this.filters.get(t)||[]},sn.prototype.mergeCondition=function(t,e){var n=e(this.filters.get(t)||[]);this.filters.set(t,n)},sn.prototype.addCondition=function(t,e){var n=this.filters.get(t),r=this.findConditionIndex(t,e);-1!==r?n[r]=e:n.push(e)},sn.prototype.addConditions=function(e,t){var n=this;!t||!Array.isArray(t)||t.length<1||t.forEach(function(t){n.addCondition(e,t)})},sn.prototype.removeCondition=function(n,t){var r=this,i=this.filters.get(n);if(i&&!(i.length<1)){var e=i.filter(t);e&&e.forEach(function(t){var e=r.findConditionIndex(n,t);0<=e&&i.splice(e,1)})}},sn.prototype.clear=function(){this.filters.clear()},sn.prototype.setConditions=function(t,e){this.filters.set(t,e)},sn.prototype.findConditionIndex=function(t,c){if(!c||"object"!=typeof c||Object.keys(c).length<1)return-1;var e=this.filters.get(t);return!e||e.length<1?-1:e.findIndex(function(t,e){var n,r,i=!0,o=Object.keys(c);try{for(var a=P(o),s=a.next();!s.done;s=a.next()){var p=s.value;if(!t||!t.hasOwnProperty(p)||t[p]!==c[p]){i=!1;break}}}catch(u){n={error:u}}finally{try{s&&!s.done&&(r=a["return"])&&r.call(a)}finally{if(n)throw n.error}}return i})},sn);function sn(){this.filters=new Map}var pn=(un.create=function(t){var e=Date.now().valueOf();return(un.previous=un.previous<e?e:un.previous+100).toString(t)},un.previous=0,un);function un(){}var cn=(Object.defineProperty(ln.prototype,"primaryKey",{get:function(){return this.entityCollection.primaryKey},enumerable:!0,configurable:!0}),Object.defineProperty(ln.prototype,"changes",{get:function(){return this.entityCollection.changes},enumerable:!0,configurable:!0}),Object.defineProperty(ln.prototype,"entityCollectionChange",{get:function(){return this.entityCollection.collectionChanged},enumerable:!0,configurable:!0}),Object.defineProperty(ln.prototype,"name",{get:function(){if(!this.innerName){var t=pn.create();this.innerName="Repository_"+t}return this.innerName},set:function(t){this.innerName=t},enumerable:!0,configurable:!0}),ln.prototype.updateEntityType=function(t){this.entityType=t,this.entityTypeInfo=new Ve(this.entityType),this.entityCollection=new We(this.entityType)},ln.prototype.readMetadata=function(){var t=O.getClassMetadataByName(this.constructor,"NgRepository");t&&(this.apiUri=t.apiUrl,this.entityType=t.entityType)},ln.prototype.setPaginationConfig=function(t){this.paginationManager=new Qe(this.entityType,t);var e=(this.paginationManager.getPaginationConfigByPath("/")||{}).pageSize,n=void 0===e?0:e;this.entityCollection.paginationInfo=Object.assign({pageSize:n},this.paginationManager.pagination,this.entityCollection.paginationInfo)},ln.prototype.reset=function(){this.entityCollection.reset()},ln.prototype.buildEntity=function(t){return ht(this.entityType,t)},ln.prototype.buildEntities=function(t){return yt(this.entityType,t)},ln.decorators=[{type:d.Injectable}],ln.ctorParameters=function(){return[]},ln);function ln(){this.paginationInfo=null,this.readMetadata(),this.entityType&&(this.entityTypeInfo=new Ve(this.entityType),this.entityCollection=new We(this.entityType)),this.dataChangeHistory=new en,this.sortConditionManager=new rn,this.filterConditionManager=new an}var fn,hn=(c(yn,fn=cn),yn.prototype.getEntities=function(t,e,n,r){throw new Error("Not Implemented")},yn.prototype.filter=function(t,e,n,r){throw new Error("Not Implemented")},yn.prototype.getList=function(){throw new Error("Not Implemented")},yn.prototype.getById=function(t){throw new Error("Not Implemented")},yn.prototype.getEntityById=function(t){throw new Error("Not Implemented")},yn.prototype.queryChild=function(t,e,n,r,i){throw new Error("Not Implemented")},yn.prototype.updateById=function(t){throw new Error("Not Implemented")},yn.prototype.updateEntityById=function(t){throw new Error("Not Implemented")},yn.prototype.create=function(){throw new Error("Not Implemented")},yn.prototype.append=function(){throw new Error("Not Implemented")},yn.prototype.appendByPath=function(t){throw new Error("Not Implemented")},yn.prototype.insert=function(t,e){throw new Error("Not Implemented")},yn.prototype.insertByPath=function(t,e){throw new Error("Not Implemented")},yn.prototype.removeById=function(t,e){throw new Error("Not Implemented")},yn.prototype.batchRemove=function(t,e){throw new Error("Not Implemented")},yn.prototype.removeByIds=function(t,e){throw new Error("Not Implemented")},yn.prototype.removeByPath=function(t,e){throw new Error("Not Implemented")},yn.prototype.updateChangesById=function(t){throw new Error("Not Implemented")},yn.prototype.updateChangesByPath=function(t,e){throw new Error("Not Implemented")},yn.prototype.updateAllChanges=function(){throw new Error("Not Implemented")},yn.prototype.applyChanges=function(){throw new Error("Not Implemented")},yn.prototype.applyChangesById=function(t){throw new Error("Not Implemented")},yn.prototype.cancelChanges=function(t){throw new Error("Not Implemented")},yn.prototype.batchRemoveByPath=function(t,e){throw new Error("Not Implemented")},yn.prototype.batchAppendByPath=function(t,e){throw new Error("Not Implemented")},yn.prototype.batchAppend=function(t){throw new Error("Not Implemented")},yn.decorators=[{type:d.Injectable}],yn.ctorParameters=function(){return[{type:d.Injector}]},yn);function yn(t){var e=fn.call(this)||this;return e.injector=t,e.entityManager=new Ze(e.entityCollection),e}var dn=(gn.prototype.resolve=function(t){var e=In.getGroupFunctionDependency(t,this.repository.entityTypeInfo),n=this.getEntityDependency(t);e&&0<e.length&&n&&0<n.length&&e.forEach(function(e){var t=n.findIndex(function(t){return e.startsWith(t)});-1!==t&&n.splice(t,1)});var r=b(e,n);return b(new Set(r))},gn.prototype.getValidEntityPropertyExpression=function(t){var e=t.split("."),n=null;try{n=this.entityTypeInfo.getPropInfoByPath(e)}catch(r){}return n?t.split("."):1<e.length?(e.pop(),this.getValidEntityPropertyExpression(e.join("."))):null},gn.prototype.getEntityDependency=function(t){var n=this,r=[];if(this.entityTypeInfo){var e=new RegExp("[\\'\\\"]?\\s*("+this.entityTypeInfo.entityInfo.nodeCode+"|"+this.entityTypeInfo.entityInfo.originalCode+")[\\.\\[\\]a-zA-Z0-9_]+\\s*[\\'\\\"]?","g"),i=t.match(e);Array.isArray(i)&&0<i.length&&i.forEach(function(t){if(-1!==t.indexOf(".")){t=t.trim().replace(/\"/g,""),t=(t=In.convertToNodeCode(t,n.repository.entityTypeInfo).join(".")).substr(t.indexOf(".")+1);var e=n.getValidEntityPropertyExpression(t);e&&Array.isArray(e)&&0<e.length&&(e.splice(0,0,He),r.push(e.join("/")))}else console.warn("无效的实体表达式:"+t)})}else console.warn("获取实体类型信息失败，请重新编译改表单。");return r},gn.decorators=[{type:d.Injectable}],gn.ctorParameters=function(){return[{type:cn}]},gn);function gn(t){this.repository=t,this.entityTypeInfo=this.repository&&this.repository.entityTypeInfo||null}var vn=["GetContextParameter","GetSessionValue"],mn=(En.prototype.resolve=function(t){var i=[],e=new RegExp("DefaultFunction\\.("+vn.join("|")+")\\s*\\([^\\r\\n\\)]*\\)","g"),n=t.match(e);if(n&&0<n.length){var o=/\(([^\r\n\)]*)\)/;n.forEach(function(t){var e=t.match(o);if(2===e.length){var n=e[1].trim().replace(/\"/g,""),r=["STATE~"];r.push(n),i.push(r.join("/"))}})}return i},En);function En(){}var bn=(Cn.prototype.resolve=function(t){var e=[];if(!t||t.length<1)return e;var n=t.match(/\/\*\*\s*__define__\((.*)\)\s*\*\//);if(n&&2===n.length){var r=n[1].trim(),i=null;try{i=JSON.parse(r)}catch(o){console.warn("自定义依赖解析失败："+r)}i&&i.hasOwnProperty("deps")&&Array.isArray(i.deps)&&e.push.apply(e,b(i.deps))}return e},Cn.decorators=[{type:d.Injectable}],Cn);function Cn(){}var xn=(Pn.prototype.resolve=function(n){var r=[];if(this.resolverRegistry&&this.resolverRegistry.resolvers&&!(this.resolverRegistry.resolvers.length<1)){var t=this.resolverRegistry.resolvers.find(function(t){return t instanceof bn});if(t){var e=t.resolve(n);e&&Array.isArray(e)&&0<e.length&&r.push.apply(r,b(e))}return r&&0<r.length?r:(this.resolverRegistry.resolvers.forEach(function(t){if(!(t instanceof bn)){var e=t.resolve(n);e&&0<e.length&&r.push.apply(r,b(e))}}),b(new Set(r)))}},Pn.decorators=[{type:d.Injectable}],Pn.ctorParameters=function(){return[{type:d.Injector},{type:ze}]},Pn);function Pn(t,e){this.injector=t,this.resolverRegistry=e}var In=(Tn.getGroupFunctionDependency=function(t,a){var s=this,p=[],e=new RegExp("DefaultFunction\\.("+Ge.join("|")+")\\s*\\([^\\r\\n\\)]*\\)","g"),n=t.match(e);if(n&&0<n.length){var u=/\(([^\r\n\)]*)\)/;n.forEach(function(t){var e=t.match(u);if(2===e.length){var n=e[1],r=n.split(",").map(function(t){return t.replace(/\"/g,"")});if(!r||2!==r.length)throw new Error("无法解析参数： "+JSON.stringify(n));var i=r.join("."),o=(i=(i=s.convertToNodeCode(i,a).join(".")).substr(i.indexOf(".")+1)).split(".");o.splice(0,0,He),p.push(o.join("/"))}})}return p},Tn.convertToNodeCode=function(t,e){var n=[];if(e&&t.includes("."))for(var r=t.split(".")||[],i=e,o=0;o<r.length;o++){var a=r[o];if(i&&i.entityInfo&&i.entityInfo.nodeCode===a||i.entityInfo.originalCode===a){0===o?n.push(i.entityInfo.originalCode):n.push(i.entityInfo.nodeCode);var s=r[o+1];if(!s)break;var p=i.getPropInfoByName(s);if(!p)break;p.typeInfo&&(i=p.typeInfo)}else{if(!i||!i.getPropInfoByName(a))break;var u=i.getPropInfoByName(a);n.push(u.name)}}return n},Tn.getChildrenEntityPaths=function(t,n,r){var i=this;void 0===r&&(r=[]);var e=t.getPropInfosByGroup(x.DataPropGroup.List);e&&0<e.length?e.forEach(function(t){0===r.length&&n.push([t.name]);var e=t.typeInfo.getPropInfosByGroup(x.DataPropGroup.List);e&&0<e.length?(r.push(t.name),e.forEach(function(t){i.getChildrenEntityPaths(t.typeInfo,n,r)})):(0!==r.length&&(r.push(t.name),n.push(b(r))),r.length=0)}):(0<r.length&&(r.push(t.entityInfo.nodeCode),n.push(b(r))),r.length=0)},Tn.getCurrentRowByPaths=function(t,e){var n=null,r=e.getValue(t);if(r&&0<r.length){var i=r.currentItem.primaryKeyValue||null;if(i){var o=r.findById(i);o&&(n=o.toJSON())}}return n},Tn.getAvailableChildrenPathsFromEntityPaths=function(t,e){var n=[];for(t=b(t);0<t.length;){var r=e.getPropInfoByPath(t);if(r&&"List"===r.group){n=t;break}t.pop()}return n},Tn.getBindingPath=function(t,e){return t=this.getEntityPath(t),this.getAvailableChildrenPathsFromEntityPaths(t,e)},Tn.getEntityPath=function(t){return t.filter(function(t,e){return e%2!=0||!t.includes(":")})},Tn);function Tn(){}var Mn=(jn.getChildrenNodeCodes=function(t,n){var r=this;void 0===n&&(n=[]);var e=t.getPropInfosByGroup(x.DataPropGroup.List);e&&0<e.length&&e.forEach(function(t){n.push(t.name);var e=t.typeInfo.getPropInfosByGroup(x.DataPropGroup.List);e&&0<e.length&&e.forEach(function(t){n.push(t.name),r.getChildrenNodeCodes(t.typeInfo,n)})})},jn);function jn(){}var wn,On=(c(Sn,wn=a.FormGroup),Object.defineProperty(Sn.prototype,"formGroupName",{get:function(){return this.ngValidateForm?this.ngValidateForm.formGroupName:""},enumerable:!0,configurable:!0}),Object.defineProperty(Sn.prototype,"enableValidate",{get:function(){return!!this.ngValidateForm&&this.ngValidateForm.enableValidate},enumerable:!0,configurable:!0}),Object.defineProperty(Sn.prototype,"translateService",{get:function(){return this.translate},enumerable:!0,configurable:!0}),Sn.updateErrors=function(n,r,i,o,a){Object.keys(Sn.insMap).forEach(function(t){var e=Sn.insMap[t];e&&(i&&e.setControlValue(n,o),e.enableValidate&&e.isFormValid(n,r,i,a))})},Sn.prototype.setIsShowmap=function(t){this.isShowPropMap[t]=!0},Sn.prototype.setShowValidationMsg=function(t){this.raisedByValidateEffector=!1,this.isShowValidationMsg=t},Sn.prototype.setControlValue=function(t,e){var n=this.bindingData&&this.bindingData.getObject()||null;n&&n.controlMap&&(n.controlMap[t]=this.getGridItemControl(t,e))},Sn.prototype.getCardControlErrors=function(t){return this.setIsShowmap(t),this.cardControls[t]&&this.cardControls[t].errors},Sn.prototype.getFormControlErrors=function(t){return this.cardControls[t]&&this.cardControls[t].errors},Sn.prototype.getGridControlErrors=function(t,e){return this.setIsShowmap(t),this.controlIdMap[e]&&this.controlIdMap[e][t]&&this.controlIdMap[e][t].errors},Sn.prototype.isFormValid=function(t,a,e,n){var s=this,r="";if(!this.raisedByValidateEffector){if(!0===n){var i=this.bindingPath.split("/").filter(function(t){return t});0<i.length&&(r=i.join(".").concat("."))}var o=this.getDomPropertyNameByEntityProp(t,r);if(t&&!o)return!0;if(o&&!this.isShowPropMap[o])return!0;var p=!0,u=this.bindingData.getObject(),c=u.primaryKeyValue,l="/"!==this.bindingPath,f=this.bindingData.getList();if(l&&0===f.innerList.size)return!0;if(!c)return!0;if(e&&o&&(this.controlIdMap[e]=this.controlIdMap[e]||{},this.controlIdMap[e][o]={errors:a}),!e||e===c)return t||e||(u.controlMap={},this.controlIdMap={},this.cardControls={}),Object.keys(this.controls).forEach(function(t){if(!0===s.isShowPropMap[t])return t===o&&(a&&0<Object.keys(a).length?n||(Object.keys(a).map(function(t){var e=a[t]&&a[t].error||null;if(e){var n=e.rule,r=s.getngFormControlByBinding(n.property);if(r){n.property=r.name,n.targetId=r.id,n.targetName=s.formGroupName;var i=vt.getMessage(t),o=bt.replaceMessageSpecialTokens(i,n,r.name);a[t].name=o}}}),s.cardControls[t]={errors:a}):s.cardControls[t]={}),s.controls[t]&&s.controls[t].errors&&0<Object.keys(s.controls[t].errors).length?(s.cardControls[t]={errors:E({},s.cardControls[t]&&s.cardControls[t].errors,s.controls[t].errors)},s.cardControls&&Object.keys(s.cardControls).forEach(function(o){s.cardControls[o]&&s.cardControls[o].errors&&Object.keys(s.cardControls[o].errors).forEach(function(e){if("object"!=typeof s.cardControls[o].errors[e]){var t=s.ngFormControls[o].validRules||[],n=[].concat(t).find(function(t){return t.type===e});if(n){n.targetName=s.formGroupName;var r=vt.getMessage(e),i=bt.replaceMessageSpecialTokens(r,n,"");s.cardControls[o].errors[o]={value:s.controls[o]&&s.controls[o].value||"",name:i}}}})}),p=!1):void 0}),Object.keys(this.cardControls).forEach(function(t){if(s.cardControls[t]&&s.cardControls[t].errors&&0<Object.keys(s.cardControls[t].errors).length)return p=!1}),p}},Sn.prototype.updateFormErrors=function(e,t,n){var r=this;void 0===t&&(t=!1),void 0===n&&(n=""),n&&"backend"===n&&this.clearBackendError(),!0!==this.isShowValidationMsg&&!0!==t||(this.isShowValidationMsg=!0,Object.keys(e).forEach(function(t){e[t].errors&&0<Object.keys(e[t].errors).length?r.cardControls[t]={errors:E({},r.cardControls[t]&&r.cardControls[t].errors,e[t].errors)}:(r.cardControls[t]={errors:{}},r.controls[t].setErrors(null),r.controls[t].markAsTouched())}))},Sn.prototype.clearBackendError=function(){var n=this;Object.keys(this.cardControls).forEach(function(t){var e=n.cardControls[t]&&n.cardControls[t].errors||null;e?(Object.keys(e).forEach(function(t){t&&t.startsWith("backend-message-")&&delete e[t]}),e&&0===Object.keys(e).length&&delete n.cardControls[t].errors):n.cardControls[t]={}})},Sn.prototype.getngFormControlByBinding=function(e){return Object.values(this.ngFormControls).find(function(t){return t.binding&&t.binding===e})},Sn.prototype.getErrorMessage=function(t,e){var n=this.ngFormControls[t];if(n){var r=n.validRules,i=[];Array.isArray(r)?i.push.apply(i,b(r)):i.push(r);var o=i.find(function(t){return t.type===e});if(o){var a=n.name,s=vt.getMessage(e);return bt.replaceMessageSpecialTokens(s,o,a)}return null}return null},Sn.prototype.init=function(t,e,n){this.frameContext=n,this.bindingData=t,this.bindingPath=e,this.buildForm(),Sn.insMap[this.constructor.name]=this},Sn.prototype.buildForm=function(){this.collectMetadatas(),this.createChildForms(),this.createControls()},Sn.prototype.resetCardValidMsg=function(){var e=this;this.cardControls={},Object.keys(this.controlIdMap).forEach(function(t){e.bindingData.getList().innerList.map(function(t){return t.id}).includes(t)||delete e.controlIdMap[t]}),this.resetFormControls(),this.setShowValidationMsg(!1)},Sn.prototype.updateFieldValidateRule=function(n,t){var r=this,e=this.controls[n];e&&(e.clearValidators(),e.markAsUntouched(),e.markAsPristine(),e.setErrors([]));var i=this.ngFormControls[n],o=i&&i.validRules||[];Array.isArray(o)||(o=[o]);var a=o.findIndex(function(t){return t.type===vt.REQUIRED});if(t){if(-1==a){var s={type:vt.REQUIRED,constraints:[!0]},p=i&&(i.name||i.defaultI18nValue)||"";s.targetId=i&&i.id||null,s.targetName=this.formGroupName,s.property=p,s.field=i&&i.binding,o.push(s)}}else-1!==a&&o.splice(a,1);var u=[];Array.prototype.forEach.call(o,function(t){var e=r.getValidatorByRuleObj(t,r.ngFormControls[n]);e&&u.push(e)}),this.ngFormControls[n].validRules=o,this.controls[n].setValidators(u)},Sn.prototype.addFieldValidateRule=function(t,e,n,r){var i=this.controls[t];i&&i.setErrors(null);var o=this.ngFormControls[t],a=this.ngFormControls[t].validRules;a=a||[],Array.isArray(a)||(a=[a]);var s=a.findIndex(function(t){return t&&t.expressionId===n});-1!==s&&a.splice(s,1);var p=this.frameContext.viewModel.bindingPath.split("/").filter(function(t){return t});0!==p.length&&(p.join("/"),(o.binding||"").split(".").join("/"));var u=this.frameContext,c={type:r,message:e,expressionId:n,constraints:[],bindingPath:p.join("/"),eval:function(t){return u.viewModel.expression.validate(n,t)}};a.push(c),this.ngFormControls[t].validRules=a},Sn.prototype.getValidatorByRuleObj=function(l,f){var h=this,t=l.type,e=l.constraints,a=void 0===e?[]:e,n=l.message,o=void 0===n?null:n;return f.name||f.defaultI18nValue,{required:function(t){var e=t.value,n=""!==e&&null!==e&&e!==undefined&&"0001-01-01"!==e&&"0001-01-01 00:00:00"!==e&&"0001-01-01T00:00:00"!==e,r=h.bindingPath.split("/").filter(function(t){return t}),i=f.binding.split("."),o=r.concat(i),a=h.getPropInfoByPath(o);if(a&&a.metadataInfo.enableMultiLangInput){var s=Mt.getCurrentLanguage(),p=e&&e[s];n=""!==p&&null!==p&&p!==undefined&&"0001-01-01"!==p&&"0001-01-01 00:00:00"!==p&&"0001-01-01T00:00:00"!==p}var u=vt.getMessage(vt.REQUIRED),c=bt.replaceMessageSpecialTokens(u,l,t.value);return n&&t.errors&&t.errors.required&&(delete t.errors.required,h.isFormValid(o.join("."))),n?null:{required:{value:t.value,name:c}}},maxLength:function(t){var e=t.value&&t.value.toString().length>a[0],n=vt.getMessage(vt.MAX_LENGTH),r=bt.replaceMessageSpecialTokens(n,l,t.value);return e?{maxLength:{value:t.value,name:r}}:null},minLength:function(t){var e=t.value&&t.value.toString().length<a[0],n=vt.getMessage(vt.MAX_LENGTH),r=bt.replaceMessageSpecialTokens(n,l,t.value);return e?{minLength:{value:t.value,name:r}}:null},minValue:function(t){var e=!1,n="";if(null===t.value||t.value===undefined)return null;if("number"==typeof t.value&&"number"==typeof a[0]){e=t.value<a[0];var r=vt.getMessage(vt.MINVALUE);n=bt.replaceMessageSpecialTokens(r,l,t.value)}else if(f&&!0===f.bigNumber){var i=new y.BigNumber(a[0]),o=new y.BigNumber(t.value);e=i.isGreaterThan(o),r=vt.getMessage(vt.MINVALUE),n=bt.replaceMessageSpecialTokens(r,l,t.value)}else{if(r=vt.getMessage(vt.MIN_DATE),!a||a.length<1||!a[0])return null;e=t.value instanceof Date?t.value<new Date(a[0]):new Date(t.value)<new Date(a[0]),n=bt.replaceMessageSpecialTokens(r,l,t.value)}return e?{minValue:{value:t.value,name:n}}:null},maxValue:function(t){var e=!1,n="";if(null===t.value||t.value===undefined)return null;if("number"==typeof t.value&&"number"==typeof a[0]){e=t.value>a[0];var r=vt.getMessage(vt.MAXVALUE);n=bt.replaceMessageSpecialTokens(r,l,t.value)}else if(f&&!0===f.bigNumber){var i=new y.BigNumber(a[0]),o=new y.BigNumber(t.value);e=i.isLessThan(o),r=vt.getMessage(vt.MAXVALUE),n=bt.replaceMessageSpecialTokens(r,l,t.value)}else r=vt.getMessage(vt.MAX_DATE),e=t.value instanceof Date?t.value>new Date(a[0]):new Date(t.value)>new Date(a[0]),n=bt.replaceMessageSpecialTokens(r,l,t.value);return e?{maxValue:{value:t.value,name:n}}:null},exclude:function(t){var e="string"==typeof t.value&&!h.validatorJs.contains(t.value,a[0]),n=vt.getMessage(vt.EXCLUDE),r=bt.replaceMessageSpecialTokens(n,l,t.value);return e?null:{exclude:{value:t.value,name:r}}},matches:function(t){var e=null===t.value||t.value===undefined?"":t.value.toString(),n=""===e||h.validatorJs.matches(e,a[0]),r=o;if(!r){var i=vt.getMessage(vt.MATCHES);r=bt.replaceMessageSpecialTokens(i,l,t.value)}return n?null:{matches:{value:t.value,name:r}}}}[t]},Sn.prototype.collectMetadatas=function(){this.ngValidateForm=this.frameContext.metadata.form?O.translateMetadataByName(this.frameContext.metadata.form,this.translateService,["formGroupName"]):O.getClassMetadataByNameWithTranslate(this.constructor,se,this.translateService,["formGroupName"]),this.ngFormControls=this.collectionFormControlMetadats(this.frameContext.metadata.formControls),this.ngChildForms=this.frameContext.metadata.subForms||O.getPropsMetadatasByName(this.constructor,pe)},Sn.prototype.collectionFormControlMetadats=function(t){var i=this;void 0===t&&(t=null);var o=t?O.translateMetadataByName(t,this.translateService,["name"]):O.getPropsMetadatasByNameWithTranslate(this.constructor,fe,this.translateService,["name"]);return o&&Object.keys(o).forEach(function(t){var e=o[t],n=e.name||e.defaultI18nValue||"",r=e.id;Array.isArray(e.validRules)&&e.validRules.forEach(function(t){t.targetId=r,t.targetName=i.formGroupName,t.property=n,t.field=e.binding})}),o},Sn.prototype.getGridItemControl=function(t,e){var n,r,i=this;return n=t,r=[],i.ngFormControls[n]&&Array.isArray(i.ngFormControls[n].validRules)&&Array.prototype.forEach.call(i.ngFormControls[n].validRules,function(t){var e=i.getValidatorByRuleObj(t,i.ngFormControls[n]);e&&r.push(e)}),new a.FormControl(e,{validators:r,updateOn:"blur"})},Sn.prototype.getDomPropertyNameByEntityProp=function(e,n){var r=this;void 0===n&&(n="");var i="";return Object.keys(this.ngFormControls).forEach(function(t){""+n+r.ngFormControls[t].binding===e&&(i=t)}),i},Sn.prototype.createControls=function(){var o=this;Object.keys(this.ngFormControls).forEach(function(n){var t=o.ngFormControls[n],r=[];Array.isArray(o.ngFormControls[n].validRules)&&Array.prototype.forEach.call(o.ngFormControls[n].validRules,function(t){var e=o.getValidatorByRuleObj(t,o.ngFormControls[n]);e&&r.push(e)});var e=t.updateOn?t.updateOn:"blur",i=new a.FormControl(null,{validators:r,updateOn:e});t.binding&&o.setUpBindingDataPipeline(i,t.binding,t.valueConverter),o.controls[n]=i,o[n]=i})},Sn.prototype.createChildForms=function(){var n=this;Object.keys(this.ngChildForms).forEach(function(t){var e=new n.ngChildForms[t].formType;e.init(n.bindingData,n.bindingPath,n.frameContext),n.controls[t]=e,n[t]=e})},Sn.prototype.addControls=function(t,e){var n=t&&t.editor&&t.editor.updateOn?t.editor.updateOn:"blur",r=new a.FormControl("",{updateOn:n}),i=t.dataField;t.editor&&t.editor.binding&&(this.setUpBindingDataPipeline(r,i,e),this.controls[t.editor.binding.path]=r,this[t.editor.binding.path]=r)},Sn.prototype.setUpBindingDataPipeline=function(a,i,s){var p=this;if(!this.bindingData)throw Error("当前组件上下文中找不到BindingData，请检查！");s&&(s.__FRAME_CONTEXT__=this.frameContext),1<this.bindingPath.length&&(i=this.bindingPath.substr(1).replace(/\//g,".")+"."+i);var u=i.split("."),c=u[u.length-1],t=this.getValueFromBindingData(u,s);a.setValue(t),this.bindingData.changes.pipe(l.filter(function(t){var e=p.bindingData.getObject(),n=t.path.join(".");if(t.isUdt)return n===i;if(t.type===x.ChangeType.ValueChanged)return n===i;if(t.type!==x.ChangeType.Load&&t.type!==x.ChangeType.SelectionChanged&&t.type!==x.ChangeType.Remove&&t.type!==x.ChangeType.Update)return t.type===x.ChangeType.UpdateErrors&&(n===i?(p.cardControls[c]=p.cardControls[c]||{},i&&p.controls[c]&&e.primaryKeyValue===t.id&&(p.cardControls[c].errors=t.errors),t.path&&i&&t.errors||(p.cardControls[c].errors=null,p.isFormValid(i)),!1):void 0);var r=""===n?n:n+".";return t&&t.type===x.ChangeType.Load&&p.resetCardValidMsg(),0===i.indexOf(r)})).subscribe(function(t){var e=c,n="";t.isUdt&&(t.isGrid&&t.path.shift(),t.path.length&&(n=t.path.join(".")),e=n);var r=p.bindingData.getValue(u,!1),i=s?s.convertFrom(r):r,o=p.getDomPropertyNameByEntityProp(e);p.cardControls[o]=p.cardControls[o]||{},t.errors&&(p.cardControls[o].errors=t.errors),t.id&&(p.controlIdMap[t.id]&&0===Object.keys(p.controlIdMap[t.id]).length&&(p.controlIdMap[t.id]={}),p.controlIdMap[t.id]=p.controlIdMap[t.id]||{},t.errors&&(p.controlIdMap[t.id][o]={errors:t.errors})),JSON.stringify(a.value)!==JSON.stringify(i)&&a.setValue(i)}),a.valueChanges.subscribe(function(t){var e=p.bindingData.getValue(u);if(t&&t.constructor&&"Date"===t.constructor.name&&e&&s){var n=s.convertFrom(e);if(!0===p.compareDate(t,n))return}if(!0!==p.isDate(s)||!0!==It.isEqual(t,e)){var r=s?s.convertTo(t):t;if(JSON.stringify(e)!==JSON.stringify(r)){p.clearBackEndMessages(c);var i=p.frameContext.appContext.runMode===x.RunMode.highSpeed;p.bindingData.setValue(u,r,i,!0,null,{frameContext:p.frameContext})}}})},Sn.prototype.isDate=function(t){var e=!1;return t&&!0===t.hasOwnProperty("format")&&(e=!0),e},Sn.prototype.compareDate=function(t,e){return t&&e?t.getFullYear()===e.getFullYear()&&t.getMonth()===e.getMonth()&&t.getDate()===e.getDate()&&t.getHours()===e.getHours()&&t.getMinutes()===e.getMinutes()&&t.getSeconds()===e.getSeconds():t===e},Sn.prototype.getPropInfoByPath=function(t){var e=this.frameContext&&this.frameContext.repository.entityType||null;return e?new Ve(e).getPropInfoByPath(t):null},Sn.prototype.getValueFromBindingData=function(t,e){var n=this.bindingData.getValue(t);return e?e.convertFrom(n):n},Sn.prototype.getEntityValueChangingListeners=function(){var n=this,r={};return Object.keys(this.ngFormControls).forEach(function(t){var e=n.ngFormControls[t];e.valueChanging&&(r[e.binding]=e.valueChanging)}),r},Sn.prototype.getEntityValueChangedListeners=function(){var n=this,r={};return Object.keys(this.ngFormControls).forEach(function(t){var e=n.ngFormControls[t];e.valueChanged&&(r[e.binding]=e.valueChanged)}),r},Sn.prototype.getValidationRules=function(){var a=this,s=new Map,p=this.bindingPath;return p.length&&"/"===p&&(p=""),Object.keys(this.ngFormControls).forEach(function(t){if(!0===a.isShowPropMap[t]||0===Object.keys(a.isShowPropMap).length){var e=a.ngFormControls[t],n=e.name||e.defaultI18nValue||"",r=e.binding?e.binding.split("."):[t],i=b([p],r).join("/");if(Array.isArray(e.validRules)&&0<e.validRules.length){var o=b(e.validRules);o.forEach(function(t){t.targetId=e.id,t.targetName=a.formGroupName,t.property=n,t.field=e.binding,t.fullPath=i,a.frameContext&&(t.frameContext=a.frameContext)}),s.set(i,o)}else s.set(i,[{type:"setDisplayInfo",targetId:e.id,targetName:a.formGroupName,property:n,fullPath:i,frameContext:a.frameContext}])}}),s},Sn.prototype.setTranslateService=function(t){t&&(this.translate=t,vt.setCurrentLanguage(t.getCurrentLanguage()))},Sn.prototype.resetFormControls=function(){var n=this;0<Object.keys(this.controls).length&&Object.keys(this.controls).forEach(function(t){var e=n.controls[t];e.markAsUntouched(),e.markAsPristine()})},Sn.prototype.clearBackEndMessages=function(t){var r=this;if(t){if(this.cardControls[t]&&this.cardControls[t].errors&&Object.keys(this.cardControls[t].errors).find(function(t){return t.startsWith("message-")})){var e=Object.keys(this.cardControls[t].errors).filter(function(t){return t.startsWith("message-")}),n=E({},this.cardControls[t].errors);e.forEach(function(t){return delete n[t]}),this.cardControls[t]={errors:n}}}else Object.keys(this.cardControls).forEach(function(t){if(r.cardControls[t]&&r.cardControls[t].errors&&Object.keys(r.cardControls[t].errors).find(function(t){return t.startsWith("message-")})){var e=Object.keys(r.cardControls[t].errors).filter(function(t){return t.startsWith("message-")}),n=E({},r.cardControls[t].errors);e.forEach(function(t){return delete n[t]}),r.cardControls[t]={errors:n}}})},Sn.insMap={},Sn.decorators=[{type:d.Injectable}],Sn.ctorParameters=function(){return[]},Sn);function Sn(){var t=wn.call(this,{},null,null)||this;return t.raisedByValidateEffector=!1,t.isShowValidationMsg=!1,t.validatorJs=n,t.controlIdMap={},t.cardControls={},t.isShowPropMap={},t}var Nn=(Dn.loadEntity=function(i,o){var a=this;o.properties.forEach(function(t){var e=t.name;if(t.type===x.BindingPropertyType.List)a.loadEntityList(i[e]||i[ut],o[e]);else if(t.type===x.BindingPropertyType.Object)i&&i[e]&&a.loadEntity(i[e],o[e]);else if(t.type===x.BindingPropertyType.Dynamic){if(i&&i[e]){var n=oe.createDynamicBindingObject(i[e].data);oe.attachDynamicObjectProperty(o,e,n),a.loadEntity(i[e],o[e])}}else{var r=i[e];o.setValue(e,r,!1,!1)}}),this.setUpEntityPipeline(i,o)},Dn.setUpEntityPipeline=function(h,a){h.onValueChanged.pipe(l.takeUntil(h.unsubscribe)).subscribe(function(t){if(t.type===x.ModifyType.ValueChange&&0!==t.path.length){var e=t.path[t.path.length-1],n=t.path[t.path.length-2];if(a.primaryKey&&"id"===a.primaryKey){var r=a.primaryKey;if(n!==r+":"+a.getValue(r))return}if(t.dynamic){if(a.__original__)return;var i=t.value,o=a[e];if(!o)return;Object.keys(i).forEach(function(t){o.getValue(t)!==i[t]&&o.setValue(t,i[t],!0,!1)})}else{if(a.getValue(e)===t.value)return;a.setValue(e,t.value,!0,!1,t.errors)}}}),a.viewChanges.pipe(l.takeUntil(a.unsubscribe)).subscribe(function(s){var e,n,p=s.value,u=s.path[0],t="",c=h.getPaths(),r=c.path,l=a.id;a.__original__=!0,e="",(n=function(t){t&&t&&t.id?e=t.id:t.parent&&n(t.parent)})(a),l=e,r.length&&(t=r.join(".")+".");var f=t+u,i=function(a){Object.values(On.insMap).find(function(t){return t&&t.enableValidate})?h.validateFromUtilSync(u,p,function(t){var e,n={};t.errors&&0<t.errors.length&&t.errors.forEach(function(e){e.constraints&&Object.keys(e.constraints).forEach(function(t){n[t]={value:p,name:e.constraints[t],error:e}})}),On.updateErrors(f,n,l,p,c.isGrid);var r=s.errors||{},i=Object.assign({},r,n),o=null;0<Object.keys(i).length&&((e={})[u]=i,o=e),"function"==typeof a&&a(o)},s.context):"function"==typeof a&&a(null)};if(a.primaryKey){var o=a.primaryKey;if(u!==o){if(!h[o]||h[o]!==a[o])return void i()}else if(h[u]!==p)return h[u]=p,void i()}h[u]!==p?i(function(t){h.errors=t,h[u]=p}):i()})},Dn.loadEntityList=function(t,e){this.loadEntities(t.items,e),this.setUpEntityListPipeline(t,e)},Dn.setUpEntityListPipeline=function(v,m){var E=this;v.onListChanged.subscribe(function(t){var e=t.target;if(!e||e===v)switch(t.type){case x.ModifyType.Add:case x.ModifyType.Clone:if(0===t.value.length)return;var n=t.path,r=n[n.length-2],i=m.parent.primaryKeyValue;if(-1===r.indexOf(i))return;E.appendEntities(t.value,m,t.type===x.ModifyType.Clone);break;case x.ModifyType.Insert:var o=t.path,a=o[o.length-2],s=m.parent.primaryKeyValue,p=t.position;if(-1===a.indexOf(s))return;E.insertEntity(t.value[0],m,p);break;case x.ModifyType.Remove:var u=t.path,c=u[u.length-2],l=m.parent.primaryKeyValue;if(-1===c.indexOf(l))return;var f=t.value[m.primaryKey];m.removeByIds([f]);break;case x.ModifyType.Load:var h=t.path,y=h[h.length-2],d=m.parent.primaryKeyValue;if(-1===y.indexOf(d))return;var g=t.value;E.loadEntities(g,m)}})},Dn.loadRepository=function(n,e){var r=this,t=Array.from(n.entityCollection.toArray());this.loadEntities(t,e),n.entityCollectionChange.subscribe(function(t){switch(t.type){case x.ModifyType.Load:e.clear(!0),r.loadEntities(t.value,e,t.entityCreate);break;case x.ModifyType.Add:case x.ModifyType.Clone:r.appendEntities(t.value,e,t.type===x.ModifyType.Clone);break;case x.ModifyType.AddData:r.addData(t.value,e);break;case x.ModifyType.Insert:r.insertEntity(t.value,e,t.position);break;case x.ModifyType.Remove:r.removeEntities(t.value,e);break;case x.ModifyType.RemoveData:r.removeData(t.value,e);break;case x.ModifyType.PaginationInfoChange:e.paginationInfo=t.value}}),e.changes.subscribe(function(t){if(t.type===x.ChangeType.PaginationInfoChange){var e=n.entityCollection;e.paginationInfo=Object.assign({},e.paginationInfo,t.value)}})},Dn.loadEntities=function(t,e,n){void 0===n&&(n=!1);var r=this.createBindingObjects(t,e);e.load(r,n)},Dn.appendEntities=function(t,e,n){void 0===n&&(n=!1);var r=this.createBindingObjects(t,e);e.append(r,n)},Dn.addData=function(t,e){var n=this.createBindingObjects(t,e);e.addData(n)},Dn.insertEntity=function(t,e,n){var r=this.createBindingObject(t,e);e.insert(r,n)},Dn.removeEntities=function(t,e){if(null!==t&&0!==t.length){var n=e.primaryKey,r=[];t.forEach(function(t){r.push(t[n])}),e.removeByIds(r)}},Dn.removeData=function(t,e){if(null!==t&&0!==t.length){var n=e.primaryKey,r=[];t.forEach(function(t){r.push(t[n])}),e.removeDataByIds(r)}},Dn.createBindingObjects=function(t,n){var r=this;if(null===t||0===t.length)return[];var i=[];return t.forEach(function(t){var e=oe.create(n.properties);r.loadEntity(t,e),i.push(e)}),i},Dn.createBindingObject=function(t,e){var n=oe.create(e.properties);return this.loadEntity(t,n),n},Dn.watchReposiroty=function(t,e){t.entityCollectionChange.subscribe(function(t){switch(t.type){case x.ModifyType.PaginationInfoChange:e.pagingInfo=t.value}})},Dn.getPropInfo=function(t,e){var n,r,i=it.getNgFields(t);Object.keys(i).forEach(function(t){t===e&&(n="NgField",r=null)});var o=it.getNgObjects(t);Object.keys(o).forEach(function(t){t===e&&(n="NgObject",r=o[t].type)});var a=it.getNgList(t);Object.keys(a).forEach(function(t){t===e&&(n="NgList",r=a[t].type)});var s=it.getNgDynamic(t);return Object.keys(s).forEach(function(t){t===e&&(n="NgDynamic",r=s[t].type)}),{propType:n,propEntityType:r}},Dn.getPrimaryKey=function(t){var e=it.getPrimaryFieldMetadata(t);return e?e.dataField:""},Dn.isObjectProp=function(t,e){var n=!1,r=it.getNgObjects(t);return Object.keys(r).forEach(function(t){t===e&&(n=!0)}),n},Dn.isDynamicProp=function(t,e){var n=!1,r=it.getNgDynamic(t);return Object.keys(r).forEach(function(t){t===e&&(n=!0)}),n},Dn.appendInitialData=function(t,e){var n=Object.assign({},e);delete n.id,delete n.parentID,t.initialData=n},Dn);function Dn(){}var Vn=(Object.defineProperty(Fn.prototype,"pagingInfo",{get:function(){return this.paginationInfo},set:function(t){this.paginationInfo=t,this.firePagingChangeEvent()},enumerable:!0,configurable:!0}),Fn.prototype.setPagingInfo=function(t,e,n){if(n.length<1||"/"===n)this.paginationInfo=Object.assign(this.paginationInfo,{pageSize:e,pageIndex:t/e+1});else{var r=this.paginationInfo||{},i=n.substr(1).split("/").filter(function(t){return!!t&&0<t.length}),o=i[i.length-1];o=o.substr(0,o.length-1);var a=i.slice(0,i.length-1),s=this.getValue(a);s&&s[s.primaryKey]&&((r=r[""+o]||{}).pageIndex=(t/e||0)+1,r.pageSize=e||0)}this.firePagingChangeEvent()},Fn.prototype.updatePagingInfo=function(t,e){if(e.length<1||"/"===e)this.paginationInfo=Object.assign(this.paginationInfo,t);else{var n=this.paginationInfo||{},r=e.substr(1).split("/").filter(function(t){return!!t&&0<t.length}),i=r[r.length-1];n[i=i.substr(0,i.length-1)]=Object.assign(n[i],t)}this.firePagingChangeEvent()},Fn.prototype.firePagingChangeEvent=function(){this.list.changes.next({type:x.ChangeType.PaginationInfoChange,path:this.bindingPath&&this.bindingPath.split("/").filter(function(t){return t})||[],value:this.paginationInfo})},Object.defineProperty(Fn.prototype,"changes",{get:function(){return this.list.changes},enumerable:!0,configurable:!0}),Fn.prototype.setValueChangeInvokerFactory=function(t){this.valueChangeInvokerFactory=t},Fn.prototype.getValudChangeInvokerFactory=function(){return this.valueChangeInvokerFactory},Fn.prototype.init=function(t,e){this.initByRepository(t,e)},Fn.prototype.initByRepository=function(t,e){this.bindingPath=e,this.properties=Jt.getProperties(t.entityType),this.list=ee.create(this.properties),this.pagingInfo=t.entityCollection.paginationInfo,Nn.loadRepository(t,this.list),this.dataTypeInfo=t.entityTypeInfo,this.extendProperties(this.properties)},Fn.prototype.initByBindingList=function(t,e){this.list=t,this.bindingPath=e,this.extendProperties(this.list.properties)},Fn.prototype.setDataTypeInfo=function(t){this.dataTypeInfo=t},Fn.prototype.getValue=function(t,e){void 0===e&&(e=!1);var n=this.list;if(t.forEach(function(t){n=n&&n[t]}),!0===e&&t&&0<t.length){var r=this.getInitValueByPaths(t);n===undefined&&n!==r&&(n=r)}return n},Fn.prototype.setValue=function(t,e,n,r,i,o){if(void 0===n&&(n=!1),void 0===r&&(r=!0),void 0===i&&(i={}),!t||0===t.length)throw Error("路径不能为空");var a=t.slice(0,t.length-1),s=t[t.length-1],p=this.getValue(a);if(!p)throw Error("找不到要设置的对象");p instanceof Fn?p=p.list.currentItem:p instanceof Rn&&(p=p.currentItem),this.valueChangeInvokerFactory?p.setValue(s,e,n,r,i,this.valueChangeInvokerFactory(t),o):p.setValue(s,e,n,r,i,null,o)},Fn.prototype.clearValue=function(t,e,n,r){var i;void 0===e&&(e=!1),void 0===n&&(n=!0);var o=this.dataTypeInfo.getPropInfoByPath(t);i=o&&o.metadataInfo&&o.metadataInfo.initValue!==undefined?o.metadataInfo.initValue:"number"==typeof this.getValue(t)?0:"",this.setValue(t,i,e,n,null,r)},Fn.prototype.getList=function(){if(!this.bindingPath||"/"===this.bindingPath)return this.list;var t=this.bindingPath.substr(1).split("/").filter(function(t){return""!==t});return this.getValue(t)},Fn.prototype.getObject=function(){return this.getList().currentItem},Fn.prototype.getPath=function(t){var n=this,e=t.filter(function(t){return t}),r=[this.list.primaryKey+":"+this.list.currentId];return e.forEach(function(t){r.push(t);var e=n[t];e&&r.push(e.primaryKey+":"+e.currentId)}),r},Fn.prototype.reset=function(){this.list.clear()},Fn.prototype.getInitValueByPaths=function(t){var e,n=this.dataTypeInfo&&this.dataTypeInfo.getPropInfoByPath(t)||null;return n&&n.metadataInfo&&n.metadataInfo.initValue!==undefined&&(e=n.metadataInfo.initValue),e},Fn.prototype.extendProperties=function(t){var n=this;t.forEach(function(t){var e=t.name;Object.defineProperty(n,e,{get:function(){return n.list.currentItem[e]},set:function(t){n.list.currentItem[e]=t}})})},Fn.decorators=[{type:d.Injectable}],Fn);function Fn(){this.paginationInfo=null}var Rn=(Object.defineProperty(Bn.prototype,"paginationInfo",{get:function(){return this._paginationInfo},set:function(t){this._paginationInfo=t,this._paginationInfo!==t&&this.changes.next({type:x.ChangeType.PaginationInfoChange,path:[],value:this._paginationInfo})},enumerable:!0,configurable:!0}),Object.defineProperty(Bn.prototype,"pageIndex",{get:function(){return this.paginationInfo&&this.paginationInfo.hasOwnProperty("pageIndex")?this.paginationInfo.pageIndex:1},enumerable:!0,configurable:!0}),Object.defineProperty(Bn.prototype,"pageSize",{get:function(){return this.paginationInfo&&this.paginationInfo.hasOwnProperty("pageSize")?this.paginationInfo.pageSize:0},enumerable:!0,configurable:!0}),Object.defineProperty(Bn.prototype,"total",{get:function(){return this.paginationInfo?this.paginationInfo.total||this.paginationInfo.totalCount:0},enumerable:!0,configurable:!0}),Object.defineProperty(Bn.prototype,"skip",{get:function(){return(this.pageIndex-1)*this.pageSize},enumerable:!0,configurable:!0}),Bn.prototype.setPaginationInfo=function(t,e){this.paginationInfo=Object.assign({},this.paginationInfo,{pageSize:e,pageIndex:t/e+1})},Object.defineProperty(Bn.prototype,"currentItem",{get:function(){var t=this.findById(this.currentId);return t||(this.emptyCurrentItem||(this.emptyCurrentItem=oe.create(this.properties)),this.emptyCurrentItem)},enumerable:!0,configurable:!0}),Object.defineProperty(Bn.prototype,"length",{get:function(){return this.innerList.count()},enumerable:!0,configurable:!0}),Bn.prototype[Symbol.iterator]=function(){var t=this,e=-1,n=this.innerList.size;return{next:function(){return++e<n?{done:!1,value:t.innerList.get(e)}:{done:!0,value:undefined}}}},Bn.prototype.load=function(t,e){var n=this;if(void 0===e&&(e=!1),this.innerList=this.innerList.clear(),0!==t.length){if(t.forEach(function(t){n.add(t)}),!this.findById(this.currentId)){var r=t[0][this.primaryKey];this.setCurrentId(r,!1,!1)}}else this.currentId=null;var i={type:x.ChangeType.Load,path:[],value:t};i.create=e,this.changes.next(i)},Bn.prototype.append=function(t,e){var n=this;if(void 0===e&&(e=!1),0!==t.length){t.forEach(function(t){n.add(t)});var r=t[t.length-1][this.primaryKey];this.setCurrentId(r,!0,!0);var i={type:x.ChangeType.Append,path:[],value:t};e&&(i.isCloned=!0),this.changes.next(i)}},Bn.prototype.addData=function(t){var e=this;0!==t.length&&(t.forEach(function(t){e.add(t)}),this.changes.next({type:x.ChangeType.Append,path:[],value:t}))},Bn.prototype.insert=function(t,e){var n=this,r=this.innerList.findIndex(function(t){return t.primaryKeyValue===n.currentId});this.innerList=1===e?this.innerList.insert(r+1,t):-1===e?this.innerList.insert(r,t):this.innerList.push(t),t.parent=this,t.changes.subscribe(function(t){n.changes.next(t)}),this.setCurrentId(t.primaryKeyValue,!0,!0),this.changes.next({type:x.ChangeType.Append,path:[],value:t})},Bn.prototype.add=function(t){var e=this;this.innerList=this.innerList.push(t),t.parent=this,t.changes.subscribe(function(t){e.changes.next(t)})},Bn.prototype.removeByIds=function(t){var n=this;if(t&&0!==t.length){var r=this.currentId;t.forEach(function(t){t===r&&(r=n.getCurrentIdBeforeDeleting());var e=n.getIndexById(t);-1!==e&&(n.innerList=n.innerList["delete"](e))}),0===this.innerList.count()?this.currentId=null:this.setCurrentId(r,!1,!1),this.changes.next({type:x.ChangeType.Remove,path:[],value:t})}},Bn.prototype.removeDataByIds=function(t){var n=this;t&&0!==t.length&&(t.forEach(function(t){var e=n.getIndexById(t);-1!==e&&(n.innerList=n.innerList["delete"](e))}),this.changes.next({type:x.ChangeType.Remove,path:[],value:t}))},Bn.prototype.clear=function(t){void 0===t&&(t=!1),this.innerList.forEach(function(t){t.unsubscribe.next(),t.unsubscribe.complete(),t.changes.complete(),t.viewChanges.complete()}),this.innerList=this.innerList.clear(),this.currentId=null,t||this.changes.next({type:x.ChangeType.Remove,path:[],value:[]})},Bn.prototype.getCurrentIdBeforeDeleting=function(){var t=-1,e=this.getIndexById(this.currentId);return t=e===this.length-1?e-1:e+1,this.getIdByIndex(t)},Bn.prototype.findById=function(e){var t,n=this;return(t=this.innerList.find(function(t){return t.getValue(n.primaryKey)===e}))===undefined?null:t},Bn.prototype.setCurrentId=function(t,e,n,r){void 0===e&&(e=!0),void 0===n&&(n=!0),void 0===r&&(r=!1),this.currentId===t&&!r||(this.findById(t)||r)&&(this.currentId=t,!0===e&&this.changes.next({type:x.ChangeType.SelectionChanged,path:[],value:this.currentItem,force:r}),!0===n&&this.changes.next({type:x.ChangeType.GlobalSelectionChanged,path:[],value:this.currentItem,force:r}))},Bn.prototype.getIndexById=function(e){var n=this;return this.innerList.findIndex(function(t){return t[n.primaryKey]===e})},Bn.prototype.getIdByIndex=function(t){return t<0||t>this.length||!1===this.innerList.has(t)?null:this.innerList.get(t)[this.primaryKey]},Bn.prototype.toArray=function(){return this.innerList.toArray()},Bn.prototype.swapById=function(n,r){var i=this.innerList.find(function(t){return t.primaryKeyValue===n}),o=this.innerList.find(function(t){return t.primaryKeyValue===r});this.innerList=this.innerList.map(function(t,e){return t.primaryKeyValue===n?o:t.primaryKeyValue===r?i:t}).toList(),this.changes.next({type:x.ChangeType.Swap,path:[]})},Bn.prototype.toJSON=function(e){var n=[];return this.innerList.forEach(function(t){n.push(t.toJSON(e))}),n},Bn.prototype.getPaginationConfigByPath=function(t,e){if(!t||"/"===t)return this.paginationInfo;if("string"!=typeof t)throw new Error("路径必须为字符串！");var n=(t=t.substring(1)).split("/").filter(function(t){return!!t&&0<t.trim().length}).map(function(t){return t.trim()}),r=this.paginationInfo;return n.forEach(function(t){r=r&&r.hasOwnProperty(t)?r[t]:null}),r||(void 0!==e?e:undefined)},Bn.prototype.sortBy=function(t,e,n){var c=this;if(!t||t.length<1||!e||e.length<1)throw new Error("sortBy:argument error");var l,f,r="string"==typeof t?t.split(","):t||[],i="string"==typeof e?e.split(","):e||[];if(r.length!==i.length||r.length<1)throw new Error("sortBy:fields and directions not match");this.innerList=this.innerList.sort((l=r,f=i,function(p,u){return l.reduce(function(t,e){if(0===t){var n=c.properties.find(function(t){return t.name===e}),r=!1;n&&(r=n.enableMultiLangInput);var i=Mt.getCurrentLanguage(),o=["asc"].includes(f[l.indexOf(e)])?1:-1,a=c.getValue(p,e,r,i),s=c.getValue(u,e,r,i);null!==a&&a!==undefined||(a=""),null!==s&&s!==undefined||(s=""),"string"==typeof a&&"string"==typeof s?t=a.localeCompare(s)*o:(s<a&&(t=o),a<s&&(t=-1*o))}return t},0)})).toList()},Bn.prototype.getValue=function(t,e,n,r){var i,o;void 0===n&&(n=!1),void 0===r&&(r="zh-CHS"),t instanceof Bn?t=t.currentItem:t instanceof Vn&&(t=t.list.currentItem);var a=null;if(-1===e.indexOf("."))a=t[e];else{var s=e.split(".");try{for(var p=P(s),u=p.next();!u.done;u=p.next()){var c=u.value;t=a=this.getValue(t,c,n,r)}}catch(l){i={error:l}}finally{try{u&&!u.done&&(o=p["return"])&&o.call(p)}finally{if(i)throw i.error}}}return n&&a&&a.hasOwnProperty(r)?a[r]:a},Bn);function Bn(t){this.__type__="BindingList",this._paginationInfo=null,this.properties=t,this.primaryKey=Jt.getPrimaryKey(t),this.changes=new h.Subject,this.innerList=e.List(),this.currentId=null}var _n=(An.createFromRepository=function(t,e){var n=new Vn,r=Jt.getProperties(t.entityType),i=ee.create(r);return n.initByBindingList(i,e),n.setDataTypeInfo(t.entityTypeInfo),Nn.loadRepository(t,i),n.pagingInfo=t.entityCollection.paginationInfo,n},An.createFromEntityManager=function(t,e){var n=new Vn,r=Jt.getProperties(t.entityType),i=ee.create(r);n.initByBindingList(i,e);var o=t.getEntitiesByPath([]);return Nn.loadEntities(o,i),n},An.createFromExistingBindingData=function(t,e){var n=new Vn;return n.initByBindingList(t.list,e),n},An);function An(){}var Ln="NgBindingData";var kn=($n.convertToBindingPathArray=function(t){return t.split("/").filter(function(t){return""!==t})},$n.convertToEntityPathArray=function(t,e){var n=this,r=this.convertToBindingPathArray(t),i=[];if(0===r.length)return i;var o=e.list.currentItem;return i.push(this.createPrimaryKeyPath(o.primaryKey,o.primaryKeyValue)),r.forEach(function(t){switch(Jt.getPropertyByName(o.properties,t).type){case x.BindingPropertyType.Plain:i.push(t);break;case x.BindingPropertyType.Object:o=o[t],i.push(t),i.push(n.createPrimaryKeyPath(o.primaryKey,o.primaryKeyValue));break;case x.BindingPropertyType.List:var e=o[t];o=e.currentItem,i.push(t),i.push(n.createPrimaryKeyPath(o.primaryKey,o.primaryKeyValue))}}),i},$n.convertToRestUrl=function(t,e){var n=this.convertToBindingPathArray(t),r=[],i=e.list.currentItem;return r.push(i.primaryKeyValue),n.forEach(function(t){var e=Jt.getPropertyByName(i.properties,t);if(e.type!==x.BindingPropertyType.List)throw new Error(e.name+"不是子表对应的属性");var n=i[t];i=n.currentItem,r.push(t),r.push(i.primaryKeyValue)}),r.pop(),"/"+r.join("/")},$n.getLeafPath=function(t){return $n.convertToBindingPathArray(t).pop()},$n.getParentPath=function(t){var e=$n.convertToBindingPathArray(t);return e.pop(),"/"+e.join("/")},$n.createPrimaryKeyPath=function(t,e){return t+":"+e},$n);function $n(){}var Un=(Hn.isGuid=function(t){var e=t.toString();return t&&(t instanceof Hn||Hn.validator.test(e))},Hn.create=function(){return new Hn(pn.create())},Hn.createEmpty=function(){return new Hn("")},Hn.parse=function(t){return new Hn(t)},Hn.raw=function(){return pn.create()},Hn.prototype.equals=function(t){return Hn.isGuid(t)&&this.value===t.toString()},Hn.prototype.isEmpty=function(){return this.value===Hn.EMPTY},Hn.prototype.toString=function(){return this.value},Hn.prototype.toJSON=function(){return{value:this.value}},Hn.validator=new RegExp("^[a-z0-9]+$","i"),Hn.EMPTY="",Hn);function Hn(t){if(!t)throw new TypeError("Invalid argument; `value` has no value.");this.value=Hn.EMPTY,t&&(this.value=t)}var Kn=(Gn.setRunMode=function(t){Gn.mode=t},Gn.getRunMode=function(){return Gn.mode},Gn.mode=null,Gn);function Gn(){}var zn=(Object.defineProperty(qn.prototype,"data",{get:function(){return this.newData},set:function(t){this.newData=t},enumerable:!0,configurable:!0}),Object.defineProperty(qn.prototype,"errors",{get:function(){return this.validErrors},set:function(t){this.validErrors=t},enumerable:!0,configurable:!0}),Object.defineProperty(qn.prototype,"changes",{get:function(){return this.changeSet.changes},enumerable:!0,configurable:!0}),Object.defineProperty(qn.prototype,"primaryProperty",{get:function(){return this.primaryFieldMetadata||(this.primaryFieldMetadata=it.getPrimaryFieldMetadata(this.constructor)),this.primaryFieldMetadata},enumerable:!0,configurable:!0}),Object.defineProperty(qn.prototype,"primaryKey",{get:function(){return this.primaryProperty?this.primaryProperty.property:""},enumerable:!0,configurable:!0}),Object.defineProperty(qn.prototype,"primaryValue",{get:function(){if(this.primaryKey){var t=this[this.primaryProperty.property];return t||""}return""},enumerable:!0,configurable:!0}),qn.prototype.setChanges=function(t){var e=t.path[t.path.length-1];this.valueChanged.next(t),this.validErrors&&Object.keys(this.validErrors).includes(e)||(t&&t.changeSetValue!==undefined&&((t=JSON.parse(JSON.stringify(t))).value=t.changeSetValue),this.changeSet.append(t))},qn.prototype.validate=function(t,e,n,r,i){var o=this;return h.from(this.validator.validate(this,t,e,n,r,i)).pipe(l.tap(function(t){t.isValid?o.validErrors={}:o.validErrors=xt.convertErrorsToNormalObject(t.errors,{})}))},qn.prototype.validateAll=function(t){},qn.prototype.validateFromUtil=function(t,e,n,r){var i=this;this.validErrors={},h.from(this.validator.validate(this,t,e,null,undefined,r&&r.frameContext||null)).subscribe(function(t){t.isValid||(i.validErrors=xt.convertErrorsToNormalObject(t.errors,{})),n(t)})},qn.prototype.validateFromUtilSync=function(t,e,n,r){this.validErrors={};var i=this.validator.verify(this,t,e,null,undefined,r&&r.frameContext||null,!0);i&&!i.isValid&&(this.validErrors=xt.convertErrorsToNormalObject(i.errors,{})),n(i)},qn.prototype.getPaths=function(){var r={path:[],isUdt:!1,isGrid:!1},i=function(t){var e=t[pt];if(e){var n=e[e.length-1];-1<Object.keys(it.getNgObjects(t[ut].constructor)).indexOf(n)&&(r.isUdt=!0),t instanceof St==1?r.isGrid=!0:r.path.push(n)}t[ut]&&i(t[ut])};return i(this),r.path=r.path.reverse(),r},qn.prototype.getEntityListPath=function(){var r=[],i=function(t){var e=t[pt];if(e&&t instanceof St==1){var n=e.concat([]).reverse();Array.prototype.push.apply(r,n)}t[ut]&&i(t[ut])};return i(this),r.reverse()},qn.prototype.getMainEntityPrimaryValue=function(){for(var t=this;t[ut];)t=t[ut];return t.primaryValue},qn.prototype.load=function(t,e){void 0===e&&(e={}),t=t||{},this.loadFields(t),(!e||e&&!1!==e.loadChild)&&this.loadLists(t),this.loadObjects(t),this.loadDynamicObjects(t),this.newData=Object.assign({},t),this.originalData=Object.assign({},t)},qn.prototype.toJSON=function(r){var i=this,o={},a=it.getNgFields(this.constructor);Object.keys(a).forEach(function(t){var e=a[t],n=e.dataField||t;!0===r&&!0===e.enableTimeZone?o[n]=i.data[t]:o[n]=i[t]});var n=it.getNgObjects(this.constructor);Object.keys(n).forEach(function(t){var e=n[t].dataField||t;o[e]=i[t]?i[t].toJSON(r):{}});var s=it.getNgDynamic(this.constructor);Object.keys(s).forEach(function(t){var e=s[t].dataField||t;o[e]=i[t]?i[t].toJSON(r):{}});var p=it.getNgList(this.constructor);return Object.keys(p).forEach(function(t){var e=p[t].dataField||t;o[e]=i[t]?i[t].toJSON(r):{}}),o},qn.prototype.initialize=function(){var t=this.constructor,e=it.getNgFields(t),n=it.getNgObjects(t),r=it.getNgList(t),i=it.getNgDynamic(t);this.initializeNormalField(e),this.initializeList(r),this.initializeObject(n),this.initializeDynamic(i)},qn.prototype.createPath=function(t){var e=this.primaryProperty;return e?[e.dataField+":"+this.primaryValue,t]:[":",t]},qn.prototype.initializeNormalField=function(t){var e=this;Object.keys(t).forEach(function(r){var i=t[r];i.dataField,delete e[r]&&Object.defineProperty(e,r,{get:function(){return this.getPropValue(r,i)},set:function(t){var e=this.getPropValue(r,i);if(!1!==this.isPropValueChanged(r,i,t,e)){this.setPropValue(r,i,t);var n=this.preparePropValue(r,i,t);this.emitValueChange(r,i,t,e,n)}}})})},qn.prototype.initializeList=function(s){var p=this;Object.keys(s).forEach(function(t){var e=s[t],n=p.createPath(t),r=e.dataField||t,i=p.data[r],o=new St;if(o[ut]=p,o[pt]=n,i){var a=i.map(function(t){return ct(e.type,t)});o.loadEntities(a)}o.onListChanged.subscribe(function(t){t&&(o[pt][0]!==t.path[0]&&(t.path=o[pt].concat(t.path)),p.setChanges(t))}),p[t]=o})},qn.prototype.initializeObject=function(s){var p=this;Object.keys(s).forEach(function(n){var r=s[n],i=p.createPath(n),t=r.dataField||n,e=p.data[t]||{},o=function(t){var e;return(e=t instanceof r.type?t:ct(r.type,t))[ut]=p,e[pt]=i,e.onValueChanged.subscribe(function(t){t&&(t.path=(p[pt]||[]).concat(t.path),p.setChanges(t))}),e},a=o(e);delete p[n]&&Object.defineProperty(p,n,{get:function(){return a},set:function(t){var e={path:a[pt],value:t.data,preValue:this[n].data,type:x.ModifyType.ValueChange};a=o(t),this.setChanges(e)}})})},qn.prototype.initializeDynamic=function(s){var p=this;Object.keys(s).forEach(function(n){var r=s[n],i=p.createPath(n),t=r.dataField||n,e=p.data[t]||{},o=function(t){var e;return(e=t instanceof r.type?t:ct(r.type,t))[ut]=p,e[pt]=i,e.onValueChanged.subscribe(function(t){t&&(t.path=(p[pt]||[]).concat(t.path),p.setChanges(t))}),e},a=o(e);delete p[n]&&Object.defineProperty(p,n,{get:function(){return a},set:function(t){var e={path:a[pt],value:t.data,preValue:this[n].data,type:x.ModifyType.ValueChange};a=o(t),this.setChanges(e)}})})},qn.prototype.loadFields=function(o){var a=this,s=it.getNgFields(this.constructor);Object.keys(s).forEach(function(t){var e=s[t],n=e.dataField||t,r=o[n];if(!0===e.enableTimeZone){var i=_t.getTimeZoneOffset();null!==i&&r&&(r=Lt.zonedTimeToSpecialTimeZoneOffsetTimeString(r,i))}a[t]=r})},qn.prototype.loadLists=function(a){var s=this,p=it.getNgList(this.constructor);Object.keys(p).forEach(function(t){var e=p[t],n=e.dataField||t,r=e.type,i=a[n];if(i){var o=i.map(function(t){return ct(r,t)});s[t].loadEntities(o)}else s[t].loadEntities([])})},qn.prototype.loadObjects=function(i){var o=this,a=it.getNgObjects(this.constructor);Object.keys(a).forEach(function(t){var e=a[t].dataField||t,n=i[e],r=o[t];r&&n&&r.load(n)})},qn.prototype.loadDynamicObjects=function(i){var o=this,a=it.getNgDynamic(this.constructor);Object.keys(a).forEach(function(t){var e=a[t].dataField||t,n=i[e]||{},r=o[t];r&&r.loadDynamicData(n)})},qn.prototype.emitValueChange=function(t,e,n,r,i){void 0===i&&(i=undefined);var o={path:this.createPath(t),value:n,changeSetValue:i,preValue:r,type:x.ModifyType.ValueChange};this[pt]&&(o.path=this[pt].concat(o.path)),this.setChanges(o)},qn.prototype.preparePropValue=function(t,e,n){var r=undefined;if(!0===e.enableTimeZone){var i=_t.getTimeZoneOffset();null!==i&&n&&(r=Lt.timeZoneOffsetTimeToUtcTimeString(n,i))}return r},qn.prototype.getPropValue=function(t,e){var n,r=e.dataField||t,i=this.data[r];if(!0===e.enableMultiLangInput&&!i){var o=window.localStorage.getItem("languageCode")||"zh-CHS",a=r.replace("_MULTILANGUAGE","");return(n={})[o]=this.data[a],n}if(!0===e.enableTimeZone){var s=_t.getTimeZoneOffset();if(null!==s&&i)return Lt.zonedTimeToSpecialTimeZoneOffsetTimeString(i,s)}return e.originalDataFieldType===Rt&&(i=i&&i.toString()||null),i},qn.prototype.setPropValue=function(t,e,n){var r=e.dataField||t;if(e.originalDataFieldType===Rt)this.data[r]=null===n?null:n&&n.toString()||"";else{if(!0===e.enableTimeZone){var i=_t.getTimeZoneOffset();null!==i&&n&&(n=Lt.timeZoneOffsetTimeToUtcTimeString(n,i))}this.data[r]=n}},qn.prototype.isPropValueChanged=function(t,e,n,r){return!0===e.enableMultiLangInput?(!0!==this.isEmptyMultiLangPropValue(n)||!0!==this.isEmptyMultiLangPropValue(r))&&JSON.stringify(n)!==JSON.stringify(r):(e.originalDataFieldType===Rt&&"string"!=typeof n&&null!==n&&n!==undefined&&(console.log("BigNumber must be a string !"),n=n.toString()),n!==r)},qn.prototype.isEmptyMultiLangPropValue=function(t){return!t||0===Object.keys(t).length||!0===Object.values(t).every(function(t){return!t})},qn);function qn(t){this.validErrors={},this.primaryFieldMetadata=null,this.originalData=undefined,this.changeSet=new F,this.isValidating=!1,this.newData=undefined,this.unsubscribe=new h.Subject,this.valueChanged=new h.Subject,this.onValueChanged=this.valueChanged.asObservable(),this.onUpdate=new h.Subject,this.validator=new wt,this.newData=Object.assign({},t),this.originalData=Object.assign({},t),this.onValueChanged=this.valueChanged,Kn.getRunMode()===x.RunMode.compatible&&this.initialize()}var Jn,Wn=(c(Yn,Jn=zn),Object.defineProperty(Yn.prototype,"IsNested",{get:function(){return this[ut]instanceof Yn},enumerable:!0,configurable:!0}),Yn.prototype.loadDynamicData=function(t){this.initializeDynamicField(t)},Yn.prototype.initializeDynamicField=function(t){var e=this;Object.keys(t).forEach(function(r){var i=r;if(delete e[r])if(t[r]instanceof Object){var n=e.createPath(r),o=e.createDynamicEntityFromJsonData(t[r],n);Object.defineProperty(e,r,{get:function(){return o},set:function(t){var e={path:o[pt],value:t.data,preValue:this[r].data,type:x.ModifyType.ValueChange};o=this.createDynamicEntityFromJsonData(t,n),this.setChanges(e)}})}else Object.defineProperty(e,r,{get:function(){return this.data[i]},set:function(t){var e=this.data[i];if(e!==t){this.data[i]=t;var n={type:x.ModifyType.ValueChange,path:this.createPath(r),value:t,preValue:e};this[pt]&&(n.path=this[pt].concat(n.path)),this.setChanges(n)}}})})},Yn.prototype.createDynamicEntityFromJsonData=function(t,e){var n,r=this;return t instanceof Yn?n=t:(n=new Yn(t)).constructor=Yn,n[ut]=this,n[pt]=e,n.onValueChanged.subscribe(function(t){t&&(t.path=(r[pt]||[]).concat(t.path),r.setChanges(t))}),n},Yn.prototype.setChanges=function(t){var e,n=t.path[t.path.length-1],r=Object.assign({},this.data);this.newData=Object.assign(this.newData,((e={})[n]=t.value,e));var i=t.path;2<t.path.length&&(i=t.path.slice(0,t.path.length-2));var o={path:i,value:this.data,preValue:r,type:t.type,dynamic:!0};this.valueChanged.next(o),this.changeSet.append(t)},Yn.prototype.toJSON=function(){return this.data},Yn);function Yn(t){var e=Jn.call(this,t)||this;return e.loadDynamicData(t),e}var Zn,Xn,Qn,tr=new d.InjectionToken("@farris/devkit ENTITY_DATA_SERVICE"),er={getFieldValue:function(t){var e,n=t.label,r=this.data[n];if(!0!==t.multiLanguage||r)return r;var i=window.localStorage.getItem("languageCode")||"zh-CHS",o=n.replace("_MULTILANGUAGE","");return(e={})[i]=this.data[o],e},setFieldValue:function(t,e){var n=t.label;this.data[n]=e},getComplexFieldValue:function(t){var e=t.label;return this.innerEntities[e]},setComplexFieldValue:function(t,e,n){var r=t.label,i=null;n instanceof e?i=n:(i=new e(n)).constructor=e;var o=this.innerEntities[r],a={path:o&&o[pt]||i[pt],value:n,preValue:this[r]&&this[r].data||null,type:x.ModifyType.ValueChange};this.innerEntities[r]=i,this.isInitializing||this.setChanges(a)},getEntities:function(t){var e=t.label;return this.innerEntities[e]},setEntities:function(t,e){var n=t.label;this.innerEntities[n]=e},isFieldValueChanged:function(t,e,n){return!0===t.multiLanguage?(!0!==this.isEmptyMultiLangPropValue(e)||!0!==this.isEmptyMultiLangPropValue(n))&&JSON.stringify(e)!==JSON.stringify(n):e!==n},isEmptyMultiLangPropValue:function(t){return!t||(0===Object.keys(t).length||!0===Object.values(t).every(function(t){return!t}))},emitFieldValueChange:function(t,e,n){if(!this.isInitializing){var r=t.label,i={path:this.createPath(r),value:e,preValue:n,type:x.ModifyType.ValueChange};this[pt]&&(i.path=this[pt].concat(i.path)),this.setChanges(i)}},setChanges:function(t){var e=t.path[t.path.length-1];this.valueChanged.next(t),this.validErrors&&Object.keys(this.validErrors).includes(e)||this.changeSet.append(t)},createPath:function(t){return this.primaryKey?[this.primaryKey+":"+this.primaryValue,t]:[":",t]},getPaths:function(){var r={path:[],isUdt:!1,isGrid:!1},i=function(t){var e=t[pt];if(e){var n=e[e.length-1];-1<Object.keys(it.getNgObjects(t[ut].constructor)).indexOf(n)&&(r.isUdt=!0),t instanceof St==!0?r.isGrid=!0:r.path.push(n)}t[ut]&&i(t[ut])};return i(this),r.path=r.path.reverse(),r},validate:function(t,e,n,r){var i=this;return h.from(this.validator.validate(this,t,e,n,r)).pipe(l.tap(function(t){t.isValid?i.validErrors={}:i.validErrors=xt.convertErrorsToNormalObject(t.errors,{})}))},validateAll:function(t){},validateFromUtil:function(t,e,n){var r=this;this.validErrors={},h.from(this.validator.validate(this,t,e)).subscribe(function(t){t.isValid||(r.validErrors=xt.convertErrorsToNormalObject(t.errors,{})),n(t)})},toJSON:function(r){var i=this,o={},a=it.getNgFields(this.constructor);Object.keys(a).forEach(function(t){var e=a[t],n=e.dataField||t;!0===r&&!0===e.enableTimeZone?o[n]=i.data[t]:o[n]=i[t]});var n=it.getNgObjects(this.constructor);Object.keys(n).forEach(function(t){var e=n[t].dataField||t;o[e]=i[t]?i[t].toJSON(r):{}});var s=it.getNgDynamic(this.constructor);Object.keys(s).forEach(function(t){var e=s[t].dataField||t;o[e]=i[t]?i[t].toJSON(r):{}});var p=it.getNgList(this.constructor);return Object.keys(p).forEach(function(t){var e=p[t].dataField||t;o[e]=i[t]?i[t].toJSON(r):{}}),o}},nr=function fp(){},rr=function hp(){},ir=function yp(){},or=function dp(){},ar=function gp(){},sr=function vp(){};(Zn=x.SchemaEntityField$Type||(x.SchemaEntityField$Type={})).SimpleField="SimpleField",Zn.ComplexField="ComplexField",(Xn=x.SchemaEntityFieldType$Type||(x.SchemaEntityFieldType$Type={})).StringType="StringType",Xn.TextType="TextType",Xn.NumericType="NumericType",Xn.BooleanType="BooleanType",Xn.DateType="DateType",Xn.DateTimeType="DateTimeType",Xn.EnumType="EnumType",Xn.EntityType="EntityType",Xn.HierarchyType="HierarchyType",Xn.ObjectType="ObjectType",Xn.BigNumericType="BigNumericType",(Qn=x.SchemaEntityFieldTypeName||(x.SchemaEntityFieldTypeName={})).String="String",Qn.DateTime="DateTime",Qn.Date="Date",Qn.Enum="Enum",Qn.Boolean="Boolean",Qn.Number="Number",Qn.Text="Text",Qn.BigNumber="BigNumber";var pr=(ur.prototype.create=function(t){var e=t.entities[0].type;return this.createClass(e)},ur.prototype.createClass=function(t){var o=this.createEntityInstanceDataInitializer(t),a=function(t){var e,n,r,i=this;this.changeSet=new F,this.isValidating=!1,this.validErrors={},this.validator=new wt,this.innerData=Object.assign({},t),this.innerEntities={},this.valueChanged=new h.Subject,this.onValueChanged=this.valueChanged,this.validateFromUtilSync=function(t,e,n,r){this.validErrors={};var i=this.validator.verify(this,t,e,null,undefined,r&&r.frameContext||null,!0);i&&!i.isValid&&(this.validErrors=xt.convertErrorsToNormalObject(i.errors,{})),n(i)},n=t,r=a,(e=this).isInitializing=!0,o(e,n,r),e.isInitializing=!1,this.load=function(t){o(i,t,a)}};a.typeName=t.name+"Entity",a.types={},a.__prop__metadata__={};var e=Object.assign({typeName:"ConcreteEntityPrototype"},er);return this.definePresetProperty(e,t),this.defineFieldsToPrototype(e,t.fields,t.primary,a),this.defineEntitiesToPrototype(e,t.entities,a),a.prototype=e,a},ur.prototype.definePresetProperty=function(t,e){Object.defineProperty(t,"data",{get:function(){return this.innerData}}),Object.defineProperty(t,"errors",{get:function(){return this.validErrors},set:function(t){this.validErrors=t}}),Object.defineProperty(t,"changes",{get:function(){return this.changeSet.changes}}),Object.defineProperty(t,"primaryProperty",{get:function(){return t.innerPrimaryProperty||{dataField:e.primary}}}),Object.defineProperty(t,"primaryKey",{get:function(){return e.primary||""}}),Object.defineProperty(t,"primaryValue",{get:function(){if(this.primaryKey){var t=this[this.primaryKey];return t||""}return""}})},ur.prototype.defineFieldsToPrototype=function(e,t,n,r){var i=this;t&&t.length&&t.forEach(function(t){switch(t.$type){case x.SchemaEntityField$Type.SimpleField:i.defineSimpleFieldToPrototype(e,t,n,r);break;case x.SchemaEntityField$Type.ComplexField:i.defineComplexFieldToPrototype(e,t,r)}})},ur.prototype.defineSimpleFieldToPrototype=function(t,n,e,r){var i=n.label;Object.defineProperty(t,i,{get:function(){return this.getFieldValue(n)},set:function(t){var e=this.getFieldValue(n);!1!==this.isFieldValueChanged(n,t,e)&&(this.setFieldValue(n,t),this.emitFieldValueChange(n,t,e))}});var o={dataField:n.label,originalDataField:n.code,originalDataFieldType:n.type.name,path:n.path,primary:n.label===e,ngMetadataName:_};o.primary&&(t.innerPrimaryProperty=o),r.__prop__metadata__[i]||(r.__prop__metadata__[i]=[]),r.__prop__metadata__[i].push(o)},ur.prototype.defineComplexFieldToPrototype=function(t,e,n){var r=this.createClass(e.type);n.types[e.type.name]=r;var i=e.label;Object.defineProperty(t,i,{get:function(){return this.getComplexFieldValue(e)},set:function(t){this.setComplexFieldValue(e,r,t)}});var o={dataField:e.label,originalDataField:e.code,type:r,path:e.path,ngMetadataName:$};n.__prop__metadata__[i]||(n.__prop__metadata__[i]=[]),n.__prop__metadata__[i].push(o)},ur.prototype.defineEntitiesToPrototype=function(i,t,o){var a=this;t&&t.length&&t.forEach(function(e){var t=a.createClass(e.type);o.types[e.type.name]=t;var n=e.label;Object.defineProperty(i,n,{get:function(){return this.getEntities(e)},set:function(t){this.setEntities(e,t)}});var r={dataField:e.label,originalDataField:"",type:t,ngMetadataName:L};o.__prop__metadata__[n]||(o.__prop__metadata__[n]=[]),o.__prop__metadata__[n].push(r)})},ur.prototype.createEntityInstanceDataInitializer=function(t){return function(p,u,c){t.fields.filter(function(t){return t.$type===x.SchemaEntityField$Type.ComplexField}).forEach(function(t){var e=t.label,n=c.types[t.type.name],r=u?u[e]:null,i=p.createPath(e),o=p[e];o instanceof n?o.load(r):((o=new n(r)).constructor=n,o[ut]=c,o[pt]=i,o.onValueChanged.subscribe(function(t){t&&(t.path=(p[pt]||[]).concat(t.path),p.setChanges(t))}),p[e]=o)}),t.entities&&t.entities.forEach(function(t){var e=t.label,n=c.types,r=p.createPath(e),i=p[e];i instanceof St||((i=new St).onListChanged.subscribe(function(t){t&&(i[pt][0]!==t.path[0]&&(t.path=i[pt].concat(t.path)),p.setChanges(t))}),p[e]=i),i[ut]=c,i[pt]=r;var o=n[t.type.name],a=u?u[e]:null;if(a){var s=a.map(function(t){var e=new o(t);return e.constructor=o,e});i.loadEntities(s)}})}},ur);function ur(){}var cr=(lr.prototype.get=function(t,e,n){return this.request(t,"GET",e,n)},lr.prototype.put=function(t,e,n,r){var i=this.addBody(r,e);return this.request(t,"PUT",n,i)},lr.prototype.post=function(t,e,n,r){var i=this.addBody(r,e);return this.request(t,"POST",n,i)},lr.prototype["delete"]=function(t,e,n){return this.request(t,"DELETE",e,n)},lr.prototype.request=function(t,e,n,r){if(void 0===r&&(r={}),r=r||{},n){var i=this.buildParams(n);r.params=i}var o=e;return this.httpClient.request(o,t,r)},lr.prototype.buildParams=function(t){var e=new s.HttpParams;for(var n in t)if(t.hasOwnProperty(n)){var r=t[n].toString();e=e.append(n,r)}return e},lr.prototype.addBody=function(t,e){return t=t||{},Object.assign(t,{body:e})},lr.decorators=[{type:d.Injectable}],lr.ctorParameters=function(){return[{type:s.HttpClient}]},lr);function lr(t){this.httpClient=t}var fr="NgCommandHandler";var hr="NgCommandHandlerExtender";var yr=(dr.prototype.execute=function(t){var e,n=this.func(t);return(e=n)&&(e[Symbol.observable]&&e===e[Symbol.observable]()||e["@@observable"]&&e===e["@@observable"]()||e instanceof h.Observable)?n:h.of(n)},dr);function dr(t,e){this.name=t,this.func=e}var gr=new d.InjectionToken("variable parsers"),vr=(mr.getAppContext=function(t){if("CommandContext"===t.typeName)return t.frameContext.appContext;if(t.appContext)return t.appContext;if("AppContext"===t.typeName)return t;throw new Error("上下文中找不到AppContext，请检查！")},mr.getFrameContext=function(t){if("CommandContext"===t.typeName)return t.frameContext;if("FrameContext"===t.typeName)return t;throw new Error("上下文中找不到FrameContext，请检查！")},mr.getRootFrameContext=function(t){return this.getFrameContext(t).root},mr.getFrameContextById=function(t,e){return this.getAppContext(t).frameContextManager.getFrameContextById(e)},mr);function mr(){}var Er=(br.prototype.parse=function(o,t){var a=this,s=vr.getAppContext(t),e=this.extractPaths(o);if(1===e.length){var n=this.getValue(e[0],s);if(o==="{DATA~"+e[0]+"}")return n;if(o==="{:DATA~"+e[0]+"}")return $e(n)}return e.forEach(function(t){var e=a.getValue(t,s),n="{DATA~"+t+"}",r="{:DATA~"+t+"}";if((o=o.replace(n,e)).includes(r)){var i=$e(e);o=o.replace(r,i)}}),o},br.prototype.extractPaths=function(t){var n=[],e=t.match(/\{:?DATA~(\S+?)\}/g);if(null===e)return[];var r=/\{:?DATA~(\S+?)\}/;return e.forEach(function(t){var e=t.match(r);null!=e&&2===e.length&&n.push(e[1])}),n},br.prototype.getValue=function(t,e){var n=t.split("/").filter(function(t){return""!==t}),r=e.getFrameContext(n[0]);if(!r)throw new Error(t+"不正确，请检查！");var i=r.bindingData;if(!i)throw new Error(t+"不正确，请检查！");return i.getValue(n.slice(1))},br.decorators=[{type:d.Injectable}],br);function br(){}var Cr=(xr.prototype.parse=function(o,t){var a=this,s=vr.getAppContext(t),e=this.extractPaths(o);if(1===e.length){var n=this.getUIState(e[0],s);if(o==="{UISTATE~"+e[0]+"}")return n;if(o==="{:UISTATE~"+e[0]+"}")return $e(n)}return e.forEach(function(t){var e="{UISTATE~"+t+"}",n=a.getUIState(t,s),r="{:UISTATE~"+t+"}";if((o=o.replace(e,n)).includes(r)){var i=$e(n);o=o.replace(r,i)}}),o},xr.prototype.extractPaths=function(t){var n=[],e=t.match(/\{:?UISTATE~(\S+?)\}/g);if(null===e)return[];var r=/\{:?UISTATE~(\S+?)\}/;return e.forEach(function(t){var e=t.match(r);null!=e&&2===e.length&&n.push(e[1])}),n},xr.prototype.getUIState=function(t,e){var n=t.split("/").filter(function(t){return""!==t}),r=m(n,2),i=r[0],o=r[1],a=e.getFrameContext(i).uiState[o];if(a&&a.constructor.toString().startsWith("function Date()"))return this.formatDate(a);for(var s=2;s<n.length;s++)if(!(a=a[n[s]]))return a;return a},xr.prototype.formatDate=function(t){if(!t)return"";var e=t.getFullYear(),n=(t.getMonth()+1).toString();n=1===n.length?"0"+n:n;var r=t.getDate().toString();return e+"-"+n+"-"+(r=1===r.length?"0"+r:r)},xr.decorators=[{type:d.Injectable}],xr);function xr(){}var Pr=(Ir.prototype.parse=function(r,i){var o=this,t=this.extractPaths(r);return 1===t.length&&r==="{STATEMACHINE~"+t[0]+"}"?this.getValue(t[0],i):(t.forEach(function(t){var e="{STATEMACHINE~"+t+"}",n=o.getValue(t,i);r=r.replace(e,n)}),r)},Ir.prototype.extractPaths=function(t){var n=[],e=t.match(/\{STATEMACHINE~(\S+?)\}/g);if(null===e)return[];var r=/\{STATEMACHINE~(\S+?)\}/;return e.forEach(function(t){var e=t.match(r);null!=e&&2===e.length&&n.push(e[1])}),n},Ir.prototype.getValue=function(t,e){var n=this.getPathObj(t),r=this.getTargetStateMachine(n.frameId,e);if("currentState"===n.type)return r.context.state;if("renderStates"===n.type)return r[n.name];throw new Error("不支类型为"+n.type+"的状态机变量")},Ir.prototype.getTargetStateMachine=function(t,e){var n;if(!(n=t?vr.getFrameContextById(e,t):vr.getRootFrameContext(e))||!n.stateMachine)throw new Error("找不到对应的状态机实例，请检查！");return n.stateMachine},Ir.prototype.getPathObj=function(t){var e=this.splitPath(t);return"currentState"===e[0]||"renderStates"===e[0]?{frameId:"",type:e[0],name:e[1]}:{frameId:e[0],type:e[1],name:e[2]}},Ir.prototype.splitPath=function(t){return t.split("/").filter(function(t){return""!==t})},Ir.decorators=[{type:d.Injectable}],Ir.ctorParameters=function(){return[]},Ir);function Ir(){}var Tr=(Mr.prototype.parse=function(r,i){var o=this,t=this.extractPaths(r);return 1===t.length&&r==="{COMMAND~"+t[0]+"}"?this.getValue(t[0],i):(t.forEach(function(t){var e="{COMMAND~"+t+"}",n=o.getValue(t,i);r=r.replace(e,n)}),r)},Mr.prototype.extractPaths=function(t){var n=[],e=t.match(/\{COMMAND~(\S+?)\}/g);if(null===e)return[];var r=/\{COMMAND~(\S+?)\}/;return e.forEach(function(t){var e=t.match(r);null!=e&&2===e.length&&n.push(e[1])}),n},Mr.prototype.getValue=function(t,e){if(e instanceof Gr==0)throw new Error("当前上下文不支持COMMAND变量，请检查！");var n=m(t.split("/").filter(function(t){return""!==t}),2),r=n[0],i=n[1];return"params"===r?e.command.params[i]:"results"===r?e.results[i]:void 0},Mr.decorators=[{type:d.Injectable}],Mr.ctorParameters=function(){return[]},Mr);function Mr(){}var jr=(wr.prototype.parse=function(n,r,i){var o=this;return"string"==typeof n&&0<n.length?this.parseExpression(n,r,i):(Array.isArray(n)?n.forEach(function(t,e){n[e]="string"==typeof t?o.parseExpression(t,r,i):o.parse(t,r,i)}):"object"==typeof n&&null!==n&&Object.keys(n).forEach(function(t){"string"==typeof n[t]?n[t]=o.parseExpression(n[t],r,i):n[t]=o.parse(n[t],r,i)}),n)},wr.prototype.evaluate=function(t,e,n){var r=this.parse(t,e,n);return new Function("return "+r)()},wr.prototype.parseExpression=function(e,n,r){return""===e?"":(this.parsers.forEach(function(t){"string"==typeof e&&(e=t.parse(e,n,r))}),e)},wr.decorators=[{type:d.Injectable}],wr.ctorParameters=function(){return[{type:Array,decorators:[{type:d.Inject,args:[gr]}]}]},wr);function wr(t){this.parsers=t}var Or=/#{\S+?}/g,Sr=(Nr.prototype.parse=function(n,t){var r=this;this.context=t;var e=this.extractVariables(n);return!e||e.length<1||e.forEach(function(t){var e=r.getVariableValue(t);n=n.replace(Or,e)}),n},Nr.prototype.getVariableValue=function(t){var e=t.substring(2,t.length-1);return this.getFullFrameId(e)},Nr.prototype.extractVariables=function(t){return t?t.match(Or):[]},Nr.prototype.getFullFrameId=function(t){var e=vr.getFrameContext(this.context).namespace||"";return(e?e+"_":"")+t},Nr.decorators=[{type:d.Injectable}],Nr);function Nr(){}var Dr=/\{FORMSTATE~\/(\S+?)\}/g,Vr=/\{FORMSTATE~\/(\S+?)\}/,Fr=(Rr.prototype.parse=function(i,t){var o=this;this.context=t;var e=this.extractVariables(i);return!e||e.length<1||e.forEach(function(t){var e=t.match(Vr);if(e&&2===e.length){var n=e[1],r=o.getVariableValue(n);i=i.replace(Vr,r)}}),i},Rr.prototype.getVariableValue=function(t){return vr.getFrameContext(this.context).appContext.params.get(t)},Rr.prototype.extractVariables=function(t){if(!t)return null;var e=t.match(Dr);return!e||e.length<1?null:e},Rr);function Rr(){}var Br=/\{EVENTPARAM~\/(\S+?)\}/g,_r=/\{EVENTPARAM~\/(\S+?)\}/,Ar=(Lr.prototype.parse=function(i,t,o){var a=this;this.context=t;var e=this.extractVariables(i);return!e||e.length<1||e.forEach(function(t){var e=t.match(_r);if(e&&2===e.length){var n=e[1],r=a.getVariableValue(n,o);i=i.replace(_r,r)}}),i},Lr.prototype.extractVariables=function(t){if(!t)return null;var e=t.match(Br);return!e||e.length<1?null:e},Lr.prototype.getVariableValue=function(t,e){return e&&t?t.split("/").filter(function(t){return t}).reduce(function(t,e){return t?t[e]:null},e):null},Lr.decorators=[{type:d.Injectable}],Lr);function Lr(){}var kr=[{provide:gr,multi:!0,useClass:Sr},{provide:gr,multi:!0,useClass:Fr},{provide:gr,multi:!0,useClass:Ar},{provide:gr,multi:!0,useClass:Er},{provide:gr,multi:!0,useClass:Cr},{provide:gr,multi:!0,useClass:Pr},{provide:gr,multi:!0,useClass:Tr},jr],$r=(Ur.prototype.canLink=function(t){var e;switch(typeof this.condition){case"boolean":e=this.condition;break;case"function":e=this.condition(t);break;case"string":e=t.frameContext.injector.get(jr).evaluate(this.condition,t);break;default:e=!1}return e},Ur);function Ur(t,e,n){this.from=t,this.to=e,this.condition=n}var Hr=(Kr.prototype.addNode=function(t,e){var n=new yr(t,e);this.nodes.push(n)},Kr.prototype.addNodes=function(t){this.nodes=this.nodes.concat(t)},Kr.prototype.insertNode=function(t,e,n){var r=this.findNodeIndex(t),i=this.createNode(e,n);this.nodes.splice(r,0,i)},Kr.prototype.appendNode=function(t,e,n){var r=this.findNodeIndex(t)+1,i=this.createNode(e,n);this.nodes.splice(r,0,i)},Kr.prototype.findNodeIndex=function(e){return this.nodes.findIndex(function(t){return t.name===e})},Kr.prototype.createNode=function(t,e){return new yr(t,e)},Kr.prototype.addLink=function(t,e,n){var r=this.createLink(t,e,n);this.links.push(r)},Kr.prototype.addLinks=function(t){this.links=this.links.concat(t)},Kr.prototype.createLink=function(t,e,n){return new $r(t,e,n)},Kr.prototype.getNext=function(e,n){if(!e)return this.nodes.shift();var r=this.links.find(function(t){return t.from===e&&t.canLink(n)});return r?this.nodes.find(function(t){return t.name===r.to}):void 0},Kr.prototype.clone=function(){var t=new Kr;return t.addNodes(this.nodes),t.addLinks(this.links),t},Kr);function Kr(){this.nodes=[],this.links=[]}var Gr=function mp(t,e){this.typeName="CommandContext",this.results={},this.command=t,this.frameContext=e},zr=new d.InjectionToken("@farris/devkit TranslateToken"),qr=(Jr.prototype.init=function(t,e){this.frameContext=t,this.parseService=e,this.taskFlow=new Hr,this.schedule()},Jr.prototype.execute=function(a){var s=this,p=new h.Subject,u=this.taskFlow.clone();return setTimeout(function(){var t=E({},a).eventParam,e=void 0===t?null:t;delete a.eventParam;var n=JSON.parse(JSON.stringify(a));n.params=s.paramsTransform(n.params),n.params=s.parseService.parse(n.params,s.frameContext,e),a.eventParam=e,n.eventParam=e,s.transParamTypes(n.params,n.paramDescriptions);var r=new Gr(n,s.frameContext);r.eventParam=a.eventParam||null;var i=new h.BehaviorSubject(r),o=u.getNext("",r);i.pipe(l.concatMap(function(e){return o.execute(e).pipe(l.take(1),l.map(function(t){return e.results[o.name]=t,e.latestResult=t,(o=u.getNext(o.name,e))?i.next(e):i.complete(),e}),l.throwIfEmpty(function(){i.complete()}))})).pipe(l.takeLast(1)).subscribe({next:function(t){p.next(t.latestResult)},error:function(t){s.displayError(t),p.error(t)},complete:function(){p.complete()}})},0),p},Jr.prototype.displayError=function(t){t&&console&&console.error&&console.error(t)},Jr.prototype.paramsTransform=function(n){var r=/\{\{(\w+)\}\}/g;if(!n)return null;var i=this.frameContext.injector.get(zr,null)||null,t=Object.keys(n),o={};return 0===t.length?n:(t.forEach(function(t){var e=n[t];e&&r.test(e)&&i&&(e=e.replace(r,function(t,e){return i.transform(e,null)})),o[t]=e}),o)},Jr.prototype.addTask=function(t,e){this.taskFlow.addNode(t,e)},Jr.prototype.addLink=function(t,e,n){this.taskFlow.addLink(t,e,n)},Jr.prototype.insertTask=function(t,e,n){throw new Error("Not Implemented")},Jr.prototype.afterTask=function(t,e,n){throw new Error("Not Implemented")},Jr.prototype.replaceTask=function(t,e){throw new Error("Not Implement")},Jr.prototype.invoke=function(t,e,n,r){this.setContextToServiceInstance(t,r);var i=this.parseService.parse(n,r,r.eventParam);return t[e].apply(t,b(i))},Jr.prototype.setContextToServiceInstance=function(t,e){var n=t.context;n&&n instanceof Gr==0||(t.context=e)},Jr.prototype.transParamTypes=function(a,s){s&&Object.keys(a).forEach(function(t){if(s[t]&&s[t].type){var e=s[t].type,n=a[t];if(n!==undefined&&null!==n&&typeof n!==e)switch(e){case"string":a[t]=n+"";break;case"int":case"double":case"number":var r=Number(n);if(isNaN(r))throw Error("类型转换失败，参数"+t+"值为"+n+"，无法转换为"+e+"类型。");a[t]=r;break;case"boolean":var i=void 0,o=(n+"").toLowerCase();if("true"===o)i=!0;else{if("false"!==o)throw Error("类型转换失败，参数"+t+"值为"+n+"，无法转换为"+e+"类型。");i=!1}a[t]=i}}})},Jr);function Jr(){}var Wr=new d.InjectionToken("@Farris Command Handlers"),Yr=(Zr.prototype.set=function(t,e){if(this.handlerMap.has(t))throw new Error(t+"对应的CommandHandler已经存在");this.handlerMap.set(t,e)},Zr.prototype.get=function(t){if(!1===this.handlerMap.has(t))throw new Error("找不到"+t+"对应的CommandHandler");return this.handlerMap.get(t)},Zr.prototype.regist=function(t){var e=t.commandName;if(!e){var n=O.getClassMetadataByName(t.constructor,fr);if(!n)throw new Error("CommandHandler必须指定要处理的命令名称");e=n.commandName}this.set(e,t)},Zr.decorators=[{type:d.Injectable}],Zr.ctorParameters=function(){return[{type:Array,decorators:[{type:d.Optional},{type:d.Inject,args:[Wr]}]}]},Zr);function Zr(t){var e=this;this.handlerMap=new Map,t&&t.forEach(function(t){e.regist(t)})}var Xr=(Qr.decorators=[{type:d.Injectable}],Qr);function Qr(){}var ti=new d.InjectionToken("@farris/devkit CommandHandler Extenders"),ei=(ni.prototype.get=function(t){return!1===this.extendersMap.has(t)?[]:this.extendersMap.get(t)},ni.prototype.set=function(t,e){this.extendersMap.has(t)?this.extendersMap.get(t).push(e):this.extendersMap.set(t,[e])},ni.prototype.regist=function(t){var e=O.getClassMetadataByName(t.constructor,hr);if(!e)throw new Error("CommandHandlerExtender必须指定要扩展的命令名称");var n=e.commandName;this.set(n,t)},ni.decorators=[{type:d.Injectable}],ni.ctorParameters=function(){return[{type:Array,decorators:[{type:d.Optional},{type:d.Inject,args:[ti]}]}]},ni);function ni(t){var e=this;this.extendersMap=new Map,t&&t.forEach(function(t){e.regist(t)})}var ri="NgParam",ii=w(ri,function(t){return t}),oi=(ai.getUIFields=function(t){return O.getPropsMetadatasByName(t,ri)},ai);function ai(){}var si=(pi.prototype._init=function(){var t=oi.getUIFields(this.constructor);this.initializeUIField(t)},pi.prototype.initialize=function(t){var e=t.metadata.uiStates||oi.getUIFields(this.constructor);this.initializeUIField(e)},pi.prototype.initializeUIField=function(n){var r=this;Object.keys(n).forEach(function(t){var e=n[t].stateName||t;delete r[t]&&r.defineProperty(t,e)})},pi.prototype.isExistProperty=function(t){return!(!this.innerData.hasOwnProperty(t)&&!this.hasOwnProperty(t))},pi.prototype.defineProperty=function(o,a){void 0===a&&(a=null),Object.defineProperty(this,o,{get:function(){return null!==a?this.innerData[a]:this.innerData[o]},set:function(t){var e=null!==a?this.innerData[a]:this.innerData[o];if(!0===this.paramTypeTransform){var n=oi.getUIFields(this.constructor),r=n&&n[o]||null,i=r&&r.originalDataType||null;i&&(t=this.transform(t,i))}e!==t&&(null!==a?this.innerData[a]=t:this.innerData[o]=t,this.changes.next({field:o,value:t}))}})},pi.prototype.setPropertyValue=function(t,e){""!==t&&t!==undefined&&(this.isExistProperty(t)||this.defineProperty(t),this[t]=e)},pi.prototype.transform=function(t,e){if(!e)return t;if("string"===(e=e.toLowerCase()))return null===t||t===undefined?t:t.toString();if("number"===e){if(t===undefined)return undefined;var n=Number(t);if(isNaN(n))throw new Error(t+"无法转换为数字！");return n}if("boolean"===e){if("boolean"==typeof t)return t;if(null===t||t===undefined)return!1;if("false"===(t=t.toString().toLowerCase()))return!1;if("true"===t)return!0;throw new Error(t+"无法转换为布尔类型！")}if("date"===e||"datetime"===e)return t;if("object"!==e)return t;if("object"==typeof t)return t;try{return JSON.parse(t)}catch(r){throw new Error(t+"无法转换为对象！")}},pi.decorators=[{type:d.Injectable}],pi.ctorParameters=function(){return[]},pi);function pi(){this.paramTypeTransform=!1,this.changes=new h.Subject,this.innerData=Object.assign({}),this._init()}var ui=new d.InjectionToken("@farris/devkit_param_type_transform"),ci=function Ep(t){this.name=t},li=(fi.prototype.initialize=function(t,e){this.frameContext=this.stateMachine&&this.stateMachine.frameContext||null,this.state=this.state||(e?e.name:""),this.parser=t,this.stateMachineEvent=this.stateMachine.stateMachineEvent},fi.prototype.transitTo=function(t){var e=this.stateMachine.states[t];e&&(this.state=e.name,this.stateMachine.render())},fi.prototype.parse=function(t,e){if(null===t||t===undefined)return t;var n=this.stateMachineEvent.getFrameContext(t)||this.stateMachine.frameContext;switch(e){case"source":return this.parseSourceValue(t,n);case"target":return this.parser.parse(t,n)}},fi.prototype.parseSourceValue=function(t,e){if(null===t||t===undefined)return t;var n=t.trim();return"state"===(n=this.parser.parse(n,e))&&(n=this.state),n},fi.prototype.get=function(t){return this.getUIState(t)},fi.prototype.getUIState=function(t){if(t){var e=this.stateMachineEvent.getFrameContext(t);if(e){if(this.stateMachineEvent.ListenUIStateChange(e,t),this.parser){var n=this.parser.parse(t,e);return null===n||"object"==typeof n&&0===Object.keys(n).length?null:n}throw new Error("未初始化变量解析器。")}}},fi.prototype.getData=function(t){if(t){var e=this.stateMachineEvent.getFrameContext(t);if(e){if(this.stateMachineEvent.ListenEntityChange(e,t),this.parser){var n=this.parser.parse(t,e);return null===n||"object"==typeof n&&0===Object.keys(n).length?null:n}throw new Error("未初始化变量解析器。")}}},fi);function fi(t){this.stateMachine=t}var hi=(Object.defineProperty(yi.prototype,"appContext",{get:function(){return this.stateMachine.appContext},enumerable:!0,configurable:!0}),yi.prototype.initialize=function(t){this.frameContext=t},yi.prototype.extractPaths=function(t){var n="";if("string"==typeof t){var e=t.match(/\{UISTATE~(\S+?)\}$/g),r=t.match(/\{DATA~(\S+?)\}$/g);if(null!==e){var i=/\{UISTATE~(\S+?)\}$/;e.forEach(function(t){var e=t.match(i);null!=e&&2===e.length&&(n=e[1])})}if(null!==r){var o=/\{DATA~(\S+?)\}$/;r.forEach(function(t){var e=t.match(o);null!=e&&2===e.length&&(n=e[1])})}}return n},yi.prototype.getFrameContext=function(t){var e=this.extractPaths(t).split("/")[1]||"";if(e.startsWith("#{")&&e.endsWith("}")&&this.frameContext){var n=e.substring(2,e.length-1);e=this.frameContext.namespace?this.frameContext.namespace+"_"+n:n}return this.appContext.getFrameContext(e)},yi.prototype.getFrameField=function(t){return this.extractPaths(t).split("/")[2]},yi.prototype.ListenUIStateChange=function(e,t){var n=this,r=this.getFrameField(t);this.frameContextMap.has(e)||(this.frameContextMap.set(e,this.uiFieldList),e.uiState.changes.subscribe(function(t){t.field&&-1<n.frameContextMap.get(e).indexOf(t.field)&&n.stateMachine.render()})),-1===this.frameContextMap.get(e).indexOf(r)&&this.uiFieldList.push(r)},yi.prototype.ListenEntityChange=function(e,t){var n=this;this.dataFrameContextMap.has(e)||(this.dataFrameContextMap.set(e,this.dataFieldList),e.bindingData.changes.subscribe(function(t){"Load"!==t.type&&"SelectionChanged"!==t.type||n.stateMachine.render(),t.path.join()&&n.isAccordingValue(n.dataFrameContextMap.get(e),t.path.join("/"))&&n.stateMachine.render()})),-1===this.dataFrameContextMap.get(e).indexOf(t)&&this.dataFieldList.push(t)},yi.prototype.isAccordingValue=function(t,e){return t.find(function(t){return-1<t.indexOf(e)})!==undefined},yi.decorators=[{type:d.Injectable}],yi.ctorParameters=function(){return[{type:gi}]},yi);function yi(t){this.stateMachine=t,this.uiFieldList=[],this.dataFieldList=[],this.frameContextMap=new Map,this.dataFrameContextMap=new Map}var di={transit:{perform:function(t,e,n){void 0===n&&(n=[]);var r=t.states[e];t.context.transitTo(r.name),t.render()}}},gi=(vi.prototype.initialize=function(t,e){this.appContext=t.appContext,this.frameContext=t;var n=this.appContext.metadata.stateMachine||this.collectionMetadata();this.metadatas=n,this.buildStateMachine(n),this.context.initialize(e,this.initialState),this.stateMachineEvent.initialize(this.frameContext),this.render()},vi.prototype.collectionMetadata=function(){var n={states:{},renderStates:{},actions:{}},t=O.getPropsMetadatas(this.constructor);return t&&Object.keys(t).forEach(function(e){t[e].forEach(function(t){switch(t.ngMetadataName){case"NgState":n.states[e]=t;break;case"NgRenderState":n.renderStates[e]=t;break;case"NgAction":n.actions[e]=t}})}),n},vi.prototype.buildStateMachine=function(e){var n=this;Object.keys(e.states).forEach(function(t){n.buildNgState(t,e.states[t])}),Object.keys(e.renderStates).forEach(function(t){n.buildNgRenderState(t,e.renderStates[t])}),Object.keys(e.actions).forEach(function(t){n.buildNgAction(t,e.actions[t])})},vi.prototype.buildNgState=function(t,e){this.states=this.states||{},this[t]=new ci(t),this.states[t]=this[t],e.initialState&&(this.initialState=this[t])},vi.prototype.buildNgRenderState=function(t,e){this.renderStates=this.renderStates||{},this[t]=!1,this.renderStates[t]=this[t],this.renders=this.renders||{},this.renders[t]=e.render},vi.prototype.buildNgAction=function(t,e){var n=this;this[t]=function(){di.transit.perform(n,e.transitTo,e.precondition)}},vi.prototype.render=function(){for(var t in this.renderStates)if(!1!==this.renderStates.hasOwnProperty(t)){var e=this.renders[t];e&&(this.renderStates[t]=e(this.context),this[t]=this.renderStates[t])}this.stateChange.next(this.context.state)},vi);function vi(){var n=this;this.isStateInited=!1;var t=O.getPropsMetadatas(this.constructor);t&&Object.keys(t).forEach(function(e){t[e].forEach(function(t){n["build"+t.ngMetadataName](e,t)})}),this.stateChange=new h.BehaviorSubject(!1),this.context=new li(this),this.stateMachineEvent=new hi(this)}var mi=w("NgState",function(t){return t}),Ei=w("NgRenderState",function(t){return t}),bi=w("NgAction",function(t){return t}),Ci="NgCommand",xi=w(Ci,function(t){return t}),Pi=(Object.defineProperty(Ii.prototype,"expression",{get:function(){return this.frameContext.expressionManager},enumerable:!0,configurable:!0}),Object.defineProperty(Ii.prototype,"expressionResult",{get:function(){return this.frameContext.expressionResult},enumerable:!0,configurable:!0}),Ii.prototype.setMetadata=function(t){!this.bindingPath&&t&&t.bindingTo&&(this.bindingPath=t.bindingTo)},Ii.prototype.init=function(t){var c=this;this.name||(this.name=t.metadata.viewModelCode||this.constructor.name),this.frameContext=t,this.bindingData=t.bindingData,this.uiState=t.uiState,this.form=t.form,this.stateMachine=t.stateMachine,this.buildCommands(t),this.entityValueChangingListeners=new Map,this.entityValueChangedListeners=new Map,this.bindingData&&this.bindingData.setValueChangeInvokerFactory(function(u){return function(t,e,n,r){var i,o="/"+u.join("/");if(i=!1===n?c.entityValueChangingListeners[o]:c.entityValueChangedListeners[o]){var a={paths:u,preValue:t,value:e,id:r,changed:n},s=i.split(";").filter(function(t){return t}),p=!0;return h.from(s).pipe(l.concatMap(function(t){return p?c[t](a).pipe(l.tap(function(t){p=t})):h.EMPTY}),l.every(function(t){return t}))}return h.of(!0)}}),this.initListeners()},Ii.prototype.buildCommands=function(i){var e=this,n=i.metadata.commands||O.getPropsMetadatasByName(this.constructor,Ci);this.metadatas=n,this.keybindingMap=new Map,Object.keys(n).forEach(function(t){var r=n[t];r.keyBinding&&e.keybindingMap.set(t,r.keyBinding),Object.defineProperty(e,t,{value:function(t){var e=i;r.frameId&&(e=i.appContext.getFrameContext(r.frameId));var n={name:r.name,params:r.params,paramDescriptions:r.paramDescriptions,eventParam:t||null};return e.commandBus.dispatch(n)}})})},Ii.prototype.initListeners=function(){var n=this,r=function(t,e){return"/"+t.split("/").concat(e.split(".")).filter(function(t){return 0<t.length}).join("/")};if(this.form){var i=this.form.getEntityValueChangingListeners();Object.keys(i).forEach(function(t){var e=r(n.bindingPath,t);n.entityValueChangingListeners[e]=i[t]});var o=this.form.getEntityValueChangedListeners();Object.keys(o).forEach(function(t){var e=r(n.bindingPath,t);n.entityValueChangedListeners[e]=o[t]})}},Ii.prototype.bindToParent=function(t){var e=this;t&&t.verifycationChanged&&t.verifycationChanged.subscribe(function(t){e.verifycationChanged.next(t)})},Ii.prototype.transform=function(t){if(Array.isArray(t)){var e=t.find(function(t){return t&&"wf"===t.source});return e&&e.value?this.transform(e.value):this.transform(t[0])}return"boolean"!=typeof t&&"string"==typeof t?new Function("ctx","return "+t).apply(this.frameContext,[this]):t},Ii.decorators=[{type:d.Injectable}],Ii.ctorParameters=function(){return[]},Ii);function Ii(){this.verifyInformations=[],this.verifycationChanged=new h.Subject}var Ti=(Mi.prototype.getParam=function(t){return this.params.get(t)},Mi.prototype.setParam=function(t,e){this.params.set(t,e)},Mi.decorators=[{type:d.Injectable}],Mi);function Mi(){this.params=new Map}var ji=(wi.prototype.getBindingDataMap=function(){return this.bindingDataMap},wi.prototype.getBindingDataByName=function(t){return this.bindingDataMap.get(t)},wi.prototype.regBindingData=function(t,e){this.bindingDataMap.set(t,e)},wi.prototype.unRegisteBindingData=function(t){this.bindingDataMap["delete"](t)},wi.prototype.ifBindingDataExits=function(t){return!!this.getBindingDataByName(t)},wi);function wi(){this.bindingDataMap=new Map}var Oi=(Si.prototype.regRepository=function(t,e){this.repositoryMap.set(t,e)},Si.prototype.unRegisteRepository=function(t){this.repositoryMap["delete"](t)},Si.prototype.getRepositoryMap=function(){return this.repositoryMap},Si.prototype.getRepositories=function(){return Array.from(this.repositoryMap.values())},Si.prototype.getRepositoryByName=function(t){return this.repositoryMap.get(t)},Si.prototype.ifRepositoryExits=function(t){return!!this.getRepositoryByName(t)},Si.decorators=[{type:d.Injectable}],Si.ctorParameters=function(){return[]},Si);function Si(){this.repositoryMap=new Map}var Ni=(Di.prototype.refreshComponents=function(){this.frameComponentMap.forEach(function(t,e){"function"==typeof t.onFormLoad&&t.onFormLoad()})},Di.prototype.regFrameComponent=function(t,e){this.frameComponentMap.set(t,e)},Di.prototype.unregFrameContext=function(t){var e=t.frameId;this.frameComponentMap["delete"](e)},Di);function Di(){this.frameComponentMap=new Map}var Vi=(Object.defineProperty(Fi.prototype,"frameContexts",{get:function(){return this.frameContextManager.getFrameContexts()},enumerable:!0,configurable:!0}),Fi.prototype.reattach=function(){var t=this;setTimeout(function(){t.frameContexts.forEach(function(t){t.frameComponent.reattach(),t.frameComponent.detectChanges()})})},Fi.prototype.detach=function(){this.frameContexts.forEach(function(t){t.frameComponent.detach()})},Fi);function Fi(t){this.frameContextManager=t}var Ri=(Bi.prototype.registerAppContext=function(t){this.appContextSet.add(t)},Bi.prototype.unregisterAppContext=function(t){this.appContextSet["delete"](t)},Bi.prototype.getAppContexts=function(){return Array.from(this.appContextSet)},Bi);function Bi(){this.appContextSet=new Set}var _i=(Ai.prototype.get=function(t){if(!Array.isArray(t)||t.length<1)throw new Error("Argument error !");if(!this.appContext||!this.appContext.componentRefs||this.appContext.componentRefs.size<1)return null;var e=this.appContext.componentRefs;return t.forEach(function(t){e=e&&e.get(t)||null}),e},Ai.prototype.getComponentsByFrameId=function(t){return!this.appContext||!this.appContext.componentRefs||this.appContext.componentRefs.size<1?null:this.appContext.componentRefs.get(t)},Ai);function Ai(t){this.appContext=t}var Li=new d.InjectionToken("@farris/devkit FORM_ID"),ki=($i.getMessager=function(){return window.igix_messagemanager||(window.igix_messagemanager=new $i),window.igix_messagemanager},$i.prototype.listner=function(n){window.addEventListener("message",function(t){var e=t.data;e.sender=t.source,n(e)})},$i.prototype.send=function(t){var e;t.target?(e=t.target,delete t.target):e=window,e.postMessage(t,"*")},$i.prototype.setAppContext=function(t){this.curAppContext=t},$i.prototype.getAppContext=function(){return this.curAppContext},$i);function $i(){}var Ui=function bp(){},Hi=function Cp(t){this.data=t},Ki=new d.InjectionToken("@farris/common-service ValidationHandler"),Gi=(zi.prototype.getElementByBinding=function(t,e){var n,r,i=[];try{for(var o=P(t),a=o.next();!a.done;a=o.next()){var s=a.value;if(s.fields){var p=this.getElementByBinding(s.fields,e);i.push.apply(i,b(p))}else s.contents?(p=this.getElementByBinding(s.contents,e),i.push.apply(i,b(p))):s.editor?(p=this.getElementByBinding([s.editor],e),i.push.apply(i,b(p))):s.binding&&s.binding.field===e&&i.push(s)}}catch(u){n={error:u}}finally{try{a&&!a.done&&(r=o["return"])&&r.call(o)}finally{if(n)throw n.error}}return i},zi);function zi(){}var qi=function xp(){},Ji=function Pp(t){this.Id=t.Id,this.Code=t.Code,this.Name=t.Name,this.Contents=JSON.stringify(t.Contents)},Wi=function Ip(){},Yi=function Tp(){},Zi=function Mp(){},Xi=(Qi.prototype.getFieldsByIds=function(t,e,n){var r=new Map,i=e.entities;if(i&&i.length&&n){var o=n.bindTo,a=this.getEntityFields(i,o),s=this.flattenFields(a);t.forEach(function(t){s.has(t)&&r.set(t,s.get(t))})}return r},Qi.prototype.flattenFields=function(t,e){var n,r;void 0===e&&(e=new Map);try{for(var i=P(t),o=i.next();!o.done;o=i.next()){var a=o.value;e.set(a.id,a),a.type&&a.type.fields&&0<a.type.fields.length&&this.flattenFields(a.type.fields,e)}}catch(s){n={error:s}}finally{try{o&&!o.done&&(r=i["return"])&&r.call(i)}finally{if(n)throw n.error}}return e},Qi.prototype.getEntityFields=function(t,e){var n,r;if(t&&t.length){var i=e.indexOf("/");-1<i&&(e=e.slice(i+1,e.length));try{for(var o=P(t),a=o.next();!a.done;a=o.next()){var s=a.value;if(""===e||e===s.code||e===s.label)return s.type.fields;var p=this.getEntityFields(s.type.entities,e);if(p&&p.length)return p}}catch(u){n={error:u}}finally{try{a&&!a.done&&(r=o["return"])&&r.call(o)}finally{if(n)throw n.error}}}return[]},Qi);function Qi(){}var to=(eo.prototype.buildAppContextMetadata=function(t,e){var n=t.module,r=n.states;return{identify:n.code,namespace:"",stateMachine:this.buildStataMachineMetadata(e),uiStates:this.buildUiStateMetadata(r)}},eo.prototype.buildViewContextMetadata=function(t,e,n,r){return{identify:t.id,namespace:"",commands:this.buildCommand(e.commands),commandHandlers:this.buildCommandHandlers(e.commands,r),commandHandlerExtends:[],form:this.buildFormMetadata(e),formControls:this.buildFormControlMetadata(e.fields,e,n,t),subForms:null,uiStates:this.buildUiStateMetadata(e.states),bindingTo:e.bindTo,viewModelCode:e.code}},eo.prototype.buildCommand=function(t){var e={};return t.reduce(function(t,e){var n={name:e.code,params:{},paramDescriptions:{}};return e.params.reduce(function(t,e){return t.params[e.name]=e.value,t.paramDescriptions[e.name]={type:"string"},t},n),t[e.code]=n,t},e),e},eo.prototype.buildFormMetadata=function(t){return{formGroupName:t.name,enableValidate:t.enableValidation}},eo.prototype.buildFormControlMetadata=function(t,e,n,s){var r={},i=t.map(function(t){return t.id}),p=(new Xi).getFieldsByIds(i,n,e),u=new Gi;return t.reduce(function(t,e){var n=p.has(e.id)?p.get(e.id):null,r=n?n.bindingPath:"",i=u.getElementByBinding(s.contents,e.id),o=[],a=i[0];return a&&Object.keys(a).forEach(function(t){"maxValue,minValue,required,require".includes(t)&&("maxValue"===t&&null!==a[t]&&a[t]!==undefined?o.push({type:"maxValue",constraints:[a[t]]}):"minValue"===t&&null!==a[t]&&a[t]!==undefined?o.push({type:"minValue",constraints:[a[t]]}):"required"!==t&&"require"!==t||"true"!==a[t]&&!0!==a[t]||o.push({type:"required",constraints:[!0]}))}),t[e.fieldName]={id:e.fieldName+"_"+e.id.substr(0,13).replace("-","_"),name:a?a.title:e.fieldName,binding:r,updateOn:e.updateOn,defaultI18nValue:a?a.title:e.fieldName,validRules:o},t},r),r},eo.prototype.buildStataMachineMetadata=function(i){var o=this,t={states:{},renderStates:{},actions:{}};return i&&(i.state.reduce(function(t,e){return t.states[e.state]={initialState:e.state===i.initialState},t},t),Object.keys(i.renderState).reduce(function(t,e){var n=i.renderState[e],r=o.buildRenderFunction(n);return t.renderStates[e]={render:r},t},t),Object.keys(i.action).reduce(function(t,e){var n=i.action[e];return t.actions[e]={precondition:n.precondition,transitTo:n.transitTo},t},t)),t},eo.prototype.buildUiStateMetadata=function(t){var e={};return t.reduce(function(t,e){return t[e.code]={stateName:e.code},t},e),e},eo.prototype.buildRenderFunction=function(t){if(t&&t.condition.length){var e=t.condition.reduce(function(t,e){var n=e.target;n.startsWith("'")||(n="'"+n),n.endsWith("'")||(n+="'");var r=e.source;r.indexOf("'")<0&&(r="'"+r+"'"),-1<r.indexOf("getUIState")&&(r=r.replace("getUIState","context.getUIState")),-1<r.indexOf("getData")&&(r=r.replace("getData","context.getData"));var i=(e.lBracket||"")+"context.parse("+r+",'source')"+e.compare+"context.parse("+e.target+",'target')"+(e.rBracket||"");if(e.relation)switch(e.relation.trim().toLocaleLowerCase()){case"or":i+="||";break;case"and":i+="&&"}return t+i},"");if(e)return new Function("context","return "+e+";")}return new Function("context","return true;")},eo.prototype.buildCommandHandlers=function(t,s){var e=[];return t.reduce(function(t,e){var n=e.code,r=e.cmpId,i=s[r],o=Object.assign({},i.methods[e.handlerName]);o.params=o.params.map(function(t){return Object.assign({},t)}),o.params&&o.params.length&&e.params.reduce(function(t,e){var n=t.params.find(function(t){return t.name===e.name});return n&&(n.expression=e.value),t},o);var a=new Hs(n,o);return t.push(a),t},e),e},eo);function eo(){}var no=(ro.prototype.getViewModelMap=function(){return this.viewModelMap},ro.prototype.getViewModelByName=function(t){return this.viewModelMap.get(t)},ro.prototype.register=function(t,e){this.viewModelMap.set(t,e)},ro.prototype.exsit=function(t){return!!this.getViewModelByName(t)},ro);function ro(){this.viewModelMap=new Map}var io=(oo.prototype.getContextMetadataMap=function(){return this.contextMetadataMap},oo.prototype.getContextMetadataByName=function(t){return this.contextMetadataMap.get(t)},oo.prototype.register=function(t,e){this.contextMetadataMap.set(t,e)},oo.prototype.exsit=function(t){return!!this.getContextMetadataByName(t)},oo);function oo(){this.contextMetadataMap=new Map}var ao,so=new d.InjectionToken("@farris/devkit FRAME_ID"),po=new d.InjectionToken("@farris/devkit NAMESPACE"),uo=new d.InjectionToken("@farris/frame_component_init_handler_token"),co=(c(lo,ao=Ti),Object.defineProperty(lo.prototype,"frameContexts",{get:function(){return this.frameContextManager.getFrameContextMap()},enumerable:!0,configurable:!0}),Object.defineProperty(lo.prototype,"formModule",{get:function(){return this.formMetadataContent?this.formMetadataContent.module:null},enumerable:!0,configurable:!0}),lo.prototype.initializeByMetadata=function(t,e,n){this.metadata=this.contextMetadataBuilder.buildAppContextMetadata(t,e),this.stateMachine||(this.stateMachine=this.injector.get(gi,new gi)),this.formMetadataContent=t,this.controllers=n},lo.prototype.registerToManager=function(){this.appContextManager&&this.appContextManager.registerAppContext(this)},lo.prototype.unregisterFromManager=function(t){if(this.appContextManager&&(this.appContextManager.unregisterAppContext(this),t)){var e=t.repository.name;this.repositoryManager.ifRepositoryExits(e)&&this.repositoryManager.unRegisteRepository(e),this.bindingDataManager.ifBindingDataExits(e)&&this.bindingDataManager.unRegisteBindingData(e)}},lo.prototype.regFrameContext=function(t){var e=t.repository,n=e.name;if(!1===this.repositoryManager.ifRepositoryExits(n)&&this.repositoryManager.regRepository(n,e),!1===this.bindingDataManager.ifBindingDataExits(n)){var r=null;this.runMode===x.RunMode.highSpeed&&(r=_n.createFromRepository(e,"/"),this.bindingDataManager.regBindingData(n,r))}this.frameContextManager.regFrameContext(t)},lo.prototype.regContextMetadata=function(t,e){this.contextMetadataManager.exsit(t)||this.contextMetadataManager.register(t,e)},lo.prototype.getFormAppContext=function(){return this},lo.prototype.destory=function(){this.isFormDestoryed=!0},Object.defineProperty(lo.prototype,"isDestoryed",{get:function(){return this.isFormDestoryed},enumerable:!0,configurable:!0}),Object.defineProperty(lo.prototype,"ApplicationId",{get:function(){return this.applicationId||(this.applicationId=pn.create()),this.applicationId},set:function(t){this.applicationId=t},enumerable:!0,configurable:!0}),Object.defineProperty(lo.prototype,"Token",{get:function(){return this.token||(this.token=pn.create()),this.token},set:function(t){this.token=t},enumerable:!0,configurable:!0}),lo.prototype.registerCommandHandler=function(t,e){this.frameComponentRefresher.regFrameComponent(t,e)},lo.prototype.refresh=function(){this.frameComponentRefresher.refreshComponents()},lo.prototype.getFrameContext=function(t){return this.frameContextManager.getFrameContextById(t)},lo.prototype.getContextById=function(t){return this.frameContextManager.getFrameContextById(t)},lo.prototype.getAllFrameContexts=function(){return this.frameContextManager.getFrameContextMap()},lo.prototype.handleSelectChange=function(r,i){var o=r.force||!1;this.frameContexts.forEach(function(t){if(t!==i&&t.repository===i.repository){var e=t.bindingData.getValue(r.path),n=r.value.id;(e&&e.currentId!==n||o)&&e.setCurrentId(n,!0,!1,o)}})},lo.prototype.initMessageEvent=function(){var a=this;if(this.parent&&this.parent!==this){var s,p=ki.getMessager();p.setAppContext(this),p.listner(function(t){var n=t.sender,e=t.data,r=p.getAppContext().frameContextManager.getFrameContextMap();if("wf-required-verification"===e.command){var i=a.injector.get(Ki,null,d.InjectFlags.Optional);i&&(s=i.validateAll())}else{var o=a.findHandler(r,e.command);o&&(s=o(e.arguments))}s&&s.pipe(l.throwIfEmpty()).subscribe(function(t){var e=new Hi(new Ui);e.data.result=!0,e.type="message",e.target=n,p.send(e)},function(){var t=new Hi(new Ui);t.data.result=!1,t.type="message",t.target=n,p.send(t)})})}},lo.prototype.findHandler=function(t,e){var n=b(t.values());for(var r in n){var i=n[r].viewModel;if(i&&i.hasOwnProperty(e))return i[e]}},lo.prototype.buildRenderViewContext=function(e){var t=this.formModule.viewmodels,n=this.formModule.components,r=this.formModule.schemas[0],i=n.find(function(t){return t.id===e}),o=t.find(function(t){return i.viewModel===t.id}),a=t.find(function(t){return t.id===o.parent});if(a){var s=n.find(function(t){return t.viewModel===a.id});s&&s.id}this.buildRenderViewContextRecursively(o,r)},lo.prototype.buildRenderViewContextRecursively=function(e,n){var r=this,t=this.controllers,i=this.formModule.components.find(function(t){return t.viewModel===e.id}),o=this.contextMetadataBuilder.buildViewContextMetadata(i,e,n,t);this.regContextMetadata(i.id,o);var a=this.formModule.viewmodels.filter(function(t){return t.parent===e.id});a&&a.length&&a.forEach(function(t){r.buildRenderViewContextRecursively(t,n)})},lo.prototype.getComponentProviders=function(t){var e=this.contextMetadataManager.getContextMetadataByName(t),n=new Vn,r=new On,i=e.namespace,o=this.injector.get(cn,null)||this.repository,a=this.stateMachine,s=new si,p=new Pi;return p.setMetadata(e),[{provide:so,useValue:t},{provide:po,useValue:i},{provide:Ss,useClass:Ss},{provide:lo,useValue:this},{provide:Vn,useValue:n},{provide:On,useValue:r},{provide:cn,useValue:o},{provide:gi,useValue:a},{provide:si,useValue:s},{provide:Pi,useValue:p},{provide:jr,useValue:new jr([new Sr,new Er,new Cr,new Pr,new Tr])}]},lo.decorators=[{type:d.Injectable}],lo.ctorParameters=function(){return[{type:d.Injector,decorators:[{type:d.Optional}]},{type:Ri,decorators:[{type:d.Optional}]},{type:lo,decorators:[{type:d.Optional},{type:d.SkipSelf}]}]},lo);function lo(t,e,n){var r=ao.call(this)||this;return r.typeName="AppContext",r.isFormDestoryed=!1,r.applicationId=null,r.token=null,r.useIsoluteEventBus=!1,r.metadata={},r.injector=t,r.appContextManager=e,r.formId=r.injector&&r.injector.get(Li,null)||null,r.runMode=r.injector&&r.injector.get(Bt,x.RunMode.compatible)||x.RunMode.compatible,Kn.setRunMode(r.runMode),r.params.set("formId",r.formId),r.params.set("appId",r.ApplicationId),r.params.set("token",r.Token),n?(r.parent=n,r.root=n.root):(r.parent=null,r.root=r),r.registerToManager(),r.frameContextManager=new fo(r),r.frameComponentRefresher=new Ni,r.repositoryManager=new Oi,r.bindingDataManager=new ji,r.changeDetectionController=new Vi(r.frameContextManager),r.messagePipe=new h.Subject,r.componentRefs=new Map,r.componentManager=new _i(r),r.contextMetadataManager=new io,r.opened=!1,r.router=r.injector&&r.injector.get(p.Router),r.viewModelManager=new no,r.contextMetadataBuilder=new to,r.variableParseService=new jr([new Sr,new Er,new Cr,new Pr,new Tr]),r.initMessageEvent(),r}var fo=(ho.prototype.regFrameContext=function(t){var e=t.frameId;if(!0===this.frameContextMap.has(e)){var n=this.frameContextMap.get(e);this.frameContextMap["delete"](e),this.frameContextSet["delete"](n)}t.index=this.frameContextSet.size,this.frameContextMap.set(e,t),this.frameContextSet.add(t)},ho.prototype.unregFrameContext=function(t){var e=t.frameId;this.frameContextMap["delete"](e),this.frameContextSet["delete"](t)},ho.prototype.getFrameContextMap=function(){return this.frameContextMap},ho.prototype.getFrameContexts=function(){return Array.from(this.frameContextSet)},ho.prototype.getFrameContextsByNamespace=function(e){return Array.from(this.frameContextSet).filter(function(t){return t&&t.namespace===e})},ho.prototype.getFrameContextById=function(t){var e=this.frameContextMap.get(t);return e||this.getFrameContextFromAllAppContexts(t)},ho.prototype.getRootFrameContext=function(){return this.getFrameContexts().find(function(t){return null===t.parent})},ho.prototype.getFrameContextFromAllAppContexts=function(n){var r;if(this.appContext.appContextManager)return this.appContext.appContextManager.getAppContexts().some(function(t){var e=t.frameContextManager.getFrameContextMap();return!0===e.has(n)&&(r=e.get(n),!0)}),r},ho.decorators=[{type:d.Injectable}],ho.ctorParameters=function(){return[{type:co}]},ho);function ho(t){this.frameContextMap=new Map,this.frameContextSet=new Set,this.appContext=t}var yo=(go.prototype.post=function(t,e){this.eventBus.post(this.hostType,this.eventTokenValueProvider(),t,e)},go);function go(t,e,n){this.eventBus=t,this.hostType=e,this.eventTokenValueProvider=n}var vo,mo="NgDeclaration";(vo=x.EventTypeEnum||(x.EventTypeEnum={}))[vo.COMPONENT=0]="COMPONENT",vo[vo.ROUTE=1]="ROUTE";var Eo=(bo.prototype.init=function(t){t&&this.bindDeclaration(t,null)},bo.prototype.initWithDeclarations=function(t,e){t&&this.bindDeclaration(t,null)},bo.prototype.bindDeclaration=function(t,e){var c=this,n=t.context;if(n){var r=e||this.getNgPublicEvent();r&&Object.keys(r).forEach(function(t){var e=r[t];Object.defineProperty(c,t,{value:function(){var r=n,i=e.token,o=e.token,a=e.name,s=JSON.parse(JSON.stringify(e.params)),p=e.type;if(r.eventBus){var u=r.injector.get(jr);setTimeout(function(){s=u.parse(s,r);var t=r.frameComponent,e=r,n=(new Date).valueOf();if(p&&p===x.EventTypeEnum.ROUTE)for(;e;)e.eventBus.post(i,o,a,s,t,p,n),e=c.getParentContext(e);else e.eventBus.post(i,o,a,s,t)},0)}}})})}},bo.prototype.getNgPublicEvent=function(){return O.getPropsMetadatasByName(this.constructor,mo)},bo.prototype.getParentContext=function(t){if(t.parent)return t.parent;var e=t.appContext.parent;return e?e.frameContextManager.getRootFrameContext():null},bo.decorators=[{type:d.Injectable}],bo.ctorParameters=function(){return[]},bo);function bo(){}var Co="NgSubscription",xo=function jp(){};var Po,Io,To=(Mo.prototype.init=function(t){if(t)return this.bindSubscription(t,null)},Mo.prototype.initWithSubscriptions=function(t,e){if(t)return this.bindSubscription(t,e)},Mo.prototype.bindSubscription=function(u,t){var c=this,l=u.context;if(l){var f=t||this.getNgEvents(u);if(f){var h=[];return Object.keys(f).forEach(function(t){var e=f[t],r=l,i=u,n=e.token,o=e.token,a=e.name,s=e.paramMapCollection,p=r.eventBus.on(n,o,a,i,function(t){c.subscriptionHandler(t,s,r);var e=u[a];if(e)try{e(i,t)}catch(n){throw new Error("Error invoking method "+a)}});h.push(p)}),h}}},Mo.prototype.getNgEvents=function(t){return O.getPropsMetadatasByName(t.constructor,Co)},Mo.prototype.subscriptionHandler=function(t,e,n){t&&e&&!(e.length<=0)&&n&&this.paramMap2UiState(t,e,n)},Mo.prototype.paramMap2UiState=function(t,e,n){for(var r=0;r<e.length;r++){var i=e[r].from,o=e[r].frameId,a=e[r].to;if(i&&o&&a){var s=this.getFrameContext(o,n);null!=s&&this.setUiStateProperty(a,t[i],s.uiState)}}},Mo.prototype.getFrameContext=function(t,e){var n=null;try{n=e.appContext.getFrameContext(t)}catch(r){throw new Error("Error in Getting FrameContext")}return n},Mo.prototype.setUiStateProperty=function(t,e,n){try{n.setPropertyValue(t,e)}catch(r){throw new Error("Error in Setting Property Value of the current UISTATE"+n)}},Mo.decorators=[{type:d.Injectable}],Mo);function Mo(){}(Io=Po=Po||{})[Io.Compile=0]="Compile",Io[Io.Parsing=1]="Parsing";var jo=(wo.prototype.post=function(t,e,n,r){var i={args:t,sender:e,eventType:n,eventId:r};this.eventSubject.next(i)},wo.prototype.subscribe=function(o,a){var s=this,t=this.subscriptionMap.get(a);null!=t&&(t.unsubscribe(),this.subscriptionMap["delete"](a));var e=this.eventSubject.subscribe(function(t){var e=t.args,n=t.sender,r=t.eventType||null,i=t.eventId||0;s.lastEventId>=i||(s.lastEventId=i,r!==x.EventTypeEnum.ROUTE&&!1===s.isInSampeScope(n,a)||o.call(a,e))});return this.subscriptionMap.set(a,e),this},wo.prototype.subscribeOnce=function(e,n){var t=this.eventSubject.subscribe(function(t){return e.call(n,t)});return this.onceSubscriptionMap.set(n,t),this},wo.prototype.unSubscribe=function(t){var e=this.subscriptionMap.get(t);e?(e.unsubscribe(),e=null,this.subscriptionMap["delete"](t)):(e=this.onceSubscriptionMap.get(t))&&(e.unsubscribe(),e=null,this.onceSubscriptionMap["delete"](t))},wo.prototype.unSubscribeForOnce=function(){var t,e;try{for(var n=P(Array.from(this.onceSubscriptionMap.keys())),r=n.next();!r.done;r=n.next()){var i=r.value;this.unSubscribe(i)}}catch(o){t={error:o}}finally{try{r&&!r.done&&(e=n["return"])&&e.call(n)}finally{if(t)throw t.error}}},wo.prototype.matchEmitterToken=function(t,e){return!(this.emitter&&t&&this.emitter!==t||this.tokenValue&&e&&this.tokenValue!==e)},wo.prototype.examByTargetToken=function(t,e){return this.emitter===t&&this.tokenValue===e},wo.prototype.dispose=function(t){var e=this;if(this.unSubscribe(t),0===this.subscriptionMap.size&&this.parentEventPipeList){var n=this.parentEventPipeList.findIndex(function(t){return t===e});-1!==n&&this.parentEventPipeList.splice(n,1)}},wo.prototype.disposeByCaller=function(t){var e=this.subscriptionMap.get(t);null!=e&&(e.unsubscribe(),this.subscriptionMap["delete"](t))},wo.prototype.isInSampeScope=function(t,e){if(this.eventPipeType===Po.Parsing)return!0;if(!t)return!0;if(t===e)return!0;if(!(t.context&&t.context.appContext&&e.context&&e.context.appContext))return!1;var n=t.context.appContext,r=e.context.appContext;return n===r||!!(n.useIsoluteEventBus&&n.isoluteEventBus||r.useIsoluteEventBus&&r.isoluteEventBus)},wo);function wo(t,e,n,r){this.name=t,this.tokenValue=e,this.emitter=n,this.parentEventPipeList=r,this.lastEventId=-1,this.eventPipeType=Po.Compile,this.eventSubject=new h.Subject,this.subscriptionMap=new Map,this.onceSubscriptionMap=new Map,this.parentEventPipeList&&this.parentEventPipeList.push(this)}var Oo=(So.prototype.getProxy=function(t,e){var n=t.constructor.typeName||t.constructor.name;return this.proxyMap.has(n)||this.proxyMap.set(n,new yo(this,t,e)),this.proxyMap.get(n)},So.prototype.post=function(t,e,n,r,i,o,a){var s,p,u=this.eventMap.get(n);if(u)if(t){var c;c=t instanceof d.Type?t.typeName||t.name:t,void 0===a&&(a=(new Date).valueOf());try{for(var l=P(u),f=l.next();!f.done;f=l.next()){var h=f.value;h.matchEmitterToken(c,e)&&(h.post(r,i,o,a),h.unSubscribeForOnce())}}catch(y){s={error:y}}finally{try{f&&!f.done&&(p=l["return"])&&p.call(l)}finally{if(s)throw s.error}}}else console.error("post方法的参数emitterType不能为空。")},So.prototype.on=function(t,e,n,r,i){return this.getEventPipe(n,t,e).subscribe(i,r)},So.prototype.once=function(t,e,n,r,i){return this.getEventPipe(n,t,e).subscribeOnce(i,r)},So.prototype.requestFor=function(t,e,n,r,i,o){var a=this.findExistEventPipe(n,"RequestSubject",e);a?(this.once(t,e,n,this,function(t){"success"===t.status?i(t.data):o&&o("No target responser listening")}),a.post({target:t,token:e,data:r})):o&&o("No target responser listening.")},So.prototype.responseOn=function(n,r,i){var o=this;this.on("RequestSubject",null,r,this,function(t){var e={status:"fail",data:null};n===t.target&&(e.data=i(t.data),e.status="success"),o.post(t.target,t.token,r,e)})},So.prototype.getEventPipe=function(t,e,n){var r=this.eventMap.get(t);return r||(r=new Array,this.eventMap.set(t,r)),new jo(t,n,e,r)},So.prototype.findExistEventPipe=function(t,e,n){var r,i,o=this.eventMap.get(t);if(!o)return null;try{for(var a=P(o),s=a.next();!s.done;s=a.next()){var p=s.value;if(p.matchEmitterToken(e,n))return p}}catch(u){r={error:u}}finally{try{s&&!s.done&&(i=a["return"])&&i.call(a)}finally{if(r)throw r.error}}return null},So.decorators=[{type:d.Injectable}],So.ctorParameters=function(){return[]},So);function So(){this.proxyMap=new Map,this.eventMap=new Map}var No=(Do.setToken=function(t,e){Do.tokens.set(t,e)},Do.getToken=function(t){return Do.tokens.get(t)},Do.tokens=new Map,Do);function Do(){}var Vo,Fo,Ro,Bo,_o,Ao,Lo,ko=new d.InjectionToken("@farris/devkit ExceptionHandler"),$o=new d.InjectionToken("@farris/devkit UserSettingsToken");Vo=x.Expression||(x.Expression={}),(Fo=Vo.ExpressionBindingType||(Vo.ExpressionBindingType={})).State="State",Fo.Field="Field",(Ro=Vo.ExpressionType||(Vo.ExpressionType={})).Required="require",Ro.Readonly="readonly",Ro.Compute="compute",Ro.Dependency="dependency",Ro.Visible="visible",Ro.Relative="relative",Ro.Validate="validate",Ro.DataPicking="dataPicking",(Bo=Vo.EventType||(Vo.EventType={})).ValueChanged="VALUE_CHANGED",Bo.SelectionChanged="SELECTION_CHANGED",Bo.Load="Load",Bo.Append="Append",Bo.Remove="Remove",Bo.Update="Update",(_o=Vo.EventSource||(Vo.EventSource={})).Field="Field",_o.State="State",_o.BindingData="BindingData",_o.Repository="Repository",(Ao=Vo.MessageType||(Vo.MessageType={})).error="error",Ao.info="info",Ao.warning="warning",(Lo=Vo.EffectPath||(Vo.EffectPath={}))[Lo.currentRow=0]="currentRow",Vo.MESSAGE={"zh-CHS":{require:"请输入'$property'",validate:"'$property'校验不通过",dataPicking:"帮助前表达式校验不通过"},en:{require:"Please input '$property'",validate:"'$property' calibration failed",dataPicking:"Failed to verify the expression before help"},"zh-CHT":{require:"請輸入'$property'",validate:"'$property'校驗不通過",dataPicking:"幫助前表達式校驗不通過"}},Vo.DEPENDENCY_SPLITER="/";var Uo=new d.InjectionToken("@farris/form_manifest_service"),Ho=new d.InjectionToken("@farris/form_expression_manifest_service"),Ko=(Go.prototype.load=function(){var i=this;return this.formExpressionManifestService.load().pipe(l.switchMap(function(t){var r=[];return Array.from(t).forEach(function(n){n.expressions.forEach(function(t){var e={id:t.id,ns:n.ns,path:n.path,bindingType:n.type,type:t.type,expression:t.value||t.expr||"",message:t.message||null,messageType:t.messageType||null,deps:[]};t.type!==x.Expression.ExpressionType.Required&&t.type!==x.Expression.ExpressionType.Validate&&t.type!==x.Expression.ExpressionType.DataPicking||(t.message||(e.message=i.getExpressionMessage(t.type)),t.messageType||(e.messageType="error")),e.message&&i.transform(e),r.push(e)})}),i._expressions=r,i.cleanSpecialCharacters(),h.of(r)}),l.catchError(function(t){return h.of([])}))},Object.defineProperty(Go.prototype,"expressions",{get:function(){return this._expressions?h.of(this._expressions):this.load()},enumerable:!0,configurable:!0}),Go.prototype.getExpressionById=function(e){return!this._expressions||this._expressions.length<1?null:this._expressions.find(function(t){return t.id===e})},Go.prototype.getExpressionMessage=function(t,e){if(t!==x.Expression.ExpressionType.Validate&&t!==x.Expression.ExpressionType.Required&&t!==x.Expression.ExpressionType.DataPicking)return null;if(!this.translate)return e;var n=this.translate.getCurrentLanguage()||"zh-CHS";return x.Expression.MESSAGE[n][t]},Go.prototype.transform=function(t){this.translate&&t.message&&t.message.startsWith("{{")&&t.message.endsWith("}}")&&(t.message=this.translate.transform(t.message.substr(2,t.message.length-4),null)||this.getExpressionMessage(t.type))},Go.prototype.cleanSpecialCharacters=function(){var r=this;if(this._expressions&&!(this._expressions.length<1)&&Array.isArray(this._expressions)){var t=this.injector.get(cn,null);if(t){var e=t.entityTypeInfo,i=new RegExp("[\\'\\\"]?\\s*("+e.entityInfo.nodeCode+"|"+e.entityInfo.originalCode+")[\\.\\[\\]a-zA-Z0-9_]+\\s*[\\'\\\"]?","g");this._expressions.forEach(function(n){var t=n.expression.match(i);Array.isArray(t)&&0<t.length&&t.forEach(function(t){if(-1!==t.indexOf(".")){if(/\[\d\]/g.test(t)){var e=t.replace(/\[\d\]/g,"");n.expression=r.replaceAll(n.expression,t,e)}/\*/g.test(t)&&(e=t.replace(/\*/g,""),n.expression=r.replaceAll(n.expression,t,e))}else console.warn("无效的实体表达式:"+t)})})}}},Go.prototype.replaceAll=function(t,e,n){return t.split(e).join(n)},Go.decorators=[{type:d.Injectable}],Go.ctorParameters=function(){return[{type:d.Injector},{type:undefined,decorators:[{type:d.Inject,args:[Ho]}]},{type:undefined,decorators:[{type:d.Optional},{type:d.Inject,args:[zr]}]}]},Go);function Go(t,e,n){this.injector=t,this.formExpressionManifestService=e,this.translate=n,this._expressions=null}var zo=new d.InjectionToken("@Farris listener"),qo=(Object.defineProperty(Jo.prototype,"onEvent",{get:function(){return this.subject},enumerable:!0,configurable:!0}),Jo.prototype.findEntityPaths=function(t,n,r){var i=this;void 0===r&&(r=[]);var e=t.getPropInfosByGroup(x.DataPropGroup.List);e&&0<e.length?e.forEach(function(t){r.push(t.name);var e=t.typeInfo.getPropInfosByGroup(x.DataPropGroup.List);e&&0<e.length?e.forEach(function(t){i.findEntityPaths(t.typeInfo,n,r)}):n.push(r)}):r&&0<r.length&&n.push(r)},Jo);function Jo(){this.subject=new h.Subject}var Wo=(Yo.prototype.compile=function(t,e){if("[object Object]"!==Object.prototype.toString.call(e))throw new Error("上下文必须为对象！");var n=this.buildContext(e);if(!t.factory){var r=new u.Expression(t.expression,n);t.factory=r.compile()}return t.factory.eval(n)},Yo.prototype.eval=function(t,e){if("[object Object]"!==Object.prototype.toString.call(e))throw new Error("上下文必须为对象！");var n=this.buildContext(e);return new u.ExpressionEngine(n).eval(t)},Yo.prototype.buildContext=function(e){var n=new u.ExpressionContext;return e&&0<Object.keys(e).length&&Object.keys(e).forEach(function(t){n.set(t,e[t])}),n},Yo.decorators=[{type:d.Injectable}],Yo);function Yo(){}var Zo=(Xo.prototype.set=function(t,e){this[t]=e},Xo.decorators=[{type:d.Injectable}],Xo.ctorParameters=function(){return[{type:d.Injector}]},Xo);function Xo(t){this.injector=t}var Qo=(ta.prototype.eval=function(t,e,n){var r=this.expressionRegistry.getExpressionById(t);if(r){var i={},o=e&&e.bindingPath||null;if(o&&n){var a=o.split("/").filter(function(t){return t}),s=this.frameContext.bindingData.getValue(a),p="id";s&&(p=s.primaryKey);var u=n[p]||s.currentId;u&&(i.currentRows=[{bindingPath:a.join("/"),primaryValue:u}])}var c=this.execute(r.expression,i);return r.type!==x.Expression.ExpressionType.Readonly&&r.type!==x.Expression.ExpressionType.Required&&r.type!==x.Expression.ExpressionType.Visible||(c=!0===c),this.expressionResult.set(t,c),c}return undefined},ta.prototype.validate=function(t,e){var n=this.expressionRegistry.getExpressionById(t);if(n){var r=e&&e.patch||null,i={};r&&(i.patch=r);var o=e.currentRow||null,a=e.currentRows||[];o&&(i.currentRows=i.currentRows||[],i.currentRows.push(o)),a&&0<a.length&&(i.currentRows=i.currentRows||[],Array.prototype.push.apply(i.currentRows,a));var s=this.execute(n.expression,i);return this.expressionResult.set(t,s),s}return console.warn("ExpressionManager 执行失败，未获取到表达式!"),undefined},ta.prototype.onDataPicking=function(t){var e=t&&t.expressionId||null;if(!e)return console.warn("ExpressionManager 相关表达式设置错误，没有表达式编号。"),h.of(!0);var n=this.eval(e);if(n)return h.of(n);var r=this.expressionRegistry.getExpressionById(e);if(!r)return console.warn("ExpressionManager 无法找到对应的表达式"+e),h.of(!0);var i=r.messageType||x.Expression.MessageType.warning,o=r.message;return o&&this.notifyService[i](o,{hideTitle:!0}),h.EMPTY},ta.prototype.execute=function(t,e){var n,r=this.resolveService.resolve(t),i=In.getGroupFunctionDependency(t,this.frameContext.repository.entityTypeInfo),o=this.buildEntityContext(r,i,e),a=this.buildStateContext(),s=e&&e.contexts||null,p=this.injector.get(zr,null),u=E(((n={})[this.entityOriginalNodeCode]=o,n),a,{BigNumber:y.BigNumber,frameContext:this.frameContext,bindingData:this.frameContext.bindingData,repository:this.frameContext.repository,CurrentLanguage:p.getCurrentLanguage()||"zh-CHS"},s);return o?this.expressionExecutor.eval(t,u):undefined},ta.prototype.executeAsync=function(t,e){var n=this.execute(t,e);return h.of(n)},ta.prototype.buildEntityContext=function(t,n,e){var r=this,i=e&&e.currentRows||null,o=-1!==t.findIndex(function(e){return!!r.isEntityDependency(e)&&-1!==n.findIndex(function(t){return t===e})&&1==e.split("/").filter(function(t){return t}).length-1}),a={};i&&0<i.length&&i.forEach(function(t){a[t.bindingPath||"/"]=t.primaryValue});var s=this.getEntity(a),p=e&&e.patch||null;if(!s)return null;if(p&&0<Object.keys(p).length&&Object.keys(p).forEach(function(t){var e=t.split("/").filter(function(t){return t}),n=p[t];r.setValue(s,e,n)}),o){var u=this.frameContext.repository.entityCollection.toJSON();s.__type__="List",s.__items__=u}return s},ta.prototype.setValue=function(t,e,n){if(1===e.length)t[e[0]]=n;else{var r=e.pop();e.reduce(function(t,e){return t&&t[e]},t)[r]=n}},ta.prototype.isEntityDependency=function(t){return t.startsWith(He)},ta.prototype.getEntity=function(d){var g=this,t=this.frameContext.repository.entityTypeInfo,v=this.frameContext.bindingData,e=[],m=null;return(m=d["/"]?(m=this.frameContext.bindingData.list.findById(d["/"]))&&m.toJSON():this.frameContext.bindingData.list.currentItem.toJSON())?(In.getChildrenEntityPaths(t,e),m.__type__="Entity",!e||e.length<1||e.forEach(function(n){var t=null;if(d&&d[n.join("/")]){var e=n.slice(0,1);if(2==n.length&&d[e.join("/")]){var r=d[e.join("/")];t=g.getPropertyValue(m,e.concat([r,n[1],d[n.join("/")]]))}else{var i=v.getValue(n),o=d[n.join("/")],a=null;(a=o!==i.currentId?i.findById(o):i.currentItem)&&a.primaryKeyValue&&(t=a.toJSON())}}else if(d&&Object.keys(d).find(function(t){var e=t.split("/").join("/");return n.join("/").startsWith(e)})){var s=d&&d["/"]||v.list.currentId,p=g.frameContext.repository.entityCollection.getEntityById(s),u=[],c=n.reduce(function(t,e){u.push(e);var n=t&&t[e];if(n){var r=d&&d[u.join("/")]||n.items[0]&&n.items[0].primaryValue||null;if(r)return n.get(r)||null}return null},p);t=c?c.toJSON():{}}else t=In.getCurrentRowByPaths(n,v);var l=n.pop(),f=n.reduce(function(t,e){return t&&t[e]||null},m),h=f[l],y=E({__items__:[]},t&&t||{},{__type__:"List"});y.length=function(){return y.__items__.length},h&&Array.isArray(h)&&(y.__items__=[].concat(h)),f[l]=y}),m):null},ta.prototype.getPropertyValue=function(t,e){return e.reduce(function(t,e){return"List"===t.__type__?t.__items__.find(function(t){return t.id===e}):Array.isArray(t)?t.find(function(t){return t.id===e}):t&&t[e]},t)},Object.defineProperty(ta.prototype,"entityOriginalNodeCode",{get:function(){var t=this.injector.get(cn);return t&&t.entityTypeInfo&&t.entityTypeInfo.entityInfo&&t.entityTypeInfo.entityInfo.originalCode||null},enumerable:!0,configurable:!0}),ta.prototype.buildStateContext=function(){var e={};if(this.frameContext){var t=this.frameContext.getVirtualRootFrameContext();if(t){var n=t.viewModel.uiState;(Object.getOwnPropertyNames(n)||[]).forEach(function(t){null!==t.match(/^[a-zA-Z0-9_\$]+$/g)&&(e[t]=n[t])})}}return e},ta.decorators=[{type:d.Injectable}],ta.ctorParameters=function(){return[{type:d.Injector},{type:xn},{type:Wo},{type:Ko},{type:Zo},{type:undefined,decorators:[{type:d.Inject,args:[_e]}]},{type:undefined,decorators:[{type:d.Inject,args:[Ae]}]}]},ta);function ta(t,e,n,r,i,o,a){this.injector=t,this.resolveService=e,this.expressionExecutor=n,this.expressionRegistry=r,this.expressionResult=i,this.messageService=o,this.notifyService=a,this.frameContext=null,this.frameContext=this.injector.get(Ss,null)}var ea=(na.prototype.registeEvent=function(){var n=this;this.expressionRegistry.expressions.subscribe(function(t){t.forEach(function(t){if(!(t.deps&&0<t.deps.length)){var e=n.expressionManager.eval(t.id);n.expressionResult[t.id]=e}})})},na.decorators=[{type:d.Injectable}],na.ctorParameters=function(){return[{type:d.Injector},{type:Ko},{type:Qo},{type:Zo}]},na);function na(t,e,n,r){this.injector=t,this.expressionRegistry=e,this.expressionManager=n,this.expressionResult=r,this.registeEvent()}var ra,ia=new d.InjectionToken("@Farris expression assigner"),oa=new d.InjectionToken("@Farris_event_handler"),aa=(c(sa,ra=qo),sa.prototype.buildEventPath=function(t){return null},sa.prototype.registerEvent=function(){var n=this;this.uiState&&this.uiState.changes&&this.uiState.changes.subscribe(function(t){var e={ns:n.namespace,path:[t.field],type:x.Expression.EventType.ValueChanged,value:t.value,source:x.Expression.EventSource.State,frameId:n.frameId};n.subject.next(e)})},sa.decorators=[{type:d.Injectable}],sa.ctorParameters=function(){return[{type:d.Injector},{type:si},{type:undefined,decorators:[{type:d.Inject,args:[po]}]},{type:String,decorators:[{type:d.Inject,args:[so]}]},{type:Vn}]},sa);function sa(t,e,n,r,i){var o=ra.call(this)||this;return o.injector=t,o.uiState=e,o.namespace=n,o.frameId=r,o.bindingData=i,o.registerEvent(),o}x.Expression.EventType;var pa,ua=(c(ca,pa=qo),ca.prototype.registerEvent=function(){var i=this;this.repository&&this.repository.changes&&this.repository.changes.subscribe(function(t){var e=i.convertEventType(t);if(e){var n=i.buildEventPath(t),r={ns:i.namespace,type:e,path:n,value:t.value,source:x.Expression.EventSource.Field};i.subject.next(r)}}),this.repository&&this.repository.entityCollectionChange&&this.repository.entityCollectionChange.subscribe(function(t){var e=i.convertEventType(t);if(e){var n=i.buildEventPath(t),r={ns:i.namespace,type:e,path:n,value:t.value,source:x.Expression.EventSource.Repository};i.subject.next(r)}})},ca.prototype.buildEventPath=function(t){var n=this,e=t.path,r=[];return!e||e.length<1?r:r=e.filter(function(t,e){if(e%2==0&&t.includes(":")){if(":"===t)return!1;if(t.split(":")[0]!==n.repository.primaryKey)return!1}return!0})},ca.prototype.convertEventType=function(t){var e=null;return t.type===x.ModifyType.Add||t.type===x.ModifyType.AddData||t.type===x.ModifyType.Insert||t.type===x.ModifyType.Remove||t.type===x.ModifyType.RemoveData||t.type===x.ModifyType.Load||t.type===x.ModifyType.ValueChange||t.type===x.ModifyType.Update&&(e=x.Expression.EventType.Update),e},ca.decorators=[{type:d.Injectable}],ca.ctorParameters=function(){return[{type:d.Injector},{type:cn},{type:undefined,decorators:[{type:d.Inject,args:[po]}]}]},ca);function ca(t,e,n){var r=pa.call(this)||this;return r.injector=t,r.repository=e,r.namespace=n,r.bindingData=r.injector.get(Vn,null),r.registerEvent(),r}var la=(fa.decorators=[{type:d.Injectable}],fa.ctorParameters=function(){return[{type:Array,decorators:[{type:d.Optional},{type:d.Inject,args:[zo]}]},{type:d.Injector,decorators:[{type:d.Optional}]}]},fa);function fa(t,e){this.listeners=t,this.injector=e}var ha,ya=x.Expression.EventType,da=(c(ga,ha=qo),ga.prototype.registerEvent=function(){var i=this;this.bindingData&&this.bindingData.changes&&"function"==typeof this.bindingData.changes.subscribe&&this.bindingData.changes.subscribe(function(t){if(t.type===x.ChangeType.Append&&!0!==t.isCloned||t.type===x.ChangeType.ValueChanged||t.type===x.ChangeType.Remove||t.type===x.ChangeType.Load||t.type===x.ChangeType.SelectionChanged){var e=null;t.type===x.ChangeType.Append?e=ya.Append:t.type===x.ChangeType.ValueChanged?e=ya.ValueChanged:t.type===x.ChangeType.Remove?e=ya.Remove:t.type===x.ChangeType.Load?e=!0===t.create?ya.Append:ya.Load:t.type===x.ChangeType.SelectionChanged&&(e=ya.SelectionChanged);var n=i.buildEventPath(t),r={ns:i.namespace,path:n,type:e,source:x.Expression.EventSource.BindingData,value:t.value,id:t.id};i.subject.next(r)}})},ga.prototype.buildEventPath=function(t){var e=t.path,n=[],r=this.bindingData.list.currentItem.primaryKeyValue;r&&(t.type===x.ChangeType.Load&&0===t.path.length||n.push(this.bindingData.list.primaryKey+":"+r));for(var i=[],o=0;o<e.length;o++){var a=e[o];i.push(a);var s=this.bindingData.getValue(i);if(n.push(a),s instanceof Rn&&i.length<e.length){var p=s.currentItem.primaryKeyValue;o===e.length-2&&t.id&&(p=t.id),n.push(this.bindingData.list.primaryKey+":"+p)}}return n},ga.decorators=[{type:d.Injectable}],ga.ctorParameters=function(){return[{type:d.Injector},{type:Vn},{type:undefined,decorators:[{type:d.Inject,args:[po]}]}]},ga);function ga(t,e,n){var r=ha.call(this)||this;return r.injector=t,r.bindingData=e,r.namespace=n,r.repository=null,r.repository=r.injector.get(cn,null),r.registerEvent(),r}var va=(Object.defineProperty(ma.prototype,"onEvent",{get:function(){return this.subject},enumerable:!0,configurable:!0}),ma.prototype.regist=function(){var e=this,t=this.registry&&this.registry.listeners||[];t&&0<t.length&&t.forEach(function(t){t.onEvent.subscribe(function(t){e.subject.next(t)})})},ma.decorators=[{type:d.Injectable}],ma.ctorParameters=function(){return[{type:la,decorators:[{type:d.Optional}]}]},ma);function ma(t){this.registry=t,this.subject=new h.Subject,this.regist()}var Ea=(ba.prototype.attach=function(){return this.onEvent||(this.onEvent=new h.BehaviorSubject(this.events)),this.onEvent.asObservable()},ba.decorators=[{type:d.Injectable}],ba.ctorParameters=function(){return[{type:va}]},ba);function ba(t){var n=this;this.listeners=t,this.events=new Array,this.listeners.onEvent.subscribe(function(t){if(n.onEvent&&0<n.onEvent.observers.length){var e=[];0<n.events.length&&(e=b(n.events)),e.push(t),n.onEvent.next(e),n.events=[]}else n.events.push(t)})}var Ca=new d.InjectionToken("@farris/effector_token"),xa=(Pa.prototype.effect=function(t,e,n){if(!n||!n.path)throw new Error("repository effector 需要指定行信息。");var r=n.path,i=r[0]||this.bindingData.list.currentItem.primaryKeyValue,o=this.repository.entityCollection.getEntityById(i);if(!i||o){for(var a=r.pop(),s=o,p=1;p<r.length;p++){var u=r[p];s=s instanceof St?s.get(u):s[u]}s?s[a]!==e&&(s[a]=e):console.error("找不到实体对应的路径："+r.push(a))}else console.error("找不到id："+i+"对应的实体！")},Pa.decorators=[{type:d.Injectable}],Pa.ctorParameters=function(){return[{type:d.Injector},{type:cn},{type:undefined,decorators:[{type:d.Inject,args:[po]}]},{type:Vn}]},Pa);function Pa(t,e,n,r){this.injector=t,this.repository=e,this.namespace=n,this.bindingData=r,this.ns=n}var Ia=(Ta.prototype.effect=function(t,e,n){this.uiState.setPropertyValue(t,e)},Ta.decorators=[{type:d.Injectable}],Ta.ctorParameters=function(){return[{type:d.Injector},{type:si},{type:undefined,decorators:[{type:d.Inject,args:[po]}]}]},Ta);function Ta(t,e,n){this.injector=t,this.uiState=e,this.namespace=n,this.ns=n}var Ma=(ja.prototype.effect=function(t,e,n){},ja.decorators=[{type:d.Injectable}],ja.ctorParameters=function(){return[{type:d.Injector},{type:undefined,decorators:[{type:d.Inject,args:[po]}]},{type:Ss}]},ja);function ja(t,e,n){this.injector=t,this.namespace=e,this.frameContext=n,this.ns=e}var wa=(Oa.prototype.effect=function(t,e,n){if(!n||!n.path)throw new Error("DependencyEffector 需要指定行信息。");"boolean"!=typeof e&&console.warn("DependencyEffector 依赖表达式计算结果应该为true/false，当前值为："+e);var r=n.path,i=r[0]||this.bindingData.list.currentItem.primaryKeyValue,o=this.repository.entityCollection.getEntityById(i);if(i&&!o)throw new Error("找不到id："+i+"对应的实体！");for(var a=r.pop(),s=o,p=1;p<r.length;p++){var u=r[p];s=s instanceof St?s.get(u):s[u]}if(!s)throw new Error("[DependencyEffector] 找不到实体对应的路径："+r.push(a));null!==s[a]&&!0===e&&(s[a]=null)},Oa.decorators=[{type:d.Injectable}],Oa.ctorParameters=function(){return[{type:d.Injector},{type:cn},{type:undefined,decorators:[{type:d.Inject,args:[po]}]},{type:Vn}]},Oa);function Oa(t,e,n,r){this.injector=t,this.repository=e,this.namespace=n,this.bindingData=r,this.ns=n}var Sa=(Na.decorators=[{type:d.Injectable}],Na.ctorParameters=function(){return[{type:d.Injector},{type:Array,decorators:[{type:d.Optional},{type:d.Inject,args:[Ca]}]}]},Na);function Na(t,e){this.injector=t,this.effectors=e}var Da=(Va.prototype.effect=function(t,e,n){if(!0===e&&n.message&&this.notifyService){var r=n.messageType||"info";this.notifyService[r](n.message,{hideTitle:!0})}},Va.decorators=[{type:d.Injectable}],Va.ctorParameters=function(){return[{type:d.Injector},{type:undefined,decorators:[{type:d.Inject,args:[_e]}]},{type:undefined,decorators:[{type:d.Inject,args:[Ae]}]},{type:undefined,decorators:[{type:d.Inject,args:[po]}]}]},Va);function Va(t,e,n,r){this.injector=t,this.messageService=e,this.notifyService=n,this.namespace=r,this.ns=r}var Fa=(Ra.prototype.effect=function(t,e,n){var r,i=this.getDomInfoByEntityPath(t);if(i){var o=i.frameContext,a=(o&&o.getVirtualRootFrameContext(),n.expressionId),s=i.domPropertyName;if(a&&o.form.addFieldValidateRule(s,n.message,a,"validate"),!1===e&&n.message){if(!i.isGridComponent){var p=n.message.replace(/\$property/g,i.propertyName),u=this.buildFormErrors(s,p);o.form.updateFormErrors(u)}}else if(!0===e){var c=o.form.getFormControlErrors(s)||null;c?(c.hasOwnProperty("validate")&&delete c.validate,o.form.updateFormErrors(((r={})[s]={errors:c},r))):(u=this.buildFormErrors(s,null),o.form.updateFormErrors(u))}}},Ra.prototype.getDomInfoByEntityPath=function(t){var e,n,r,i,o=null;if(!t)return o;t=t.split("/").filter(function(t){return t}).join(".");var a=this.frameContext&&this.frameContext.appContext.frameContextManager.getFrameContextsByNamespace(this.namespace)||null;if(a&&0<a.length)try{for(var s=P(a),p=s.next();!p.done;p=s.next()){var u=p.value;if(o)break;if(u&&u.form&&u.form.ngFormControls&&0<Object.keys(u.form.ngFormControls).length){var c=Object.keys(u.form.ngFormControls);try{for(var l=P(c),f=l.next();!f.done;f=l.next()){var h=f.value,y=u.form.ngFormControls[h],d=(u.viewModel.bindingPath||"/").split("/").filter(function(t){return t}),g=y.binding.split(".");if(t===(g=d.concat(g)).join(".")){var v=u.viewModel.dataGridColumnsName||null,m=u.viewModel[v]||null;if(m&&Array.isArray(m)&&0<m.length&&!m.find(function(t){return!t.every(function(t){return!(t.hasOwnProperty("editor")&&t.editor)})}))continue;var E=!1;v&&(E=!0),o={domPropertyName:h,propertyName:y.name||y.defaultI18nValue,frameContext:u,id:y.id,isGridComponent:E};break}}}catch(b){r={error:b}}finally{try{f&&!f.done&&(i=l["return"])&&i.call(l)}finally{if(r)throw r.error}}}}}catch(C){e={error:C}}finally{try{p&&!p.done&&(n=s["return"])&&n.call(s)}finally{if(e)throw e.error}}return o},Ra.prototype.getVerifyInformations=function(t){return(t&&t.getVirtualRootFrameContext()).viewModel.verifyInformations},Ra.prototype.buildFormErrors=function(t,e){var n,r;return e?(e=e.replace(/\$property/g,"domPropertyName"),(n={})[t]={errors:{validate:{name:e}}},n):((r={})[t]={errors:{}},r)},Ra.prototype.buildVerifyInformations=function(e,t,n,r){var i=this.getVerifyInformations(t),o=i.findIndex(function(t){return t.id===e});return-1!==o&&i.splice(o,1),i.push({id:e,namespace:t.namespace,targetField:n,index:i.length+1,title:t.form.formGroupName,msg:r,type:"error"}),i},Ra.prototype.removeValidateVerifyInformations=function(e,t){var n=this.getVerifyInformations(t),r=n.findIndex(function(t){return t.id===e});return-1!==r&&n.splice(r,1),n},Ra.decorators=[{type:d.Injectable}],Ra.ctorParameters=function(){return[{type:d.Injector},{type:undefined,decorators:[{type:d.Inject,args:[_e]}]},{type:undefined,decorators:[{type:d.Inject,args:[Ae]}]},{type:undefined,decorators:[{type:d.Inject,args:[po]}]},{type:Ss}]},Ra);function Ra(t,e,n,r,i){this.injector=t,this.messageService=e,this.notifyService=n,this.namespace=r,this.frameContext=i,this.ns=r}var Ba=(_a.prototype.effect=function(t,e,n){var r,i=this.getDomInfoByEntityPath(t);if(i){var o=i.frameContext,a=((o&&o.getVirtualRootFrameContext()).viewModel,i.domPropertyName),s=this.frameContext.bindingData.getValue(t.split("/").filter(function(t){return t})),p=n.expressionId;if(p&&o.form.addFieldValidateRule(a,n.message,p,"require"),!0===e){if(n.message)if(i.isGridComponent)this.updateColumnValidators(o,i.binding,i.datagridColumns,!0);else{var u=n.message.replace(/\$property/g,i.propertyName),c=this.buildFormErrors(a,u);this.isValidValue(t,s)||o.form.updateFormErrors(c)}}else if(i.isGridComponent)this.updateColumnValidators(o,i.binding,i.datagridColumns,!1);else{var l=o.form.getFormControlErrors(a)||null;l?(l.hasOwnProperty("require")&&delete l.require,o.form.updateFormErrors(((r={})[a]={errors:l},r))):(c=this.buildFormErrors(a,null),o.form.updateFormErrors(c))}}},_a.prototype.updateColumnValidators=function(t,e,n,r){var i=t.frameId,o=t.appContext.componentManager.get([i]);if(o&&0<o.size){var a=Array.from(o.values())[0];if(a&&"function"==typeof a.updateColumn){var s=n.find(function(t){return t.find(function(t){return t.field===e})}),p=s&&s.find(function(t){return t.field===e})||null;if(p){var u=p.validators||[],c=u.findIndex(function(t){return"required"===t.type});r?-1===c&&u.push({type:"required",message:"该字段不能为空！"}):-1!==c&&u.splice(c,1),a.updateColumn(e,{validators:b(u)}),a.columnsChanged()}}}},_a.prototype.getDomInfoByEntityPath=function(t){var e,n,r,i,o=null;if(!t)return o;t=t.split("/").filter(function(t){return t}).join(".");var a=this.frameContext&&this.frameContext.appContext.frameContextManager.getFrameContextsByNamespace(this.namespace)||null;if(a&&0<a.length)try{for(var s=P(a),p=s.next();!p.done;p=s.next()){var u=p.value;if(o)break;if(u&&u.form&&u.form.ngFormControls&&0<Object.keys(u.form.ngFormControls).length){var c=Object.keys(u.form.ngFormControls);try{for(var l=P(c),f=l.next();!f.done;f=l.next()){var h=f.value,y=u.form.ngFormControls[h],d=(u.viewModel.bindingPath||"/").split("/").filter(function(t){return t}),g=y.binding.split(".");if(t===(g=d.concat(g)).join(".")){var v=u.viewModel.dataGridColumnsName||null,m=u.viewModel[v]||null;if(m&&Array.isArray(m)&&0<m.length&&!m.find(function(t){return!t.every(function(t){return!(t.hasOwnProperty("editor")&&t.editor)})}))continue;var E=!1;v&&(E=!0),o={domPropertyName:h,propertyName:y.name||y.defaultI18nValue,frameContext:u,id:y.id,isGridComponent:E,binding:y.binding,datagridColumns:m};break}}}catch(b){r={error:b}}finally{try{f&&!f.done&&(i=l["return"])&&i.call(l)}finally{if(r)throw r.error}}}}}catch(C){e={error:C}}finally{try{p&&!p.done&&(n=s["return"])&&n.call(s)}finally{if(e)throw e.error}}return o},_a.prototype.getDataPropInfo=function(t){if(!t)return null;var e=t.split("/").filter(function(t){return t});return this.frameContext.repository.entityTypeInfo.getPropInfoByPath(e)},_a.prototype.isValidValue=function(t,e){var n=this.getDataPropInfo(t);if(n&&n.metadataInfo&&!0===n.metadataInfo.enableMultiLangInput){var r=this.injector.get(zr,null),i=r&&r.getCurrentLanguage()||"zh-CHS";return!(Object.keys(e).length<1)&&!!e[i]}return null!==e&&""!==e&&e!==undefined},_a.prototype.buildFormErrors=function(t,e){var n,r;return e?((n={})[t]={errors:{require:{name:e}}},n):((r={})[t]={errors:{}},r)},_a.decorators=[{type:d.Injectable}],_a.ctorParameters=function(){return[{type:d.Injector},{type:cn},{type:undefined,decorators:[{type:d.Inject,args:[po]}]},{type:Ss}]},_a);function _a(t,e,n,r){this.injector=t,this.repository=e,this.namespace=n,this.frameContext=r,this.ns=n}var Aa=(La.prototype.effect=function(t,e,n){var r,i=t.split("/").filter(function(t){return t}),o=this.getTablePaths(i),a=o.join("/");if(o&&0<o.length){if(this.isGridComponent(a)&&(r=this.getDatagridComponent(a))){var s=this.getPropertyPaths(i);if(s){var p=s.join(".");e?r.showColumn(p):r.hideColumn(p)}}}else(r=this.getDatagridComponent(a))&&r.columnsChanged()},La.prototype.getTablePaths=function(t){return In.getAvailableChildrenPathsFromEntityPaths(t,this.repository.entityTypeInfo)},La.prototype.getDatagridComponent=function(e){var i=this,t=(this.frameContext.appContext.frameContextManager.getFrameContextsByNamespace(this.namespace)||[]).filter(function(t){return t.viewModel&&t.viewModel.bindingPath.split("/").filter(function(t){return t}).toString()===e.split("/").filter(function(t){return t}).toString()}),o=null;return t&&t.every(function(t){var e=t.frameId,n=i.frameContext.appContext.componentManager.getComponentsByFrameId(e);if(!n)return!0;var r=Array.from(n.values()).find(function(t){return t&&"DatagridComponent"===t.__component_type__});return!r||(o=r,!1)}),o},La.prototype.getPropertyPaths=function(t){var e=In.getAvailableChildrenPathsFromEntityPaths(t,this.repository.entityTypeInfo);return t.slice(e.length)},La.prototype.isGridComponent=function(e){var t=(this.frameContext.appContext.frameContextManager.getFrameContextsByNamespace(this.namespace)||[]).find(function(t){return t.viewModel&&t.viewModel.bindingPath.split("/").filter(function(t){return t}).toString()===e.split("/").filter(function(t){return t}).toString()});return!!t&&!!t.viewModel.dataGridColumnsName},La.decorators=[{type:d.Injectable}],La.ctorParameters=function(){return[{type:d.Injector},{type:undefined,decorators:[{type:d.Inject,args:[po]}]},{type:Ss},{type:cn}]},La);function La(t,e,n,r){this.injector=t,this.namespace=e,this.frameContext=n,this.repository=r,this.ns=e}var ka=($a.prototype.getEffector=function(t){t.path;var e=t.ns,n=t.bindingType,r=t.type,i=this.effectorRegistry.effectors.filter(function(t){return t.ns==e});if(r!==x.Expression.ExpressionType.Compute)return r===x.Expression.ExpressionType.Readonly?i.find(function(t){return t instanceof Ma}):r===x.Expression.ExpressionType.Dependency?i.find(function(t){return t instanceof wa}):r===x.Expression.ExpressionType.Relative?i.find(function(t){return t instanceof Da}):r===x.Expression.ExpressionType.Validate?i.find(function(t){return t instanceof Fa}):r===x.Expression.ExpressionType.Required?i.find(function(t){return t instanceof Ba}):r===x.Expression.ExpressionType.Visible?i.find(function(t){return t instanceof Aa}):null;if(n===x.Expression.ExpressionBindingType.Field)return i.find(function(t){return t instanceof xa});if(n===x.Expression.ExpressionBindingType.State)return i.find(function(t){return t instanceof Ia});throw new Error("不支持的绑定字段类型："+n)},$a.decorators=[{type:d.Injectable}],$a.ctorParameters=function(){return[{type:d.Injector},{type:Sa}]},$a);function $a(t,e){this.injector=t,this.effectorRegistry=e}var Ua=(Ha.prototype.handleEvent=function(t,e){t=Object.assign({},t),this.expressionObjects=e,this.dispatch(t)},Object.defineProperty(Ha.prototype,"primaryValue",{get:function(){return this.bindingData.list.currentItem.primaryKeyValue},enumerable:!0,configurable:!0}),Object.defineProperty(Ha.prototype,"entityOriginalNodeCode",{get:function(){return this.repository&&this.repository.entityTypeInfo&&this.repository.entityTypeInfo.entityInfo&&this.repository.entityTypeInfo.entityInfo.originalCode||null},enumerable:!0,configurable:!0}),Ha.prototype.perform=function(t,e){return this.expressionExecutor.compile(t,e)},Ha.prototype.effect=function(t,n){var e=n.bindingType,r=this.effectorFactory.getEffector(n);if(r){if(e!==x.Expression.ExpressionBindingType.Field)throw new Error("not supported！");var i=n.effectPaths||[];if(0<i.length)i.forEach(function(t){var e={path:t.split("/"),message:n.message,expressionId:n.id};r.effect(n.path,n.result,e)});else if(n.type===x.Expression.ExpressionType.Required||n.type===x.Expression.ExpressionType.Validate||n.type===x.Expression.ExpressionType.Readonly||n.type===x.Expression.ExpressionType.Visible){var o={message:n.message,expressionId:n.id};r.effect(n.path,n.result,o)}}},Ha.prototype.isValidateOrRequiredExpression=function(t){return t&&(t.type===x.Expression.ExpressionType.Validate||t.type===x.Expression.ExpressionType.Required)},Ha.prototype.getEntityPathFromEvent=function(t){if(!(t=JSON.parse(JSON.stringify(t)))||!t.path||t.path.length<1)return[];var e=t.path;return this.getEntityPath(e)},Ha.prototype.getEntityPath=function(t){return t.filter(function(t,e){return e%2!=0||!t.includes(":")})},Ha.prototype.buildEntityPath=function(t){return t.filter(function(t,e){return e%2!=0||!t.includes(":")})},Ha.prototype.cleanEventPath=function(t){return(t=t.filter(function(t){return!(!t||":"===t)})).map(function(t){return t.includes(":")?t.split(":")[1]:t})},Ha.prototype.getCurrentRowByPaths=function(t){var e=null,n=this.bindingData.getValue(t);if(n&&0<n.length){var r=n.currentItem.primaryKeyValue||null;if(r){var i=n.findById(r);i&&(e=i.toJSON())}}return e},Ha.prototype.getEventId=function(t,e){if(!t||t.length<1)throw new Error("invalid path!");var n=t.findIndex(function(t){return t===e});if(-1===n)return null;var r=n+1;if(r>t.length-1)throw new Error("invalid propertyName or path");var i=t[r];if(-1===i.indexOf(":"))throw new Error("compute error.");return i.split(":")[1]},Ha.prototype.buildStateContext=function(t){var e=t.ns,n=this.injector.get(co,null).frameContextManager.getFrameContextsByNamespace(e),r={};if(n&&0<n.length){var i=n[0].getVirtualRootFrameContext();if(i){var o=i.viewModel.uiState;(Object.getOwnPropertyNames(o)||[]).forEach(function(t){null!==t.match(/^[a-zA-Z0-9_\$]+$/g)&&(r[t]=o[t])})}}return r},Ha.prototype.buildEntityContext=function(t,e,c){var l=this,n=e.bindingType;if(n===x.Expression.ExpressionBindingType.Field){var r=this.repository.entityTypeInfo,i=[];In.getChildrenEntityPaths(r,i);var o=c&&c.find(function(t){return""===t.bindingPath||"/"===t.bindingPath})||null,a=o&&o.primaryValue||this.bindingData.list.currentId,s=this.bindingData.list.findById(a);if(!s)return null;var f=s.toJSON();return f.__type__="Entity",!i||i.length<1||(i.sort(function(t,e){return t.length-e.length}),i.forEach(function(e){var t=l.bindingData.getValue(e),n=t.currentId,r=e[e.length-1],i=e.slice(0,e.length-1).reduce(function(t,e){return t&&t[e]||null},f);if(i){var o=i,a=null;if(n){if(c&&0<c.length){var s=c.find(function(t){return t.bindingPath.split("/").filter(function(t){return t}).join("/")===e.join("/")});s&&(n=s.primaryValue)}var p=t.findById(n),u=i[r];(a=E({__items__:[]},p&&p.toJSON()||{},{__type__:"List"})).length=function(){return a.__items__.length},u&&Array.isArray(u)&&(a.__items__=[].concat(u))}else a={__items__:[],__type__:"List",length:function(){return a.__items__.length}};o[r]=a}})),f}if(n!==x.Expression.ExpressionBindingType.State)return null},Ha.prototype.buildContext=function(t,e,n,r){var i,o=[];if(n)o.push(n);else{var a=this.buildEntityContext(e,t,r);o.push(a)}var s=this.buildStateContext(e),p=this.entityOriginalNodeCode,u=null;1===o.length?u=o.pop():((u=o[0]).__type__||(u.__type__="Entity"),u.__items__=o);var c=this.injector.get(zr,null);return E(((i={})[p]=u,i),s,{BigNumber:y.BigNumber,frameContext:this.frameContext,bindingData:this.bindingData,repository:this.repository,CurrentLanguage:c.getCurrentLanguage()||"zh-CHS"})},Ha.prototype.buildEffectPath=function(t,e){var n=e.path.split("/").filter(function(t){return t}),r=t.path[0]&&t.path[0].split(":")[1];if(!r)throw new Error("Invalid event path!");if(1===n.length)return[r,n.pop()];for(var i=[r],o=0;o<n.length;o++){var a=n[o];i.push(a);var s=n.slice(0,o+1),p=this.repository.entityTypeInfo.getPropInfoByPath(s);if("List"===p.group){var u=this.getEventId(t.path,p.name)||null;if(!u){var c=this.bindingData.getValue(s);c&&(u=c.currentId)}i.push(u)}}return i},Ha.prototype.getPathInfo=function(t){var e=t.split("/").filter(function(t){return t}),n=In.getAvailableChildrenPathsFromEntityPaths(e,this.repository.entityTypeInfo),r=e.slice(n.length).join("/");return{path:n.join("/"),propertyName:r,paths:n,propertyNames:r.split("/").filter(function(t){return t})}},Ha.prototype.getTablePathsFromEventPaths=function(t){return t=this.getEntityPath(t),In.getAvailableChildrenPathsFromEntityPaths(t,this.repository.entityTypeInfo)},Ha.prototype.getPropertyPathsFromEventPaths=function(t){t=this.getEntityPath(t);var e=In.getAvailableChildrenPathsFromEntityPaths(t,this.repository.entityTypeInfo);return t.slice(e.length)},Ha.prototype.analysis=function(t,e){var n=this.getPathInfo(e.path),r=this.getEntityPath(t.path.slice(0)),i=this.getPathInfo(r.join("/"));if(!n||!i)return console.warn("表达式路径或事件路径错误，获取路径信息失败。"),null;var o=n.path.split("/").filter(function(t){return t}),a=n.propertyName.split("/").filter(function(t){return t}),s=i.path.split("/").filter(function(t){return t}),p=i.propertyName.split("/").filter(function(t){return t}),u={distance:undefined,eventFromChildren:undefined,eventFromParent:undefined,expressionTablePaths:o,expressionPropertyNames:a,eventTablePaths:s,eventPropertyNames:p,isSameTable:!1};return u.distance=Math.abs(o.length-s.length),1===u.distance&&(u.eventFromChildren=s.length>o.length&&s.join("/").startsWith(o.join("/")),u.eventFromParent=s.length<o.length&&o.join("/").startsWith(s.join("/"))),u.isSameTable=o.join("/")===s.join("/"),u},Ha.prototype.buildCurrentRows=function(t,r){var i=new Array;if(!t||t.length<1)i.push({bindingPath:"/",primaryValue:r[0]});else{var o=[];t.forEach(function(t,e){0===e&&i.push({bindingPath:"/",primaryValue:r[0]}),o.push(t);var n=r[2*e+2];i.push({bindingPath:o.join("/"),primaryValue:n})})}return i},Ha.prototype.convertBooleanTypeExpressionResult=function(t,e){return this.isBooleanTypeExpression(t)?!0===e:e},Ha.prototype.isBooleanTypeExpression=function(t){return this.isReadonlyExpression(t)||this.isVisibleExpression(t)||this.isValidateExpression(t)||this.isRequiredExpression(t)||this.isDependencyExpression(t)},Ha.prototype.isReadonlyExpression=function(t){return t&&t.type===x.Expression.ExpressionType.Readonly||!1},Ha.prototype.isVisibleExpression=function(t){return t&&t.type===x.Expression.ExpressionType.Visible},Ha.prototype.isValidateExpression=function(t){return t&&t.type===x.Expression.ExpressionType.Validate},Ha.prototype.isRequiredExpression=function(t){return t&&t.type===x.Expression.ExpressionType.Required},Ha.prototype.isDependencyExpression=function(t){return t&&t.type===x.Expression.ExpressionType.Dependency},Ha.decorators=[{type:d.Injectable}],Ha.ctorParameters=function(){return[{type:d.Injector},{type:cn},{type:Vn},{type:Ko},{type:ka},{type:Wo},{type:Zo}]},Ha);function Ha(t,e,n,r,i,o,a){this.injector=t,this.repository=e,this.bindingData=n,this.expressionRegistry=r,this.effectorFactory=i,this.expressionExecutor=o,this.expressionResult=a,this.frameContext=this.injector.get(Ss)}var Ka,Ga=(c(za,Ka=Ua),za.prototype.filter=function(t){return null},za.prototype.dispatch=function(t){},za.prototype.getCurrentRowByEvent=function(t,e){return this.getCurrentRowByPaths(t)},za.decorators=[{type:d.Injectable}],za);function za(){return null!==Ka&&Ka.apply(this,arguments)||this}var qa=(Ja.effect=function(n,r,t){!t||t.length<1||t.forEach(function(t){var e={path:t,message:r.message,expressionId:r.id};n.effect(r.path,r.result,e)})},Ja);function Ja(){}var Wa,Ya=(c(Za,Wa=Ua),Za.prototype.filter=function(i){var o=this;return this.expressionObjects&&0<this.expressionObjects.length?this.expressionObjects.filter(function(t){var e=t.deps;if(!e||e.length<1||i.ns!==t.ns)return!1;var n=o.cleanEventPath(i.path);n.splice(0,0,Ke);var r=n.join("/");return!!e.includes(r)}):null},Za.prototype.dispatch=function(r){var i=this,t=this.filter(r);t&&0<t.length&&t.forEach(function(t){var e=i.buildContext(t,r),n=i.perform(t,e);n===undefined&&!i.isValidateOrRequiredExpression(t)||(t.result=i.convertBooleanTypeExpressionResult(t,n),t.id&&i.expressionResult.set(t.id,t.result),i.effect(r,t))})},Za.prototype.effect=function(n,r){var i=this,o=this.effectorFactory.getEffector(r),t=r.bindingType;if(o)if(t===x.Expression.ExpressionBindingType.State)o.effect(r.path,r.result,{message:r.message});else if(t===x.Expression.ExpressionBindingType.Field){var e=this.getPathInfo(r.path),a=e.paths,s=this.repository.entityCollection.getAllEntities();!s||s.length<1||r.type===x.Expression.ExpressionType.Visible?o.effect(r.path,r.result,{message:r.message}):this.effectRows(s,a,e.propertyNames,function(t,e){i.output(n,r,t,o,[e])})}},Za.prototype.output=function(t,e,n,r,i){var o=this.buildContext(e,t,null,n),a=this.perform(e,o);a!==undefined&&(e.result=a,e.id&&this.expressionResult.set(e.id,e.result),qa.effect(r,e,i))},Za.prototype.effectRows=function(t,i,o,a,s,p,u){var c=this;if(void 0===s&&(s=[]),void 0===p&&(p=[]),void 0===u&&(u=[]),!i||i.length<1)t.forEach(function(t){if(t&&t.primaryValue){var e=u.concat([t.primaryValue]).concat(o),n=s.concat([{bindingPath:p.join("/")||"/",primaryValue:t.primaryValue}]);a(n,e)}}),s.length=0,u.length=0;else{var l=!1,f=p;t.forEach(function(t){var e=i[0],n=t[e];if(n&&!(n.count()<1)){s.push({bindingPath:p.join("/")||"/",primaryValue:t.primaryValue}),u.push(t.primaryValue),u.push(e),!1===l&&(l=!0,f.push(e));var r=i.slice(1);c.effectRows(n.items,r,o,a,s,f,u)}})}},Za.prototype.getCurrentRowByEvent=function(t,e){return this.getCurrentRowByPaths(t)},Za.decorators=[{type:d.Injectable}],Za);function Za(){return null!==Wa&&Wa.apply(this,arguments)||this}var Xa,Qa=(c(ts,Xa=Ua),ts.prototype.filter=function(t){return null},ts.prototype.dispatch=function(i){var o=this,t=this.filter(i);t&&0<t.length&&t.forEach(function(t){var e=o.buildEntityContext(i,t),n=o.buildContext(t,i,e),r=o.perform(t,n);r===undefined&&!o.isValidateOrRequiredExpression(t)||(t.result=r,t.id&&o.expressionResult.set(t.id,t.result),o.effect(i,t))})},ts.prototype.getCurrentRowByEvent=function(t,e){return this.getCurrentRowByPaths(t)},ts.decorators=[{type:d.Injectable}],ts);function ts(){return null!==Xa&&Xa.apply(this,arguments)||this}var es,ns=(c(rs,es=Ua),rs.prototype.filter=function(t){return null},rs.prototype.dispatch=function(t){},rs.decorators=[{type:d.Injectable}],rs);function rs(){return null!==es&&es.apply(this,arguments)||this}var is,os=(c(as,is=Ua),as.prototype.filter=function(t){return null},as.prototype.dispatch=function(i){var o=this,t=this.filter(i);t&&0<t.length&&t.forEach(function(t){var e=o.buildEntityContext(i,t),n=o.buildContext(t,i,e),r=o.perform(t,n);r===undefined&&!o.isValidateOrRequiredExpression(t)||(t.result=r,t.id?o.expressionResult.set(t.id,t.result):console.warn("EventHandler 表达式未设置唯一标识，无法更新表达式值。"),o.effect(i,t))})},as.prototype.getCurrentRowByEvent=function(t,e){return this.getCurrentRowByPaths(t)},as.decorators=[{type:d.Injectable}],as);function as(){return null!==is&&is.apply(this,arguments)||this}var ss,ps=(c(us,ss=Ua),us.prototype.filter=function(n){var r=this;return this.expressionObjects.filter(function(t){if(t.ns!==n.ns||!t.deps||0===t.deps.length||t.type===x.Expression.ExpressionType.Compute||t.type===x.Expression.ExpressionType.Dependency||t.type===x.Expression.ExpressionType.DataPicking)return!1;var e=r.analysis(n,t);return!!e&&0===e.expressionTablePaths.length&&-1!==t.deps.findIndex(function(t){if(!t.startsWith(He))return!1;var e=t.split(x.Expression.DEPENDENCY_SPLITER).filter(function(t){return t}).slice(1),n=r.getPathInfo(e.join("/"));return!!n&&0===n.paths.length})})},us.prototype.dispatch=function(i){var o=this,t=this.filter(i);t&&0<t.length&&t.forEach(function(t){var e=o.buildEntityContext(i,t),n=o.buildContext(t,i,e),r=o.perform(t,n);r===undefined&&!o.isValidateOrRequiredExpression(t)||(t.result=o.convertBooleanTypeExpressionResult(t,r),t.id?o.expressionResult.set(t.id,t.result):console.warn("EventHandler 表达式未设置唯一标识，无法更新表达式值。"),o.effect(i,t))})},us.prototype.getCurrentRowByEvent=function(t,e){var n=null,r=this.bindingData.getValue(t),i=this.getEntityPath(e.path);if(r&&0<r.length){var o=r.currentItem.primaryKeyValue||null,a=In.getAvailableChildrenPathsFromEntityPaths(i,this.repository.entityTypeInfo);if(a&&a.toString()===t.toString()&&(o=(o=e.id||null)||this.getEventId(e.path,t[t.length-1])),o){var s=r.findById(o);s&&(n=s.toJSON())}}return n},us.decorators=[{type:d.Injectable}],us);function us(){return null!==ss&&ss.apply(this,arguments)||this}var cs,ls=(c(fs,cs=Ua),fs.prototype.filter=function(n){var o=this;if(this.expressionObjects&&0<this.expressionObjects.length){var t=this.expressionObjects.filter(function(t){if(t.ns!==n.ns||!t.deps||t.deps.length<1)return!1;var r=o.buildEntityPath(n.path),i=o.analysis(n,t);return!(!i||0===r.length&&t.bindingType===x.Expression.ExpressionBindingType.Field||(r.splice(0,0,He),i.eventTablePaths.length-1!==i.expressionTablePaths.length||!i.eventTablePaths.join(x.Expression.DEPENDENCY_SPLITER).startsWith(i.expressionTablePaths.join(x.Expression.DEPENDENCY_SPLITER))||-1===t.deps.findIndex(function(t){if(!t.startsWith(r.join(x.Expression.DEPENDENCY_SPLITER)))return!1;var e=t.split(x.Expression.DEPENDENCY_SPLITER).filter(function(t){return t}).slice(1),n=o.getPathInfo(e.join(x.Expression.DEPENDENCY_SPLITER));return!(!n||n.paths.join(x.Expression.DEPENDENCY_SPLITER)!==i.eventTablePaths.join(x.Expression.DEPENDENCY_SPLITER))})))}),r=this.buildEntityPath(n.path),e=this.expressionObjects.filter(function(t){if(t.ns!==n.ns)return!1;if(o.getPathInfo(t.path).paths.join(x.Expression.DEPENDENCY_SPLITER)!==r.join(x.Expression.DEPENDENCY_SPLITER))return!1;if(!t.deps||t.deps.length<1)return!0;if(t.deps.every(function(t){return t.startsWith(Ke)}))return!0;var e=o.analysis(n,t);return!(!e||0!==e.distance||!e.isSameTable)});return t.concat(e)}return null},fs.prototype.dispatch=function(i){var o=this,t=this.filter(i);t&&0<t.length&&t.forEach(function(t){var e=o.buildEntityContext(i,t),n=o.buildContext(t,i,e),r=o.perform(t,n);r===undefined&&!o.isValidateOrRequiredExpression(t)||(t.result=o.convertBooleanTypeExpressionResult(t,r),t.id?o.expressionResult.set(t.id,t.result):console.warn("EventHandler 表达式未设置唯一标识，无法更新表达式值。"),o.effect(i,t))})},fs.prototype.getCurrentRowByEvent=function(t,e){return this.getCurrentRowByPaths(t)},fs.prototype.effect=function(n,r){var i=this,t=r.bindingType,e=this.cleanEventPath(n.path),o=this.effectorFactory.getEffector(r);if(o){var a=this.analysis(n,r);if(a){var s=r.path.split("/").filter(function(t){return t});if(t===x.Expression.ExpressionBindingType.Field){var p=[],u=s.slice(a.expressionTablePaths.length);if(0===a.distance){if(!a.isSameTable)return;var c=e.slice(0);if(1===e.length)if(n.value&&Array.isArray(n.value))n.value.forEach(function(t){p.push([t.primaryKeyValue].concat(u))});else{var l=c.concat(u);p.push(l)}else if(n.value&&Array.isArray(n.value))n.value.forEach(function(t){p.push(c.concat([t.primaryKeyValue]).concat(u))});else{var f=this.bindingData.getValue(a.eventTablePaths);f&&f.currentId&&p.push(c.concat(f.currentId).concat(u))}}else{if(!0===a.eventFromParent)return void console.warn("[BindingDataAppendObjectEventHandler][effect_error]");if(!0!==a.eventFromChildren)return void console.warn("[BindingDataAppendObjectEventHandler][effect_error]");l=e.slice(0,e.length-1).concat(u),p.push(l)}p.forEach(function(t){var e=i.buildCurrentRows(a.expressionTablePaths,t);i.output(n,r,e,o,[t])})}else t===x.Expression.ExpressionBindingType.State&&console.error("not supported！")}else console.warn("[BindingDataAppendObjectEventHandler][analysis]获取路径信息失败。")}},fs.prototype.output=function(t,e,n,r,i){var o=this.buildContext(e,t,null,n),a=this.perform(e,o);a!==undefined&&(e.result=a,e.id&&this.expressionResult.set(e.id,e.result),qa.effect(r,e,i))},fs.decorators=[{type:d.Injectable}],fs);function fs(){return null!==cs&&cs.apply(this,arguments)||this}var hs,ys=(c(ds,hs=Ua),ds.prototype.filter=function(r){var i=this;return this.expressionObjects&&0<this.expressionObjects.length?this.expressionObjects.filter(function(t){var e=t.deps;if(!e||e.length<1||r.ns!==t.ns)return!1;var n=i.getEntityPath(r.path);return n.splice(0,0,He),e.includes(n.join("/"))}):null},ds.prototype.dispatch=function(e){var n=this,t=this.filter(e);t&&0<t.length&&t.forEach(function(t){n.effect(e,t)})},ds.prototype.effect=function(t,e){var n,r,i=this.effectorFactory.getEffector(e);if(i){var o=this.analysis(t,e);if(o){var a=this.cleanEventPath(t.path),s=[];if(0===o.distance){if(!1===o.isSameTable)return void console.warn("[BindingDataValueChangeEventHandler]不支持多对多关系。");var p=(c=a.slice(0,a.length-o.eventPropertyNames.length)).concat(o.expressionPropertyNames),u=this.buildCurrentRows(o.eventTablePaths,p);s.push(p),this.output(t,e,u,i,s)}else if(!0===o.eventFromChildren){if(1<o.distance)return;p=(c=a.slice(0,a.length-o.eventPropertyNames.length-2)).concat(o.expressionPropertyNames),s.push(p),u=this.buildCurrentRows(o.eventTablePaths,a),this.output(t,e,u,i,s)}else if(!0===o.eventFromParent){if(1<o.distance)return void console.warn("[BindingDataValueChangeEventHandler]不支持多对多关系。");var c;(c=a.slice(0,a.length-o.eventPropertyNames.length)).push(o.expressionTablePaths.slice(0).pop()),o.expressionTablePaths;var l=a[0];if(!l)return;for(var f=this.frameContext.repository.entityCollection.getEntityById(l),h=1;h<c.length;h++){var y=c[h];f=f instanceof St?f.get(y):f[y]}var d=f;if(d&&d instanceof St)if(0===d.count()){if(e.type===x.Expression.ExpressionType.Visible||e.type===x.Expression.ExpressionType.Required){var g=this.buildContext(e,t),v=this.perform(e,g);if(v===undefined&&!this.isValidateOrRequiredExpression(e))return;e.result=this.convertBooleanTypeExpressionResult(e,v),e.id&&this.expressionResult.set(e.id,e.result),hs.prototype.effect.call(this,t,e)}}else try{for(var m=P(d),E=m.next();!E.done;E=m.next()){var b=E.value;b&&b.primaryValue&&(p=c.concat([b.primaryValue]).concat(o.expressionPropertyNames),u=this.buildCurrentRows(o.expressionTablePaths,p),this.output(t,e,u,i,[p]))}}catch(C){n={error:C}}finally{try{E&&!E.done&&(r=m["return"])&&r.call(m)}finally{if(n)throw n.error}}}}}},ds.prototype.output=function(t,e,n,r,i){var o=this.buildContext(e,t,null,n),a=this.perform(e,o);a===undefined&&!this.isValidateOrRequiredExpression(e)||(e.result=this.convertBooleanTypeExpressionResult(e,a),e.id&&this.expressionResult.set(e.id,e.result),qa.effect(r,e,i))},ds.prototype.getCurrentRowByEvent=function(t,e){e=JSON.parse(JSON.stringify(e));var n=null,r=this.bindingData.getValue(t),i=this.getEntityPath(e.path);if(r&&0<r.length){var o=r.currentItem.primaryKeyValue||null,a=In.getAvailableChildrenPathsFromEntityPaths(i,this.repository.entityTypeInfo);if(a&&a.toString()===t.toString()&&(o=(o=e.id||null)||this.getEventId(e.path,t[t.length-1])),o){var s=r.findById(o);s&&(n=s.toJSON())}}return n},ds.decorators=[{type:d.Injectable}],ds);function ds(){return null!==hs&&hs.apply(this,arguments)||this}var gs,vs=(c(ms,gs=Ua),ms.prototype.filter=function(e){var o=this;if(this.expressionObjects&&0<this.expressionObjects.length)return this.expressionObjects.filter(function(t){if(t.ns!==e.ns||!t.deps||t.deps.length<1)return!1;var r=o.analysis(e,t);if(!r)return!1;var i=o.buildEntityPath(e.path);return(0!==i.length||t.bindingType!==x.Expression.ExpressionBindingType.Field)&&(i.splice(0,0,He),r.eventTablePaths.length-1===r.expressionTablePaths.length&&!!r.eventTablePaths.join(x.Expression.DEPENDENCY_SPLITER).startsWith(r.expressionTablePaths.join(x.Expression.DEPENDENCY_SPLITER))&&-1!==t.deps.findIndex(function(t){if(!t.startsWith(i.join(x.Expression.DEPENDENCY_SPLITER)))return!1;var e=t.split(x.Expression.DEPENDENCY_SPLITER).filter(function(t){return t}).slice(1),n=o.getPathInfo(e.join(x.Expression.DEPENDENCY_SPLITER));return!(!n||n.paths.join(x.Expression.DEPENDENCY_SPLITER)!==r.eventTablePaths.join(x.Expression.DEPENDENCY_SPLITER))}))})},ms.prototype.dispatch=function(i){var o=this,t=this.filter(i);t&&0<t.length&&t.forEach(function(t){var e=o.buildEntityContext(i,t),n=o.buildContext(t,i,e),r=o.perform(t,n);r===undefined&&!o.isValidateOrRequiredExpression(t)||(t.result=o.convertBooleanTypeExpressionResult(t,r),t.id&&o.expressionResult.set(t.id,t.result),o.effect(i,t))})},ms.prototype.effect=function(t,e){var n=e.bindingType,r=this.cleanEventPath(t.path),i=this.effectorFactory.getEffector(e);if(i){var o=this.analysis(t,e);if(o){var a=e.path.split("/").filter(function(t){return t});if(n===x.Expression.ExpressionBindingType.Field){var s=[],p=a.slice(o.expressionTablePaths.length);if(0!==o.distance){if(!0===o.eventFromParent)return void console.warn("[BindingDataRemoveObjectEventHandler][effect_error]");if(!0!==o.eventFromChildren)return void console.warn("[BindingDataRemoveObjectEventHandler][effect_error]");var u=r.slice(0,r.length-1).concat(p);s.push(u)}qa.effect(i,e,s)}else n===x.Expression.ExpressionBindingType.State&&console.error("not supported！")}else console.warn("[BindingDataRemoveObjectEventHandler][analysis]获取路径信息失败。")}},ms.prototype.getCurrentRowByEvent=function(t,e){return this.getCurrentRowByPaths(t)},ms.decorators=[{type:d.Injectable}],ms);function ms(){return null!==gs&&gs.apply(this,arguments)||this}var Es,bs=(c(Cs,Es=Ua),Cs.prototype.filter=function(n){var r=this;return(n.path&&0!==n.path.length||!n.value||!Array.isArray(n.value)||0!==n.value.length)&&this.expressionObjects&&0<this.expressionObjects.length?this.expressionObjects.filter(function(t){if(t.ns!==n.ns||t.type!==x.Expression.ExpressionType.Readonly&&t.type!==x.Expression.ExpressionType.Visible&&t.type!==x.Expression.ExpressionType.Required&&t.type!==x.Expression.ExpressionType.Validate)return!1;var e=r.analysis(n,t);return!!e&&(0===e.distance&&e.isSameTable||e.eventFromParent&&2===n.path.length)}):null},Cs.prototype.dispatch=function(i){var o=this,t=this.filter(i);t&&0<t.length&&t.forEach(function(t){var e=o.buildEntityContext(i,t),n=o.buildContext(t,i,e),r=o.perform(t,n);r===undefined&&!o.isValidateOrRequiredExpression(t)||(t.result=o.convertBooleanTypeExpressionResult(t,r),t.id&&o.expressionResult.set(t.id,t.result),o.effect(i,t))})},Cs.prototype.getCurrentRowByEvent=function(t,e){return this.getCurrentRowByPaths(t)},Cs.decorators=[{type:d.Injectable}],Cs);function Cs(){return null!==Es&&Es.apply(this,arguments)||this}var xs,Ps=(c(Is,xs=Ua),Is.prototype.filter=function(i){var o=this;return this.expressionObjects&&0<this.expressionObjects.length?this.expressionObjects.filter(function(t){var e=t.deps;if(!e||e.length<1)return!1;var n=e.findIndex(function(t){return t.startsWith(He)});if(-1===n)return!1;var r=o.analysis(i,t);return!!r&&1===r.eventTablePaths.length&&2===r.expressionTablePaths.length&&!!r.expressionTablePaths.join("/").startsWith(r.eventTablePaths.join("/"))&&-1!==(n=e.findIndex(function(t){return t.startsWith(He+"/"+r.eventTablePaths[0])}))}):null},Is.prototype.dispatch=function(i){var o=this,t=this.filter(i);t&&0<t.length&&t.forEach(function(t){var e=o.buildEntityContext(i,t),n=o.buildContext(t,i,e),r=o.perform(t,n);r===undefined&&!o.isValidateOrRequiredExpression(t)||(t.result=o.convertBooleanTypeExpressionResult(t,r),t.id&&o.expressionResult.set(t.id,t.result),o.effect(i,t))})},Is.decorators=[{type:d.Injectable}],Is);function Is(){return null!==xs&&xs.apply(this,arguments)||this}var Ts=(Object.defineProperty(Ms.prototype,"entityValueChangedEventHandler",{get:function(){return this.handlers&&this.handlers.find(function(t){return t instanceof Ga})},enumerable:!0,configurable:!0}),Object.defineProperty(Ms.prototype,"stateValueChangedEventHandler",{get:function(){return this.handlers&&this.handlers.find(function(t){return t instanceof Ya})},enumerable:!0,configurable:!0}),Object.defineProperty(Ms.prototype,"repositoryAddEntityEventHandler",{get:function(){return this.handlers&&this.handlers.find(function(t){return t instanceof Qa})},enumerable:!0,configurable:!0}),Object.defineProperty(Ms.prototype,"repositoryRemoveEntityEventHandler",{get:function(){return this.handlers&&this.handlers.find(function(t){return t instanceof ns})},enumerable:!0,configurable:!0}),Object.defineProperty(Ms.prototype,"entityUpdateEventHandler",{get:function(){return this.handlers&&this.handlers.find(function(t){return t instanceof ps})},enumerable:!0,configurable:!0}),Object.defineProperty(Ms.prototype,"repositoryLoadEventHandler",{get:function(){return this.handlers&&this.handlers.find(function(t){return t instanceof os})},enumerable:!0,configurable:!0}),Object.defineProperty(Ms.prototype,"bindingDataAppendEntityEventHandler",{get:function(){return this.handlers&&this.handlers.find(function(t){return t instanceof ls})},enumerable:!0,configurable:!0}),Object.defineProperty(Ms.prototype,"bindingDataValueChangeEventHandler",{get:function(){return this.handlers&&this.handlers.find(function(t){return t instanceof ys})},enumerable:!0,configurable:!0}),Object.defineProperty(Ms.prototype,"bindingDataRemoveObjectEventHandler",{get:function(){return this.handlers&&this.handlers.find(function(t){return t instanceof vs})},enumerable:!0,configurable:!0}),Object.defineProperty(Ms.prototype,"bindingDataLoadEventHandler",{get:function(){return this.handlers&&this.handlers.find(function(t){return t instanceof bs})},enumerable:!0,configurable:!0}),Object.defineProperty(Ms.prototype,"bindingDataSelectionChangedHandler",{get:function(){return this.handlers&&this.handlers.find(function(t){return t instanceof Ps})},enumerable:!0,configurable:!0}),Ms.decorators=[{type:d.Injectable}],Ms.ctorParameters=function(){return[{type:Array,decorators:[{type:d.Optional},{type:d.Inject,args:[oa]}]}]},Ms);function Ms(t){this.handlers=t}var js=(ws.prototype.attachEvent=function(){var n=this;this.expressionEventEmitter.attach().subscribe(function(t){!t||t.length<1||!n.expressionObjects||n.expressionObjects.length<1||t.forEach(function(t){var e=n.getEventHandler(t);e?e.handleEvent(t,n.expressionObjects):Le.warn("没有对应的事件处理器,event="+t.type)})})},ws.prototype.resolveDependency=function(){var r=this;!this.resolverRegistry||!this.resolverRegistry.resolvers||this.resolverRegistry.resolvers.length<1||!this.expressionObjects||this.expressionObjects.length<1||!Array.isArray(this.expressionObjects)||this.expressionObjects.forEach(function(t){var e=t.expression,n=r.resolveService.resolve(e);t.deps=n})},ws.prototype.getEventHandler=function(t){if(t.type===x.Expression.EventType.ValueChanged){if(t.source===x.Expression.EventSource.BindingData)return this.eventHandlerRegistry.bindingDataValueChangeEventHandler;if(t.source===x.Expression.EventSource.Field)return this.eventHandlerRegistry.entityValueChangedEventHandler;if(t.source===x.Expression.EventSource.State)return this.eventHandlerRegistry.stateValueChangedEventHandler}else if(t.type===x.Expression.EventType.Append){if(t.source===x.Expression.EventSource.Repository||t.source===x.Expression.EventSource.Field)return this.eventHandlerRegistry.repositoryAddEntityEventHandler;if(t.source===x.Expression.EventSource.BindingData)return this.eventHandlerRegistry.bindingDataAppendEntityEventHandler}else if(t.type===x.Expression.EventType.Remove){if(t.source===x.Expression.EventSource.Repository||t.source===x.Expression.EventSource.Field)return this.eventHandlerRegistry.repositoryRemoveEntityEventHandler;if(t.source===x.Expression.EventSource.BindingData)return this.eventHandlerRegistry.bindingDataRemoveObjectEventHandler}else if(t.type===x.Expression.EventType.Update){if(t.source===x.Expression.EventSource.Repository)return this.eventHandlerRegistry.entityUpdateEventHandler}else if(t.type===x.Expression.EventType.Load){if(t.source===x.Expression.EventSource.Repository||t.source===x.Expression.EventSource.Field)return this.eventHandlerRegistry.repositoryLoadEventHandler;if(t.source===x.Expression.EventSource.BindingData)return this.eventHandlerRegistry.bindingDataLoadEventHandler}else if(t.type===x.Expression.EventType.SelectionChanged&&t.source===x.Expression.EventSource.BindingData)return this.eventHandlerRegistry.bindingDataSelectionChangedHandler;return null},ws.decorators=[{type:d.Injectable}],ws.ctorParameters=function(){return[{type:d.Injector},{type:Ko},{type:Ea},{type:ze},{type:Ts},{type:xn}]},ws);function ws(t,e,n,r,i,o){var a=this;this.injector=t,this.expressionRegistry=e,this.expressionEventEmitter=n,this.resolverRegistry=r,this.eventHandlerRegistry=i,this.resolveService=o,this.expressionObjects=new Array,this.expressionRegistry.expressions.subscribe(function(t){t&&0<t.length&&(a.expressionObjects=t,a.resolveDependency()),a.attachEvent()})}var Os,Ss=(c(Ns,Os=Ti),Ns.prototype.bindInjector=function(t){this.injector=t},Ns.prototype.init=function(t){this.frameComponent=t,this.initializeBindingData(),this.initializeStateMachine(),this.initializeUiState(),this.initializeForm(),this.initializeCommandBus(),this.initializeViewModel(),this.registerExceptionHandler(),this.initExpression(),this.appContext.frameComponentRefresher.regFrameComponent(this.frameId,this.frameComponent)},Ns.prototype.initExpression=function(){this.expressionEngineImpl=this.injector.get(js,null),this.expressionManager=this.injector.get(Qo,null),this.injector.get(ea,null),this.expressionResult=this.injector.get(Zo,null)},Ns.prototype.registerExceptionHandler=function(){var n=this,t=this.getFormAppContext().ApplicationId;if(window[window.location.href]=t,null!==this.exceptionHandler){var e=window[t]=window[t]||{};null!==this.eventBus&&this.isRootFrameContext()&&(e.isExceptionHandlerExist=!0,this.exceptionHandler.setContext(this.appContext),this.eventBus.on("Exception","","onException",this.getFormAppContext(),function(t){if(!0!==n.isDestoried){if(t&&t.error)try{t.error.__frame_context__=n}catch(e){}n.exceptionHandler.handle(t)}}))}},Ns.prototype.getFormAppContext=function(){return this.appContext},Ns.prototype.getFrameId=function(t){return t?this.namespace&&0<this.namespace.length?this.namespace+"_"+t:t:this.frameId},Ns.prototype.initializeRepository=function(){this.repository.setPaginationConfig(this.repository.paginationInfo)},Ns.prototype.initializeForm=function(){if(this.form=this.injector.get(On,null),this.form){this.form.setTranslateService(this.injector.get(zr,null));var t=this.viewModel.bindingPath||this.metadata.bindingTo;this.form.init(this.bindingData,t,this)}},Ns.prototype.initializeStateMachine=function(){this.stateMachine=this.injector.get(gi,null),this.stateMachine&&this.stateMachine.initialize(this,this.variableParseService)},Ns.prototype.initializeCommandBus=function(){var t=this.injector.get(Yr,new Yr(this.metadata.commandHandlers)),e=this.injector.get(ei,new ei(this.metadata.commandHandlerExtends)),n=new _s(t,e,this,this.variableParseService);this.commandBus=new Ls(n)},Ns.prototype.initializeViewModel=function(){this.metadata.bindingTo||(this.metadata.bindingTo=this.viewModel.bindingPath),this.viewModel.init(this),this.regViewModel(this.viewModel)},Ns.prototype.initializeBindingData=function(){var e=this,t=this.repository.name,n=this.appContext.runMode===x.RunMode.highSpeed;if(t&&n){var r=this.appContext.bindingDataManager.getBindingDataByName(t);this.bindingData.initByBindingList(r.list,this.viewModel.bindingPath),this.bindingData.pagingInfo=r.pagingInfo,this.bindingData.setDataTypeInfo(this.repository.entityTypeInfo),Nn.watchReposiroty(this.repository,this.bindingData)}else this.bindingData.initByRepository(this.repository,this.viewModel.bindingPath),Nn.watchReposiroty(this.repository,this.bindingData),this.bindingData.changes.subscribe(function(t){t.type===x.ChangeType.GlobalSelectionChanged&&e.appContext.handleSelectChange(t,e)})},Ns.prototype.initializeUiState=function(){var e=this,t=(window.location.href.indexOf("platform"),this.injector.get(ui,!1));if(this.uiState=this.injector.get(si,null),this.uiState){this.uiState.paramTypeTransform=t,this.uiState.initialize(this);var n=this.appContext&&this.appContext.router&&this.appContext.router.url||"",r=(new Kt).getParams(n);Object.keys(r).forEach(function(t){Object.defineProperty(e.uiState,t,{get:function(){return r[t]}})})}},Ns.prototype.regViewModel=function(t){this.appContext&&!1===this.appContext.viewModelManager.exsit(t.name)&&this.appContext.viewModelManager.register(t.name,t);var e=t.constructor.name,n=this.parent,r=null;if(n&&n.viewModel&&(r=n.viewModel),r){var i=r.childViewModels,o=null;if(i){var a=t.constructor.name;o=i[t.name]||i[a]}else 1===e.length&&(o=t.name.split("-").map(function(t,e){return 0<e&&t.length?t.charAt(0).toLocaleUpperCase()+t.substr(1,t.length-1):0===e&&t.length?t.charAt(0).toLocaleLowerCase()+t.substr(1,t.length-1):t}).join(""));(r[o=o||e[0].toLowerCase()+e.substring(1,e.length)]=t).bindToParent(r)}},Ns.prototype.isRootFrameContext=function(){return null===this.parent||this.appContext.runMode===x.RunMode.highSpeed&&!0===this.getVirtualRootFrameContext().frameComponent.isDialogRootComponent},Ns.prototype.destroy=function(){this.appContext.frameContextManager.unregFrameContext(this),this.appContext.frameComponentRefresher.unregFrameContext(this),this.isDestoried=!0},Ns.prototype.getVirtualRootFrameContext=function(){for(var t=this,e=this.parent;e&&e.namespace===this.namespace;)e=(t=e).parent;return t},Ns.prototype.getContextById=function(t){return this.appContext.getContextById(t)},Ns.prototype.getViewModel=function(t){var e=this.appContext;return e?e.viewModelManager.getViewModelByName(t):null},Ns.prototype.attachViewComponent=function(t){this.frameComponent=t,this.appContext.frameComponentRefresher.regFrameComponent(this.frameId,this.frameComponent)},Ns.prototype.invoke=function(t,e){var n=t.split("."),r=n[n.length-1],i=1===n.length?this.viewModel:this.getViewModel(n[n.length-2]);return i||alert("未匹配到'"+t+"'命令的视图模型，请检查事件是否配置正确。"),i[r](e)},Ns.decorators=[{type:d.Injectable}],Ns.ctorParameters=function(){return[{type:d.Injector},{type:Ns,decorators:[{type:d.Optional},{type:d.SkipSelf}]}]},Ns);function Ns(t,e){var n=Os.call(this)||this;n.injector=t,n.typeName="FrameContext",n.isDestoried=!1,n.metadata={identify:"",namespace:"",commands:null,form:null,formControls:null,subForms:null,stateMachine:null,uiStates:null,bindingTo:""},n.appContext=t.get(co),e&&e.appContext===n.appContext?(n.parent=e,n.root=e.root):(n.parent=null,n.root=n),n.frameId=t.get(so),n.appContext.contextMetadataManager.exsit(n.frameId)&&(n.metadata=n.appContext.contextMetadataManager.getContextMetadataByName(n.frameId)),n.namespace=t.get(po,null),n.bindingData=n.injector.get(Vn,new Vn),!n.appContext.useIsoluteEventBus||n.appContext.useIsoluteEventBus&&!n.appContext.isoluteEventBus?n.eventBus=n.injector.get(Oo,null,d.InjectFlags.Optional):n.eventBus=n.appContext.isoluteEventBus,n.form=n.injector.get(On,new On),n.repository=n.injector.get(cn,n.appContext.repository),n.uiState=n.injector.get(si,new si);var r=new Pi;r.setMetadata(n.metadata),n.viewModel=n.injector.get(Pi,r),n.variableParseService=t.get(jr,new jr([new Sr,new Er,new Cr,new Pr,new Tr])),n.exceptionHandler=t.get(ko,null,d.InjectFlags.Optional);var i=t.get(zr,null);n.translate=i,Mt.setTranslate(i);var o=t.get($o,null);return _t.setUserSettings(o),n.initializeRepository(),n.appContext.regFrameContext(n),n}var Ds=(Vs.prototype.ngOnInit=function(){this.initialize()},Vs.prototype.initialize=function(){this.initialized||(this.context.init(this),this.viewModel=this.context.viewModel,this.cd=this.getChangeDetectorRef(),this.initPublicEvent(),this.initSubscription(),this.restComponent(),this.onFrameComponentInit(),this.initialized=!0)},Vs.prototype.onFrameComponentInit=function(){var e=this,t=this.injector.get(uo,null);t&&Array.isArray(t)&&0<t.length&&t.forEach(function(t){t.onComponentInit(e.context)})},Vs.prototype.getChangeDetectorRef=function(){return this.injector.get(d.ChangeDetectorRef,null)},Vs.prototype.detach=function(){!1!==this.isCdValid()&&this.cd.detach()},Vs.prototype.reattach=function(){!1!==this.isCdValid()&&this.cd.reattach()},Vs.prototype.detectChanges=function(){!1!==this.isCdValid()&&this.cd.detectChanges()},Vs.prototype.isCdValid=function(){return this.cd&&!1===this.cd.destroyed||!1},Vs.prototype.restComponent=function(){this.context===this.context.root&&(null!==this.context.appContext.parent&&null!==this.context.appContext.parent.parent||(this.context.repository.reset(),this.context.bindingData.reset()))},Vs.prototype.ngOnDestroy=function(){var e=this;!0===this.context.isRootFrameContext()&&this.context.appContext.unregisterFromManager(this.context),this.eventPipes.forEach(function(t){t.disposeByCaller(e)}),this.context.destroy()},Vs.prototype.initSubscription=function(){this.subscription=this.getSubscription(),this.subscription&&(this.eventPipes=this.subscription.init(this))},Vs.prototype.getSubscription=function(){return this.injector.get(To,null)},Vs.prototype.initPublicEvent=function(){this.declaration=this.getDeclaration(),this.declaration&&this.declaration.init(this)},Vs.prototype.getDeclaration=function(){return this.injector.get(Eo,null)},Vs.prototype.trigger=function(e){var n=this,r=this.context.commandBus.executingCommandCount$.subscribe(function(t){0===t&&(n.innerTrigger(e),r?r.unsubscribe():setTimeout(function(){r&&r.unsubscribe()},0))})},Vs.prototype.innerTrigger=function(t){var e=this.declaration&&this.declaration[t];e&&e()},Vs.decorators=[{type:d.Injectable}],Vs.ctorParameters=function(){return[{type:d.Injector}]},Vs);function Vs(t){this.injector=t,this.initialized=!1,this.context=this.injector.get(Ss,null),this.context&&this.initialize()}var Fs=function wp(){},Rs=(Bs.prototype.on=function(e,t,n){this.events.pipe(l.filter(function(t){return t.type===e&&(!t.frameIds||-1<t.frameIds.indexOf(n))})).subscribe(t)},Bs.prototype.off=function(t,e){throw new Error("暂不实现")},Bs.prototype.trigger=function(t,e,n){var r={type:t,data:e,frameIds:n};this.events.next(r)},Bs.decorators=[{type:d.Injectable}],Bs);function Bs(){this.events=new h.Subject}var _s=(As.prototype.create=function(t){var e=this.handlerRegistry.get(t);return e.init(this.frameContext,this.variableParseService),this.extenderRegistry.get(t).reduce(function(t,e){return e.extend(t)},e)},As.decorators=[{type:d.Injectable}],As.ctorParameters=function(){return[{type:Yr},{type:ei},{type:Ss},{type:jr}]},As);function As(t,e,n,r){this.handlerRegistry=t,this.extenderRegistry=e,this.frameContext=n,this.variableParseService=r}var Ls=(ks.prototype.dispatch=function(e){var n=this,r=new h.Subject;return this.executeCommand(e).subscribe({next:function(t){r.next(t),r.complete()},complete:function(){r.complete(),n.removeCommandFromExecutingQueue(e)},error:function(t){r.error(t),n.removeCommandFromExecutingQueue(e,!n.is401Error(t))}}),r},ks.prototype.executeCommand=function(t){this.addCommandToExecutingQueue(t);var e=t.name;return this.handlerFactory.create(e).execute(t)},ks.prototype.addCommandToExecutingQueue=function(t){this.executingCommands.push(t),this.executingCommandCount$.next(this.executingCommands.length)},ks.prototype.removeCommandFromExecutingQueue=function(e,t){void 0===t&&(t=!0),this.executingCommands=this.executingCommands.filter(function(t){return t!==e}),!0===t&&this.executingCommandCount$.next(this.executingCommands.length)},ks.prototype.is401Error=function(t){return t&&401===t.status},ks.decorators=[{type:d.Injectable}],ks.ctorParameters=function(){return[{type:_s}]},ks);function ks(t){this.handlerFactory=t,this.executingCommands=[],this.executingCommandCount$=new h.BehaviorSubject(this.executingCommands.length)}var $s,Us=[Yr,ei,_s,Ls],Hs=(c(Ks,$s=qr),Ks.prototype.dynamicInvoke=function(t,e,n,r){var i=r.frameContext.injector.get(t,null);if(i){this.setContextToServiceInstance(i,r);var o=this.parseService.parse(n,r).map(function(t){return t.expression});return i[e].apply(i,o)}},Ks.prototype.dynamicInvoke2=function(t,s){var p=this,e=t.source,u=t.service,c=t.method,l=t.params.map(function(t){return Object.assign({},t)}),f=new h.Subject;return e&&System["import"](e).then(function(t){if(t[u]){var e=p.loadProvidersFromModule(t),n=d.ReflectiveInjector.fromResolvedProviders(e,s.frameContext.injector),r=s.frameContext.injector,i=(s.frameContext.injector=n).get(u,null);if(i){p.setContextToServiceInstance(i,s);var o=p.parseService.parse(l,s).map(function(t){return t.expression}),a=i[c].apply(i,o);(h.isObservable(a)?a:h.of(a)).subscribe({next:function(t){f.next(t)},error:function(t){f.error(t)},complete:function(){f.complete(),s.frameContext.injector=r}})}}}),f},Ks.prototype.schedule=function(){this.scheduleStages(this.method.stages,null)},Ks.prototype.scheduleStages=function(t,e){var r=this;t.reduce(function(t,e){if("executing"===e.type)r.addTask(e.name,function(t){return r.dynamicInvoke2(e,t)});else if("fork"===e.type)e.stages.forEach(function(t){r.scheduleStages(t.stages,t)}),r.scheduleStages(e.stages,e);else{if("determing"!==e.type)throw new Error("unknow method stage type, the "+e.name+"'s type is "+e.type);r.addTask(e.name,function(t){return h.of(!0)})}if(t){var n="determing"===t.type?t.condition:"1===1";r.addLink(t.name,e.name,n)}return e},e)},Ks.prototype.loadProvidersFromModule=function(t){var e=[];for(var n in t)if(Object.prototype.hasOwnProperty.call(t,n)){var r=t[n];if(this.isInjectableService(r)){var i=n;e.push({provide:i,useClass:r}),e.push(r)}}return d.ReflectiveInjector.resolve(e)},Ks.prototype.isInjectableService=function(t){var e=!1,n=t instanceof Function;if(n&&t.hasOwnProperty("decorators"))e=(r=t.decorators.filter(function(t){if(t.type&&t.type.prototype&&"Injectable"===t.type.prototype.ngMetadataName)return t}))&&0<r.length;else if(n&&t.hasOwnProperty("__annotations__")){var r;e=(r=t.__annotations__.filter(function(t){if(t&&t.ngMetadataName&&"Injectable"===t.ngMetadataName)return t}))&&0<r.length}return e},Ks);function Ks(t,e){var n=$s.call(this)||this;return n.commandName=t,n.method=e,n}var Gs=[Oo,To,cr,kr,co,Kt,Rs,Ri],zs=[Oo,To,cr,Kt,kr,Ri],qs=[co],Js=[la,va,Sa,ka,Ko,Ea,Wo,Qo,Zo,ea,{provide:Ue,useClass:dn,multi:!0},{provide:Ue,useClass:mn,multi:!0},{provide:Ue,useClass:bn,multi:!0},ze,{provide:oa,useClass:Qa,multi:!0},{provide:oa,useClass:ns,multi:!0},{provide:oa,useClass:Ga,multi:!0},{provide:oa,useClass:Ya,multi:!0},{provide:oa,useClass:os,multi:!0},{provide:oa,useClass:ps,multi:!0},{provide:oa,useClass:ls,multi:!0},{provide:oa,useClass:ys,multi:!0},{provide:oa,useClass:vs,multi:!0},{provide:oa,useClass:bs,multi:!0},{provide:oa,useClass:Ps,multi:!0},Ts,js,xn],Ws=[{provide:zo,useClass:aa,multi:!0},{provide:zo,useClass:ua,multi:!0},{provide:zo,useClass:da,multi:!0}],Ys=[{provide:Ca,useClass:xa,multi:!0},{provide:Ca,useClass:Ia,multi:!0},{provide:Ca,useClass:Ma,multi:!0},{provide:Ca,useClass:wa,multi:!0},{provide:Ca,useClass:Da,multi:!0},{provide:Ca,useClass:Fa,multi:!0},{provide:Ca,useClass:Ba,multi:!0},{provide:Ca,useClass:Aa,multi:!0}],Zs=[Us,Ss],Xs=(Qs.decorators=[{type:d.NgModule,args:[{providers:zs}]}],Qs);function Qs(){}var tp,ep=(c(np,tp=qo),np.prototype.buildEventPath=function(t){return null},np.decorators=[{type:d.Injectable}],np.ctorParameters=function(){return[{type:d.Injector},{type:Vn},{type:undefined,decorators:[{type:d.Inject,args:[po]}]}]},np);function np(t,e,n){var r=tp.call(this)||this;return r.injector=t,r.bindingData=e,r.namespace=n,r}x.ɵb=x.Expression,x.ɵc=qo,x.ɵe=ep,x.ɵa=Fr,x.ANNOTATIONS=C,x.PARAMETERS=I,x.PROP_METADATA=T,x.makeDecorator=M,x.makeParamDecorator=function Op(t,e,n){var r=j(e);function o(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];if(this instanceof o)return r.apply(this,t),this;var i=new(o.bind.apply(o,b([void 0],t)));return n.annotation=i,n;function n(t,e,n){for(var r=t.hasOwnProperty(I)?t[I]:Object.defineProperty(t,I,{value:[]})[I];r.length<=n;)r.push(null);return(r[n]=r[n]||[]).push(i),t}}return n&&(o.prototype=Object.create(n.prototype)),o.prototype.ngMetadataName=t,o.annotationCls=o},x.makePropDecorator=w,x.MetadataUtil=O,x.ChangeSet=F,x.Modification=D,x.Entity=zn,x.DynamicEntity=Wn,x.createEntity=ht,x.createEntities=yt,x.EntityFactory=dt,x.EntityList=St,x.NG_FIELD=_,x.NgField=A,x.NG_LIST=L,x.NgList=k,x.NG_OBJECT=$,x.NgObject=U,x.NG_Dynamic=H,x.NgDynamic=G,x.NG_ENTITY=z,x.NgEntity=function Sp(t){return M(z,function(t){return t})(t)},x.FieldMetadataUtil=it,x.EntityMetadataUtil=at,x.PARENT_PATH=pt,x.PARENT_CLASS=ut,x.ENTITY_DATA_SERVICE_TOKEN=tr,x.ValidationTypes=vt,x.Validator=wt,x.ValidationError=Et,x.entityPrototype=er,x.EntityTypeFactory=pr,x.EntityTypeCreator=lt,x.RestfulService=cr,x.NG_REPOSITORY=Je,x.NgRepository=function Np(t){return M(Je,function(t){return t})(t)},x.EntityCollection=We,x.EntityManager=Ze,x.Repository=cn,x.DefaultRepository=hn,x.SortConditionManager=rn,x.FilterConditionManager=an,x.BigNumberType=Rt,x.DEVKIT_RUN_MODE=Bt,x.DataPathNode=Me,x.DataPath=je,x.DataPathCreator=Se,x.DataPropInfo=De,x.DataTypeInfo=Ve,x.FORM_PATH_TOKEN=Re,x.BACK_END_MESSAGE_HANDLER_TOKEN=Be,x.MESSAGE_SERVICE_TOKEN=_e,x.NOTIFY_SERVICE_TOKEN=Ae,x.encodeUrl=function Dp(t){return String(t).replace(/(^|[^\uD800-\uDBFF])[\uDC00-\uDFFF]|[\uD800-\uDBFF]([^\uDC00-\uDFFF]|$)/g,"$1�$2").replace(/(?:[^\x21\x25\x26-\x3B\x3D\x3F-\x5B\x5D\x5F\x61-\x7A\x7E]|%(?:[^0-9A-Fa-f]|[0-9A-Fa-f][^0-9A-Fa-f]|$))+/g,encodeURI).replace("#","%23").replace("&","%26")},x.Core=Le,x.escape=$e,x.NG_COMMAND_HANDLER=fr,x.NgCommandHandler=function Vp(t){return M(fr,function(t){return t})(t)},x.NG_COMMAND_HANDLER_EXTENDER=hr,x.NgCommandHandlerExtender=function Fp(t){return M(hr,function(t){return t})(t)},x.TaskNode=yr,x.TaskLink=$r,x.TaskFlow=Hr,x.CommandContext=Gr,x.CommandHandler=qr,x.COMMAND_HANDLERS_TOKEN=Wr,x.CommandHandlerRegistry=Yr,x.CommandHandlerExtender=Xr,x.COMMAND_HANDLER_EXTENDERS_TOKEN=ti,x.CommandHandlerExtenderRegistry=ei,x.CommandHandlerFactory=_s,x.CommandBus=Ls,x.COMMAND_PROVIDERS=Us,x.DynamicCommandHandler=Hs,x.BaseBindingObject=zt,x.BindingObject=Zt,x.BindingList=Rn,x.BindingData=Vn,x.PropertyUtil=Jt,x.EntityUtil=Nn,x.BindingListFactory=ee,x.BindingObjectFactory=oe,x.BindingDataFactory=_n,x.NG_BINDING_DATA=Ln,x.NgBindingData=function Rp(t){return M(Ln,function(t){return t})(t)},x.BindingObjectTypeFactory=re,x.BindingListTypeFactory=Qt,x.Form=On,x.NG_VALIDATE_FORM=se,x.NgValidateForm=function Bp(t){return M(se,function(t){return t})(t)},x.NG_CHILD_FORM=pe,x.NgChildForm=ue,x.NG_CHILD_FORM_ARRAY=ce,x.NgChildFormArray=le,x.NG_FORM_CONTROL=fe,x.NgFormControl=he,x.State=ci,x.initialUIState=!1,x.StateMachineContext=li,x.effectHandlers=di,x.StateMachine=gi,x.NgState=mi,x.NgRenderState=Ei,x.NgAction=bi,x.UIState=si,x.NG_COMPONENT_STATE=ri,x.NgParam=ii,x.UIStateMetadataUtil=oi,x.PARAM_TYPE_TRANSFORM_TOKEN=ui,x.EventBus=Oo,x.EventCache=No,x.EventBusProxy=yo,x.EventPipe=jo,x.NG_DECLARATION=mo,x.NgDeclaration=function _p(t){return w(mo,function(t){return t})(t)},x.Declaration=Eo,x.NG_SUBSCRIPTION=Co,x.ParamMap=xo,x.NgSubscription=function Ap(t){return w(Co,function(t){return t})(t)},x.getNgSubscriptionDecoratorFactory=function Lp(){return w(Co,function(t){return t})},x.Subscription=To,x.ViewModel=Pi,x.NG_COMMAND=Ci,x.NgCommand=xi,x.Context=Ti,x.BindingDataManager=ji,x.RepositoryManager=Oi,x.FrameContextManager=fo,x.FrameComponentRefresher=Ni,x.AppContext=co,x.AppContextManager=Ri,x.ViewModelManager=no,x.FORM_ID=Li,x.EXCEPTION_HANDLER=ko,x.VARIABLE_PARSERS=gr,x.FrameIdVariableParser=Sr,x.DataVariableParser=Er,x.UIStateVariableParser=Cr,x.CommandVariableParser=Tr,x.StateMachineVariableParser=Pr,x.VariableParseService=jr,x.EventParamVariableParser=Ar,x.VARIABLE_PROVIDERS=kr,x.FrameContext=Ss,x.FrameComponent=Ds,x.FrameEvent=Fs,x.FrameEventBus=Rs,x.FRAME_ID=so,x.NAMESPACE=po,x.FRAME_COMPONENT_INIT_HANDLER_TOKEN=uo,x.RouterParamService=Kt,x.DataPathUtil=kn,x.UID=pn,x.Guid=Un,x.RunModeService=Kn,x.DateUtil=It,x.BindingPathConverter=ye,x.BindingPathComparer=ge,x.BindingPathTraverser=me,x.EntityPathConverter=be,x.EntityPathComparer=Pe,x.FormPathConverter=Ie,x.ExpressionUtil=In,x.DataTypeInfoUtil=Mn,x.FARRIS_DEVKIT_APP_PROVIDERS=Gs,x.FARRIS_DEVKIT_MODULE_PROVIDERS=zs,x.FARRIS_DEVKIT_ROOT_FRAME_PROVIDERS=qs,x.FARRIS_DEVKIT_EXPRESSION_ROOT_FRAME_PROVIDERS=Js,x.FARRIS_DEVKIT_EXPRESSION_LISTENER_PROVIDERS=Ws,x.FARRIS_DEVKIT_EXPRESSION_EFFECTOR_PROVIDERS=Ys,x.FARRIS_DEVKIT_FRAME_PROVIDERS=Zs,x.DevkitModule=Xs,x.TranslateToken=zr,x.UserSettingsToken=$o,x.ZonedTime=Lt,x.Schema=nr,x.SchemaEntity=rr,x.SchemaEntityType=ir,x.SchemaEntityField=or,x.SchemaEntityFieldType=ar,x.SchemaEntityFieldEditor=sr,x.DomService=Gi,x.FormContent=qi,x.FormContentForDB=Ji,x.FormMetadaDataDom=Wi,x.FormModule=Yi,x.FormOptions=Zi,x.LISTENER_TOKEN=zo,x.UIStateChangeListener=aa,x.RepositoryChangeListener=ua,x.ListenerRegistry=la,x.BindingDataChangeListener=da,x.Listeners=va,x.FORM_MANIFEST_SERVICE_TOKEN=Uo,x.FORM_EXPRESSION_MANIFEST_SERVICE_TOKEN=Ho,x.ExpressionEventEmitter=Ea,x.ExpressionRegistry=Ko,x.ExpressionExecutor=Wo,x.ExpressionEngineImpl=js,x.ExpressionManager=Qo,x.ExpressionResult=Zo,x.ExpressionResultFactory=ea,x.ASSIGNER_TOKEN=ia,x.EVENT_HANDLER_TOKEN=oa,x.EFFECTOR_TOKEN=Ca,x.RepositoryEffector=xa,x.UIStateEffector=Ia,x.ReadonlyEffector=Ma,x.DependencyEffector=wa,x.EffectorRegistry=Sa,x.EffectorFactory=ka,x.RelativeEffector=Da,x.ValidateEffector=Fa,x.RequiredEffector=Ba,x.VisibleEffector=Aa,x.RESOLVER_TOKEN=Ue,x.ENTITY_TEMPLATE=He,x.STATE_TEMPLATE=Ke,x.GROUP_FUNCTIONS=Ge,x.ResolverRegistry=ze,x.EntityDependencyResolver=dn,x.StateDependencyResolver=mn,x.CommentDependencyResolver=bn,x.ResolveService=xn,x.EntityValueChangedEventHandler=Ga,x.StateValueChangedEventHandler=Ya,x.RepositoryAddEntityEventHandler=Qa,x.RepositoryRemoveEntityEventHandler=ns,x.RepositoryLoadEventHandler=os,x.EntityUpdateEventHandler=ps,x.BindingDataAppendObjectEventHandler=ls,x.BindingDataValueChangeEventHandler=ys,x.BindingDataRemoveObjectEventHandler=vs,x.BindingDataLoadEventHandler=bs,x.BindingDataSelectionChangedEventHandler=Ps,x.EventHandlerRegistry=Ts,x.EventHandler=Ua,x.CacheKeyCompare=q,x.Cacheable=Z,x.CacheContainer=X,x.CacheObject=W,x.MemoryCacheProvider=tt,x.DefaultCacheProvider=nt,Object.defineProperty(x,"__esModule",{value:!0})});
//# sourceMappingURL=farris-devkit.umd.min.js.map