import { Subject } from 'rxjs';
import { ChangeSet } from '../changeset';
import { SchemaEntityField$Type } from '../schema/schema';
import { EntityList } from './entity_list';
import { entityPrototype } from './entity_prototype';
import { NG_FIELD, NG_LIST, NG_OBJECT } from './metadata';
import { PARENT_CLASS, PARENT_PATH } from './types';
import { Validator } from './validator';
import { ValidationUtils } from './validator/validation_utils';
/**
 * 实体类型工厂
 * 用来根据实体Schema描述信息创建实体类型
 */
export class EntityTypeFactory {
    constructor() { }
    /**
     * 由实体Schema结构创建实体类型
     * @param schema 实体Schema结构
     * @returns 实体类型
     */
    create(schema) {
        // 提取Schema定义中的第一个是实体描述
        const schemaType = schema.entities[0].type;
        // 创建实体类型
        const entityType = this.createClass(schemaType);
        return entityType;
    }
    /**
     * 由实体Schema类型描述创建实体类
     * @param schemaType Schema实体类型描述
     * @returns 实体类型
     */
    createClass(schemaType) {
        const attachEntityInstanceData = this.createEntityInstanceDataInitializer(schemaType);
        // 创建指定实体类型的初始化函数，用来在实体类型构造函数中为实体实例赋值
        const initialize = (entityInstance, entityData, entityTypeConstructor) => {
            entityInstance.isInitializing = true;
            attachEntityInstanceData(entityInstance, entityData, entityTypeConstructor);
            entityInstance.isInitializing = false;
        };
        // 声明实体类构造函数
        const ConcreteEntity = function (data) {
            // 创建实体变更集
            this.changeSet = new ChangeSet();
            // 初始化实体验证状态
            this.isValidating = false;
            // 初始化实体验证信息
            this.validErrors = {};
            // 初始化验证器
            this.validator = new Validator();
            // 初始化实体数据副本
            this.innerData = Object.assign({}, data);
            // 初始化子实体对象集合
            this.innerEntities = {};
            // 初始化实体值变化事件
            this.valueChanged = new Subject();
            this.onValueChanged = this.valueChanged;
            this.validateFromUtilSync = function (propertyName, value, cb, context) {
                this.validErrors = {};
                var result = this.validator.verify(this, propertyName, value, null, undefined, context && context.frameContext || null, true);
                if (result && !result.isValid) {
                    this.validErrors = ValidationUtils.convertErrorsToNormalObject(result.errors, {});
                }
                cb(result);
            };
            // 调用初始化方法，初始化实体数据
            initialize(this, data, ConcreteEntity);
            this.load = (newData) => {
                attachEntityInstanceData(this, newData, ConcreteEntity);
            };
        };
        // 在实体类构造函数中记录视图类型名称
        ConcreteEntity.typeName = `${schemaType.name}Entity`;
        // 在实体类构造函数中记录其下直接引用的子类型
        ConcreteEntity.types = {};
        ConcreteEntity.__prop__metadata__ = {};
        // 构造实体类的原型对象
        const entityTypePrototype = Object.assign({ typeName: 'ConcreteEntityPrototype' }, entityPrototype);
        // 向实体类原型对象中定义预制属性
        this.definePresetProperty(entityTypePrototype, schemaType);
        // 向实体类原型对象中定义字段属性get/set方法
        this.defineFieldsToPrototype(entityTypePrototype, schemaType.fields, schemaType.primary, ConcreteEntity);
        // 向实体类原型对象中定义访问子实体的get/set方法
        this.defineEntitiesToPrototype(entityTypePrototype, schemaType.entities, ConcreteEntity);
        // 将实体类的原型对象指向新构造的原型对象。
        ConcreteEntity.prototype = entityTypePrototype;
        return ConcreteEntity;
    }
    /**
     * 向实体类原型对象中定义预制属性
     * @param prototypeObject 实体类原型对象
     * @param schemaType Schema类型描述
     */
    definePresetProperty(prototypeObject, schemaType) {
        /**
         * 实体数据
         */
        Object.defineProperty(prototypeObject, 'data', {
            get: function () {
                return this.innerData;
            }
        });
        /**
         * 实体验证信息
         */
        Object.defineProperty(prototypeObject, 'errors', {
            get: function () {
                return this.validErrors;
            },
            set: function (errors) {
                this.validErrors = errors;
            }
        });
        /**
         * 实体变更集
         */
        Object.defineProperty(prototypeObject, 'changes', {
            get: function () {
                return this.changeSet.changes;
            }
        });
        /**
         * 实体主键
         */
        Object.defineProperty(prototypeObject, 'primaryProperty', {
            // tslint:disable-next-line: only-arrow-functions
            get: function () {
                // return schemaType.primary;
                return prototypeObject.innerPrimaryProperty || { dataField: schemaType.primary };
            }
        });
        /**
         * 实体主键
         */
        Object.defineProperty(prototypeObject, 'primaryKey', {
            // tslint:disable-next-line: only-arrow-functions
            get: function () {
                return schemaType.primary || '';
            }
        });
        /**
         * 实体主键的值
         */
        Object.defineProperty(prototypeObject, 'primaryValue', {
            get: function () {
                if (this.primaryKey) {
                    // return this[this.primaryProperty.property].toString();
                    const primaryValue = this[this.primaryKey];
                    return primaryValue ? primaryValue : '';
                }
                else {
                    return '';
                }
            }
        });
    }
    /**
     * 向实体类定义字段属性
     * @param prototypeObject 实体类原型对象
     * @param fields 字段描述集合
     * @param parentEntityType 父类型
     */
    defineFieldsToPrototype(prototypeObject, fields, primary, parentEntityType) {
        if (fields && fields.length) {
            // 遍历Schema中描述的字段，在实体原型对象上定义字段访问函数
            fields.forEach(schemaEntityField => {
                switch (schemaEntityField.$type) {
                    // 定义简单类型字段
                    case SchemaEntityField$Type.SimpleField:
                        this.defineSimpleFieldToPrototype(prototypeObject, schemaEntityField, primary, parentEntityType);
                        break;
                    // 定义复杂类型字段
                    case SchemaEntityField$Type.ComplexField:
                        this.defineComplexFieldToPrototype(prototypeObject, schemaEntityField, parentEntityType);
                        break;
                }
            });
        }
    }
    /**
     * 向实体类定义简单类型字段
     * @param prototypeObject 实体类原型对象
     * @param schemaField 字段描述
     */
    defineSimpleFieldToPrototype(prototypeObject, schemaField, primary, parentEntityType) {
        const propertyName = schemaField.label;
        Object.defineProperty(prototypeObject, propertyName, {
            get: function () {
                return this.getFieldValue(schemaField);
            },
            set: function (newPropValue) {
                // 值相同时不触发变更。
                const oldPropValue = this.getFieldValue(schemaField);
                if (this.isFieldValueChanged(schemaField, newPropValue, oldPropValue) === false) {
                    return;
                }
                this.setFieldValue(schemaField, newPropValue);
                this.emitFieldValueChange(schemaField, newPropValue, oldPropValue);
            }
        });
        const fieldMetadata = {
            /** 字段名称 */
            dataField: schemaField.label,
            /** 原始字段名称 */
            originalDataField: schemaField.code,
            /** 原始字段类型 */
            originalDataFieldType: schemaField.type.name,
            /**
             * 原始字段
             * @description 对应到scheme的path属性
             */
            path: schemaField.path,
            primary: schemaField.label === primary,
            ngMetadataName: NG_FIELD
        };
        if (fieldMetadata.primary) {
            prototypeObject.innerPrimaryProperty = fieldMetadata;
        }
        if (!parentEntityType.__prop__metadata__[propertyName]) {
            parentEntityType.__prop__metadata__[propertyName] = [];
        }
        parentEntityType.__prop__metadata__[propertyName].push(fieldMetadata);
    }
    /**
     * 向实体类定义复杂类型字段
     * @param prototypeObject 实体类原型对象
     * @param schemaField 字段描述
     * @param parentEntityType 父类型
     */
    defineComplexFieldToPrototype(prototypeObject, schemaField, parentEntityType) {
        const complexFieldType = this.createClass(schemaField.type);
        parentEntityType.types[schemaField.type.name] = complexFieldType;
        const propertyName = schemaField.label;
        Object.defineProperty(prototypeObject, propertyName, {
            get: function () {
                const fieldValue = this.getComplexFieldValue(schemaField);
                return fieldValue;
            },
            set: function (value) {
                this.setComplexFieldValue(schemaField, complexFieldType, value);
            }
        });
        const fieldMetadata = {
            /** 映射字段 */
            dataField: schemaField.label,
            /** 原始字段名称 */
            originalDataField: schemaField.code,
            /** 引用实体类型 */
            type: complexFieldType,
            /**
             * 原始字段
             * @description 对应到scheme的path属性
             */
            path: schemaField.path,
            ngMetadataName: NG_OBJECT
        };
        if (!parentEntityType.__prop__metadata__[propertyName]) {
            parentEntityType.__prop__metadata__[propertyName] = [];
        }
        parentEntityType.__prop__metadata__[propertyName].push(fieldMetadata);
    }
    /**
     * 向实体类定义子实体
     * @param prototypeObject 实体类原型对象
     * @param entities 实体描述集合
     * @param parentEntityType 父类型
     */
    defineEntitiesToPrototype(prototypeObject, entities, parentEntityType) {
        if (entities && entities.length) {
            // 遍历Schema中描述的子实体，在实体对象上定义子实体列表
            entities.forEach(schemaEntity => {
                const complexFieldType = this.createClass(schemaEntity.type);
                parentEntityType.types[schemaEntity.type.name] = complexFieldType;
                // 提取子实体在实体对象上的属性名
                const propertyName = schemaEntity.label;
                Object.defineProperty(prototypeObject, propertyName, {
                    get: function () {
                        const fieldValue = this.getEntities(schemaEntity);
                        return fieldValue;
                    },
                    set: function (value) {
                        this.setEntities(schemaEntity, value);
                    }
                });
                const entitMetadata = {
                    /** 字段名称 */
                    dataField: schemaEntity.label,
                    /** 原始字段名称 */
                    originalDataField: '',
                    /** 实体类型 */
                    type: complexFieldType,
                    ngMetadataName: NG_LIST
                };
                if (!parentEntityType.__prop__metadata__[propertyName]) {
                    parentEntityType.__prop__metadata__[propertyName] = [];
                }
                parentEntityType.__prop__metadata__[propertyName].push(entitMetadata);
            });
        }
    }
    /**
     * 创建初始化实体对象方法
     * @param schemaType 实体类型描述
     * @returns 初始化实体对象方法
     */
    createEntityInstanceDataInitializer(schemaType) {
        /**
         * 实体初始化函数，用来初始化实体的复杂类型数据和子实体数据
         * @param entityInstance 实体类型实例
         * @param data 实体原始数据
         * @param entityTypeConstructor 实体类型构造函数
         */
        const initializer = (entityInstance, entityData, entityTypeConstructor) => {
            // 初始化复杂类型字段
            schemaType.fields
                // 过滤复杂类型字段
                .filter(field => field.$type === SchemaEntityField$Type.ComplexField)
                // 遍历复杂类型字段创建对应实体类型数据
                .forEach(field => {
                // 提取字段名
                const fieldName = field.label;
                // 提取实体类型下的所有子实体类型
                const includedEntityTypes = entityTypeConstructor.types;
                // 获取复杂类型字段对应的实体类型
                const ComplexField = includedEntityTypes[field.type.name];
                // 提取复杂类型字段原始数据
                const fieldData = entityData ? entityData[fieldName] : null;
                // 创建复杂类型字段对象路径
                const path = entityInstance.createPath(fieldName);
                let complexFieldValue = entityInstance[fieldName];
                if (complexFieldValue instanceof ComplexField) {
                    complexFieldValue.load(fieldData);
                }
                else {
                    // 创建复杂类型字段实体实例
                    complexFieldValue = new ComplexField(fieldData);
                    complexFieldValue.constructor = ComplexField;
                    complexFieldValue[PARENT_CLASS] = entityTypeConstructor;
                    complexFieldValue[PARENT_PATH] = path;
                    complexFieldValue.onValueChanged.subscribe(changes => {
                        if (changes) {
                            changes.path = (entityInstance[PARENT_PATH] || []).concat(changes.path);
                            entityInstance.setChanges(changes);
                        }
                    });
                    entityInstance[fieldName] = complexFieldValue;
                }
            });
            // 初始化子实体
            if (schemaType.entities) {
                // 遍历子实体创建对应实体类型的数据
                schemaType.entities.forEach(schemaEntity => {
                    // 提取子实体名
                    const subEntityName = schemaEntity.label;
                    // 提取实体类型下的所有子实体类型
                    const includedEntityTypes = entityTypeConstructor.types;
                    // 创建子实体对象路径
                    const path = entityInstance.createPath(subEntityName);
                    // 创建子实体对象集合
                    let entityList = entityInstance[subEntityName];
                    if (!(entityList instanceof EntityList)) {
                        entityList = new EntityList();
                        // 向子实体列表注册子实体变化事件
                        entityList.onListChanged.subscribe(value => {
                            if (value) {
                                if (entityList[PARENT_PATH][0] !== value.path[0]) {
                                    value.path = entityList[PARENT_PATH].concat(value.path);
                                }
                                entityInstance.setChanges(value);
                            }
                        });
                        // 向实体类型实例上直接存储子实体对象列表
                        entityInstance[subEntityName] = entityList;
                    }
                    entityList[PARENT_CLASS] = entityTypeConstructor;
                    entityList[PARENT_PATH] = path;
                    // 提取子实体类型名称
                    const schemaEntityTypeName = schemaEntity.type.name;
                    // 获取子实体类型
                    const ConcreteEntity = includedEntityTypes[schemaEntityTypeName];
                    const originalEntityDataArray = entityData ? entityData[subEntityName] : null;
                    // 构造子实体集合
                    if (originalEntityDataArray) {
                        // 遍历子实体原始数据，构造实体对象集合
                        const entities = originalEntityDataArray.map((originalEntityData) => {
                            const concreteEntityInstance = new ConcreteEntity(originalEntityData);
                            concreteEntityInstance.constructor = ConcreteEntity;
                            return concreteEntityInstance;
                        });
                        // 向子实体列表中添加子实体对象
                        entityList.loadEntities(entities);
                    }
                });
            }
        };
        return initializer;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW50aXR5X3R5cGVfZmFjdG9yeS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL2VudGl0eS9lbnRpdHlfdHlwZV9mYWN0b3J5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDL0IsT0FBTyxFQUFFLFNBQVMsRUFBZ0IsTUFBTSxjQUFjLENBQUM7QUFDdkQsT0FBTyxFQUEyQyxzQkFBc0IsRUFBYyxNQUFNLGtCQUFrQixDQUFDO0FBRS9HLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3JELE9BQU8sRUFBRSxRQUFRLEVBQUUsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLFlBQVksQ0FBQztBQUMxRCxPQUFPLEVBQUUsWUFBWSxFQUFFLFdBQVcsRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUNwRCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQ3hDLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQVEvRDs7O0dBR0c7QUFDSCxNQUFNLE9BQU8saUJBQWlCO0lBRTVCLGdCQUFnQixDQUFDO0lBQ2pCOzs7O09BSUc7SUFDSSxNQUFNLENBQUMsTUFBYztRQUMxQix1QkFBdUI7UUFDdkIsTUFBTSxVQUFVLEdBQUcsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7UUFDM0MsU0FBUztRQUNULE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDaEQsT0FBTyxVQUFVLENBQUM7SUFDcEIsQ0FBQztJQUNEOzs7O09BSUc7SUFDSyxXQUFXLENBQUMsVUFBc0I7UUFDeEMsTUFBTSx3QkFBd0IsR0FBRyxJQUFJLENBQUMsbUNBQW1DLENB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LE1BQU0sdUJBQXVCLEdBQUcsVUFBVSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztvQkFDOUUsVUFBVTtvQkFDVixJQUFJLHVCQUF1QixFQUFFO3dCQUMzQixxQkFBcUI7d0JBQ3JCLE1BQU0sUUFBUSxHQUFHLHVCQUF1QixDQUFDLEdBQUcsQ0FBQyxDQUFDLGtCQUF1QixFQUFFLEVBQUU7NEJBQ3ZFLE1BQU0sc0JBQXNCLEdBQUcsSUFBSSxjQUFjLENBQUMsa0JBQWtCLENBQUMsQ0FBQzs0QkFDdEUsc0JBQXNCLENBQUMsV0FBVyxHQUFHLGNBQWMsQ0FBQzs0QkFDcEQsT0FBTyxzQkFBc0IsQ0FBQzt3QkFDaEMsQ0FBQyxDQUFDLENBQUM7d0JBQ0gsaUJBQWlCO3dCQUNqQixVQUFVLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxDQUFDO3FCQUNuQztnQkFDSCxDQUFDLENBQUMsQ0FBQzthQUNKO1FBQ0gsQ0FBQyxDQUFDO1FBQ0YsT0FBTyxXQUFXLENBQUM7SUFDckIsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBDaGFuZ2VTZXQsIE1vZGlmaWNhdGlvbiB9IGZyb20gJy4uL2NoYW5nZXNldCc7XHJcbmltcG9ydCB7IFNjaGVtYSwgU2NoZW1hRW50aXR5LCBTY2hlbWFFbnRpdHlGaWVsZCwgU2NoZW1hRW50aXR5RmllbGQkVHlwZSwgU2NoZW1hVHlwZSB9IGZyb20gJy4uL3NjaGVtYS9zY2hlbWEnO1xyXG5pbXBvcnQgeyBFbnRpdHkgfSBmcm9tICcuL2VudGl0eSc7XHJcbmltcG9ydCB7IEVudGl0eUxpc3QgfSBmcm9tICcuL2VudGl0eV9saXN0JztcclxuaW1wb3J0IHsgZW50aXR5UHJvdG90eXBlIH0gZnJvbSAnLi9lbnRpdHlfcHJvdG90eXBlJztcclxuaW1wb3J0IHsgTkdfRklFTEQsIE5HX0xJU1QsIE5HX09CSkVDVCB9IGZyb20gJy4vbWV0YWRhdGEnO1xyXG5pbXBvcnQgeyBQQVJFTlRfQ0xBU1MsIFBBUkVOVF9QQVRIIH0gZnJvbSAnLi90eXBlcyc7XHJcbmltcG9ydCB7IFZhbGlkYXRvciB9IGZyb20gJy4vdmFsaWRhdG9yJztcclxuaW1wb3J0IHsgVmFsaWRhdGlvblV0aWxzIH0gZnJvbSAnLi92YWxpZGF0b3IvdmFsaWRhdGlvbl91dGlscyc7XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIEFic3RyYWN0RW50aXR5VHlwZSB7XHJcbiAgdHlwZU5hbWU6IHN0cmluZztcclxuICB0eXBlczogYW55O1xyXG4gIF9fcHJvcF9fbWV0YWRhdGFfXzogYW55O1xyXG59XHJcblxyXG4vKipcclxuICog5a6e5L2T57G75Z6L5bel5Y6CXHJcbiAqIOeUqOadpeagueaNruWunuS9k1NjaGVtYeaPj+i/sOS/oeaBr+WIm+W7uuWunuS9k+exu+Wei1xyXG4gKi9cclxuZXhwb3J0IGNsYXNzIEVudGl0eVR5cGVGYWN0b3J5IHtcclxuXHJcbiAgY29uc3RydWN0b3IoKSB7IH1cclxuICAvKipcclxuICAgKiDnlLHlrp7kvZNTY2hlbWHnu5PmnoTliJvlu7rlrp7kvZPnsbvlnotcclxuICAgKiBAcGFyYW0gc2NoZW1hIOWunuS9k1NjaGVtYee7k+aehFxyXG4gICAqIEByZXR1cm5zIOWunuS9k+exu+Wei1xyXG4gICAqL1xyXG4gIHB1YmxpYyBjcmVhdGUoc2NoZW1hOiBTY2hlbWEpIHtcclxuICAgIC8vIOaPkOWPllNjaGVtYeWumuS5ieS4reeahOesrOS4gOS4quaYr+WunuS9k+aPj+i/sFxyXG4gICAgY29uc3Qgc2NoZW1hVHlwZSA9IHNjaGVtYS5lbnRpdGllc1swXS50eXBlO1xyXG4gICAgLy8g5Yib5bu65a6e5L2T57G75Z6LXHJcbiAgICBjb25zdCBlbnRpdHlUeXBlID0gdGhpcy5jcmVhdGVDbGFzcyhzY2hlbWFUeXBlKTtcclxuICAgIHJldHVybiBlbnRpdHlUeXBlO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDnlLHlrp7kvZNTY2hlbWHnsbvlnovmj4/ov7DliJvlu7rlrp7kvZPnsbtcclxuICAgKiBAcGFyYW0gc2NoZW1hVHlwZSBTY2hlbWHlrp7kvZPnsbvlnovmj4/ov7BcclxuICAgKiBAcmV0dXJucyDlrp7kvZPnsbvlnotcclxuICAgKi9cclxuICBwcml2YXRlIGNyZWF0ZUNsYXNzKHNjaGVtYVR5cGU6IFNjaGVtYVR5cGUpIHtcclxuICAgIGNvbnN0IGF0dGFjaEVudGl0eUluc3RhbmNlRGF0YSA9IHRoaXMuY3JlYXRlRW50aXR5SW5zdGFuY2VEYXRhSW5pdGlhbGl6ZXIoc2NoZW1hVHlwZSk7XHJcbiAgICAvLyDliJvlu7rmjIflrprlrp7kvZPnsbvlnovnmoTliJ3lp4vljJblh73mlbDvvIznlKjmnaXlnKjlrp7kvZPnsbvlnovmnoTpgKDlh73mlbDkuK3kuLrlrp7kvZPlrp7kvovotYvlgLxcclxuICAgIGNvbnN0IGluaXRpYWxpemUgPSAoZW50aXR5SW5zdGFuY2U6IGFueSwgZW50aXR5RGF0YTogYW55LCBlbnRpdHlUeXBlQ29uc3RydWN0b3I6IGFueSkgPT4ge1xyXG4gICAgICBlbnRpdHlJbnN0YW5jZS5pc0luaXRpYWxpemluZyA9IHRydWU7XHJcbiAgICAgIGF0dGFjaEVudGl0eUluc3RhbmNlRGF0YShlbnRpdHlJbnN0YW5jZSwgZW50aXR5RGF0YSwgZW50aXR5VHlwZUNvbnN0cnVjdG9yKTtcclxuICAgICAgZW50aXR5SW5zdGFuY2UuaXNJbml0aWFsaXppbmcgPSBmYWxzZTtcclxuICAgIH07XHJcbiAgICAvLyDlo7DmmI7lrp7kvZPnsbvmnoTpgKDlh73mlbBcclxuICAgIGNvbnN0IENvbmNyZXRlRW50aXR5ID0gZnVuY3Rpb24gKGRhdGE6IGFueSkge1xyXG4gICAgICAvLyDliJvlu7rlrp7kvZPlj5jmm7Tpm4ZcclxuICAgICAgdGhpcy5jaGFuZ2VTZXQgPSBuZXcgQ2hhbmdlU2V0KCk7XHJcbiAgICAgIC8vIOWIneWni+WMluWunuS9k+mqjOivgeeKtuaAgVxyXG4gICAgICB0aGlzLmlzVmFsaWRhdGluZyA9IGZhbHNlO1xyXG4gICAgICAvLyDliJ3lp4vljJblrp7kvZPpqozor4Hkv6Hmga9cclxuICAgICAgdGhpcy52YWxpZEVycm9ycyA9IHt9O1xyXG4gICAgICAvLyDliJ3lp4vljJbpqozor4HlmahcclxuICAgICAgdGhpcy52YWxpZGF0b3IgPSBuZXcgVmFsaWRhdG9yKCk7XHJcbiAgICAgIC8vIOWIneWni+WMluWunuS9k+aVsOaNruWJr+acrFxyXG4gICAgICB0aGlzLmlubmVyRGF0YSA9IE9iamVjdC5hc3NpZ24oe30sIGRhdGEpO1xyXG4gICAgICAvLyDliJ3lp4vljJblrZDlrp7kvZPlr7nosaHpm4blkIhcclxuICAgICAgdGhpcy5pbm5lckVudGl0aWVzID0ge307XHJcbiAgICAgIC8vIOWIneWni+WMluWunuS9k+WAvOWPmOWMluS6i+S7tlxyXG4gICAgICB0aGlzLnZhbHVlQ2hhbmdlZCA9IG5ldyBTdWJqZWN0PE1vZGlmaWNhdGlvbj4oKTtcclxuICAgICAgdGhpcy5vblZhbHVlQ2hhbmdlZCA9IHRoaXMudmFsdWVDaGFuZ2VkO1xyXG4gICAgICB0aGlzLnZhbGlkYXRlRnJvbVV0aWxTeW5jID0gZnVuY3Rpb24gKHByb3BlcnR5TmFtZSwgdmFsdWUsIGNiLCBjb250ZXh0KSB7XHJcbiAgICAgICAgdGhpcy52YWxpZEVycm9ycyA9IHt9O1xyXG4gICAgICAgIHZhciByZXN1bHQgPSB0aGlzLnZhbGlkYXRvci52ZXJpZnkodGhpcywgcHJvcGVydHlOYW1lLCB2YWx1ZSwgbnVsbCwgdW5kZWZpbmVkLCBjb250ZXh0ICYmIGNvbnRleHQuZnJhbWVDb250ZXh0IHx8IG51bGwsIHRydWUpO1xyXG4gICAgICAgIGlmIChyZXN1bHQgJiYgIXJlc3VsdC5pc1ZhbGlkKSB7XHJcbiAgICAgICAgICB0aGlzLnZhbGlkRXJyb3JzID0gVmFsaWRhdGlvblV0aWxzLmNvbnZlcnRFcnJvcnNUb05vcm1hbE9iamVjdChyZXN1bHQuZXJyb3JzLCB7fSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNiKHJlc3VsdCk7XHJcbiAgICAgIH07XHJcbiAgICAgIC8vIOiwg+eUqOWIneWni+WMluaWueazle+8jOWIneWni+WMluWunuS9k+aVsOaNrlxyXG4gICAgICBpbml0aWFsaXplKHRoaXMsIGRhdGEsIENvbmNyZXRlRW50aXR5KTtcclxuICAgICAgdGhpcy5sb2FkID0gKG5ld0RhdGE6IGFueSkgPT4ge1xyXG4gICAgICAgIGF0dGFjaEVudGl0eUluc3RhbmNlRGF0YSh0aGlzLCBuZXdEYXRhLCBDb25jcmV0ZUVudGl0eSk7XHJcbiAgICAgIH07XHJcbiAgICB9O1xyXG4gICAgLy8g5Zyo5a6e5L2T57G75p6E6YCg5Ye95pWw5Lit6K6w5b2V6KeG5Zu+57G75Z6L5ZCN56ewXHJcbiAgICBDb25jcmV0ZUVudGl0eS50eXBlTmFtZSA9IGAke3NjaGVtYVR5cGUubmFtZX1FbnRpdHlgO1xyXG4gICAgLy8g5Zyo5a6e5L2T57G75p6E6YCg5Ye95pWw5Lit6K6w5b2V5YW25LiL55u05o6l5byV55So55qE5a2Q57G75Z6LXHJcbiAgICBDb25jcmV0ZUVudGl0eS50eXBlcyA9IHt9O1xyXG4gICAgQ29uY3JldGVFbnRpdHkuX19wcm9wX19tZXRhZGF0YV9fID0ge307XHJcbiAgICAvLyDmnoTpgKDlrp7kvZPnsbvnmoTljp/lnovlr7nosaFcclxuICAgIGNvbnN0IGVudGl0eVR5cGVQcm90b3R5cGUgPSBPYmplY3QuYXNzaWduKHsgdHlwZU5hbWU6ICdDb25jcmV0ZUVudGl0eVByb3RvdHlwZScgfSwgZW50aXR5UHJvdG90eXBlKTtcclxuICAgIC8vIOWQkeWunuS9k+exu+WOn+Wei+WvueixoeS4reWumuS5iemihOWItuWxnuaAp1xyXG4gICAgdGhpcy5kZWZpbmVQcmVzZXRQcm9wZXJ0eShlbnRpdHlUeXBlUHJvdG90eXBlLCBzY2hlbWFUeXBlKTtcclxuICAgIC8vIOWQkeWunuS9k+exu+WOn+Wei+WvueixoeS4reWumuS5ieWtl+auteWxnuaAp2dldC9zZXTmlrnms5VcclxuICAgIHRoaXMuZGVmaW5lRmllbGRzVG9Qcm90b3R5cGUoZW50aXR5VHlwZVByb3RvdHlwZSwgc2NoZW1hVHlwZS5maWVsZHMsIHNjaGVtYVR5cGUucHJpbWFyeSwgQ29uY3JldGVFbnRpdHkpO1xyXG4gICAgLy8g5ZCR5a6e5L2T57G75Y6f5Z6L5a+56LGh5Lit5a6a5LmJ6K6/6Zeu5a2Q5a6e5L2T55qEZ2V0L3NldOaWueazlVxyXG4gICAgdGhpcy5kZWZpbmVFbnRpdGllc1RvUHJvdG90eXBlKGVudGl0eVR5cGVQcm90b3R5cGUsIHNjaGVtYVR5cGUuZW50aXRpZXMsIENvbmNyZXRlRW50aXR5KTtcclxuICAgIC8vIOWwhuWunuS9k+exu+eahOWOn+Wei+WvueixoeaMh+WQkeaWsOaehOmAoOeahOWOn+Wei+WvueixoeOAglxyXG4gICAgQ29uY3JldGVFbnRpdHkucHJvdG90eXBlID0gZW50aXR5VHlwZVByb3RvdHlwZTtcclxuXHJcbiAgICByZXR1cm4gQ29uY3JldGVFbnRpdHk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOWQkeWunuS9k+exu+WOn+Wei+WvueixoeS4reWumuS5iemihOWItuWxnuaAp1xyXG4gICAqIEBwYXJhbSBwcm90b3R5cGVPYmplY3Qg5a6e5L2T57G75Y6f5Z6L5a+56LGhXHJcbiAgICogQHBhcmFtIHNjaGVtYVR5cGUgU2NoZW1h57G75Z6L5o+P6L+wXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBkZWZpbmVQcmVzZXRQcm9wZXJ0eShwcm90b3R5cGVPYmplY3Q6IGFueSwgc2NoZW1hVHlwZTogU2NoZW1hVHlwZSkge1xyXG4gICAgLyoqXHJcbiAgICAgKiDlrp7kvZPmlbDmja5cclxuICAgICAqL1xyXG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHByb3RvdHlwZU9iamVjdCwgJ2RhdGEnLCB7XHJcbiAgICAgIGdldDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmlubmVyRGF0YTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICAvKipcclxuICAgICAqIOWunuS9k+mqjOivgeS/oeaBr1xyXG4gICAgICovXHJcbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkocHJvdG90eXBlT2JqZWN0LCAnZXJyb3JzJywge1xyXG4gICAgICBnZXQ6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy52YWxpZEVycm9ycztcclxuICAgICAgfSxcclxuICAgICAgc2V0OiBmdW5jdGlvbiAoZXJyb3JzOiBhbnkpIHtcclxuICAgICAgICB0aGlzLnZhbGlkRXJyb3JzID0gZXJyb3JzO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICAgIC8qKlxyXG4gICAgICog5a6e5L2T5Y+Y5pu06ZuGXHJcbiAgICAgKi9cclxuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShwcm90b3R5cGVPYmplY3QsICdjaGFuZ2VzJywge1xyXG4gICAgICBnZXQ6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5jaGFuZ2VTZXQuY2hhbmdlcztcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICAvKipcclxuICAgICAqIOWunuS9k+S4u+mUrlxyXG4gICAgICovXHJcbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkocHJvdG90eXBlT2JqZWN0LCAncHJpbWFyeVByb3BlcnR5Jywge1xyXG4gICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IG9ubHktYXJyb3ctZnVuY3Rpb25zXHJcbiAgICAgIGdldDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIC8vIHJldHVybiBzY2hlbWFUeXBlLnByaW1hcnk7XHJcbiAgICAgICAgcmV0dXJuIHByb3RvdHlwZU9iamVjdC5pbm5lclByaW1hcnlQcm9wZXJ0eSB8fCB7IGRhdGFGaWVsZDogc2NoZW1hVHlwZS5wcmltYXJ5IH07XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgLyoqXHJcbiAgICAgKiDlrp7kvZPkuLvplK5cclxuICAgICAqL1xyXG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHByb3RvdHlwZU9iamVjdCwgJ3ByaW1hcnlLZXknLCB7XHJcbiAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogb25seS1hcnJvdy1mdW5jdGlvbnNcclxuICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgcmV0dXJuIHNjaGVtYVR5cGUucHJpbWFyeSB8fCAnJztcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICAvKipcclxuICAgICAqIOWunuS9k+S4u+mUrueahOWAvFxyXG4gICAgICovXHJcbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkocHJvdG90eXBlT2JqZWN0LCAncHJpbWFyeVZhbHVlJywge1xyXG4gICAgICBnZXQ6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICBpZiAodGhpcy5wcmltYXJ5S2V5KSB7XHJcbiAgICAgICAgICAvLyByZXR1cm4gdGhpc1t0aGlzLnByaW1hcnlQcm9wZXJ0eS5wcm9wZXJ0eV0udG9TdHJpbmcoKTtcclxuICAgICAgICAgIGNvbnN0IHByaW1hcnlWYWx1ZSA9IHRoaXNbdGhpcy5wcmltYXJ5S2V5XTtcclxuICAgICAgICAgIHJldHVybiBwcmltYXJ5VmFsdWUgPyBwcmltYXJ5VmFsdWUgOiAnJztcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgcmV0dXJuICcnO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOWQkeWunuS9k+exu+WumuS5ieWtl+auteWxnuaAp1xyXG4gICAqIEBwYXJhbSBwcm90b3R5cGVPYmplY3Qg5a6e5L2T57G75Y6f5Z6L5a+56LGhXHJcbiAgICogQHBhcmFtIGZpZWxkcyDlrZfmrrXmj4/ov7Dpm4blkIhcclxuICAgKiBAcGFyYW0gcGFyZW50RW50aXR5VHlwZSDniLbnsbvlnotcclxuICAgKi9cclxuICBwcml2YXRlIGRlZmluZUZpZWxkc1RvUHJvdG90eXBlKFxyXG4gICAgcHJvdG90eXBlT2JqZWN0OiBhbnksXHJcbiAgICBmaWVsZHM6IFNjaGVtYUVudGl0eUZpZWxkW10sXHJcbiAgICBwcmltYXJ5OiBzdHJpbmcsXHJcbiAgICBwYXJlbnRFbnRpdHlUeXBlOiBBYnN0cmFjdEVudGl0eVR5cGVcclxuICApOiB2b2lkIHtcclxuICAgIGlmIChmaWVsZHMgJiYgZmllbGRzLmxlbmd0aCkge1xyXG4gICAgICAvLyDpgY3ljoZTY2hlbWHkuK3mj4/ov7DnmoTlrZfmrrXvvIzlnKjlrp7kvZPljp/lnovlr7nosaHkuIrlrprkuYnlrZfmrrXorr/pl67lh73mlbBcclxuICAgICAgZmllbGRzLmZvckVhY2goc2NoZW1hRW50aXR5RmllbGQgPT4ge1xyXG4gICAgICAgIHN3aXRjaCAoc2NoZW1hRW50aXR5RmllbGQuJHR5cGUpIHtcclxuICAgICAgICAgIC8vIOWumuS5ieeugOWNleexu+Wei+Wtl+autVxyXG4gICAgICAgICAgY2FzZSBTY2hlbWFFbnRpdHlGaWVsZCRUeXBlLlNpbXBsZUZpZWxkOlxyXG4gICAgICAgICAgICB0aGlzLmRlZmluZVNpbXBsZUZpZWxkVG9Qcm90b3R5cGUocHJvdG90eXBlT2JqZWN0LCBzY2hlbWFFbnRpdHlGaWVsZCwgcHJpbWFyeSwgcGFyZW50RW50aXR5VHlwZSk7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgLy8g5a6a5LmJ5aSN5p2C57G75Z6L5a2X5q61XHJcbiAgICAgICAgICBjYXNlIFNjaGVtYUVudGl0eUZpZWxkJFR5cGUuQ29tcGxleEZpZWxkOlxyXG4gICAgICAgICAgICB0aGlzLmRlZmluZUNvbXBsZXhGaWVsZFRvUHJvdG90eXBlKHByb3RvdHlwZU9iamVjdCwgc2NoZW1hRW50aXR5RmllbGQsIHBhcmVudEVudGl0eVR5cGUpO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH1cclxuICAvKipcclxuICAgKiDlkJHlrp7kvZPnsbvlrprkuYnnroDljZXnsbvlnovlrZfmrrVcclxuICAgKiBAcGFyYW0gcHJvdG90eXBlT2JqZWN0IOWunuS9k+exu+WOn+Wei+WvueixoVxyXG4gICAqIEBwYXJhbSBzY2hlbWFGaWVsZCDlrZfmrrXmj4/ov7BcclxuICAgKi9cclxuICBwcml2YXRlIGRlZmluZVNpbXBsZUZpZWxkVG9Qcm90b3R5cGUoXHJcbiAgICBwcm90b3R5cGVPYmplY3Q6IGFueSxcclxuICAgIHNjaGVtYUZpZWxkOiBTY2hlbWFFbnRpdHlGaWVsZCxcclxuICAgIHByaW1hcnk6IHN0cmluZyxcclxuICAgIHBhcmVudEVudGl0eVR5cGU6IEFic3RyYWN0RW50aXR5VHlwZVxyXG4gICkge1xyXG4gICAgY29uc3QgcHJvcGVydHlOYW1lID0gc2NoZW1hRmllbGQubGFiZWw7XHJcbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkocHJvdG90eXBlT2JqZWN0LCBwcm9wZXJ0eU5hbWUsIHtcclxuICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0RmllbGRWYWx1ZShzY2hlbWFGaWVsZCk7XHJcbiAgICAgIH0sXHJcbiAgICAgIHNldDogZnVuY3Rpb24gKG5ld1Byb3BWYWx1ZSkge1xyXG4gICAgICAgIC8vIOWAvOebuOWQjOaXtuS4jeinpuWPkeWPmOabtOOAglxyXG4gICAgICAgIGNvbnN0IG9sZFByb3BWYWx1ZSA9IHRoaXMuZ2V0RmllbGRWYWx1ZShzY2hlbWFGaWVsZCk7XHJcbiAgICAgICAgaWYgKHRoaXMuaXNGaWVsZFZhbHVlQ2hhbmdlZChzY2hlbWFGaWVsZCwgbmV3UHJvcFZhbHVlLCBvbGRQcm9wVmFsdWUpID09PSBmYWxzZSkge1xyXG4gICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLnNldEZpZWxkVmFsdWUoc2NoZW1hRmllbGQsIG5ld1Byb3BWYWx1ZSk7XHJcbiAgICAgICAgdGhpcy5lbWl0RmllbGRWYWx1ZUNoYW5nZShzY2hlbWFGaWVsZCwgbmV3UHJvcFZhbHVlLCBvbGRQcm9wVmFsdWUpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICAgIGNvbnN0IGZpZWxkTWV0YWRhdGEgPSB7XHJcbiAgICAgIC8qKiDlrZfmrrXlkI3np7AgKi9cclxuICAgICAgZGF0YUZpZWxkOiBzY2hlbWFGaWVsZC5sYWJlbCxcclxuICAgICAgLyoqIOWOn+Wni+Wtl+auteWQjeensCAqL1xyXG4gICAgICBvcmlnaW5hbERhdGFGaWVsZDogc2NoZW1hRmllbGQuY29kZSxcclxuICAgICAgLyoqIOWOn+Wni+Wtl+auteexu+WeiyAqL1xyXG4gICAgICBvcmlnaW5hbERhdGFGaWVsZFR5cGU6IHNjaGVtYUZpZWxkLnR5cGUubmFtZSxcclxuICAgICAgLyoqXHJcbiAgICAgICAqIOWOn+Wni+Wtl+autVxyXG4gICAgICAgKiBAZGVzY3JpcHRpb24g5a+55bqU5Yiwc2NoZW1l55qEcGF0aOWxnuaAp1xyXG4gICAgICAgKi9cclxuICAgICAgcGF0aDogc2NoZW1hRmllbGQucGF0aCxcclxuICAgICAgcHJpbWFyeTogc2NoZW1hRmllbGQubGFiZWwgPT09IHByaW1hcnksXHJcbiAgICAgIG5nTWV0YWRhdGFOYW1lOiBOR19GSUVMRFxyXG4gICAgfTtcclxuICAgIGlmIChmaWVsZE1ldGFkYXRhLnByaW1hcnkpIHtcclxuICAgICAgcHJvdG90eXBlT2JqZWN0LmlubmVyUHJpbWFyeVByb3BlcnR5ID0gZmllbGRNZXRhZGF0YTtcclxuICAgIH1cclxuICAgIGlmICghcGFyZW50RW50aXR5VHlwZS5fX3Byb3BfX21ldGFkYXRhX19bcHJvcGVydHlOYW1lXSkge1xyXG4gICAgICBwYXJlbnRFbnRpdHlUeXBlLl9fcHJvcF9fbWV0YWRhdGFfX1twcm9wZXJ0eU5hbWVdID0gW107XHJcbiAgICB9XHJcbiAgICBwYXJlbnRFbnRpdHlUeXBlLl9fcHJvcF9fbWV0YWRhdGFfX1twcm9wZXJ0eU5hbWVdLnB1c2goZmllbGRNZXRhZGF0YSk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOWQkeWunuS9k+exu+WumuS5ieWkjeadguexu+Wei+Wtl+autVxyXG4gICAqIEBwYXJhbSBwcm90b3R5cGVPYmplY3Qg5a6e5L2T57G75Y6f5Z6L5a+56LGhXHJcbiAgICogQHBhcmFtIHNjaGVtYUZpZWxkIOWtl+auteaPj+i/sFxyXG4gICAqIEBwYXJhbSBwYXJlbnRFbnRpdHlUeXBlIOeItuexu+Wei1xyXG4gICAqL1xyXG4gIHByaXZhdGUgZGVmaW5lQ29tcGxleEZpZWxkVG9Qcm90b3R5cGUocHJvdG90eXBlT2JqZWN0OiBhbnksIHNjaGVtYUZpZWxkOiBTY2hlbWFFbnRpdHlGaWVsZCwgcGFyZW50RW50aXR5VHlwZTogQWJzdHJhY3RFbnRpdHlUeXBlKSB7XHJcbiAgICBjb25zdCBjb21wbGV4RmllbGRUeXBlID0gdGhpcy5jcmVhdGVDbGFzcyhzY2hlbWFGaWVsZC50eXBlKTtcclxuICAgIHBhcmVudEVudGl0eVR5cGUudHlwZXNbc2NoZW1hRmllbGQudHlwZS5uYW1lXSA9IGNvbXBsZXhGaWVsZFR5cGU7XHJcbiAgICBjb25zdCBwcm9wZXJ0eU5hbWUgPSBzY2hlbWFGaWVsZC5sYWJlbDtcclxuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShwcm90b3R5cGVPYmplY3QsIHByb3BlcnR5TmFtZSwge1xyXG4gICAgICBnZXQ6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICBjb25zdCBmaWVsZFZhbHVlID0gdGhpcy5nZXRDb21wbGV4RmllbGRWYWx1ZShzY2hlbWFGaWVsZCk7XHJcbiAgICAgICAgcmV0dXJuIGZpZWxkVmFsdWU7XHJcbiAgICAgIH0sXHJcbiAgICAgIHNldDogZnVuY3Rpb24gKHZhbHVlOiBhbnkpIHtcclxuICAgICAgICB0aGlzLnNldENvbXBsZXhGaWVsZFZhbHVlKHNjaGVtYUZpZWxkLCBjb21wbGV4RmllbGRUeXBlLCB2YWx1ZSk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgY29uc3QgZmllbGRNZXRhZGF0YSA9IHtcclxuICAgICAgLyoqIOaYoOWwhOWtl+autSAqL1xyXG4gICAgICBkYXRhRmllbGQ6IHNjaGVtYUZpZWxkLmxhYmVsLFxyXG4gICAgICAvKiog5Y6f5aeL5a2X5q615ZCN56ewICovXHJcbiAgICAgIG9yaWdpbmFsRGF0YUZpZWxkOiBzY2hlbWFGaWVsZC5jb2RlLFxyXG4gICAgICAvKiog5byV55So5a6e5L2T57G75Z6LICovXHJcbiAgICAgIHR5cGU6IGNvbXBsZXhGaWVsZFR5cGUsXHJcbiAgICAgIC8qKlxyXG4gICAgICAgKiDljp/lp4vlrZfmrrVcclxuICAgICAgICogQGRlc2NyaXB0aW9uIOWvueW6lOWIsHNjaGVtZeeahHBhdGjlsZ7mgKdcclxuICAgICAgICovXHJcbiAgICAgIHBhdGg6IHNjaGVtYUZpZWxkLnBhdGgsXHJcbiAgICAgIG5nTWV0YWRhdGFOYW1lOiBOR19PQkpFQ1RcclxuICAgIH07XHJcbiAgICBpZiAoIXBhcmVudEVudGl0eVR5cGUuX19wcm9wX19tZXRhZGF0YV9fW3Byb3BlcnR5TmFtZV0pIHtcclxuICAgICAgcGFyZW50RW50aXR5VHlwZS5fX3Byb3BfX21ldGFkYXRhX19bcHJvcGVydHlOYW1lXSA9IFtdO1xyXG4gICAgfVxyXG4gICAgcGFyZW50RW50aXR5VHlwZS5fX3Byb3BfX21ldGFkYXRhX19bcHJvcGVydHlOYW1lXS5wdXNoKGZpZWxkTWV0YWRhdGEpO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDlkJHlrp7kvZPnsbvlrprkuYnlrZDlrp7kvZNcclxuICAgKiBAcGFyYW0gcHJvdG90eXBlT2JqZWN0IOWunuS9k+exu+WOn+Wei+WvueixoVxyXG4gICAqIEBwYXJhbSBlbnRpdGllcyDlrp7kvZPmj4/ov7Dpm4blkIhcclxuICAgKiBAcGFyYW0gcGFyZW50RW50aXR5VHlwZSDniLbnsbvlnotcclxuICAgKi9cclxuICBwcml2YXRlIGRlZmluZUVudGl0aWVzVG9Qcm90b3R5cGUocHJvdG90eXBlT2JqZWN0OiBhbnksIGVudGl0aWVzOiBTY2hlbWFFbnRpdHlbXSwgcGFyZW50RW50aXR5VHlwZTogQWJzdHJhY3RFbnRpdHlUeXBlKSB7XHJcbiAgICBpZiAoZW50aXRpZXMgJiYgZW50aXRpZXMubGVuZ3RoKSB7XHJcbiAgICAgIC8vIOmBjeWOhlNjaGVtYeS4reaPj+i/sOeahOWtkOWunuS9k++8jOWcqOWunuS9k+WvueixoeS4iuWumuS5ieWtkOWunuS9k+WIl+ihqFxyXG4gICAgICBlbnRpdGllcy5mb3JFYWNoKHNjaGVtYUVudGl0eSA9PiB7XHJcbiAgICAgICAgY29uc3QgY29tcGxleEZpZWxkVHlwZSA9IHRoaXMuY3JlYXRlQ2xhc3Moc2NoZW1hRW50aXR5LnR5cGUpO1xyXG4gICAgICAgIHBhcmVudEVudGl0eVR5cGUudHlwZXNbc2NoZW1hRW50aXR5LnR5cGUubmFtZV0gPSBjb21wbGV4RmllbGRUeXBlO1xyXG4gICAgICAgIC8vIOaPkOWPluWtkOWunuS9k+WcqOWunuS9k+WvueixoeS4iueahOWxnuaAp+WQjVxyXG4gICAgICAgIGNvbnN0IHByb3BlcnR5TmFtZSA9IHNjaGVtYUVudGl0eS5sYWJlbDtcclxuICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkocHJvdG90eXBlT2JqZWN0LCBwcm9wZXJ0eU5hbWUsIHtcclxuICAgICAgICAgIGdldDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBjb25zdCBmaWVsZFZhbHVlID0gdGhpcy5nZXRFbnRpdGllcyhzY2hlbWFFbnRpdHkpO1xyXG4gICAgICAgICAgICByZXR1cm4gZmllbGRWYWx1ZTtcclxuICAgICAgICAgIH0sXHJcbiAgICAgICAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZTogYW55KSB7XHJcbiAgICAgICAgICAgIHRoaXMuc2V0RW50aXRpZXMoc2NoZW1hRW50aXR5LCB2YWx1ZSk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgY29uc3QgZW50aXRNZXRhZGF0YSA9IHtcclxuICAgICAgICAgIC8qKiDlrZfmrrXlkI3np7AgKi9cclxuICAgICAgICAgIGRhdGFGaWVsZDogc2NoZW1hRW50aXR5LmxhYmVsLFxyXG4gICAgICAgICAgLyoqIOWOn+Wni+Wtl+auteWQjeensCAqL1xyXG4gICAgICAgICAgb3JpZ2luYWxEYXRhRmllbGQ6ICcnLFxyXG4gICAgICAgICAgLyoqIOWunuS9k+exu+WeiyAqL1xyXG4gICAgICAgICAgdHlwZTogY29tcGxleEZpZWxkVHlwZSxcclxuICAgICAgICAgIG5nTWV0YWRhdGFOYW1lOiBOR19MSVNUXHJcbiAgICAgICAgfTtcclxuICAgICAgICBpZiAoIXBhcmVudEVudGl0eVR5cGUuX19wcm9wX19tZXRhZGF0YV9fW3Byb3BlcnR5TmFtZV0pIHtcclxuICAgICAgICAgIHBhcmVudEVudGl0eVR5cGUuX19wcm9wX19tZXRhZGF0YV9fW3Byb3BlcnR5TmFtZV0gPSBbXTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcGFyZW50RW50aXR5VHlwZS5fX3Byb3BfX21ldGFkYXRhX19bcHJvcGVydHlOYW1lXS5wdXNoKGVudGl0TWV0YWRhdGEpO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICB9XHJcbiAgLyoqXHJcbiAgICog5Yib5bu65Yid5aeL5YyW5a6e5L2T5a+56LGh5pa55rOVXHJcbiAgICogQHBhcmFtIHNjaGVtYVR5cGUg5a6e5L2T57G75Z6L5o+P6L+wXHJcbiAgICogQHJldHVybnMg5Yid5aeL5YyW5a6e5L2T5a+56LGh5pa55rOVXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBjcmVhdGVFbnRpdHlJbnN0YW5jZURhdGFJbml0aWFsaXplcihzY2hlbWFUeXBlOiBTY2hlbWFUeXBlKSB7XHJcbiAgICAvKipcclxuICAgICAqIOWunuS9k+WIneWni+WMluWHveaVsO+8jOeUqOadpeWIneWni+WMluWunuS9k+eahOWkjeadguexu+Wei+aVsOaNruWSjOWtkOWunuS9k+aVsOaNrlxyXG4gICAgICogQHBhcmFtIGVudGl0eUluc3RhbmNlIOWunuS9k+exu+Wei+WunuS+i1xyXG4gICAgICogQHBhcmFtIGRhdGEg5a6e5L2T5Y6f5aeL5pWw5o2uXHJcbiAgICAgKiBAcGFyYW0gZW50aXR5VHlwZUNvbnN0cnVjdG9yIOWunuS9k+exu+Wei+aehOmAoOWHveaVsFxyXG4gICAgICovXHJcbiAgICBjb25zdCBpbml0aWFsaXplciA9IChlbnRpdHlJbnN0YW5jZTogYW55LCBlbnRpdHlEYXRhOiBhbnksIGVudGl0eVR5cGVDb25zdHJ1Y3RvcjogYW55KSA9PiB7XHJcbiAgICAgIC8vIOWIneWni+WMluWkjeadguexu+Wei+Wtl+autVxyXG4gICAgICBzY2hlbWFUeXBlLmZpZWxkc1xyXG4gICAgICAgIC8vIOi/h+a7pOWkjeadguexu+Wei+Wtl+autVxyXG4gICAgICAgIC5maWx0ZXIoZmllbGQgPT4gZmllbGQuJHR5cGUgPT09IFNjaGVtYUVudGl0eUZpZWxkJFR5cGUuQ29tcGxleEZpZWxkKVxyXG4gICAgICAgIC8vIOmBjeWOhuWkjeadguexu+Wei+Wtl+auteWIm+W7uuWvueW6lOWunuS9k+exu+Wei+aVsOaNrlxyXG4gICAgICAgIC5mb3JFYWNoKGZpZWxkID0+IHtcclxuICAgICAgICAgIC8vIOaPkOWPluWtl+auteWQjVxyXG4gICAgICAgICAgY29uc3QgZmllbGROYW1lID0gZmllbGQubGFiZWw7XHJcbiAgICAgICAgICAvLyDmj5Dlj5blrp7kvZPnsbvlnovkuIvnmoTmiYDmnInlrZDlrp7kvZPnsbvlnotcclxuICAgICAgICAgIGNvbnN0IGluY2x1ZGVkRW50aXR5VHlwZXMgPSBlbnRpdHlUeXBlQ29uc3RydWN0b3IudHlwZXM7XHJcbiAgICAgICAgICAvLyDojrflj5blpI3mnYLnsbvlnovlrZfmrrXlr7nlupTnmoTlrp7kvZPnsbvlnotcclxuICAgICAgICAgIGNvbnN0IENvbXBsZXhGaWVsZCA9IGluY2x1ZGVkRW50aXR5VHlwZXNbZmllbGQudHlwZS5uYW1lXTtcclxuICAgICAgICAgIC8vIOaPkOWPluWkjeadguexu+Wei+Wtl+auteWOn+Wni+aVsOaNrlxyXG4gICAgICAgICAgY29uc3QgZmllbGREYXRhID0gZW50aXR5RGF0YSA/IGVudGl0eURhdGFbZmllbGROYW1lXSA6IG51bGw7XHJcbiAgICAgICAgICAvLyDliJvlu7rlpI3mnYLnsbvlnovlrZfmrrXlr7nosaHot6/lvoRcclxuICAgICAgICAgIGNvbnN0IHBhdGggPSBlbnRpdHlJbnN0YW5jZS5jcmVhdGVQYXRoKGZpZWxkTmFtZSk7XHJcbiAgICAgICAgICBsZXQgY29tcGxleEZpZWxkVmFsdWUgPSBlbnRpdHlJbnN0YW5jZVtmaWVsZE5hbWVdO1xyXG4gICAgICAgICAgaWYgKGNvbXBsZXhGaWVsZFZhbHVlIGluc3RhbmNlb2YgQ29tcGxleEZpZWxkKSB7XHJcbiAgICAgICAgICAgIGNvbXBsZXhGaWVsZFZhbHVlLmxvYWQoZmllbGREYXRhKTtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIC8vIOWIm+W7uuWkjeadguexu+Wei+Wtl+auteWunuS9k+WunuS+i1xyXG4gICAgICAgICAgICBjb21wbGV4RmllbGRWYWx1ZSA9IG5ldyBDb21wbGV4RmllbGQoZmllbGREYXRhKTtcclxuICAgICAgICAgICAgY29tcGxleEZpZWxkVmFsdWUuY29uc3RydWN0b3IgPSBDb21wbGV4RmllbGQ7XHJcbiAgICAgICAgICAgIGNvbXBsZXhGaWVsZFZhbHVlW1BBUkVOVF9DTEFTU10gPSBlbnRpdHlUeXBlQ29uc3RydWN0b3I7XHJcbiAgICAgICAgICAgIGNvbXBsZXhGaWVsZFZhbHVlW1BBUkVOVF9QQVRIXSA9IHBhdGg7XHJcbiAgICAgICAgICAgIGNvbXBsZXhGaWVsZFZhbHVlLm9uVmFsdWVDaGFuZ2VkLnN1YnNjcmliZShjaGFuZ2VzID0+IHtcclxuICAgICAgICAgICAgICBpZiAoY2hhbmdlcykge1xyXG4gICAgICAgICAgICAgICAgY2hhbmdlcy5wYXRoID0gKGVudGl0eUluc3RhbmNlW1BBUkVOVF9QQVRIXSB8fCBbXSkuY29uY2F0KGNoYW5nZXMucGF0aCk7XHJcbiAgICAgICAgICAgICAgICBlbnRpdHlJbnN0YW5jZS5zZXRDaGFuZ2VzKGNoYW5nZXMpO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIGVudGl0eUluc3RhbmNlW2ZpZWxkTmFtZV0gPSBjb21wbGV4RmllbGRWYWx1ZTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgLy8g5Yid5aeL5YyW5a2Q5a6e5L2TXHJcbiAgICAgIGlmIChzY2hlbWFUeXBlLmVudGl0aWVzKSB7XHJcbiAgICAgICAgLy8g6YGN5Y6G5a2Q5a6e5L2T5Yib5bu65a+55bqU5a6e5L2T57G75Z6L55qE5pWw5o2uXHJcbiAgICAgICAgc2NoZW1hVHlwZS5lbnRpdGllcy5mb3JFYWNoKHNjaGVtYUVudGl0eSA9PiB7XHJcbiAgICAgICAgICAvLyDmj5Dlj5blrZDlrp7kvZPlkI1cclxuICAgICAgICAgIGNvbnN0IHN1YkVudGl0eU5hbWUgPSBzY2hlbWFFbnRpdHkubGFiZWw7XHJcbiAgICAgICAgICAvLyDmj5Dlj5blrp7kvZPnsbvlnovkuIvnmoTmiYDmnInlrZDlrp7kvZPnsbvlnotcclxuICAgICAgICAgIGNvbnN0IGluY2x1ZGVkRW50aXR5VHlwZXMgPSBlbnRpdHlUeXBlQ29uc3RydWN0b3IudHlwZXM7XHJcbiAgICAgICAgICAvLyDliJvlu7rlrZDlrp7kvZPlr7nosaHot6/lvoRcclxuICAgICAgICAgIGNvbnN0IHBhdGggPSBlbnRpdHlJbnN0YW5jZS5jcmVhdGVQYXRoKHN1YkVudGl0eU5hbWUpO1xyXG4gICAgICAgICAgLy8g5Yib5bu65a2Q5a6e5L2T5a+56LGh6ZuG5ZCIXHJcbiAgICAgICAgICBsZXQgZW50aXR5TGlzdCA9IGVudGl0eUluc3RhbmNlW3N1YkVudGl0eU5hbWVdO1xyXG4gICAgICAgICAgaWYgKCEoZW50aXR5TGlzdCBpbnN0YW5jZW9mIEVudGl0eUxpc3QpKSB7XHJcbiAgICAgICAgICAgIGVudGl0eUxpc3QgPSBuZXcgRW50aXR5TGlzdDxFbnRpdHk+KCk7XHJcbiAgICAgICAgICAgIC8vIOWQkeWtkOWunuS9k+WIl+ihqOazqOWGjOWtkOWunuS9k+WPmOWMluS6i+S7tlxyXG4gICAgICAgICAgICBlbnRpdHlMaXN0Lm9uTGlzdENoYW5nZWQuc3Vic2NyaWJlKHZhbHVlID0+IHtcclxuICAgICAgICAgICAgICBpZiAodmFsdWUpIHtcclxuICAgICAgICAgICAgICAgIGlmIChlbnRpdHlMaXN0W1BBUkVOVF9QQVRIXVswXSAhPT0gdmFsdWUucGF0aFswXSkge1xyXG4gICAgICAgICAgICAgICAgICB2YWx1ZS5wYXRoID0gZW50aXR5TGlzdFtQQVJFTlRfUEFUSF0uY29uY2F0KHZhbHVlLnBhdGgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZW50aXR5SW5zdGFuY2Uuc2V0Q2hhbmdlcyh2YWx1ZSk7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgLy8g5ZCR5a6e5L2T57G75Z6L5a6e5L6L5LiK55u05o6l5a2Y5YKo5a2Q5a6e5L2T5a+56LGh5YiX6KGoXHJcbiAgICAgICAgICAgIGVudGl0eUluc3RhbmNlW3N1YkVudGl0eU5hbWVdID0gZW50aXR5TGlzdDtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGVudGl0eUxpc3RbUEFSRU5UX0NMQVNTXSA9IGVudGl0eVR5cGVDb25zdHJ1Y3RvcjtcclxuICAgICAgICAgIGVudGl0eUxpc3RbUEFSRU5UX1BBVEhdID0gcGF0aDtcclxuICAgICAgICAgIC8vIOaPkOWPluWtkOWunuS9k+exu+Wei+WQjeensFxyXG4gICAgICAgICAgY29uc3Qgc2NoZW1hRW50aXR5VHlwZU5hbWUgPSBzY2hlbWFFbnRpdHkudHlwZS5uYW1lO1xyXG4gICAgICAgICAgLy8g6I635Y+W5a2Q5a6e5L2T57G75Z6LXHJcbiAgICAgICAgICBjb25zdCBDb25jcmV0ZUVudGl0eSA9IGluY2x1ZGVkRW50aXR5VHlwZXNbc2NoZW1hRW50aXR5VHlwZU5hbWVdO1xyXG4gICAgICAgICAgY29uc3Qgb3JpZ2luYWxFbnRpdHlEYXRhQXJyYXkgPSBlbnRpdHlEYXRhID8gZW50aXR5RGF0YVtzdWJFbnRpdHlOYW1lXSA6IG51bGw7XHJcbiAgICAgICAgICAvLyDmnoTpgKDlrZDlrp7kvZPpm4blkIhcclxuICAgICAgICAgIGlmIChvcmlnaW5hbEVudGl0eURhdGFBcnJheSkge1xyXG4gICAgICAgICAgICAvLyDpgY3ljoblrZDlrp7kvZPljp/lp4vmlbDmja7vvIzmnoTpgKDlrp7kvZPlr7nosaHpm4blkIhcclxuICAgICAgICAgICAgY29uc3QgZW50aXRpZXMgPSBvcmlnaW5hbEVudGl0eURhdGFBcnJheS5tYXAoKG9yaWdpbmFsRW50aXR5RGF0YTogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgY29uc3QgY29uY3JldGVFbnRpdHlJbnN0YW5jZSA9IG5ldyBDb25jcmV0ZUVudGl0eShvcmlnaW5hbEVudGl0eURhdGEpO1xyXG4gICAgICAgICAgICAgIGNvbmNyZXRlRW50aXR5SW5zdGFuY2UuY29uc3RydWN0b3IgPSBDb25jcmV0ZUVudGl0eTtcclxuICAgICAgICAgICAgICByZXR1cm4gY29uY3JldGVFbnRpdHlJbnN0YW5jZTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIC8vIOWQkeWtkOWunuS9k+WIl+ihqOS4rea3u+WKoOWtkOWunuS9k+WvueixoVxyXG4gICAgICAgICAgICBlbnRpdHlMaXN0LmxvYWRFbnRpdGllcyhlbnRpdGllcyk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH1cclxuICAgIH07XHJcbiAgICByZXR1cm4gaW5pdGlhbGl6ZXI7XHJcbiAgfVxyXG59XHJcbiJdfQ==