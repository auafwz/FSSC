/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
var LookupDialogManager = /** @class */ (function () {
    function LookupDialogManager(ins) {
        this.ins = ins;
        this.lookupInit = null;
        this._loadDataWhenOpen = true;
        this._navSelectedId = '';
        this._selectFirstInNav = false;
        this.keyDownHandler = null;
    }
    // 帮助窗口关闭后做一些清理工作
    // 帮助窗口关闭后做一些清理工作
    /**
     * @return {?}
     */
    LookupDialogManager.prototype.dialogClosed = 
    // 帮助窗口关闭后做一些清理工作
    /**
     * @return {?}
     */
    function () {
        if (this.ins.displayText !== this.ins.originalText && !this.ins.nosearch) {
            this.ins.displayText = this.ins.originalText;
            this.ins.setModelValue(this.ins.displayText);
        }
        if (this.ins.componentRef) {
            this.ins.componentRef.destroy();
            this.ins.componentRef = null;
        }
        if (this.ins.favoritesComponentRef) {
            this.ins.favoritesComponentRef.destroy();
            this.ins.favoritesComponentRef = null;
        }
        if (this.ins.contentContainer) {
            this.ins.contentContainer.clear();
        }
        if (this.ins.centerContainer) {
            this.ins.centerContainer.clear();
        }
        if (this.ins.leftComponentRef) {
            this.ins.leftComponentRef.destroy();
            this.ins.leftComponentRef = null;
        }
        if (this.ins.leftContainer) {
            this.ins.leftContainer.clear();
        }
        this.ins.isShow = false;
        this.ins.isTextChange = false;
        if (this.ins.dialog) {
            this.ins.content = null;
        }
        this.ins.navigationFilter = null;
        this.ins.lookupUtils.pendingEnd();
        if (this.ins.helpId) {
            this.ins.displayType = '';
        }
        if (this.lookupInit) {
            this.lookupInit.unsubscribe();
            this.lookupInit = null;
        }
        // this.ins.items = [];
        this.ins.favoriteItems = [];
        this.ins.isTabChanged = false;
        if (this.ins.uri) {
            this.ins.items = [];
        }
        this.ins._searchState = null;
        this.ins.pageIndex = 1;
        this.ins.loadDataWhenOpen = this._loadDataWhenOpen;
        this.ins.navSelectedIds = this._navSelectedId;
        this.ins.selectFirstInNav = this._selectFirstInNav;
        this.ins.isGetAllChidlNodes = false;
        this.ins.enableGetAllChildNodes = true;
        // 保存个性化数据
        if (this.ins.usePersionalConf && this.ins.favoriteDataFrom !== 'locale') {
            this.ins.httpMgr.submitFavoriteData('dialog closed event.');
        }
        if (this.keyDownHandler) {
            this.keyDownHandler();
            this.keyDownHandler = null;
        }
        if (this.ins.inputGroup) {
            this.ins.inputGroup.focus();
        }
        this.ins.dialogClosed.emit();
    };
    /**
     * @return {?}
     */
    LookupDialogManager.prototype.onDialogCreated = /**
     * @return {?}
     */
    function () {
        var _this = this;
        this._loadDataWhenOpen = this.ins.loadDataWhenOpen;
        this._navSelectedId = this.ins.navSelectedIds;
        this._selectFirstInNav = this.ins.selectFirstInNav;
        this.ins.dialogCreatedSubscription = this.ins.dialogCreated.subscribe((/**
         * @param {?} dlg
         * @return {?}
         */
        function (dlg) {
            if (dlg) {
                if (_this.ins.dialogOpenedSubscription) {
                    _this.ins.dialogOpenedSubscription.unsubscribe();
                }
                if (_this.ins.dialogClosedSubscription) {
                    _this.ins.dialogClosedSubscription.unsubscribe();
                }
                _this.registerDialogEvent();
                if (_this.ins.isRecordSize) {
                    /** @type {?} */
                    var dlgSize = _this.ins.personalConfigService.getDialogSize();
                    if (dlgSize) {
                        var width = dlgSize.width, height = dlgSize.height;
                        _this.ins.dialogWidth = width ? width : _this.ins.dialogWidth;
                        _this.ins.dialogHeight = height ? height : _this.ins.dialogHeight;
                        // 20200908 更新现窗口的尺寸 by Lucas
                        dlg.width = _this.ins.dialogWidth;
                        dlg.height = _this.ins.dialogHeight;
                    }
                }
                dlg.show();
            }
        }));
    };
    /**
     * @param {?} pr
     * @return {?}
     */
    LookupDialogManager.prototype.canOpenDialog = /**
     * @param {?} pr
     * @return {?}
     */
    function (pr) {
        /** @type {?} */
        var o = true;
        if (pr === undefined || pr === null || pr === '') {
            o = true;
        }
        if (typeof pr === 'boolean') {
            o = pr;
        }
        if (typeof pr === 'object') {
            if (pr.showDialog === undefined) {
                o = true;
            }
            else {
                o = pr.showDialog;
            }
            if (pr.hasOwnProperty('data')) {
                /** 保存帮助前传递的数据 */
                this.ins.customData = pr.data;
            }
            this.ins.selectedIds = pr.selectedIds || null;
            if (pr.message) {
                this.ins.notifyService.warning(pr.message);
            }
        }
        this.ins.isReady = false;
        this.ins.isShow = o;
    };
    /**
     * @return {?}
     */
    LookupDialogManager.prototype.getHeight = /**
     * @return {?}
     */
    function () {
        return this.ins.dialog.size.contentHeight -
            this.ins.containerMargin.bottom -
            this.ins.containerMargin.top -
            (this.ins.useFavorite ? 40 : 0);
    };
    /**
     * @private
     * @return {?}
     */
    LookupDialogManager.prototype.getMainGridSize = /**
     * @private
     * @return {?}
     */
    function () {
        if (this.ins.isDoublleList()) {
            return {
                width: this.ins.dialog.size.width - this.ins.leftPanel.width - 27,
                height: this.getHeight()
            };
        }
        return {
            width: this.ins.dialog.size.width - this.ins.containerMargin.left - this.ins.containerMargin.right,
            height: this.getHeight()
        };
    };
    /** 注册弹出窗口的事件 */
    /**
     * 注册弹出窗口的事件
     * @private
     * @return {?}
     */
    LookupDialogManager.prototype.registerDialogEvent = /**
     * 注册弹出窗口的事件
     * @private
     * @return {?}
     */
    function () {
        var _this = this;
        this.ins.dialogOpenedSubscription = this.ins.dialog.opened.subscribe((/**
         * @return {?}
         */
        function () {
            _this.ins.gridOptions = Object.assign(_this.ins.gridOptions, _this.getMainGridSize());
            _this.ins.dialog.el.nativeElement.querySelector('.ps-content').style.height = '100%';
            if (_this.ins.displayType && _this.ins.customDisplayType) {
                _this.ins.componentRef = _this.ins.lookupCmpMgr.createContent(_this.ins.gridOptions);
                _this.ins.lookupCmpMgr.createFavoriteComponent();
            }
            _this.ins.initData();
            // 修改帮助窗口的状态
            _this.ins.lookupUtils.pendingEnd();
            _this.ins.dialogOpened.emit();
        }));
        this.ins.subscriptions.push(this.ins.dialogOpenedSubscription);
        this.lookupInit = this.ins.lookupinitializationSubject.subscribe((/**
         * @return {?}
         */
        function () {
            _this.ins.loadDataWhenOpen = true;
            // 注册快捷键
            _this.registerShortcutKey();
            // 监听左侧尺寸变化事件
            if (_this.ins.leftPanel) {
                /** @type {?} */
                var leftPanelResize$ = _this.ins.leftPanel.resizing.subscribe((/**
                 * @param {?} s
                 * @return {?}
                 */
                function (s) {
                    _this.ins.componentRef.instance.resize({
                        width: _this.ins.dialog.size.width - s.size.width - 27,
                        height: _this.getHeight()
                    });
                    _this.ins.leftComponentRef.instance.resize(s.size);
                }));
                _this.ins.subscriptions.push(leftPanelResize$);
            }
        }));
        this.ins.dialogClosedSubscription = this.ins.dialog.closed.subscribe((/**
         * @return {?}
         */
        function () {
            // 输入框变化后，弹出窗口未选择数据关闭窗口时，还原原始值
            _this.ins.dialogMgr.dialogClosed();
        }));
        this.ins.subscriptions.push(this.ins.dialogClosedSubscription);
    };
    /**
     * @private
     * @return {?}
     */
    LookupDialogManager.prototype.registerShortcutKey = /**
     * @private
     * @return {?}
     */
    function () {
        var _this = this;
        // 回车，与确定按钮处理逻辑一至。
        /** @type {?} */
        var dlgContainerDom = this.ins.dialog.el.nativeElement.querySelector('.farris-modal');
        if (dlgContainerDom && this.ins.shortcutKey && !this.keyDownHandler) {
            this.keyDownHandler = this.ins.eventManager.addEventListener(dlgContainerDom, 'keydown', (/**
             * @param {?} e
             * @return {?}
             */
            function (e) {
                e.stopPropagation();
                var _a = _this.ins.shortcutKey, moveUp = _a.moveUp, moveDown = _a.moveDown, searchFocus = _a.searchFocus, confirm = _a.confirm, nextPager = _a.nextPager, prevPager = _a.prevPager, expand = _a.expand, collapse = _a.collapse;
                /** @type {?} */
                var arrowKey = [moveUp, moveDown, expand, collapse];
                if (arrowKey.includes(e.code)) {
                    _this.ins.componentRef.instance.onKeydownEvent(e);
                }
                else if (e.key === confirm) {
                    if (e.target['nodeName'] === 'INPUT' && !e.ctrlKey) {
                        return;
                    }
                    _this.ins.okButton.nativeElement.click();
                }
                else if (e.code === searchFocus) { // 帮助窗口查询输入框焦点
                    e.preventDefault();
                    _this.ins.componentRef.instance.inputGroup.focus();
                }
                else if (!_this.ins.isTree() && (e.code === nextPager || e.code === prevPager)) { // 分页
                    // 分页
                    /** @type {?} */
                    var isNextPager = e.code === nextPager;
                    _this.paginationKeyDownHandler(isNextPager);
                }
            }));
        }
    };
    /**
     * @private
     * @param {?=} next
     * @return {?}
     */
    LookupDialogManager.prototype.paginationKeyDownHandler = /**
     * @private
     * @param {?=} next
     * @return {?}
     */
    function (next) {
        if (next === void 0) { next = true; }
        /** @type {?} */
        var datatableRef = this.ins.componentRef.instance;
        var pageIndex = datatableRef.pageIndex, pageSize = datatableRef.pageSize, total = datatableRef.total;
        /** @type {?} */
        var pagerCount = Math.ceil(total / pageSize);
        /** @type {?} */
        var newPageNum = pageIndex;
        if (next) {
            newPageNum = newPageNum + 1;
        }
        else {
            newPageNum = newPageNum - 1;
        }
        if (newPageNum > pagerCount || newPageNum < 1) {
            newPageNum = pageIndex;
        }
        this.ins.componentRef.instance.onPageChange({ pageSize: pageSize, pageIndex: newPageNum });
    };
    return LookupDialogManager;
}());
export { LookupDialogManager };
if (false) {
    /**
     * @type {?}
     * @private
     */
    LookupDialogManager.prototype.lookupInit;
    /**
     * @type {?}
     * @private
     */
    LookupDialogManager.prototype._loadDataWhenOpen;
    /**
     * @type {?}
     * @private
     */
    LookupDialogManager.prototype._navSelectedId;
    /**
     * @type {?}
     * @private
     */
    LookupDialogManager.prototype._selectFirstInNav;
    /**
     * @type {?}
     * @private
     */
    LookupDialogManager.prototype.keyDownHandler;
    /**
     * @type {?}
     * @private
     */
    LookupDialogManager.prototype.ins;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGlhbG9nLW1hbmdhZ2VyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy91aS1sb29rdXAvIiwic291cmNlcyI6WyJsaWIvc2VydmljZXMvZGlhbG9nLW1hbmdhZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFJQTtJQVNJLDZCQUFvQixHQUF3QjtRQUF4QixRQUFHLEdBQUgsR0FBRyxDQUFxQjtRQVBwQyxlQUFVLEdBQWlCLElBQUksQ0FBQztRQUNoQyxzQkFBaUIsR0FBRyxJQUFJLENBQUM7UUFDekIsbUJBQWMsR0FBRyxFQUFFLENBQUM7UUFDcEIsc0JBQWlCLEdBQUcsS0FBSyxDQUFDO1FBRTFCLG1CQUFjLEdBQUcsSUFBSSxDQUFDO0lBRWtCLENBQUM7SUFDakQsaUJBQWlCOzs7OztJQUNqQiwwQ0FBWTs7Ozs7SUFBWjtRQUNJLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxXQUFXLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxZQUFZLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRTtZQUN0RSxJQUFJLENBQUMsR0FBRyxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQztZQUM3QyxJQUFJLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1NBQ2hEO1FBRUQsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLFlBQVksRUFBRTtZQUN2QixJQUFJLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUNoQyxJQUFJLENBQUMsR0FBRyxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUM7U0FDaEM7UUFFRCxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMscUJBQXFCLEVBQUU7WUFDaEMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxxQkFBcUIsQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUN6QyxJQUFJLENBQUMsR0FBRyxDQUFD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QUFJLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLEVBQUUsUUFBUSxVQUFBLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBRSxDQUFDLENBQUM7SUFDckYsQ0FBQztJQUVMLDBCQUFDO0FBQUQsQ0FBQyxBQXJSRCxJQXFSQzs7Ozs7OztJQW5SRyx5Q0FBd0M7Ozs7O0lBQ3hDLGdEQUFpQzs7Ozs7SUFDakMsNkNBQTRCOzs7OztJQUM1QixnREFBa0M7Ozs7O0lBRWxDLDZDQUE4Qjs7Ozs7SUFFbEIsa0NBQWdDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IFBpY2tpbmdSZXN1bHQgfSBmcm9tICcuLi9sb29rdXAtZ3JpZC1vcHRpb25zJztcclxuaW1wb3J0IHsgTG9va3VwR3JpZENvbXBvbmVudCB9IGZyb20gJy4uL2xvb2t1cC1ncmlkLmNvbXBvbmVudCc7XHJcblxyXG5leHBvcnQgY2xhc3MgTG9va3VwRGlhbG9nTWFuYWdlciB7XHJcblxyXG4gICAgcHJpdmF0ZSBsb29rdXBJbml0OiBTdWJzY3JpcHRpb24gPSBudWxsO1xyXG4gICAgcHJpdmF0ZSBfbG9hZERhdGFXaGVuT3BlbiA9IHRydWU7XHJcbiAgICBwcml2YXRlIF9uYXZTZWxlY3RlZElkID0gJyc7XHJcbiAgICBwcml2YXRlIF9zZWxlY3RGaXJzdEluTmF2ID0gZmFsc2U7XHJcblxyXG4gICAgcHJpdmF0ZSBrZXlEb3duSGFuZGxlciA9IG51bGw7XHJcblxyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBpbnM6IExvb2t1cEdyaWRDb21wb25lbnQpIHsgfVxyXG4gICAgLy8g5biu5Yqp56qX5Y+j5YWz6Zet5ZCO5YGa5LiA5Lqb5riF55CG5bel5L2cXHJcbiAgICBkaWFsb2dDbG9zZWQoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuaW5zLmRpc3BsYXlUZXh0ICE9PSB0aGlzLmlucy5vcmlnaW5hbFRleHQgJiYgIXRoaXMuaW5zLm5vc2VhcmNoKSB7XHJcbiAgICAgICAgICAgIHRoaXMuaW5zLmRpc3BsYXlUZXh0ID0gdGhpcy5pbnMub3JpZ2luYWxUZXh0O1xyXG4gICAgICAgICAgICB0aGlzLmlucy5zZXRNb2RlbFZhbHVlKHRoaXMuaW5zLmRpc3BsYXlUZXh0KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmlucy5jb21wb25lbnRSZWYpIHtcclxuICAgICAgICAgICAgdGhpcy5pbnMuY29tcG9uZW50UmVmLmRlc3Ryb3koKTtcclxuICAgICAgICAgICAgdGhpcy5pbnMuY29tcG9uZW50UmVmID0gbnVsbDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmlucy5mYXZvcml0ZXNDb21wb25lbnRSZWYpIHtcclxuICAgICAgICAgICAgdGhpcy5pbnMuZmF2b3JpdGVzQ29tcG9uZW50UmVmLmRlc3Ryb3koKTtcclxuICAgICAgICAgICAgdGhpcy5pbnMuZmF2b3JpdGVzQ29tcG9uZW50UmVmID0gbnVsbDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmlucy5jb250ZW50Q29udGFpbmVyKSB7XHJcbiAgICAgICAgICAgIHRoaXMuaW5zLmNvbnRlbnRDb250YWluZXIuY2xlYXIoKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmlucy5jZW50ZXJDb250YWluZXIpIHtcclxuICAgICAgICAgICAgdGhpcy5pbnMuY2VudGVyQ29udGFpbmVyLmNsZWFyKCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodGhpcy5pbnMubGVmdENvbXBvbmVudFJlZikge1xyXG4gICAgICAgICAgICB0aGlzLmlucy5sZWZ0Q29tcG9uZW50UmVmLmRlc3Ryb3koKTtcclxuICAgICAgICAgICAgdGhpcy5pbnMubGVmdENvbXBvbmVudFJlZiA9IG51bGw7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodGhpcy5pbnMubGVmdENvbnRhaW5lcikge1xyXG4gICAgICAgICAgICB0aGlzLmlucy5sZWZ0Q29udGFpbmVyLmNsZWFyKCk7XHJcbiAgICAgICAgfVxyXG5cclxuXHJcbiAgICAgICAgdGhpcy5pbnMuaXNTaG93ID0gZmFsc2U7XHJcbiAgICAgICAgdGhpcy5pbnMuaXNUZXh0Q2hhbmdlID0gZmFsc2U7XHJcbiAgICAgICAgaWYgKHRoaXMuaW5zLmRpYWxvZykge1xyXG4gICAgICAgICAgICB0aGlzLmlucy5jb250ZW50ID0gbnVsbDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuaW5zLm5hdmlnYXRpb25GaWx0ZXIgPSBudWxsO1xyXG5cclxuICAgICAgICB0aGlzLmlucy5sb29rdXBVdGlscy5wZW5kaW5nRW5kKCk7XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmlucy5oZWxwSWQpIHtcclxuICAgICAgICAgICAgdGhpcy5pbnMuZGlzcGxheVR5cGUgPSAnJztcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmxvb2t1cEluaXQpIHtcclxuICAgICAgICAgICAgdGhpcy5sb29rdXBJbml0LnVuc3Vic2NyaWJlKCk7XHJcbiAgICAgICAgICAgIHRoaXMubG9va3VwSW5pdCA9IG51bGw7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyB0aGlzLmlucy5pdGVtcyA9IFtdO1xyXG4gICAgICAgIHRoaXMuaW5zLmZhdm9yaXRlSXRlbXMgPSBbXTtcclxuICAgICAgICB0aGlzLmlucy5pc1RhYkNoYW5nZWQgPSBmYWxzZTtcclxuXHJcbiAgICAgICAgaWYgKHRoaXMuaW5zLnVyaSkge1xyXG4gICAgICAgICAgICB0aGlzLmlucy5pdGVtcyA9IFtdO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmlucy5fc2VhcmNoU3RhdGUgPSBudWxsO1xyXG5cclxuXHJcbiAgICAgICAgdGhpcy5pbnMucGFnZUluZGV4ID0gMTtcclxuXHJcbiAgICAgICAgdGhpcy5pbnMubG9hZERhdGFXaGVuT3BlbiA9IHRoaXMuX2xvYWREYXRhV2hlbk9wZW47XHJcbiAgICAgICAgdGhpcy5pbnMubmF2U2VsZWN0ZWRJZHMgPSB0aGlzLl9uYXZTZWxlY3RlZElkO1xyXG4gICAgICAgIHRoaXMuaW5zLnNlbGVjdEZpcnN0SW5OYXYgPSB0aGlzLl9zZWxlY3RGaXJzdEluTmF2O1xyXG5cclxuICAgICAgICB0aGlzLmlucy5pc0dldEFsbENoaWRsTm9kZXMgPSBmYWxzZTtcclxuXHJcbiAgICAgICAgdGhpcy5pbnMuZW5hYmxlR2V0QWxsQ2hpbGROb2RlcyA9IHRydWU7XHJcblxyXG4gICAgICAgIC8vIOS/neWtmOS4quaAp+WMluaVsOaNrlxyXG4gICAgICAgIGlmICh0aGlzLmlucy51c2VQZXJzaW9uYWxDb25mICYmIHRoaXMuaW5zLmZhdm9yaXRlRGF0YUZyb20gIT09ICdsb2NhbGUnKSB7XHJcbiAgICAgICAgICAgIHRoaXMuaW5zLmh0dHBNZ3Iuc3VibWl0RmF2b3JpdGVEYXRhKCdkaWFsb2cgY2xvc2VkIGV2ZW50LicpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHRoaXMua2V5RG93bkhhbmRsZXIpIHtcclxuICAgICAgICAgICAgdGhpcy5rZXlEb3duSGFuZGxlcigpO1xyXG4gICAgICAgICAgICB0aGlzLmtleURvd25IYW5kbGVyID0gbnVsbDtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHRoaXMuaW5zLmlucHV0R3JvdXApIHtcclxuICAgICAgICAgICAgdGhpcy5pbnMuaW5wdXRHcm91cC5mb2N1cygpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmlucy5kaWFsb2dDbG9zZWQuZW1pdCgpO1xyXG4gICAgfVxyXG5cclxuICAgIG9uRGlhbG9nQ3JlYXRlZCgpIHtcclxuICAgICAgICB0aGlzLl9sb2FkRGF0YVdoZW5PcGVuID0gdGhpcy5pbnMubG9hZERhdGFXaGVuT3BlbjtcclxuICAgICAgICB0aGlzLl9uYXZTZWxlY3RlZElkID0gdGhpcy5pbnMubmF2U2VsZWN0ZWRJZHM7XHJcbiAgICAgICAgdGhpcy5fc2VsZWN0Rmlyc3RJbk5hdiA9IHRoaXMuaW5zLnNlbGVjdEZpcnN0SW5OYXY7XHJcblxyXG4gICAgICAgIHRoaXMuaW5zLmRpYWxvZ0NyZWF0ZWRTdWJzY3JpcHRpb24gPSB0aGlzLmlucy5kaWFsb2dDcmVhdGVkLnN1YnNjcmliZShkbGcgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZGxnKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5pbnMuZGlhbG9nT3BlbmVkU3Vic2NyaXB0aW9uKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnMuZGlhbG9nT3BlbmVkU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5pbnMuZGlhbG9nQ2xvc2VkU3Vic2NyaXB0aW9uKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnMuZGlhbG9nQ2xvc2VkU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlZ2lzdGVyRGlhbG9nRXZlbnQoKTtcclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLmlucy5pc1JlY29yZFNpemUpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBkbGdTaXplID0gdGhpcy5pbnMucGVyc29uYWxDb25maWdTZXJ2aWNlLmdldERpYWxvZ1NpemUoKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZGxnU2l6ZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB7IHdpZHRoLCBoZWlnaHQgfSA9IGRsZ1NpemU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaW5zLmRpYWxvZ1dpZHRoID0gd2lkdGggPyB3aWR0aCA6IHRoaXMuaW5zLmRpYWxvZ1dpZHRoO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmlucy5kaWFsb2dIZWlnaHQgPSBoZWlnaHQgPyBoZWlnaHQgOiB0aGlzLmlucy5kaWFsb2dIZWlnaHQ7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIDIwMjAwOTA4IOabtOaWsOeOsOeql+WPo+eahOWwuuWvuCBieSBMdWNhc1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkbGcud2lkdGggPSB0aGlzLmlucy5kaWFsb2dXaWR0aDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZGxnLmhlaWdodCA9IHRoaXMuaW5zLmRpYWxvZ0hlaWdodDtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBkbGcuc2hvdygpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgY2FuT3BlbkRpYWxvZyhwcjogUGlja2luZ1Jlc3VsdCB8IGFueSkge1xyXG4gICAgICAgIGxldCBvID0gdHJ1ZTtcclxuICAgICAgICBpZiAocHIgPT09IHVuZGVmaW5lZCB8fCBwciA9PT0gbnVsbCB8fCBwciA9PT0gJycpIHtcclxuICAgICAgICAgICAgbyA9IHRydWU7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodHlwZW9mIHByID09PSAnYm9vbGVhbicpIHtcclxuICAgICAgICAgICAgbyA9IHByO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHR5cGVvZiBwciA9PT0gJ29iamVjdCcpIHtcclxuICAgICAgICAgICAgaWYgKHByLnNob3dEaWFsb2cgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgbyA9IHRydWU7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBvID0gcHIuc2hvd0RpYWxvZztcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKHByLmhhc093blByb3BlcnR5KCdkYXRhJykpIHtcclxuICAgICAgICAgICAgICAgIC8qKiDkv53lrZjluK7liqnliY3kvKDpgJLnmoTmlbDmja4gKi9cclxuICAgICAgICAgICAgICAgIHRoaXMuaW5zLmN1c3RvbURhdGEgPSBwci5kYXRhO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMuaW5zLnNlbGVjdGVkSWRzID0gcHIuc2VsZWN0ZWRJZHMgfHwgbnVsbDtcclxuXHJcbiAgICAgICAgICAgIGlmIChwci5tZXNzYWdlKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmlucy5ub3RpZnlTZXJ2aWNlLndhcm5pbmcocHIubWVzc2FnZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG5cclxuICAgICAgICB0aGlzLmlucy5pc1JlYWR5ID0gZmFsc2U7XHJcblxyXG4gICAgICAgIHRoaXMuaW5zLmlzU2hvdyA9IG87XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0SGVpZ2h0KCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmlucy5kaWFsb2cuc2l6ZS5jb250ZW50SGVpZ2h0IC1cclxuICAgICAgICAgICAgICAgIHRoaXMuaW5zLmNvbnRhaW5lck1hcmdpbi5ib3R0b20gLVxyXG4gICAgICAgICAgICAgICAgdGhpcy5pbnMuY29udGFpbmVyTWFyZ2luLnRvcCAtXHJcbiAgICAgICAgICAgICAgICAodGhpcy5pbnMudXNlRmF2b3JpdGUgPyA0MCA6IDApO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICBwcml2YXRlIGdldE1haW5HcmlkU2l6ZSgpIHtcclxuICAgICAgICBpZiAodGhpcy5pbnMuaXNEb3VibGxlTGlzdCgpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICB3aWR0aDogdGhpcy5pbnMuZGlhbG9nLnNpemUud2lkdGggLSB0aGlzLmlucy5sZWZ0UGFuZWwud2lkdGggLSAyNyxcclxuICAgICAgICAgICAgICAgIGhlaWdodDogdGhpcy5nZXRIZWlnaHQoKVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgd2lkdGg6IHRoaXMuaW5zLmRpYWxvZy5zaXplLndpZHRoIC0gdGhpcy5pbnMuY29udGFpbmVyTWFyZ2luLmxlZnQgLSB0aGlzLmlucy5jb250YWluZXJNYXJnaW4ucmlnaHQsXHJcbiAgICAgICAgICAgIGhlaWdodDogdGhpcy5nZXRIZWlnaHQoKVxyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgLyoqIOazqOWGjOW8ueWHuueql+WPo+eahOS6i+S7tiAqL1xyXG4gICAgcHJpdmF0ZSByZWdpc3RlckRpYWxvZ0V2ZW50KCkge1xyXG4gICAgICAgIHRoaXMuaW5zLmRpYWxvZ09wZW5lZFN1YnNjcmlwdGlvbiA9IHRoaXMuaW5zLmRpYWxvZy5vcGVuZWQuc3Vic2NyaWJlKCgpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5pbnMuZ3JpZE9wdGlvbnMgPSBPYmplY3QuYXNzaWduKHRoaXMuaW5zLmdyaWRPcHRpb25zLCB0aGlzLmdldE1haW5HcmlkU2l6ZSgpKTtcclxuICAgICAgICAgICAgdGhpcy5pbnMuZGlhbG9nLmVsLm5hdGl2ZUVsZW1lbnQucXVlcnlTZWxlY3RvcignLnBzLWNvbnRlbnQnKS5zdHlsZS5oZWlnaHQgPSAnMTAwJSc7XHJcblxyXG4gICAgICAgICAgICBpZiAodGhpcy5pbnMuZGlzcGxheVR5cGUgJiYgdGhpcy5pbnMuY3VzdG9tRGlzcGxheVR5cGUpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuaW5zLmNvbXBvbmVudFJlZiA9IHRoaXMuaW5zLmxvb2t1cENtcE1nci5jcmVhdGVDb250ZW50KHRoaXMuaW5zLmdyaWRPcHRpb25zKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuaW5zLmxvb2t1cENtcE1nci5jcmVhdGVGYXZvcml0ZUNvbXBvbmVudCgpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB0aGlzLmlucy5pbml0RGF0YSgpO1xyXG5cclxuICAgICAgICAgICAgLy8g5L+u5pS55biu5Yqp56qX5Y+j55qE54q25oCBXHJcbiAgICAgICAgICAgIHRoaXMuaW5zLmxvb2t1cFV0aWxzLnBlbmRpbmdFbmQoKTtcclxuICAgICAgICAgICAgdGhpcy5pbnMuZGlhbG9nT3BlbmVkLmVtaXQoKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgdGhpcy5pbnMuc3Vic2NyaXB0aW9ucy5wdXNoKHRoaXMuaW5zLmRpYWxvZ09wZW5lZFN1YnNjcmlwdGlvbik7XHJcblxyXG4gICAgICAgIHRoaXMubG9va3VwSW5pdCA9IHRoaXMuaW5zLmxvb2t1cGluaXRpYWxpemF0aW9uU3ViamVjdC5zdWJzY3JpYmUoKCkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLmlucy5sb2FkRGF0YVdoZW5PcGVuID0gdHJ1ZTtcclxuICAgICAgICAgICAgLy8g5rOo5YaM5b+r5o236ZSuXHJcbiAgICAgICAgICAgIHRoaXMucmVnaXN0ZXJTaG9ydGN1dEtleSgpO1xyXG4gICAgICAgICAgICAvLyDnm5HlkKzlt6bkvqflsLrlr7jlj5jljJbkuovku7ZcclxuICAgICAgICAgICAgaWYgKHRoaXMuaW5zLmxlZnRQYW5lbCkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgbGVmdFBhbmVsUmVzaXplJCA9IHRoaXMuaW5zLmxlZnRQYW5lbC5yZXNpemluZy5zdWJzY3JpYmUoKHM6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaW5zLmNvbXBvbmVudFJlZi5pbnN0YW5jZS5yZXNpemUoe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB3aWR0aDogdGhpcy5pbnMuZGlhbG9nLnNpemUud2lkdGggLSBzLnNpemUud2lkdGggLSAyNyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiB0aGlzLmdldEhlaWdodCgpXHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnMubGVmdENvbXBvbmVudFJlZi5pbnN0YW5jZS5yZXNpemUocy5zaXplKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgIHRoaXMuaW5zLnN1YnNjcmlwdGlvbnMucHVzaChsZWZ0UGFuZWxSZXNpemUkKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICB0aGlzLmlucy5kaWFsb2dDbG9zZWRTdWJzY3JpcHRpb24gPSB0aGlzLmlucy5kaWFsb2cuY2xvc2VkLnN1YnNjcmliZSgoKSA9PiB7XHJcbiAgICAgICAgICAgIC8vIOi+k+WFpeahhuWPmOWMluWQju+8jOW8ueWHuueql+WPo+acqumAieaLqeaVsOaNruWFs+mXreeql+WPo+aXtu+8jOi/mOWOn+WOn+Wni+WAvFxyXG4gICAgICAgICAgICB0aGlzLmlucy5kaWFsb2dNZ3IuZGlhbG9nQ2xvc2VkKCk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHRoaXMuaW5zLnN1YnNjcmlwdGlvbnMucHVzaCh0aGlzLmlucy5kaWFsb2dDbG9zZWRTdWJzY3JpcHRpb24pO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgcmVnaXN0ZXJTaG9ydGN1dEtleSgpIHtcclxuICAgICAgICAvLyDlm57ovabvvIzkuI7noa7lrprmjInpkq7lpITnkIbpgLvovpHkuIDoh7PjgIJcclxuICAgICAgICBjb25zdCBkbGdDb250YWluZXJEb20gPSB0aGlzLmlucy5kaWFsb2cuZWwubmF0aXZlRWxlbWVudC5xdWVyeVNlbGVjdG9yKCcuZmFycmlzLW1vZGFsJyk7XHJcblxyXG4gICAgICAgIGlmIChkbGdDb250YWluZXJEb20gJiYgdGhpcy5pbnMuc2hvcnRjdXRLZXkgJiYgIXRoaXMua2V5RG93bkhhbmRsZXIpIHtcclxuICAgICAgICAgICAgdGhpcy5rZXlEb3duSGFuZGxlciA9IHRoaXMuaW5zLmV2ZW50TWFuYWdlci5hZGRFdmVudExpc3RlbmVyKGRsZ0NvbnRhaW5lckRvbSwgJ2tleWRvd24nLCAoZTogS2V5Ym9hcmRFdmVudCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHsgbW92ZVVwLCBtb3ZlRG93biwgc2VhcmNoRm9jdXMsIGNvbmZpcm0sIG5leHRQYWdlciwgcHJldlBhZ2VyLCBleHBhbmQsIGNvbGxhcHNlIH0gPSB0aGlzLmlucy5zaG9ydGN1dEtleTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGFycm93S2V5ID0gW21vdmVVcCwgbW92ZURvd24sIGV4cGFuZCwgY29sbGFwc2VdO1xyXG4gICAgICAgICAgICAgICAgaWYgKGFycm93S2V5LmluY2x1ZGVzKGUuY29kZSkpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmlucy5jb21wb25lbnRSZWYuaW5zdGFuY2Uub25LZXlkb3duRXZlbnQoZSk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGUua2V5ID09PSBjb25maXJtKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGUudGFyZ2V0Wydub2RlTmFtZSddID09PSAnSU5QVVQnICYmICFlLmN0cmxLZXkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmlucy5va0J1dHRvbi5uYXRpdmVFbGVtZW50LmNsaWNrKCk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGUuY29kZSA9PT0gc2VhcmNoRm9jdXMpIHsgLy8g5biu5Yqp56qX5Y+j5p+l6K+i6L6T5YWl5qGG54Sm54K5XHJcbiAgICAgICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaW5zLmNvbXBvbmVudFJlZi5pbnN0YW5jZS5pbnB1dEdyb3VwLmZvY3VzKCk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCF0aGlzLmlucy5pc1RyZWUoKSAmJiAoZS5jb2RlID09PSBuZXh0UGFnZXIgfHwgZS5jb2RlID09PSBwcmV2UGFnZXIgKSkgeyAgLy8g5YiG6aG1XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgaXNOZXh0UGFnZXIgPSBlLmNvZGUgPT09IG5leHRQYWdlcjtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnBhZ2luYXRpb25LZXlEb3duSGFuZGxlcihpc05leHRQYWdlcik7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHBhZ2luYXRpb25LZXlEb3duSGFuZGxlcihuZXh0ID0gdHJ1ZSkge1xyXG4gICAgICAgIGNvbnN0IGRhdGF0YWJsZVJlZiA9IHRoaXMuaW5zLmNvbXBvbmVudFJlZi5pbnN0YW5jZTtcclxuICAgICAgICBjb25zdCB7cGFnZUluZGV4LCBwYWdlU2l6ZSwgdG90YWx9ID0gZGF0YXRhYmxlUmVmO1xyXG4gICAgICAgIGNvbnN0IHBhZ2VyQ291bnQgPSBNYXRoLmNlaWwodG90YWwgLyBwYWdlU2l6ZSk7XHJcblxyXG4gICAgICAgIGxldCBuZXdQYWdlTnVtID0gcGFnZUluZGV4O1xyXG4gICAgICAgIGlmIChuZXh0KSB7XHJcbiAgICAgICAgICAgIG5ld1BhZ2VOdW0gPSBuZXdQYWdlTnVtICsgMTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBuZXdQYWdlTnVtID0gbmV3UGFnZU51bSAtIDE7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAobmV3UGFnZU51bSA+IHBhZ2VyQ291bnQgfHwgbmV3UGFnZU51bSA8IDEpIHtcclxuICAgICAgICAgICAgbmV3UGFnZU51bSA9IHBhZ2VJbmRleDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuaW5zLmNvbXBvbmVudFJlZi5pbnN0YW5jZS5vblBhZ2VDaGFuZ2UoeyBwYWdlU2l6ZSwgcGFnZUluZGV4OiBuZXdQYWdlTnVtIH0pO1xyXG4gICAgfVxyXG5cclxufVxyXG5cclxuIl19