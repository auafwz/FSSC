/**
 * @fileoverview added by tsickle
 * Generated from: lib/grid-personnel-selector.component.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Component, ElementRef, EventEmitter, Injector, Renderer2, ViewChild } from '@angular/core';
import { CommonUtils, RuntimeStateService } from '@farris/ui-common';
import { GRID_EDITORS } from '@farris/ui-datagrid';
import { DatagridBaseEditorDirective } from '@farris/ui-datagrid-editors';
import * as _ from 'lodash-es';
import { isNull, isUndefined, omitBy, trim } from 'lodash-es';
/** @type {?} */
const personnelSelectorDefautOption = {
    absOrgType: 'System_organization',
    // 数据源类型
    readonly: false,
    // 是否只读
    placeholder: '请选择',
    viewType: 'tag',
    busNum: 'common',
    idField: 'userId'
};
export class DatagridPersonnelSelectorComponent extends DatagridBaseEditorDirective {
    /**
     * @param {?} render
     * @param {?} el
     * @param {?} rts
     * @param {?} utils
     * @param {?} injector
     */
    constructor(render, el, rts, utils, injector) {
        super(render, el, injector);
        this.rts = rts;
        this.utils = utils;
        this.lookupFieldMap = (/**
         * @param {?} helpData
         * @param {?} mapFields
         * @param {?} dataObj
         * @return {?}
         */
        (helpData, mapFields, dataObj) => {
            if (mapFields) {
                /** @type {?} */
                const helpFields = Object.keys(mapFields);
                helpFields.forEach((/**
                 * @param {?} f
                 * @return {?}
                 */
                (f) => {
                    /** @type {?} */
                    let val = '';
                    if (helpData) {
                        if (helpData instanceof Array) {
                            val = helpData.map((/**
                             * @param {?} h
                             * @return {?}
                             */
                            (h) => {
                                return this.utils.getValue(f, h);
                            })).join(',');
                        }
                        else {
                            val = this.utils.getValue(f, helpData);
                        }
                    }
                    mapFields[f].split(',').forEach((/**
                     * @param {?} ff
                     * @return {?}
                     */
                    (ff) => {
                        /** @type {?} */
                        const field = trim(ff);
                        this.utils.setValue(dataObj, field, val);
                    }));
                }));
            }
        });
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        super.ngOnInit();
        // 这里添加了过滤 this.options 中null、undefined,万一 jit 生成了 undefined 的呢，
        this.options = Object.assign({}, personnelSelectorDefautOption, omitBy(this.options, (/**
         * @param {?} itemValue
         * @return {?}
         */
        (itemValue) => isUndefined(itemValue) || isNull(itemValue))));
        this.instance.selectedData = new EventEmitter();
        this.instance.clear = new EventEmitter();
    }
    /**
     * @return {?}
     */
    ngAfterViewInit() {
        this.inputElement = this.el.nativeElement;
        super.ngAfterViewInit();
        if (this.instance.ngControl &&
            this.instance.ngControl.formDirective &&
            this.instance.ngControl.formDirective.form &&
            this.instance.ngControl.formDirective.form.bindingData) {
            this.bindingData = this.instance.ngControl.formDirective.form.bindingData;
            this.bindingData.setValue = (/**
             * @param {?} fieldPath
             * @return {?}
             */
            (fieldPath) => {
                return this.utils.setValue(fieldPath.join('.'), this.bindingData, true);
            });
            this.bindingData.getValue = (/**
             * @param {?} fieldPath
             * @return {?}
             */
            (fieldPath) => {
                return this.utils.getValue(fieldPath.join('.'), this.bindingData, true);
            });
        }
    }
    /**
     * @return {?}
     */
    inputClear() {
        this.updateControlValue(null);
        this.instance.clear.emit();
        if (this.options.inputClear) {
            this.options.inputClear();
        }
    }
    /**
     * @param {?} removedItem
     * @return {?}
     */
    tagRemoved(removedItem) {
        /** @type {?} */
        const mapFields = this.instance.mapFields;
        /** @type {?} */
        const helpFields = Object.keys(mapFields);
        /** @type {?} */
        const bindingData = _.cloneDeep(this.bindingData);
        /** @type {?} */
        const selectedData = [];
        helpFields.forEach((/**
         * @param {?} key
         * @return {?}
         */
        key => {
            /** @type {?} */
            let value = this.utils.getValue(mapFields[key], bindingData);
            /** @type {?} */
            const vArr = value.split(',');
            vArr.splice(removedItem.deleteIndex, 1);
            vArr.forEach((/**
             * @param {?} v
             * @param {?} i
             * @return {?}
             */
            (v, i) => {
                if (!selectedData[i]) {
                    selectedData.push({ index: i });
                    selectedData[i][key] = v;
                }
                else {
                    selectedData[i][key] = v;
                }
            }));
            value = vArr.join(',');
            this.utils.setValue(this.bindingData, mapFields[key], value);
        }));
        if (selectedData.length) {
            this.instance.selectedData.emit(selectedData);
        }
        else {
            this.instance.clear.emit();
        }
        if (this.options.tagRemoved) {
            this.options.tagRemoved(this.eventPrams(removedItem));
        }
    }
    /**
     * @param {?} changeData
     * @return {?}
     */
    selectionsChange(changeData) {
        /** @type {?} */
        const formedSelections = this.formSelectedRowData();
        this.updateControlValue(formedSelections);
        this.instance.selectedData.emit(formedSelections);
        if (this.options.selectionsChange) {
            this.options.selectionsChange(this.eventPrams(changeData));
        }
    }
    /**
     * @param {?} selectedRow
     * @return {?}
     */
    updateControlValue(selectedRow) {
        if (this.instance.mapFields && this.bindingData) {
            this.lookupFieldMap(selectedRow, this.instance.mapFields, this.bindingData);
        }
    }
    /**
     * @return {?}
     */
    formSelectedRowData() {
        /** @type {?} */
        let selectedRowData = [];
        this.instance.selections.forEach((/**
         * @param {?} item
         * @return {?}
         */
        (item) => {
            /** @type {?} */
            const defaultDisplayName = this.instance.displayField ? item[this.instance.displayField] : `[${item.code}]${item.name}`;
            /** @type {?} */
            const displayName = this.instance.formatFn ? this.instance.formatFn(item) : defaultDisplayName;
            selectedRowData.push(Object.assign({}, item, { displayName }));
        }));
        return selectedRowData.length ? selectedRowData : null;
    }
    /**
     * @private
     * @param {?} $event
     * @return {?}
     */
    eventPrams($event) {
        /** @type {?} */
        const p = this.eventParams($event);
        p['instance'] = this.instance;
        p['editor'] = this;
        return p;
    }
}
DatagridPersonnelSelectorComponent.decorators = [
    { type: Component, args: [{
                selector: 'grid-personnel-selector',
                template: `
    <div [formGroup]="group" class="f-datagrid-cell-formgroup farris-group-auto">
            <farris-personnel-selector #selection
            style="width: 100%"
            [placeholder]="options.placeholder"
            [enableQuick]="false"
            [readonly]="options.readonly"
            [absOrgType]="options.absOrgType"
            [viewType]="options.viewType"
            [multiSelect]="options.multiSelect"
            [busNum]="options.busNum"
            [mapFields]="options.mapFields"
            [formatFn]="options.formatter"
            [formControlName]="column.field"
            [idField]="options.idField"
            [displayField]="options.textField"
            (inputClear)="inputClear()"
            (selectionsChange)="selectionsChange($event)"
            (tagRemoved)="tagRemoved($event)"
            >
            </farris-personnel-selector>
    </div>
    `
            }] }
];
/** @nocollapse */
DatagridPersonnelSelectorComponent.ctorParameters = () => [
    { type: Renderer2 },
    { type: ElementRef },
    { type: RuntimeStateService },
    { type: CommonUtils },
    { type: Injector }
];
DatagridPersonnelSelectorComponent.propDecorators = {
    instance: [{ type: ViewChild, args: ['selection',] }]
};
if (false) {
    /** @type {?} */
    DatagridPersonnelSelectorComponent.prototype.instance;
    /** @type {?} */
    DatagridPersonnelSelectorComponent.prototype.bindingData;
    /** @type {?} */
    DatagridPersonnelSelectorComponent.prototype.lookupFieldMap;
    /**
     * @type {?}
     * @private
     */
    DatagridPersonnelSelectorComponent.prototype.rts;
    /** @type {?} */
    DatagridPersonnelSelectorComponent.prototype.utils;
}
/** @type {?} */
export const PersonnelSelectorDataGridEditorProvider = { provide: GRID_EDITORS, useValue: { name: 'PersonnelSelector', value: DatagridPersonnelSelectorComponent }, multi: true };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ3JpZC1wZXJzb25uZWwtc2VsZWN0b3IuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy91aS1wZXJzb25uZWwtc2VsZWN0b3IvIiwic291cmNlcyI6WyJsaWIvZ3JpZC1wZXJzb25uZWwtc2VsZWN0b3IuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFpQixTQUFTLEVBQUUsVUFBVSxFQUFFLFlBQVksRUFBRSxRQUFRLEVBQVUsU0FBUyxFQUFFLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzSCxPQUFPLEVBQUUsV0FBVyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDckUsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ25ELE9BQU8sRUFBRSwyQkFBMkIsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBQzFFLE9BQU8sS0FBSyxDQUFDLE1BQU0sV0FBVyxDQUFDO0FBQy9CLE9BQU8sRUFBRSxNQUFNLEVBQUUsV0FBVyxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsTUFBTSxXQUFXLENBQUM7O01BR3hELDZCQUE2QixHQUFHO0lBQ3BDLFVBQVUsRUFBRSxxQkFBcUI7O0lBQ2pDLFFBQVEsRUFBRSxLQUFLOztJQUNmLFdBQVcsRUFBRSxLQUFLO0lBQ2xCLFFBQVEsRUFBRSxLQUFLO0lBQ2YsTUFBTSxFQUFFLFFBQVE7SUFDaEIsT0FBTyxFQUFFLFFBQVE7Q0FDbEI7QUE0QkQsTUFBTSxPQUFPLGtDQUFtQyxTQUFRLDJCQUEyQjs7Ozs7Ozs7SUFNakYsWUFDRSxNQUFpQixFQUNqQixFQUFjLEVBQ04sR0FBd0IsRUFDekIsS0FBa0IsRUFDekIsUUFBa0I7UUFDbEIsS0FBSyxDQUFDLE1BQU0sRUFBRSxFQUFFLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFIcEIsUUFBRyxHQUFILEdBQUcsQ0FBcUI7UUFDekIsVUFBSyxHQUFMLEtBQUssQ0FBYTtRQXlD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TSxDQUFDO1FBQ2xDLENBQUMsQ0FBQyxVQUFVLENBQUMsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDO1FBQzlCLENBQUMsQ0FBQyxRQUFRLENBQUMsR0FBRyxJQUFJLENBQUM7UUFDbkIsT0FBTyxDQUFDLENBQUM7SUFDWCxDQUFDOzs7WUE1S0YsU0FBUyxTQUFDO2dCQUNULFFBQVEsRUFBRSx5QkFBeUI7Z0JBQ25DLFFBQVEsRUFBRTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztLQXNCUDthQUNKOzs7O1lBMUM4RSxTQUFTO1lBQXJELFVBQVU7WUFDdkIsbUJBQW1CO1lBQWhDLFdBQVc7WUFEeUMsUUFBUTs7O3VCQTZDbEUsU0FBUyxTQUFDLFdBQVc7Ozs7SUFBdEIsc0RBQTZIOztJQUU3SCx5REFBaUI7O0lBK0NqQiw0REFzQkM7Ozs7O0lBaEVDLGlEQUFnQzs7SUFDaEMsbURBQXlCOzs7QUE0STdCLE1BQU0sT0FBTyx1Q0FBdUMsR0FBRyxFQUFFLE9BQU8sRUFBRSxZQUFZLEVBQUUsUUFBUSxFQUFFLEVBQUUsSUFBSSxFQUFFLG1CQUFtQixFQUFFLEtBQUssRUFBRSxrQ0FBa0MsRUFBRSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBZnRlclZpZXdJbml0LCBDb21wb25lbnQsIEVsZW1lbnRSZWYsIEV2ZW50RW1pdHRlciwgSW5qZWN0b3IsIE9uSW5pdCwgUmVuZGVyZXIyLCBWaWV3Q2hpbGQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgQ29tbW9uVXRpbHMsIFJ1bnRpbWVTdGF0ZVNlcnZpY2UgfSBmcm9tICdAZmFycmlzL3VpLWNvbW1vbic7XHJcbmltcG9ydCB7IEdSSURfRURJVE9SUyB9IGZyb20gJ0BmYXJyaXMvdWktZGF0YWdyaWQnO1xyXG5pbXBvcnQgeyBEYXRhZ3JpZEJhc2VFZGl0b3JEaXJlY3RpdmUgfSBmcm9tICdAZmFycmlzL3VpLWRhdGFncmlkLWVkaXRvcnMnO1xyXG5pbXBvcnQgKiBhcyBfIGZyb20gJ2xvZGFzaC1lcyc7XHJcbmltcG9ydCB7IGlzTnVsbCwgaXNVbmRlZmluZWQsIG9taXRCeSwgdHJpbSB9IGZyb20gJ2xvZGFzaC1lcyc7XHJcbmltcG9ydCB7IFBlcnNvbm5lbFNlbGVjdG9yQ29tcG9uZW50IH0gZnJvbSAnLi9zZWxlY3Rpb24uY29tcG9uZW50JztcclxuXHJcbmNvbnN0IHBlcnNvbm5lbFNlbGVjdG9yRGVmYXV0T3B0aW9uID0ge1xyXG4gIGFic09yZ1R5cGU6ICdTeXN0ZW1fb3JnYW5pemF0aW9uJywgLy8g5pWw5o2u5rqQ57G75Z6LXHJcbiAgcmVhZG9ubHk6IGZhbHNlLCAvLyDmmK/lkKblj6ror7tcclxuICBwbGFjZWhvbGRlcjogJ+ivt+mAieaLqScsXHJcbiAgdmlld1R5cGU6ICd0YWcnLFxyXG4gIGJ1c051bTogJ2NvbW1vbicsXHJcbiAgaWRGaWVsZDogJ3VzZXJJZCdcclxufTtcclxuXHJcbkBDb21wb25lbnQoe1xyXG4gIHNlbGVjdG9yOiAnZ3JpZC1wZXJzb25uZWwtc2VsZWN0b3InLFxyXG4gIHRlbXBsYXRlOiBgXHJcbiAgICA8ZGl2IFtmb3JtR3JvdXBdPVwiZ3JvdXBcIiBjbGFzcz1cImYtZGF0YWdyaWQtY2VsbC1mb3JtZ3JvdXAgZmFycmlzLWdyb3VwLWF1dG9cIj5cclxuICAgICAgICAgICAgPGZhcnJpcy1wZXJzb25uZWwtc2VsZWN0b3IgI3NlbGVjdGlvblxyXG4gICAgICAgICAgICBzdHlsZT1cIndpZHRoOiAxMDAlXCJcclxuICAgICAgICAgICAgW3BsYWNlaG9sZGVyXT1cIm9wdGlvbnMucGxhY2Vob2xkZXJcIlxyXG4gICAgICAgICAgICBbZW5hYmxlUXVpY2tdPVwiZmFsc2VcIlxyXG4gICAgICAgICAgICBbcmVhZG9ubHldPVwib3B0aW9ucy5yZWFkb25seVwiXHJcbiAgICAgICAgICAgIFthYnNPcmdUeXBlXT1cIm9wdGlvbnMuYWJzT3JnVHlwZVwiXHJcbiAgICAgICAgICAgIFt2aWV3VHlwZV09XCJvcHRpb25zLnZpZXdUeXBlXCJcclxuICAgICAgICAgICAgW211bHRpU2VsZWN0XT1cIm9wdGlvbnMubXVsdGlTZWxlY3RcIlxyXG4gICAgICAgICAgICBbYnVzTnVtXT1cIm9wdGlvbnMuYnVzTnVtXCJcclxuICAgICAgICAgICAgW21hcEZpZWxkc109XCJvcHRpb25zLm1hcEZpZWxkc1wiXHJcbiAgICAgICAgICAgIFtmb3JtYXRGbl09XCJvcHRpb25zLmZvcm1hdHRlclwiXHJcbiAgICAgICAgICAgIFtmb3JtQ29udHJvbE5hbWVdPVwiY29sdW1uLmZpZWxkXCJcclxuICAgICAgICAgICAgW2lkRmllbGRdPVwib3B0aW9ucy5pZEZpZWxkXCJcclxuICAgICAgICAgICAgW2Rpc3BsYXlGaWVsZF09XCJvcHRpb25zLnRleHRGaWVsZFwiXHJcbiAgICAgICAgICAgIChpbnB1dENsZWFyKT1cImlucHV0Q2xlYXIoKVwiXHJcbiAgICAgICAgICAgIChzZWxlY3Rpb25zQ2hhbmdlKT1cInNlbGVjdGlvbnNDaGFuZ2UoJGV2ZW50KVwiXHJcbiAgICAgICAgICAgICh0YWdSZW1vdmVkKT1cInRhZ1JlbW92ZWQoJGV2ZW50KVwiXHJcbiAgICAgICAgICAgID5cclxuICAgICAgICAgICAgPC9mYXJyaXMtcGVyc29ubmVsLXNlbGVjdG9yPlxyXG4gICAgPC9kaXY+XHJcbiAgICBgLFxyXG59KVxyXG5leHBvcnQgY2xhc3MgRGF0YWdyaWRQZXJzb25uZWxTZWxlY3RvckNvbXBvbmVudCBleHRlbmRzIERhdGFncmlkQmFzZUVkaXRvckRpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uSW5pdCwgQWZ0ZXJWaWV3SW5pdCB7XHJcblxyXG4gIEBWaWV3Q2hpbGQoJ3NlbGVjdGlvbicpIGluc3RhbmNlOiBQZXJzb25uZWxTZWxlY3RvckNvbXBvbmVudCAmIHsgY2xlYXI6IEV2ZW50RW1pdHRlcjxhbnk+OyBzZWxlY3RlZERhdGE6IEV2ZW50RW1pdHRlcjxhbnk+IH07XHJcblxyXG4gIGJpbmRpbmdEYXRhOiBhbnk7XHJcblxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcmVuZGVyOiBSZW5kZXJlcjIsXHJcbiAgICBlbDogRWxlbWVudFJlZixcclxuICAgIHByaXZhdGUgcnRzOiBSdW50aW1lU3RhdGVTZXJ2aWNlLFxyXG4gICAgcHVibGljIHV0aWxzOiBDb21tb25VdGlscyxcclxuICAgIGluamVjdG9yOiBJbmplY3Rvcikge1xyXG4gICAgc3VwZXIocmVuZGVyLCBlbCwgaW5qZWN0b3IpO1xyXG4gIH1cclxuXHJcbiAgbmdPbkluaXQoKTogdm9pZCB7XHJcbiAgICBzdXBlci5uZ09uSW5pdCgpO1xyXG4gICAgLy8g6L+Z6YeM5re75Yqg5LqG6L+H5rukIHRoaXMub3B0aW9ucyDkuK1udWxs44CBdW5kZWZpbmVkLOS4h+S4gCBqaXQg55Sf5oiQ5LqGIHVuZGVmaW5lZCDnmoTlkaLvvIxcclxuICAgIHRoaXMub3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oe30sIHBlcnNvbm5lbFNlbGVjdG9yRGVmYXV0T3B0aW9uLCBvbWl0QnkodGhpcy5vcHRpb25zLCAoaXRlbVZhbHVlKSA9PiBpc1VuZGVmaW5lZChpdGVtVmFsdWUpIHx8IGlzTnVsbChpdGVtVmFsdWUpKSk7XHJcbiAgICB0aGlzLmluc3RhbmNlLnNlbGVjdGVkRGF0YSA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpXHJcbiAgICB0aGlzLmluc3RhbmNlLmNsZWFyID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KClcclxuICB9XHJcblxyXG4gIG5nQWZ0ZXJWaWV3SW5pdCgpIHtcclxuICAgIHRoaXMuaW5wdXRFbGVtZW50ID0gdGhpcy5lbC5uYXRpdmVFbGVtZW50O1xyXG4gICAgc3VwZXIubmdBZnRlclZpZXdJbml0KCk7XHJcbiAgICBpZiAoXHJcbiAgICAgIHRoaXMuaW5zdGFuY2UubmdDb250cm9sICYmXHJcbiAgICAgIHRoaXMuaW5zdGFuY2UubmdDb250cm9sLmZvcm1EaXJlY3RpdmUgJiZcclxuICAgICAgdGhpcy5pbnN0YW5jZS5uZ0NvbnRyb2wuZm9ybURpcmVjdGl2ZS5mb3JtICYmXHJcbiAgICAgIHRoaXMuaW5zdGFuY2UubmdDb250cm9sLmZvcm1EaXJlY3RpdmUuZm9ybS5iaW5kaW5nRGF0YVxyXG4gICAgKSB7XHJcbiAgICAgIHRoaXMuYmluZGluZ0RhdGEgPSB0aGlzLmluc3RhbmNlLm5nQ29udHJvbC5mb3JtRGlyZWN0aXZlLmZvcm0uYmluZGluZ0RhdGE7XHJcbiAgICAgIHRoaXMuYmluZGluZ0RhdGEuc2V0VmFsdWUgPSAoZmllbGRQYXRoKSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMudXRpbHMuc2V0VmFsdWUoZmllbGRQYXRoLmpvaW4oJy4nKSwgdGhpcy5iaW5kaW5nRGF0YSwgdHJ1ZSk7XHJcbiAgICAgIH07XHJcbiAgICAgIHRoaXMuYmluZGluZ0RhdGEuZ2V0VmFsdWUgPSAoZmllbGRQYXRoKSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMudXRpbHMuZ2V0VmFsdWUoZmllbGRQYXRoLmpvaW4oJy4nKSwgdGhpcy5iaW5kaW5nRGF0YSwgdHJ1ZSk7XHJcbiAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gIH1cclxuXHJcbiAgaW5wdXRDbGVhcigpIHtcclxuICAgIHRoaXMudXBkYXRlQ29udHJvbFZhbHVlKG51bGwpXHJcbiAgICB0aGlzLmluc3RhbmNlLmNsZWFyLmVtaXQoKTtcclxuICAgIGlmICh0aGlzLm9wdGlvbnMuaW5wdXRDbGVhcikge1xyXG4gICAgICB0aGlzLm9wdGlvbnMuaW5wdXRDbGVhcigpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgbG9va3VwRmllbGRNYXAgPSAoaGVscERhdGEsIG1hcEZpZWxkcywgZGF0YU9iaikgPT4ge1xyXG4gICAgaWYgKG1hcEZpZWxkcykge1xyXG4gICAgICBjb25zdCBoZWxwRmllbGRzID0gT2JqZWN0LmtleXMobWFwRmllbGRzKTtcclxuICAgICAgaGVscEZpZWxkcy5mb3JFYWNoKChmOiBhbnkpID0+IHtcclxuICAgICAgICBsZXQgdmFsID0gJyc7XHJcbiAgICAgICAgaWYgKGhlbHBEYXRhKSB7XHJcbiAgICAgICAgICBpZiAoaGVscERhdGEgaW5zdGFuY2VvZiBBcnJheSkge1xyXG4gICAgICAgICAgICB2YWwgPSBoZWxwRGF0YS5tYXAoKGg6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgIHJldHVybiB0aGlzLnV0aWxzLmdldFZhbHVlKGYsIGgpO1xyXG4gICAgICAgICAgICB9KS5qb2luKCcsJyk7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB2YWwgPSB0aGlzLnV0aWxzLmdldFZhbHVlKGYsIGhlbHBEYXRhKTtcclxuICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBtYXBGaWVsZHNbZl0uc3BsaXQoJywnKS5mb3JFYWNoKChmZjogYW55KSA9PiB7XHJcbiAgICAgICAgICBjb25zdCBmaWVsZCA9IHRyaW0oZmYpO1xyXG4gICAgICAgICAgdGhpcy51dGlscy5zZXRWYWx1ZShkYXRhT2JqLCBmaWVsZCwgdmFsKTtcclxuICAgICAgICB9KTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICB0YWdSZW1vdmVkKHJlbW92ZWRJdGVtOiB7XHJcbiAgICBkZWxldGVJdGVtOiBhbnksXHJcbiAgICBkZWxldGVJbmRleDogTnVtYmVyLFxyXG4gICAgc2VsZWN0aW9uczogQXJyYXk8YW55PlxyXG4gIH0pIHtcclxuICAgIGNvbnN0IG1hcEZpZWxkcyA9IHRoaXMuaW5zdGFuY2UubWFwRmllbGRzO1xyXG4gICAgY29uc3QgaGVscEZpZWxkcyA9IE9iamVjdC5rZXlzKG1hcEZpZWxkcyk7XHJcbiAgICBjb25zdCBiaW5kaW5nRGF0YSA9IF8uY2xvbmVEZWVwKHRoaXMuYmluZGluZ0RhdGEpO1xyXG4gICAgY29uc3Qgc2VsZWN0ZWREYXRhID0gW107XHJcblxyXG4gICAgaGVscEZpZWxkcy5mb3JFYWNoKGtleSA9PiB7XHJcbiAgICAgIGxldCB2YWx1ZSA9IHRoaXMudXRpbHMuZ2V0VmFsdWUobWFwRmllbGRzW2tleV0sIGJpbmRpbmdEYXRhKTtcclxuICAgICAgY29uc3QgdkFyciA9IHZhbHVlLnNwbGl0KCcsJyk7XHJcbiAgICAgIHZBcnIuc3BsaWNlKHJlbW92ZWRJdGVtLmRlbGV0ZUluZGV4LCAxKTtcclxuICAgICAgdkFyci5mb3JFYWNoKCh2LCBpKSA9PiB7XHJcbiAgICAgICAgaWYgKCFzZWxlY3RlZERhdGFbaV0pIHtcclxuICAgICAgICAgIHNlbGVjdGVkRGF0YS5wdXNoKHsgaW5kZXg6IGkgfSk7XHJcbiAgICAgICAgICBzZWxlY3RlZERhdGFbaV1ba2V5XSA9IHY7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHNlbGVjdGVkRGF0YVtpXVtrZXldID0gdjtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgICB2YWx1ZSA9IHZBcnIuam9pbignLCcpO1xyXG4gICAgICB0aGlzLnV0aWxzLnNldFZhbHVlKHRoaXMuYmluZGluZ0RhdGEsIG1hcEZpZWxkc1trZXldLCB2YWx1ZSk7XHJcbiAgICB9KTtcclxuICAgIGlmIChzZWxlY3RlZERhdGEubGVuZ3RoKSB7XHJcbiAgICAgIHRoaXMuaW5zdGFuY2Uuc2VsZWN0ZWREYXRhLmVtaXQoc2VsZWN0ZWREYXRhKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMuaW5zdGFuY2UuY2xlYXIuZW1pdCgpO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICBpZiAodGhpcy5vcHRpb25zLnRhZ1JlbW92ZWQpIHtcclxuICAgICAgdGhpcy5vcHRpb25zLnRhZ1JlbW92ZWQodGhpcy5ldmVudFByYW1zKHJlbW92ZWRJdGVtKSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBzZWxlY3Rpb25zQ2hhbmdlKGNoYW5nZURhdGE6IHtcclxuICAgIGluZm86IHN0cmluZyxcclxuICAgIGRhdGE6IEFycmF5PGFueT5cclxuICB9KSB7XHJcbiAgICBjb25zdCBmb3JtZWRTZWxlY3Rpb25zID0gdGhpcy5mb3JtU2VsZWN0ZWRSb3dEYXRhKClcclxuICAgIHRoaXMudXBkYXRlQ29udHJvbFZhbHVlKGZvcm1lZFNlbGVjdGlvbnMpO1xyXG4gICAgdGhpcy5pbnN0YW5jZS5zZWxlY3RlZERhdGEuZW1pdChmb3JtZWRTZWxlY3Rpb25zKTtcclxuICAgIGlmICh0aGlzLm9wdGlvbnMuc2VsZWN0aW9uc0NoYW5nZSkge1xyXG4gICAgICB0aGlzLm9wdGlvbnMuc2VsZWN0aW9uc0NoYW5nZSh0aGlzLmV2ZW50UHJhbXMoY2hhbmdlRGF0YSkpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgdXBkYXRlQ29udHJvbFZhbHVlKHNlbGVjdGVkUm93KSB7XHJcbiAgICBpZiAodGhpcy5pbnN0YW5jZS5tYXBGaWVsZHMgJiYgdGhpcy5iaW5kaW5nRGF0YSkge1xyXG4gICAgICB0aGlzLmxvb2t1cEZpZWxkTWFwKHNlbGVjdGVkUm93LCB0aGlzLmluc3RhbmNlLm1hcEZpZWxkcywgdGhpcy5iaW5kaW5nRGF0YSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuXHJcbiAgZm9ybVNlbGVjdGVkUm93RGF0YSgpIHtcclxuICAgIGxldCBzZWxlY3RlZFJvd0RhdGEgPSBbXTtcclxuICAgIHRoaXMuaW5zdGFuY2Uuc2VsZWN0aW9ucy5mb3JFYWNoKChpdGVtKSA9PiB7XHJcbiAgICAgIGNvbnN0IGRlZmF1bHREaXNwbGF5TmFtZSA9IHRoaXMuaW5zdGFuY2UuZGlzcGxheUZpZWxkID8gaXRlbVt0aGlzLmluc3RhbmNlLmRpc3BsYXlGaWVsZF0gOiBgWyR7aXRlbS5jb2RlfV0ke2l0ZW0ubmFtZX1gO1xyXG4gICAgICBjb25zdCBkaXNwbGF5TmFtZSA9IHRoaXMuaW5zdGFuY2UuZm9ybWF0Rm4gPyB0aGlzLmluc3RhbmNlLmZvcm1hdEZuKGl0ZW0pIDogZGVmYXVsdERpc3BsYXlOYW1lO1xyXG4gICAgICBzZWxlY3RlZFJvd0RhdGEucHVzaChPYmplY3QuYXNzaWduKHt9LCBpdGVtLCB7IGRpc3BsYXlOYW1lIH0pKVxyXG4gICAgfSlcclxuICAgIHJldHVybiBzZWxlY3RlZFJvd0RhdGEubGVuZ3RoID8gc2VsZWN0ZWRSb3dEYXRhIDogbnVsbDtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZXZlbnRQcmFtcygkZXZlbnQpOiBhbnkge1xyXG4gICAgY29uc3QgcCA9IHRoaXMuZXZlbnRQYXJhbXMoJGV2ZW50KTtcclxuICAgIHBbJ2luc3RhbmNlJ10gPSB0aGlzLmluc3RhbmNlO1xyXG4gICAgcFsnZWRpdG9yJ10gPSB0aGlzO1xyXG4gICAgcmV0dXJuIHA7XHJcbiAgfVxyXG59XHJcblxyXG5cclxuZXhwb3J0IGNvbnN0IFBlcnNvbm5lbFNlbGVjdG9yRGF0YUdyaWRFZGl0b3JQcm92aWRlciA9IHsgcHJvdmlkZTogR1JJRF9FRElUT1JTLCB1c2VWYWx1ZTogeyBuYW1lOiAnUGVyc29ubmVsU2VsZWN0b3InLCB2YWx1ZTogRGF0YWdyaWRQZXJzb25uZWxTZWxlY3RvckNvbXBvbmVudCB9LCBtdWx0aTogdHJ1ZSB9Il19