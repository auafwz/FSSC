import { Injectable, Injector } from "@angular/core";
import { AppContextManager, FrameContext } from "@farris/devkit";
import { from, of } from "rxjs";
import { BefRepositoryUtil } from '@farris/bef';
import { concatMap, throwIfEmpty } from "rxjs/operators";
import { ValidationService } from "../validation.service";
import { WorkFlowMessage } from "./work-flow-message";
import { WorkFlowMessageService } from "./work-flow-message.service";
var WorkFlowMessageHandler = /** @class */ (function () {
    function WorkFlowMessageHandler(injector, frameContext, workFlowMessageService, workFlowMessage) {
        this.injector = injector;
        this.frameContext = frameContext;
        this.workFlowMessageService = workFlowMessageService;
        this.workFlowMessage = workFlowMessage;
    }
    WorkFlowMessageHandler.prototype.onComponentInit = function (frameContext) {
        this.workFlowMessage.addEventListener(this.handle.bind(this));
    };
    WorkFlowMessageHandler.prototype.handle = function (message) {
        var _this = this;
        var source = message.sender;
        var data = message.data;
        var commandName = data.command || null;
        var resultTask = null;
        if (!commandName) {
            return;
        }
        if (commandName == 'wf-required-verification') {
            // 工作流的必填校验
            // 如此获取的是当前组件的校验服务，应该按namespace来区分，不同的namespace需要分别执行校验
            var formFrameContexts = this.getFormFrameContexts();
            resultTask = from(formFrameContexts).pipe(concatMap(function (frameContext) {
                var validation = frameContext.injector.get(ValidationService, null);
                if (validation) {
                    return validation.validateAll();
                }
                return of(true);
            }));
        }
        else {
            var command = this.frameContext.viewModel[commandName];
            if (command) {
                resultTask = command(data.arguments);
            }
        }
        if (resultTask) {
            var message_1 = this.buildMessage(true, source, this.isChanged);
            resultTask.pipe(throwIfEmpty()).subscribe(function (result) {
                // 向来源方回传消息
                _this.workFlowMessageService.send(message_1);
            }, function () {
                message_1.data.result = false;
                _this.workFlowMessageService.send(message_1);
            });
        }
    };
    WorkFlowMessageHandler.prototype.buildMessage = function (result, target, dataChanged, type) {
        if (type === void 0) { type = 'message'; }
        var message = {
            data: {
                result: result,
                dataChanged: dataChanged
            },
            type: type,
            target: target,
        };
        return message;
    };
    WorkFlowMessageHandler.prototype.getFormFrameContexts = function () {
        var appContextManager = this.injector.get(AppContextManager, null);
        var formFrameContexts = [];
        if (appContextManager) {
            var appContexts = appContextManager.getAppContexts();
            if (appContexts && appContexts.length > 0) {
                appContexts.forEach(function (appContext) {
                    var frameContexts = appContext.frameContextManager.getFrameContexts();
                    frameContexts.reduce(function (contexts, frameContext) {
                        var namespace = frameContext.namespace;
                        var index = contexts.findIndex(function (frame) { return frame.namespace === namespace; });
                        if (index === -1) {
                            var root = frameContext.getVirtualRootFrameContext();
                            contexts.push(root);
                        }
                        return contexts;
                    }, formFrameContexts);
                });
            }
        }
        return formFrameContexts;
    };
    Object.defineProperty(WorkFlowMessageHandler.prototype, "isChanged", {
        /**
         * 是否有未保存的变更
         */
        get: function () {
            var befRepository = this.frameContext.repository;
            return BefRepositoryUtil.isExistUnsaveData(befRepository);
        },
        enumerable: true,
        configurable: true
    });
    WorkFlowMessageHandler.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    WorkFlowMessageHandler.ctorParameters = function () { return [
        { type: Injector },
        { type: FrameContext },
        { type: WorkFlowMessageService },
        { type: WorkFlowMessage }
    ]; };
    return WorkFlowMessageHandler;
}());
export { WorkFlowMessageHandler };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid29yay1mbG93LW1lc3NhZ2UuaGFuZGxlci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy8iLCJzb3VyY2VzIjpbImxpYi93b3JrLWZsb3cvd29yay1mbG93LW1lc3NhZ2UuaGFuZGxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNyRCxPQUFPLEVBQWMsaUJBQWlCLEVBQUUsWUFBWSxFQUF3QixNQUFNLGdCQUFnQixDQUFDO0FBQ25HLE9BQU8sRUFBRSxJQUFJLEVBQWMsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzVDLE9BQU8sRUFBaUIsaUJBQWlCLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDL0QsT0FBTyxFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN6RCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUUxRCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDdEQsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFFckU7SUFFRSxnQ0FBb0IsUUFBa0IsRUFBVSxZQUEwQixFQUFVLHNCQUE4QyxFQUFVLGVBQWdDO1FBQXhKLGFBQVEsR0FBUixRQUFRLENBQVU7UUFBVSxpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUFVLDJCQUFzQixHQUF0QixzQkFBc0IsQ0FBd0I7UUFBVSxvQkFBZSxHQUFmLGVBQWUsQ0FBaUI7SUFFNUssQ0FBQztJQUNNLGdEQUFlLEdBQXRCLFVBQXVCLFlBQTBCO1FBQy9DLElBQUksQ0FBQyxlQUFlLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztJQUNoRSxDQUFDO0lBQ00sdUNBQU0sR0FBYixVQUFjLE9BQTBCO1FB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Q3hFLElBQU0sU0FBUyxHQUFHLFlBQVksQ0FBQyxTQUFTLENBQUM7d0JBQ3pDLElBQU0sS0FBSyxHQUFHLFFBQVEsQ0FBQyxTQUFTLENBQUMsVUFBQyxLQUFtQixJQUFLLE9BQUEsS0FBSyxDQUFDLFNBQVMsS0FBSyxTQUFTLEVBQTdCLENBQTZCLENBQUMsQ0FBQzt3QkFDekYsSUFBSSxLQUFLLEtBQUssQ0FBQyxDQUFDLEVBQUU7NEJBQ2hCLElBQU0sSUFBSSxHQUFHLFlBQVksQ0FBQywwQkFBMEIsRUFBRSxDQUFDOzRCQUN2RCxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO3lCQUNyQjt3QkFDRCxPQUFPLFFBQVEsQ0FBQztvQkFDbEIsQ0FBQyxFQUFFLGlCQUFpQixDQUFDLENBQUM7Z0JBQ3hCLENBQUMsQ0FBQyxDQUFDO2FBQ0o7U0FDRjtRQUNELE9BQU8saUJBQWlCLENBQUM7SUFDM0IsQ0FBQztJQUlELHNCQUFZLDZDQUFTO1FBSHJCOztXQUVHO2FBQ0g7WUFDRSxJQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLFVBQWdDLENBQUM7WUFDekUsT0FBTyxpQkFBaUIsQ0FBQyxpQkFBaUIsQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUM1RCxDQUFDOzs7T0FBQTs7Z0JBckZGLFVBQVU7Ozs7Z0JBVlUsUUFBUTtnQkFDVyxZQUFZO2dCQU8zQyxzQkFBc0I7Z0JBRHRCLGVBQWU7O0lBeUZ4Qiw2QkFBQztDQUFBLEFBdEZELElBc0ZDO1NBckZZLHNCQUFzQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEluamVjdG9yIH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcclxuaW1wb3J0IHsgQXBwQ29udGV4dCwgQXBwQ29udGV4dE1hbmFnZXIsIEZyYW1lQ29udGV4dCwgb25GcmFtZUNvbXBvbmVudEluaXQgfSBmcm9tIFwiQGZhcnJpcy9kZXZraXRcIjtcclxuaW1wb3J0IHsgZnJvbSwgT2JzZXJ2YWJsZSwgb2YgfSBmcm9tIFwicnhqc1wiO1xyXG5pbXBvcnQgeyBCZWZSZXBvc2l0b3J5LCBCZWZSZXBvc2l0b3J5VXRpbCB9IGZyb20gJ0BmYXJyaXMvYmVmJztcclxuaW1wb3J0IHsgY29uY2F0TWFwLCB0aHJvd0lmRW1wdHkgfSBmcm9tIFwicnhqcy9vcGVyYXRvcnNcIjtcclxuaW1wb3J0IHsgVmFsaWRhdGlvblNlcnZpY2UgfSBmcm9tIFwiLi4vdmFsaWRhdGlvbi5zZXJ2aWNlXCI7XHJcbmltcG9ydCB7IFdvcmtGbG93IH0gZnJvbSBcIi4vdHlwZXNcIjtcclxuaW1wb3J0IHsgV29ya0Zsb3dNZXNzYWdlIH0gZnJvbSBcIi4vd29yay1mbG93LW1lc3NhZ2VcIjtcclxuaW1wb3J0IHsgV29ya0Zsb3dNZXNzYWdlU2VydmljZSB9IGZyb20gXCIuL3dvcmstZmxvdy1tZXNzYWdlLnNlcnZpY2VcIjtcclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIFdvcmtGbG93TWVzc2FnZUhhbmRsZXIgaW1wbGVtZW50cyBvbkZyYW1lQ29tcG9uZW50SW5pdCB7XHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IsIHByaXZhdGUgZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQsIHByaXZhdGUgd29ya0Zsb3dNZXNzYWdlU2VydmljZTogV29ya0Zsb3dNZXNzYWdlU2VydmljZSwgcHJpdmF0ZSB3b3JrRmxvd01lc3NhZ2U6IFdvcmtGbG93TWVzc2FnZSkge1xyXG5cclxuICB9XHJcbiAgcHVibGljIG9uQ29tcG9uZW50SW5pdChmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCkge1xyXG4gICAgdGhpcy53b3JrRmxvd01lc3NhZ2UuYWRkRXZlbnRMaXN0ZW5lcih0aGlzLmhhbmRsZS5iaW5kKHRoaXMpKTtcclxuICB9XHJcbiAgcHVibGljIGhhbmRsZShtZXNzYWdlOiBXb3JrRmxvdy5JTWVzc2FnZSk6IHZvaWQge1xyXG4gICAgY29uc3Qgc291cmNlID0gbWVzc2FnZS5zZW5kZXIgYXMgV2luZG93O1xyXG4gICAgY29uc3QgZGF0YSA9IG1lc3NhZ2UuZGF0YSBhcyBXb3JrRmxvdy5JTWVzc2FnZUJvZHk7XHJcbiAgICBjb25zdCBjb21tYW5kTmFtZSA9IGRhdGEuY29tbWFuZCB8fCBudWxsO1xyXG4gICAgbGV0IHJlc3VsdFRhc2s6IE9ic2VydmFibGU8YW55PiA9IG51bGw7XHJcbiAgICBpZiAoIWNvbW1hbmROYW1lKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGlmIChjb21tYW5kTmFtZSA9PSAnd2YtcmVxdWlyZWQtdmVyaWZpY2F0aW9uJykge1xyXG4gICAgICAvLyDlt6XkvZzmtYHnmoTlv4XloavmoKHpqoxcclxuICAgICAgLy8g5aaC5q2k6I635Y+W55qE5piv5b2T5YmN57uE5Lu255qE5qCh6aqM5pyN5Yqh77yM5bqU6K+l5oyJbmFtZXNwYWNl5p2l5Yy65YiG77yM5LiN5ZCM55qEbmFtZXNwYWNl6ZyA6KaB5YiG5Yir5omn6KGM5qCh6aqMXHJcbiAgICAgIGNvbnN0IGZvcm1GcmFtZUNvbnRleHRzID0gdGhpcy5nZXRGb3JtRnJhbWVDb250ZXh0cygpO1xyXG4gICAgICByZXN1bHRUYXNrID0gZnJvbShmb3JtRnJhbWVDb250ZXh0cykucGlwZShcclxuICAgICAgICBjb25jYXRNYXAoKGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0KSA9PiB7XHJcbiAgICAgICAgICB2YXIgdmFsaWRhdGlvbiA9IGZyYW1lQ29udGV4dC5pbmplY3Rvci5nZXQ8VmFsaWRhdGlvblNlcnZpY2U+KFZhbGlkYXRpb25TZXJ2aWNlLCBudWxsKTtcclxuICAgICAgICAgIGlmICh2YWxpZGF0aW9uKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB2YWxpZGF0aW9uLnZhbGlkYXRlQWxsKCk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICByZXR1cm4gb2YodHJ1ZSk7XHJcbiAgICAgICAgfSlcclxuICAgICAgKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHZhciBjb21tYW5kID0gdGhpcy5mcmFtZUNvbnRleHQudmlld01vZGVsW2NvbW1hbmROYW1lXTtcclxuICAgICAgaWYgKGNvbW1hbmQpIHtcclxuICAgICAgICByZXN1bHRUYXNrID0gY29tbWFuZChkYXRhLmFyZ3VtZW50cyk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIGlmIChyZXN1bHRUYXNrKSB7XHJcbiAgICAgIGNvbnN0IG1lc3NhZ2U6IFdvcmtGbG93LklNZXNzYWdlID0gdGhpcy5idWlsZE1lc3NhZ2UodHJ1ZSwgc291cmNlLCB0aGlzLmlzQ2hhbmdlZCk7XHJcbiAgICAgIHJlc3VsdFRhc2sucGlwZSh0aHJvd0lmRW1wdHkoKSkuc3Vic2NyaWJlKChyZXN1bHQpID0+IHtcclxuICAgICAgICAvLyDlkJHmnaXmupDmlrnlm57kvKDmtojmga9cclxuICAgICAgICB0aGlzLndvcmtGbG93TWVzc2FnZVNlcnZpY2Uuc2VuZChtZXNzYWdlKTtcclxuICAgICAgfSwgKCkgPT4ge1xyXG4gICAgICAgIG1lc3NhZ2UuZGF0YS5yZXN1bHQgPSBmYWxzZTtcclxuICAgICAgICB0aGlzLndvcmtGbG93TWVzc2FnZVNlcnZpY2Uuc2VuZChtZXNzYWdlKTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIHByaXZhdGUgYnVpbGRNZXNzYWdlKHJlc3VsdDogYm9vbGVhbiwgdGFyZ2V0OiBhbnksIGRhdGFDaGFuZ2VkOiBib29sZWFuLCB0eXBlOiBzdHJpbmcgPSAnbWVzc2FnZScpIHtcclxuICAgIGNvbnN0IG1lc3NhZ2U6IFdvcmtGbG93LklNZXNzYWdlID0ge1xyXG4gICAgICBkYXRhOiB7XHJcbiAgICAgICAgcmVzdWx0LFxyXG4gICAgICAgIGRhdGFDaGFuZ2VkXHJcbiAgICAgIH0sXHJcbiAgICAgIHR5cGU6IHR5cGUsXHJcbiAgICAgIHRhcmdldDogdGFyZ2V0LFxyXG4gICAgfTtcclxuICAgIHJldHVybiBtZXNzYWdlO1xyXG4gIH1cclxuICBwcml2YXRlIGdldEZvcm1GcmFtZUNvbnRleHRzKCk6IEZyYW1lQ29udGV4dFtdIHtcclxuICAgIGNvbnN0IGFwcENvbnRleHRNYW5hZ2VyID0gdGhpcy5pbmplY3Rvci5nZXQ8QXBwQ29udGV4dE1hbmFnZXI+KEFwcENvbnRleHRNYW5hZ2VyLCBudWxsKTtcclxuICAgIGNvbnN0IGZvcm1GcmFtZUNvbnRleHRzID0gW107XHJcbiAgICBpZiAoYXBwQ29udGV4dE1hbmFnZXIpIHtcclxuICAgICAgY29uc3QgYXBwQ29udGV4dHM6IEFwcENvbnRleHRbXSA9IGFwcENvbnRleHRNYW5hZ2VyLmdldEFwcENvbnRleHRzKCk7XHJcbiAgICAgIGlmIChhcHBDb250ZXh0cyAmJiBhcHBDb250ZXh0cy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgYXBwQ29udGV4dHMuZm9yRWFjaCgoYXBwQ29udGV4dDogQXBwQ29udGV4dCkgPT4ge1xyXG4gICAgICAgICAgY29uc3QgZnJhbWVDb250ZXh0czogRnJhbWVDb250ZXh0W10gPSBhcHBDb250ZXh0LmZyYW1lQ29udGV4dE1hbmFnZXIuZ2V0RnJhbWVDb250ZXh0cygpO1xyXG4gICAgICAgICAgZnJhbWVDb250ZXh0cy5yZWR1Y2UoKGNvbnRleHRzOiBGcmFtZUNvbnRleHRbXSwgZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgbmFtZXNwYWNlID0gZnJhbWVDb250ZXh0Lm5hbWVzcGFjZTtcclxuICAgICAgICAgICAgY29uc3QgaW5kZXggPSBjb250ZXh0cy5maW5kSW5kZXgoKGZyYW1lOiBGcmFtZUNvbnRleHQpID0+IGZyYW1lLm5hbWVzcGFjZSA9PT0gbmFtZXNwYWNlKTtcclxuICAgICAgICAgICAgaWYgKGluZGV4ID09PSAtMSkge1xyXG4gICAgICAgICAgICAgIGNvbnN0IHJvb3QgPSBmcmFtZUNvbnRleHQuZ2V0VmlydHVhbFJvb3RGcmFtZUNvbnRleHQoKTtcclxuICAgICAgICAgICAgICBjb250ZXh0cy5wdXNoKHJvb3QpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBjb250ZXh0cztcclxuICAgICAgICAgIH0sIGZvcm1GcmFtZUNvbnRleHRzKTtcclxuICAgICAgICB9KTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIGZvcm1GcmFtZUNvbnRleHRzO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmmK/lkKbmnInmnKrkv53lrZjnmoTlj5jmm7RcclxuICAgKi9cclxuICBwcml2YXRlIGdldCBpc0NoYW5nZWQoKTogYm9vbGVhbiB7XHJcbiAgICBjb25zdCBiZWZSZXBvc2l0b3J5ID0gdGhpcy5mcmFtZUNvbnRleHQucmVwb3NpdG9yeSBhcyBCZWZSZXBvc2l0b3J5PGFueT47XHJcbiAgICByZXR1cm4gQmVmUmVwb3NpdG9yeVV0aWwuaXNFeGlzdFVuc2F2ZURhdGEoYmVmUmVwb3NpdG9yeSk7XHJcbiAgfVxyXG59Il19