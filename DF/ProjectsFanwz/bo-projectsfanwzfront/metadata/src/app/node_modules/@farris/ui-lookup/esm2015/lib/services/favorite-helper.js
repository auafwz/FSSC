/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { TreeTableComponent } from '@farris/ui-treetable';
import { FavoriteAction, FavoriteIcon, FAVORITE_FIELD_NAME, LookupGridDisplayType } from '../lookup-displaytype';
export class FavoriteHelper {
    /**
     * @param {?} instance
     */
    constructor(instance) {
        this.instance = instance;
        this.favoriteColumnFormatter = (/**
         * @param {?} v
         * @param {?} data
         * @return {?}
         */
        (v, data) => {
            /** @type {?} */
            const f = v ? FavoriteIcon.yes : FavoriteIcon.no;
            if (this.instance.isTree()) {
                /** @type {?} */
                const id = data[this.instance.idField];
                if (id) {
                    /** @type {?} */
                    const tt = (/** @type {?} */ (this.instance.componentRef.instance));
                    /** @type {?} */
                    const rn = tt.findRowNode(id);
                    if (rn) {
                        if (rn.node.selectable) {
                            return f;
                        }
                        else {
                            return '';
                        }
                    }
                }
            }
            return f;
        });
        this.lookupSelectionSer = this.instance.lookupSelectionSer;
    }
    /**
     * @return {?}
     */
    getFavoriteColumns() {
        /** @type {?} */
        const columns = this.instance.gridOptions.columns.map((/**
         * @param {?} item
         * @return {?}
         */
        item => {
            /** @type {?} */
            const rtn = Object.assign({}, item);
            if (item.field === FAVORITE_FIELD_NAME) {
                rtn.formatter = (/**
                 * @return {?}
                 */
                () => FavoriteIcon.delete);
            }
            return rtn;
        }));
        return columns;
    }
    /**
     * @return {?}
     */
    initPersonalInfo() {
        if (this.instance.personalConfigService) {
            /** @type {?} */
            const controlID = this.instance.el.nativeElement.id || this.instance.controlId;
            if (!controlID) {
                console.log('LookupGrid - 未设置组件id, 收藏功能将不能正常，请设置组件id.');
            }
            /** @type {?} */
            const pcstr = this.getPersonalConfigKey(controlID);
            this.instance.personalConfigService.controlID = controlID;
            this.instance.personalConfigService.personalConfigKey = pcstr;
            /** @type {?} */
            const conf = {
                displayType: this.instance.displayType,
                singleSelect: this.instance.singleSelect,
                idField: this.instance.idField,
                textField: this.instance.textField,
                mapFields: Object.assign({}, this.instance.mapFields || {})
            };
            this.instance.personalConfigService.initPersonalConf(conf);
            // 个性化配置的订阅事件处理
            this.listenPersonalConfigHandler();
        }
    }
    /**
     * @private
     * @param {?} controlID
     * @return {?}
     */
    getPersonalConfigKey(controlID) {
        // return this.instance.ngControl && this.instance.ngControl.name ? this.instance.ngControl.name : this.instance.mapFields
        //     ? this.instance.mapFields[this.instance.textField]
        //     : '';
        if (this.instance.ngControl) {
            if (this.instance.ngControl.name) {
                return this.instance.ngControl.name;
            }
            else {
                if (this.instance.mapFields && this.instance.mapFields.length) {
                    return Object.keys(this.instance.mapFields).map((/**
                     * @param {?} k
                     * @return {?}
                     */
                    k => {
                        return this.instance.mapFields[k];
                    })).join('_');
                }
                else {
                    return this.instance.textField;
                }
            }
        }
        else {
            return '';
        }
    }
    /**
     * 监听收藏TAB页中相关事件；
     * 数据选中，取消选中，移除收藏，双击事件
     * @param {?} cmpRef
     * @return {?}
     */
    initFavoriteComponentEvent(cmpRef) {
        switch (this.instance.displayType) {
            case LookupGridDisplayType.NavList:
            case LookupGridDisplayType.NavTreeList:
            case LookupGridDisplayType.List: {
                /** @type {?} */
                const fdt = (/** @type {?} */ (cmpRef.instance));
                fdt.remoteSort = false;
                fdt.selectedRow.subscribe((/**
                 * @param {?} e
                 * @return {?}
                 */
                e => {
                    if (this.instance.singleSelect) {
                        this.lookupSelectionSer.clearSelections();
                    }
                    this.lookupSelectionSer.updateSelections(e.data);
                }));
                fdt.unSelectRow.subscribe((/**
                 * @param {?} e
                 * @return {?}
                 */
                e => {
                    this.lookupSelectionSer.unSelect(e.data[this.instance.idField]);
                }));
                if (!fdt.singleSelect) {
                    fdt.checkAll.subscribe((/**
                     * @param {?} e
                     * @return {?}
                     */
                    e => {
                        this.lookupSelectionSer.updateSelections(fdt.data, e);
                    }));
                }
                fdt.cellClick.subscribe((/**
                 * @param {?} e
                 * @return {?}
                 */
                (e) => {
                    if (e.col.field === FAVORITE_FIELD_NAME) {
                        e.event.stopPropagation();
                        // tslint:disable-next-line: no-string-literal
                        /** @type {?} */
                        const classList = e.event.target['classList'];
                        if (classList.contains('f-lookup-unfavorite')) {
                            if (this.instance.items) {
                                this.instance.items.forEach((/**
                                 * @param {?} item
                                 * @return {?}
                                 */
                                item => {
                                    if (item[this.instance.idField] === e.row[this.instance.idField]) {
                                        item[FAVORITE_FIELD_NAME] = false;
                                    }
                                }));
                                /** @type {?} */
                                const dt = (/** @type {?} */ (this.instance.componentRef.instance));
                                if (dt) {
                                    dt.loadData({
                                        pageSize: this.instance.gridOptions.pageSize,
                                        pageIndex: this.instance.gridOptions.pageIndex,
                                        total: this.instance.gridOptions.total,
                                        data: this.instance.gridOptions.items
                                    });
                                }
                            }
                            this.instance.favoriteItems =
                                this.instance.favoriteItems.filter((/**
                                 * @param {?} n
                                 * @return {?}
                                 */
                                n => n[this.instance.idField] !== e.row[this.instance.idField]));
                            this.lookupSelectionSer.updateFavoriteData(e.row, FavoriteAction.delete);
                        }
                    }
                }));
                // 双击事件
                fdt.rowDblClick.subscribe((/**
                 * @param {?} rowData
                 * @return {?}
                 */
                (rowData) => {
                    if (this.instance.gridOptions.singleSelect) {
                        this.instance.selectItem(rowData);
                    }
                }));
                break;
            }
            case LookupGridDisplayType.TreeList: {
                if (cmpRef) {
                    /** @type {?} */
                    const ftt = (/** @type {?} */ (cmpRef.instance));
                    ftt.remoteSort = false;
                    ftt.nodeSelected.subscribe((/**
                     * @param {?} e
                     * @return {?}
                     */
                    e => {
                        if (this.instance.singleSelect) {
                            this.lookupSelectionSer.clearSelections();
                        }
                        this.lookupSelectionSer.updateSelections(e.node.data);
                    }));
                    ftt.nodeUnChecked.subscribe((/**
                     * @param {?} e
                     * @return {?}
                     */
                    e => {
                        if (e && e.node && e.node.data && e.node.data.id) {
                            // const tt = this.instance.componentRef.instance as TreeTableComponent;
                            // tt.unSelectNode(e.node.data.id);
                            this.lookupSelectionSer.unSelect(e.node.data.id);
                        }
                    }));
                    ftt.nodeChecked.subscribe((/**
                     * @param {?} e
                     * @return {?}
                     */
                    e => {
                        if (!this.instance.singleSelect) {
                            if (e.nodes && e.nodes.length) {
                                this.instance.multiSelMgr.updateSelections(e.nodes.map((/**
                                 * @param {?} n
                                 * @return {?}
                                 */
                                n => n.data)));
                            }
                            else {
                                if (Array.isArray(e.node)) {
                                    this.instance.multiSelMgr.updateSelections(e.node.map((/**
                                     * @param {?} n
                                     * @return {?}
                                     */
                                    n => n.data)));
                                }
                                else {
                                    this.instance.multiSelMgr.updateSelections([e.node.data]);
                                }
                            }
                        }
                    }));
                    ftt.cellClick.subscribe((/**
                     * @param {?} row
                     * @return {?}
                     */
                    row => {
                        if (row.col.field === FAVORITE_FIELD_NAME) {
                            row.event.stopPropagation();
                            /** @type {?} */
                            const classList = row.event.target['classList'];
                            if (classList.contains('f-lookup-unfavorite')) {
                                /** @type {?} */
                                const _this = this.instance;
                                ((/**
                                 * @param {?} items
                                 * @return {?}
                                 */
                                function every(items) {
                                    /** @type {?} */
                                    let hasFinish = false;
                                    items.forEach((/**
                                     * @param {?} item
                                     * @return {?}
                                     */
                                    item => {
                                        if (hasFinish) {
                                            return;
                                        }
                                        if (item.data[_this.idField] === row.node[_this.idField]) {
                                            item.data[FAVORITE_FIELD_NAME] = false;
                                            hasFinish = true;
                                        }
                                        else if (item.children && item.children.length > 0) {
                                            every(item.children);
                                        }
                                    }));
                                }))(this.instance.items);
                                /** @type {?} */
                                const tt = (/** @type {?} */ (this.instance.componentRef.instance));
                                tt.loadData(this.instance.items);
                                this.lookupSelectionSer.updateFavoriteData(row.node.data, FavoriteAction.delete);
                            }
                        }
                    }));
                    ftt.dblClick.subscribe((/**
                     * @param {?} treeNode
                     * @return {?}
                     */
                    (treeNode) => {
                        if (this.instance.gridOptions.singleSelect && treeNode.selectable) {
                            if (this.instance.okButton) {
                                this.instance.okButton.nativeElement.click();
                            }
                        }
                    }));
                }
            }
        }
    }
    /**
     * @private
     * @return {?}
     */
    getFavoritData() {
        if (this.instance.personalConf) {
            /** @type {?} */
            const favData = this.instance.personalConf.favorite;
            /** @type {?} */
            const _data = (favData && favData[this.instance.localService.localeId]) ? favData[this.instance.localService.localeId] : [];
            return _data;
        }
        return [];
    }
    /**
     * @return {?}
     */
    getFavoritIds() {
        return this.getFavoritData();
    }
    /**
     * @param {?=} data
     * @return {?}
     */
    _loadFavoriteData(data = null) {
        /** @type {?} */
        const fdt = (/** @type {?} */ (this.instance.favoritesComponentRef.instance));
        this.loadFavoriteDatatable(fdt, data);
        fdt.cd.markForCheck();
        this.instance.closeLoading();
    }
    // 加载收藏grid数据
    /**
     * @param {?=} res
     * @return {?}
     */
    loadFavoritesData(res = null) {
        /** @type {?} */
        const favIds = this.getFavoritIds();
        switch (this.instance.displayType) {
            case LookupGridDisplayType.NavList:
            case LookupGridDisplayType.NavTreeList:
            case LookupGridDisplayType.List: {
                /** @type {?} */
                const fdt = (/** @type {?} */ (this.instance.favoritesComponentRef.instance));
                if (this.instance.favoriteDataFrom === 'locale') {
                    if (res) {
                        this._loadFavoriteData(res.items);
                    }
                    else {
                        // this.instance.httpMgr.getFavoriteData(favIds).subscribe(resData => {
                        //     if (resData) {
                        //         this._loadFavoriteData(resData.items);
                        //     }
                        //     this.instance.closeLoading();
                        // });
                    }
                }
                else {
                    /** @type {?} */
                    const favData = this.getFavoritData();
                    this.loadFavoriteDatatable(fdt, res ? res.items : favData);
                }
                break;
            }
            case LookupGridDisplayType.TreeList: {
                if (this.instance.favoritesComponentRef && this.instance.favoritesComponentRef.instance instanceof TreeTableComponent) {
                    /** @type {?} */
                    const ftt = (/** @type {?} */ (this.instance.favoritesComponentRef.instance));
                    this.bindFavTreetable(ftt);
                    if (this.instance.favoriteDataFrom === 'locale') {
                        if (res) {
                            this.loadFavoriteForTreeTable(res.items || [], ftt);
                        }
                        else {
                            // this.instance.httpMgr.getFavoriteData(favIds).subscribe(resData => {
                            //     if (resData) {
                            //         const items = resData.items;
                            //         this.loadFavoriteForTreeTable(items, ftt);
                            //     }
                            //     this.instance.closeLoading();
                            // });
                        }
                    }
                    else {
                        if (res) {
                            this.loadFavoriteForTreeTable(res.items, ftt);
                        }
                    }
                }
            }
        }
    }
    /**
     * @private
     * @param {?} fdt
     * @param {?=} data
     * @return {?}
     */
    loadFavoriteDatatable(fdt, data) {
        if (data !== undefined) {
            this.instance.favoriteItems = data;
        }
        if (fdt.columns && !fdt.columns.length) {
            fdt.columns = this.instance.favoriteColumns;
        }
        fdt.loadData({
            total: 0,
            pageSize: 20,
            pageIndex: 1,
            data: this.instance.favoriteItems
        });
        this.instance.selectionMgr.selectCurrentValue();
        fdt.cd.detectChanges();
    }
    /**
     * @private
     * @param {?} ftt
     * @return {?}
     */
    bindFavTreetable(ftt) {
        ftt.allColumnsTitle = this.instance.allColumnsTitle;
        ftt.idField = this.instance.idField;
        /** @type {?} */
        const columns = this.instance.gridOptions.columns.map((/**
         * @param {?} item
         * @return {?}
         */
        item => {
            /** @type {?} */
            const rtn = Object.assign({}, item);
            if (item.field === FAVORITE_FIELD_NAME) {
                rtn.formatter = (/**
                 * @param {?} v
                 * @param {?} data
                 * @return {?}
                 */
                (v, data) => {
                    /** @type {?} */
                    const favids = this.getFavoritIds();
                    if (favids && favids.length) {
                        /** @type {?} */
                        const index = favids.findIndex((/**
                         * @param {?} el
                         * @return {?}
                         */
                        el => el === data[this.instance.idField]));
                        if (index >= 0) {
                            return FavoriteIcon.delete;
                        }
                    }
                    return '';
                });
            }
            return rtn;
        }));
        this.instance.favoriteColumns = columns;
        ftt.columns = columns;
        if (this.instance.gridOptions.treeInfo) {
            ftt.onlySelectLeaf = this.instance.gridOptions.treeInfo.onlySelectLeaf;
        }
        if (!ftt.singleSelect) {
            ftt.checkOnSelect = true;
            ftt.selectOnCheck = true;
            ftt.showCheckbox = true;
            // 启用多选后，同时启用级联选择
            // 启用多选后，同时启用级联选择
            if (this.instance.enableCascade) {
                this.instance.ttEventMgr.cascadeValueChanged(this.instance.cascadeStatus);
            }
            else {
                ftt.cascadeCheck = false;
                ftt.cascadeDown = false;
                ftt.cascadeUp = false;
            }
        }
    }
    /**
     * @param {?} items
     * @return {?}
     */
    initFavoriteTreeData(items) {
        /** @type {?} */
        const treeInfo = this.instance.gridOptions.treeInfo;
        if (treeInfo && !treeInfo['treeDataIsInit']) {
            if (treeInfo.layerType.toLowerCase() === 'pathcode') {
                items = this.instance.lookupUtils.makeTree(items, treeInfo);
            }
            else {
                items = this.instance.lookupUtils.makeTreeWithParentID(items, '', `${treeInfo.dataField}.${treeInfo.parentField}`, this.instance.idField);
            }
        }
        return this.instance.checkNodeCanBeSelect(items, true);
    }
    /**
     * @param {?} items
     * @param {?} ftt
     * @return {?}
     */
    loadFavoriteForTreeTable(items, ftt) {
        items = this.initFavoriteTreeData(items);
        this.instance.favoriteItems = items;
        ftt.loadData(items);
        ftt.expandAll();
        this.instance.selectionMgr.selectCurrentValue();
        return items;
    }
    // 更新列表中的收藏数据标识
    /**
     * @param {?} data
     * @return {?}
     */
    updateFavoritesStatus(data) {
        if (!data || !this.instance.useFavorite) {
            return;
        }
        /** @type {?} */
        const favIds = this.getFavoritIds();
        if (favIds && favIds.length) {
            // 处理数据列表中的收藏数据标识
            if (this.instance.displayType !== LookupGridDisplayType.TreeList) {
                data.map((/**
                 * @param {?} item
                 * @return {?}
                 */
                item => {
                    if (favIds && favIds.length && favIds.find((/**
                     * @param {?} v
                     * @return {?}
                     */
                    v => v === item[this.instance.idField]))) {
                        item[FAVORITE_FIELD_NAME] = true;
                    }
                }));
            }
            else {
                /** @type {?} */
                const _this = this.instance;
                ((/**
                 * @param {?} _data
                 * @return {?}
                 */
                function each(_data) {
                    _data.forEach((/**
                     * @param {?} item
                     * @return {?}
                     */
                    item => {
                        if (favIds && favIds.length && favIds.find((/**
                         * @param {?} v
                         * @return {?}
                         */
                        v => v === item.data[_this.idField]))) {
                            item.data[FAVORITE_FIELD_NAME] = true;
                        }
                        if (item.children && item.children.length > 0) {
                            each(item.children);
                        }
                    }));
                }))(data);
            }
        }
    }
    /**
     * @private
     * @param {?} value
     * @param {?} action
     * @return {?}
     */
    _updateFavorites(value, action) {
        /** @type {?} */
        const localeID = this.instance.localService.localeId;
        this.instance.personalConf.favorite = this.instance.personalConf.favorite || {};
        /** @type {?} */
        const items = value.filter((/**
         * @param {?} n
         * @return {?}
         */
        n => !n['_addtional_']));
        /** @type {?} */
        const newVal = items.map((/**
         * @param {?} n
         * @return {?}
         */
        n => n[this.instance.idField])).filter((/**
         * @param {?} n
         * @return {?}
         */
        n => n !== null && n !== undefined));
        // const favIds = this.instance.personalConf.favorite[localeID] || [];
        this.instance.personalConf.favorite[localeID] = newVal;
        return newVal;
    }
    // 收藏数据管理
    /**
     * @private
     * @return {?}
     */
    listenPersonalConfigHandler() {
        this.lookupSelectionSer.favoriteItems$.subscribe((/**
         * @param {?} n
         * @return {?}
         */
        n => {
            if (!this.instance.favoritesComponentRef) {
                return;
            }
            const { items, action } = n;
            /** @type {?} */
            const favids = this._updateFavorites(items, action);
            this.instance.httpMgr.submitFavoriteData(action);
            if (this.instance.displayType === LookupGridDisplayType.List || this.instance.displayType.includes('NAV')) {
                /** @type {?} */
                const dt = (/** @type {?} */ (this.instance.favoritesComponentRef.instance));
                this.loadFavoriteDatatable(dt, items);
            }
            else if (this.instance.displayType === LookupGridDisplayType.TreeList) {
                /** @type {?} */
                const ftt = (/** @type {?} */ (this.instance.favoritesComponentRef.instance));
                // const favids = items.map(d => d.id);
                this.instance.showLoading();
                this.instance.httpMgr.getData({ favoriteIds: favids }, 'fav').subscribe((/**
                 * @param {?} resData
                 * @return {?}
                 */
                resData => {
                    if (resData) {
                        /** @type {?} */
                        const _items = resData.items;
                        this.loadFavoriteForTreeTable(_items, ftt);
                    }
                    else {
                        this.instance.favoriteItems = [];
                        ftt.loadData([]);
                    }
                    this.instance.closeLoading();
                }));
            }
        }));
    }
}
if (false) {
    /**
     * @type {?}
     * @private
     */
    FavoriteHelper.prototype.lookupSelectionSer;
    /** @type {?} */
    FavoriteHelper.prototype.favoriteColumnFormatter;
    /**
     * @type {?}
     * @private
     */
    FavoriteHelper.prototype.instance;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmF2b3JpdGUtaGVscGVyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy91aS1sb29rdXAvIiwic291cmNlcyI6WyJsaWIvc2VydmljZXMvZmF2b3JpdGUtaGVscGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFFQSxPQUFPLEVBQVksa0JBQWtCLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUVwRSxPQUFPLEVBQUUsY0FBYyxFQUFFLFlBQVksRUFBRSxtQkFBbUIsRUFBRSxxQkFBcUIsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBS2pILE1BQU0sT0FBTyxjQUFjOzs7O0lBSXZCLFlBQW9CLFFBQTZCO1FBQTdCLGFBQVEsR0FBUixRQUFRLENBQXFCO1FBZWpELDRCQUF1Qjs7Ozs7UUFBRyxDQUFDLENBQU0sRUFBRSxJQUFTLEVBQUksRUFBRTs7a0JBQ3hDLENBQUMsR0FBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLFlBQVksQ0FBQyxFQUFFO1lBQ2pELElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEVBQUUsRUFBRTs7c0JBQ2xCLEVBQUUsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUM7Z0JBQ3RDLElBQUksRUFBRSxFQUFFOzswQkFDRSxFQUFFLEdBQUcsbUJBQUEsSUFBSSxDQUFDLFFBQVEsQ0FBQyxZQUFZLENBQUMsUUFBUSxFQUFzQjs7MEJBQzlELEVBQUUsR0FBRyxFQUFFLENBQUMsV0FBVyxDQUFDLEVBQUUsQ0FBQztvQkFDN0IsSUFBSSxFQUFFLEVBQUU7d0JBQ0osSUFBSSxFQUFFLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRTs0QkFDcEIsT0FBTyxDQUFDLENBQUM7eUJBQ1o7NkJBQU07NEJBQ0gsT0FBTyxFQUFFLENBQUM7eUJBQ2I7cUJBQ0o7aUJBQ0o7YUFDSjtZQUNELE9BQU8sQ0FBQyxDQUFDO1FBQ2IsQ0FBQyxFQUFBO1FBL0JHLElB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b20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBEYXRhVGFibGVDb21wb25lbnQgfSBmcm9tICdAZmFycmlzL3VpLWRhdGF0YWJsZSc7XHJcbmltcG9ydCB7IFRyZWVOb2RlLCBUcmVlVGFibGVDb21wb25lbnQgfSBmcm9tICdAZmFycmlzL3VpLXRyZWV0YWJsZSc7XHJcbmltcG9ydCB7IFVzZXJGYXZvcml0ZURhdGEgfSBmcm9tICcuLi9odHRwL1JlbW90ZVBhcmFtcyc7XHJcbmltcG9ydCB7IEZhdm9yaXRlQWN0aW9uLCBGYXZvcml0ZUljb24sIEZBVk9SSVRFX0ZJRUxEX05BTUUsIExvb2t1cEdyaWREaXNwbGF5VHlwZSB9IGZyb20gJy4uL2xvb2t1cC1kaXNwbGF5dHlwZSc7XHJcbmltcG9ydCB7IExvb2t1cEdyaWRSZXN1bHQgfSBmcm9tICcuLi9sb29rdXAtZ3JpZC1vcHRpb25zJztcclxuaW1wb3J0IHsgTG9va3VwR3JpZENvbXBvbmVudCB9IGZyb20gJy4uL2xvb2t1cC1ncmlkLmNvbXBvbmVudCc7XHJcbmltcG9ydCB7IExvb2t1cFNlbGVjdGlvblNlcnZpY2UgfSBmcm9tICcuL2xvb2t1cC1zZWxlY3Rpb24uc2VydmljZSc7XHJcblxyXG5leHBvcnQgY2xhc3MgRmF2b3JpdGVIZWxwZXIge1xyXG5cclxuICAgIHByaXZhdGUgbG9va3VwU2VsZWN0aW9uU2VyOiBMb29rdXBTZWxlY3Rpb25TZXJ2aWNlO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgaW5zdGFuY2U6IExvb2t1cEdyaWRDb21wb25lbnQpIHtcclxuICAgICAgICB0aGlzLmxvb2t1cFNlbGVjdGlvblNlciA9IHRoaXMuaW5zdGFuY2UubG9va3VwU2VsZWN0aW9uU2VyO1xyXG4gICAgfVxyXG5cclxuICAgIGdldEZhdm9yaXRlQ29sdW1ucygpOiBhbnlbXSB7XHJcbiAgICAgICAgY29uc3QgY29sdW1ucyA9IHRoaXMuaW5zdGFuY2UuZ3JpZE9wdGlvbnMuY29sdW1ucy5tYXAoaXRlbSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHJ0biA9IE9iamVjdC5hc3NpZ24oe30sIGl0ZW0pO1xyXG4gICAgICAgICAgICBpZiAoaXRlbS5maWVsZCA9PT0gRkFWT1JJVEVfRklFTERfTkFNRSkge1xyXG4gICAgICAgICAgICAgICAgcnRuLmZvcm1hdHRlciA9ICgpID0+IEZhdm9yaXRlSWNvbi5kZWxldGU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIHJ0bjtcclxuICAgICAgICB9KTtcclxuICAgICAgICByZXR1cm4gY29sdW1ucztcclxuICAgIH1cclxuXHJcbiAgICBmYXZvcml0ZUNvbHVtbkZvcm1hdHRlciA9ICh2OiBhbnksIGRhdGE6IGFueSAgKSA9PiB7XHJcbiAgICAgICAgY29uc3QgZiA9ICB2ID8gRmF2b3JpdGVJY29uLnllcyA6IEZhdm9yaXRlSWNvbi5ubztcclxuICAgICAgICBpZiAodGhpcy5pbnN0YW5jZS5pc1RyZWUoKSkge1xyXG4gICAgICAgICAgICBjb25zdCBpZCA9IGRhdGFbdGhpcy5pbnN0YW5jZS5pZEZpZWxkXTtcclxuICAgICAgICAgICAgaWYgKGlkKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCB0dCA9IHRoaXMuaW5zdGFuY2UuY29tcG9uZW50UmVmLmluc3RhbmNlIGFzIFRyZWVUYWJsZUNvbXBvbmVudDtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHJuID0gdHQuZmluZFJvd05vZGUoaWQpO1xyXG4gICAgICAgICAgICAgICAgaWYgKHJuKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJuLm5vZGUuc2VsZWN0YWJsZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZjtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJyc7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBmO1xyXG4gICAgfVxyXG5cclxuICAgIGluaXRQZXJzb25hbEluZm8oKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuaW5zdGFuY2UucGVyc29uYWxDb25maWdTZXJ2aWNlKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGNvbnRyb2xJRCA9IHRoaXMuaW5zdGFuY2UuZWwubmF0aXZlRWxlbWVudC5pZCB8fCB0aGlzLmluc3RhbmNlLmNvbnRyb2xJZDtcclxuICAgICAgICAgICAgaWYgKCFjb250cm9sSUQpIHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdMb29rdXBHcmlkIC0g5pyq6K6+572u57uE5Lu2aWQsIOaUtuiXj+WKn+iDveWwhuS4jeiDveato+W4uO+8jOivt+iuvue9rue7hOS7tmlkLicpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNvbnN0IHBjc3RyID0gdGhpcy5nZXRQZXJzb25hbENvbmZpZ0tleShjb250cm9sSUQpO1xyXG4gICAgICAgICAgICB0aGlzLmluc3RhbmNlLnBlcnNvbmFsQ29uZmlnU2VydmljZS5jb250cm9sSUQgPSBjb250cm9sSUQ7XHJcbiAgICAgICAgICAgIHRoaXMuaW5zdGFuY2UucGVyc29uYWxDb25maWdTZXJ2aWNlLnBlcnNvbmFsQ29uZmlnS2V5ID0gcGNzdHI7XHJcblxyXG4gICAgICAgICAgICBjb25zdCBjb25mID0ge1xyXG4gICAgICAgICAgICAgICAgZGlzcGxheVR5cGU6IHRoaXMuaW5zdGFuY2UuZGlzcGxheVR5cGUsXHJcbiAgICAgICAgICAgICAgICBzaW5nbGVTZWxlY3Q6IHRoaXMuaW5zdGFuY2Uuc2luZ2xlU2VsZWN0LFxyXG4gICAgICAgICAgICAgICAgaWRGaWVsZDogdGhpcy5pbnN0YW5jZS5pZEZpZWxkLFxyXG4gICAgICAgICAgICAgICAgdGV4dEZpZWxkOiB0aGlzLmluc3RhbmNlLnRleHRGaWVsZCxcclxuICAgICAgICAgICAgICAgIG1hcEZpZWxkczogT2JqZWN0LmFzc2lnbih7fSwgdGhpcy5pbnN0YW5jZS5tYXBGaWVsZHMgfHwge30pXHJcbiAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICB0aGlzLmluc3RhbmNlLnBlcnNvbmFsQ29uZmlnU2VydmljZS5pbml0UGVyc29uYWxDb25mKGNvbmYpO1xyXG5cclxuICAgICAgICAgICAgLy8g5Liq5oCn5YyW6YWN572u55qE6K6i6ZiF5LqL5Lu25aSE55CGXHJcbiAgICAgICAgICAgIHRoaXMubGlzdGVuUGVyc29uYWxDb25maWdIYW5kbGVyKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZ2V0UGVyc29uYWxDb25maWdLZXkoY29udHJvbElEKSB7XHJcbiAgICAgICAgLy8gcmV0dXJuIHRoaXMuaW5zdGFuY2UubmdDb250cm9sICYmIHRoaXMuaW5zdGFuY2UubmdDb250cm9sLm5hbWUgPyB0aGlzLmluc3RhbmNlLm5nQ29udHJvbC5uYW1lIDogdGhpcy5pbnN0YW5jZS5tYXBGaWVsZHNcclxuICAgICAgICAvLyAgICAgPyB0aGlzLmluc3RhbmNlLm1hcEZpZWxkc1t0aGlzLmluc3RhbmNlLnRleHRGaWVsZF1cclxuICAgICAgICAvLyAgICAgOiAnJztcclxuXHJcbiAgICAgICAgaWYgKHRoaXMuaW5zdGFuY2UubmdDb250cm9sKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmluc3RhbmNlLm5nQ29udHJvbC5uYW1lKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5pbnN0YW5jZS5uZ0NvbnRyb2wubmFtZTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLmluc3RhbmNlLm1hcEZpZWxkcyAmJiB0aGlzLmluc3RhbmNlLm1hcEZpZWxkcy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gT2JqZWN0LmtleXModGhpcy5pbnN0YW5jZS5tYXBGaWVsZHMpLm1hcChrID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuaW5zdGFuY2UubWFwRmllbGRzW2tdO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pLmpvaW4oJ18nKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuaW5zdGFuY2UudGV4dEZpZWxkO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuICcnO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDnm5HlkKzmlLbol49UQULpobXkuK3nm7jlhbPkuovku7bvvJtcclxuICAgICAqIOaVsOaNrumAieS4re+8jOWPlua2iOmAieS4re+8jOenu+mZpOaUtuiXj++8jOWPjOWHu+S6i+S7tlxyXG4gICAgICovXHJcbiAgICBpbml0RmF2b3JpdGVDb21wb25lbnRFdmVudChjbXBSZWY6IENvbXBvbmVudFJlZjxhbnk+KSB7XHJcbiAgICAgICAgc3dpdGNoICh0aGlzLmluc3RhbmNlLmRpc3BsYXlUeXBlKSB7XHJcbiAgICAgICAgICAgIGNhc2UgTG9va3VwR3JpZERpc3BsYXlUeXBlLk5hdkxpc3Q6XHJcbiAgICAgICAgICAgIGNhc2UgTG9va3VwR3JpZERpc3BsYXlUeXBlLk5hdlRyZWVMaXN0OlxyXG4gICAgICAgICAgICBjYXNlIExvb2t1cEdyaWREaXNwbGF5VHlwZS5MaXN0OiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBmZHQgPSBjbXBSZWYuaW5zdGFuY2UgYXMgRGF0YVRhYmxlQ29tcG9uZW50O1xyXG4gICAgICAgICAgICAgICAgZmR0LnJlbW90ZVNvcnQgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgIGZkdC5zZWxlY3RlZFJvdy5zdWJzY3JpYmUoZSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuaW5zdGFuY2Uuc2luZ2xlU2VsZWN0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubG9va3VwU2VsZWN0aW9uU2VyLmNsZWFyU2VsZWN0aW9ucygpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmxvb2t1cFNlbGVjdGlvblNlci51cGRhdGVTZWxlY3Rpb25zKGUuZGF0YSk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIGZkdC51blNlbGVjdFJvdy5zdWJzY3JpYmUoZSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb29rdXBTZWxlY3Rpb25TZXIudW5TZWxlY3QoZS5kYXRhW3RoaXMuaW5zdGFuY2UuaWRGaWVsZF0pO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKCFmZHQuc2luZ2xlU2VsZWN0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZmR0LmNoZWNrQWxsLnN1YnNjcmliZShlID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sb29rdXBTZWxlY3Rpb25TZXIudXBkYXRlU2VsZWN0aW9ucyhmZHQuZGF0YSwgZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgZmR0LmNlbGxDbGljay5zdWJzY3JpYmUoKGU6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChlLmNvbC5maWVsZCA9PT0gRkFWT1JJVEVfRklFTERfTkFNRSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBlLmV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IG5vLXN0cmluZy1saXRlcmFsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNsYXNzTGlzdCA9IGUuZXZlbnQudGFyZ2V0WydjbGFzc0xpc3QnXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNsYXNzTGlzdC5jb250YWlucygnZi1sb29rdXAtdW5mYXZvcml0ZScpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5pbnN0YW5jZS5pdGVtcykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaW5zdGFuY2UuaXRlbXMuZm9yRWFjaChpdGVtID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW1bdGhpcy5pbnN0YW5jZS5pZEZpZWxkXSA9PT0gZS5yb3dbdGhpcy5pbnN0YW5jZS5pZEZpZWxkXSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbVtGQVZPUklURV9GSUVMRF9OQU1FXSA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGR0ID0gdGhpcy5pbnN0YW5jZS5jb21wb25lbnRSZWYuaW5zdGFuY2UgYXMgRGF0YVRhYmxlQ29tcG9uZW50O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkdCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkdC5sb2FkRGF0YSh7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYWdlU2l6ZTogdGhpcy5pbnN0YW5jZS5ncmlkT3B0aW9ucy5wYWdlU2l6ZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhZ2VJbmRleDogdGhpcy5pbnN0YW5jZS5ncmlkT3B0aW9ucy5wYWdlSW5kZXgsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b3RhbDogdGhpcy5pbnN0YW5jZS5ncmlkT3B0aW9ucy50b3RhbCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGE6IHRoaXMuaW5zdGFuY2UuZ3JpZE9wdGlvbnMuaXRlbXNcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaW5zdGFuY2UuZmF2b3JpdGVJdGVtcyA9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnN0YW5jZS5mYXZvcml0ZUl0ZW1zLmZpbHRlcihuID0+IG5bdGhpcy5pbnN0YW5jZS5pZEZpZWxkXSAhPT0gZS5yb3dbdGhpcy5pbnN0YW5jZS5pZEZpZWxkXSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sb29rdXBTZWxlY3Rpb25TZXIudXBkYXRlRmF2b3JpdGVEYXRhKGUucm93LCBGYXZvcml0ZUFjdGlvbi5kZWxldGUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgLy8g5Y+M5Ye75LqL5Lu2XHJcbiAgICAgICAgICAgICAgICBmZHQucm93RGJsQ2xpY2suc3Vic2NyaWJlKChyb3dEYXRhOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5pbnN0YW5jZS5ncmlkT3B0aW9ucy5zaW5nbGVTZWxlY3QpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnN0YW5jZS5zZWxlY3RJdGVtKHJvd0RhdGEpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2FzZSBMb29rdXBHcmlkRGlzcGxheVR5cGUuVHJlZUxpc3Q6IHtcclxuICAgICAgICAgICAgICAgIGlmIChjbXBSZWYpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBmdHQgPSBjbXBSZWYuaW5zdGFuY2UgYXMgVHJlZVRhYmxlQ29tcG9uZW50O1xyXG4gICAgICAgICAgICAgICAgICAgIGZ0dC5yZW1vdGVTb3J0ID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgZnR0Lm5vZGVTZWxlY3RlZC5zdWJzY3JpYmUoZSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmluc3RhbmNlLnNpbmdsZVNlbGVjdCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sb29rdXBTZWxlY3Rpb25TZXIuY2xlYXJTZWxlY3Rpb25zKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sb29rdXBTZWxlY3Rpb25TZXIudXBkYXRlU2VsZWN0aW9ucyhlLm5vZGUuZGF0YSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgZnR0Lm5vZGVVbkNoZWNrZWQuc3Vic2NyaWJlKGUgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZSAmJiBlLm5vZGUgJiYgZS5ub2RlLmRhdGEgJiYgZS5ub2RlLmRhdGEuaWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNvbnN0IHR0ID0gdGhpcy5pbnN0YW5jZS5jb21wb25lbnRSZWYuaW5zdGFuY2UgYXMgVHJlZVRhYmxlQ29tcG9uZW50O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdHQudW5TZWxlY3ROb2RlKGUubm9kZS5kYXRhLmlkKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubG9va3VwU2VsZWN0aW9uU2VyLnVuU2VsZWN0KGUubm9kZS5kYXRhLmlkKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBmdHQubm9kZUNoZWNrZWQuc3Vic2NyaWJlKCBlID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmluc3RhbmNlLnNpbmdsZVNlbGVjdCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGUubm9kZXMgJiYgZS5ub2Rlcy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmluc3RhbmNlLm11bHRpU2VsTWdyLnVwZGF0ZVNlbGVjdGlvbnMoZS5ub2Rlcy5tYXAobiA9PiBuLmRhdGEpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZS5ub2RlKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmluc3RhbmNlLm11bHRpU2VsTWdyLnVwZGF0ZVNlbGVjdGlvbnMoZS5ub2RlLm1hcChuID0+IG4uZGF0YSkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaW5zdGFuY2UubXVsdGlTZWxNZ3IudXBkYXRlU2VsZWN0aW9ucyhbZS5ub2RlLmRhdGFdKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgZnR0LmNlbGxDbGljay5zdWJzY3JpYmUocm93ID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJvdy5jb2wuZmllbGQgPT09IEZBVk9SSVRFX0ZJRUxEX05BTUUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJvdy5ldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNsYXNzTGlzdCA9IHJvdy5ldmVudC50YXJnZXRbJ2NsYXNzTGlzdCddO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNsYXNzTGlzdC5jb250YWlucygnZi1sb29rdXAtdW5mYXZvcml0ZScpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgX3RoaXMgPSB0aGlzLmluc3RhbmNlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChmdW5jdGlvbiBldmVyeShpdGVtcykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgaGFzRmluaXNoID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1zLmZvckVhY2goaXRlbSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGFzRmluaXNoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW0uZGF0YVtfdGhpcy5pZEZpZWxkXSA9PT0gcm93Lm5vZGVbX3RoaXMuaWRGaWVsZF0pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtLmRhdGFbRkFWT1JJVEVfRklFTERfTkFNRV0gPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYXNGaW5pc2ggPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpdGVtLmNoaWxkcmVuICYmIGl0ZW0uY2hpbGRyZW4ubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZXJ5KGl0ZW0uY2hpbGRyZW4pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KSh0aGlzLmluc3RhbmNlLml0ZW1zKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0dCA9IHRoaXMuaW5zdGFuY2UuY29tcG9uZW50UmVmLmluc3RhbmNlIGFzIFRyZWVUYWJsZUNvbXBvbmVudDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0dC5sb2FkRGF0YSh0aGlzLmluc3RhbmNlLml0ZW1zKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sb29rdXBTZWxlY3Rpb25TZXIudXBkYXRlRmF2b3JpdGVEYXRhKHJvdy5ub2RlLmRhdGEsIEZhdm9yaXRlQWN0aW9uLmRlbGV0ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICBmdHQuZGJsQ2xpY2suc3Vic2NyaWJlKCh0cmVlTm9kZTogVHJlZU5vZGUpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuaW5zdGFuY2UuZ3JpZE9wdGlvbnMuc2luZ2xlU2VsZWN0ICYmIHRyZWVOb2RlLnNlbGVjdGFibGUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmluc3RhbmNlLm9rQnV0dG9uKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnN0YW5jZS5va0J1dHRvbi5uYXRpdmVFbGVtZW50LmNsaWNrKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcblxyXG4gICAgcHJpdmF0ZSBnZXRGYXZvcml0RGF0YSgpIHtcclxuICAgICAgICBpZiAodGhpcy5pbnN0YW5jZS5wZXJzb25hbENvbmYpIHtcclxuICAgICAgICAgICAgY29uc3QgZmF2RGF0YSA9IHRoaXMuaW5zdGFuY2UucGVyc29uYWxDb25mLmZhdm9yaXRlO1xyXG4gICAgICAgICAgICBjb25zdCBfZGF0YSA9IChmYXZEYXRhICYmIGZhdkRhdGFbdGhpcy5pbnN0YW5jZS5sb2NhbFNlcnZpY2UubG9jYWxlSWRdKSA/IGZhdkRhdGFbdGhpcy5pbnN0YW5jZS5sb2NhbFNlcnZpY2UubG9jYWxlSWRdIDogW107XHJcbiAgICAgICAgICAgIHJldHVybiBfZGF0YTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIFtdO1xyXG4gICAgfVxyXG5cclxuICAgIGdldEZhdm9yaXRJZHMoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0RmF2b3JpdERhdGEoKTtcclxuICAgIH1cclxuXHJcbiAgICBfbG9hZEZhdm9yaXRlRGF0YShkYXRhID0gbnVsbCkge1xyXG4gICAgICAgIGNvbnN0IGZkdCA9IHRoaXMuaW5zdGFuY2UuZmF2b3JpdGVzQ29tcG9uZW50UmVmLmluc3RhbmNlIGFzIERhdGFUYWJsZUNvbXBvbmVudDtcclxuICAgICAgICB0aGlzLmxvYWRGYXZvcml0ZURhdGF0YWJsZShmZHQsIGRhdGEpO1xyXG4gICAgICAgIGZkdC5jZC5tYXJrRm9yQ2hlY2soKTtcclxuICAgICAgICB0aGlzLmluc3RhbmNlLmNsb3NlTG9hZGluZygpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIOWKoOi9veaUtuiXj2dyaWTmlbDmja5cclxuICAgIGxvYWRGYXZvcml0ZXNEYXRhKHJlcyA9IG51bGwpIHtcclxuICAgICAgICBjb25zdCBmYXZJZHMgPSB0aGlzLmdldEZhdm9yaXRJZHMoKTtcclxuICAgICAgICBzd2l0Y2ggKHRoaXMuaW5zdGFuY2UuZGlzcGxheVR5cGUpIHtcclxuICAgICAgICAgICAgY2FzZSBMb29rdXBHcmlkRGlzcGxheVR5cGUuTmF2TGlzdDpcclxuICAgICAgICAgICAgY2FzZSBMb29rdXBHcmlkRGlzcGxheVR5cGUuTmF2VHJlZUxpc3Q6XHJcbiAgICAgICAgICAgIGNhc2UgTG9va3VwR3JpZERpc3BsYXlUeXBlLkxpc3Q6IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGZkdCA9IHRoaXMuaW5zdGFuY2UuZmF2b3JpdGVzQ29tcG9uZW50UmVmLmluc3RhbmNlIGFzIERhdGFUYWJsZUNvbXBvbmVudDtcclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLmluc3RhbmNlLmZhdm9yaXRlRGF0YUZyb20gPT09ICdsb2NhbGUnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJlcykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9sb2FkRmF2b3JpdGVEYXRhKHJlcy5pdGVtcyk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gdGhpcy5pbnN0YW5jZS5odHRwTWdyLmdldEZhdm9yaXRlRGF0YShmYXZJZHMpLnN1YnNjcmliZShyZXNEYXRhID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gICAgIGlmIChyZXNEYXRhKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vICAgICAgICAgdGhpcy5fbG9hZEZhdm9yaXRlRGF0YShyZXNEYXRhLml0ZW1zKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gICAgIHRoaXMuaW5zdGFuY2UuY2xvc2VMb2FkaW5nKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZmF2RGF0YSA9IHRoaXMuZ2V0RmF2b3JpdERhdGEoKTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmxvYWRGYXZvcml0ZURhdGF0YWJsZShmZHQsIHJlcyA/IHJlcy5pdGVtcyA6IGZhdkRhdGEpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2FzZSBMb29rdXBHcmlkRGlzcGxheVR5cGUuVHJlZUxpc3Q6IHtcclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLmluc3RhbmNlLmZhdm9yaXRlc0NvbXBvbmVudFJlZiAmJiB0aGlzLmluc3RhbmNlLmZhdm9yaXRlc0NvbXBvbmVudFJlZi5pbnN0YW5jZSBpbnN0YW5jZW9mIFRyZWVUYWJsZUNvbXBvbmVudCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGZ0dCA9IHRoaXMuaW5zdGFuY2UuZmF2b3JpdGVzQ29tcG9uZW50UmVmLmluc3RhbmNlIGFzIFRyZWVUYWJsZUNvbXBvbmVudDtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmJpbmRGYXZUcmVldGFibGUoZnR0KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuaW5zdGFuY2UuZmF2b3JpdGVEYXRhRnJvbSA9PT0gJ2xvY2FsZScpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlcykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2FkRmF2b3JpdGVGb3JUcmVlVGFibGUocmVzLml0ZW1zIHx8IFtdLCBmdHQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdGhpcy5pbnN0YW5jZS5odHRwTWdyLmdldEZhdm9yaXRlRGF0YShmYXZJZHMpLnN1YnNjcmliZShyZXNEYXRhID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vICAgICBpZiAocmVzRGF0YSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gICAgICAgICBjb25zdCBpdGVtcyA9IHJlc0RhdGEuaXRlbXM7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAgICAgICAgIHRoaXMubG9hZEZhdm9yaXRlRm9yVHJlZVRhYmxlKGl0ZW1zLCBmdHQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vICAgICB0aGlzLmluc3RhbmNlLmNsb3NlTG9hZGluZygpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxvYWRGYXZvcml0ZUZvclRyZWVUYWJsZShyZXMuaXRlbXMsIGZ0dCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBsb2FkRmF2b3JpdGVEYXRhdGFibGUoZmR0OiBEYXRhVGFibGVDb21wb25lbnQsIGRhdGE/OiBhbnkpIHtcclxuICAgICAgICBpZiAoZGF0YSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgIHRoaXMuaW5zdGFuY2UuZmF2b3JpdGVJdGVtcyA9IGRhdGE7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoZmR0LmNvbHVtbnMgJiYgIWZkdC5jb2x1bW5zLmxlbmd0aCkge1xyXG4gICAgICAgICAgICBmZHQuY29sdW1ucyA9IHRoaXMuaW5zdGFuY2UuZmF2b3JpdGVDb2x1bW5zO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgZmR0LmxvYWREYXRhKHtcclxuICAgICAgICAgICAgdG90YWw6IDAsXHJcbiAgICAgICAgICAgIHBhZ2VTaXplOiAyMCxcclxuICAgICAgICAgICAgcGFnZUluZGV4OiAxLFxyXG4gICAgICAgICAgICBkYXRhOiB0aGlzLmluc3RhbmNlLmZhdm9yaXRlSXRlbXNcclxuICAgICAgICB9KTtcclxuXHJcblxyXG4gICAgICAgIHRoaXMuaW5zdGFuY2Uuc2VsZWN0aW9uTWdyLnNlbGVjdEN1cnJlbnRWYWx1ZSgpO1xyXG4gICAgICAgIGZkdC5jZC5kZXRlY3RDaGFuZ2VzKCk7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIHByaXZhdGUgYmluZEZhdlRyZWV0YWJsZShmdHQ6IFRyZWVUYWJsZUNvbXBvbmVudCkge1xyXG4gICAgICAgIGZ0dC5hbGxDb2x1bW5zVGl0bGUgPSB0aGlzLmluc3RhbmNlLmFsbENvbHVtbnNUaXRsZTtcclxuICAgICAgICBmdHQuaWRGaWVsZCA9IHRoaXMuaW5zdGFuY2UuaWRGaWVsZDtcclxuXHJcbiAgICAgICAgY29uc3QgY29sdW1ucyA9IHRoaXMuaW5zdGFuY2UuZ3JpZE9wdGlvbnMuY29sdW1ucy5tYXAoaXRlbSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHJ0bjogYW55ID0geyAuLi5pdGVtIH07XHJcbiAgICAgICAgICAgIGlmIChpdGVtLmZpZWxkID09PSBGQVZPUklURV9GSUVMRF9OQU1FKSB7XHJcbiAgICAgICAgICAgICAgICBydG4uZm9ybWF0dGVyID0gKHY6IGFueSwgZGF0YTogYW55KTogYW55ID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBmYXZpZHMgPSB0aGlzLmdldEZhdm9yaXRJZHMoKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZmF2aWRzICYmIGZhdmlkcy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaW5kZXggPSBmYXZpZHMuZmluZEluZGV4KGVsID0+IGVsID09PSBkYXRhW3RoaXMuaW5zdGFuY2UuaWRGaWVsZF0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5kZXggPj0gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhdm9yaXRlSWNvbi5kZWxldGU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICcnO1xyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gcnRuO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHRoaXMuaW5zdGFuY2UuZmF2b3JpdGVDb2x1bW5zID0gY29sdW1ucztcclxuICAgICAgICBmdHQuY29sdW1ucyA9IGNvbHVtbnM7XHJcblxyXG5cclxuICAgICAgICBpZiAodGhpcy5pbnN0YW5jZS5ncmlkT3B0aW9ucy50cmVlSW5mbykge1xyXG4gICAgICAgICAgICBmdHQub25seVNlbGVjdExlYWYgPSB0aGlzLmluc3RhbmNlLmdyaWRPcHRpb25zLnRyZWVJbmZvLm9ubHlTZWxlY3RMZWFmO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKCFmdHQuc2luZ2xlU2VsZWN0KSB7XHJcbiAgICAgICAgICAgIGZ0dC5jaGVja09uU2VsZWN0ID0gdHJ1ZTtcclxuICAgICAgICAgICAgZnR0LnNlbGVjdE9uQ2hlY2sgPSB0cnVlO1xyXG4gICAgICAgICAgICBmdHQuc2hvd0NoZWNrYm94ID0gdHJ1ZTtcclxuXHJcbiAgICAgICAgICAgIC8vIOWQr+eUqOWkmumAieWQju+8jOWQjOaXtuWQr+eUqOe6p+iBlOmAieaLqVxyXG4gICAgICAgICAgICAvLyDlkK/nlKjlpJrpgInlkI7vvIzlkIzml7blkK/nlKjnuqfogZTpgInmi6lcclxuICAgICAgICAgICAgaWYgKHRoaXMuaW5zdGFuY2UuZW5hYmxlQ2FzY2FkZSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5pbnN0YW5jZS50dEV2ZW50TWdyLmNhc2NhZGVWYWx1ZUNoYW5nZWQodGhpcy5pbnN0YW5jZS5jYXNjYWRlU3RhdHVzKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGZ0dC5jYXNjYWRlQ2hlY2sgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgIGZ0dC5jYXNjYWRlRG93biA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgZnR0LmNhc2NhZGVVcCA9IGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGluaXRGYXZvcml0ZVRyZWVEYXRhKGl0ZW1zKSB7XHJcbiAgICAgICAgY29uc3QgdHJlZUluZm8gPSB0aGlzLmluc3RhbmNlLmdyaWRPcHRpb25zLnRyZWVJbmZvO1xyXG5cclxuICAgICAgICBpZiAodHJlZUluZm8gJiYgIXRyZWVJbmZvWyd0cmVlRGF0YUlzSW5pdCddKSB7XHJcbiAgICAgICAgICAgIGlmICh0cmVlSW5mby5sYXllclR5cGUudG9Mb3dlckNhc2UoKSA9PT0gJ3BhdGhjb2RlJykge1xyXG4gICAgICAgICAgICAgICAgaXRlbXMgPSB0aGlzLmluc3RhbmNlLmxvb2t1cFV0aWxzLm1ha2VUcmVlKGl0ZW1zLCB0cmVlSW5mbyk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBpdGVtcyA9IHRoaXMuaW5zdGFuY2UubG9va3VwVXRpbHMubWFrZVRyZWVXaXRoUGFyZW50SUQoXHJcbiAgICAgICAgICAgICAgICAgICAgaXRlbXMsXHJcbiAgICAgICAgICAgICAgICAgICAgJycsXHJcbiAgICAgICAgICAgICAgICAgICAgYCR7dHJlZUluZm8uZGF0YUZpZWxkfS4ke3RyZWVJbmZvLnBhcmVudEZpZWxkfWAsXHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnN0YW5jZS5pZEZpZWxkXHJcbiAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB0aGlzLmluc3RhbmNlLmNoZWNrTm9kZUNhbkJlU2VsZWN0KGl0ZW1zLCB0cnVlKTtcclxuICAgIH1cclxuXHJcbiAgICBsb2FkRmF2b3JpdGVGb3JUcmVlVGFibGUoaXRlbXMsIGZ0dDogYW55KSB7XHJcbiAgICAgICAgaXRlbXMgPSB0aGlzLmluaXRGYXZvcml0ZVRyZWVEYXRhKGl0ZW1zKTtcclxuICAgICAgICB0aGlzLmluc3RhbmNlLmZhdm9yaXRlSXRlbXMgPSBpdGVtcztcclxuICAgICAgICBmdHQubG9hZERhdGEoaXRlbXMpO1xyXG4gICAgICAgIGZ0dC5leHBhbmRBbGwoKTtcclxuICAgICAgICB0aGlzLmluc3RhbmNlLnNlbGVjdGlvbk1nci5zZWxlY3RDdXJyZW50VmFsdWUoKTtcclxuXHJcbiAgICAgICAgcmV0dXJuIGl0ZW1zO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIOabtOaWsOWIl+ihqOS4reeahOaUtuiXj+aVsOaNruagh+ivhlxyXG4gICAgdXBkYXRlRmF2b3JpdGVzU3RhdHVzKGRhdGE6IGFueVtdKSB7XHJcblxyXG4gICAgICAgIGlmICghZGF0YSB8fCAhdGhpcy5pbnN0YW5jZS51c2VGYXZvcml0ZSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBmYXZJZHMgPSB0aGlzLmdldEZhdm9yaXRJZHMoKTtcclxuXHJcbiAgICAgICAgaWYgKGZhdklkcyAmJiBmYXZJZHMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIC8vIOWkhOeQhuaVsOaNruWIl+ihqOS4reeahOaUtuiXj+aVsOaNruagh+ivhlxyXG4gICAgICAgICAgICBpZiAodGhpcy5pbnN0YW5jZS5kaXNwbGF5VHlwZSAhPT0gTG9va3VwR3JpZERpc3BsYXlUeXBlLlRyZWVMaXN0KSB7XHJcbiAgICAgICAgICAgICAgICBkYXRhLm1hcChpdGVtID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZmF2SWRzICYmIGZhdklkcy5sZW5ndGggJiYgZmF2SWRzLmZpbmQodiA9PiB2ID09PSBpdGVtW3RoaXMuaW5zdGFuY2UuaWRGaWVsZF0pKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1bRkFWT1JJVEVfRklFTERfTkFNRV0gPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgX3RoaXMgPSB0aGlzLmluc3RhbmNlO1xyXG4gICAgICAgICAgICAgICAgKGZ1bmN0aW9uIGVhY2goX2RhdGEpIHtcclxuICAgICAgICAgICAgICAgICAgICBfZGF0YS5mb3JFYWNoKGl0ZW0gPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmF2SWRzICYmIGZhdklkcy5sZW5ndGggJiYgZmF2SWRzLmZpbmQodiA9PiB2ID09PSBpdGVtLmRhdGFbX3RoaXMuaWRGaWVsZF0pKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtLmRhdGFbRkFWT1JJVEVfRklFTERfTkFNRV0gPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpdGVtLmNoaWxkcmVuICYmIGl0ZW0uY2hpbGRyZW4ubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWFjaChpdGVtLmNoaWxkcmVuKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfSkoZGF0YSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG5cclxuICAgIHByaXZhdGUgX3VwZGF0ZUZhdm9yaXRlcyh2YWx1ZTogYW55LCBhY3Rpb24pIHtcclxuICAgICAgICBjb25zdCBsb2NhbGVJRCA9IHRoaXMuaW5zdGFuY2UubG9jYWxTZXJ2aWNlLmxvY2FsZUlkO1xyXG4gICAgICAgIHRoaXMuaW5zdGFuY2UucGVyc29uYWxDb25mLmZhdm9yaXRlID0gdGhpcy5pbnN0YW5jZS5wZXJzb25hbENvbmYuZmF2b3JpdGUgfHwge307XHJcbiAgICAgICAgY29uc3QgaXRlbXMgPSB2YWx1ZS5maWx0ZXIobiA9PiAhblsnX2FkZHRpb25hbF8nXSk7XHJcbiAgICAgICAgY29uc3QgbmV3VmFsID0gaXRlbXMubWFwKG4gPT4gblt0aGlzLmluc3RhbmNlLmlkRmllbGRdKS5maWx0ZXIobiA9PiBuICE9PSBudWxsICYmIG4gIT09IHVuZGVmaW5lZCk7XHJcbiAgICAgICAgLy8gY29uc3QgZmF2SWRzID0gdGhpcy5pbnN0YW5jZS5wZXJzb25hbENvbmYuZmF2b3JpdGVbbG9jYWxlSURdIHx8IFtdO1xyXG4gICAgICAgIHRoaXMuaW5zdGFuY2UucGVyc29uYWxDb25mLmZhdm9yaXRlW2xvY2FsZUlEXSA9IG5ld1ZhbDtcclxuICAgICAgICByZXR1cm4gbmV3VmFsO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIOaUtuiXj+aVsOaNrueuoeeQhlxyXG4gICAgcHJpdmF0ZSBsaXN0ZW5QZXJzb25hbENvbmZpZ0hhbmRsZXIoKSB7XHJcbiAgICAgICAgdGhpcy5sb29rdXBTZWxlY3Rpb25TZXIuZmF2b3JpdGVJdGVtcyQuc3Vic2NyaWJlKG4gPT4ge1xyXG4gICAgICAgICAgICBpZiAoIXRoaXMuaW5zdGFuY2UuZmF2b3JpdGVzQ29tcG9uZW50UmVmKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGNvbnN0IHsgaXRlbXMsIGFjdGlvbiB9ID0gbjtcclxuICAgICAgICAgICAgY29uc3QgZmF2aWRzID0gdGhpcy5fdXBkYXRlRmF2b3JpdGVzKGl0ZW1zLCBhY3Rpb24pO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5pbnN0YW5jZS5odHRwTWdyLnN1Ym1pdEZhdm9yaXRlRGF0YShhY3Rpb24pO1xyXG5cclxuICAgICAgICAgICAgaWYgKHRoaXMuaW5zdGFuY2UuZGlzcGxheVR5cGUgPT09IExvb2t1cEdyaWREaXNwbGF5VHlwZS5MaXN0IHx8IHRoaXMuaW5zdGFuY2UuZGlzcGxheVR5cGUuaW5jbHVkZXMoJ05BVicpKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBkdCA9IHRoaXMuaW5zdGFuY2UuZmF2b3JpdGVzQ29tcG9uZW50UmVmLmluc3RhbmNlIGFzIERhdGFUYWJsZUNvbXBvbmVudDtcclxuICAgICAgICAgICAgICAgIHRoaXMubG9hZEZhdm9yaXRlRGF0YXRhYmxlKGR0LCBpdGVtcyk7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5pbnN0YW5jZS5kaXNwbGF5VHlwZSA9PT0gTG9va3VwR3JpZERpc3BsYXlUeXBlLlRyZWVMaXN0KSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBmdHQgPSB0aGlzLmluc3RhbmNlLmZhdm9yaXRlc0NvbXBvbmVudFJlZi5pbnN0YW5jZSBhcyBUcmVlVGFibGVDb21wb25lbnQ7XHJcbiAgICAgICAgICAgICAgICAvLyBjb25zdCBmYXZpZHMgPSBpdGVtcy5tYXAoZCA9PiBkLmlkKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuaW5zdGFuY2Uuc2hvd0xvYWRpbmcoKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuaW5zdGFuY2UuaHR0cE1nci5nZXREYXRhKHsgZmF2b3JpdGVJZHM6IGZhdmlkcyB9LCAnZmF2Jykuc3Vic2NyaWJlKHJlc0RhdGEgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChyZXNEYXRhKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IF9pdGVtcyA9IHJlc0RhdGEuaXRlbXM7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubG9hZEZhdm9yaXRlRm9yVHJlZVRhYmxlKF9pdGVtcywgZnR0KTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmluc3RhbmNlLmZhdm9yaXRlSXRlbXMgPSBbXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZnR0LmxvYWREYXRhKFtdKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnN0YW5jZS5jbG9zZUxvYWRpbmcoKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG59XHJcbiJdfQ==