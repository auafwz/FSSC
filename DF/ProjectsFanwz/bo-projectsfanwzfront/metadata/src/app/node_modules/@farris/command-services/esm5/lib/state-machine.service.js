import { Injectable, ElementRef } from '@angular/core';
import { StateMachine } from '@farris/devkit';
// tslint:disable: max-line-length
/**
 * 状态机服务
 * @scope FrameComponent
 */
var StateMachineService = /** @class */ (function () {
    function StateMachineService(stateMachine) {
        var _this = this;
        this.stateMachine = stateMachine;
        this._clsDefaultName = 'f-form-state-default';
        this._initLoad = true;
        if (this.stateMachine.initialState.name === 'init') {
            window.setTimeout(function () {
                _this.initFormState();
            }, 0);
        }
    }
    StateMachineService.prototype.transit = function (action) {
        if (action && typeof this.stateMachine[action] === 'function') {
            this.stateMachine[action]();
            this._currentFrameContext = this['context'] && this['context']['frameContext'];
            if (this._initLoad) {
                this.initFormState();
                this._initLoad = false;
            }
            if (!this._currentFrameContext) {
                return;
            }
            var currentRootFrameContext = this.getCurrentRootFrameContext(this._currentFrameContext);
            if (!!currentRootFrameContext) {
                this.toggleFormState(action, currentRootFrameContext);
            }
        }
    };
    StateMachineService.prototype.getCurrentRootFrameContext = function (currentFrameContext) {
        var currentRootFrameContext;
        this.getAllRootFrameContext().forEach(function (rootFc) {
            if (currentFrameContext.namespace === rootFc.namespace) {
                currentRootFrameContext = rootFc;
            }
        });
        return currentRootFrameContext;
    };
    StateMachineService.prototype.getFrameContextManagerMap = function () {
        if (this.stateMachine && this.stateMachine.frameContext) {
            var appContext = this.stateMachine.frameContext.appContext;
            if (appContext) {
                var frameContextManager = appContext.frameContextManager;
                return frameContextManager.getFrameContextMap();
            }
        }
        return null;
        // return this.stateMachine && this.stateMachine.frameContext && this.stateMachine.frameContext.appContext && this.stateMachine.frameContext.appContext.frameContextManager && this.stateMachine.frameContext.appContext.frameContextManager.getFrameContextMap();
    };
    StateMachineService.prototype.getAllRootFrameContext = function () {
        var rootFrameContextArr = [];
        this.getFrameContextManagerMap().forEach(function (item) {
            if ((item['namespace'] === '' && item['parent'] === null) || (item['parent'] !== null && item['namespace'] !== item['parent']['namespace'])) {
                rootFrameContextArr.push(item);
            }
        });
        return rootFrameContextArr;
    };
    StateMachineService.prototype.initFormState = function () {
        var _this = this;
        if (!this.getFrameContextManagerMap()) {
            return;
        }
        this.getAllRootFrameContext().forEach(function (rootFc) {
            var rootComponent = rootFc.injector.get(ElementRef, null) || null;
            if (!rootComponent || !rootComponent.nativeElement) {
                return;
            }
            if (!rootComponent.nativeElement.className.includes(_this._clsDefaultName) && !rootComponent.nativeElement.className.includes('f-form-state-create') && !rootComponent.nativeElement.className.includes('f-form-state-edit')) {
                _this.addCssClass(rootComponent, _this._clsDefaultName);
            }
        });
    };
    StateMachineService.prototype.toggleFormState = function (action, frameContext) {
        var _this = this;
        var rootComponent = frameContext.injector.get(ElementRef, null) || null;
        if (!rootComponent || !rootComponent.nativeElement || !action) {
            return;
        }
        action = action.toLowerCase();
        if (action && ['create', 'edit'].includes(action)) {
            if (action === 'create') {
                this.addCssClass(rootComponent, 'f-form-state-create');
            }
            else if (action === 'edit') {
                this.addCssClass(rootComponent, 'f-form-state-edit');
            }
            this.removeCssClass(rootComponent, this._clsDefaultName);
        }
        else {
            ['f-form-state-create', 'f-form-state-edit'].forEach(function (item) { return _this.removeCssClass(rootComponent, item); });
            this.addCssClass(rootComponent, this._clsDefaultName);
        }
    };
    StateMachineService.prototype.addCssClass = function (elementRef, className) {
        if (!elementRef || !className || !elementRef.nativeElement) {
            return;
        }
        var originalClassName = elementRef.nativeElement.className || '';
        if (!originalClassName.includes(className)) {
            elementRef.nativeElement.className = originalClassName + " " + className;
        }
    };
    StateMachineService.prototype.removeCssClass = function (elementRef, className) {
        if (!elementRef || !className || !elementRef.nativeElement) {
            return;
        }
        var originalClassName = elementRef.nativeElement.className || '';
        if (originalClassName.includes(className)) {
            elementRef.nativeElement.className = originalClassName.split(' ').filter(function (p) { return p && p !== className; }).join(' ');
        }
    };
    StateMachineService.prototype.getFormRootComponent = function () {
        if (this.stateMachine && this.stateMachine.frameContext) {
            var viewContext = this.stateMachine.frameContext;
            if (viewContext) {
                var virtualRootContext = viewContext.getVirtualRootFrameContext();
                if (virtualRootContext) {
                    var injector = virtualRootContext.injector;
                    if (typeof injector.get === 'function') {
                        return injector.get(ElementRef, null);
                    }
                }
            }
        }
        return null;
        // return this.stateMachine && this.stateMachine.frameContext && this.stateMachine.frameContext.getVirtualRootFrameContext() && this.stateMachine.frameContext.getVirtualRootFrameContext().injector && typeof this.stateMachine.frameContext.getVirtualRootFrameContext().injector.get === 'function' && this.stateMachine.frameContext.getVirtualRootFrameContext().injector.get<ElementRef>(ElementRef, null) || null;
    };
    StateMachineService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    StateMachineService.ctorParameters = function () { return [
        { type: StateMachine }
    ]; };
    return StateMachineService;
}());
export { StateMachineService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhdGUtbWFjaGluZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL3N0YXRlLW1hY2hpbmUuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN2RCxPQUFPLEVBQUUsWUFBWSxFQUE0QixNQUFNLGdCQUFnQixDQUFDO0FBQ3hFLGtDQUFrQztBQUNsQzs7O0dBR0c7QUFDSDtJQUdFLDZCQUNVLFlBQTBCO1FBRHBDLGlCQVFDO1FBUFMsaUJBQVksR0FBWixZQUFZLENBQWM7UUFTNUIsb0JBQWUsR0FBRyxzQkFBc0IsQ0FBQztRQUN6QyxjQUFTLEdBQUcsSUFBSSxDQUFDO1FBUnZCLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQyxZQUFZLENBQUMsSUFBSSxLQUFLLE1BQU0sRUFBRTtZQUNsRCxNQUFNLENBQUMsVUFBVSxDQUFDO2dCQUNoQixLQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7WUFDdkIsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1NBQ1A7SUFDSCxDQUFDO0lBTUQscUNBQU8sR0FBUCxVQUFRLE1BQWM7UUFDcEIsSUFBSSxNQUFNLElBQUksT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxLQUFLLFVBQVUsRUFBRTtZQUM3RCxJQUFJLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUM7WUFDNUIsSUFBSSxDQUFDLG9CQUFvQixHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsY0FBYyxDQUFDLENBQUM7WUFDL0UsSUFBSSxJQUFJLENBQUMsU0FBUyxFQUFFO2dCQUNsQixJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7Z0JBQ3JCLElBQUksQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFDO2FBQ3hC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TyxRQUFRLENBQUMsR0FBRyxLQUFLLFVBQVUsRUFBRTt3QkFDdEMsT0FBTyxRQUFRLENBQUMsR0FBRyxDQUFhLFVBQVUsRUFBRSxJQUFJLENBQUMsQ0FBQztxQkFDbkQ7aUJBQ0Y7YUFDRjtTQUNGO1FBQ0QsT0FBTyxJQUFJLENBQUM7UUFDWix5WkFBeVo7SUFDM1osQ0FBQzs7Z0JBdElGLFVBQVU7Ozs7Z0JBTkYsWUFBWTs7SUE2SXJCLDBCQUFDO0NBQUEsQUF2SUQsSUF1SUM7QUFFRCxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEVsZW1lbnRSZWYgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgU3RhdGVNYWNoaW5lLCBGcmFtZUNvbnRleHQsIEFwcENvbnRleHQgfSBmcm9tICdAZmFycmlzL2RldmtpdCc7XHJcbi8vIHRzbGludDpkaXNhYmxlOiBtYXgtbGluZS1sZW5ndGhcclxuLyoqXHJcbiAqIOeKtuaAgeacuuacjeWKoVxyXG4gKiBAc2NvcGUgRnJhbWVDb21wb25lbnRcclxuICovXHJcbkBJbmplY3RhYmxlKClcclxuY2xhc3MgU3RhdGVNYWNoaW5lU2VydmljZSB7XHJcblxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJpdmF0ZSBzdGF0ZU1hY2hpbmU6IFN0YXRlTWFjaGluZVxyXG4gICkge1xyXG4gICAgaWYgKHRoaXMuc3RhdGVNYWNoaW5lLmluaXRpYWxTdGF0ZS5uYW1lID09PSAnaW5pdCcpIHtcclxuICAgICAgd2luZG93LnNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgIHRoaXMuaW5pdEZvcm1TdGF0ZSgpO1xyXG4gICAgICB9LCAwKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgX2Nsc0RlZmF1bHROYW1lID0gJ2YtZm9ybS1zdGF0ZS1kZWZhdWx0JztcclxuICBwcml2YXRlIF9pbml0TG9hZCA9IHRydWU7XHJcbiAgcHJpdmF0ZSBfY3VycmVudEZyYW1lQ29udGV4dDogYW55XHJcblxyXG4gIHRyYW5zaXQoYWN0aW9uOiBzdHJpbmcpIHtcclxuICAgIGlmIChhY3Rpb24gJiYgdHlwZW9mIHRoaXMuc3RhdGVNYWNoaW5lW2FjdGlvbl0gPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgdGhpcy5zdGF0ZU1hY2hpbmVbYWN0aW9uXSgpO1xyXG4gICAgICB0aGlzLl9jdXJyZW50RnJhbWVDb250ZXh0ID0gdGhpc1snY29udGV4dCddICYmIHRoaXNbJ2NvbnRleHQnXVsnZnJhbWVDb250ZXh0J107XHJcbiAgICAgIGlmICh0aGlzLl9pbml0TG9hZCkge1xyXG4gICAgICAgIHRoaXMuaW5pdEZvcm1TdGF0ZSgpO1xyXG4gICAgICAgIHRoaXMuX2luaXRMb2FkID0gZmFsc2U7XHJcbiAgICAgIH1cclxuICAgICAgaWYgKCF0aGlzLl9jdXJyZW50RnJhbWVDb250ZXh0KSB7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcbiAgICAgIGNvbnN0IGN1cnJlbnRSb290RnJhbWVDb250ZXh0ID0gdGhpcy5nZXRDdXJyZW50Um9vdEZyYW1lQ29udGV4dCh0aGlzLl9jdXJyZW50RnJhbWVDb250ZXh0KTtcclxuICAgICAgaWYgKCEhY3VycmVudFJvb3RGcmFtZUNvbnRleHQpIHtcclxuICAgICAgICB0aGlzLnRvZ2dsZUZvcm1TdGF0ZShhY3Rpb24sIGN1cnJlbnRSb290RnJhbWVDb250ZXh0KTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXRDdXJyZW50Um9vdEZyYW1lQ29udGV4dChjdXJyZW50RnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQpOiBGcmFtZUNvbnRleHQge1xyXG4gICAgbGV0IGN1cnJlbnRSb290RnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQ7XHJcbiAgICB0aGlzLmdldEFsbFJvb3RGcmFtZUNvbnRleHQoKS5mb3JFYWNoKChyb290RmM6IEZyYW1lQ29udGV4dCkgPT4ge1xyXG4gICAgICBpZiAoY3VycmVudEZyYW1lQ29udGV4dC5uYW1lc3BhY2UgPT09IHJvb3RGYy5uYW1lc3BhY2UpIHtcclxuICAgICAgICBjdXJyZW50Um9vdEZyYW1lQ29udGV4dCA9IHJvb3RGYztcclxuICAgICAgfVxyXG4gICAgfSlcclxuICAgIHJldHVybiBjdXJyZW50Um9vdEZyYW1lQ29udGV4dDtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0RnJhbWVDb250ZXh0TWFuYWdlck1hcCgpIHtcclxuICAgIGlmICh0aGlzLnN0YXRlTWFjaGluZSAmJiB0aGlzLnN0YXRlTWFjaGluZS5mcmFtZUNvbnRleHQpIHtcclxuICAgICAgY29uc3QgYXBwQ29udGV4dCA9IHRoaXMuc3RhdGVNYWNoaW5lLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0IGFzIEFwcENvbnRleHQ7XHJcbiAgICAgIGlmIChhcHBDb250ZXh0KSB7XHJcbiAgICAgICAgY29uc3QgZnJhbWVDb250ZXh0TWFuYWdlciA9IGFwcENvbnRleHQuZnJhbWVDb250ZXh0TWFuYWdlcjtcclxuICAgICAgICByZXR1cm4gZnJhbWVDb250ZXh0TWFuYWdlci5nZXRGcmFtZUNvbnRleHRNYXAoKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIG51bGw7XHJcbiAgICAvLyByZXR1cm4gdGhpcy5zdGF0ZU1hY2hpbmUgJiYgdGhpcy5zdGF0ZU1hY2hpbmUuZnJhbWVDb250ZXh0ICYmIHRoaXMuc3RhdGVNYWNoaW5lLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0ICYmIHRoaXMuc3RhdGVNYWNoaW5lLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0LmZyYW1lQ29udGV4dE1hbmFnZXIgJiYgdGhpcy5zdGF0ZU1hY2hpbmUuZnJhbWVDb250ZXh0LmFwcENvbnRleHQuZnJhbWVDb250ZXh0TWFuYWdlci5nZXRGcmFtZUNvbnRleHRNYXAoKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0QWxsUm9vdEZyYW1lQ29udGV4dCgpOiBhbnlbXSB7XHJcbiAgICBjb25zdCByb290RnJhbWVDb250ZXh0QXJyID0gW107XHJcbiAgICB0aGlzLmdldEZyYW1lQ29udGV4dE1hbmFnZXJNYXAoKS5mb3JFYWNoKGl0ZW0gPT4ge1xyXG4gICAgICBpZiAoKGl0ZW1bJ25hbWVzcGFjZSddID09PSAnJyAmJiBpdGVtWydwYXJlbnQnXSA9PT0gbnVsbCkgfHwgKGl0ZW1bJ3BhcmVudCddICE9PSBudWxsICYmIGl0ZW1bJ25hbWVzcGFjZSddICE9PSBpdGVtWydwYXJlbnQnXVsnbmFtZXNwYWNlJ10pKSB7XHJcbiAgICAgICAgcm9vdEZyYW1lQ29udGV4dEFyci5wdXNoKGl0ZW0pO1xyXG4gICAgICB9XHJcbiAgICB9KVxyXG5cclxuICAgIHJldHVybiByb290RnJhbWVDb250ZXh0QXJyO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBpbml0Rm9ybVN0YXRlKCkge1xyXG4gICAgaWYgKCF0aGlzLmdldEZyYW1lQ29udGV4dE1hbmFnZXJNYXAoKSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICB0aGlzLmdldEFsbFJvb3RGcmFtZUNvbnRleHQoKS5mb3JFYWNoKChyb290RmM6IEZyYW1lQ29udGV4dCkgPT4ge1xyXG4gICAgICBjb25zdCByb290Q29tcG9uZW50ID0gcm9vdEZjLmluamVjdG9yLmdldDxFbGVtZW50UmVmPihFbGVtZW50UmVmLCBudWxsKSB8fCBudWxsO1xyXG4gICAgICBpZiAoIXJvb3RDb21wb25lbnQgfHwgIXJvb3RDb21wb25lbnQubmF0aXZlRWxlbWVudCkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG4gICAgICBpZiAoIXJvb3RDb21wb25lbnQubmF0aXZlRWxlbWVudC5jbGFzc05hbWUuaW5jbHVkZXModGhpcy5fY2xzRGVmYXVsdE5hbWUpICYmICFyb290Q29tcG9uZW50Lm5hdGl2ZUVsZW1lbnQuY2xhc3NOYW1lLmluY2x1ZGVzKCdmLWZvcm0tc3RhdGUtY3JlYXRlJykgJiYgIXJvb3RDb21wb25lbnQubmF0aXZlRWxlbWVudC5jbGFzc05hbWUuaW5jbHVkZXMoJ2YtZm9ybS1zdGF0ZS1lZGl0JykpIHtcclxuICAgICAgICB0aGlzLmFkZENzc0NsYXNzKHJvb3RDb21wb25lbnQsIHRoaXMuX2Nsc0RlZmF1bHROYW1lKTtcclxuICAgICAgfVxyXG4gICAgfSlcclxuICB9XHJcblxyXG4gIHByaXZhdGUgdG9nZ2xlRm9ybVN0YXRlKGFjdGlvbjogc3RyaW5nLCBmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCkge1xyXG4gICAgY29uc3Qgcm9vdENvbXBvbmVudCA9IGZyYW1lQ29udGV4dC5pbmplY3Rvci5nZXQ8RWxlbWVudFJlZj4oRWxlbWVudFJlZiwgbnVsbCkgfHwgbnVsbDtcclxuICAgIGlmICghcm9vdENvbXBvbmVudCB8fCAhcm9vdENvbXBvbmVudC5uYXRpdmVFbGVtZW50IHx8ICFhY3Rpb24pIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgYWN0aW9uID0gYWN0aW9uLnRvTG93ZXJDYXNlKCk7XHJcbiAgICBpZiAoYWN0aW9uICYmIFsnY3JlYXRlJywgJ2VkaXQnXS5pbmNsdWRlcyhhY3Rpb24pKSB7XHJcbiAgICAgIGlmIChhY3Rpb24gPT09ICdjcmVhdGUnKSB7XHJcbiAgICAgICAgdGhpcy5hZGRDc3NDbGFzcyhyb290Q29tcG9uZW50LCAnZi1mb3JtLXN0YXRlLWNyZWF0ZScpO1xyXG4gICAgICB9IGVsc2UgaWYgKGFjdGlvbiA9PT0gJ2VkaXQnKSB7XHJcbiAgICAgICAgdGhpcy5hZGRDc3NDbGFzcyhyb290Q29tcG9uZW50LCAnZi1mb3JtLXN0YXRlLWVkaXQnKTtcclxuICAgICAgfVxyXG4gICAgICB0aGlzLnJlbW92ZUNzc0NsYXNzKHJvb3RDb21wb25lbnQsIHRoaXMuX2Nsc0RlZmF1bHROYW1lKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIFsnZi1mb3JtLXN0YXRlLWNyZWF0ZScsICdmLWZvcm0tc3RhdGUtZWRpdCddLmZvckVhY2goaXRlbSA9PiB0aGlzLnJlbW92ZUNzc0NsYXNzKHJvb3RDb21wb25lbnQsIGl0ZW0pKTtcclxuICAgICAgdGhpcy5hZGRDc3NDbGFzcyhyb290Q29tcG9uZW50LCB0aGlzLl9jbHNEZWZhdWx0TmFtZSk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIHByaXZhdGUgYWRkQ3NzQ2xhc3MoZWxlbWVudFJlZjogRWxlbWVudFJlZiwgY2xhc3NOYW1lOiBzdHJpbmcpIHtcclxuICAgIGlmICghZWxlbWVudFJlZiB8fCAhY2xhc3NOYW1lIHx8ICFlbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgY29uc3Qgb3JpZ2luYWxDbGFzc05hbWU6IHN0cmluZyA9IGVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5jbGFzc05hbWUgfHwgJyc7XHJcbiAgICBpZiAoIW9yaWdpbmFsQ2xhc3NOYW1lLmluY2x1ZGVzKGNsYXNzTmFtZSkpIHtcclxuICAgICAgZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LmNsYXNzTmFtZSA9IGAke29yaWdpbmFsQ2xhc3NOYW1lfSAke2NsYXNzTmFtZX1gO1xyXG4gICAgfVxyXG4gIH1cclxuICBwcml2YXRlIHJlbW92ZUNzc0NsYXNzKGVsZW1lbnRSZWY6IEVsZW1lbnRSZWYsIGNsYXNzTmFtZTogc3RyaW5nKSB7XHJcbiAgICBpZiAoIWVsZW1lbnRSZWYgfHwgIWNsYXNzTmFtZSB8fCAhZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50KSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGNvbnN0IG9yaWdpbmFsQ2xhc3NOYW1lOiBzdHJpbmcgPSBlbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQuY2xhc3NOYW1lIHx8ICcnO1xyXG4gICAgaWYgKG9yaWdpbmFsQ2xhc3NOYW1lLmluY2x1ZGVzKGNsYXNzTmFtZSkpIHtcclxuICAgICAgZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LmNsYXNzTmFtZSA9IG9yaWdpbmFsQ2xhc3NOYW1lLnNwbGl0KCcgJykuZmlsdGVyKHAgPT4gcCAmJiBwICE9PSBjbGFzc05hbWUpLmpvaW4oJyAnKTtcclxuICAgIH1cclxuICB9XHJcbiAgcHJpdmF0ZSBnZXRGb3JtUm9vdENvbXBvbmVudCgpIHtcclxuICAgIGlmICh0aGlzLnN0YXRlTWFjaGluZSAmJiB0aGlzLnN0YXRlTWFjaGluZS5mcmFtZUNvbnRleHQpIHtcclxuICAgICAgY29uc3Qgdmlld0NvbnRleHQgPSB0aGlzLnN0YXRlTWFjaGluZS5mcmFtZUNvbnRleHQ7XHJcbiAgICAgIGlmICh2aWV3Q29udGV4dCkge1xyXG4gICAgICAgIGNvbnN0IHZpcnR1YWxSb290Q29udGV4dCA9IHZpZXdDb250ZXh0LmdldFZpcnR1YWxSb290RnJhbWVDb250ZXh0KCk7XHJcbiAgICAgICAgaWYgKHZpcnR1YWxSb290Q29udGV4dCkge1xyXG4gICAgICAgICAgY29uc3QgaW5qZWN0b3IgPSB2aXJ0dWFsUm9vdENvbnRleHQuaW5qZWN0b3I7XHJcbiAgICAgICAgICBpZiAodHlwZW9mIGluamVjdG9yLmdldCA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICAgICAgICByZXR1cm4gaW5qZWN0b3IuZ2V0PEVsZW1lbnRSZWY+KEVsZW1lbnRSZWYsIG51bGwpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIG51bGw7XHJcbiAgICAvLyByZXR1cm4gdGhpcy5zdGF0ZU1hY2hpbmUgJiYgdGhpcy5zdGF0ZU1hY2hpbmUuZnJhbWVDb250ZXh0ICYmIHRoaXMuc3RhdGVNYWNoaW5lLmZyYW1lQ29udGV4dC5nZXRWaXJ0dWFsUm9vdEZyYW1lQ29udGV4dCgpICYmIHRoaXMuc3RhdGVNYWNoaW5lLmZyYW1lQ29udGV4dC5nZXRWaXJ0dWFsUm9vdEZyYW1lQ29udGV4dCgpLmluamVjdG9yICYmIHR5cGVvZiB0aGlzLnN0YXRlTWFjaGluZS5mcmFtZUNvbnRleHQuZ2V0VmlydHVhbFJvb3RGcmFtZUNvbnRleHQoKS5pbmplY3Rvci5nZXQgPT09ICdmdW5jdGlvbicgJiYgdGhpcy5zdGF0ZU1hY2hpbmUuZnJhbWVDb250ZXh0LmdldFZpcnR1YWxSb290RnJhbWVDb250ZXh0KCkuaW5qZWN0b3IuZ2V0PEVsZW1lbnRSZWY+KEVsZW1lbnRSZWYsIG51bGwpIHx8IG51bGw7XHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgeyBTdGF0ZU1hY2hpbmVTZXJ2aWNlIH07XHJcbiJdfQ==