/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { cloneDeep } from 'lodash-es';
var SearchHandle = /** @class */ (function () {
    function SearchHandle(ttInstance) {
        this.ttInstance = ttInstance;
        this.allNodes = [];
    }
    /**
     * @param {?} field
     * @param {?} value
     * @param {?=} from
     * @return {?}
     */
    SearchHandle.prototype.search = /**
     * @param {?} field
     * @param {?} value
     * @param {?=} from
     * @return {?}
     */
    function (field, value, from) {
        var _this = this;
        if (from === void 0) { from = 'client'; }
        if (!this.allNodes.length) {
            this.allNodes = cloneDeep(this.ttInstance.state.rowNodes);
        }
        switch (from) {
            case 'server':
                this.searchOnServer(field, value);
                break;
            default:
                if (value !== '' && value !== undefined) {
                    /** @type {?} */
                    var values = this.searchOnClient(field, value, this.allNodes);
                    this._updateSerializedValues(values);
                }
                else {
                    this.ttInstance.updateSerializedValue();
                }
                if (this.ttInstance.checkeds && this.ttInstance.checkeds.length) {
                    this.ttInstance.checkedNodes(this.ttInstance.checkeds.map((/**
                     * @param {?} n
                     * @return {?}
                     */
                    function (n) { return n.data[_this.ttInstance.idField]; })));
                }
                else {
                    this.ttInstance.detectChanges();
                }
                break;
        }
    };
    /**
     * @private
     * @param {?} visibleItems
     * @return {?}
     */
    SearchHandle.prototype._updateSerializedValues = /**
     * @private
     * @param {?} visibleItems
     * @return {?}
     */
    function (visibleItems) {
        /** @type {?} */
        var pids = ((/** @type {?} */ (visibleItems.map((/**
         * @param {?} n
         * @return {?}
         */
        function (n) { return tslib_1.__spread(n.parents, [n.id]); }))))).flat();
        /** @type {?} */
        var pidArr = Array.from(new Set(pids));
        /** @type {?} */
        var rowNodes = this.allNodes.filter((/**
         * @param {?} n
         * @return {?}
         */
        function (n) { return pidArr.some((/**
         * @param {?} item
         * @return {?}
         */
        function (item) { return item == n.id; })); })).map((/**
         * @param {?} r
         * @return {?}
         */
        function (r) {
            r.expanded = true;
            return r;
        }));
        this.ttInstance.serializedValue = this.resetTreeData(null, rowNodes);
        this.ttInstance.state.rowNodes = this.ttInstance.serializedValue;
    };
    /**
     * @param {?} item
     * @param {?} allNodes
     * @return {?}
     */
    SearchHandle.prototype.findParent = /**
     * @param {?} item
     * @param {?} allNodes
     * @return {?}
     */
    function (item, allNodes) {
        var _this = this;
        /** @type {?} */
        var res = [];
        if (item && allNodes && allNodes.length) {
            /** @type {?} */
            var p = allNodes.find((/**
             * @param {?} t1
             * @return {?}
             */
            function (t1) { return t1.id === item.data[_this.ttInstance.idField]; }));
            res.push(p);
            if (p.parent) {
                res = res.concat(this.findParent(p.parent, allNodes));
            }
        }
        return res;
    };
    /**
     * @private
     * @param {?} item
     * @param {?} value
     * @param {?=} fields
     * @return {?}
     */
    SearchHandle.prototype.searchExpression = /**
     * @private
     * @param {?} item
     * @param {?} value
     * @param {?=} fields
     * @return {?}
     */
    function (item, value, fields) {
        var _this = this;
        if (fields === void 0) { fields = []; }
        /** @type {?} */
        var _fields = fields.length ? fields : this.ttInstance.columns.map((/**
         * @param {?} c
         * @return {?}
         */
        function (c) { return c.field; }));
        /** @type {?} */
        var results = _fields.map((/**
         * @param {?} f
         * @return {?}
         */
        function (f) {
            /** @type {?} */
            var targetValue = '' + _this.getValue(f, item.node.data);
            if (targetValue !== undefined) {
                if (typeof targetValue === 'number') {
                    return targetValue === parseFloat(value);
                }
                else {
                    return targetValue.indexOf(value) > -1;
                }
            }
            else {
                console.warn("\u4E0D\u5B58\u5728\u5217 " + f);
            }
        }));
        return results.reduce((/**
         * @param {?} flag
         * @param {?} curr
         * @return {?}
         */
        function (flag, curr) {
            return flag || curr;
        }), false);
    };
    /**
     * @private
     * @param {?} field
     * @param {?} data
     * @return {?}
     */
    SearchHandle.prototype.getValue = /**
     * @private
     * @param {?} field
     * @param {?} data
     * @return {?}
     */
    function (field, data) {
        if (field) {
            if (field.indexOf('.') > -1) {
                try {
                    return field.split('.').reduce((/**
                     * @param {?} r
                     * @param {?} f
                     * @return {?}
                     */
                    function (r, f) {
                        if (r) {
                            return r[f];
                        }
                        else {
                            return null;
                        }
                    }), data);
                }
                catch (_a) {
                    console.log(field);
                }
            }
            else {
                return data[field];
            }
        }
    };
    /**
     * @param {?} field
     * @param {?} value
     * @param {?} nodes
     * @return {?}
     */
    SearchHandle.prototype.getFindTextTotal = /**
     * @param {?} field
     * @param {?} value
     * @param {?} nodes
     * @return {?}
     */
    function (field, value, nodes) {
        var _this = this;
        /** @type {?} */
        var t = 0;
        /** @type {?} */
        var getCount = (/**
         * @param {?} fields
         * @return {?}
         */
        function (fields) {
            /** @type {?} */
            var c = 0;
            nodes.forEach((/**
             * @param {?} n
             * @return {?}
             */
            function (n) {
                fields.forEach((/**
                 * @param {?} f
                 * @return {?}
                 */
                function (f) {
                    /** @type {?} */
                    var targetValue = '' + _this.getValue(f, n.node.data);
                    if (targetValue !== undefined) {
                        if (targetValue.indexOf(value) > -1) {
                            c++;
                        }
                    }
                }));
            }));
            return c;
        });
        /** @type {?} */
        var _fields = [field];
        if (field === '*') {
            _fields = this.ttInstance.columns.map((/**
             * @param {?} c
             * @return {?}
             */
            function (c) { return c.field; }));
        }
        else if (field.indexOf(',') > -1) {
            _fields = field.split(',').map((/**
             * @param {?} f
             * @return {?}
             */
            function (f) { return f.trim(); }));
        }
        t = getCount(_fields);
        return t;
    };
    /**
     * @param {?} field
     * @param {?} value
     * @param {?} nodes
     * @return {?}
     */
    SearchHandle.prototype.searchOnClient = /**
     * @param {?} field
     * @param {?} value
     * @param {?} nodes
     * @return {?}
     */
    function (field, value, nodes) {
        var _this = this;
        /** @type {?} */
        var resultNodes = [];
        if (!value) {
            return [];
        }
        if (field === '*') {
            resultNodes = nodes.filter((/**
             * @param {?} n
             * @return {?}
             */
            function (n) { return _this.searchExpression(n, value); }));
        }
        else if (field.indexOf(',') > -1) {
            resultNodes = nodes.filter((/**
             * @param {?} n
             * @return {?}
             */
            function (n) { return _this.searchExpression(n, value, field.split(',').map((/**
             * @param {?} f
             * @return {?}
             */
            function (f) { return f.trim(); }))); }));
        }
        else {
            value = value.toLowerCase();
            if (field.indexOf('.') === -1) {
                resultNodes = nodes.filter((/**
                 * @param {?} n
                 * @return {?}
                 */
                function (n) { return ('' + n.node.data[field]).toLowerCase().indexOf(value) > -1; }));
            }
            else {
                resultNodes = nodes.filter((/**
                 * @param {?} n
                 * @return {?}
                 */
                function (n) { return ('' + _this.getValue(field, n.node.data)).toLowerCase().indexOf(value) > -1; }));
            }
        }
        return resultNodes;
    };
    /**
     * @param {?} rowNodes
     * @param {?} allNodes
     * @return {?}
     */
    SearchHandle.prototype.findParents = /**
     * @param {?} rowNodes
     * @param {?} allNodes
     * @return {?}
     */
    function (rowNodes, allNodes) {
        var _this = this;
        /** @type {?} */
        var res = [];
        rowNodes.forEach((/**
         * @param {?} item
         * @return {?}
         */
        function (item) {
            res = res.concat(_this.findParent(item.node, allNodes));
        }));
        return Array.from(new Set(res));
    };
    /**
     * @private
     * @param {?} parentNode
     * @param {?} visibleItems
     * @return {?}
     */
    SearchHandle.prototype.resetTreeData = /**
     * @private
     * @param {?} parentNode
     * @param {?} visibleItems
     * @return {?}
     */
    function (parentNode, visibleItems) {
        var _this = this;
        /** @type {?} */
        var res = [];
        /** @type {?} */
        var arr = [];
        if (parentNode === null) {
            arr = visibleItems.filter((/**
             * @param {?} t2
             * @return {?}
             */
            function (t2) { return t2.parent === parentNode; }));
        }
        else {
            parentNode.node.expanded = true;
            arr = visibleItems.filter((/**
             * @param {?} t2
             * @return {?}
             */
            function (t2) { return t2.parent && t2.parent.data[_this.ttInstance.idField] === parentNode.id; }));
            if (!arr.length) {
                parentNode.node.children = [];
            }
            else {
                parentNode.node.children = arr.map((/**
                 * @param {?} tn
                 * @return {?}
                 */
                function (tn) { return tn.node; }));
            }
        }
        arr.forEach((/**
         * @param {?} a
         * @return {?}
         */
        function (a) {
            a.visible = true;
            res.push(a);
            res = res.concat(_this.resetTreeData(a, visibleItems));
        }));
        return res;
    };
    /**
     * @private
     * @param {?} field
     * @param {?} value
     * @return {?}
     */
    SearchHandle.prototype.searchOnServer = /**
     * @private
     * @param {?} field
     * @param {?} value
     * @return {?}
     */
    function (field, value) {
    };
    return SearchHandle;
}());
export { SearchHandle };
if (false) {
    /** @type {?} */
    SearchHandle.prototype.allNodes;
    /**
     * @type {?}
     * @private
     */
    SearchHandle.prototype.ttInstance;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VhcmNoLmhhbmRsZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvdWktdHJlZXRhYmxlLyIsInNvdXJjZXMiOlsibGliL3NlYXJjaC5oYW5kbGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFXQSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ3RDO0lBRUksc0JBQW9CLFVBQThCO1FBQTlCLGVBQVUsR0FBVixVQUFVLENBQW9CO1FBRGxELGFBQVEsR0FBRyxFQUFFLENBQUM7SUFFZCxDQUFDOzs7Ozs7O0lBRUQsNkJBQU07Ozs7OztJQUFOLFVBQU8sS0FBYSxFQUFFLEtBQWEsRUFBRSxJQUFrQztRQUF2RSxpQkF1QkM7UUF2Qm9DLHFCQUFBLEVBQUEsZUFBa0M7UUFDbkUsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxFQUFFO1lBQ3ZCLElBQUksQ0FBQyxRQUFRLEdBQUcsU0FBUyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1NBQzdEO1FBQ0QsUUFBUSxJQUFJLEVBQUU7WUFDVixLQUFLLFFBQVE7Z0JBQ1QsSUFBSSxDQUFDLGNBQWMsQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUM7Z0JBQ2xDLE1BQU07WUFDVjtnQkFDSSxJQUFJLEtBQUssS0FBSyxFQUFFLElBQUksS0FBSyxLQUFLLFNBQVMsRUFBRTs7d0JBQy9CLE1BQU0sR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLEtBQUssRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLFFBQVEsQ0FBQztvQkFDL0QsSUFBSSxDQUFDLHVCQUF1QixDQUFDLE1BQU0sQ0FBQyxDQUFDO2lCQUN4QztxQkFBTTtvQkFDSCxJQUFJLENBQUMsVUFBVSxDQUFDLHFCQUFxQixFQUFFLENBQUM7aUJBQzNDO2dCQUVELElBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxRQUFRLElBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxR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bSAnbG9kYXNoLWVzJztcclxuLypcclxuICogQEF1dGhvcjog55av54uC56eA5omNKGx1Y2FzIGh1YW5nKVxyXG4gKiBARGF0ZTogMjAxOC0xMi0xOCAxMzozODo1MVxyXG4gKiBATGFzdEVkaXRvcnM6IOeWr+eLguengOaJjShMdWNhcyBIdWFuZylcclxuICogQExhc3RFZGl0VGltZTogMjAxOS0xMS0xNSAxNToxMzo1NlxyXG4gKiBAQ29tcGFueTogSW5zcHVyXHJcbiAqIEBWZXJzaW9uOiB2MC4wLjFcclxuICovXHJcbmltcG9ydCB7IFRyZWVUYWJsZUNvbXBvbmVudCB9IGZyb20gJy4vdHJlZXRhYmxlLmNvbXBvbmVudCc7XHJcbmltcG9ydCB7IFJvd05vZGUsIFRyZWVOb2RlIH0gZnJvbSAnLi90eXBlcy90cmVlbm9kZSc7XHJcbmltcG9ydCB7IGNsb25lRGVlcCB9IGZyb20gJ2xvZGFzaC1lcyc7XHJcbmV4cG9ydCBjbGFzcyBTZWFyY2hIYW5kbGUge1xyXG4gICAgYWxsTm9kZXMgPSBbXTtcclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgdHRJbnN0YW5jZTogVHJlZVRhYmxlQ29tcG9uZW50KSB7XHJcbiAgICB9XHJcblxyXG4gICAgc2VhcmNoKGZpZWxkOiBzdHJpbmcsIHZhbHVlOiBzdHJpbmcsIGZyb206ICdjbGllbnQnfCdzZXJ2ZXInID0gJ2NsaWVudCcpOiBhbnkge1xyXG4gICAgICAgIGlmICghdGhpcy5hbGxOb2Rlcy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgdGhpcy5hbGxOb2RlcyA9IGNsb25lRGVlcCh0aGlzLnR0SW5zdGFuY2Uuc3RhdGUucm93Tm9kZXMpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBzd2l0Y2ggKGZyb20pIHtcclxuICAgICAgICAgICAgY2FzZSAnc2VydmVyJzpcclxuICAgICAgICAgICAgICAgIHRoaXMuc2VhcmNoT25TZXJ2ZXIoZmllbGQsIHZhbHVlKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgaWYgKHZhbHVlICE9PSAnJyAmJiB2YWx1ZSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdmFsdWVzID0gdGhpcy5zZWFyY2hPbkNsaWVudChmaWVsZCwgdmFsdWUsIHRoaXMuYWxsTm9kZXMpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVNlcmlhbGl6ZWRWYWx1ZXModmFsdWVzKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy50dEluc3RhbmNlLnVwZGF0ZVNlcmlhbGl6ZWRWYWx1ZSgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLnR0SW5zdGFuY2UuY2hlY2tlZHMgJiYgdGhpcy50dEluc3RhbmNlLmNoZWNrZWRzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMudHRJbnN0YW5jZS5jaGVja2VkTm9kZXModGhpcy50dEluc3RhbmNlLmNoZWNrZWRzLm1hcChuID0+IG4uZGF0YVt0aGlzLnR0SW5zdGFuY2UuaWRGaWVsZF0pKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy50dEluc3RhbmNlLmRldGVjdENoYW5nZXMoKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIF91cGRhdGVTZXJpYWxpemVkVmFsdWVzKHZpc2libGVJdGVtczogUm93Tm9kZVtdKSB7XHJcbiAgICAgICAgY29uc3QgcGlkcyA9ICh2aXNpYmxlSXRlbXMubWFwKG4gPT4gWy4uLm4ucGFyZW50cywgbi5pZF0pIGFzIGFueSkuZmxhdCgpO1xyXG4gICAgICAgIGNvbnN0IHBpZEFyciA9IEFycmF5LmZyb20obmV3IFNldChwaWRzKSk7XHJcblxyXG4gICAgICAgIGNvbnN0IHJvd05vZGVzID0gIHRoaXMuYWxsTm9kZXMuZmlsdGVyKG4gPT4gcGlkQXJyLnNvbWUoaXRlbT0+aXRlbT09bi5pZCkpLm1hcChyID0+IHtcclxuICAgICAgICAgICAgci5leHBhbmRlZCA9IHRydWU7XHJcbiAgICAgICAgICAgIHJldHVybiByO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICB0aGlzLnR0SW5zdGFuY2Uuc2VyaWFsaXplZFZhbHVlID0gdGhpcy5yZXNldFRyZWVEYXRhKG51bGwsIHJvd05vZGVzKTtcclxuICAgICAgICB0aGlzLnR0SW5zdGFuY2Uuc3RhdGUucm93Tm9kZXMgPSB0aGlzLnR0SW5zdGFuY2Uuc2VyaWFsaXplZFZhbHVlO1xyXG4gICAgfVxyXG5cclxuICAgIGZpbmRQYXJlbnQoaXRlbTogVHJlZU5vZGUsIGFsbE5vZGVzOiBhbnlbXSkge1xyXG4gICAgICAgIGxldCByZXMgPSBbXTtcclxuICAgICAgICBpZiAoaXRlbSAmJiBhbGxOb2RlcyAmJiBhbGxOb2Rlcy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgY29uc3QgcCA9IGFsbE5vZGVzLmZpbmQodDEgPT4gdDEuaWQgPT09IGl0ZW0uZGF0YVt0aGlzLnR0SW5zdGFuY2UuaWRGaWVsZF0pO1xyXG4gICAgICAgICAgICByZXMucHVzaChwKTtcclxuICAgICAgICAgICAgaWYgKHAucGFyZW50KSB7XHJcbiAgICAgICAgICAgICAgICByZXMgPSByZXMuY29uY2F0KHRoaXMuZmluZFBhcmVudChwLnBhcmVudCwgYWxsTm9kZXMpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gcmVzO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgc2VhcmNoRXhwcmVzc2lvbihpdGVtOiBSb3dOb2RlLCB2YWx1ZTogc3RyaW5nLCBmaWVsZHM6IHN0cmluZ1tdID0gW10pIHtcclxuICAgICAgICBjb25zdCBfZmllbGRzID0gZmllbGRzLmxlbmd0aCA/IGZpZWxkcyA6IHRoaXMudHRJbnN0YW5jZS5jb2x1bW5zLm1hcChjID0+IGMuZmllbGQpO1xyXG4gICAgICAgIGNvbnN0IHJlc3VsdHMgPSBfZmllbGRzLm1hcChmID0+IHtcclxuICAgICAgICAgICAgY29uc3QgdGFyZ2V0VmFsdWUgPSAnJyArICAgdGhpcy5nZXRWYWx1ZShmLCBpdGVtLm5vZGUuZGF0YSk7XHJcbiAgICAgICAgICAgIGlmICh0YXJnZXRWYWx1ZSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHRhcmdldFZhbHVlID09PSAnbnVtYmVyJykge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0YXJnZXRWYWx1ZSA9PT0gcGFyc2VGbG9hdCh2YWx1ZSk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0YXJnZXRWYWx1ZS5pbmRleE9mKHZhbHVlKSA+IC0xO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS53YXJuKGDkuI3lrZjlnKjliJcgJHtmfWApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJldHVybiByZXN1bHRzLnJlZHVjZSgoZmxhZywgY3VycikgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gZmxhZyB8fCBjdXJyO1xyXG4gICAgICAgIH0sIGZhbHNlKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdldFZhbHVlKGZpZWxkLCBkYXRhKSB7XHJcbiAgICAgICAgaWYgKGZpZWxkKSB7XHJcbiAgICAgICAgICAgIGlmIChmaWVsZC5pbmRleE9mKCcuJykgPiAtMSkge1xyXG4gICAgICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBmaWVsZC5zcGxpdCgnLicpLnJlZHVjZSggKHIsIGYpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAocikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcltmXTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9LCBkYXRhICk7XHJcbiAgICAgICAgICAgIH0gY2F0Y2gge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coZmllbGQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZGF0YVtmaWVsZF07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0RmluZFRleHRUb3RhbChmaWVsZDogc3RyaW5nLCB2YWx1ZTogc3RyaW5nLCBub2RlczogUm93Tm9kZVtdKSB7XHJcbiAgICAgICAgbGV0IHQgPSAwO1xyXG4gICAgICAgIGNvbnN0IGdldENvdW50ID0gKGZpZWxkcyk6IGFueSA9PiB7XHJcbiAgICAgICAgICAgIGxldCBjID0gMDtcclxuICAgICAgICAgICAgbm9kZXMuZm9yRWFjaChuID0+IHtcclxuICAgICAgICAgICAgICAgIGZpZWxkcy5mb3JFYWNoKGYgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldFZhbHVlID0gJycgKyAgIHRoaXMuZ2V0VmFsdWUoZiwgbi5ub2RlLmRhdGEpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0YXJnZXRWYWx1ZSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0YXJnZXRWYWx1ZS5pbmRleE9mKHZhbHVlKSA+IC0xKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjKys7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHJldHVybiBjO1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgbGV0IF9maWVsZHMgPSBbZmllbGRdO1xyXG4gICAgICAgIGlmIChmaWVsZCA9PT0gJyonKSB7XHJcbiAgICAgICAgICAgIF9maWVsZHMgPSB0aGlzLnR0SW5zdGFuY2UuY29sdW1ucy5tYXAoYyA9PiBjLmZpZWxkKTtcclxuXHJcbiAgICAgICAgfSBlbHNlIGlmIChmaWVsZC5pbmRleE9mKCcsJykgPiAtMSkge1xyXG4gICAgICAgICAgICBfZmllbGRzID0gZmllbGQuc3BsaXQoJywnKS5tYXAoZiA9PiBmLnRyaW0oKSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0ID0gZ2V0Q291bnQoX2ZpZWxkcyk7XHJcbiAgICAgICAgcmV0dXJuIHQ7XHJcbiAgICB9XHJcblxyXG4gICAgc2VhcmNoT25DbGllbnQoZmllbGQ6IHN0cmluZywgdmFsdWU6IHN0cmluZywgbm9kZXM6IFJvd05vZGVbXSkge1xyXG4gICAgICAgIGxldCByZXN1bHROb2RlczogUm93Tm9kZVtdID0gW107XHJcbiAgICAgICAgaWYgKCF2YWx1ZSkge1xyXG4gICAgICAgICAgICByZXR1cm4gW107XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChmaWVsZCA9PT0gJyonKSB7XHJcbiAgICAgICAgICAgIHJlc3VsdE5vZGVzID0gbm9kZXMuZmlsdGVyKG4gPT4gdGhpcy5zZWFyY2hFeHByZXNzaW9uKG4sIHZhbHVlKSk7XHJcbiAgICAgICAgfSBlbHNlIGlmIChmaWVsZC5pbmRleE9mKCcsJykgPiAtMSkge1xyXG4gICAgICAgICAgICByZXN1bHROb2RlcyA9IG5vZGVzLmZpbHRlcihuID0+IHRoaXMuc2VhcmNoRXhwcmVzc2lvbihuLCB2YWx1ZSwgZmllbGQuc3BsaXQoJywnKS5tYXAoZiA9PiBmLnRyaW0oKSkpKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB2YWx1ZSA9IHZhbHVlLnRvTG93ZXJDYXNlKCk7XHJcbiAgICAgICAgICAgIGlmIChmaWVsZC5pbmRleE9mKCcuJykgPT09IC0xKSB7XHJcbiAgICAgICAgICAgICAgICByZXN1bHROb2RlcyA9IG5vZGVzLmZpbHRlcihuID0+ICgnJyArIG4ubm9kZS5kYXRhW2ZpZWxkXSkudG9Mb3dlckNhc2UoKS5pbmRleE9mKHZhbHVlKSA+IC0xKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHJlc3VsdE5vZGVzID0gbm9kZXMuZmlsdGVyKG4gPT4gKCcnICsgdGhpcy5nZXRWYWx1ZShmaWVsZCwgbi5ub2RlLmRhdGEpKS50b0xvd2VyQ2FzZSgpLmluZGV4T2YodmFsdWUpID4gLTEpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gcmVzdWx0Tm9kZXM7XHJcbiAgICB9XHJcblxyXG4gICAgZmluZFBhcmVudHMocm93Tm9kZXMsIGFsbE5vZGVzKSB7XHJcbiAgICAgICAgbGV0IHJlcyA9IFtdO1xyXG4gICAgICAgIHJvd05vZGVzLmZvckVhY2goaXRlbSA9PiB7XHJcbiAgICAgICAgICAgIHJlcyA9IHJlcy5jb25jYXQodGhpcy5maW5kUGFyZW50KGl0ZW0ubm9kZSwgYWxsTm9kZXMpKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgcmV0dXJuIEFycmF5LmZyb20obmV3IFNldChyZXMpKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHJlc2V0VHJlZURhdGEocGFyZW50Tm9kZTogUm93Tm9kZSwgdmlzaWJsZUl0ZW1zOiBSb3dOb2RlW10pIHtcclxuICAgICAgICBsZXQgcmVzID0gW107XHJcbiAgICAgICAgbGV0IGFyciA9IFtdO1xyXG4gICAgICAgIGlmIChwYXJlbnROb2RlID09PSBudWxsKSB7XHJcbiAgICAgICAgICAgIGFyciA9IHZpc2libGVJdGVtcy5maWx0ZXIodDIgPT4gdDIucGFyZW50ID09PSBwYXJlbnROb2RlKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBwYXJlbnROb2RlLm5vZGUuZXhwYW5kZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICBhcnIgPSB2aXNpYmxlSXRlbXMuZmlsdGVyKHQyID0+IHQyLnBhcmVudCAmJiB0Mi5wYXJlbnQuZGF0YVt0aGlzLnR0SW5zdGFuY2UuaWRGaWVsZF0gPT09IHBhcmVudE5vZGUuaWQpO1xyXG4gICAgICAgICAgICBpZiAoIWFyci5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgIHBhcmVudE5vZGUubm9kZS5jaGlsZHJlbiA9IFtdO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcGFyZW50Tm9kZS5ub2RlLmNoaWxkcmVuID0gYXJyLm1hcCggdG4gPT4gdG4ubm9kZSApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGFyci5mb3JFYWNoKCBhID0+IHtcclxuICAgICAgICAgICAgYS52aXNpYmxlID0gdHJ1ZTtcclxuICAgICAgICAgICAgcmVzLnB1c2goYSk7XHJcbiAgICAgICAgICAgIHJlcyA9IHJlcy5jb25jYXQodGhpcy5yZXNldFRyZWVEYXRhKGEsIHZpc2libGVJdGVtcykpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHJldHVybiByZXM7XHJcblxyXG5cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHNlYXJjaE9uU2VydmVyKGZpZWxkOiBzdHJpbmcsIHZhbHVlOiBzdHJpbmcpIHtcclxuXHJcbiAgICB9XHJcblxyXG59XHJcbiJdfQ==