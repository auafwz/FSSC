import { Injectable, ElementRef } from '@angular/core';
import { StateMachine } from '@farris/devkit';
// tslint:disable: max-line-length
/**
 * 状态机服务
 * @scope FrameComponent
 */
class StateMachineService {
    constructor(stateMachine) {
        this.stateMachine = stateMachine;
        this._clsDefaultName = 'f-form-state-default';
        this._initLoad = true;
        if (this.stateMachine.initialState.name === 'init') {
            window.setTimeout(() => {
                this.initFormState();
            }, 0);
        }
    }
    transit(action) {
        if (action && typeof this.stateMachine[action] === 'function') {
            this.stateMachine[action]();
            this._currentFrameContext = this['context'] && this['context']['frameContext'];
            if (this._initLoad) {
                this.initFormState();
                this._initLoad = false;
            }
            if (!this._currentFrameContext) {
                return;
            }
            const currentRootFrameContext = this.getCurrentRootFrameContext(this._currentFrameContext);
            if (!!currentRootFrameContext) {
                this.toggleFormState(action, currentRootFrameContext);
            }
        }
    }
    getCurrentRootFrameContext(currentFrameContext) {
        let currentRootFrameContext;
        this.getAllRootFrameContext().forEach((rootFc) => {
            if (currentFrameContext.namespace === rootFc.namespace) {
                currentRootFrameContext = rootFc;
            }
        });
        return currentRootFrameContext;
    }
    getFrameContextManagerMap() {
        if (this.stateMachine && this.stateMachine.frameContext) {
            const appContext = this.stateMachine.frameContext.appContext;
            if (appContext) {
                const frameContextManager = appContext.frameContextManager;
                return frameContextManager.getFrameContextMap();
            }
        }
        return null;
        // return this.stateMachine && this.stateMachine.frameContext && this.stateMachine.frameContext.appContext && this.stateMachine.frameContext.appContext.frameContextManager && this.stateMachine.frameContext.appContext.frameContextManager.getFrameContextMap();
    }
    getAllRootFrameContext() {
        const rootFrameContextArr = [];
        this.getFrameContextManagerMap().forEach(item => {
            if ((item['namespace'] === '' && item['parent'] === null) || (item['parent'] !== null && item['namespace'] !== item['parent']['namespace'])) {
                rootFrameContextArr.push(item);
            }
        });
        return rootFrameContextArr;
    }
    initFormState() {
        if (!this.getFrameContextManagerMap()) {
            return;
        }
        this.getAllRootFrameContext().forEach((rootFc) => {
            const rootComponent = rootFc.injector.get(ElementRef, null) || null;
            if (!rootComponent || !rootComponent.nativeElement) {
                return;
            }
            if (!rootComponent.nativeElement.className.includes(this._clsDefaultName) && !rootComponent.nativeElement.className.includes('f-form-state-create') && !rootComponent.nativeElement.className.includes('f-form-state-edit')) {
                this.addCssClass(rootComponent, this._clsDefaultName);
            }
        });
    }
    toggleFormState(action, frameContext) {
        const rootComponent = frameContext.injector.get(ElementRef, null) || null;
        if (!rootComponent || !rootComponent.nativeElement || !action) {
            return;
        }
        action = action.toLowerCase();
        if (action && ['create', 'edit'].includes(action)) {
            if (action === 'create') {
                this.addCssClass(rootComponent, 'f-form-state-create');
            }
            else if (action === 'edit') {
                this.addCssClass(rootComponent, 'f-form-state-edit');
            }
            this.removeCssClass(rootComponent, this._clsDefaultName);
        }
        else {
            ['f-form-state-create', 'f-form-state-edit'].forEach(item => this.removeCssClass(rootComponent, item));
            this.addCssClass(rootComponent, this._clsDefaultName);
        }
    }
    addCssClass(elementRef, className) {
        if (!elementRef || !className || !elementRef.nativeElement) {
            return;
        }
        const originalClassName = elementRef.nativeElement.className || '';
        if (!originalClassName.includes(className)) {
            elementRef.nativeElement.className = `${originalClassName} ${className}`;
        }
    }
    removeCssClass(elementRef, className) {
        if (!elementRef || !className || !elementRef.nativeElement) {
            return;
        }
        const originalClassName = elementRef.nativeElement.className || '';
        if (originalClassName.includes(className)) {
            elementRef.nativeElement.className = originalClassName.split(' ').filter(p => p && p !== className).join(' ');
        }
    }
    getFormRootComponent() {
        if (this.stateMachine && this.stateMachine.frameContext) {
            const viewContext = this.stateMachine.frameContext;
            if (viewContext) {
                const virtualRootContext = viewContext.getVirtualRootFrameContext();
                if (virtualRootContext) {
                    const injector = virtualRootContext.injector;
                    if (typeof injector.get === 'function') {
                        return injector.get(ElementRef, null);
                    }
                }
            }
        }
        return null;
        // return this.stateMachine && this.stateMachine.frameContext && this.stateMachine.frameContext.getVirtualRootFrameContext() && this.stateMachine.frameContext.getVirtualRootFrameContext().injector && typeof this.stateMachine.frameContext.getVirtualRootFrameContext().injector.get === 'function' && this.stateMachine.frameContext.getVirtualRootFrameContext().injector.get<ElementRef>(ElementRef, null) || null;
    }
}
StateMachineService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
StateMachineService.ctorParameters = () => [
    { type: StateMachine }
];
export { StateMachineService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhdGUtbWFjaGluZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL3N0YXRlLW1hY2hpbmUuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN2RCxPQUFPLEVBQUUsWUFBWSxFQUE0QixNQUFNLGdCQUFnQixDQUFDO0FBQ3hFLGtDQUFrQztBQUNsQzs7O0dBR0c7QUFDSCxNQUNNLG1CQUFtQjtJQUV2QixZQUNVLFlBQTBCO1FBQTFCLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBUzVCLG9CQUFlLEdBQUcsc0JBQXNCLENBQUM7UUFDekMsY0FBUyxHQUFHLElBQUksQ0FBQztRQVJ2QixJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMsWUFBWSxDQUFDLElBQUksS0FBSyxNQUFNLEVBQUU7WUFDbEQsTUFBTSxDQUFDLFVBQVUsQ0FBQyxHQUFHLEVBQUU7Z0JBQ3JCLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztZQUN2QixDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7U0FDUDtJQUNILENBQUM7SUFNRCxPQUFPLENBQUMsTUFBYztRQUNwQixJQUFJLE1BQU0sSUFBSSxPQUFPLElBQUksQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLEtBQUssVUFBVSxFQUFFO1lBQzdELElBQUksQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQztZQUM1QixJQUFJLENBQUMsb0JBQW9CLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxjQUFjLENBQUMsQ0FBQztZQUMvRSxJQUFJLElBQUksQ0FBQyxTQUFTLEVBQUU7Z0JBQ2xCLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztnQkFDckIsSUFBSSxDQUFDLFNBQVMsR0FBRyxLQUFLLENBQUM7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QUFhLFVBQVUsRUFBRSxJQUFJLENBQUMsQ0FBQztxQkFDbkQ7aUJBQ0Y7YUFDRjtTQUNGO1FBQ0QsT0FBTyxJQUFJLENBQUM7UUFDWix5WkFBeVo7SUFDM1osQ0FBQzs7O1lBdElGLFVBQVU7Ozs7WUFORixZQUFZOztBQStJckIsT0FBTyxFQUFFLG1CQUFtQixFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBFbGVtZW50UmVmIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IFN0YXRlTWFjaGluZSwgRnJhbWVDb250ZXh0LCBBcHBDb250ZXh0IH0gZnJvbSAnQGZhcnJpcy9kZXZraXQnO1xyXG4vLyB0c2xpbnQ6ZGlzYWJsZTogbWF4LWxpbmUtbGVuZ3RoXHJcbi8qKlxyXG4gKiDnirbmgIHmnLrmnI3liqFcclxuICogQHNjb3BlIEZyYW1lQ29tcG9uZW50XHJcbiAqL1xyXG5ASW5qZWN0YWJsZSgpXHJcbmNsYXNzIFN0YXRlTWFjaGluZVNlcnZpY2Uge1xyXG5cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHByaXZhdGUgc3RhdGVNYWNoaW5lOiBTdGF0ZU1hY2hpbmVcclxuICApIHtcclxuICAgIGlmICh0aGlzLnN0YXRlTWFjaGluZS5pbml0aWFsU3RhdGUubmFtZSA9PT0gJ2luaXQnKSB7XHJcbiAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICB0aGlzLmluaXRGb3JtU3RhdGUoKTtcclxuICAgICAgfSwgMCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIF9jbHNEZWZhdWx0TmFtZSA9ICdmLWZvcm0tc3RhdGUtZGVmYXVsdCc7XHJcbiAgcHJpdmF0ZSBfaW5pdExvYWQgPSB0cnVlO1xyXG4gIHByaXZhdGUgX2N1cnJlbnRGcmFtZUNvbnRleHQ6IGFueVxyXG5cclxuICB0cmFuc2l0KGFjdGlvbjogc3RyaW5nKSB7XHJcbiAgICBpZiAoYWN0aW9uICYmIHR5cGVvZiB0aGlzLnN0YXRlTWFjaGluZVthY3Rpb25dID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgIHRoaXMuc3RhdGVNYWNoaW5lW2FjdGlvbl0oKTtcclxuICAgICAgdGhpcy5fY3VycmVudEZyYW1lQ29udGV4dCA9IHRoaXNbJ2NvbnRleHQnXSAmJiB0aGlzWydjb250ZXh0J11bJ2ZyYW1lQ29udGV4dCddO1xyXG4gICAgICBpZiAodGhpcy5faW5pdExvYWQpIHtcclxuICAgICAgICB0aGlzLmluaXRGb3JtU3RhdGUoKTtcclxuICAgICAgICB0aGlzLl9pbml0TG9hZCA9IGZhbHNlO1xyXG4gICAgICB9XHJcbiAgICAgIGlmICghdGhpcy5fY3VycmVudEZyYW1lQ29udGV4dCkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG4gICAgICBjb25zdCBjdXJyZW50Um9vdEZyYW1lQ29udGV4dCA9IHRoaXMuZ2V0Q3VycmVudFJvb3RGcmFtZUNvbnRleHQodGhpcy5fY3VycmVudEZyYW1lQ29udGV4dCk7XHJcbiAgICAgIGlmICghIWN1cnJlbnRSb290RnJhbWVDb250ZXh0KSB7XHJcbiAgICAgICAgdGhpcy50b2dnbGVGb3JtU3RhdGUoYWN0aW9uLCBjdXJyZW50Um9vdEZyYW1lQ29udGV4dCk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0Q3VycmVudFJvb3RGcmFtZUNvbnRleHQoY3VycmVudEZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0KTogRnJhbWVDb250ZXh0IHtcclxuICAgIGxldCBjdXJyZW50Um9vdEZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0O1xyXG4gICAgdGhpcy5nZXRBbGxSb290RnJhbWVDb250ZXh0KCkuZm9yRWFjaCgocm9vdEZjOiBGcmFtZUNvbnRleHQpID0+IHtcclxuICAgICAgaWYgKGN1cnJlbnRGcmFtZUNvbnRleHQubmFtZXNwYWNlID09PSByb290RmMubmFtZXNwYWNlKSB7XHJcbiAgICAgICAgY3VycmVudFJvb3RGcmFtZUNvbnRleHQgPSByb290RmM7XHJcbiAgICAgIH1cclxuICAgIH0pXHJcbiAgICByZXR1cm4gY3VycmVudFJvb3RGcmFtZUNvbnRleHQ7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGdldEZyYW1lQ29udGV4dE1hbmFnZXJNYXAoKSB7XHJcbiAgICBpZiAodGhpcy5zdGF0ZU1hY2hpbmUgJiYgdGhpcy5zdGF0ZU1hY2hpbmUuZnJhbWVDb250ZXh0KSB7XHJcbiAgICAgIGNvbnN0IGFwcENvbnRleHQgPSB0aGlzLnN0YXRlTWFjaGluZS5mcmFtZUNvbnRleHQuYXBwQ29udGV4dCBhcyBBcHBDb250ZXh0O1xyXG4gICAgICBpZiAoYXBwQ29udGV4dCkge1xyXG4gICAgICAgIGNvbnN0IGZyYW1lQ29udGV4dE1hbmFnZXIgPSBhcHBDb250ZXh0LmZyYW1lQ29udGV4dE1hbmFnZXI7XHJcbiAgICAgICAgcmV0dXJuIGZyYW1lQ29udGV4dE1hbmFnZXIuZ2V0RnJhbWVDb250ZXh0TWFwKCk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBudWxsO1xyXG4gICAgLy8gcmV0dXJuIHRoaXMuc3RhdGVNYWNoaW5lICYmIHRoaXMuc3RhdGVNYWNoaW5lLmZyYW1lQ29udGV4dCAmJiB0aGlzLnN0YXRlTWFjaGluZS5mcmFtZUNvbnRleHQuYXBwQ29udGV4dCAmJiB0aGlzLnN0YXRlTWFjaGluZS5mcmFtZUNvbnRleHQuYXBwQ29udGV4dC5mcmFtZUNvbnRleHRNYW5hZ2VyICYmIHRoaXMuc3RhdGVNYWNoaW5lLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0LmZyYW1lQ29udGV4dE1hbmFnZXIuZ2V0RnJhbWVDb250ZXh0TWFwKCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGdldEFsbFJvb3RGcmFtZUNvbnRleHQoKTogYW55W10ge1xyXG4gICAgY29uc3Qgcm9vdEZyYW1lQ29udGV4dEFyciA9IFtdO1xyXG4gICAgdGhpcy5nZXRGcmFtZUNvbnRleHRNYW5hZ2VyTWFwKCkuZm9yRWFjaChpdGVtID0+IHtcclxuICAgICAgaWYgKChpdGVtWyduYW1lc3BhY2UnXSA9PT0gJycgJiYgaXRlbVsncGFyZW50J10gPT09IG51bGwpIHx8IChpdGVtWydwYXJlbnQnXSAhPT0gbnVsbCAmJiBpdGVtWyduYW1lc3BhY2UnXSAhPT0gaXRlbVsncGFyZW50J11bJ25hbWVzcGFjZSddKSkge1xyXG4gICAgICAgIHJvb3RGcmFtZUNvbnRleHRBcnIucHVzaChpdGVtKTtcclxuICAgICAgfVxyXG4gICAgfSlcclxuXHJcbiAgICByZXR1cm4gcm9vdEZyYW1lQ29udGV4dEFycjtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgaW5pdEZvcm1TdGF0ZSgpIHtcclxuICAgIGlmICghdGhpcy5nZXRGcmFtZUNvbnRleHRNYW5hZ2VyTWFwKCkpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgdGhpcy5nZXRBbGxSb290RnJhbWVDb250ZXh0KCkuZm9yRWFjaCgocm9vdEZjOiBGcmFtZUNvbnRleHQpID0+IHtcclxuICAgICAgY29uc3Qgcm9vdENvbXBvbmVudCA9IHJvb3RGYy5pbmplY3Rvci5nZXQ8RWxlbWVudFJlZj4oRWxlbWVudFJlZiwgbnVsbCkgfHwgbnVsbDtcclxuICAgICAgaWYgKCFyb290Q29tcG9uZW50IHx8ICFyb290Q29tcG9uZW50Lm5hdGl2ZUVsZW1lbnQpIHtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuICAgICAgaWYgKCFyb290Q29tcG9uZW50Lm5hdGl2ZUVsZW1lbnQuY2xhc3NOYW1lLmluY2x1ZGVzKHRoaXMuX2Nsc0RlZmF1bHROYW1lKSAmJiAhcm9vdENvbXBvbmVudC5uYXRpdmVFbGVtZW50LmNsYXNzTmFtZS5pbmNsdWRlcygnZi1mb3JtLXN0YXRlLWNyZWF0ZScpICYmICFyb290Q29tcG9uZW50Lm5hdGl2ZUVsZW1lbnQuY2xhc3NOYW1lLmluY2x1ZGVzKCdmLWZvcm0tc3RhdGUtZWRpdCcpKSB7XHJcbiAgICAgICAgdGhpcy5hZGRDc3NDbGFzcyhyb290Q29tcG9uZW50LCB0aGlzLl9jbHNEZWZhdWx0TmFtZSk7XHJcbiAgICAgIH1cclxuICAgIH0pXHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHRvZ2dsZUZvcm1TdGF0ZShhY3Rpb246IHN0cmluZywgZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQpIHtcclxuICAgIGNvbnN0IHJvb3RDb21wb25lbnQgPSBmcmFtZUNvbnRleHQuaW5qZWN0b3IuZ2V0PEVsZW1lbnRSZWY+KEVsZW1lbnRSZWYsIG51bGwpIHx8IG51bGw7XHJcbiAgICBpZiAoIXJvb3RDb21wb25lbnQgfHwgIXJvb3RDb21wb25lbnQubmF0aXZlRWxlbWVudCB8fCAhYWN0aW9uKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGFjdGlvbiA9IGFjdGlvbi50b0xvd2VyQ2FzZSgpO1xyXG4gICAgaWYgKGFjdGlvbiAmJiBbJ2NyZWF0ZScsICdlZGl0J10uaW5jbHVkZXMoYWN0aW9uKSkge1xyXG4gICAgICBpZiAoYWN0aW9uID09PSAnY3JlYXRlJykge1xyXG4gICAgICAgIHRoaXMuYWRkQ3NzQ2xhc3Mocm9vdENvbXBvbmVudCwgJ2YtZm9ybS1zdGF0ZS1jcmVhdGUnKTtcclxuICAgICAgfSBlbHNlIGlmIChhY3Rpb24gPT09ICdlZGl0Jykge1xyXG4gICAgICAgIHRoaXMuYWRkQ3NzQ2xhc3Mocm9vdENvbXBvbmVudCwgJ2YtZm9ybS1zdGF0ZS1lZGl0Jyk7XHJcbiAgICAgIH1cclxuICAgICAgdGhpcy5yZW1vdmVDc3NDbGFzcyhyb290Q29tcG9uZW50LCB0aGlzLl9jbHNEZWZhdWx0TmFtZSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBbJ2YtZm9ybS1zdGF0ZS1jcmVhdGUnLCAnZi1mb3JtLXN0YXRlLWVkaXQnXS5mb3JFYWNoKGl0ZW0gPT4gdGhpcy5yZW1vdmVDc3NDbGFzcyhyb290Q29tcG9uZW50LCBpdGVtKSk7XHJcbiAgICAgIHRoaXMuYWRkQ3NzQ2xhc3Mocm9vdENvbXBvbmVudCwgdGhpcy5fY2xzRGVmYXVsdE5hbWUpO1xyXG4gICAgfVxyXG4gIH1cclxuICBwcml2YXRlIGFkZENzc0NsYXNzKGVsZW1lbnRSZWY6IEVsZW1lbnRSZWYsIGNsYXNzTmFtZTogc3RyaW5nKSB7XHJcbiAgICBpZiAoIWVsZW1lbnRSZWYgfHwgIWNsYXNzTmFtZSB8fCAhZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50KSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGNvbnN0IG9yaWdpbmFsQ2xhc3NOYW1lOiBzdHJpbmcgPSBlbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQuY2xhc3NOYW1lIHx8ICcnO1xyXG4gICAgaWYgKCFvcmlnaW5hbENsYXNzTmFtZS5pbmNsdWRlcyhjbGFzc05hbWUpKSB7XHJcbiAgICAgIGVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5jbGFzc05hbWUgPSBgJHtvcmlnaW5hbENsYXNzTmFtZX0gJHtjbGFzc05hbWV9YDtcclxuICAgIH1cclxuICB9XHJcbiAgcHJpdmF0ZSByZW1vdmVDc3NDbGFzcyhlbGVtZW50UmVmOiBFbGVtZW50UmVmLCBjbGFzc05hbWU6IHN0cmluZykge1xyXG4gICAgaWYgKCFlbGVtZW50UmVmIHx8ICFjbGFzc05hbWUgfHwgIWVsZW1lbnRSZWYubmF0aXZlRWxlbWVudCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBjb25zdCBvcmlnaW5hbENsYXNzTmFtZTogc3RyaW5nID0gZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LmNsYXNzTmFtZSB8fCAnJztcclxuICAgIGlmIChvcmlnaW5hbENsYXNzTmFtZS5pbmNsdWRlcyhjbGFzc05hbWUpKSB7XHJcbiAgICAgIGVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5jbGFzc05hbWUgPSBvcmlnaW5hbENsYXNzTmFtZS5zcGxpdCgnICcpLmZpbHRlcihwID0+IHAgJiYgcCAhPT0gY2xhc3NOYW1lKS5qb2luKCcgJyk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIHByaXZhdGUgZ2V0Rm9ybVJvb3RDb21wb25lbnQoKSB7XHJcbiAgICBpZiAodGhpcy5zdGF0ZU1hY2hpbmUgJiYgdGhpcy5zdGF0ZU1hY2hpbmUuZnJhbWVDb250ZXh0KSB7XHJcbiAgICAgIGNvbnN0IHZpZXdDb250ZXh0ID0gdGhpcy5zdGF0ZU1hY2hpbmUuZnJhbWVDb250ZXh0O1xyXG4gICAgICBpZiAodmlld0NvbnRleHQpIHtcclxuICAgICAgICBjb25zdCB2aXJ0dWFsUm9vdENvbnRleHQgPSB2aWV3Q29udGV4dC5nZXRWaXJ0dWFsUm9vdEZyYW1lQ29udGV4dCgpO1xyXG4gICAgICAgIGlmICh2aXJ0dWFsUm9vdENvbnRleHQpIHtcclxuICAgICAgICAgIGNvbnN0IGluamVjdG9yID0gdmlydHVhbFJvb3RDb250ZXh0LmluamVjdG9yO1xyXG4gICAgICAgICAgaWYgKHR5cGVvZiBpbmplY3Rvci5nZXQgPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGluamVjdG9yLmdldDxFbGVtZW50UmVmPihFbGVtZW50UmVmLCBudWxsKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBudWxsO1xyXG4gICAgLy8gcmV0dXJuIHRoaXMuc3RhdGVNYWNoaW5lICYmIHRoaXMuc3RhdGVNYWNoaW5lLmZyYW1lQ29udGV4dCAmJiB0aGlzLnN0YXRlTWFjaGluZS5mcmFtZUNvbnRleHQuZ2V0VmlydHVhbFJvb3RGcmFtZUNvbnRleHQoKSAmJiB0aGlzLnN0YXRlTWFjaGluZS5mcmFtZUNvbnRleHQuZ2V0VmlydHVhbFJvb3RGcmFtZUNvbnRleHQoKS5pbmplY3RvciAmJiB0eXBlb2YgdGhpcy5zdGF0ZU1hY2hpbmUuZnJhbWVDb250ZXh0LmdldFZpcnR1YWxSb290RnJhbWVDb250ZXh0KCkuaW5qZWN0b3IuZ2V0ID09PSAnZnVuY3Rpb24nICYmIHRoaXMuc3RhdGVNYWNoaW5lLmZyYW1lQ29udGV4dC5nZXRWaXJ0dWFsUm9vdEZyYW1lQ29udGV4dCgpLmluamVjdG9yLmdldDxFbGVtZW50UmVmPihFbGVtZW50UmVmLCBudWxsKSB8fCBudWxsO1xyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IHsgU3RhdGVNYWNoaW5lU2VydmljZSB9O1xyXG4iXX0=