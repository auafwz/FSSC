/*
 * @Author: 疯狂秀才(lucas huang)
 * @Date: 2018-11-07 16:31:57
 * @LastEditors: 疯狂秀才(Lucas Huang)
 * @LastEditTime: 2019-09-27 14:57:22
 * @Company: Inspur
 * @Version: v0.0.1
 */
/**
 * 使用方法：
 * [data-mapping]="{ id: 'user.userId', name: 'user.userName' }"
 * key 为帮助上的字段， value 为 表单中的字段名
 * 帮助上的同一个字段可以映射到表单中的多个字段中，{ ... id: 'user.userid, user.addusid'}
 * 多字段以逗号隔开
 *
 */
import { Directive, Optional, Self, Input } from '@angular/core';
import { BindingObject, ViewModel } from '@farris/devkit';
import { LookupGridComponent } from '@farris/ui-lookup';
import { isNumber } from 'lodash-es';
export class LookupDataMappingDirective {
    constructor(vm, lookup) {
        this.vm = vm;
        this.lookup = lookup;
        this.target = null;
    }
    ngOnInit() {
        this.lookup.selectedData.subscribe((data) => {
            const _mapfields = this.mapfields || this.lookup.mapFields;
            this.mappingData(data, _mapfields);
        });
        this.lookup.clear.subscribe(() => {
            const _mapfields = this.mapfields || this.lookup.mapFields;
            this.mappingData(null, _mapfields);
        });
    }
    /**
     *
     * @param helpData 清空时，值为null
     * @param mapFields 格式形如：{id: "assoField.assoField", code: "assoField.assoField_Code", name: "assoField.assoField_Name"}
     */
    mappingData(helpData, mapFields) {
        if (!mapFields) {
            return;
        }
        // 关闭变更检测
        const appContext = this.vm.frameContext.appContext;
        appContext.changeDetectionController.detach();
        let helpFields = Object.keys(mapFields);
        let basePaths;
        // 映射到目标主键的源字段数组
        let primaryKeys;
        // 目标主键字段数组
        let primaryFields;
        basePaths = this.getBindingPathArray();
        const primaryInfo = this.getMapFieldsPrimaryKey(mapFields, basePaths);
        primaryKeys = primaryInfo && primaryInfo.map(item => item.primaryKey) || [];
        primaryFields = primaryInfo && primaryInfo.map(item => item.primaryField) || [];
        // 对映射中的key进行排序，使映射到目标主键的key排到前面
        helpFields = this.sortMapFieldKeys(helpFields, primaryKeys);
        if (!helpData) {
            helpFields.reverse();
        }
        this.mapping(helpFields, mapFields, helpData, primaryFields, basePaths);
        // 重新打开变更检测
        appContext.changeDetectionController.reattach();
    }
    mapping(sortedKeyFields, mapFields, helpData, targetPrimaryFields, basePaths) {
        sortedKeyFields.forEach((field) => {
            const val = this.getHelpValue(field, helpData);
            let mappings = mapFields[field].split(',');
            const headMappings = mappings.filter(p => targetPrimaryFields.includes(p));
            const leftMappings = mappings.filter(p => !targetPrimaryFields.includes(p));
            if (!helpData) {
                mappings = [].concat(leftMappings).concat(headMappings);
            }
            else {
                mappings = [].concat(headMappings).concat(leftMappings);
            }
            this.updateTarget(mappings, basePaths, helpData, val);
        });
    }
    updateTarget(mappings, basePaths, helpData, value) {
        mappings.forEach((targetFieldPath) => {
            this.updateTargetValue(basePaths, targetFieldPath, value, helpData);
        });
    }
    updateTargetValue(basePaths, targetFieldPath, value, helpData) {
        if (this.target) {
            const paths = targetFieldPath.split('.');
            this.setValue(this.target, paths, value);
        }
        else {
            const paths = basePaths.concat(targetFieldPath.split('.'));
            if (!helpData) {
                this.vm.bindingData.clearValue(paths, true, true, { frameContext: this.vm.frameContext });
            }
            else {
                this.vm.bindingData.setValue(paths, value, true, true, null, { frameContext: this.vm.frameContext });
            }
        }
    }
    /**
     * 获取帮助字段对应的值
     * @param field 帮助字段
     * @param helpData 帮助数据
     * @returns
     */
    getHelpValue(field, helpData) {
        let value = '';
        if (helpData) {
            if (helpData instanceof Array) {
                value = helpData.map((item) => {
                    return this.getValue(field, item);
                }).join(',');
            }
            else {
                value = this.getValue(field, helpData);
            }
        }
        return value;
    }
    getValue(f, data) {
        let val = '';
        if (f.indexOf('.') === -1) {
            val = data[f];
        }
        else {
            val = f.split('.').reduce((a, b) => {
                return a[b];
            }, data);
        }
        return val;
    }
    setValue(target, paths, value) {
        if (target) {
            if (paths.length <= 1) {
                target[paths[0]] = value;
            }
            else {
                paths.slice(0, -1).reduce((prev, path) => {
                    if (!(prev.hasOwnProperty(path) || prev['__proto__'].hasOwnProperty(path))) {
                        prev[path] = {};
                    }
                    return prev[path];
                }, target)[paths[paths.length - 1]] = value;
            }
        }
    }
    getBindingPathArray() {
        const path = this.vm.bindingPath;
        if (path) {
            return path.split('/').filter(n => n !== '');
        }
        return [];
    }
    isNumberValue(field, data) {
        const currentVal = this.getValue(field, data);
        return isNumber(currentVal);
    }
    /**
     *
     * @param mapFields  格式形如：{id: "assoField.assoField", code: "assoField.assoField_Code", name: "assoField.assoField_Name"} 或者 {id:'vid',code:'code',name:'name'}
     */
    getMapFieldsPrimaryKey(mapFields, bindingPaths) {
        if (!mapFields || Object.keys(mapFields).length < 1) {
            return null;
        }
        const results = [];
        // let primaryField = null;
        try {
            const entityTypeInfo = this.vm.frameContext.repository.entityTypeInfo;
            Object.keys(mapFields).forEach((key) => {
                const mapField = mapFields[key];
                if (mapField && typeof mapField === 'string') {
                    const mappings = mapField.split(',').filter(p => p);
                    mappings.forEach((item) => {
                        let paths = item.split('.');
                        if (bindingPaths && bindingPaths.length > 0) {
                            paths = bindingPaths.concat(paths);
                        }
                        const propInfo = entityTypeInfo.getPropInfoByPath(paths);
                        if (propInfo && propInfo.metadataInfo && propInfo.metadataInfo.primary === true) {
                            results.push({
                                primaryKey: key,
                                primaryField: item
                            });
                        }
                    });
                }
            });
        }
        catch (e) {
            console.error(e);
        }
        return results;
    }
    sortMapFieldKeys(keys, primaryKeys) {
        if (!primaryKeys || primaryKeys.length < 1 || !keys || keys.length < 1) {
            return keys;
        }
        primaryKeys = [...new Set(primaryKeys)];
        // 过滤出非主键映射字段
        keys = keys.filter(p => !primaryKeys.includes(p));
        return [].concat(primaryKeys).concat(keys);
    }
}
LookupDataMappingDirective.decorators = [
    { type: Directive, args: [{ selector: '[data-mapping]' },] }
];
/** @nocollapse */
LookupDataMappingDirective.ctorParameters = () => [
    { type: ViewModel, decorators: [{ type: Optional }] },
    { type: LookupGridComponent, decorators: [{ type: Optional }, { type: Self }] }
];
LookupDataMappingDirective.propDecorators = {
    mapfields: [{ type: Input, args: ['data-mapping',] }],
    target: [{ type: Input, args: ['target',] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9va3VwLWRhdGEtbWFwcGluZy5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2tlbmRvLWJpbmRpbmcvIiwic291cmNlcyI6WyJsaWIvZGlyZWN0aXZlcy9sb29rdXAtZGF0YS1tYXBwaW5nLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7OztHQU9HO0FBRUg7Ozs7Ozs7R0FPRztBQUVILE9BQU8sRUFBRSxTQUFTLEVBQVUsUUFBUSxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDekUsT0FBTyxFQUFFLGFBQWEsRUFBOEIsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDdEYsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDeEQsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUdyQyxNQUFNLE9BQU8sMEJBQTBCO0lBS3JDLFlBQWdDLEVBQWEsRUFBOEIsTUFBMkI7UUFBdEUsT0FBRSxHQUFGLEVBQUUsQ0FBVztRQUE4QixXQUFNLEdBQU4sTUFBTSxDQUFxQjtRQUZyRixXQUFNLEdBQWtCLElBQUksQ0FBQztJQUU0RCxDQUFDO0lBRTNHLFFBQVE7UUFDTixJQUFJLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxTQUFTLENBQUMsQ0FBQyxJQUFTLEVBQUUsRUFBRTtZQUMvQyxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsU0FBUyxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDO1lBQzNELElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxFQUFFLFVBQVUsQ0FBQyxDQUFDO1FBQ3JDLENBQUMsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLEdBQUcsRUFBRTtZQUMvQixNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsU0FBUyxJQUFJLElBQUksQ0FBQyxNQUFNLENB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QUNWLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDbEI7UUFDRCxPQUFPLE9BQU8sQ0FBQztJQUNqQixDQUFDO0lBQ08sZ0JBQWdCLENBQUMsSUFBYyxFQUFFLFdBQXFCO1FBQzVELElBQUksQ0FBQyxXQUFXLElBQUksV0FBVyxDQUFDLE1BQU0sR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDdEUsT0FBTyxJQUFJLENBQUM7U0FDYjtRQUNELFdBQVcsR0FBRyxDQUFDLEdBQUcsSUFBSSxHQUFHLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQztRQUN4QyxhQUFhO1FBQ2IsSUFBSSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNsRCxPQUFPLEVBQUUsQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzdDLENBQUM7OztZQXhMRixTQUFTLFNBQUMsRUFBRSxRQUFRLEVBQUUsZ0JBQWdCLEVBQUU7Ozs7WUFKVyxTQUFTLHVCQVU5QyxRQUFRO1lBVGQsbUJBQW1CLHVCQVNzQixRQUFRLFlBQUksSUFBSTs7O3dCQUgvRCxLQUFLLFNBQUMsY0FBYztxQkFDcEIsS0FBSyxTQUFDLFFBQVEiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxyXG4gKiBAQXV0aG9yOiDnlq/ni4Lnp4DmiY0obHVjYXMgaHVhbmcpXHJcbiAqIEBEYXRlOiAyMDE4LTExLTA3IDE2OjMxOjU3XHJcbiAqIEBMYXN0RWRpdG9yczog55av54uC56eA5omNKEx1Y2FzIEh1YW5nKVxyXG4gKiBATGFzdEVkaXRUaW1lOiAyMDE5LTA5LTI3IDE0OjU3OjIyXHJcbiAqIEBDb21wYW55OiBJbnNwdXJcclxuICogQFZlcnNpb246IHYwLjAuMVxyXG4gKi9cclxuXHJcbi8qKlxyXG4gKiDkvb/nlKjmlrnms5XvvJpcclxuICogW2RhdGEtbWFwcGluZ109XCJ7IGlkOiAndXNlci51c2VySWQnLCBuYW1lOiAndXNlci51c2VyTmFtZScgfVwiXHJcbiAqIGtleSDkuLrluK7liqnkuIrnmoTlrZfmrrXvvIwgdmFsdWUg5Li6IOihqOWNleS4reeahOWtl+auteWQjVxyXG4gKiDluK7liqnkuIrnmoTlkIzkuIDkuKrlrZfmrrXlj6/ku6XmmKDlsITliLDooajljZXkuK3nmoTlpJrkuKrlrZfmrrXkuK3vvIx7IC4uLiBpZDogJ3VzZXIudXNlcmlkLCB1c2VyLmFkZHVzaWQnfVxyXG4gKiDlpJrlrZfmrrXku6XpgJflj7fpmpTlvIBcclxuICpcclxuICovXHJcblxyXG5pbXBvcnQgeyBEaXJlY3RpdmUsIE9uSW5pdCwgT3B0aW9uYWwsIFNlbGYsIElucHV0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEJpbmRpbmdPYmplY3QsIERhdGFQcm9wSW5mbywgRGF0YVR5cGVJbmZvLCBWaWV3TW9kZWwgfSBmcm9tICdAZmFycmlzL2RldmtpdCc7XHJcbmltcG9ydCB7IExvb2t1cEdyaWRDb21wb25lbnQgfSBmcm9tICdAZmFycmlzL3VpLWxvb2t1cCc7XHJcbmltcG9ydCB7IGlzTnVtYmVyIH0gZnJvbSAnbG9kYXNoLWVzJztcclxuXHJcbkBEaXJlY3RpdmUoeyBzZWxlY3RvcjogJ1tkYXRhLW1hcHBpbmddJyB9KVxyXG5leHBvcnQgY2xhc3MgTG9va3VwRGF0YU1hcHBpbmdEaXJlY3RpdmUgaW1wbGVtZW50cyBPbkluaXQge1xyXG5cclxuICBASW5wdXQoJ2RhdGEtbWFwcGluZycpIG1hcGZpZWxkczogYW55O1xyXG4gIEBJbnB1dCgndGFyZ2V0JykgdGFyZ2V0OiBCaW5kaW5nT2JqZWN0ID0gbnVsbDtcclxuXHJcbiAgY29uc3RydWN0b3IoQE9wdGlvbmFsKCkgcHJpdmF0ZSB2bTogVmlld01vZGVsLCBAT3B0aW9uYWwoKSBAU2VsZigpIHByaXZhdGUgbG9va3VwOiBMb29rdXBHcmlkQ29tcG9uZW50KSB7IH1cclxuXHJcbiAgbmdPbkluaXQoKSB7XHJcbiAgICB0aGlzLmxvb2t1cC5zZWxlY3RlZERhdGEuc3Vic2NyaWJlKChkYXRhOiBhbnkpID0+IHtcclxuICAgICAgY29uc3QgX21hcGZpZWxkcyA9IHRoaXMubWFwZmllbGRzIHx8IHRoaXMubG9va3VwLm1hcEZpZWxkcztcclxuICAgICAgdGhpcy5tYXBwaW5nRGF0YShkYXRhLCBfbWFwZmllbGRzKTtcclxuICAgIH0pO1xyXG5cclxuICAgIHRoaXMubG9va3VwLmNsZWFyLnN1YnNjcmliZSgoKSA9PiB7XHJcbiAgICAgIGNvbnN0IF9tYXBmaWVsZHMgPSB0aGlzLm1hcGZpZWxkcyB8fCB0aGlzLmxvb2t1cC5tYXBGaWVsZHM7XHJcbiAgICAgIHRoaXMubWFwcGluZ0RhdGEobnVsbCwgX21hcGZpZWxkcyk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFxyXG4gICAqIEBwYXJhbSBoZWxwRGF0YSDmuIXnqbrml7bvvIzlgLzkuLpudWxsXHJcbiAgICogQHBhcmFtIG1hcEZpZWxkcyDmoLzlvI/lvaLlpoLvvJp7aWQ6IFwiYXNzb0ZpZWxkLmFzc29GaWVsZFwiLCBjb2RlOiBcImFzc29GaWVsZC5hc3NvRmllbGRfQ29kZVwiLCBuYW1lOiBcImFzc29GaWVsZC5hc3NvRmllbGRfTmFtZVwifVxyXG4gICAqL1xyXG4gIG1hcHBpbmdEYXRhKGhlbHBEYXRhOiBhbnksIG1hcEZpZWxkczogYW55KSB7XHJcbiAgICBpZiAoIW1hcEZpZWxkcykge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICAvLyDlhbPpl63lj5jmm7Tmo4DmtYtcclxuICAgIGNvbnN0IGFwcENvbnRleHQgPSB0aGlzLnZtLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0O1xyXG4gICAgYXBwQ29udGV4dC5jaGFuZ2VEZXRlY3Rpb25Db250cm9sbGVyLmRldGFjaCgpO1xyXG4gICAgbGV0IGhlbHBGaWVsZHMgPSBPYmplY3Qua2V5cyhtYXBGaWVsZHMpO1xyXG4gICAgbGV0IGJhc2VQYXRoczogYW55W107XHJcbiAgICAvLyDmmKDlsITliLDnm67moIfkuLvplK7nmoTmupDlrZfmrrXmlbDnu4RcclxuICAgIGxldCBwcmltYXJ5S2V5czogc3RyaW5nW107XHJcbiAgICAvLyDnm67moIfkuLvplK7lrZfmrrXmlbDnu4RcclxuICAgIGxldCBwcmltYXJ5RmllbGRzOiBzdHJpbmdbXTtcclxuICAgIGJhc2VQYXRocyA9IHRoaXMuZ2V0QmluZGluZ1BhdGhBcnJheSgpO1xyXG4gICAgY29uc3QgcHJpbWFyeUluZm8gPSB0aGlzLmdldE1hcEZpZWxkc1ByaW1hcnlLZXkobWFwRmllbGRzLCBiYXNlUGF0aHMpO1xyXG4gICAgcHJpbWFyeUtleXMgPSBwcmltYXJ5SW5mbyAmJiBwcmltYXJ5SW5mby5tYXAoaXRlbSA9PiBpdGVtLnByaW1hcnlLZXkpIHx8IFtdO1xyXG4gICAgcHJpbWFyeUZpZWxkcyA9IHByaW1hcnlJbmZvICYmIHByaW1hcnlJbmZvLm1hcChpdGVtID0+IGl0ZW0ucHJpbWFyeUZpZWxkKSB8fCBbXTtcclxuICAgIC8vIOWvueaYoOWwhOS4reeahGtleei/m+ihjOaOkuW6j++8jOS9v+aYoOWwhOWIsOebruagh+S4u+mUrueahGtleeaOkuWIsOWJjemdolxyXG4gICAgaGVscEZpZWxkcyA9IHRoaXMuc29ydE1hcEZpZWxkS2V5cyhoZWxwRmllbGRzLCBwcmltYXJ5S2V5cyk7XHJcbiAgICBpZiAoIWhlbHBEYXRhKSB7XHJcbiAgICAgIGhlbHBGaWVsZHMucmV2ZXJzZSgpO1xyXG4gICAgfVxyXG4gICAgdGhpcy5tYXBwaW5nKGhlbHBGaWVsZHMsIG1hcEZpZWxkcywgaGVscERhdGEsIHByaW1hcnlGaWVsZHMsIGJhc2VQYXRocyk7XHJcbiAgICAvLyDph43mlrDmiZPlvIDlj5jmm7Tmo4DmtYtcclxuICAgIGFwcENvbnRleHQuY2hhbmdlRGV0ZWN0aW9uQ29udHJvbGxlci5yZWF0dGFjaCgpO1xyXG4gIH1cclxuICBwcml2YXRlIG1hcHBpbmcoc29ydGVkS2V5RmllbGRzOiBzdHJpbmdbXSwgbWFwRmllbGRzOiBhbnksIGhlbHBEYXRhOiBhbnksIHRhcmdldFByaW1hcnlGaWVsZHM6IHN0cmluZ1tdLCBiYXNlUGF0aHM6IHN0cmluZ1tdKSB7XHJcbiAgICBzb3J0ZWRLZXlGaWVsZHMuZm9yRWFjaCgoZmllbGQ6IGFueSkgPT4ge1xyXG4gICAgICBjb25zdCB2YWwgPSB0aGlzLmdldEhlbHBWYWx1ZShmaWVsZCwgaGVscERhdGEpO1xyXG4gICAgICBsZXQgbWFwcGluZ3M6IGFueVtdID0gbWFwRmllbGRzW2ZpZWxkXS5zcGxpdCgnLCcpO1xyXG4gICAgICBjb25zdCBoZWFkTWFwcGluZ3MgPSBtYXBwaW5ncy5maWx0ZXIocCA9PiB0YXJnZXRQcmltYXJ5RmllbGRzLmluY2x1ZGVzKHApKTtcclxuICAgICAgY29uc3QgbGVmdE1hcHBpbmdzID0gbWFwcGluZ3MuZmlsdGVyKHAgPT4gIXRhcmdldFByaW1hcnlGaWVsZHMuaW5jbHVkZXMocCkpO1xyXG4gICAgICBpZiAoIWhlbHBEYXRhKSB7XHJcbiAgICAgICAgbWFwcGluZ3MgPSBbXS5jb25jYXQobGVmdE1hcHBpbmdzKS5jb25jYXQoaGVhZE1hcHBpbmdzKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBtYXBwaW5ncyA9IFtdLmNvbmNhdChoZWFkTWFwcGluZ3MpLmNvbmNhdChsZWZ0TWFwcGluZ3MpO1xyXG4gICAgICB9XHJcbiAgICAgIHRoaXMudXBkYXRlVGFyZ2V0KG1hcHBpbmdzLCBiYXNlUGF0aHMsIGhlbHBEYXRhLCB2YWwpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG4gIHByaXZhdGUgdXBkYXRlVGFyZ2V0KG1hcHBpbmdzOiBzdHJpbmdbXSwgYmFzZVBhdGhzOiBzdHJpbmdbXSwgaGVscERhdGE6IGFueSwgdmFsdWU6IGFueSkge1xyXG4gICAgbWFwcGluZ3MuZm9yRWFjaCgodGFyZ2V0RmllbGRQYXRoOiBhbnkpID0+IHtcclxuICAgICAgdGhpcy51cGRhdGVUYXJnZXRWYWx1ZShiYXNlUGF0aHMsIHRhcmdldEZpZWxkUGF0aCwgdmFsdWUsIGhlbHBEYXRhKTtcclxuICAgIH0pO1xyXG4gIH1cclxuICBwcml2YXRlIHVwZGF0ZVRhcmdldFZhbHVlKGJhc2VQYXRoczogc3RyaW5nW10sIHRhcmdldEZpZWxkUGF0aCwgdmFsdWU6IGFueSwgaGVscERhdGE6IGFueSkge1xyXG4gICAgaWYgKHRoaXMudGFyZ2V0KSB7XHJcbiAgICAgIGNvbnN0IHBhdGhzID0gdGFyZ2V0RmllbGRQYXRoLnNwbGl0KCcuJyk7XHJcbiAgICAgIHRoaXMuc2V0VmFsdWUodGhpcy50YXJnZXQsIHBhdGhzLCB2YWx1ZSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBjb25zdCBwYXRocyA9IGJhc2VQYXRocy5jb25jYXQodGFyZ2V0RmllbGRQYXRoLnNwbGl0KCcuJykpO1xyXG4gICAgICBpZiAoIWhlbHBEYXRhKSB7XHJcbiAgICAgICAgdGhpcy52bS5iaW5kaW5nRGF0YS5jbGVhclZhbHVlKHBhdGhzLCB0cnVlLCB0cnVlLCB7IGZyYW1lQ29udGV4dDogdGhpcy52bS5mcmFtZUNvbnRleHQgfSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdGhpcy52bS5iaW5kaW5nRGF0YS5zZXRWYWx1ZShwYXRocywgdmFsdWUsIHRydWUsIHRydWUsIG51bGwsIHsgZnJhbWVDb250ZXh0OiB0aGlzLnZtLmZyYW1lQ29udGV4dCB9KTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuICAvKipcclxuICAgKiDojrflj5bluK7liqnlrZfmrrXlr7nlupTnmoTlgLxcclxuICAgKiBAcGFyYW0gZmllbGQg5biu5Yqp5a2X5q61XHJcbiAgICogQHBhcmFtIGhlbHBEYXRhIOW4ruWKqeaVsOaNrlxyXG4gICAqIEByZXR1cm5zIFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0SGVscFZhbHVlKGZpZWxkOiBzdHJpbmcsIGhlbHBEYXRhOiBhbnkpIHtcclxuICAgIGxldCB2YWx1ZTogYW55ID0gJyc7XHJcbiAgICBpZiAoaGVscERhdGEpIHtcclxuICAgICAgaWYgKGhlbHBEYXRhIGluc3RhbmNlb2YgQXJyYXkpIHtcclxuICAgICAgICB2YWx1ZSA9IGhlbHBEYXRhLm1hcCgoaXRlbTogYW55KSA9PiB7XHJcbiAgICAgICAgICByZXR1cm4gdGhpcy5nZXRWYWx1ZShmaWVsZCwgaXRlbSk7XHJcbiAgICAgICAgfSkuam9pbignLCcpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHZhbHVlID0gdGhpcy5nZXRWYWx1ZShmaWVsZCwgaGVscERhdGEpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdmFsdWU7XHJcbiAgfVxyXG4gIHByaXZhdGUgZ2V0VmFsdWUoZjogc3RyaW5nLCBkYXRhOiBhbnkpIHtcclxuICAgIGxldCB2YWwgPSAnJztcclxuICAgIGlmIChmLmluZGV4T2YoJy4nKSA9PT0gLTEpIHtcclxuICAgICAgdmFsID0gZGF0YVtmXTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHZhbCA9IGYuc3BsaXQoJy4nKS5yZWR1Y2UoKGEsIGIpID0+IHtcclxuICAgICAgICByZXR1cm4gYVtiXTtcclxuICAgICAgfSwgZGF0YSk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHZhbDtcclxuICB9XHJcbiAgcHJpdmF0ZSBzZXRWYWx1ZSh0YXJnZXQ6IG9iamVjdCwgcGF0aHM6IHN0cmluZ1tdLCB2YWx1ZTogYW55KSB7XHJcbiAgICBpZiAodGFyZ2V0KSB7XHJcbiAgICAgIGlmIChwYXRocy5sZW5ndGggPD0gMSkge1xyXG4gICAgICAgIHRhcmdldFtwYXRoc1swXV0gPSB2YWx1ZTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBwYXRocy5zbGljZSgwLCAtMSkucmVkdWNlKChwcmV2LCBwYXRoKSA9PiB7XHJcbiAgICAgICAgICBpZiAoIShwcmV2Lmhhc093blByb3BlcnR5KHBhdGgpIHx8IHByZXZbJ19fcHJvdG9fXyddLmhhc093blByb3BlcnR5KHBhdGgpKSkge1xyXG4gICAgICAgICAgICBwcmV2W3BhdGhdID0ge307XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICByZXR1cm4gcHJldltwYXRoXTtcclxuICAgICAgICB9LCB0YXJnZXQpW3BhdGhzW3BhdGhzLmxlbmd0aCAtIDFdXSA9IHZhbHVlO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG4gIHByaXZhdGUgZ2V0QmluZGluZ1BhdGhBcnJheSgpOiBhbnlbXSB7XHJcbiAgICBjb25zdCBwYXRoID0gdGhpcy52bS5iaW5kaW5nUGF0aDtcclxuICAgIGlmIChwYXRoKSB7XHJcbiAgICAgIHJldHVybiBwYXRoLnNwbGl0KCcvJykuZmlsdGVyKG4gPT4gbiAhPT0gJycpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIFtdO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBpc051bWJlclZhbHVlKGZpZWxkLCBkYXRhKSB7XHJcbiAgICBjb25zdCBjdXJyZW50VmFsID0gdGhpcy5nZXRWYWx1ZShmaWVsZCwgZGF0YSk7XHJcbiAgICByZXR1cm4gaXNOdW1iZXIoY3VycmVudFZhbCk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIFxyXG4gICAqIEBwYXJhbSBtYXBGaWVsZHMgIOagvOW8j+W9ouWmgu+8mntpZDogXCJhc3NvRmllbGQuYXNzb0ZpZWxkXCIsIGNvZGU6IFwiYXNzb0ZpZWxkLmFzc29GaWVsZF9Db2RlXCIsIG5hbWU6IFwiYXNzb0ZpZWxkLmFzc29GaWVsZF9OYW1lXCJ9IOaIluiAhSB7aWQ6J3ZpZCcsY29kZTonY29kZScsbmFtZTonbmFtZSd9XHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXRNYXBGaWVsZHNQcmltYXJ5S2V5KG1hcEZpZWxkczogYW55LCBiaW5kaW5nUGF0aHM6IHN0cmluZ1tdKTogQXJyYXk8eyBwcmltYXJ5S2V5OiBzdHJpbmcsIHByaW1hcnlGaWVsZDogc3RyaW5nIH0+IHtcclxuICAgIGlmICghbWFwRmllbGRzIHx8IE9iamVjdC5rZXlzKG1hcEZpZWxkcykubGVuZ3RoIDwgMSkge1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuICAgIGNvbnN0IHJlc3VsdHMgPSBbXTtcclxuICAgIC8vIGxldCBwcmltYXJ5RmllbGQgPSBudWxsO1xyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3QgZW50aXR5VHlwZUluZm86IERhdGFUeXBlSW5mbyA9IHRoaXMudm0uZnJhbWVDb250ZXh0LnJlcG9zaXRvcnkuZW50aXR5VHlwZUluZm87XHJcbiAgICAgIE9iamVjdC5rZXlzKG1hcEZpZWxkcykuZm9yRWFjaCgoa2V5OiBzdHJpbmcpID0+IHtcclxuICAgICAgICBjb25zdCBtYXBGaWVsZCA9IG1hcEZpZWxkc1trZXldO1xyXG4gICAgICAgIGlmIChtYXBGaWVsZCAmJiB0eXBlb2YgbWFwRmllbGQgPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgICAgICBjb25zdCBtYXBwaW5ncyA9IG1hcEZpZWxkLnNwbGl0KCcsJykuZmlsdGVyKHAgPT4gcCk7XHJcbiAgICAgICAgICBtYXBwaW5ncy5mb3JFYWNoKChpdGVtOiBzdHJpbmcpID0+IHtcclxuICAgICAgICAgICAgbGV0IHBhdGhzID0gaXRlbS5zcGxpdCgnLicpO1xyXG4gICAgICAgICAgICBpZiAoYmluZGluZ1BhdGhzICYmIGJpbmRpbmdQYXRocy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgcGF0aHMgPSBiaW5kaW5nUGF0aHMuY29uY2F0KHBhdGhzKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zdCBwcm9wSW5mbzogRGF0YVByb3BJbmZvID0gZW50aXR5VHlwZUluZm8uZ2V0UHJvcEluZm9CeVBhdGgocGF0aHMpO1xyXG4gICAgICAgICAgICBpZiAocHJvcEluZm8gJiYgcHJvcEluZm8ubWV0YWRhdGFJbmZvICYmIHByb3BJbmZvLm1ldGFkYXRhSW5mby5wcmltYXJ5ID09PSB0cnVlKSB7XHJcbiAgICAgICAgICAgICAgcmVzdWx0cy5wdXNoKHtcclxuICAgICAgICAgICAgICAgIHByaW1hcnlLZXk6IGtleSxcclxuICAgICAgICAgICAgICAgIHByaW1hcnlGaWVsZDogaXRlbVxyXG4gICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICBjb25zb2xlLmVycm9yKGUpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHJlc3VsdHM7XHJcbiAgfVxyXG4gIHByaXZhdGUgc29ydE1hcEZpZWxkS2V5cyhrZXlzOiBzdHJpbmdbXSwgcHJpbWFyeUtleXM6IHN0cmluZ1tdKTogc3RyaW5nW10ge1xyXG4gICAgaWYgKCFwcmltYXJ5S2V5cyB8fCBwcmltYXJ5S2V5cy5sZW5ndGggPCAxIHx8ICFrZXlzIHx8IGtleXMubGVuZ3RoIDwgMSkge1xyXG4gICAgICByZXR1cm4ga2V5cztcclxuICAgIH1cclxuICAgIHByaW1hcnlLZXlzID0gWy4uLm5ldyBTZXQocHJpbWFyeUtleXMpXTtcclxuICAgIC8vIOi/h+a7pOWHuumdnuS4u+mUruaYoOWwhOWtl+autVxyXG4gICAga2V5cyA9IGtleXMuZmlsdGVyKHAgPT4gIXByaW1hcnlLZXlzLmluY2x1ZGVzKHApKTtcclxuICAgIHJldHVybiBbXS5jb25jYXQocHJpbWFyeUtleXMpLmNvbmNhdChrZXlzKTtcclxuICB9XHJcbn1cclxuIl19