/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Directive, ElementRef, Injector, Input, Renderer2 } from '@angular/core';
import { NgControl } from '@angular/forms';
import { LocaleService } from '@farris/ui-locale';
import { EventManager } from '@angular/platform-browser';
export class TextareaWordcountDirective {
    /**
     * @param {?} el
     * @param {?} render
     * @param {?} injector
     */
    constructor(el, render, injector) {
        this.el = el;
        this.render = render;
        this.injector = injector;
        this.useWordCount = true;
        /**
         * 统计字数的方式； surplus 剩余可输入字数; length: 当前已输入字数；
         *
         * 默认为 surplus
         */
        this.countType = 'surplus';
        this.onlyShowInDialog = false;
        this.wordCountElement = null;
        // 当前字数
        this.currentLengthElement = null;
        this.onInput = null;
        this.eventManager = this.injector.get(EventManager);
        this.localeSer = this.injector.get(LocaleService);
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        this.ngControl = this.injector.get(NgControl, null);
    }
    /**
     * @return {?}
     */
    ngAfterViewInit() {
        this.initWordCount();
    }
    /**
     * @param {?} changes
     * @return {?}
     */
    ngOnChanges(changes) {
        if (changes.useWordCount && !changes.useWordCount.isFirstChange()) {
            if (this.useWordCount) {
                this.initWordCount();
            }
            else {
                this.destroy();
            }
        }
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        this.destroy();
    }
    /**
     * @private
     * @return {?}
     */
    destroy() {
        if (this.onInput) {
            this.onInput();
        }
        if (this.wordCountElement) {
            this.wordCountElement.remove();
        }
    }
    /**
     * @return {?}
     */
    initWordCount() {
        if (this.useWordCount && !this.onlyShowInDialog) {
            this.createWordCountElement();
        }
    }
    /**
     * @private
     * @return {?}
     */
    createWordCountID() {
        /** @type {?} */
        const tagName = this.el.nativeElement.tagName;
        if (this.ngControl) {
            /** @type {?} */
            const ctrlName = this.ngControl.name;
            return `${tagName}_WORDCOUNT_${ctrlName}`;
        }
        else {
            if (this.el.nativeElement.id) {
                return `${tagName}_WORDCOUNT_${this.el.nativeElement.id}`;
            }
        }
        return '';
    }
    /**
     * @private
     * @return {?}
     */
    createWordCountElement() {
        /** @type {?} */
        const max = this.el.nativeElement.maxLength;
        if (!max || max < 0) {
            console.info('未设置最大字符数，计数功能失效。');
            return;
        }
        /** @type {?} */
        const wordCountSPAN = this.render.createElement('span');
        wordCountSPAN.className = 'textarea-wordcount';
        /** @type {?} */
        const id = this.createWordCountID();
        if (id) {
            wordCountSPAN.id = id;
        }
        this.render.setStyle(wordCountSPAN, 'position', 'absolute');
        this.render.setStyle(wordCountSPAN, 'bottom', '10px');
        this.render.setStyle(wordCountSPAN, 'right', '20px');
        this.render.setStyle(wordCountSPAN, 'cursor', 'pointer');
        this.el.nativeElement.after(wordCountSPAN);
        this.wordCountElement = wordCountSPAN;
        /** @type {?} */
        const currentLengthSPAN = this.render.createElement('span');
        wordCountSPAN.appendChild(currentLengthSPAN);
        this.currentLengthElement = currentLengthSPAN;
        currentLengthSPAN.after(` / ${max}`);
        this.updateWordsCount();
        this.onInput = this.render.listen(this.el.nativeElement, 'input', (/**
         * @return {?}
         */
        () => {
            // value.replace(/\n|\r/gi, '') // 移除换行符
            this.updateWordsCount();
        }));
    }
    /**
     * @return {?}
     */
    updateWordsCount() {
        /** @type {?} */
        const max = this.el.nativeElement.maxLength;
        /** @type {?} */
        const val = this.countType === 'surplus' ? max - this.el.nativeElement.value.length : this.el.nativeElement.value.length;
        /** @type {?} */
        const tip = 'messager.prompt.tips.' + this.countType;
        this.currentLengthElement.innerText = val;
        this.wordCountElement.title = this.localeSer.getValue(tip).replace('{0}', val);
    }
}
TextareaWordcountDirective.decorators = [
    { type: Directive, args: [{
                selector: '[word-count]',
                exportAs: 'WordCountRef'
            },] }
];
/** @nocollapse */
TextareaWordcountDirective.ctorParameters = () => [
    { type: ElementRef },
    { type: Renderer2 },
    { type: Injector }
];
TextareaWordcountDirective.propDecorators = {
    useWordCount: [{ type: Input, args: ['word-count',] }],
    countType: [{ type: Input }],
    onlyShowInDialog: [{ type: Input }]
};
if (false) {
    /** @type {?} */
    TextareaWordcountDirective.prototype.useWordCount;
    /**
     * 统计字数的方式； surplus 剩余可输入字数; length: 当前已输入字数；
     *
     * 默认为 surplus
     * @type {?}
     */
    TextareaWordcountDirective.prototype.countType;
    /** @type {?} */
    TextareaWordcountDirective.prototype.onlyShowInDialog;
    /** @type {?} */
    TextareaWordcountDirective.prototype.wordCountElement;
    /**
     * @type {?}
     * @private
     */
    TextareaWordcountDirective.prototype.currentLengthElement;
    /**
     * @type {?}
     * @private
     */
    TextareaWordcountDirective.prototype.eventManager;
    /**
     * @type {?}
     * @private
     */
    TextareaWordcountDirective.prototype.ngControl;
    /**
     * @type {?}
     * @private
     */
    TextareaWordcountDirective.prototype.onInput;
    /**
     * @type {?}
     * @private
     */
    TextareaWordcountDirective.prototype.localeSer;
    /**
     * @type {?}
     * @private
     */
    TextareaWordcountDirective.prototype.el;
    /**
     * @type {?}
     * @private
     */
    TextareaWordcountDirective.prototype.render;
    /**
     * @type {?}
     * @private
     */
    TextareaWordcountDirective.prototype.injector;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGV4dGFyZWEtd29yZGNvdW50LmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvdWktZm9ybXMvIiwic291cmNlcyI6WyJsaWIvdGV4dGFyZWEtd29yZGNvdW50LmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQ00sTUFBTSxlQUFlLENBQUM7QUFDdEYsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzNDLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNsRCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFNekQsTUFBTSxPQUFPLDBCQUEwQjs7Ozs7O0lBa0JuQyxZQUFvQixFQUFjLEVBQVUsTUFBaUIsRUFBVSxRQUFrQjtRQUFyRSxPQUFFLEdBQUYsRUFBRSxDQUFZO1FBQVUsV0FBTSxHQUFOLE1BQU0sQ0FBVztRQUFVLGFBQVEsR0FBUixRQUFRLENBQVU7UUFqQnBFLGlCQUFZLEdBQUcsSUFBSSxDQUFDOzs7Ozs7UUFNaEMsY0FBUyxHQUF5QixTQUFTLENBQUM7UUFFNUMscUJBQWdCLEdBQUcsS0FBSyxDQUFDO1FBRWxDLHFCQUFnQixHQUFHLElBQUksQ0FBQzs7UUFFaEIseUJBQW9CLEdBQUcsSUFBSSxDQUFDO1FBRzVCLFlBQU8sR0FBRyxJQUFJLENBQUM7UUFHbkIsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUNwRCxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxDQUFDO0lBQ3RELENBQUM7Ozs7SUFFRCxRQUFRO1FBQ0osSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsUUFBUSxD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QUFFLGNBQWM7YUFDM0I7Ozs7WUFUbUIsVUFBVTtZQUFtQixTQUFTO1lBQTFCLFFBQVE7OzsyQkFXbkMsS0FBSyxTQUFDLFlBQVk7d0JBTWxCLEtBQUs7K0JBRUwsS0FBSzs7OztJQVJOLGtEQUF5Qzs7Ozs7OztJQU16QywrQ0FBcUQ7O0lBRXJELHNEQUFrQzs7SUFFbEMsc0RBQXdCOzs7OztJQUV4QiwwREFBb0M7Ozs7O0lBQ3BDLGtEQUFtQzs7Ozs7SUFDbkMsK0NBQTZCOzs7OztJQUM3Qiw2Q0FBdUI7Ozs7O0lBQ3ZCLCtDQUFpQzs7Ozs7SUFDckIsd0NBQXNCOzs7OztJQUFFLDRDQUF5Qjs7Ozs7SUFBRSw4Q0FBMEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBEaXJlY3RpdmUsIEVsZW1lbnRSZWYsIEluamVjdG9yLCBJbnB1dCwgUmVuZGVyZXIyLFxyXG4gICAgT25Jbml0LCBBZnRlclZpZXdJbml0LCBPbkRlc3Ryb3ksIE9uQ2hhbmdlcywgU2ltcGxlQ2hhbmdlcyB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBOZ0NvbnRyb2wgfSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XHJcbmltcG9ydCB7IExvY2FsZVNlcnZpY2UgfSBmcm9tICdAZmFycmlzL3VpLWxvY2FsZSc7XHJcbmltcG9ydCB7IEV2ZW50TWFuYWdlciB9IGZyb20gJ0Bhbmd1bGFyL3BsYXRmb3JtLWJyb3dzZXInO1xyXG5cclxuQERpcmVjdGl2ZSh7XHJcbiAgICBzZWxlY3RvcjogJ1t3b3JkLWNvdW50XScsXHJcbiAgICBleHBvcnRBczogJ1dvcmRDb3VudFJlZidcclxufSlcclxuZXhwb3J0IGNsYXNzIFRleHRhcmVhV29yZGNvdW50RGlyZWN0aXZlIGltcGxlbWVudHMgT25Jbml0LCBBZnRlclZpZXdJbml0LCBPbkRlc3Ryb3ksIE9uQ2hhbmdlcyB7XHJcbiAgICBASW5wdXQoJ3dvcmQtY291bnQnKSB1c2VXb3JkQ291bnQgPSB0cnVlO1xyXG4gICAgLyoqXHJcbiAgICAgKiDnu5/orqHlrZfmlbDnmoTmlrnlvI/vvJsgc3VycGx1cyDliankvZnlj6/ovpPlhaXlrZfmlbA7IGxlbmd0aDog5b2T5YmN5bey6L6T5YWl5a2X5pWw77ybXHJcbiAgICAgKlxyXG4gICAgICog6buY6K6k5Li6IHN1cnBsdXNcclxuICAgICAqL1xyXG4gICAgQElucHV0KCkgY291bnRUeXBlOiAnc3VycGx1cycgfCAnbGVuZ3RoJyA9ICdzdXJwbHVzJztcclxuXHJcbiAgICBASW5wdXQoKSBvbmx5U2hvd0luRGlhbG9nID0gZmFsc2U7XHJcblxyXG4gICAgd29yZENvdW50RWxlbWVudCA9IG51bGw7XHJcbiAgICAvLyDlvZPliY3lrZfmlbBcclxuICAgIHByaXZhdGUgY3VycmVudExlbmd0aEVsZW1lbnQgPSBudWxsO1xyXG4gICAgcHJpdmF0ZSBldmVudE1hbmFnZXI6IEV2ZW50TWFuYWdlcjtcclxuICAgIHByaXZhdGUgbmdDb250cm9sOiBOZ0NvbnRyb2w7XHJcbiAgICBwcml2YXRlIG9uSW5wdXQgPSBudWxsO1xyXG4gICAgcHJpdmF0ZSBsb2NhbGVTZXI6IExvY2FsZVNlcnZpY2U7XHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGVsOiBFbGVtZW50UmVmLCBwcml2YXRlIHJlbmRlcjogUmVuZGVyZXIyLCBwcml2YXRlIGluamVjdG9yOiBJbmplY3Rvcikge1xyXG4gICAgICAgIHRoaXMuZXZlbnRNYW5hZ2VyID0gdGhpcy5pbmplY3Rvci5nZXQoRXZlbnRNYW5hZ2VyKTtcclxuICAgICAgICB0aGlzLmxvY2FsZVNlciA9IHRoaXMuaW5qZWN0b3IuZ2V0KExvY2FsZVNlcnZpY2UpO1xyXG4gICAgfVxyXG5cclxuICAgIG5nT25Jbml0KCkge1xyXG4gICAgICAgIHRoaXMubmdDb250cm9sID0gdGhpcy5pbmplY3Rvci5nZXQoTmdDb250cm9sLCBudWxsKTtcclxuICAgIH1cclxuXHJcbiAgICBuZ0FmdGVyVmlld0luaXQoKSB7XHJcbiAgICAgICAgdGhpcy5pbml0V29yZENvdW50KCk7XHJcbiAgICB9XHJcblxyXG4gICAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcyk6IHZvaWQge1xyXG5cclxuICAgICAgICBpZiAoY2hhbmdlcy51c2VXb3JkQ291bnQgJiYgIWNoYW5nZXMudXNlV29yZENvdW50LmlzRmlyc3RDaGFuZ2UoKSkge1xyXG4gICAgICAgICAgICBpZiAodGhpcy51c2VXb3JkQ291bnQpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuaW5pdFdvcmRDb3VudCgpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5kZXN0cm95KCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgbmdPbkRlc3Ryb3koKSB7XHJcbiAgICAgICAgdGhpcy5kZXN0cm95KCk7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIHByaXZhdGUgZGVzdHJveSgpIHtcclxuICAgICAgICBpZiAodGhpcy5vbklucHV0KSB7XHJcbiAgICAgICAgICAgIHRoaXMub25JbnB1dCgpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHRoaXMud29yZENvdW50RWxlbWVudCkge1xyXG4gICAgICAgICAgICB0aGlzLndvcmRDb3VudEVsZW1lbnQucmVtb3ZlKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGluaXRXb3JkQ291bnQoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMudXNlV29yZENvdW50ICYmICF0aGlzLm9ubHlTaG93SW5EaWFsb2cpIHtcclxuICAgICAgICAgICAgdGhpcy5jcmVhdGVXb3JkQ291bnRFbGVtZW50KCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgY3JlYXRlV29yZENvdW50SUQoKSB7XHJcbiAgICAgICAgY29uc3QgdGFnTmFtZSA9IHRoaXMuZWwubmF0aXZlRWxlbWVudC50YWdOYW1lO1xyXG4gICAgICAgIGlmICh0aGlzLm5nQ29udHJvbCkge1xyXG4gICAgICAgICAgICBjb25zdCBjdHJsTmFtZSA9IHRoaXMubmdDb250cm9sLm5hbWU7XHJcbiAgICAgICAgICAgIHJldHVybiBgJHt0YWdOYW1lfV9XT1JEQ09VTlRfJHtjdHJsTmFtZX1gO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmVsLm5hdGl2ZUVsZW1lbnQuaWQpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBgJHt0YWdOYW1lfV9XT1JEQ09VTlRfJHt0aGlzLmVsLm5hdGl2ZUVsZW1lbnQuaWR9YDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gJyc7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBjcmVhdGVXb3JkQ291bnRFbGVtZW50KCkge1xyXG4gICAgICAgIGNvbnN0IG1heCA9IHRoaXMuZWwubmF0aXZlRWxlbWVudC5tYXhMZW5ndGg7XHJcbiAgICAgICAgaWYgKCFtYXggfHwgbWF4IDwgMCkge1xyXG4gICAgICAgICAgICBjb25zb2xlLmluZm8oJ+acquiuvue9ruacgOWkp+Wtl+espuaVsO+8jOiuoeaVsOWKn+iDveWkseaViOOAgicpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCB3b3JkQ291bnRTUEFOID0gdGhpcy5yZW5kZXIuY3JlYXRlRWxlbWVudCgnc3BhbicpO1xyXG4gICAgICAgIHdvcmRDb3VudFNQQU4uY2xhc3NOYW1lID0gJ3RleHRhcmVhLXdvcmRjb3VudCc7XHJcblxyXG4gICAgICAgIGNvbnN0IGlkID0gdGhpcy5jcmVhdGVXb3JkQ291bnRJRCgpO1xyXG4gICAgICAgIGlmIChpZCkge1xyXG4gICAgICAgICAgICB3b3JkQ291bnRTUEFOLmlkID0gaWQ7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLnJlbmRlci5zZXRTdHlsZSh3b3JkQ291bnRTUEFOLCAncG9zaXRpb24nLCAnYWJzb2x1dGUnKTtcclxuICAgICAgICB0aGlzLnJlbmRlci5zZXRTdHlsZSh3b3JkQ291bnRTUEFOLCAnYm90dG9tJywgJzEwcHgnKTtcclxuICAgICAgICB0aGlzLnJlbmRlci5zZXRTdHlsZSh3b3JkQ291bnRTUEFOLCAncmlnaHQnLCAnMjBweCcpO1xyXG4gICAgICAgIHRoaXMucmVuZGVyLnNldFN0eWxlKHdvcmRDb3VudFNQQU4sICdjdXJzb3InLCAncG9pbnRlcicpO1xyXG5cclxuICAgICAgICB0aGlzLmVsLm5hdGl2ZUVsZW1lbnQuYWZ0ZXIod29yZENvdW50U1BBTik7XHJcbiAgICAgICAgdGhpcy53b3JkQ291bnRFbGVtZW50ID0gd29yZENvdW50U1BBTjtcclxuXHJcbiAgICAgICAgY29uc3QgY3VycmVudExlbmd0aFNQQU4gPSB0aGlzLnJlbmRlci5jcmVhdGVFbGVtZW50KCdzcGFuJyk7XHJcbiAgICAgICAgd29yZENvdW50U1BBTi5hcHBlbmRDaGlsZChjdXJyZW50TGVuZ3RoU1BBTik7XHJcbiAgICAgICAgdGhpcy5jdXJyZW50TGVuZ3RoRWxlbWVudCA9IGN1cnJlbnRMZW5ndGhTUEFOO1xyXG4gICAgICAgIGN1cnJlbnRMZW5ndGhTUEFOLmFmdGVyKCBgIC8gJHttYXh9YCApO1xyXG5cclxuICAgICAgICB0aGlzLnVwZGF0ZVdvcmRzQ291bnQoKTtcclxuICAgICAgICB0aGlzLm9uSW5wdXQgPSB0aGlzLnJlbmRlci5saXN0ZW4odGhpcy5lbC5uYXRpdmVFbGVtZW50LCAnaW5wdXQnLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIC8vIHZhbHVlLnJlcGxhY2UoL1xcbnxcXHIvZ2ksICcnKSAvLyDnp7vpmaTmjaLooYznrKZcclxuICAgICAgICAgICAgdGhpcy51cGRhdGVXb3Jkc0NvdW50KCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgdXBkYXRlV29yZHNDb3VudCgpIHtcclxuICAgICAgICBjb25zdCBtYXggPSB0aGlzLmVsLm5hdGl2ZUVsZW1lbnQubWF4TGVuZ3RoO1xyXG4gICAgICAgIGNvbnN0IHZhbCA9IHRoaXMuY291bnRUeXBlID09PSAnc3VycGx1cycgPyBtYXggLSB0aGlzLmVsLm5hdGl2ZUVsZW1lbnQudmFsdWUubGVuZ3RoIDogdGhpcy5lbC5uYXRpdmVFbGVtZW50LnZhbHVlLmxlbmd0aDtcclxuICAgICAgICBjb25zdCB0aXAgPSAnbWVzc2FnZXIucHJvbXB0LnRpcHMuJyArIHRoaXMuY291bnRUeXBlO1xyXG5cclxuICAgICAgICB0aGlzLmN1cnJlbnRMZW5ndGhFbGVtZW50LmlubmVyVGV4dCA9IHZhbDtcclxuICAgICAgICB0aGlzLndvcmRDb3VudEVsZW1lbnQudGl0bGUgPSB0aGlzLmxvY2FsZVNlci5nZXRWYWx1ZSh0aXApLnJlcGxhY2UoJ3swfScsIHZhbCk7XHJcbiAgICB9XHJcbn1cclxuIl19