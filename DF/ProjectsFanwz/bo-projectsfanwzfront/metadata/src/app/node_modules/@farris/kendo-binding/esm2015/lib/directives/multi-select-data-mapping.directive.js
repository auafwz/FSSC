import { Directive, Input, Self, Host, Optional, Output, EventEmitter } from '@angular/core';
import { MultiSelectComponent } from '@farris/ui-multi-select';
import { ViewModel } from '@farris/devkit';
export class MultiSelectDataMappingDirective {
    constructor(vm, multiSelectComponent) {
        this.vm = vm;
        this.multiSelectComponent = multiSelectComponent;
        this.selectedIdChanged = new EventEmitter();
        this.vm.uiState.changes.subscribe(data => {
            this.selectedId = data.value;
        });
    }
    ngOnInit() {
        this.multiSelectComponent.dataSource = [];
        if (Array.isArray(this.dataSource)) {
            this.multiSelectComponent.dataSource = this.dataSource;
            this.originalDataSource = this.dataSource;
        }
        else if (this.dataSource && this.dataSource.changes) {
            this.dataSource.changes.subscribe((data) => {
                if (data.type === 'Load') {
                    this.originalDataSource = data.value;
                    if (this.multiSelectComponent.isTree()) {
                        if (this.fjmField) {
                            // 分级码加载树结构
                            this.multiSelectComponent.dataSource = this.plainToTree(data.value, this.fjmField, 1);
                        }
                        else if (this.fjdField) {
                            // 父节点加载树结构
                            this.multiSelectComponent.dataSource = this.buildTreeNodesByFjd(data.value, this.fjdField);
                        }
                        this.multiSelectComponent.selections = this.getTreeSelectionsById(this.selectedId, this.originalDataSource);
                    }
                    else {
                        this.multiSelectComponent.dataSource = data.value;
                        this.multiSelectComponent.selections = this.getListSelectionsById(this.selectedId, this.multiSelectComponent.dataSource);
                    }
                }
            });
        }
        this.selectIdBindingToUIStateField();
    }
    selectIdBindingToUIStateField() {
        if (this.multiSelectComponent && this.multiSelectComponent.selectedIdChange) {
            this.multiSelectComponent.selectedIdChange.subscribe(data => {
                this.selectedIdChanged.emit(data);
            });
        }
    }
    /**
     *
     * @param data 需要格式化的数据
     */
    formatDataSource(data, field) {
        if (!data || !data.length) {
            return [];
        }
        return data.map(item => {
            const n = item['toJSON'] ? item.toJSON() : item;
            return {
                data: Object.assign(Object.assign({}, n), {
                    [`${this.idField}`]: item[this.idField],
                    [`${this.textField}`]: item[this.textField],
                    [`${this.valueField}`]: item[this.valueField],
                    [`${field}`]: item[field]
                }),
                children: []
            };
        });
    }
    /**
     * 把平行结构的数据转换成树形结构
     * @param plainSource
     * @param field
     * @param layer
     */
    plainToTree(plainSource, field, layer) {
        const treeSource = this.formatDataSource(plainSource, field);
        if (!treeSource.length) {
            console.log('数据为空，不能转换成树形结构');
            return [];
        }
        if (!treeSource[0]['data'][field]) {
            console.log('需要转换成树形结构的关键字段不存在');
            return [];
        }
        const parents = treeSource.filter(item => {
            return item['data'][field]['layer'] === layer;
        });
        this.recursive(parents, treeSource, field, 1);
        return parents;
    }
    /**
     * 递归遍历树形结构
     * @param parents
     * @param treeSource
     * @param field
     * @param layer
     */
    recursive(parents, treeSource, field, layer) {
        parents.forEach(parent => {
            const parentPath = parent['data'][field]['path'];
            const parentLayer = parent['data'][field]['layer'];
            if (parent['data'][field]['isDetail'] === false) {
                treeSource.forEach(item => {
                    if (item && item['data'] && item['data'][field] && item['data'][field]['path']) {
                        const itemPath = item['data'][field]['path'];
                        const itemLayer = item['data'][field]['layer'];
                        let targetPath;
                        if (itemPath && itemPath.length > parentPath.length) {
                            targetPath = itemPath.substr(0, Number(layer) * 4);
                        }
                        if (parentPath === targetPath && parentLayer === itemLayer - 1) {
                            parent['children'].push(item);
                        }
                        if (item['data'][field]['isDetail'] === false && parentPath === targetPath) {
                            this.recursive([item], treeSource, field, Number(layer) + 1);
                        }
                    }
                });
            }
        });
    }
    /**
       *
       * @param ids 选中数据的id
       * @param dataSource 原始数据
       */
    getListSelectionsById(ids, dataSource) {
        let result = [];
        const _this = this;
        if ((typeof ids === 'string' && !!ids) || typeof ids === 'number') {
            const reusltObj = dataSource.find(item => {
                return item && item[_this.idField] === ids;
            });
            if (reusltObj) {
                result.push(reusltObj);
            }
        }
        else if (Array.isArray(ids)) {
            if (dataSource) {
                ids.forEach(id => {
                    const item = dataSource.find(item => item && item[_this.idField] === id);
                    if (item) {
                        result.push(item);
                    }
                });
                // dataSource.forEach(item => {
                //   ids.forEach(id => {
                //     if (item[_this.idField] === id) {
                //       result.push(item);
                //     }
                //   })
                // })
            }
            else {
                result = [];
            }
        }
        else {
            result = [];
        }
        return result;
    }
    /**
     *
     * @param ids 选中数据的id
     * @param dataSource 原始数据
     */
    getTreeSelectionsById(ids, dataSource) {
        let result = [];
        const _this = this;
        if ((typeof ids === 'string' && !!ids) || typeof ids === 'number') {
            const reusltObj = dataSource.find(item => {
                return item && item[_this.idField] === ids;
            });
            if (reusltObj) {
                result.push(reusltObj);
            }
        }
        else if (Array.isArray(ids)) {
            if (dataSource) {
                ids.forEach(id => {
                    const item = dataSource.find(item => item && item[_this.idField] === id);
                    if (item) {
                        result.push(item);
                    }
                });
                // dataSource.forEach(item => {
                //   ids.forEach(id => {
                //     if (item.data[_this.idField] === id) {
                //       result.push(item.data);
                //     }
                //   })
                // })
            }
            else {
                result = [];
            }
        }
        else {
            result = [];
        }
        return result;
    }
    /**
     * 根据父节点初始化树结构
     * @param bindingObjects
     */
    buildTreeNodesByFjd(bindingObjects, field) {
        const treeData = this.formatDataSource(bindingObjects, field);
        treeData.forEach((item) => {
            const parent = treeData.find((ele) => item.data[field].parentElement === ele.data[this.idField]);
            if (parent) {
                parent.children.push(item);
            }
        });
        return treeData.filter((ele) => !ele.data[field].parentElement);
    }
}
MultiSelectDataMappingDirective.decorators = [
    { type: Directive, args: [{
                selector: '[multiSelectDataMapping]'
            },] }
];
/** @nocollapse */
MultiSelectDataMappingDirective.ctorParameters = () => [
    { type: ViewModel, decorators: [{ type: Optional }] },
    { type: MultiSelectComponent, decorators: [{ type: Host }, { type: Self }, { type: Optional }] }
];
MultiSelectDataMappingDirective.propDecorators = {
    dataSource: [{ type: Input }],
    idField: [{ type: Input }],
    textField: [{ type: Input }],
    valueField: [{ type: Input }],
    fjmField: [{ type: Input }],
    fjdField: [{ type: Input }],
    uiStateField: [{ type: Input }],
    selectedId: [{ type: Input }],
    selectedIdChanged: [{ type: Output }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibXVsdGktc2VsZWN0LWRhdGEtbWFwcGluZy5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2tlbmRvLWJpbmRpbmcvIiwic291cmNlcyI6WyJsaWIvZGlyZWN0aXZlcy9tdWx0aS1zZWxlY3QtZGF0YS1tYXBwaW5nLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBVSxNQUFNLEVBQUUsWUFBWSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3JHLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLHlCQUF5QixDQUFBO0FBQzlELE9BQU8sRUFBRSxTQUFTLEVBQWlCLE1BQU0sZ0JBQWdCLENBQUM7QUFLMUQsTUFBTSxPQUFPLCtCQUErQjtJQWExQyxZQUNzQixFQUFhLEVBQ0csb0JBQTBDO1FBRDFELE9BQUUsR0FBRixFQUFFLENBQVc7UUFDRyx5QkFBb0IsR0FBcEIsb0JBQW9CLENBQXNCO1FBTHRFLHNCQUFpQixHQUFHLElBQUksWUFBWSxFQUFVLENBQUM7UUFPdkQsSUFBSSxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsRUFBRTtZQUN2QyxJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7UUFDL0IsQ0FBQyxDQUFDLENBQUE7SUFDSixDQUFDO0lBQ0QsUUFBUTtRQUNOLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxVQUFVLEdBQUcsRUFBRSxDQUFDO1FBQzFDLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLEVBQUU7WUFDbEMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDO1lBQ3ZELElBQUksQ0FBQyxrQkFBa0IsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDO1NB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Q0wsS0FBSzt3QkFDTCxLQUFLO3lCQUNMLEtBQUs7dUJBQ0wsS0FBSzt1QkFDTCxLQUFLOzJCQUNMLEtBQUs7eUJBQ0wsS0FBSztnQ0FDTCxNQUFNIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGlyZWN0aXZlLCBJbnB1dCwgU2VsZiwgSG9zdCwgT3B0aW9uYWwsIE9uSW5pdCwgT3V0cHV0LCBFdmVudEVtaXR0ZXIgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgTXVsdGlTZWxlY3RDb21wb25lbnQgfSBmcm9tICdAZmFycmlzL3VpLW11bHRpLXNlbGVjdCdcclxuaW1wb3J0IHsgVmlld01vZGVsLCBCaW5kaW5nT2JqZWN0IH0gZnJvbSAnQGZhcnJpcy9kZXZraXQnO1xyXG5cclxuQERpcmVjdGl2ZSh7XHJcbiAgc2VsZWN0b3I6ICdbbXVsdGlTZWxlY3REYXRhTWFwcGluZ10nXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBNdWx0aVNlbGVjdERhdGFNYXBwaW5nRGlyZWN0aXZlIGltcGxlbWVudHMgT25Jbml0IHtcclxuXHJcbiAgQElucHV0KCkgZGF0YVNvdXJjZTogYW55O1xyXG4gIEBJbnB1dCgpIGlkRmllbGQ6IHN0cmluZztcclxuICBASW5wdXQoKSB0ZXh0RmllbGQ6IHN0cmluZztcclxuICBASW5wdXQoKSB2YWx1ZUZpZWxkOiBzdHJpbmc7XHJcbiAgQElucHV0KCkgZmptRmllbGQ6IHN0cmluZztcclxuICBASW5wdXQoKSBmamRGaWVsZDogc3RyaW5nO1xyXG4gIEBJbnB1dCgpIHVpU3RhdGVGaWVsZDogYW55O1xyXG4gIEBJbnB1dCgpIHNlbGVjdGVkSWQ6IHN0cmluZztcclxuICBAT3V0cHV0KCkgc2VsZWN0ZWRJZENoYW5nZWQgPSBuZXcgRXZlbnRFbWl0dGVyPHN0cmluZz4oKTtcclxuICBwcml2YXRlIG9yaWdpbmFsRGF0YVNvdXJjZTogYW55O1xyXG5cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIEBPcHRpb25hbCgpIHByaXZhdGUgdm06IFZpZXdNb2RlbCxcclxuICAgIEBIb3N0KCkgQFNlbGYoKSBAT3B0aW9uYWwoKSBwcml2YXRlIG11bHRpU2VsZWN0Q29tcG9uZW50OiBNdWx0aVNlbGVjdENvbXBvbmVudFxyXG4gICkge1xyXG4gICAgdGhpcy52bS51aVN0YXRlLmNoYW5nZXMuc3Vic2NyaWJlKGRhdGEgPT4ge1xyXG4gICAgICB0aGlzLnNlbGVjdGVkSWQgPSBkYXRhLnZhbHVlO1xyXG4gICAgfSlcclxuICB9XHJcbiAgbmdPbkluaXQoKSB7XHJcbiAgICB0aGlzLm11bHRpU2VsZWN0Q29tcG9uZW50LmRhdGFTb3VyY2UgPSBbXTtcclxuICAgIGlmIChBcnJheS5pc0FycmF5KHRoaXMuZGF0YVNvdXJjZSkpIHtcclxuICAgICAgdGhpcy5tdWx0aVNlbGVjdENvbXBvbmVudC5kYXRhU291cmNlID0gdGhpcy5kYXRhU291cmNlO1xyXG4gICAgICB0aGlzLm9yaWdpbmFsRGF0YVNvdXJjZSA9IHRoaXMuZGF0YVNvdXJjZTtcclxuICAgIH0gZWxzZSBpZiAodGhpcy5kYXRhU291cmNlICYmIHRoaXMuZGF0YVNvdXJjZS5jaGFuZ2VzKSB7XHJcbiAgICAgIHRoaXMuZGF0YVNvdXJjZS5jaGFuZ2VzLnN1YnNjcmliZSgoZGF0YTogYW55KSA9PiB7XHJcbiAgICAgICAgaWYgKGRhdGEudHlwZSA9PT0gJ0xvYWQnKSB7XHJcbiAgICAgICAgICB0aGlzLm9yaWdpbmFsRGF0YVNvdXJjZSA9IGRhdGEudmFsdWU7XHJcbiAgICAgICAgICBpZiAodGhpcy5tdWx0aVNlbGVjdENvbXBvbmVudC5pc1RyZWUoKSkge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5mam1GaWVsZCkge1xyXG4gICAgICAgICAgICAgIC8vIOWIhue6p+eggeWKoOi9veagkee7k+aehFxyXG4gICAgICAgICAgICAgIHRoaXMubXVsdGlTZWxlY3RDb21wb25lbnQuZGF0YVNvdXJjZSA9IHRoaXMucGxhaW5Ub1RyZWUoZGF0YS52YWx1ZSwgdGhpcy5mam1GaWVsZCwgMSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5mamRGaWVsZCkge1xyXG4gICAgICAgICAgICAgIC8vIOeItuiKgueCueWKoOi9veagkee7k+aehFxyXG4gICAgICAgICAgICAgIHRoaXMubXVsdGlTZWxlY3RDb21wb25lbnQuZGF0YVNvdXJjZSA9IHRoaXMuYnVpbGRUcmVlTm9kZXNCeUZqZChkYXRhLnZhbHVlLCB0aGlzLmZqZEZpZWxkKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLm11bHRpU2VsZWN0Q29tcG9uZW50LnNlbGVjdGlvbnMgPSB0aGlzLmdldFRyZWVTZWxlY3Rpb25zQnlJZCh0aGlzLnNlbGVjdGVkSWQsIHRoaXMub3JpZ2luYWxEYXRhU291cmNlKTtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMubXVsdGlTZWxlY3RDb21wb25lbnQuZGF0YVNvdXJjZSA9IGRhdGEudmFsdWU7XHJcbiAgICAgICAgICAgIHRoaXMubXVsdGlTZWxlY3RDb21wb25lbnQuc2VsZWN0aW9ucyA9IHRoaXMuZ2V0TGlzdFNlbGVjdGlvbnNCeUlkKHRoaXMuc2VsZWN0ZWRJZCwgdGhpcy5tdWx0aVNlbGVjdENvbXBvbmVudC5kYXRhU291cmNlKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH0pXHJcbiAgICB9XHJcbiAgICB0aGlzLnNlbGVjdElkQmluZGluZ1RvVUlTdGF0ZUZpZWxkKCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHNlbGVjdElkQmluZGluZ1RvVUlTdGF0ZUZpZWxkKCkge1xyXG4gICAgaWYgKHRoaXMubXVsdGlTZWxlY3RDb21wb25lbnQgJiYgdGhpcy5tdWx0aVNlbGVjdENvbXBvbmVudC5zZWxlY3RlZElkQ2hhbmdlKSB7XHJcbiAgICAgIHRoaXMubXVsdGlTZWxlY3RDb21wb25lbnQuc2VsZWN0ZWRJZENoYW5nZS5zdWJzY3JpYmUoZGF0YSA9PiB7XHJcbiAgICAgICAgdGhpcy5zZWxlY3RlZElkQ2hhbmdlZC5lbWl0KGRhdGEpO1xyXG4gICAgICB9KVxyXG4gICAgfVxyXG4gIH1cclxuICAvKipcclxuICAgKiBcclxuICAgKiBAcGFyYW0gZGF0YSDpnIDopoHmoLzlvI/ljJbnmoTmlbDmja5cclxuICAgKi9cclxuICBwcml2YXRlIGZvcm1hdERhdGFTb3VyY2UoZGF0YTogYW55W10sIGZpZWxkOiBzdHJpbmcpIHtcclxuICAgIGlmICghZGF0YSB8fCAhZGF0YS5sZW5ndGgpIHtcclxuICAgICAgcmV0dXJuIFtdO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGRhdGEubWFwKGl0ZW0gPT4ge1xyXG4gICAgICBjb25zdCBuID0gaXRlbVsndG9KU09OJ10gPyBpdGVtLnRvSlNPTigpIDogaXRlbTtcclxuICAgICAgcmV0dXJuIHtcclxuICAgICAgICBkYXRhOiBPYmplY3QuYXNzaWduKHsgLi4ubiB9LCB7XHJcbiAgICAgICAgICBbYCR7dGhpcy5pZEZpZWxkfWBdOiBpdGVtW3RoaXMuaWRGaWVsZF0sXHJcbiAgICAgICAgICBbYCR7dGhpcy50ZXh0RmllbGR9YF06IGl0ZW1bdGhpcy50ZXh0RmllbGRdLFxyXG4gICAgICAgICAgW2Ake3RoaXMudmFsdWVGaWVsZH1gXTogaXRlbVt0aGlzLnZhbHVlRmllbGRdLFxyXG4gICAgICAgICAgW2Ake2ZpZWxkfWBdOiBpdGVtW2ZpZWxkXVxyXG4gICAgICAgIH0pLFxyXG4gICAgICAgIGNoaWxkcmVuOiBbXVxyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5oqK5bmz6KGM57uT5p6E55qE5pWw5o2u6L2s5o2i5oiQ5qCR5b2i57uT5p6EXHJcbiAgICogQHBhcmFtIHBsYWluU291cmNlIFxyXG4gICAqIEBwYXJhbSBmaWVsZCBcclxuICAgKiBAcGFyYW0gbGF5ZXIgXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBwbGFpblRvVHJlZShwbGFpblNvdXJjZTogYW55W10sIGZpZWxkOiBzdHJpbmcsIGxheWVyOiBudW1iZXIpIHtcclxuICAgIGNvbnN0IHRyZWVTb3VyY2UgPSB0aGlzLmZvcm1hdERhdGFTb3VyY2UocGxhaW5Tb3VyY2UsIGZpZWxkKTtcclxuICAgIGlmICghdHJlZVNvdXJjZS5sZW5ndGgpIHtcclxuICAgICAgY29uc29sZS5sb2coJ+aVsOaNruS4uuepuu+8jOS4jeiDvei9rOaNouaIkOagkeW9oue7k+aehCcpO1xyXG4gICAgICByZXR1cm4gW107XHJcbiAgICB9XHJcbiAgICBpZiAoIXRyZWVTb3VyY2VbMF1bJ2RhdGEnXVtmaWVsZF0pIHtcclxuICAgICAgY29uc29sZS5sb2coJ+mcgOimgei9rOaNouaIkOagkeW9oue7k+aehOeahOWFs+mUruWtl+auteS4jeWtmOWcqCcpO1xyXG4gICAgICByZXR1cm4gW107XHJcbiAgICB9XHJcbiAgICBjb25zdCBwYXJlbnRzID0gdHJlZVNvdXJjZS5maWx0ZXIoaXRlbSA9PiB7XHJcbiAgICAgIHJldHVybiBpdGVtWydkYXRhJ11bZmllbGRdWydsYXllciddID09PSBsYXllcjtcclxuICAgIH0pXHJcbiAgICB0aGlzLnJlY3Vyc2l2ZShwYXJlbnRzLCB0cmVlU291cmNlLCBmaWVsZCwgMSk7XHJcbiAgICByZXR1cm4gcGFyZW50cztcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOmAkuW9kumBjeWOhuagkeW9oue7k+aehFxyXG4gICAqIEBwYXJhbSBwYXJlbnRzIFxyXG4gICAqIEBwYXJhbSB0cmVlU291cmNlIFxyXG4gICAqIEBwYXJhbSBmaWVsZCBcclxuICAgKiBAcGFyYW0gbGF5ZXIgXHJcbiAgICovXHJcbiAgcHJpdmF0ZSByZWN1cnNpdmUocGFyZW50czogYW55W10sIHRyZWVTb3VyY2U6IGFueVtdLCBmaWVsZDogc3RyaW5nLCBsYXllcjogbnVtYmVyKSB7XHJcbiAgICBwYXJlbnRzLmZvckVhY2gocGFyZW50ID0+IHtcclxuICAgICAgY29uc3QgcGFyZW50UGF0aCA9IHBhcmVudFsnZGF0YSddW2ZpZWxkXVsncGF0aCddO1xyXG4gICAgICBjb25zdCBwYXJlbnRMYXllciA9IHBhcmVudFsnZGF0YSddW2ZpZWxkXVsnbGF5ZXInXTtcclxuICAgICAgaWYgKHBhcmVudFsnZGF0YSddW2ZpZWxkXVsnaXNEZXRhaWwnXSA9PT0gZmFsc2UpIHtcclxuICAgICAgICB0cmVlU291cmNlLmZvckVhY2goaXRlbSA9PiB7XHJcbiAgICAgICAgICBpZiAoaXRlbSAmJiBpdGVtWydkYXRhJ10gJiYgaXRlbVsnZGF0YSddW2ZpZWxkXSAmJiBpdGVtWydkYXRhJ11bZmllbGRdWydwYXRoJ10pIHtcclxuICAgICAgICAgICAgY29uc3QgaXRlbVBhdGggPSBpdGVtWydkYXRhJ11bZmllbGRdWydwYXRoJ107XHJcbiAgICAgICAgICAgIGNvbnN0IGl0ZW1MYXllciA9IGl0ZW1bJ2RhdGEnXVtmaWVsZF1bJ2xheWVyJ107XHJcbiAgICAgICAgICAgIGxldCB0YXJnZXRQYXRoOiBzdHJpbmc7XHJcbiAgICAgICAgICAgIGlmIChpdGVtUGF0aCAmJiBpdGVtUGF0aC5sZW5ndGggPiBwYXJlbnRQYXRoLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgIHRhcmdldFBhdGggPSBpdGVtUGF0aC5zdWJzdHIoMCwgTnVtYmVyKGxheWVyKSAqIDQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChwYXJlbnRQYXRoID09PSB0YXJnZXRQYXRoICYmIHBhcmVudExheWVyID09PSBpdGVtTGF5ZXIgLSAxKSB7XHJcbiAgICAgICAgICAgICAgcGFyZW50WydjaGlsZHJlbiddLnB1c2goaXRlbSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGl0ZW1bJ2RhdGEnXVtmaWVsZF1bJ2lzRGV0YWlsJ10gPT09IGZhbHNlICYmIHBhcmVudFBhdGggPT09IHRhcmdldFBhdGgpIHtcclxuICAgICAgICAgICAgICB0aGlzLnJlY3Vyc2l2ZShbaXRlbV0sIHRyZWVTb3VyY2UsIGZpZWxkLCBOdW1iZXIobGF5ZXIpICsgMSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgfVxyXG4gICAgfSlcclxuICB9XHJcbiAgLyoqXHJcbiAgICAgKiBcclxuICAgICAqIEBwYXJhbSBpZHMg6YCJ5Lit5pWw5o2u55qEaWRcclxuICAgICAqIEBwYXJhbSBkYXRhU291cmNlIOWOn+Wni+aVsOaNrlxyXG4gICAgICovXHJcbiAgcHJpdmF0ZSBnZXRMaXN0U2VsZWN0aW9uc0J5SWQoaWRzOiBhbnksIGRhdGFTb3VyY2U6IGFueSkge1xyXG4gICAgbGV0IHJlc3VsdCA9IFtdO1xyXG4gICAgY29uc3QgX3RoaXMgPSB0aGlzO1xyXG4gICAgaWYgKCh0eXBlb2YgaWRzID09PSAnc3RyaW5nJyAmJiAhIWlkcykgfHwgdHlwZW9mIGlkcyA9PT0gJ251bWJlcicpIHtcclxuICAgICAgY29uc3QgcmV1c2x0T2JqID0gZGF0YVNvdXJjZS5maW5kKGl0ZW0gPT4ge1xyXG4gICAgICAgIHJldHVybiBpdGVtICYmIGl0ZW1bX3RoaXMuaWRGaWVsZF0gPT09IGlkcztcclxuICAgICAgfSk7XHJcbiAgICAgIGlmIChyZXVzbHRPYmopIHtcclxuICAgICAgICByZXN1bHQucHVzaChyZXVzbHRPYmopO1xyXG4gICAgICB9XHJcbiAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkoaWRzKSkge1xyXG4gICAgICBpZiAoZGF0YVNvdXJjZSkge1xyXG4gICAgICAgIGlkcy5mb3JFYWNoKGlkID0+IHtcclxuICAgICAgICAgIGNvbnN0IGl0ZW0gPSBkYXRhU291cmNlLmZpbmQoaXRlbSA9PiBpdGVtICYmIGl0ZW1bX3RoaXMuaWRGaWVsZF0gPT09IGlkKTtcclxuICAgICAgICAgIGlmIChpdGVtKSB7XHJcbiAgICAgICAgICAgIHJlc3VsdC5wdXNoKGl0ZW0pO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIC8vIGRhdGFTb3VyY2UuZm9yRWFjaChpdGVtID0+IHtcclxuICAgICAgICAvLyAgIGlkcy5mb3JFYWNoKGlkID0+IHtcclxuICAgICAgICAvLyAgICAgaWYgKGl0ZW1bX3RoaXMuaWRGaWVsZF0gPT09IGlkKSB7XHJcbiAgICAgICAgLy8gICAgICAgcmVzdWx0LnB1c2goaXRlbSk7XHJcbiAgICAgICAgLy8gICAgIH1cclxuICAgICAgICAvLyAgIH0pXHJcbiAgICAgICAgLy8gfSlcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICByZXN1bHQgPSBbXTtcclxuICAgICAgfVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmVzdWx0ID0gW107XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcmVzdWx0O1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogXHJcbiAgICogQHBhcmFtIGlkcyDpgInkuK3mlbDmja7nmoRpZFxyXG4gICAqIEBwYXJhbSBkYXRhU291cmNlIOWOn+Wni+aVsOaNrlxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0VHJlZVNlbGVjdGlvbnNCeUlkKGlkczogYW55LCBkYXRhU291cmNlOiBhbnkpIHtcclxuICAgIGxldCByZXN1bHQgPSBbXTtcclxuICAgIGNvbnN0IF90aGlzID0gdGhpcztcclxuICAgIGlmICgodHlwZW9mIGlkcyA9PT0gJ3N0cmluZycgJiYgISFpZHMpIHx8IHR5cGVvZiBpZHMgPT09ICdudW1iZXInKSB7XHJcbiAgICAgIGNvbnN0IHJldXNsdE9iaiA9IGRhdGFTb3VyY2UuZmluZChpdGVtID0+IHtcclxuICAgICAgICByZXR1cm4gaXRlbSAmJiBpdGVtW190aGlzLmlkRmllbGRdID09PSBpZHM7XHJcbiAgICAgIH0pO1xyXG4gICAgICBpZiAocmV1c2x0T2JqKSB7XHJcbiAgICAgICAgcmVzdWx0LnB1c2gocmV1c2x0T2JqKTtcclxuICAgICAgfVxyXG4gICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KGlkcykpIHtcclxuICAgICAgaWYgKGRhdGFTb3VyY2UpIHtcclxuICAgICAgICBpZHMuZm9yRWFjaChpZCA9PiB7XHJcbiAgICAgICAgICBjb25zdCBpdGVtID0gZGF0YVNvdXJjZS5maW5kKGl0ZW0gPT4gaXRlbSAmJiBpdGVtW190aGlzLmlkRmllbGRdID09PSBpZCk7XHJcbiAgICAgICAgICBpZiAoaXRlbSkge1xyXG4gICAgICAgICAgICByZXN1bHQucHVzaChpdGVtKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgICAvLyBkYXRhU291cmNlLmZvckVhY2goaXRlbSA9PiB7XHJcbiAgICAgICAgLy8gICBpZHMuZm9yRWFjaChpZCA9PiB7XHJcbiAgICAgICAgLy8gICAgIGlmIChpdGVtLmRhdGFbX3RoaXMuaWRGaWVsZF0gPT09IGlkKSB7XHJcbiAgICAgICAgLy8gICAgICAgcmVzdWx0LnB1c2goaXRlbS5kYXRhKTtcclxuICAgICAgICAvLyAgICAgfVxyXG4gICAgICAgIC8vICAgfSlcclxuICAgICAgICAvLyB9KVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHJlc3VsdCA9IFtdO1xyXG4gICAgICB9XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXN1bHQgPSBbXTtcclxuICAgIH1cclxuICAgIHJldHVybiByZXN1bHQ7XHJcbiAgfVxyXG5cclxuXHJcblxyXG4gIC8qKlxyXG4gICAqIOagueaNrueItuiKgueCueWIneWni+WMluagkee7k+aehFxyXG4gICAqIEBwYXJhbSBiaW5kaW5nT2JqZWN0cyBcclxuICAgKi9cclxuICBwcml2YXRlIGJ1aWxkVHJlZU5vZGVzQnlGamQoYmluZGluZ09iamVjdHM6IEJpbmRpbmdPYmplY3RbXSwgZmllbGQ6IHN0cmluZykge1xyXG4gICAgY29uc3QgdHJlZURhdGEgPSB0aGlzLmZvcm1hdERhdGFTb3VyY2UoYmluZGluZ09iamVjdHMsIGZpZWxkKTtcclxuICAgIHRyZWVEYXRhLmZvckVhY2goKGl0ZW06IGFueSkgPT4ge1xyXG4gICAgICBjb25zdCBwYXJlbnQgPSB0cmVlRGF0YS5maW5kKChlbGU6IGFueSkgPT4gaXRlbS5kYXRhW2ZpZWxkXS5wYXJlbnRFbGVtZW50ID09PSBlbGUuZGF0YVt0aGlzLmlkRmllbGRdKTtcclxuICAgICAgaWYgKHBhcmVudCkge1xyXG4gICAgICAgIHBhcmVudC5jaGlsZHJlbi5wdXNoKGl0ZW0pO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICAgIHJldHVybiB0cmVlRGF0YS5maWx0ZXIoKGVsZTogYW55KSA9PiAhZWxlLmRhdGFbZmllbGRdLnBhcmVudEVsZW1lbnQpO1xyXG4gIH1cclxufVxyXG4iXX0=