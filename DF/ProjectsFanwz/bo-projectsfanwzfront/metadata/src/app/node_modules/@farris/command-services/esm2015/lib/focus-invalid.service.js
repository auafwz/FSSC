import { Injectable, ElementRef } from '@angular/core';
import { Repository, FrameContext } from '@farris/devkit';
import { FrameContextService } from './frame-context.service';
import { FormControlService } from './form-control.service';
const FIXED_COLUMN_START_INDEX = 5000;
const GRID_COLUMN_START_INDEX = 10000;
/**
 * 表单验证服务
 * @scope FrameComponent
 */
class FocusInvalidService {
    /**
     * 构造函数
     */
    constructor(repository, frameContext, frameContextService, formControlService) {
        this.repository = repository;
        this.frameContext = frameContext;
        this.frameContextService = frameContextService;
        this.formControlService = formControlService;
    }
    /**
     * 向第一个验证不通过的字段设置焦点
     */
    focusInvalidInput(verifyInformations, rootElement) {
        // 无验证不通过信息时，直接返回。
        if (!verifyInformations || !verifyInformations.length) {
            return;
        }
        let targetField = null;
        const firstVerifyInformation = this.selectFirstVerifyInformation(verifyInformations, rootElement);
        if (firstVerifyInformation) {
            targetField = firstVerifyInformation.targetField;
            if (targetField) {
                const canFocus = this.focusElement(targetField, rootElement);
                if (canFocus) {
                    verifyInformations['focused'] = true;
                }
            }
        }
    }
    /**
     * 设置DataGrid单元格焦点
     */
    focusGridCell(verifyInformations, focusableDataGrid) {
        if (!verifyInformations || !verifyInformations.length || verifyInformations['focused'] == true) {
            return;
        }
        let targetField = null;
        let targetId = null;
        const firstVerifyInformation = this.selectFirstVerifyInformation(verifyInformations);
        if (firstVerifyInformation) {
            targetField = firstVerifyInformation.targetField;
            targetId = firstVerifyInformation.id;
            verifyInformations['focused'] = true;
            focusableDataGrid.editCell(targetId, targetField);
        }
    }
    updateVerifyInformationsIndex(verifyInformations, rootElement) {
        verifyInformations = verifyInformations.filter((verifyInformation) => {
            const frameContexts = this.getFrameContextsByPropertyPath(verifyInformation.fullPath, '/');
            const frameContext = frameContexts && frameContexts[0] || null;
            return frameContext && frameContext.frameId === this.frameContext.frameId;
        });
        return verifyInformations.map((verifyInformation) => {
            let tabIndex = -1;
            if (verifyInformation) {
                if (rootElement && verifyInformation.targetField) {
                    const input = this.getInputElementById(verifyInformation.targetField, rootElement);
                    tabIndex = input && input.getAttribute('tabindex') || -1;
                    tabIndex = Number(tabIndex);
                }
                const frameContexts = this.getFrameContextsByPropertyPath(verifyInformation.fullPath, '/');
                const frameContext = frameContexts && frameContexts[0] || null;
                const frameIndex = frameContext.index + 1;
                verifyInformation.tabIndex = tabIndex;
                verifyInformation.domIndex = -1;
                verifyInformation.frameIndex = -1;
                verifyInformation.position = tabIndex;
                if (frameContext) {
                    const domIndex = this.getFieldIndex(frameContext, verifyInformation.fullPath) || 0;
                    if (domIndex > 0) {
                        const rowIndex = verifyInformation.index || 0;
                        verifyInformation.domIndex = domIndex;
                        verifyInformation.frameIndex = frameContext.index;
                        verifyInformation.position = tabIndex > 0 ? tabIndex : (frameIndex * 1000 + rowIndex * 1000 + domIndex);
                    }
                }
            }
            return verifyInformation;
        });
    }
    isGridComponent(frameContext) {
        if (frameContext) {
            const dataGridColumnsName = frameContext.viewModel['dataGridColumnsName'] || null;
            return dataGridColumnsName ? true : false;
        }
        return undefined;
    }
    getColumnIndex(frameContext, binding) {
        binding = binding.split('/').filter(p => p).join('/');
        const bindingPaths = frameContext.viewModel.bindingPath.split('/').filter(p => p);
        const dataGridColumnsName = frameContext.viewModel['dataGridColumnsName'] || null;
        const frameIndex = frameContext.index + 1;
        if (!dataGridColumnsName) {
            return undefined;
        }
        let columns = frameContext.viewModel[dataGridColumnsName];
        if (!columns || columns.length < 1) {
            return undefined;
        }
        // 打平columns
        columns = columns.reduce((results, item) => {
            if (Array.isArray(item)) {
                return results.concat(item);
            }
            return results.concat([item]);
        }, []);
        let position = -1;
        for (let index = 0; index < columns.length; index++) {
            const column = columns[index];
            const fields = column && column.field && column.field.split('.').filter(p => p) || null;
            if (!fields) {
                continue;
            }
            if (bindingPaths.concat(fields).join('/') === binding) {
                const fixed = column.fixed;
                if (fixed) {
                    const fixedColumns = columns.filter(item => item.fixed === fixed);
                    const fixedColumnIndex = this.getIndexFromColumns(fixedColumns, binding);
                    if (fixed === 'left') {
                        position = frameIndex * FIXED_COLUMN_START_INDEX + fixedColumnIndex;
                    }
                    else {
                        position = frameIndex * GRID_COLUMN_START_INDEX + 1000 + fixedColumnIndex;
                    }
                }
                else {
                    position = frameIndex * GRID_COLUMN_START_INDEX + index;
                }
                break;
            }
        }
        return position;
    }
    getIndexFromColumns(columns, binding) {
        const bindingPaths = this.frameContext.viewModel.bindingPath.split('/').filter(p => p);
        return columns.findIndex(column => {
            const fields = column && column.field && column.field.split('.').filter(p => p) || null;
            if (!fields) {
                return false;
            }
            if (bindingPaths.concat(fields).join('/') === binding) {
                return true;
            }
            return false;
        });
    }
    selectFirstVerifyInformation(verifyInformations, rootElement) {
        verifyInformations = this.updateVerifyInformationsIndex(verifyInformations, rootElement);
        verifyInformations.sort((v1, v2) => Number(v1.position) - Number(v2.position));
        return verifyInformations && verifyInformations.length > 0 && verifyInformations[0] || null;
    }
    getInputElementById(targetField, rootElement) {
        let element = rootElement.nativeElement.ownerDocument.getElementById(targetField) || null;
        if (element && element.tagName !== 'INPUT') {
            const inputs = element.getElementsByTagName('input');
            if (inputs.length) {
                element = inputs[0];
            }
        }
        return element;
    }
    getFrameContextsByPropertyPath(propertyPath, separtor = '/') {
        if (!propertyPath) {
            return [];
        }
        const frameContexts = this.frameContext && this.frameContext.appContext.frameContextManager.getFrameContexts() || [];
        return frameContexts.filter((frameContext) => {
            const formControls = frameContext && frameContext.form && frameContext.form.ngFormControls || {};
            const bindingPath = frameContext && frameContext.viewModel && frameContext.viewModel.bindingPath || '';
            if (formControls && Object.keys(formControls).length > 0) {
                const key = Object.keys(formControls).find((key) => {
                    const formControl = formControls[key];
                    if (!formControl || !formControl.binding) {
                        return false;
                    }
                    const bindings = formControl.binding.split('.').filter(p => p);
                    const bindingPaths = bindingPath.split('/').filter(p => p);
                    const fullPath = bindingPaths.concat(bindings);
                    return propertyPath.split(separtor).filter(p => p).join('/') === fullPath.join('/');
                });
                return key ? true : false;
            }
            return false;
        });
    }
    getFormControlIndexByBindingPath(frameContext, binding) {
        const ngFormControls = this.getFormControlsByFrameContext(frameContext);
        if (!ngFormControls) {
            return null;
        }
        const bindings = binding.split('/').filter(p => p);
        return Object.values(ngFormControls).findIndex((ngFormControl) => {
            if (!ngFormControl) {
                return false;
            }
            const bindingPath = frameContext.viewModel.bindingPath;
            const bindingPaths = bindingPath.split('/').filter(p => p);
            const formControlBindingPaths = ngFormControl.binding.split('.').filter(p => p);
            const fullPath = bindingPaths.concat(formControlBindingPaths);
            return fullPath.join('/') === bindings.join('/');
        });
    }
    getFieldIndex(frameContext, binding) {
        const isGridComponent = this.isGridComponent(frameContext);
        if (isGridComponent) {
            return this.getColumnIndex(frameContext, binding);
        }
        else {
            return this.getFormControlIndexByBindingPath(frameContext, binding);
        }
    }
    getFormControlsByFrameContext(frameContext) {
        return frameContext && frameContext.form && frameContext.form.ngFormControls || null;
    }
    focusElement(elementId, rootElement) {
        let focused = false;
        let elementToFocus = rootElement.nativeElement.ownerDocument.getElementById(elementId);
        // 未获取到指定字段时，返回，不再设置焦点。
        if (elementToFocus) {
            // 如果有多个id重复的元素，则不定位
            const elements = rootElement.nativeElement.ownerDocument.querySelectorAll(`#${elementId}`);
            if (elements && elements.length > 1) {
                return focused;
            }
            // 如果绑定目标字段的控件不是Input元素，则查找其下级节点。
            if (elementToFocus.tagName !== 'INPUT') {
                const subElements = elementToFocus.getElementsByTagName('input');
                if (subElements.length) {
                    elementToFocus = subElements[0];
                }
            }
            elementToFocus.focus();
            focused = true;
        }
        return focused;
    }
    /**
     * 设置焦点
     * @param verifyInformation 错误信息
     * @param frameContext 上下文
     * @returns
     */
    focus(verifyInformation, frameContext) {
        if (!verifyInformation) {
            return;
        }
        const isGridValidation = verifyInformation.index !== null;
        if (isGridValidation) {
            const grid = this.getGridRef(frameContext);
            if (grid) {
                setTimeout(() => {
                    grid.editCell(verifyInformation.id, verifyInformation.targetField);
                }, 0);
            }
        }
        else {
            const frameElement = this.getComponentRef(frameContext);
            const elementId = verifyInformation.targetField;
            this.focusById(elementId, frameElement);
        }
    }
    /**
     * 通过控件id设置焦点
     * @param elementId
     * @param elementRef
     */
    focusById(elementId, elementRef) {
        const document = elementRef && elementRef.nativeElement.ownerDocument || window.document;
        if (document) {
            const element = document.getElementById(elementId);
            if (element.tagName !== 'INPUT') {
                const subElements = element.getElementsByTagName('input');
                if (subElements.length) {
                    const input = subElements[0];
                    if (input && typeof input.focus === 'function') {
                        input.focus();
                    }
                }
            }
            else {
                element.focus();
            }
        }
    }
    /**
     * 获取组件实例
     * @param frameContext
     * @returns
     */
    getComponentRef(frameContext) {
        return this.frameContext && this.frameContext.injector.get(ElementRef, null) || null;
    }
    /**
     * 获取grid实例
     * @param frameContext frameContext
     * @returns
     */
    getGridRef(frameContext) {
        const namespace = frameContext.namespace;
        const bindingPath = frameContext.viewModel.bindingPath;
        const frameContexts = this.frameContext.appContext.frameContextManager.getFrameContextsByNamespace(namespace) || [];
        const matchedFrameContexts = frameContexts.filter((frameContext) => frameContext.viewModel && frameContext.viewModel.bindingPath.split('/').filter(p => p).toString() === bindingPath.split('/').filter(p => p).toString());
        let result = null;
        if (matchedFrameContexts) {
            matchedFrameContexts.every((frameContext) => {
                const frameId = frameContext.frameId;
                const componentsMap = this.frameContext.appContext.componentManager.getComponentsByFrameId(frameId);
                if (!componentsMap) {
                    return true;
                }
                const datagridComponent = Array.from(componentsMap.values()).find((component) => component && component['__component_type__'] === 'DatagridComponent');
                if (datagridComponent) {
                    result = datagridComponent;
                    return false;
                }
                else {
                    return true;
                }
            });
        }
        return result;
    }
}
FocusInvalidService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
FocusInvalidService.ctorParameters = () => [
    { type: Repository },
    { type: FrameContext },
    { type: FrameContextService },
    { type: FormControlService }
];
export { FocusInvalidService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9jdXMtaW52YWxpZC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL2ZvY3VzLWludmFsaWQuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN2RCxPQUFPLEVBQUUsVUFBVSxFQUFFLFlBQVksRUFBaUIsTUFBTSxnQkFBZ0IsQ0FBQztBQUN6RSxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUM5RCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUU1RCxNQUFNLHdCQUF3QixHQUFHLElBQUksQ0FBQztBQUN0QyxNQUFNLHVCQUF1QixHQUFHLEtBQUssQ0FBQztBQUt0Qzs7O0dBR0c7QUFDSCxNQUNNLG1CQUFtQjtJQUN2Qjs7T0FFRztJQUNILFlBQ1UsVUFBMkIsRUFDM0IsWUFBMEIsRUFDMUIsbUJBQXdDLEVBQ3hDLGtCQUFzQztRQUh0QyxlQUFVLEdBQVYsVUFBVSxDQUFpQjtRQUMzQixpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQix3QkFBbUIsR0FBbkIsbUJBQW1CLENBQXFCO1FBQ3hDLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBb0I7SUFFaEQsQ0FBQztJQUVEOztPQUVHO0lBQ0ksaUJBQWlCLENBQUMsa0JBQXlCLEVBQUUsV0FBNEI7UUFDOUUsa0JBQWtCO1FBQ2xCLElBQUksQ0FBQyxrQkFBa0IsSUFBSSxDQUFDLGtCQUFrQixDQUFDLE1BQU0sRUFBRTtZQUNyRCxPQUFPO1NBQ1I7UUFDRCxJQUFJLFdBQVcsR0FBRyxJQUFJLENBQUM7UUFDdkIsTUFBTSxzQkFBc0IsR0FBRyxJQUFJLENBQUMsNEJBQTRCLENBQUMsa0JBQWtCLEVBQUUsV0FBVyxDQUFDLENBQUM7UUFDbEcsSUFBSSxzQkFBc0IsRUFBRTtZ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LEVBQUUsQ0FBQyxTQUFTLElBQUksU0FBUyxDQUFDLG9CQUFvQixDQUFDLEtBQUssbUJBQW1CLENBQUMsQ0FBQztnQkFDNUosSUFBSSxpQkFBaUIsRUFBRTtvQkFDckIsTUFBTSxHQUFHLGlCQUFpQixDQUFDO29CQUMzQixPQUFPLEtBQUssQ0FBQztpQkFDZDtxQkFBTTtvQkFDTCxPQUFPLElBQUksQ0FBQztpQkFDYjtZQUNILENBQUMsQ0FBQyxDQUFDO1NBQ0o7UUFDRCxPQUFPLE1BQU0sQ0FBQztJQUNoQixDQUFDOzs7WUFqVUYsVUFBVTs7OztZQWRGLFVBQVU7WUFBRSxZQUFZO1lBQ3hCLG1CQUFtQjtZQUNuQixrQkFBa0I7O0FBZ1YzQixPQUFPLEVBQTZCLG1CQUFtQixFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBFbGVtZW50UmVmIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IFJlcG9zaXRvcnksIEZyYW1lQ29udGV4dCwgTmdGb3JtQ29udHJvbCB9IGZyb20gJ0BmYXJyaXMvZGV2a2l0JztcclxuaW1wb3J0IHsgRnJhbWVDb250ZXh0U2VydmljZSB9IGZyb20gJy4vZnJhbWUtY29udGV4dC5zZXJ2aWNlJztcclxuaW1wb3J0IHsgRm9ybUNvbnRyb2xTZXJ2aWNlIH0gZnJvbSAnLi9mb3JtLWNvbnRyb2wuc2VydmljZSc7XHJcblxyXG5jb25zdCBGSVhFRF9DT0xVTU5fU1RBUlRfSU5ERVggPSA1MDAwO1xyXG5jb25zdCBHUklEX0NPTFVNTl9TVEFSVF9JTkRFWCA9IDEwMDAwO1xyXG5pbnRlcmZhY2UgRm9jdXNhYmxlSW52YWxpZGF0aW9uR3JpZCB7XHJcbiAgZWRpdENlbGwocm93SWQ6IGFueSwgZmllbGQ6IHN0cmluZyk6IHZvaWQ7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDooajljZXpqozor4HmnI3liqFcclxuICogQHNjb3BlIEZyYW1lQ29tcG9uZW50XHJcbiAqL1xyXG5ASW5qZWN0YWJsZSgpXHJcbmNsYXNzIEZvY3VzSW52YWxpZFNlcnZpY2Uge1xyXG4gIC8qKlxyXG4gICAqIOaehOmAoOWHveaVsFxyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJpdmF0ZSByZXBvc2l0b3J5OiBSZXBvc2l0b3J5PGFueT4sXHJcbiAgICBwcml2YXRlIGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0LFxyXG4gICAgcHJpdmF0ZSBmcmFtZUNvbnRleHRTZXJ2aWNlOiBGcmFtZUNvbnRleHRTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSBmb3JtQ29udHJvbFNlcnZpY2U6IEZvcm1Db250cm9sU2VydmljZVxyXG4gICkge1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5ZCR56ys5LiA5Liq6aqM6K+B5LiN6YCa6L+H55qE5a2X5q616K6+572u54Sm54K5XHJcbiAgICovXHJcbiAgcHVibGljIGZvY3VzSW52YWxpZElucHV0KHZlcmlmeUluZm9ybWF0aW9uczogYW55W10sIHJvb3RFbGVtZW50OiBFbGVtZW50UmVmPGFueT4pIHtcclxuICAgIC8vIOaXoOmqjOivgeS4jemAmui/h+S/oeaBr+aXtu+8jOebtOaOpei/lOWbnuOAglxyXG4gICAgaWYgKCF2ZXJpZnlJbmZvcm1hdGlvbnMgfHwgIXZlcmlmeUluZm9ybWF0aW9ucy5sZW5ndGgpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgbGV0IHRhcmdldEZpZWxkID0gbnVsbDtcclxuICAgIGNvbnN0IGZpcnN0VmVyaWZ5SW5mb3JtYXRpb24gPSB0aGlzLnNlbGVjdEZpcnN0VmVyaWZ5SW5mb3JtYXRpb24odmVyaWZ5SW5mb3JtYXRpb25zLCByb290RWxlbWVudCk7XHJcbiAgICBpZiAoZmlyc3RWZXJpZnlJbmZvcm1hdGlvbikge1xyXG4gICAgICB0YXJnZXRGaWVsZCA9IGZpcnN0VmVyaWZ5SW5mb3JtYXRpb24udGFyZ2V0RmllbGQ7XHJcbiAgICAgIGlmICh0YXJnZXRGaWVsZCkge1xyXG4gICAgICAgIGNvbnN0IGNhbkZvY3VzID0gdGhpcy5mb2N1c0VsZW1lbnQodGFyZ2V0RmllbGQsIHJvb3RFbGVtZW50KTtcclxuICAgICAgICBpZiAoY2FuRm9jdXMpIHtcclxuICAgICAgICAgIHZlcmlmeUluZm9ybWF0aW9uc1snZm9jdXNlZCddID0gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiuvue9rkRhdGFHcmlk5Y2V5YWD5qC854Sm54K5XHJcbiAgICovXHJcbiAgcHVibGljIGZvY3VzR3JpZENlbGwodmVyaWZ5SW5mb3JtYXRpb25zOiBhbnlbXSwgZm9jdXNhYmxlRGF0YUdyaWQ6IEZvY3VzYWJsZUludmFsaWRhdGlvbkdyaWQpIHtcclxuICAgIGlmICghdmVyaWZ5SW5mb3JtYXRpb25zIHx8ICF2ZXJpZnlJbmZvcm1hdGlvbnMubGVuZ3RoIHx8IHZlcmlmeUluZm9ybWF0aW9uc1snZm9jdXNlZCddID09IHRydWUpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgbGV0IHRhcmdldEZpZWxkID0gbnVsbDtcclxuICAgIGxldCB0YXJnZXRJZCA9IG51bGw7XHJcbiAgICBjb25zdCBmaXJzdFZlcmlmeUluZm9ybWF0aW9uID0gdGhpcy5zZWxlY3RGaXJzdFZlcmlmeUluZm9ybWF0aW9uKHZlcmlmeUluZm9ybWF0aW9ucyk7XHJcbiAgICBpZiAoZmlyc3RWZXJpZnlJbmZvcm1hdGlvbikge1xyXG4gICAgICB0YXJnZXRGaWVsZCA9IGZpcnN0VmVyaWZ5SW5mb3JtYXRpb24udGFyZ2V0RmllbGQ7XHJcbiAgICAgIHRhcmdldElkID0gZmlyc3RWZXJpZnlJbmZvcm1hdGlvbi5pZDtcclxuICAgICAgdmVyaWZ5SW5mb3JtYXRpb25zWydmb2N1c2VkJ10gPSB0cnVlO1xyXG4gICAgICBmb2N1c2FibGVEYXRhR3JpZC5lZGl0Q2VsbCh0YXJnZXRJZCwgdGFyZ2V0RmllbGQpO1xyXG4gICAgfVxyXG4gIH1cclxuICBwcml2YXRlIHVwZGF0ZVZlcmlmeUluZm9ybWF0aW9uc0luZGV4KHZlcmlmeUluZm9ybWF0aW9uczogYW55W10sIHJvb3RFbGVtZW50PzogRWxlbWVudFJlZjxhbnk+KSB7XHJcbiAgICB2ZXJpZnlJbmZvcm1hdGlvbnMgPSB2ZXJpZnlJbmZvcm1hdGlvbnMuZmlsdGVyKCh2ZXJpZnlJbmZvcm1hdGlvbjogYW55KSA9PiB7XHJcbiAgICAgIGNvbnN0IGZyYW1lQ29udGV4dHMgPSB0aGlzLmdldEZyYW1lQ29udGV4dHNCeVByb3BlcnR5UGF0aCh2ZXJpZnlJbmZvcm1hdGlvbi5mdWxsUGF0aCwgJy8nKTtcclxuICAgICAgY29uc3QgZnJhbWVDb250ZXh0ID0gZnJhbWVDb250ZXh0cyAmJiBmcmFtZUNvbnRleHRzWzBdIHx8IG51bGw7XHJcbiAgICAgIHJldHVybiBmcmFtZUNvbnRleHQgJiYgZnJhbWVDb250ZXh0LmZyYW1lSWQgPT09IHRoaXMuZnJhbWVDb250ZXh0LmZyYW1lSWQ7XHJcbiAgICB9KTtcclxuICAgIHJldHVybiB2ZXJpZnlJbmZvcm1hdGlvbnMubWFwKCh2ZXJpZnlJbmZvcm1hdGlvbjogYW55KSA9PiB7XHJcbiAgICAgIGxldCB0YWJJbmRleCA9IC0xO1xyXG4gICAgICBpZiAodmVyaWZ5SW5mb3JtYXRpb24pIHtcclxuICAgICAgICBpZiAocm9vdEVsZW1lbnQgJiYgdmVyaWZ5SW5mb3JtYXRpb24udGFyZ2V0RmllbGQpIHtcclxuICAgICAgICAgIGNvbnN0IGlucHV0ID0gdGhpcy5nZXRJbnB1dEVsZW1lbnRCeUlkKHZlcmlmeUluZm9ybWF0aW9uLnRhcmdldEZpZWxkLCByb290RWxlbWVudCk7XHJcbiAgICAgICAgICB0YWJJbmRleCA9IGlucHV0ICYmIGlucHV0LmdldEF0dHJpYnV0ZSgndGFiaW5kZXgnKSB8fCAtMTtcclxuICAgICAgICAgIHRhYkluZGV4ID0gTnVtYmVyKHRhYkluZGV4KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgZnJhbWVDb250ZXh0cyA9IHRoaXMuZ2V0RnJhbWVDb250ZXh0c0J5UHJvcGVydHlQYXRoKHZlcmlmeUluZm9ybWF0aW9uLmZ1bGxQYXRoLCAnLycpO1xyXG4gICAgICAgIGNvbnN0IGZyYW1lQ29udGV4dCA9IGZyYW1lQ29udGV4dHMgJiYgZnJhbWVDb250ZXh0c1swXSB8fCBudWxsO1xyXG4gICAgICAgIGNvbnN0IGZyYW1lSW5kZXggPSBmcmFtZUNvbnRleHQuaW5kZXggKyAxO1xyXG4gICAgICAgIHZlcmlmeUluZm9ybWF0aW9uLnRhYkluZGV4ID0gdGFiSW5kZXg7XHJcbiAgICAgICAgdmVyaWZ5SW5mb3JtYXRpb24uZG9tSW5kZXggPSAtMTtcclxuICAgICAgICB2ZXJpZnlJbmZvcm1hdGlvbi5mcmFtZUluZGV4ID0gLTE7XHJcbiAgICAgICAgdmVyaWZ5SW5mb3JtYXRpb24ucG9zaXRpb24gPSB0YWJJbmRleDtcclxuICAgICAgICBpZiAoZnJhbWVDb250ZXh0KSB7XHJcbiAgICAgICAgICBjb25zdCBkb21JbmRleCA9IHRoaXMuZ2V0RmllbGRJbmRleChmcmFtZUNvbnRleHQsIHZlcmlmeUluZm9ybWF0aW9uLmZ1bGxQYXRoKSB8fCAwO1xyXG4gICAgICAgICAgaWYgKGRvbUluZGV4ID4gMCkge1xyXG4gICAgICAgICAgICBjb25zdCByb3dJbmRleCA9IHZlcmlmeUluZm9ybWF0aW9uLmluZGV4IHx8IDA7XHJcbiAgICAgICAgICAgIHZlcmlmeUluZm9ybWF0aW9uLmRvbUluZGV4ID0gZG9tSW5kZXg7XHJcbiAgICAgICAgICAgIHZlcmlmeUluZm9ybWF0aW9uLmZyYW1lSW5kZXggPSBmcmFtZUNvbnRleHQuaW5kZXg7XHJcbiAgICAgICAgICAgIHZlcmlmeUluZm9ybWF0aW9uLnBvc2l0aW9uID0gdGFiSW5kZXggPiAwID8gdGFiSW5kZXggOiAoZnJhbWVJbmRleCAqIDEwMDAgKyByb3dJbmRleCAqIDEwMDAgKyBkb21JbmRleCk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiB2ZXJpZnlJbmZvcm1hdGlvbjtcclxuICAgIH0pO1xyXG4gIH1cclxuICBwcml2YXRlIGlzR3JpZENvbXBvbmVudChmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCkge1xyXG4gICAgaWYgKGZyYW1lQ29udGV4dCkge1xyXG4gICAgICBjb25zdCBkYXRhR3JpZENvbHVtbnNOYW1lID0gZnJhbWVDb250ZXh0LnZpZXdNb2RlbFsnZGF0YUdyaWRDb2x1bW5zTmFtZSddIHx8IG51bGw7XHJcbiAgICAgIHJldHVybiBkYXRhR3JpZENvbHVtbnNOYW1lID8gdHJ1ZSA6IGZhbHNlO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcclxuICB9XHJcbiAgcHJpdmF0ZSBnZXRDb2x1bW5JbmRleChmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCwgYmluZGluZzogc3RyaW5nKSB7XHJcbiAgICBiaW5kaW5nID0gYmluZGluZy5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApLmpvaW4oJy8nKTtcclxuICAgIGNvbnN0IGJpbmRpbmdQYXRocyA9IGZyYW1lQ29udGV4dC52aWV3TW9kZWwuYmluZGluZ1BhdGguc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKTtcclxuICAgIGNvbnN0IGRhdGFHcmlkQ29sdW1uc05hbWUgPSBmcmFtZUNvbnRleHQudmlld01vZGVsWydkYXRhR3JpZENvbHVtbnNOYW1lJ10gfHwgbnVsbDtcclxuICAgIGNvbnN0IGZyYW1lSW5kZXggPSBmcmFtZUNvbnRleHQuaW5kZXggKyAxO1xyXG4gICAgaWYgKCFkYXRhR3JpZENvbHVtbnNOYW1lKSB7XHJcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgICB9XHJcbiAgICBsZXQgY29sdW1uczogYW55W10gPSBmcmFtZUNvbnRleHQudmlld01vZGVsW2RhdGFHcmlkQ29sdW1uc05hbWVdO1xyXG4gICAgaWYgKCFjb2x1bW5zIHx8IGNvbHVtbnMubGVuZ3RoIDwgMSkge1xyXG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG4gICAgfVxyXG4gICAgLy8g5omT5bmzY29sdW1uc1xyXG4gICAgY29sdW1ucyA9IGNvbHVtbnMucmVkdWNlKChyZXN1bHRzOiBhbnlbXSwgaXRlbSkgPT4ge1xyXG4gICAgICBpZiAoQXJyYXkuaXNBcnJheShpdGVtKSkge1xyXG4gICAgICAgIHJldHVybiByZXN1bHRzLmNvbmNhdChpdGVtKTtcclxuICAgICAgfVxyXG4gICAgICByZXR1cm4gcmVzdWx0cy5jb25jYXQoW2l0ZW1dKTtcclxuICAgIH0sIFtdKTtcclxuICAgIGxldCBwb3NpdGlvbiA9IC0xO1xyXG4gICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IGNvbHVtbnMubGVuZ3RoOyBpbmRleCsrKSB7XHJcbiAgICAgIGNvbnN0IGNvbHVtbjogYW55IHwgYW55W10gPSBjb2x1bW5zW2luZGV4XTtcclxuICAgICAgY29uc3QgZmllbGRzID0gY29sdW1uICYmIGNvbHVtbi5maWVsZCAmJiBjb2x1bW4uZmllbGQuc3BsaXQoJy4nKS5maWx0ZXIocCA9PiBwKSB8fCBudWxsO1xyXG4gICAgICBpZiAoIWZpZWxkcykge1xyXG4gICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICB9XHJcbiAgICAgIGlmIChiaW5kaW5nUGF0aHMuY29uY2F0KGZpZWxkcykuam9pbignLycpID09PSBiaW5kaW5nKSB7XHJcbiAgICAgICAgY29uc3QgZml4ZWQgPSBjb2x1bW4uZml4ZWQ7XHJcbiAgICAgICAgaWYgKGZpeGVkKSB7XHJcbiAgICAgICAgICBjb25zdCBmaXhlZENvbHVtbnMgPSBjb2x1bW5zLmZpbHRlcihpdGVtID0+IGl0ZW0uZml4ZWQgPT09IGZpeGVkKTtcclxuICAgICAgICAgIGNvbnN0IGZpeGVkQ29sdW1uSW5kZXggPSB0aGlzLmdldEluZGV4RnJvbUNvbHVtbnMoZml4ZWRDb2x1bW5zLCBiaW5kaW5nKTtcclxuICAgICAgICAgIGlmIChmaXhlZCA9PT0gJ2xlZnQnKSB7XHJcbiAgICAgICAgICAgIHBvc2l0aW9uID0gZnJhbWVJbmRleCAqIEZJWEVEX0NPTFVNTl9TVEFSVF9JTkRFWCArIGZpeGVkQ29sdW1uSW5kZXg7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBwb3NpdGlvbiA9IGZyYW1lSW5kZXggKiBHUklEX0NPTFVNTl9TVEFSVF9JTkRFWCArIDEwMDAgKyBmaXhlZENvbHVtbkluZGV4O1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBwb3NpdGlvbiA9IGZyYW1lSW5kZXggKiBHUklEX0NPTFVNTl9TVEFSVF9JTkRFWCArIGluZGV4O1xyXG4gICAgICAgIH1cclxuICAgICAgICBicmVhaztcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIHBvc2l0aW9uO1xyXG4gIH1cclxuICBwcml2YXRlIGdldEluZGV4RnJvbUNvbHVtbnMoY29sdW1uczogYW55W10sIGJpbmRpbmc6IHN0cmluZykge1xyXG4gICAgY29uc3QgYmluZGluZ1BhdGhzID0gdGhpcy5mcmFtZUNvbnRleHQudmlld01vZGVsLmJpbmRpbmdQYXRoLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCk7XHJcbiAgICByZXR1cm4gY29sdW1ucy5maW5kSW5kZXgoY29sdW1uID0+IHtcclxuICAgICAgY29uc3QgZmllbGRzID0gY29sdW1uICYmIGNvbHVtbi5maWVsZCAmJiBjb2x1bW4uZmllbGQuc3BsaXQoJy4nKS5maWx0ZXIocCA9PiBwKSB8fCBudWxsO1xyXG4gICAgICBpZiAoIWZpZWxkcykge1xyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgfVxyXG4gICAgICBpZiAoYmluZGluZ1BhdGhzLmNvbmNhdChmaWVsZHMpLmpvaW4oJy8nKSA9PT0gYmluZGluZykge1xyXG4gICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH0pO1xyXG4gIH1cclxuICBwcml2YXRlIHNlbGVjdEZpcnN0VmVyaWZ5SW5mb3JtYXRpb24odmVyaWZ5SW5mb3JtYXRpb25zOiBhbnlbXSwgcm9vdEVsZW1lbnQ/OiBFbGVtZW50UmVmPGFueT4pIHtcclxuICAgIHZlcmlmeUluZm9ybWF0aW9ucyA9IHRoaXMudXBkYXRlVmVyaWZ5SW5mb3JtYXRpb25zSW5kZXgodmVyaWZ5SW5mb3JtYXRpb25zLCByb290RWxlbWVudCk7XHJcbiAgICB2ZXJpZnlJbmZvcm1hdGlvbnMuc29ydCgodjE6IGFueSwgdjI6IGFueSkgPT4gTnVtYmVyKHYxLnBvc2l0aW9uKSAtIE51bWJlcih2Mi5wb3NpdGlvbikpO1xyXG4gICAgcmV0dXJuIHZlcmlmeUluZm9ybWF0aW9ucyAmJiB2ZXJpZnlJbmZvcm1hdGlvbnMubGVuZ3RoID4gMCAmJiB2ZXJpZnlJbmZvcm1hdGlvbnNbMF0gfHwgbnVsbDtcclxuICB9XHJcbiAgcHJpdmF0ZSBnZXRJbnB1dEVsZW1lbnRCeUlkKHRhcmdldEZpZWxkOiBzdHJpbmcsIHJvb3RFbGVtZW50OiBFbGVtZW50UmVmPGFueT4pIHtcclxuICAgIGxldCBlbGVtZW50ID0gcm9vdEVsZW1lbnQubmF0aXZlRWxlbWVudC5vd25lckRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHRhcmdldEZpZWxkKSB8fCBudWxsO1xyXG4gICAgaWYgKGVsZW1lbnQgJiYgZWxlbWVudC50YWdOYW1lICE9PSAnSU5QVVQnKSB7XHJcbiAgICAgIGNvbnN0IGlucHV0cyA9IGVsZW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2lucHV0Jyk7XHJcbiAgICAgIGlmIChpbnB1dHMubGVuZ3RoKSB7XHJcbiAgICAgICAgZWxlbWVudCA9IGlucHV0c1swXTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIGVsZW1lbnQ7XHJcbiAgfVxyXG4gIHB1YmxpYyBnZXRGcmFtZUNvbnRleHRzQnlQcm9wZXJ0eVBhdGgocHJvcGVydHlQYXRoOiBzdHJpbmcsIHNlcGFydG9yOiBzdHJpbmcgPSAnLycpOiBGcmFtZUNvbnRleHRbXSB7XHJcbiAgICBpZiAoIXByb3BlcnR5UGF0aCkge1xyXG4gICAgICByZXR1cm4gW107XHJcbiAgICB9XHJcbiAgICBjb25zdCBmcmFtZUNvbnRleHRzID0gdGhpcy5mcmFtZUNvbnRleHQgJiYgdGhpcy5mcmFtZUNvbnRleHQuYXBwQ29udGV4dC5mcmFtZUNvbnRleHRNYW5hZ2VyLmdldEZyYW1lQ29udGV4dHMoKSB8fCBbXTtcclxuICAgIHJldHVybiBmcmFtZUNvbnRleHRzLmZpbHRlcigoZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQpID0+IHtcclxuICAgICAgY29uc3QgZm9ybUNvbnRyb2xzID0gZnJhbWVDb250ZXh0ICYmIGZyYW1lQ29udGV4dC5mb3JtICYmIGZyYW1lQ29udGV4dC5mb3JtLm5nRm9ybUNvbnRyb2xzIHx8IHt9O1xyXG4gICAgICBjb25zdCBiaW5kaW5nUGF0aCA9IGZyYW1lQ29udGV4dCAmJiBmcmFtZUNvbnRleHQudmlld01vZGVsICYmIGZyYW1lQ29udGV4dC52aWV3TW9kZWwuYmluZGluZ1BhdGggfHwgJyc7XHJcbiAgICAgIGlmIChmb3JtQ29udHJvbHMgJiYgT2JqZWN0LmtleXMoZm9ybUNvbnRyb2xzKS5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgY29uc3Qga2V5ID0gT2JqZWN0LmtleXMoZm9ybUNvbnRyb2xzKS5maW5kKChrZXk6IHN0cmluZykgPT4ge1xyXG4gICAgICAgICAgY29uc3QgZm9ybUNvbnRyb2wgPSBmb3JtQ29udHJvbHNba2V5XTtcclxuICAgICAgICAgIGlmICghZm9ybUNvbnRyb2wgfHwgIWZvcm1Db250cm9sLmJpbmRpbmcpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgY29uc3QgYmluZGluZ3MgPSBmb3JtQ29udHJvbC5iaW5kaW5nLnNwbGl0KCcuJykuZmlsdGVyKHAgPT4gcCk7XHJcbiAgICAgICAgICBjb25zdCBiaW5kaW5nUGF0aHMgPSBiaW5kaW5nUGF0aC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApO1xyXG4gICAgICAgICAgY29uc3QgZnVsbFBhdGggPSBiaW5kaW5nUGF0aHMuY29uY2F0KGJpbmRpbmdzKTtcclxuICAgICAgICAgIHJldHVybiBwcm9wZXJ0eVBhdGguc3BsaXQoc2VwYXJ0b3IpLmZpbHRlcihwID0+IHApLmpvaW4oJy8nKSA9PT0gZnVsbFBhdGguam9pbignLycpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHJldHVybiBrZXkgPyB0cnVlIDogZmFsc2U7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfSk7XHJcbiAgfVxyXG4gIHB1YmxpYyBnZXRGb3JtQ29udHJvbEluZGV4QnlCaW5kaW5nUGF0aChmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCwgYmluZGluZzogc3RyaW5nKTogbnVtYmVyIHtcclxuICAgIGNvbnN0IG5nRm9ybUNvbnRyb2xzID0gdGhpcy5nZXRGb3JtQ29udHJvbHNCeUZyYW1lQ29udGV4dChmcmFtZUNvbnRleHQpO1xyXG4gICAgaWYgKCFuZ0Zvcm1Db250cm9scykge1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuICAgIGNvbnN0IGJpbmRpbmdzID0gYmluZGluZy5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApO1xyXG4gICAgcmV0dXJuIE9iamVjdC52YWx1ZXMobmdGb3JtQ29udHJvbHMpLmZpbmRJbmRleCgobmdGb3JtQ29udHJvbDogTmdGb3JtQ29udHJvbCkgPT4ge1xyXG4gICAgICBpZiAoIW5nRm9ybUNvbnRyb2wpIHtcclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgIH1cclxuICAgICAgY29uc3QgYmluZGluZ1BhdGggPSBmcmFtZUNvbnRleHQudmlld01vZGVsLmJpbmRpbmdQYXRoO1xyXG4gICAgICBjb25zdCBiaW5kaW5nUGF0aHMgPSBiaW5kaW5nUGF0aC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApO1xyXG4gICAgICBjb25zdCBmb3JtQ29udHJvbEJpbmRpbmdQYXRocyA9IG5nRm9ybUNvbnRyb2wuYmluZGluZy5zcGxpdCgnLicpLmZpbHRlcihwID0+IHApO1xyXG4gICAgICBjb25zdCBmdWxsUGF0aCA9IGJpbmRpbmdQYXRocy5jb25jYXQoZm9ybUNvbnRyb2xCaW5kaW5nUGF0aHMpO1xyXG4gICAgICByZXR1cm4gZnVsbFBhdGguam9pbignLycpID09PSBiaW5kaW5ncy5qb2luKCcvJyk7XHJcbiAgICB9KTtcclxuICB9XHJcbiAgcHVibGljIGdldEZpZWxkSW5kZXgoZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQsIGJpbmRpbmc6IHN0cmluZykge1xyXG4gICAgY29uc3QgaXNHcmlkQ29tcG9uZW50ID0gdGhpcy5pc0dyaWRDb21wb25lbnQoZnJhbWVDb250ZXh0KTtcclxuICAgIGlmIChpc0dyaWRDb21wb25lbnQpIHtcclxuICAgICAgcmV0dXJuIHRoaXMuZ2V0Q29sdW1uSW5kZXgoZnJhbWVDb250ZXh0LCBiaW5kaW5nKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiB0aGlzLmdldEZvcm1Db250cm9sSW5kZXhCeUJpbmRpbmdQYXRoKGZyYW1lQ29udGV4dCwgYmluZGluZyk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIHB1YmxpYyBnZXRGb3JtQ29udHJvbHNCeUZyYW1lQ29udGV4dChmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCk6IHsgW3Byb3BlcnR5TmFtZTogc3RyaW5nXTogTmdGb3JtQ29udHJvbCB9IHwgbnVsbCB7XHJcbiAgICByZXR1cm4gZnJhbWVDb250ZXh0ICYmIGZyYW1lQ29udGV4dC5mb3JtICYmIGZyYW1lQ29udGV4dC5mb3JtLm5nRm9ybUNvbnRyb2xzIHx8IG51bGw7XHJcbiAgfVxyXG4gIHB1YmxpYyBmb2N1c0VsZW1lbnQoZWxlbWVudElkOiBzdHJpbmcsIHJvb3RFbGVtZW50OiBFbGVtZW50UmVmPGFueT4pOiBib29sZWFuIHtcclxuICAgIGxldCBmb2N1c2VkID0gZmFsc2U7XHJcbiAgICBsZXQgZWxlbWVudFRvRm9jdXMgPSByb290RWxlbWVudC5uYXRpdmVFbGVtZW50Lm93bmVyRG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoZWxlbWVudElkKTtcclxuICAgIC8vIOacquiOt+WPluWIsOaMh+WumuWtl+auteaXtu+8jOi/lOWbnu+8jOS4jeWGjeiuvue9rueEpueCueOAglxyXG4gICAgaWYgKGVsZW1lbnRUb0ZvY3VzKSB7XHJcbiAgICAgIC8vIOWmguaenOacieWkmuS4qmlk6YeN5aSN55qE5YWD57Sg77yM5YiZ5LiN5a6a5L2NXHJcbiAgICAgIGNvbnN0IGVsZW1lbnRzID0gcm9vdEVsZW1lbnQubmF0aXZlRWxlbWVudC5vd25lckRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoYCMke2VsZW1lbnRJZH1gKTtcclxuICAgICAgaWYgKGVsZW1lbnRzICYmIGVsZW1lbnRzLmxlbmd0aCA+IDEpIHtcclxuICAgICAgICByZXR1cm4gZm9jdXNlZDtcclxuICAgICAgfVxyXG4gICAgICAvLyDlpoLmnpznu5Hlrprnm67moIflrZfmrrXnmoTmjqfku7bkuI3mmK9JbnB1dOWFg+e0oO+8jOWImeafpeaJvuWFtuS4i+e6p+iKgueCueOAglxyXG4gICAgICBpZiAoZWxlbWVudFRvRm9jdXMudGFnTmFtZSAhPT0gJ0lOUFVUJykge1xyXG4gICAgICAgIGNvbnN0IHN1YkVsZW1lbnRzID0gZWxlbWVudFRvRm9jdXMuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2lucHV0Jyk7XHJcbiAgICAgICAgaWYgKHN1YkVsZW1lbnRzLmxlbmd0aCkge1xyXG4gICAgICAgICAgZWxlbWVudFRvRm9jdXMgPSBzdWJFbGVtZW50c1swXTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgZWxlbWVudFRvRm9jdXMuZm9jdXMoKTtcclxuICAgICAgZm9jdXNlZCA9IHRydWU7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gZm9jdXNlZDtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6K6+572u54Sm54K5XHJcbiAgICogQHBhcmFtIHZlcmlmeUluZm9ybWF0aW9uIOmUmeivr+S/oeaBr1xyXG4gICAqIEBwYXJhbSBmcmFtZUNvbnRleHQg5LiK5LiL5paHXHJcbiAgICogQHJldHVybnMgXHJcbiAgICovXHJcbiAgcHVibGljIGZvY3VzKHZlcmlmeUluZm9ybWF0aW9uOiBhbnksIGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0KSB7XHJcbiAgICBpZiAoIXZlcmlmeUluZm9ybWF0aW9uKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGNvbnN0IGlzR3JpZFZhbGlkYXRpb24gPSB2ZXJpZnlJbmZvcm1hdGlvbi5pbmRleCAhPT0gbnVsbDtcclxuICAgIGlmIChpc0dyaWRWYWxpZGF0aW9uKSB7XHJcbiAgICAgIGNvbnN0IGdyaWQgPSB0aGlzLmdldEdyaWRSZWYoZnJhbWVDb250ZXh0KTtcclxuICAgICAgaWYgKGdyaWQpIHtcclxuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgIGdyaWQuZWRpdENlbGwodmVyaWZ5SW5mb3JtYXRpb24uaWQsIHZlcmlmeUluZm9ybWF0aW9uLnRhcmdldEZpZWxkKTtcclxuICAgICAgICB9LCAwKTtcclxuICAgICAgfVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgY29uc3QgZnJhbWVFbGVtZW50ID0gdGhpcy5nZXRDb21wb25lbnRSZWYoZnJhbWVDb250ZXh0KTtcclxuICAgICAgY29uc3QgZWxlbWVudElkID0gdmVyaWZ5SW5mb3JtYXRpb24udGFyZ2V0RmllbGQ7XHJcbiAgICAgIHRoaXMuZm9jdXNCeUlkKGVsZW1lbnRJZCwgZnJhbWVFbGVtZW50KTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOmAmui/h+aOp+S7tmlk6K6+572u54Sm54K5XHJcbiAgICogQHBhcmFtIGVsZW1lbnRJZCBcclxuICAgKiBAcGFyYW0gZWxlbWVudFJlZiBcclxuICAgKi9cclxuICBwcml2YXRlIGZvY3VzQnlJZChlbGVtZW50SWQ6IHN0cmluZywgZWxlbWVudFJlZj86IEVsZW1lbnRSZWYpIHtcclxuICAgIGNvbnN0IGRvY3VtZW50OiBhbnkgPSBlbGVtZW50UmVmICYmIGVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5vd25lckRvY3VtZW50IHx8IHdpbmRvdy5kb2N1bWVudDtcclxuICAgIGlmIChkb2N1bWVudCkge1xyXG4gICAgICBjb25zdCBlbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoZWxlbWVudElkKTtcclxuICAgICAgaWYgKGVsZW1lbnQudGFnTmFtZSAhPT0gJ0lOUFVUJykge1xyXG4gICAgICAgIGNvbnN0IHN1YkVsZW1lbnRzID0gZWxlbWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnaW5wdXQnKTtcclxuICAgICAgICBpZiAoc3ViRWxlbWVudHMubGVuZ3RoKSB7XHJcbiAgICAgICAgICBjb25zdCBpbnB1dCA9IHN1YkVsZW1lbnRzWzBdO1xyXG4gICAgICAgICAgaWYgKGlucHV0ICYmIHR5cGVvZiBpbnB1dC5mb2N1cyA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICAgICAgICBpbnB1dC5mb2N1cygpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBlbGVtZW50LmZvY3VzKCk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcbiAgLyoqXHJcbiAgICog6I635Y+W57uE5Lu25a6e5L6LXHJcbiAgICogQHBhcmFtIGZyYW1lQ29udGV4dCBcclxuICAgKiBAcmV0dXJucyBcclxuICAgKi9cclxuICBwcml2YXRlIGdldENvbXBvbmVudFJlZihmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCkge1xyXG4gICAgcmV0dXJuIHRoaXMuZnJhbWVDb250ZXh0ICYmIHRoaXMuZnJhbWVDb250ZXh0LmluamVjdG9yLmdldDxFbGVtZW50UmVmPihFbGVtZW50UmVmLCBudWxsKSB8fCBudWxsO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDojrflj5Zncmlk5a6e5L6LXHJcbiAgICogQHBhcmFtIGZyYW1lQ29udGV4dCBmcmFtZUNvbnRleHRcclxuICAgKiBAcmV0dXJucyBcclxuICAgKi9cclxuICBwcml2YXRlIGdldEdyaWRSZWYoZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQpOiBGb2N1c2FibGVJbnZhbGlkYXRpb25HcmlkIHtcclxuICAgIGNvbnN0IG5hbWVzcGFjZSA9IGZyYW1lQ29udGV4dC5uYW1lc3BhY2U7XHJcbiAgICBjb25zdCBiaW5kaW5nUGF0aCA9IGZyYW1lQ29udGV4dC52aWV3TW9kZWwuYmluZGluZ1BhdGg7XHJcbiAgICBjb25zdCBmcmFtZUNvbnRleHRzOiBGcmFtZUNvbnRleHRbXSA9IHRoaXMuZnJhbWVDb250ZXh0LmFwcENvbnRleHQuZnJhbWVDb250ZXh0TWFuYWdlci5nZXRGcmFtZUNvbnRleHRzQnlOYW1lc3BhY2UobmFtZXNwYWNlKSB8fCBbXTtcclxuICAgIGNvbnN0IG1hdGNoZWRGcmFtZUNvbnRleHRzID0gZnJhbWVDb250ZXh0cy5maWx0ZXIoKGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0KSA9PiBmcmFtZUNvbnRleHQudmlld01vZGVsICYmIGZyYW1lQ29udGV4dC52aWV3TW9kZWwuYmluZGluZ1BhdGguc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKS50b1N0cmluZygpID09PSBiaW5kaW5nUGF0aC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApLnRvU3RyaW5nKCkpO1xyXG4gICAgbGV0IHJlc3VsdCA9IG51bGw7XHJcbiAgICBpZiAobWF0Y2hlZEZyYW1lQ29udGV4dHMpIHtcclxuICAgICAgbWF0Y2hlZEZyYW1lQ29udGV4dHMuZXZlcnkoKGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0KSA9PiB7XHJcbiAgICAgICAgY29uc3QgZnJhbWVJZCA9IGZyYW1lQ29udGV4dC5mcmFtZUlkO1xyXG4gICAgICAgIGNvbnN0IGNvbXBvbmVudHNNYXAgPSB0aGlzLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0LmNvbXBvbmVudE1hbmFnZXIuZ2V0Q29tcG9uZW50c0J5RnJhbWVJZChmcmFtZUlkKTtcclxuICAgICAgICBpZiAoIWNvbXBvbmVudHNNYXApIHtcclxuICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBkYXRhZ3JpZENvbXBvbmVudCA9IEFycmF5LmZyb20oY29tcG9uZW50c01hcC52YWx1ZXMoKSkuZmluZCgoY29tcG9uZW50OiBhbnkpID0+IGNvbXBvbmVudCAmJiBjb21wb25lbnRbJ19fY29tcG9uZW50X3R5cGVfXyddID09PSAnRGF0YWdyaWRDb21wb25lbnQnKTtcclxuICAgICAgICBpZiAoZGF0YWdyaWRDb21wb25lbnQpIHtcclxuICAgICAgICAgIHJlc3VsdCA9IGRhdGFncmlkQ29tcG9uZW50O1xyXG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHJlc3VsdDtcclxuICB9XHJcbn1cclxuXHJcbmV4cG9ydCB7IEZvY3VzYWJsZUludmFsaWRhdGlvbkdyaWQsIEZvY3VzSW52YWxpZFNlcnZpY2UgfTtcclxuIl19