/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import DefaultOptions from './DefaultOptions';
import { DisplaySize } from './modules/DisplaySize';
import { Toolbar } from './modules/Toolbar';
import { Resize } from './modules/Resize';
import Quill from 'quill';
/** @type {?} */
const knownModules = { DisplaySize, Toolbar, Resize };
/**
 * Custom module for quilljs to allow user to resize <img> elements
 * (Works on Chrome, Edge, Safari and replaces Firefox's native resize behavior)
 * @see https://quilljs.com/blog/building-a-custom-module/
 */
export class ImageResize {
    /**
     * @param {?} quill
     * @param {?=} options
     */
    constructor(quill, options = {}) {
        this.initializeModules = (/**
         * @return {?}
         */
        () => {
            this.removeModules();
            this.modules = this.moduleClasses.map((/**
             * @param {?} ModuleClass
             * @return {?}
             */
            ModuleClass => new (knownModules[ModuleClass] || ModuleClass)(this)));
            this.modules.forEach((/**
             * @param {?} module
             * @return {?}
             */
            module => {
                module.onCreate();
            }));
            this.onUpdate();
        });
        this.onUpdate = (/**
         * @return {?}
         */
        () => {
            this.repositionElements();
            this.modules.forEach((/**
             * @param {?} module
             * @return {?}
             */
            module => {
                module.onUpdate();
            }));
        });
        this.removeModules = (/**
         * @return {?}
         */
        () => {
            this.modules.forEach((/**
             * @param {?} module
             * @return {?}
             */
            module => {
                module.onDestroy();
            }));
            this.modules = [];
        });
        this.handleClick = (/**
         * @param {?} evt
         * @return {?}
         */
        evt => {
            if (evt.target &&
                evt.target.tagName &&
                evt.target.tagName.toUpperCase() === 'IMG') {
                if (this.img === evt.target) {
                    // we are already focused on this image
                    return;
                }
                if (this.img) {
                    // we were just focused on another image
                    this.hide();
                }
                // clicked on an image inside the editor
                this.show(evt.target);
            }
            else if (this.img) {
                // clicked on a non image
                this.hide();
            }
        });
        this.show = (/**
         * @param {?} img
         * @return {?}
         */
        img => {
            // keep track of this img element
            this.img = img;
            this.showOverlay();
            this.initializeModules();
        });
        this.showOverlay = (/**
         * @return {?}
         */
        () => {
            if (this.overlay) {
                this.hideOverlay();
            }
            this.quill.setSelection(null);
            // prevent spurious text selection
            this.setUserSelect('none');
            // listen for the image being deleted or moved
            document.addEventListener('keyup', this.checkImage, true);
            this.quill.root.addEventListener('input', this.checkImage, true);
            // Create and add the overlay
            this.overlay = document.createElement('div');
            Object.assign(this.overlay.style, this.options.overlayStyles);
            this.quill.root.parentNode.appendChild(this.overlay);
            this.repositionElements();
        });
        this.hideOverlay = (/**
         * @return {?}
         */
        () => {
            if (!this.overlay) {
                return;
            }
            // Remove the overlay
            this.quill.root.parentNode.removeChild(this.overlay);
            this.overlay = undefined;
            // stop listening for image deletion or movement
            document.removeEventListener('keyup', this.checkImage);
            this.quill.root.removeEventListener('input', this.checkImage);
            // reset user-select
            this.setUserSelect('');
        });
        this.repositionElements = (/**
         * @return {?}
         */
        () => {
            if (!this.overlay || !this.img) {
                return;
            }
            // position the overlay over the image
            /** @type {?} */
            const parent = this.quill.root.parentNode;
            /** @type {?} */
            const imgRect = this.img.getBoundingClientRect();
            /** @type {?} */
            const containerRect = parent.getBoundingClientRect();
            Object.assign(this.overlay.style, {
                left: `${imgRect.left -
                    containerRect.left +
                    parent.scrollLeft -
                    2}px`,
                top: `${imgRect.top - containerRect.top + parent.scrollTop - 2}px`,
                width: `${imgRect.width + 2}px`,
                height: `${imgRect.height + 2}px`
            });
        });
        this.hide = (/**
         * @return {?}
         */
        () => {
            this.hideOverlay();
            this.removeModules();
            this.img = undefined;
        });
        this.setUserSelect = (/**
         * @param {?} value
         * @return {?}
         */
        value => {
            [
                'userSelect',
                'mozUserSelect',
                'webkitUserSelect',
                'msUserSelect'
            ].forEach((/**
             * @param {?} prop
             * @return {?}
             */
            prop => {
                // set on contenteditable element and <html>
                this.quill.root.style[prop] = value;
                document.documentElement.style[prop] = value;
            }));
        });
        this.checkImage = (/**
         * @param {?} evt
         * @return {?}
         */
        evt => {
            if (this.img) {
                if (evt.keyCode == 46 || evt.keyCode == 8) {
                    Quill.find(this.img).deleteAt(0);
                }
                this.hide();
            }
        });
        // save the quill reference and options
        this.quill = quill;
        // Apply the options to our defaults, and stash them for later
        // defaultsDeep doesn't do arrays as you'd expect, so we'll need to apply the classes array from options separately
        /** @type {?} */
        let moduleClasses = false;
        // tslint:disable-next-line:object-literal-key-quotes
        if (options['modules']) {
            moduleClasses = options['modules'].slice();
        }
        // Apply options to default options
        //this.options = defaultsDeep({}, options, DefaultOptions);
        this.options = Object.assign({}, options, DefaultOptions);
        // (see above about moduleClasses)
        if (moduleClasses !== false) {
            this.options.modules = moduleClasses;
        }
        // disable native image resizing on firefox
        document.execCommand('enableObjectResizing', false, 'false');
        // respond to clicks inside the editor
        this.quill.root.addEventListener('click', this.handleClick, false);
        this.quill.root.parentNode.style.position =
            this.quill.root.parentNode.style.position || 'relative';
        // setup modules
        this.moduleClasses = this.options.modules;
        //console.log('this.options.modules', this.options.modules)
        this.modules = [];
    }
}
if (false) {
    /** @type {?} */
    ImageResize.prototype.quill;
    /** @type {?} */
    ImageResize.prototype.options;
    /** @type {?} */
    ImageResize.prototype.moduleClasses;
    /** @type {?} */
    ImageResize.prototype.modules;
    /** @type {?} */
    ImageResize.prototype.img;
    /** @type {?} */
    ImageResize.prototype.overlay;
    /** @type {?} */
    ImageResize.prototype.initializeModules;
    /** @type {?} */
    ImageResize.prototype.onUpdate;
    /** @type {?} */
    ImageResize.prototype.removeModules;
    /** @type {?} */
    ImageResize.prototype.handleClick;
    /** @type {?} */
    ImageResize.prototype.show;
    /** @type {?} */
    ImageResize.prototype.showOverlay;
    /** @type {?} */
    ImageResize.prototype.hideOverlay;
    /** @type {?} */
    ImageResize.prototype.repositionElements;
    /** @type {?} */
    ImageResize.prototype.hide;
    /** @type {?} */
    ImageResize.prototype.setUserSelect;
    /** @type {?} */
    ImageResize.prototype.checkImage;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiSW1hZ2VSZXNpemUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL3VpLWh0bWwtZWRpdG9yLyIsInNvdXJjZXMiOlsibGliL2ltYWdlLXJlc2l6ZS1tb2R1bGUvSW1hZ2VSZXNpemUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUNBLE9BQU8sY0FBYyxNQUFNLGtCQUFrQixDQUFDO0FBQzlDLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUNwRCxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDNUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQzFDLE9BQU8sS0FBSyxNQUFNLE9BQU8sQ0FBQzs7TUFDcEIsWUFBWSxHQUFHLEVBQUUsV0FBVyxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUU7Ozs7OztBQU9yRCxNQUFNLE9BQU8sV0FBVzs7Ozs7SUFPcEIsWUFBWSxLQUFLLEVBQUUsT0FBTyxHQUFHLEVBQUU7UUFvQy9CLHNCQUFpQjs7O1FBQUcsR0FBRyxFQUFFO1lBQ3JCLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztZQUVyQixJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRzs7OztZQUNqQyxXQUFXLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDLElBQUksV0FBVyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQ3RFLENBQUM7WUFFRixJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU87Ozs7WUFBQyxNQUFNLENBQUMsRUFBRTtnQkFDMUIsTUFBTSxDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQ3RCLENBQUMsRUFBQyxDQUFDO1lBRUgsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ3BCLENBQUMsRUFBQztRQUVGLGFBQVE7OztRQUFHLEdBQUcsRUFBRTtZQUNaLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO1lBQzFC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b25zIGZyb20gJy4vRGVmYXVsdE9wdGlvbnMnO1xyXG5pbXBvcnQgeyBEaXNwbGF5U2l6ZSB9IGZyb20gJy4vbW9kdWxlcy9EaXNwbGF5U2l6ZSc7XHJcbmltcG9ydCB7IFRvb2xiYXIgfSBmcm9tICcuL21vZHVsZXMvVG9vbGJhcic7XHJcbmltcG9ydCB7IFJlc2l6ZSB9IGZyb20gJy4vbW9kdWxlcy9SZXNpemUnO1xyXG5pbXBvcnQgUXVpbGwgZnJvbSAncXVpbGwnO1xyXG5jb25zdCBrbm93bk1vZHVsZXMgPSB7IERpc3BsYXlTaXplLCBUb29sYmFyLCBSZXNpemUgfTtcclxuXHJcbi8qKlxyXG4gKiBDdXN0b20gbW9kdWxlIGZvciBxdWlsbGpzIHRvIGFsbG93IHVzZXIgdG8gcmVzaXplIDxpbWc+IGVsZW1lbnRzXHJcbiAqIChXb3JrcyBvbiBDaHJvbWUsIEVkZ2UsIFNhZmFyaSBhbmQgcmVwbGFjZXMgRmlyZWZveCdzIG5hdGl2ZSByZXNpemUgYmVoYXZpb3IpXHJcbiAqIEBzZWUgaHR0cHM6Ly9xdWlsbGpzLmNvbS9ibG9nL2J1aWxkaW5nLWEtY3VzdG9tLW1vZHVsZS9cclxuICovXHJcbmV4cG9ydCBjbGFzcyBJbWFnZVJlc2l6ZSB7XHJcbiAgICBxdWlsbDogYW55O1xyXG4gICAgb3B0aW9uczogYW55O1xyXG4gICAgbW9kdWxlQ2xhc3NlczogYW55O1xyXG4gICAgbW9kdWxlczogYW55O1xyXG4gICAgaW1nOiBhbnk7XHJcbiAgICBvdmVybGF5OiBhbnk7XHJcbiAgICBjb25zdHJ1Y3RvcihxdWlsbCwgb3B0aW9ucyA9IHt9KSB7XHJcbiAgICAgICAgLy8gc2F2ZSB0aGUgcXVpbGwgcmVmZXJlbmNlIGFuZCBvcHRpb25zXHJcbiAgICAgICAgdGhpcy5xdWlsbCA9IHF1aWxsO1xyXG4gICAgICAgIC8vIEFwcGx5IHRoZSBvcHRpb25zIHRvIG91ciBkZWZhdWx0cywgYW5kIHN0YXNoIHRoZW0gZm9yIGxhdGVyXHJcbiAgICAgICAgLy8gZGVmYXVsdHNEZWVwIGRvZXNuJ3QgZG8gYXJyYXlzIGFzIHlvdSdkIGV4cGVjdCwgc28gd2UnbGwgbmVlZCB0byBhcHBseSB0aGUgY2xhc3NlcyBhcnJheSBmcm9tIG9wdGlvbnMgc2VwYXJhdGVseVxyXG4gICAgICAgIGxldCBtb2R1bGVDbGFzc2VzID0gZmFsc2U7XHJcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm9iamVjdC1saXRlcmFsLWtleS1xdW90ZXNcclxuICAgICAgICBpZiAob3B0aW9uc1snbW9kdWxlcyddKSB7XHJcbiAgICAgICAgICAgIG1vZHVsZUNsYXNzZXMgPSBvcHRpb25zWydtb2R1bGVzJ10uc2xpY2UoKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIEFwcGx5IG9wdGlvbnMgdG8gZGVmYXVsdCBvcHRpb25zXHJcbiAgICAgICAgLy90aGlzLm9wdGlvbnMgPSBkZWZhdWx0c0RlZXAoe30sIG9wdGlvbnMsIERlZmF1bHRPcHRpb25zKTtcclxuICAgICAgICB0aGlzLm9wdGlvbnMgPU9iamVjdC5hc3NpZ24oe30sIG9wdGlvbnMsIERlZmF1bHRPcHRpb25zKTtcclxuXHJcbiAgICAgICAgLy8gKHNlZSBhYm92ZSBhYm91dCBtb2R1bGVDbGFzc2VzKVxyXG4gICAgICAgIGlmIChtb2R1bGVDbGFzc2VzICE9PSBmYWxzZSkge1xyXG4gICAgICAgICAgICB0aGlzLm9wdGlvbnMubW9kdWxlcyA9IG1vZHVsZUNsYXNzZXM7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBkaXNhYmxlIG5hdGl2ZSBpbWFnZSByZXNpemluZyBvbiBmaXJlZm94XHJcbiAgICAgICAgZG9jdW1lbnQuZXhlY0NvbW1hbmQoJ2VuYWJsZU9iamVjdFJlc2l6aW5nJywgZmFsc2UsICdmYWxzZScpO1xyXG5cclxuICAgICAgICAvLyByZXNwb25kIHRvIGNsaWNrcyBpbnNpZGUgdGhlIGVkaXRvclxyXG4gICAgICAgIHRoaXMucXVpbGwucm9vdC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIHRoaXMuaGFuZGxlQ2xpY2ssIGZhbHNlKTtcclxuXHJcbiAgICAgICAgdGhpcy5xdWlsbC5yb290LnBhcmVudE5vZGUuc3R5bGUucG9zaXRpb24gPVxyXG4gICAgICAgICAgICB0aGlzLnF1aWxsLnJvb3QucGFyZW50Tm9kZS5zdHlsZS5wb3NpdGlvbiB8fCAncmVsYXRpdmUnO1xyXG5cclxuICAgICAgICAvLyBzZXR1cCBtb2R1bGVzXHJcbiAgICAgICAgdGhpcy5tb2R1bGVDbGFzc2VzID0gdGhpcy5vcHRpb25zLm1vZHVsZXM7XHJcbiAgICAgICAgLy9jb25zb2xlLmxvZygndGhpcy5vcHRpb25zLm1vZHVsZXMnLCB0aGlzLm9wdGlvbnMubW9kdWxlcylcclxuXHJcbiAgICAgICAgdGhpcy5tb2R1bGVzID0gW107XHJcbiAgICB9XHJcblxyXG4gICAgaW5pdGlhbGl6ZU1vZHVsZXMgPSAoKSA9PiB7XHJcbiAgICAgICAgdGhpcy5yZW1vdmVNb2R1bGVzKCk7XHJcblxyXG4gICAgICAgIHRoaXMubW9kdWxlcyA9IHRoaXMubW9kdWxlQ2xhc3Nlcy5tYXAoXHJcbiAgICAgICAgICAgIE1vZHVsZUNsYXNzID0+IG5ldyAoa25vd25Nb2R1bGVzW01vZHVsZUNsYXNzXSB8fCBNb2R1bGVDbGFzcykodGhpcylcclxuICAgICAgICApO1xyXG5cclxuICAgICAgICB0aGlzLm1vZHVsZXMuZm9yRWFjaChtb2R1bGUgPT4ge1xyXG4gICAgICAgICAgICBtb2R1bGUub25DcmVhdGUoKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgdGhpcy5vblVwZGF0ZSgpO1xyXG4gICAgfTtcclxuXHJcbiAgICBvblVwZGF0ZSA9ICgpID0+IHtcclxuICAgICAgICB0aGlzLnJlcG9zaXRpb25FbGVtZW50cygpO1xyXG4gICAgICAgIHRoaXMubW9kdWxlcy5mb3JFYWNoKG1vZHVsZSA9PiB7XHJcbiAgICAgICAgICAgIG1vZHVsZS5vblVwZGF0ZSgpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuXHJcbiAgICByZW1vdmVNb2R1bGVzID0gKCkgPT4ge1xyXG4gICAgICAgIHRoaXMubW9kdWxlcy5mb3JFYWNoKG1vZHVsZSA9PiB7XHJcbiAgICAgICAgICAgIG1vZHVsZS5vbkRlc3Ryb3koKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgdGhpcy5tb2R1bGVzID0gW107XHJcbiAgICB9O1xyXG5cclxuICAgIGhhbmRsZUNsaWNrID0gZXZ0ID0+IHtcclxuICAgICAgICBpZiAoXHJcbiAgICAgICAgICAgIGV2dC50YXJnZXQgJiZcclxuICAgICAgICAgICAgZXZ0LnRhcmdldC50YWdOYW1lICYmXHJcbiAgICAgICAgICAgIGV2dC50YXJnZXQudGFnTmFtZS50b1VwcGVyQ2FzZSgpID09PSAnSU1HJ1xyXG4gICAgICAgICkge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5pbWcgPT09IGV2dC50YXJnZXQpIHtcclxuICAgICAgICAgICAgICAgIC8vIHdlIGFyZSBhbHJlYWR5IGZvY3VzZWQgb24gdGhpcyBpbWFnZVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmltZykge1xyXG4gICAgICAgICAgICAgICAgLy8gd2Ugd2VyZSBqdXN0IGZvY3VzZWQgb24gYW5vdGhlciBpbWFnZVxyXG4gICAgICAgICAgICAgICAgdGhpcy5oaWRlKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgLy8gY2xpY2tlZCBvbiBhbiBpbWFnZSBpbnNpZGUgdGhlIGVkaXRvclxyXG4gICAgICAgICAgICB0aGlzLnNob3coZXZ0LnRhcmdldCk7XHJcbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLmltZykge1xyXG4gICAgICAgICAgICAvLyBjbGlja2VkIG9uIGEgbm9uIGltYWdlXHJcbiAgICAgICAgICAgIHRoaXMuaGlkZSgpO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBzaG93ID0gaW1nID0+IHtcclxuICAgICAgICAvLyBrZWVwIHRyYWNrIG9mIHRoaXMgaW1nIGVsZW1lbnRcclxuICAgICAgICB0aGlzLmltZyA9IGltZztcclxuXHJcbiAgICAgICAgdGhpcy5zaG93T3ZlcmxheSgpO1xyXG5cclxuICAgICAgICB0aGlzLmluaXRpYWxpemVNb2R1bGVzKCk7XHJcbiAgICB9O1xyXG5cclxuICAgIHNob3dPdmVybGF5ID0gKCkgPT4ge1xyXG4gICAgICAgIGlmICh0aGlzLm92ZXJsYXkpIHtcclxuICAgICAgICAgICAgdGhpcy5oaWRlT3ZlcmxheSgpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5xdWlsbC5zZXRTZWxlY3Rpb24obnVsbCk7XHJcblxyXG4gICAgICAgIC8vIHByZXZlbnQgc3B1cmlvdXMgdGV4dCBzZWxlY3Rpb25cclxuICAgICAgICB0aGlzLnNldFVzZXJTZWxlY3QoJ25vbmUnKTtcclxuXHJcbiAgICAgICAgLy8gbGlzdGVuIGZvciB0aGUgaW1hZ2UgYmVpbmcgZGVsZXRlZCBvciBtb3ZlZFxyXG4gICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2tleXVwJywgdGhpcy5jaGVja0ltYWdlLCB0cnVlKTtcclxuICAgICAgICB0aGlzLnF1aWxsLnJvb3QuYWRkRXZlbnRMaXN0ZW5lcignaW5wdXQnLCB0aGlzLmNoZWNrSW1hZ2UsIHRydWUpO1xyXG5cclxuICAgICAgICAvLyBDcmVhdGUgYW5kIGFkZCB0aGUgb3ZlcmxheVxyXG4gICAgICAgIHRoaXMub3ZlcmxheSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xyXG4gICAgICAgIE9iamVjdC5hc3NpZ24odGhpcy5vdmVybGF5LnN0eWxlLCB0aGlzLm9wdGlvbnMub3ZlcmxheVN0eWxlcyk7XHJcblxyXG4gICAgICAgIHRoaXMucXVpbGwucm9vdC5wYXJlbnROb2RlLmFwcGVuZENoaWxkKHRoaXMub3ZlcmxheSk7XHJcblxyXG4gICAgICAgIHRoaXMucmVwb3NpdGlvbkVsZW1lbnRzKCk7XHJcbiAgICB9O1xyXG5cclxuICAgIGhpZGVPdmVybGF5ID0gKCkgPT4ge1xyXG4gICAgICAgIGlmICghdGhpcy5vdmVybGF5KSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIFJlbW92ZSB0aGUgb3ZlcmxheVxyXG4gICAgICAgIHRoaXMucXVpbGwucm9vdC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHRoaXMub3ZlcmxheSk7XHJcbiAgICAgICAgdGhpcy5vdmVybGF5ID0gdW5kZWZpbmVkO1xyXG5cclxuICAgICAgICAvLyBzdG9wIGxpc3RlbmluZyBmb3IgaW1hZ2UgZGVsZXRpb24gb3IgbW92ZW1lbnRcclxuICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdrZXl1cCcsIHRoaXMuY2hlY2tJbWFnZSk7XHJcbiAgICAgICAgdGhpcy5xdWlsbC5yb290LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2lucHV0JywgdGhpcy5jaGVja0ltYWdlKTtcclxuXHJcbiAgICAgICAgLy8gcmVzZXQgdXNlci1zZWxlY3RcclxuICAgICAgICB0aGlzLnNldFVzZXJTZWxlY3QoJycpO1xyXG4gICAgfTtcclxuXHJcbiAgICByZXBvc2l0aW9uRWxlbWVudHMgPSAoKSA9PiB7XHJcbiAgICAgICAgaWYgKCF0aGlzLm92ZXJsYXkgfHwgIXRoaXMuaW1nKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIHBvc2l0aW9uIHRoZSBvdmVybGF5IG92ZXIgdGhlIGltYWdlXHJcbiAgICAgICAgY29uc3QgcGFyZW50ID0gdGhpcy5xdWlsbC5yb290LnBhcmVudE5vZGU7XHJcbiAgICAgICAgY29uc3QgaW1nUmVjdCA9IHRoaXMuaW1nLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xyXG4gICAgICAgIGNvbnN0IGNvbnRhaW5lclJlY3QgPSBwYXJlbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XHJcblxyXG4gICAgICAgIE9iamVjdC5hc3NpZ24odGhpcy5vdmVybGF5LnN0eWxlLCB7XHJcbiAgICAgICAgICAgIGxlZnQ6IGAke2ltZ1JlY3QubGVmdCAtXHJcbiAgICAgICAgICAgICAgICBjb250YWluZXJSZWN0LmxlZnQgK1xyXG4gICAgICAgICAgICAgICAgcGFyZW50LnNjcm9sbExlZnQgLVxyXG4gICAgICAgICAgICAgICAgMn1weGAsXHJcbiAgICAgICAgICAgIHRvcDogYCR7aW1nUmVjdC50b3AgLSBjb250YWluZXJSZWN0LnRvcCArIHBhcmVudC5zY3JvbGxUb3AgLSAyfXB4YCxcclxuICAgICAgICAgICAgd2lkdGg6IGAke2ltZ1JlY3Qud2lkdGggKyAyfXB4YCxcclxuICAgICAgICAgICAgaGVpZ2h0OiBgJHtpbWdSZWN0LmhlaWdodCArIDJ9cHhgXHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG5cclxuICAgIGhpZGUgPSAoKSA9PiB7XHJcbiAgICAgICAgdGhpcy5oaWRlT3ZlcmxheSgpO1xyXG4gICAgICAgIHRoaXMucmVtb3ZlTW9kdWxlcygpO1xyXG4gICAgICAgIHRoaXMuaW1nID0gdW5kZWZpbmVkO1xyXG4gICAgfTtcclxuXHJcbiAgICBzZXRVc2VyU2VsZWN0ID0gdmFsdWUgPT4ge1xyXG4gICAgICAgIFtcclxuICAgICAgICAgICAgJ3VzZXJTZWxlY3QnLFxyXG4gICAgICAgICAgICAnbW96VXNlclNlbGVjdCcsXHJcbiAgICAgICAgICAgICd3ZWJraXRVc2VyU2VsZWN0JyxcclxuICAgICAgICAgICAgJ21zVXNlclNlbGVjdCdcclxuICAgICAgICBdLmZvckVhY2gocHJvcCA9PiB7XHJcbiAgICAgICAgICAgIC8vIHNldCBvbiBjb250ZW50ZWRpdGFibGUgZWxlbWVudCBhbmQgPGh0bWw+XHJcbiAgICAgICAgICAgIHRoaXMucXVpbGwucm9vdC5zdHlsZVtwcm9wXSA9IHZhbHVlO1xyXG4gICAgICAgICAgICBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc3R5bGVbcHJvcF0gPSB2YWx1ZTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcblxyXG4gICAgY2hlY2tJbWFnZSA9IGV2dCA9PiB7XHJcbiAgICAgICAgaWYgKHRoaXMuaW1nKSB7XHJcbiAgICAgICAgICAgIGlmIChldnQua2V5Q29kZSA9PSA0NiB8fCBldnQua2V5Q29kZSA9PSA4KSB7XHJcbiAgICAgICAgICAgICAgICBRdWlsbC5maW5kKHRoaXMuaW1nKS5kZWxldGVBdCgwKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLmhpZGUoKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG59XHJcbi8vY29uc29sZS5sb2coSW1hZ2VSZXNpemUpXHJcbi8vIGlmIChRdWlsbCkge1xyXG4vLyAgICAgUXVpbGwucmVnaXN0ZXIoJ21vZHVsZXMvaW1hZ2VSZXNpemUnLCBJbWFnZVJlc2l6ZSlcclxuLy8gfVxyXG4iXX0=