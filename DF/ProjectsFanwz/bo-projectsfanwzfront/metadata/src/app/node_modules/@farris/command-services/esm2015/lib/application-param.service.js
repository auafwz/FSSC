import { take } from 'rxjs/operators';
import { Injectable, Optional } from '@angular/core';
import { ParamService } from './param.service';
import { RuntimeFrameworkService } from './rtf-service';
import { isObservable } from 'rxjs';
/**
 * 应用参数服务
 * @scope FormModule
 */
export class ApplicationParamService {
    constructor(paramService, runtimeFrameworkService) {
        this.paramService = paramService;
        this.runtimeFrameworkService = runtimeFrameworkService;
        if (!this.runtimeFrameworkService) {
            this.runtimeFrameworkService = new RuntimeFrameworkService();
        }
    }
    /**
     * 解析参数
     */
    parseParams(route, frameworkService, viewModel, callback) {
        const highOrderInvoke = this.highOrderInvoke(callback);
        if (!this.paramService) {
            route.queryParams.pipe(take(1)).subscribe((params) => {
                this.setupParams(params, frameworkService, viewModel, highOrderInvoke);
            });
        }
        else {
            this.paramService.parse().pipe(take(1)).subscribe(params => {
                this.setupParams(params, frameworkService, viewModel, highOrderInvoke);
            });
        }
    }
    /**
     * 设置参数
     */
    setupParams(params, frameworkService, viewModel, callback) {
        const queryParams = this.getParams(params);
        if (!queryParams) {
            callback();
            return;
        }
        // 先设置参数，保证普通路由也能正常执行。
        this.setQueryParams(queryParams, viewModel);
        const funcId = this.getFuncId(queryParams);
        const appId = this.getAppId(queryParams);
        if (!funcId && !appId) {
            callback();
            return;
        }
        if (funcId) {
            this.setStaticParams(funcId, queryParams, frameworkService, viewModel, callback);
        }
        else {
            callback();
        }
    }
    /**
     * 设置查询参数
     */
    setQueryParams(queryParams, viewModel) {
        const parsedQueryParams = {};
        // 设置表单参数
        // 首先判断是否为弹窗
        const isInDialog = this.isInDialog(viewModel);
        const uiState = viewModel && viewModel.uiState && viewModel.uiState.innerData || {};
        // 如果是弹窗，弹窗外的参数（无论表单参数或静态参数）不应该覆盖弹窗的参数。弹窗打开时传递的参数相当于局部变量，不应被覆盖
        Object.keys(queryParams).forEach((paramName) => {
            if (!isInDialog) {
                parsedQueryParams[paramName] = queryParams[paramName];
            }
            else {
                if (!uiState.hasOwnProperty(paramName)) {
                    parsedQueryParams[paramName] = queryParams[paramName];
                }
            }
        });
        this.updateUIState(viewModel, parsedQueryParams);
    }
    /**
     * 设置静态参数
     */
    setStaticParams(funcId, queryParams, frameworkService, viewModel, callback) {
        this.runtimeFrameworkService.getMenuParams(funcId, (staicParams) => {
            const staticParamsObj = this.mapStaticParamsToObject(staicParams, queryParams, viewModel);
            if (!staticParamsObj) {
                callback();
                return;
            }
            this.updateUIState(viewModel, staticParamsObj);
            callback();
        });
    }
    /**
     * 将staticParams转换为普通对象
     * @param staticParams，形如：[{'name': 'key1', 'value': 'val1'}, {'name': 'key2', 'value': 'val2'}]
     * @return 形如：{key1: val1, key2: value2 }
     */
    mapStaticParamsToObject(staticParams, queryParams, viewModel) {
        if (!staticParams) {
            return;
        }
        const inDialog = this.isInDialog(viewModel);
        const uiState = viewModel && viewModel.uiState && viewModel.uiState.innerData || {};
        const result = {};
        staticParams.forEach((value, key, map) => {
            if (!inDialog) {
                // 静态参数不能覆盖查询参数
                if (!queryParams.hasOwnProperty(key)) {
                    result[key] = value;
                }
            }
            else {
                if (!queryParams.hasOwnProperty(key) && !uiState.hasOwnProperty(key)) {
                    result[key] = value;
                }
            }
        });
        return result;
    }
    /**
     * 是否在弹窗内
     * @param viewModel viewmodel
     */
    isInDialog(viewModel) {
        let isInDialog = false;
        if (viewModel && viewModel.uiState) {
            // tslint:disable-next-line: max-line-length
            if (viewModel.uiState.innerData && viewModel.uiState.innerData.hasOwnProperty('DEVKIT_DIALOG') || viewModel.uiState['DEVKIT_DIALOG']) {
                isInDialog = true;
            }
        }
        return isInDialog;
    }
    /**
     * 更新UIState
     */
    updateUIState(viewModel, params) {
        if (!viewModel || !params) {
            return;
        }
        const uiState = viewModel.uiState;
        // 兼容使用string传递params对象的场景
        if (typeof params === 'string' && params !== '') {
            params = JSON.parse(params);
        }
        // 在UIState为参数创建属性
        Object.keys(params).forEach((propName) => {
            uiState.setPropertyValue(propName, params[propName]);
            if (propName && propName === 'union_session') {
                let sessionInfo = params[propName];
                this.setSessionInfo(viewModel, sessionInfo);
            }
        });
    }
    setSessionInfo(viewModel, sessionInfo) {
        if (!viewModel || !sessionInfo) {
            return;
        }
        if (sessionInfo && typeof sessionInfo === 'string' && sessionInfo.startsWith('{') && sessionInfo.endsWith('}')) {
            sessionInfo = JSON.parse(sessionInfo);
        }
        const token = sessionInfo && sessionInfo.token || null;
        const sessionId = sessionInfo && sessionInfo.sessionId || null;
        if (token) {
            viewModel.frameContext.appContext.Token = token;
        }
        if (sessionId) {
            const befRepository = viewModel.frameContext.repository;
            if (befRepository) {
                befRepository.restService.sessionService.setBeSessionId(sessionId);
            }
        }
    }
    /**
     * 获取功能菜单id
     */
    getFuncId(queryParams) {
        if (!queryParams) {
            return;
        }
        return queryParams['funcId'];
    }
    /**
     * 获取应用id
     */
    getAppId(queryParams) {
        if (!queryParams) {
            return;
        }
        return queryParams['appId'];
    }
    /**
     * 获取url参数对象
     * @param queryParams url参数
     */
    getParams(queryParams) {
        if (!queryParams) {
            return {};
        }
        let result = {};
        if (queryParams.hasOwnProperty('WEB_FORM_ROUTE_PARAMS')) {
            let webFormRouteParams = queryParams['WEB_FORM_ROUTE_PARAMS'];
            if (webFormRouteParams && webFormRouteParams.startsWith('{') && webFormRouteParams.endsWith('}')) {
                webFormRouteParams = decodeURI(encodeURI(webFormRouteParams).replace(/%0A/g, '\\n').replace(/%09/g, '\\t').replace(/%0D/g, '\\r'));
                result = JSON.parse(webFormRouteParams);
            }
            Object.keys(queryParams).forEach(prop => {
                if (prop !== 'WEB_FORM_ROUTE_PARAMS') {
                    result[prop] = queryParams[prop];
                }
            });
            return result;
        }
        return queryParams;
    }
    highOrderInvoke(callback) {
        return () => {
            try {
                const controlEvent = this.runtimeFrameworkService.getMenuSwitchControlEvent();
                if (controlEvent && isObservable(controlEvent)) {
                    controlEvent.subscribe((event) => {
                        if (event) {
                            event.next('ok');
                        }
                    });
                }
            }
            catch (e) {
                console.warn(e);
            }
            if (callback && typeof callback === 'function') {
                callback();
            }
        };
    }
}
ApplicationParamService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
ApplicationParamService.ctorParameters = () => [
    { type: ParamService, decorators: [{ type: Optional }] },
    { type: RuntimeFrameworkService, decorators: [{ type: Optional }] }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwbGljYXRpb24tcGFyYW0uc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy8iLCJzb3VyY2VzIjpbImxpYi9hcHBsaWNhdGlvbi1wYXJhbS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUd0QyxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNyRCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDL0MsT0FBTyxFQUFFLHVCQUF1QixFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRXhELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFcEM7OztHQUdHO0FBR0gsTUFBTSxPQUFPLHVCQUF1QjtJQUNsQyxZQUNzQixZQUEwQixFQUMxQix1QkFBZ0Q7UUFEaEQsaUJBQVksR0FBWixZQUFZLENBQWM7UUFDMUIsNEJBQXVCLEdBQXZCLHVCQUF1QixDQUF5QjtRQUVwRSxJQUFJLENBQUMsSUFBSSxDQUFDLHVCQUF1QixFQUFFO1lBQ2pDLElBQUksQ0FBQyx1QkFBdUIsR0FBRyxJQUFJLHVCQUF1QixFQUFFLENBQUM7U0FDOUQ7SUFDSCxDQUFDO0lBQ0Q7O09BRUc7SUFDSSxXQUFXLENBQUMsS0FBcUIsRUFBRSxnQkFBa0MsRUFBRSxTQUFvQixFQUFFLFFBQW9CO1FBQ3RILE1BQU0sZUFBZSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDdkQsSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUU7WUFDdEIsS0FBSyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsTUFBVyxFQUFFLEVBQUU7Z0JBQ3hELElBQUksQ0FBQyxXQUFXLENBQUMsTUFB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Q0FBQyxDQUFDO3lCQUNsQjtvQkFDSCxDQUFDLENBQUMsQ0FBQztpQkFDSjthQUNGO1lBQUMsT0FBTyxDQUFDLEVBQUU7Z0JBQUUsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQzthQUFDO1lBQy9CLElBQUksUUFBUSxJQUFJLE9BQU8sUUFBUSxLQUFLLFVBQVUsRUFBRTtnQkFDOUMsUUFBUSxFQUFFLENBQUM7YUFDWjtRQUNILENBQUMsQ0FBQTtJQUNILENBQUM7OztZQXhPRixVQUFVOzs7O1lBVkYsWUFBWSx1QkFhaEIsUUFBUTtZQVpKLHVCQUF1Qix1QkFhM0IsUUFBUSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFjdGl2YXRlZFJvdXRlLCBQYXJhbU1hcCB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XHJcbmltcG9ydCB7IHRha2UgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IEZyYW1ld29ya1NlcnZpY2UgfSBmcm9tICdAZ3NwLXN5cy9ydGYtY29tbW9uJztcclxuaW1wb3J0IHsgVmlld01vZGVsIH0gZnJvbSAnQGZhcnJpcy9kZXZraXQnO1xyXG5pbXBvcnQgeyBJbmplY3RhYmxlLCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBQYXJhbVNlcnZpY2UgfSBmcm9tICcuL3BhcmFtLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBSdW50aW1lRnJhbWV3b3JrU2VydmljZSB9IGZyb20gJy4vcnRmLXNlcnZpY2UnO1xyXG5pbXBvcnQgeyBCZWZSZXBvc2l0b3J5IH0gZnJvbSAnQGZhcnJpcy9iZWYnO1xyXG5pbXBvcnQgeyBpc09ic2VydmFibGUgfSBmcm9tICdyeGpzJztcclxuXHJcbi8qKlxyXG4gKiDlupTnlKjlj4LmlbDmnI3liqFcclxuICogQHNjb3BlIEZvcm1Nb2R1bGVcclxuICovXHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBBcHBsaWNhdGlvblBhcmFtU2VydmljZSB7XHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIHBhcmFtU2VydmljZTogUGFyYW1TZXJ2aWNlLFxyXG4gICAgQE9wdGlvbmFsKCkgcHJpdmF0ZSBydW50aW1lRnJhbWV3b3JrU2VydmljZTogUnVudGltZUZyYW1ld29ya1NlcnZpY2UsXHJcbiAgKSB7XHJcbiAgICBpZiAoIXRoaXMucnVudGltZUZyYW1ld29ya1NlcnZpY2UpIHtcclxuICAgICAgdGhpcy5ydW50aW1lRnJhbWV3b3JrU2VydmljZSA9IG5ldyBSdW50aW1lRnJhbWV3b3JrU2VydmljZSgpO1xyXG4gICAgfVxyXG4gIH1cclxuICAvKipcclxuICAgKiDop6PmnpDlj4LmlbBcclxuICAgKi9cclxuICBwdWJsaWMgcGFyc2VQYXJhbXMocm91dGU6IEFjdGl2YXRlZFJvdXRlLCBmcmFtZXdvcmtTZXJ2aWNlOiBGcmFtZXdvcmtTZXJ2aWNlLCB2aWV3TW9kZWw6IFZpZXdNb2RlbCwgY2FsbGJhY2s6ICgpID0+IHZvaWQpIHtcclxuICAgIGNvbnN0IGhpZ2hPcmRlckludm9rZSA9IHRoaXMuaGlnaE9yZGVySW52b2tlKGNhbGxiYWNrKTtcclxuICAgIGlmICghdGhpcy5wYXJhbVNlcnZpY2UpIHtcclxuICAgICAgcm91dGUucXVlcnlQYXJhbXMucGlwZSh0YWtlKDEpKS5zdWJzY3JpYmUoKHBhcmFtczogYW55KSA9PiB7XHJcbiAgICAgICAgdGhpcy5zZXR1cFBhcmFtcyhwYXJhbXMsIGZyYW1ld29ya1NlcnZpY2UsIHZpZXdNb2RlbCwgaGlnaE9yZGVySW52b2tlKTtcclxuICAgICAgfSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLnBhcmFtU2VydmljZS5wYXJzZSgpLnBpcGUodGFrZSgxKSkuc3Vic2NyaWJlKHBhcmFtcyA9PiB7XHJcbiAgICAgICAgdGhpcy5zZXR1cFBhcmFtcyhwYXJhbXMsIGZyYW1ld29ya1NlcnZpY2UsIHZpZXdNb2RlbCwgaGlnaE9yZGVySW52b2tlKTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDorr7nva7lj4LmlbBcclxuICAgKi9cclxuICBwcml2YXRlIHNldHVwUGFyYW1zKHBhcmFtcywgZnJhbWV3b3JrU2VydmljZTogRnJhbWV3b3JrU2VydmljZSwgdmlld01vZGVsOiBWaWV3TW9kZWwsIGNhbGxiYWNrOiAoKSA9PiB2b2lkKSB7XHJcbiAgICBjb25zdCBxdWVyeVBhcmFtcyA9IHRoaXMuZ2V0UGFyYW1zKHBhcmFtcyk7XHJcbiAgICBpZiAoIXF1ZXJ5UGFyYW1zKSB7XHJcbiAgICAgIGNhbGxiYWNrKCk7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICAvLyDlhYjorr7nva7lj4LmlbDvvIzkv53or4Hmma7pgJrot6/nlLHkuZ/og73mraPluLjmiafooYzjgIJcclxuICAgIHRoaXMuc2V0UXVlcnlQYXJhbXMocXVlcnlQYXJhbXMsIHZpZXdNb2RlbCk7XHJcblxyXG4gICAgY29uc3QgZnVuY0lkID0gdGhpcy5nZXRGdW5jSWQocXVlcnlQYXJhbXMpO1xyXG4gICAgY29uc3QgYXBwSWQgPSB0aGlzLmdldEFwcElkKHF1ZXJ5UGFyYW1zKTtcclxuICAgIGlmICghZnVuY0lkICYmICFhcHBJZCkge1xyXG4gICAgICBjYWxsYmFjaygpO1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGZ1bmNJZCkge1xyXG4gICAgICB0aGlzLnNldFN0YXRpY1BhcmFtcyhmdW5jSWQsIHF1ZXJ5UGFyYW1zLCBmcmFtZXdvcmtTZXJ2aWNlLCB2aWV3TW9kZWwsIGNhbGxiYWNrKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGNhbGxiYWNrKCk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiuvue9ruafpeivouWPguaVsFxyXG4gICAqL1xyXG4gIHByaXZhdGUgc2V0UXVlcnlQYXJhbXMocXVlcnlQYXJhbXM6IGFueSwgdmlld01vZGVsOiBWaWV3TW9kZWwpOiBhbnkge1xyXG4gICAgY29uc3QgcGFyc2VkUXVlcnlQYXJhbXMgPSB7fTtcclxuICAgIC8vIOiuvue9ruihqOWNleWPguaVsFxyXG4gICAgLy8g6aaW5YWI5Yik5pat5piv5ZCm5Li65by556qXXHJcbiAgICBjb25zdCBpc0luRGlhbG9nID0gdGhpcy5pc0luRGlhbG9nKHZpZXdNb2RlbCk7XHJcbiAgICBjb25zdCB1aVN0YXRlID0gdmlld01vZGVsICYmIHZpZXdNb2RlbC51aVN0YXRlICYmIHZpZXdNb2RlbC51aVN0YXRlLmlubmVyRGF0YSB8fCB7fTtcclxuICAgIC8vIOWmguaenOaYr+W8ueeql++8jOW8ueeql+WklueahOWPguaVsO+8iOaXoOiuuuihqOWNleWPguaVsOaIlumdmeaAgeWPguaVsO+8ieS4jeW6lOivpeimhuebluW8ueeql+eahOWPguaVsOOAguW8ueeql+aJk+W8gOaXtuS8oOmAkueahOWPguaVsOebuOW9k+S6juWxgOmDqOWPmOmHj++8jOS4jeW6lOiiq+imhuebllxyXG4gICAgT2JqZWN0LmtleXMocXVlcnlQYXJhbXMpLmZvckVhY2goKHBhcmFtTmFtZTogc3RyaW5nKSA9PiB7XHJcbiAgICAgIGlmICghaXNJbkRpYWxvZykge1xyXG4gICAgICAgIHBhcnNlZFF1ZXJ5UGFyYW1zW3BhcmFtTmFtZV0gPSBxdWVyeVBhcmFtc1twYXJhbU5hbWVdO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGlmICghdWlTdGF0ZS5oYXNPd25Qcm9wZXJ0eShwYXJhbU5hbWUpKSB7XHJcbiAgICAgICAgICBwYXJzZWRRdWVyeVBhcmFtc1twYXJhbU5hbWVdID0gcXVlcnlQYXJhbXNbcGFyYW1OYW1lXTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgdGhpcy51cGRhdGVVSVN0YXRlKHZpZXdNb2RlbCwgcGFyc2VkUXVlcnlQYXJhbXMpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6K6+572u6Z2Z5oCB5Y+C5pWwXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBzZXRTdGF0aWNQYXJhbXMoXHJcbiAgICBmdW5jSWQ6IHN0cmluZywgcXVlcnlQYXJhbXM6IGFueSwgZnJhbWV3b3JrU2VydmljZTogRnJhbWV3b3JrU2VydmljZSwgdmlld01vZGVsOiBWaWV3TW9kZWwsIGNhbGxiYWNrOiAoKSA9PiB2b2lkXHJcbiAgKSB7XHJcbiAgICB0aGlzLnJ1bnRpbWVGcmFtZXdvcmtTZXJ2aWNlLmdldE1lbnVQYXJhbXMoZnVuY0lkLCAoc3RhaWNQYXJhbXMpID0+IHtcclxuICAgICAgY29uc3Qgc3RhdGljUGFyYW1zT2JqID0gdGhpcy5tYXBTdGF0aWNQYXJhbXNUb09iamVjdChzdGFpY1BhcmFtcywgcXVlcnlQYXJhbXMsIHZpZXdNb2RlbCk7XHJcbiAgICAgIGlmICghc3RhdGljUGFyYW1zT2JqKSB7XHJcbiAgICAgICAgY2FsbGJhY2soKTtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuICAgICAgdGhpcy51cGRhdGVVSVN0YXRlKHZpZXdNb2RlbCwgc3RhdGljUGFyYW1zT2JqKTtcclxuICAgICAgY2FsbGJhY2soKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5bCGc3RhdGljUGFyYW1z6L2s5o2i5Li65pmu6YCa5a+56LGhXHJcbiAgICogQHBhcmFtIHN0YXRpY1BhcmFtc++8jOW9ouWmgu+8mlt7J25hbWUnOiAna2V5MScsICd2YWx1ZSc6ICd2YWwxJ30sIHsnbmFtZSc6ICdrZXkyJywgJ3ZhbHVlJzogJ3ZhbDInfV1cclxuICAgKiBAcmV0dXJuIOW9ouWmgu+8mntrZXkxOiB2YWwxLCBrZXkyOiB2YWx1ZTIgfVxyXG4gICAqL1xyXG4gIHByaXZhdGUgbWFwU3RhdGljUGFyYW1zVG9PYmplY3Qoc3RhdGljUGFyYW1zOiBNYXA8YW55LCBhbnk+LCBxdWVyeVBhcmFtczogYW55LCB2aWV3TW9kZWw/OiBWaWV3TW9kZWwpOiBhbnkge1xyXG4gICAgaWYgKCFzdGF0aWNQYXJhbXMpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgY29uc3QgaW5EaWFsb2cgPSB0aGlzLmlzSW5EaWFsb2codmlld01vZGVsKTtcclxuICAgIGNvbnN0IHVpU3RhdGUgPSB2aWV3TW9kZWwgJiYgdmlld01vZGVsLnVpU3RhdGUgJiYgdmlld01vZGVsLnVpU3RhdGUuaW5uZXJEYXRhIHx8IHt9O1xyXG4gICAgY29uc3QgcmVzdWx0ID0ge307XHJcbiAgICBzdGF0aWNQYXJhbXMuZm9yRWFjaCgodmFsdWUsIGtleSwgbWFwKSA9PiB7XHJcbiAgICAgIGlmICghaW5EaWFsb2cpIHtcclxuICAgICAgICAvLyDpnZnmgIHlj4LmlbDkuI3og73opobnm5bmn6Xor6Llj4LmlbBcclxuICAgICAgICBpZiAoIXF1ZXJ5UGFyYW1zLmhhc093blByb3BlcnR5KGtleSkpIHtcclxuICAgICAgICAgIHJlc3VsdFtrZXldID0gdmFsdWU7XHJcbiAgICAgICAgfVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGlmICghcXVlcnlQYXJhbXMuaGFzT3duUHJvcGVydHkoa2V5KSAmJiAhdWlTdGF0ZS5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7XHJcbiAgICAgICAgICByZXN1bHRba2V5XSA9IHZhbHVlO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gcmVzdWx0O1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmmK/lkKblnKjlvLnnqpflhoVcclxuICAgKiBAcGFyYW0gdmlld01vZGVsIHZpZXdtb2RlbFxyXG4gICAqL1xyXG4gIHByaXZhdGUgaXNJbkRpYWxvZyh2aWV3TW9kZWw6IFZpZXdNb2RlbCkge1xyXG4gICAgbGV0IGlzSW5EaWFsb2cgPSBmYWxzZTtcclxuICAgIGlmICh2aWV3TW9kZWwgJiYgdmlld01vZGVsLnVpU3RhdGUpIHtcclxuICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBtYXgtbGluZS1sZW5ndGhcclxuICAgICAgaWYgKHZpZXdNb2RlbC51aVN0YXRlLmlubmVyRGF0YSAmJiB2aWV3TW9kZWwudWlTdGF0ZS5pbm5lckRhdGEuaGFzT3duUHJvcGVydHkoJ0RFVktJVF9ESUFMT0cnKSB8fCB2aWV3TW9kZWwudWlTdGF0ZVsnREVWS0lUX0RJQUxPRyddKSB7XHJcbiAgICAgICAgaXNJbkRpYWxvZyA9IHRydWU7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBpc0luRGlhbG9nO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmm7TmlrBVSVN0YXRlXHJcbiAgICovXHJcbiAgcHJpdmF0ZSB1cGRhdGVVSVN0YXRlKHZpZXdNb2RlbDogVmlld01vZGVsLCBwYXJhbXM6IGFueSkge1xyXG4gICAgaWYgKCF2aWV3TW9kZWwgfHwgIXBhcmFtcykge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBjb25zdCB1aVN0YXRlID0gdmlld01vZGVsLnVpU3RhdGU7XHJcblxyXG4gICAgLy8g5YW85a655L2/55Soc3RyaW5n5Lyg6YCScGFyYW1z5a+56LGh55qE5Zy65pmvXHJcbiAgICBpZiAodHlwZW9mIHBhcmFtcyA9PT0gJ3N0cmluZycgJiYgcGFyYW1zICE9PSAnJykge1xyXG4gICAgICBwYXJhbXMgPSBKU09OLnBhcnNlKHBhcmFtcyk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8g5ZyoVUlTdGF0ZeS4uuWPguaVsOWIm+W7uuWxnuaAp1xyXG4gICAgT2JqZWN0LmtleXMocGFyYW1zKS5mb3JFYWNoKChwcm9wTmFtZTogc3RyaW5nKSA9PiB7XHJcbiAgICAgIHVpU3RhdGUuc2V0UHJvcGVydHlWYWx1ZShwcm9wTmFtZSwgcGFyYW1zW3Byb3BOYW1lXSk7XHJcbiAgICAgIGlmIChwcm9wTmFtZSAmJiBwcm9wTmFtZSA9PT0gJ3VuaW9uX3Nlc3Npb24nKSB7XHJcbiAgICAgICAgbGV0IHNlc3Npb25JbmZvID0gcGFyYW1zW3Byb3BOYW1lXTtcclxuICAgICAgICB0aGlzLnNldFNlc3Npb25JbmZvKHZpZXdNb2RlbCwgc2Vzc2lvbkluZm8pO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcbiAgcHJpdmF0ZSBzZXRTZXNzaW9uSW5mbyh2aWV3TW9kZWw6IFZpZXdNb2RlbCwgc2Vzc2lvbkluZm86IGFueSkge1xyXG4gICAgaWYgKCF2aWV3TW9kZWwgfHwgIXNlc3Npb25JbmZvKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGlmIChzZXNzaW9uSW5mbyAmJiB0eXBlb2Ygc2Vzc2lvbkluZm8gPT09ICdzdHJpbmcnICYmIHNlc3Npb25JbmZvLnN0YXJ0c1dpdGgoJ3snKSAmJiBzZXNzaW9uSW5mby5lbmRzV2l0aCgnfScpKSB7XHJcbiAgICAgIHNlc3Npb25JbmZvID0gSlNPTi5wYXJzZShzZXNzaW9uSW5mbyk7XHJcbiAgICB9XHJcbiAgICBjb25zdCB0b2tlbiA9IHNlc3Npb25JbmZvICYmIHNlc3Npb25JbmZvLnRva2VuIHx8IG51bGw7XHJcbiAgICBjb25zdCBzZXNzaW9uSWQgPSBzZXNzaW9uSW5mbyAmJiBzZXNzaW9uSW5mby5zZXNzaW9uSWQgfHwgbnVsbDtcclxuICAgIGlmICh0b2tlbikge1xyXG4gICAgICB2aWV3TW9kZWwuZnJhbWVDb250ZXh0LmFwcENvbnRleHQuVG9rZW4gPSB0b2tlbjtcclxuICAgIH1cclxuICAgIGlmIChzZXNzaW9uSWQpIHtcclxuICAgICAgY29uc3QgYmVmUmVwb3NpdG9yeSA9IHZpZXdNb2RlbC5mcmFtZUNvbnRleHQucmVwb3NpdG9yeSBhcyBCZWZSZXBvc2l0b3J5PGFueT47XHJcbiAgICAgIGlmIChiZWZSZXBvc2l0b3J5KSB7XHJcbiAgICAgICAgYmVmUmVwb3NpdG9yeS5yZXN0U2VydmljZS5zZXNzaW9uU2VydmljZS5zZXRCZVNlc3Npb25JZChzZXNzaW9uSWQpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluWKn+iDveiPnOWNlWlkXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXRGdW5jSWQocXVlcnlQYXJhbXM6IGFueSk6IGFueSB7XHJcbiAgICBpZiAoIXF1ZXJ5UGFyYW1zKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIHJldHVybiBxdWVyeVBhcmFtc1snZnVuY0lkJ107XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDojrflj5blupTnlKhpZFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0QXBwSWQocXVlcnlQYXJhbXM6IGFueSk6IGFueSB7XHJcbiAgICBpZiAoIXF1ZXJ5UGFyYW1zKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIHJldHVybiBxdWVyeVBhcmFtc1snYXBwSWQnXTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6I635Y+WdXJs5Y+C5pWw5a+56LGhXHJcbiAgICogQHBhcmFtIHF1ZXJ5UGFyYW1zIHVybOWPguaVsFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0UGFyYW1zKHF1ZXJ5UGFyYW1zOiBhbnkpOiB7IFtwcm9wTmFtZTogc3RyaW5nXTogYW55IH0ge1xyXG4gICAgaWYgKCFxdWVyeVBhcmFtcykge1xyXG4gICAgICByZXR1cm4ge307XHJcbiAgICB9XHJcbiAgICBsZXQgcmVzdWx0ID0ge307XHJcbiAgICBpZiAocXVlcnlQYXJhbXMuaGFzT3duUHJvcGVydHkoJ1dFQl9GT1JNX1JPVVRFX1BBUkFNUycpKSB7XHJcbiAgICAgIGxldCB3ZWJGb3JtUm91dGVQYXJhbXM6IHN0cmluZyA9IHF1ZXJ5UGFyYW1zWydXRUJfRk9STV9ST1VURV9QQVJBTVMnXTtcclxuICAgICAgaWYgKHdlYkZvcm1Sb3V0ZVBhcmFtcyAmJiB3ZWJGb3JtUm91dGVQYXJhbXMuc3RhcnRzV2l0aCgneycpICYmIHdlYkZvcm1Sb3V0ZVBhcmFtcy5lbmRzV2l0aCgnfScpKSB7XHJcbiAgICAgICAgd2ViRm9ybVJvdXRlUGFyYW1zID0gZGVjb2RlVVJJKGVuY29kZVVSSSh3ZWJGb3JtUm91dGVQYXJhbXMpLnJlcGxhY2UoLyUwQS9nLCAnXFxcXG4nKS5yZXBsYWNlKC8lMDkvZywgJ1xcXFx0JykucmVwbGFjZSgvJTBEL2csICdcXFxccicpKTtcclxuICAgICAgICByZXN1bHQgPSBKU09OLnBhcnNlKHdlYkZvcm1Sb3V0ZVBhcmFtcyk7XHJcbiAgICAgIH1cclxuICAgICAgT2JqZWN0LmtleXMocXVlcnlQYXJhbXMpLmZvckVhY2gocHJvcCA9PiB7XHJcbiAgICAgICAgaWYgKHByb3AgIT09ICdXRUJfRk9STV9ST1VURV9QQVJBTVMnKSB7XHJcbiAgICAgICAgICByZXN1bHRbcHJvcF0gPSBxdWVyeVBhcmFtc1twcm9wXTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHF1ZXJ5UGFyYW1zO1xyXG4gIH1cclxuICBwcml2YXRlIGhpZ2hPcmRlckludm9rZShjYWxsYmFjaykge1xyXG4gICAgcmV0dXJuICgpID0+IHtcclxuICAgICAgdHJ5IHtcclxuICAgICAgICBjb25zdCBjb250cm9sRXZlbnQgPSB0aGlzLnJ1bnRpbWVGcmFtZXdvcmtTZXJ2aWNlLmdldE1lbnVTd2l0Y2hDb250cm9sRXZlbnQoKTtcclxuICAgICAgICBpZiAoY29udHJvbEV2ZW50ICYmIGlzT2JzZXJ2YWJsZShjb250cm9sRXZlbnQpKSB7XHJcbiAgICAgICAgICBjb250cm9sRXZlbnQuc3Vic2NyaWJlKChldmVudDogYW55KSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChldmVudCkge1xyXG4gICAgICAgICAgICAgIGV2ZW50Lm5leHQoJ29rJyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgfSBjYXRjaCAoZSkgeyBjb25zb2xlLndhcm4oZSk7fVxyXG4gICAgICBpZiAoY2FsbGJhY2sgJiYgdHlwZW9mIGNhbGxiYWNrID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgICAgY2FsbGJhY2soKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxufVxyXG4iXX0=