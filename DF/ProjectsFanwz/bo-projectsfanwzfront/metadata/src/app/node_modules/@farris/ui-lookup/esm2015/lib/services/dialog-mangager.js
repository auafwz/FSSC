/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
export class LookupDialogManager {
    /**
     * @param {?} ins
     */
    constructor(ins) {
        this.ins = ins;
        this.lookupInit = null;
        this._loadDataWhenOpen = true;
        this._navSelectedId = '';
        this._selectFirstInNav = false;
        this.keyDownHandler = null;
    }
    // 帮助窗口关闭后做一些清理工作
    /**
     * @return {?}
     */
    dialogClosed() {
        if (this.ins.displayText !== this.ins.originalText && !this.ins.nosearch) {
            this.ins.displayText = this.ins.originalText;
            this.ins.setModelValue(this.ins.displayText);
        }
        if (this.ins.componentRef) {
            this.ins.componentRef.destroy();
            this.ins.componentRef = null;
        }
        if (this.ins.favoritesComponentRef) {
            this.ins.favoritesComponentRef.destroy();
            this.ins.favoritesComponentRef = null;
        }
        if (this.ins.contentContainer) {
            this.ins.contentContainer.clear();
        }
        if (this.ins.centerContainer) {
            this.ins.centerContainer.clear();
        }
        if (this.ins.leftComponentRef) {
            this.ins.leftComponentRef.destroy();
            this.ins.leftComponentRef = null;
        }
        if (this.ins.leftContainer) {
            this.ins.leftContainer.clear();
        }
        this.ins.isShow = false;
        this.ins.isTextChange = false;
        if (this.ins.dialog) {
            this.ins.content = null;
        }
        this.ins.navigationFilter = null;
        this.ins.lookupUtils.pendingEnd();
        if (this.ins.helpId) {
            this.ins.displayType = '';
        }
        if (this.lookupInit) {
            this.lookupInit.unsubscribe();
            this.lookupInit = null;
        }
        // this.ins.items = [];
        this.ins.favoriteItems = [];
        this.ins.isTabChanged = false;
        if (this.ins.uri) {
            this.ins.items = [];
        }
        this.ins._searchState = null;
        this.ins.pageIndex = 1;
        this.ins.loadDataWhenOpen = this._loadDataWhenOpen;
        this.ins.navSelectedIds = this._navSelectedId;
        this.ins.selectFirstInNav = this._selectFirstInNav;
        this.ins.isGetAllChidlNodes = false;
        this.ins.enableGetAllChildNodes = true;
        // 保存个性化数据
        if (this.ins.usePersionalConf && this.ins.favoriteDataFrom !== 'locale') {
            this.ins.httpMgr.submitFavoriteData('dialog closed event.');
        }
        if (this.keyDownHandler) {
            this.keyDownHandler();
            this.keyDownHandler = null;
        }
        if (this.ins.inputGroup) {
            this.ins.inputGroup.focus();
        }
        this.ins.dialogClosed.emit();
    }
    /**
     * @return {?}
     */
    onDialogCreated() {
        this._loadDataWhenOpen = this.ins.loadDataWhenOpen;
        this._navSelectedId = this.ins.navSelectedIds;
        this._selectFirstInNav = this.ins.selectFirstInNav;
        this.ins.dialogCreatedSubscription = this.ins.dialogCreated.subscribe((/**
         * @param {?} dlg
         * @return {?}
         */
        dlg => {
            if (dlg) {
                if (this.ins.dialogOpenedSubscription) {
                    this.ins.dialogOpenedSubscription.unsubscribe();
                }
                if (this.ins.dialogClosedSubscription) {
                    this.ins.dialogClosedSubscription.unsubscribe();
                }
                this.registerDialogEvent();
                if (this.ins.isRecordSize) {
                    /** @type {?} */
                    const dlgSize = this.ins.personalConfigService.getDialogSize();
                    if (dlgSize) {
                        const { width, height } = dlgSize;
                        this.ins.dialogWidth = width ? width : this.ins.dialogWidth;
                        this.ins.dialogHeight = height ? height : this.ins.dialogHeight;
                        // 20200908 更新现窗口的尺寸 by Lucas
                        dlg.width = this.ins.dialogWidth;
                        dlg.height = this.ins.dialogHeight;
                    }
                }
                dlg.show();
            }
        }));
    }
    /**
     * @param {?} pr
     * @return {?}
     */
    canOpenDialog(pr) {
        /** @type {?} */
        let o = true;
        if (pr === undefined || pr === null || pr === '') {
            o = true;
        }
        if (typeof pr === 'boolean') {
            o = pr;
        }
        if (typeof pr === 'object') {
            if (pr.showDialog === undefined) {
                o = true;
            }
            else {
                o = pr.showDialog;
            }
            if (pr.hasOwnProperty('data')) {
                /** 保存帮助前传递的数据 */
                this.ins.customData = pr.data;
            }
            this.ins.selectedIds = pr.selectedIds || null;
            if (pr.message) {
                this.ins.notifyService.warning(pr.message);
            }
        }
        this.ins.isReady = false;
        this.ins.isShow = o;
    }
    /**
     * @return {?}
     */
    getHeight() {
        return this.ins.dialog.size.contentHeight -
            this.ins.containerMargin.bottom -
            this.ins.containerMargin.top -
            (this.ins.useFavorite ? 40 : 0);
    }
    /**
     * @private
     * @return {?}
     */
    getMainGridSize() {
        if (this.ins.isDoublleList()) {
            return {
                width: this.ins.dialog.size.width - this.ins.leftPanel.width - 27,
                height: this.getHeight()
            };
        }
        return {
            width: this.ins.dialog.size.width - this.ins.containerMargin.left - this.ins.containerMargin.right,
            height: this.getHeight()
        };
    }
    /**
     * 注册弹出窗口的事件
     * @private
     * @return {?}
     */
    registerDialogEvent() {
        this.ins.dialogOpenedSubscription = this.ins.dialog.opened.subscribe((/**
         * @return {?}
         */
        () => {
            this.ins.gridOptions = Object.assign(this.ins.gridOptions, this.getMainGridSize());
            this.ins.dialog.el.nativeElement.querySelector('.ps-content').style.height = '100%';
            if (this.ins.displayType && this.ins.customDisplayType) {
                this.ins.componentRef = this.ins.lookupCmpMgr.createContent(this.ins.gridOptions);
                this.ins.lookupCmpMgr.createFavoriteComponent();
            }
            this.ins.initData();
            // 修改帮助窗口的状态
            this.ins.lookupUtils.pendingEnd();
            this.ins.dialogOpened.emit();
        }));
        this.ins.subscriptions.push(this.ins.dialogOpenedSubscription);
        this.lookupInit = this.ins.lookupinitializationSubject.subscribe((/**
         * @return {?}
         */
        () => {
            this.ins.loadDataWhenOpen = true;
            // 注册快捷键
            this.registerShortcutKey();
            // 监听左侧尺寸变化事件
            if (this.ins.leftPanel) {
                /** @type {?} */
                const leftPanelResize$ = this.ins.leftPanel.resizing.subscribe((/**
                 * @param {?} s
                 * @return {?}
                 */
                (s) => {
                    this.ins.componentRef.instance.resize({
                        width: this.ins.dialog.size.width - s.size.width - 27,
                        height: this.getHeight()
                    });
                    this.ins.leftComponentRef.instance.resize(s.size);
                }));
                this.ins.subscriptions.push(leftPanelResize$);
            }
        }));
        this.ins.dialogClosedSubscription = this.ins.dialog.closed.subscribe((/**
         * @return {?}
         */
        () => {
            // 输入框变化后，弹出窗口未选择数据关闭窗口时，还原原始值
            this.ins.dialogMgr.dialogClosed();
        }));
        this.ins.subscriptions.push(this.ins.dialogClosedSubscription);
    }
    /**
     * @private
     * @return {?}
     */
    registerShortcutKey() {
        // 回车，与确定按钮处理逻辑一至。
        /** @type {?} */
        const dlgContainerDom = this.ins.dialog.el.nativeElement.querySelector('.farris-modal');
        if (dlgContainerDom && this.ins.shortcutKey && !this.keyDownHandler) {
            this.keyDownHandler = this.ins.eventManager.addEventListener(dlgContainerDom, 'keydown', (/**
             * @param {?} e
             * @return {?}
             */
            (e) => {
                e.stopPropagation();
                const { moveUp, moveDown, searchFocus, confirm, nextPager, prevPager, expand, collapse } = this.ins.shortcutKey;
                /** @type {?} */
                const arrowKey = [moveUp, moveDown, expand, collapse];
                if (arrowKey.includes(e.code)) {
                    this.ins.componentRef.instance.onKeydownEvent(e);
                }
                else if (e.key === confirm) {
                    if (e.target['nodeName'] === 'INPUT' && !e.ctrlKey) {
                        return;
                    }
                    this.ins.okButton.nativeElement.click();
                }
                else if (e.code === searchFocus) { // 帮助窗口查询输入框焦点
                    e.preventDefault();
                    this.ins.componentRef.instance.inputGroup.focus();
                }
                else if (!this.ins.isTree() && (e.code === nextPager || e.code === prevPager)) { // 分页
                    // 分页
                    /** @type {?} */
                    const isNextPager = e.code === nextPager;
                    this.paginationKeyDownHandler(isNextPager);
                }
            }));
        }
    }
    /**
     * @private
     * @param {?=} next
     * @return {?}
     */
    paginationKeyDownHandler(next = true) {
        /** @type {?} */
        const datatableRef = this.ins.componentRef.instance;
        const { pageIndex, pageSize, total } = datatableRef;
        /** @type {?} */
        const pagerCount = Math.ceil(total / pageSize);
        /** @type {?} */
        let newPageNum = pageIndex;
        if (next) {
            newPageNum = newPageNum + 1;
        }
        else {
            newPageNum = newPageNum - 1;
        }
        if (newPageNum > pagerCount || newPageNum < 1) {
            newPageNum = pageIndex;
        }
        this.ins.componentRef.instance.onPageChange({ pageSize, pageIndex: newPageNum });
    }
}
if (false) {
    /**
     * @type {?}
     * @private
     */
    LookupDialogManager.prototype.lookupInit;
    /**
     * @type {?}
     * @private
     */
    LookupDialogManager.prototype._loadDataWhenOpen;
    /**
     * @type {?}
     * @private
     */
    LookupDialogManager.prototype._navSelectedId;
    /**
     * @type {?}
     * @private
     */
    LookupDialogManager.prototype._selectFirstInNav;
    /**
     * @type {?}
     * @private
     */
    LookupDialogManager.prototype.keyDownHandler;
    /**
     * @type {?}
     * @private
     */
    LookupDialogManager.prototype.ins;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGlhbG9nLW1hbmdhZ2VyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy91aS1sb29rdXAvIiwic291cmNlcyI6WyJsaWIvc2VydmljZXMvZGlhbG9nLW1hbmdhZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFJQSxNQUFNLE9BQU8sbUJBQW1COzs7O0lBUzVCLFlBQW9CLEdBQXdCO1FBQXhCLFFBQUcsR0FBSCxHQUFHLENBQXFCO1FBUHBDLGVBQVUsR0FBaUIsSUFBSSxDQUFDO1FBQ2hDLHNCQUFpQixHQUFHLElBQUksQ0FBQztRQUN6QixtQkFBYyxHQUFHLEVBQUUsQ0FBQztRQUNwQixzQkFBaUIsR0FBRyxLQUFLLENBQUM7UUFFMUIsbUJBQWMsR0FBRyxJQUFJLENBQUM7SUFFa0IsQ0FBQzs7Ozs7SUFFakQsWUFBWTtRQUNSLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxXQUFXLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxZQUFZLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRTtZQUN0RSxJQUFJLENBQUMsR0FBRyxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQztZQUM3QyxJQUFJLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1NBQ2hEO1FBRUQsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLFlBQVksRUFBRTtZQUN2QixJQUFJLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUNoQyxJQUFJLENBQUMsR0FBRyxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUM7U0FDaEM7UUFFRCxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMscUJBQXFCLEVBQUU7WUFDaEMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxxQkFBcUIsQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUN6QyxJQUFJLENBQUMsR0FBRyxDQUFDLHFC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Q0FBQyxZQUFZLENBQUMsRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBRSxDQUFDLENBQUM7SUFDckYsQ0FBQztDQUVKOzs7Ozs7SUFuUkcseUNBQXdDOzs7OztJQUN4QyxnREFBaUM7Ozs7O0lBQ2pDLDZDQUE0Qjs7Ozs7SUFDNUIsZ0RBQWtDOzs7OztJQUVsQyw2Q0FBOEI7Ozs7O0lBRWxCLGtDQUFnQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBQaWNraW5nUmVzdWx0IH0gZnJvbSAnLi4vbG9va3VwLWdyaWQtb3B0aW9ucyc7XHJcbmltcG9ydCB7IExvb2t1cEdyaWRDb21wb25lbnQgfSBmcm9tICcuLi9sb29rdXAtZ3JpZC5jb21wb25lbnQnO1xyXG5cclxuZXhwb3J0IGNsYXNzIExvb2t1cERpYWxvZ01hbmFnZXIge1xyXG5cclxuICAgIHByaXZhdGUgbG9va3VwSW5pdDogU3Vic2NyaXB0aW9uID0gbnVsbDtcclxuICAgIHByaXZhdGUgX2xvYWREYXRhV2hlbk9wZW4gPSB0cnVlO1xyXG4gICAgcHJpdmF0ZSBfbmF2U2VsZWN0ZWRJZCA9ICcnO1xyXG4gICAgcHJpdmF0ZSBfc2VsZWN0Rmlyc3RJbk5hdiA9IGZhbHNlO1xyXG5cclxuICAgIHByaXZhdGUga2V5RG93bkhhbmRsZXIgPSBudWxsO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgaW5zOiBMb29rdXBHcmlkQ29tcG9uZW50KSB7IH1cclxuICAgIC8vIOW4ruWKqeeql+WPo+WFs+mXreWQjuWBmuS4gOS6m+a4heeQhuW3peS9nFxyXG4gICAgZGlhbG9nQ2xvc2VkKCkge1xyXG4gICAgICAgIGlmICh0aGlzLmlucy5kaXNwbGF5VGV4dCAhPT0gdGhpcy5pbnMub3JpZ2luYWxUZXh0ICYmICF0aGlzLmlucy5ub3NlYXJjaCkge1xyXG4gICAgICAgICAgICB0aGlzLmlucy5kaXNwbGF5VGV4dCA9IHRoaXMuaW5zLm9yaWdpbmFsVGV4dDtcclxuICAgICAgICAgICAgdGhpcy5pbnMuc2V0TW9kZWxWYWx1ZSh0aGlzLmlucy5kaXNwbGF5VGV4dCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodGhpcy5pbnMuY29tcG9uZW50UmVmKSB7XHJcbiAgICAgICAgICAgIHRoaXMuaW5zLmNvbXBvbmVudFJlZi5kZXN0cm95KCk7XHJcbiAgICAgICAgICAgIHRoaXMuaW5zLmNvbXBvbmVudFJlZiA9IG51bGw7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodGhpcy5pbnMuZmF2b3JpdGVzQ29tcG9uZW50UmVmKSB7XHJcbiAgICAgICAgICAgIHRoaXMuaW5zLmZhdm9yaXRlc0NvbXBvbmVudFJlZi5kZXN0cm95KCk7XHJcbiAgICAgICAgICAgIHRoaXMuaW5zLmZhdm9yaXRlc0NvbXBvbmVudFJlZiA9IG51bGw7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodGhpcy5pbnMuY29udGVudENvbnRhaW5lcikge1xyXG4gICAgICAgICAgICB0aGlzLmlucy5jb250ZW50Q29udGFpbmVyLmNsZWFyKCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodGhpcy5pbnMuY2VudGVyQ29udGFpbmVyKSB7XHJcbiAgICAgICAgICAgIHRoaXMuaW5zLmNlbnRlckNvbnRhaW5lci5jbGVhcigpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHRoaXMuaW5zLmxlZnRDb21wb25lbnRSZWYpIHtcclxuICAgICAgICAgICAgdGhpcy5pbnMubGVmdENvbXBvbmVudFJlZi5kZXN0cm95KCk7XHJcbiAgICAgICAgICAgIHRoaXMuaW5zLmxlZnRDb21wb25lbnRSZWYgPSBudWxsO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHRoaXMuaW5zLmxlZnRDb250YWluZXIpIHtcclxuICAgICAgICAgICAgdGhpcy5pbnMubGVmdENvbnRhaW5lci5jbGVhcigpO1xyXG4gICAgICAgIH1cclxuXHJcblxyXG4gICAgICAgIHRoaXMuaW5zLmlzU2hvdyA9IGZhbHNlO1xyXG4gICAgICAgIHRoaXMuaW5zLmlzVGV4dENoYW5nZSA9IGZhbHNlO1xyXG4gICAgICAgIGlmICh0aGlzLmlucy5kaWFsb2cpIHtcclxuICAgICAgICAgICAgdGhpcy5pbnMuY29udGVudCA9IG51bGw7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLmlucy5uYXZpZ2F0aW9uRmlsdGVyID0gbnVsbDtcclxuXHJcbiAgICAgICAgdGhpcy5pbnMubG9va3VwVXRpbHMucGVuZGluZ0VuZCgpO1xyXG5cclxuICAgICAgICBpZiAodGhpcy5pbnMuaGVscElkKSB7XHJcbiAgICAgICAgICAgIHRoaXMuaW5zLmRpc3BsYXlUeXBlID0gJyc7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodGhpcy5sb29rdXBJbml0KSB7XHJcbiAgICAgICAgICAgIHRoaXMubG9va3VwSW5pdC51bnN1YnNjcmliZSgpO1xyXG4gICAgICAgICAgICB0aGlzLmxvb2t1cEluaXQgPSBudWxsO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gdGhpcy5pbnMuaXRlbXMgPSBbXTtcclxuICAgICAgICB0aGlzLmlucy5mYXZvcml0ZUl0ZW1zID0gW107XHJcbiAgICAgICAgdGhpcy5pbnMuaXNUYWJDaGFuZ2VkID0gZmFsc2U7XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmlucy51cmkpIHtcclxuICAgICAgICAgICAgdGhpcy5pbnMuaXRlbXMgPSBbXTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5pbnMuX3NlYXJjaFN0YXRlID0gbnVsbDtcclxuXHJcblxyXG4gICAgICAgIHRoaXMuaW5zLnBhZ2VJbmRleCA9IDE7XHJcblxyXG4gICAgICAgIHRoaXMuaW5zLmxvYWREYXRhV2hlbk9wZW4gPSB0aGlzLl9sb2FkRGF0YVdoZW5PcGVuO1xyXG4gICAgICAgIHRoaXMuaW5zLm5hdlNlbGVjdGVkSWRzID0gdGhpcy5fbmF2U2VsZWN0ZWRJZDtcclxuICAgICAgICB0aGlzLmlucy5zZWxlY3RGaXJzdEluTmF2ID0gdGhpcy5fc2VsZWN0Rmlyc3RJbk5hdjtcclxuXHJcbiAgICAgICAgdGhpcy5pbnMuaXNHZXRBbGxDaGlkbE5vZGVzID0gZmFsc2U7XHJcblxyXG4gICAgICAgIHRoaXMuaW5zLmVuYWJsZUdldEFsbENoaWxkTm9kZXMgPSB0cnVlO1xyXG5cclxuICAgICAgICAvLyDkv53lrZjkuKrmgKfljJbmlbDmja5cclxuICAgICAgICBpZiAodGhpcy5pbnMudXNlUGVyc2lvbmFsQ29uZiAmJiB0aGlzLmlucy5mYXZvcml0ZURhdGFGcm9tICE9PSAnbG9jYWxlJykge1xyXG4gICAgICAgICAgICB0aGlzLmlucy5odHRwTWdyLnN1Ym1pdEZhdm9yaXRlRGF0YSgnZGlhbG9nIGNsb3NlZCBldmVudC4nKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmtleURvd25IYW5kbGVyKSB7XHJcbiAgICAgICAgICAgIHRoaXMua2V5RG93bkhhbmRsZXIoKTtcclxuICAgICAgICAgICAgdGhpcy5rZXlEb3duSGFuZGxlciA9IG51bGw7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh0aGlzLmlucy5pbnB1dEdyb3VwKSB7XHJcbiAgICAgICAgICAgIHRoaXMuaW5zLmlucHV0R3JvdXAuZm9jdXMoKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5pbnMuZGlhbG9nQ2xvc2VkLmVtaXQoKTtcclxuICAgIH1cclxuXHJcbiAgICBvbkRpYWxvZ0NyZWF0ZWQoKSB7XHJcbiAgICAgICAgdGhpcy5fbG9hZERhdGFXaGVuT3BlbiA9IHRoaXMuaW5zLmxvYWREYXRhV2hlbk9wZW47XHJcbiAgICAgICAgdGhpcy5fbmF2U2VsZWN0ZWRJZCA9IHRoaXMuaW5zLm5hdlNlbGVjdGVkSWRzO1xyXG4gICAgICAgIHRoaXMuX3NlbGVjdEZpcnN0SW5OYXYgPSB0aGlzLmlucy5zZWxlY3RGaXJzdEluTmF2O1xyXG5cclxuICAgICAgICB0aGlzLmlucy5kaWFsb2dDcmVhdGVkU3Vic2NyaXB0aW9uID0gdGhpcy5pbnMuZGlhbG9nQ3JlYXRlZC5zdWJzY3JpYmUoZGxnID0+IHtcclxuICAgICAgICAgICAgaWYgKGRsZykge1xyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuaW5zLmRpYWxvZ09wZW5lZFN1YnNjcmlwdGlvbikge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaW5zLmRpYWxvZ09wZW5lZFN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuaW5zLmRpYWxvZ0Nsb3NlZFN1YnNjcmlwdGlvbikge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaW5zLmRpYWxvZ0Nsb3NlZFN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgdGhpcy5yZWdpc3RlckRpYWxvZ0V2ZW50KCk7XHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5pbnMuaXNSZWNvcmRTaXplKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGxnU2l6ZSA9IHRoaXMuaW5zLnBlcnNvbmFsQ29uZmlnU2VydmljZS5nZXREaWFsb2dTaXplKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGRsZ1NpemUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgeyB3aWR0aCwgaGVpZ2h0IH0gPSBkbGdTaXplO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmlucy5kaWFsb2dXaWR0aCA9IHdpZHRoID8gd2lkdGggOiB0aGlzLmlucy5kaWFsb2dXaWR0aDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnMuZGlhbG9nSGVpZ2h0ID0gaGVpZ2h0ID8gaGVpZ2h0IDogdGhpcy5pbnMuZGlhbG9nSGVpZ2h0O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyAyMDIwMDkwOCDmm7TmlrDnjrDnqpflj6PnmoTlsLrlr7ggYnkgTHVjYXNcclxuICAgICAgICAgICAgICAgICAgICAgICAgZGxnLndpZHRoID0gdGhpcy5pbnMuZGlhbG9nV2lkdGg7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRsZy5oZWlnaHQgPSB0aGlzLmlucy5kaWFsb2dIZWlnaHQ7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZGxnLnNob3coKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGNhbk9wZW5EaWFsb2cocHI6IFBpY2tpbmdSZXN1bHQgfCBhbnkpIHtcclxuICAgICAgICBsZXQgbyA9IHRydWU7XHJcbiAgICAgICAgaWYgKHByID09PSB1bmRlZmluZWQgfHwgcHIgPT09IG51bGwgfHwgcHIgPT09ICcnKSB7XHJcbiAgICAgICAgICAgIG8gPSB0cnVlO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHR5cGVvZiBwciA9PT0gJ2Jvb2xlYW4nKSB7XHJcbiAgICAgICAgICAgIG8gPSBwcjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0eXBlb2YgcHIgPT09ICdvYmplY3QnKSB7XHJcbiAgICAgICAgICAgIGlmIChwci5zaG93RGlhbG9nID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgIG8gPSB0cnVlO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgbyA9IHByLnNob3dEaWFsb2c7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChwci5oYXNPd25Qcm9wZXJ0eSgnZGF0YScpKSB7XHJcbiAgICAgICAgICAgICAgICAvKiog5L+d5a2Y5biu5Yqp5YmN5Lyg6YCS55qE5pWw5o2uICovXHJcbiAgICAgICAgICAgICAgICB0aGlzLmlucy5jdXN0b21EYXRhID0gcHIuZGF0YTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLmlucy5zZWxlY3RlZElkcyA9IHByLnNlbGVjdGVkSWRzIHx8IG51bGw7XHJcblxyXG4gICAgICAgICAgICBpZiAocHIubWVzc2FnZSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5pbnMubm90aWZ5U2VydmljZS53YXJuaW5nKHByLm1lc3NhZ2UpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuXHJcbiAgICAgICAgdGhpcy5pbnMuaXNSZWFkeSA9IGZhbHNlO1xyXG5cclxuICAgICAgICB0aGlzLmlucy5pc1Nob3cgPSBvO1xyXG4gICAgfVxyXG5cclxuICAgIGdldEhlaWdodCgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5pbnMuZGlhbG9nLnNpemUuY29udGVudEhlaWdodCAtXHJcbiAgICAgICAgICAgICAgICB0aGlzLmlucy5jb250YWluZXJNYXJnaW4uYm90dG9tIC1cclxuICAgICAgICAgICAgICAgIHRoaXMuaW5zLmNvbnRhaW5lck1hcmdpbi50b3AgLVxyXG4gICAgICAgICAgICAgICAgKHRoaXMuaW5zLnVzZUZhdm9yaXRlID8gNDAgOiAwKTtcclxuICAgIH1cclxuXHJcblxyXG4gICAgcHJpdmF0ZSBnZXRNYWluR3JpZFNpemUoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuaW5zLmlzRG91YmxsZUxpc3QoKSkge1xyXG4gICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgd2lkdGg6IHRoaXMuaW5zLmRpYWxvZy5zaXplLndpZHRoIC0gdGhpcy5pbnMubGVmdFBhbmVsLndpZHRoIC0gMjcsXHJcbiAgICAgICAgICAgICAgICBoZWlnaHQ6IHRoaXMuZ2V0SGVpZ2h0KClcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIHdpZHRoOiB0aGlzLmlucy5kaWFsb2cuc2l6ZS53aWR0aCAtIHRoaXMuaW5zLmNvbnRhaW5lck1hcmdpbi5sZWZ0IC0gdGhpcy5pbnMuY29udGFpbmVyTWFyZ2luLnJpZ2h0LFxyXG4gICAgICAgICAgICBoZWlnaHQ6IHRoaXMuZ2V0SGVpZ2h0KClcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIC8qKiDms6jlhozlvLnlh7rnqpflj6PnmoTkuovku7YgKi9cclxuICAgIHByaXZhdGUgcmVnaXN0ZXJEaWFsb2dFdmVudCgpIHtcclxuICAgICAgICB0aGlzLmlucy5kaWFsb2dPcGVuZWRTdWJzY3JpcHRpb24gPSB0aGlzLmlucy5kaWFsb2cub3BlbmVkLnN1YnNjcmliZSgoKSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuaW5zLmdyaWRPcHRpb25zID0gT2JqZWN0LmFzc2lnbih0aGlzLmlucy5ncmlkT3B0aW9ucywgdGhpcy5nZXRNYWluR3JpZFNpemUoKSk7XHJcbiAgICAgICAgICAgIHRoaXMuaW5zLmRpYWxvZy5lbC5uYXRpdmVFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJy5wcy1jb250ZW50Jykuc3R5bGUuaGVpZ2h0ID0gJzEwMCUnO1xyXG5cclxuICAgICAgICAgICAgaWYgKHRoaXMuaW5zLmRpc3BsYXlUeXBlICYmIHRoaXMuaW5zLmN1c3RvbURpc3BsYXlUeXBlKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmlucy5jb21wb25lbnRSZWYgPSB0aGlzLmlucy5sb29rdXBDbXBNZ3IuY3JlYXRlQ29udGVudCh0aGlzLmlucy5ncmlkT3B0aW9ucyk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmlucy5sb29rdXBDbXBNZ3IuY3JlYXRlRmF2b3JpdGVDb21wb25lbnQoKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgdGhpcy5pbnMuaW5pdERhdGEoKTtcclxuXHJcbiAgICAgICAgICAgIC8vIOS/ruaUueW4ruWKqeeql+WPo+eahOeKtuaAgVxyXG4gICAgICAgICAgICB0aGlzLmlucy5sb29rdXBVdGlscy5wZW5kaW5nRW5kKCk7XHJcbiAgICAgICAgICAgIHRoaXMuaW5zLmRpYWxvZ09wZW5lZC5lbWl0KCk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHRoaXMuaW5zLnN1YnNjcmlwdGlvbnMucHVzaCh0aGlzLmlucy5kaWFsb2dPcGVuZWRTdWJzY3JpcHRpb24pO1xyXG5cclxuICAgICAgICB0aGlzLmxvb2t1cEluaXQgPSB0aGlzLmlucy5sb29rdXBpbml0aWFsaXphdGlvblN1YmplY3Quc3Vic2NyaWJlKCgpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5pbnMubG9hZERhdGFXaGVuT3BlbiA9IHRydWU7XHJcbiAgICAgICAgICAgIC8vIOazqOWGjOW/q+aNt+mUrlxyXG4gICAgICAgICAgICB0aGlzLnJlZ2lzdGVyU2hvcnRjdXRLZXkoKTtcclxuICAgICAgICAgICAgLy8g55uR5ZCs5bem5L6n5bC65a+45Y+Y5YyW5LqL5Lu2XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmlucy5sZWZ0UGFuZWwpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGxlZnRQYW5lbFJlc2l6ZSQgPSB0aGlzLmlucy5sZWZ0UGFuZWwucmVzaXppbmcuc3Vic2NyaWJlKChzOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmlucy5jb21wb25lbnRSZWYuaW5zdGFuY2UucmVzaXplKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgd2lkdGg6IHRoaXMuaW5zLmRpYWxvZy5zaXplLndpZHRoIC0gcy5zaXplLndpZHRoIC0gMjcsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGhlaWdodDogdGhpcy5nZXRIZWlnaHQoKVxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaW5zLmxlZnRDb21wb25lbnRSZWYuaW5zdGFuY2UucmVzaXplKHMuc2l6ZSk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICB0aGlzLmlucy5zdWJzY3JpcHRpb25zLnB1c2gobGVmdFBhbmVsUmVzaXplJCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgdGhpcy5pbnMuZGlhbG9nQ2xvc2VkU3Vic2NyaXB0aW9uID0gdGhpcy5pbnMuZGlhbG9nLmNsb3NlZC5zdWJzY3JpYmUoKCkgPT4ge1xyXG4gICAgICAgICAgICAvLyDovpPlhaXmoYblj5jljJblkI7vvIzlvLnlh7rnqpflj6PmnKrpgInmi6nmlbDmja7lhbPpl63nqpflj6Pml7bvvIzov5jljp/ljp/lp4vlgLxcclxuICAgICAgICAgICAgdGhpcy5pbnMuZGlhbG9nTWdyLmRpYWxvZ0Nsb3NlZCgpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICB0aGlzLmlucy5zdWJzY3JpcHRpb25zLnB1c2godGhpcy5pbnMuZGlhbG9nQ2xvc2VkU3Vic2NyaXB0aW9uKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHJlZ2lzdGVyU2hvcnRjdXRLZXkoKSB7XHJcbiAgICAgICAgLy8g5Zue6L2m77yM5LiO56Gu5a6a5oyJ6ZKu5aSE55CG6YC76L6R5LiA6Iez44CCXHJcbiAgICAgICAgY29uc3QgZGxnQ29udGFpbmVyRG9tID0gdGhpcy5pbnMuZGlhbG9nLmVsLm5hdGl2ZUVsZW1lbnQucXVlcnlTZWxlY3RvcignLmZhcnJpcy1tb2RhbCcpO1xyXG5cclxuICAgICAgICBpZiAoZGxnQ29udGFpbmVyRG9tICYmIHRoaXMuaW5zLnNob3J0Y3V0S2V5ICYmICF0aGlzLmtleURvd25IYW5kbGVyKSB7XHJcbiAgICAgICAgICAgIHRoaXMua2V5RG93bkhhbmRsZXIgPSB0aGlzLmlucy5ldmVudE1hbmFnZXIuYWRkRXZlbnRMaXN0ZW5lcihkbGdDb250YWluZXJEb20sICdrZXlkb3duJywgKGU6IEtleWJvYXJkRXZlbnQpID0+IHtcclxuICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCB7IG1vdmVVcCwgbW92ZURvd24sIHNlYXJjaEZvY3VzLCBjb25maXJtLCBuZXh0UGFnZXIsIHByZXZQYWdlciwgZXhwYW5kLCBjb2xsYXBzZSB9ID0gdGhpcy5pbnMuc2hvcnRjdXRLZXk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBhcnJvd0tleSA9IFttb3ZlVXAsIG1vdmVEb3duLCBleHBhbmQsIGNvbGxhcHNlXTtcclxuICAgICAgICAgICAgICAgIGlmIChhcnJvd0tleS5pbmNsdWRlcyhlLmNvZGUpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnMuY29tcG9uZW50UmVmLmluc3RhbmNlLm9uS2V5ZG93bkV2ZW50KGUpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChlLmtleSA9PT0gY29uZmlybSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChlLnRhcmdldFsnbm9kZU5hbWUnXSA9PT0gJ0lOUFVUJyAmJiAhZS5jdHJsS2V5KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnMub2tCdXR0b24ubmF0aXZlRWxlbWVudC5jbGljaygpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChlLmNvZGUgPT09IHNlYXJjaEZvY3VzKSB7IC8vIOW4ruWKqeeql+WPo+afpeivoui+k+WFpeahhueEpueCuVxyXG4gICAgICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmlucy5jb21wb25lbnRSZWYuaW5zdGFuY2UuaW5wdXRHcm91cC5mb2N1cygpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmICghdGhpcy5pbnMuaXNUcmVlKCkgJiYgKGUuY29kZSA9PT0gbmV4dFBhZ2VyIHx8IGUuY29kZSA9PT0gcHJldlBhZ2VyICkpIHsgIC8vIOWIhumhtVxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGlzTmV4dFBhZ2VyID0gZS5jb2RlID09PSBuZXh0UGFnZXI7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5wYWdpbmF0aW9uS2V5RG93bkhhbmRsZXIoaXNOZXh0UGFnZXIpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBwYWdpbmF0aW9uS2V5RG93bkhhbmRsZXIobmV4dCA9IHRydWUpIHtcclxuICAgICAgICBjb25zdCBkYXRhdGFibGVSZWYgPSB0aGlzLmlucy5jb21wb25lbnRSZWYuaW5zdGFuY2U7XHJcbiAgICAgICAgY29uc3Qge3BhZ2VJbmRleCwgcGFnZVNpemUsIHRvdGFsfSA9IGRhdGF0YWJsZVJlZjtcclxuICAgICAgICBjb25zdCBwYWdlckNvdW50ID0gTWF0aC5jZWlsKHRvdGFsIC8gcGFnZVNpemUpO1xyXG5cclxuICAgICAgICBsZXQgbmV3UGFnZU51bSA9IHBhZ2VJbmRleDtcclxuICAgICAgICBpZiAobmV4dCkge1xyXG4gICAgICAgICAgICBuZXdQYWdlTnVtID0gbmV3UGFnZU51bSArIDE7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgbmV3UGFnZU51bSA9IG5ld1BhZ2VOdW0gLSAxO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKG5ld1BhZ2VOdW0gPiBwYWdlckNvdW50IHx8IG5ld1BhZ2VOdW0gPCAxKSB7XHJcbiAgICAgICAgICAgIG5ld1BhZ2VOdW0gPSBwYWdlSW5kZXg7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLmlucy5jb21wb25lbnRSZWYuaW5zdGFuY2Uub25QYWdlQ2hhbmdlKHsgcGFnZVNpemUsIHBhZ2VJbmRleDogbmV3UGFnZU51bSB9KTtcclxuICAgIH1cclxuXHJcbn1cclxuXHJcbiJdfQ==