// tslint:disable: max-line-length
import { Injectable } from '@angular/core';
import { Repository, FrameContext, PARENT_CLASS, ChangeType } from '@farris/devkit';
import { tap, switchMap } from 'rxjs/operators';
import { Subject } from 'rxjs';
import { zip } from 'rxjs/observable/zip';
import { empty } from 'rxjs/observable/empty';
import { of } from 'rxjs/observable/of';
import { VerifyDetailService } from '@farris/ui-verify-detail';
/**
 * 表单验证服务
 * @scope FrameComponent
 */
class ValidationService {
    /**
     * 构造函数
     */
    constructor(repository, frameContext) {
        this.repository = repository;
        this.frameContext = frameContext;
        this.validationResults = new Subject();
        this.validationAllResult = new Subject();
    }
    /**
     * 验证表单内的所有表单
     */
    validate() {
        this.repository.getList().subscribe((result) => {
            for (const entity of result) {
                entity.validate().subscribe((result) => {
                    if (!result.isValid) {
                        alert(result.message);
                        this.validationResults.next(result);
                    }
                });
            }
        });
        return this.validationResults;
    }
    /**
     * 校验当前行
     */
    validateCurrentRow() {
        // 组合表单只校验当前按钮所在的表单
        const primaryValue = this.frameContext.bindingData.list.currentId;
        const entities = [this.repository.entityCollection.getEntityById(primaryValue)];
        const namespace = this.frameContext.namespace;
        let frameContexts = [];
        if (namespace) {
            // 存在命名空间，说明表单较新，可以依赖该特性
            frameContexts = this.frameContext.appContext.frameContextManager.getFrameContextsByNamespace(namespace);
        }
        else {
            // 表单较老，获取所有的上下文，在校验阶段过滤规则
            frameContexts = this.frameContext.appContext.frameContextManager.getFrameContexts();
        }
        const isModal = this.isInDialog();
        const hasOwnVerifyDetailService = this.hasOwnVerifyDetailService();
        let rootViewModel = this.frameContext.root.viewModel;
        if (isModal && hasOwnVerifyDetailService) {
            rootViewModel = this.frameContext.getVirtualRootFrameContext().viewModel;
        }
        let toValidate = false;
        const formErrors = [];
        frameContexts.forEach((frameContext) => {
            if (frameContext.form && frameContext.form.enableValidate) {
                toValidate = true;
            }
        });
        if (!toValidate || entities.length < 1) {
            return of(true);
        }
        rootViewModel.verifyInformations = [];
        let formValid = true;
        let entityValid = true;
        const formValidationRules = new Map();
        frameContexts.forEach((formContext) => {
            const bindingObject = formContext.bindingData.getObject();
            // 通知所有bindingData,
            bindingObject && bindingObject.setShowValidationMsg(true);
            if (formContext.form && formContext.form.enableValidate) {
                // 获取当前表单上的所有验证规则
                const currentFormValidationRules = formContext.form.getValidationRules();
                currentFormValidationRules.forEach((rules, path) => {
                    if (formValidationRules.has(path)) {
                        rules.forEach(rule => formValidationRules.get(path).push(rule));
                    }
                    else {
                        formValidationRules.set(path, [...rules]);
                    }
                });
                formContext.form.setShowValidationMsg(true);
                // 逐个调用表单的验证，验证前端表单规则
                if (!formContext.form.isFormValid()) {
                    formErrors.push(formContext.form);
                    formValid = false;
                }
            }
        });
        // 验证所有实体
        const observableList = entities.map((entity) => {
            const index = this.frameContext.bindingData.list.getIndexById(entity.primaryValue);
            return entity.validate(undefined, undefined, formValidationRules, null, this.frameContext);
        });
        const result$ = zip(...observableList).pipe(tap((resultList) => {
            frameContexts.forEach((formContext) => {
                if (!formContext.form.enableValidate) {
                    return;
                }
                const handleErrors = (errors) => {
                    errors.forEach((validationError) => {
                        if (validationError.children && validationError.children.length) {
                            handleErrors(validationError.children);
                        }
                        const errMsgObj = {};
                        let id = '';
                        const findId = (target) => {
                            if (target && target.data && target.data.id) {
                                id = target.data.id;
                                return;
                            }
                            else if (target[PARENT_CLASS]) {
                                findId(target[PARENT_CLASS]);
                            }
                        };
                        findId(validationError.target);
                        // 实体验证出错，需要将错误展示到界面上
                        // 实体不一定是当前行
                        let parentPathData = {
                            path: [],
                            isUdt: false,
                            isGrid: false
                        };
                        if (validationError.target) {
                            parentPathData = validationError.target.getPaths();
                        }
                        const bindingPath = '/' + parentPathData.path.join('/');
                        if (validationError.constraints) {
                            Object.keys(validationError.constraints).forEach(key => {
                                errMsgObj[key] = {
                                    name: validationError.constraints[key]
                                };
                                // if (this.frameContext.viewModel.bindingPath === bindingPath) {
                                //   rootViewModel['verifyInformations'].push({
                                //     id: id,
                                //     title: key,
                                //     msg: validationError.constraints[key],
                                //     type: 'warn'
                                //   })
                                // }
                            });
                        }
                        const paths = parentPathData.path.concat(validationError.property);
                        //if (this.frameContext.viewModel.bindingPath === bindingPath) {
                        // 将错误信息更新到formControl上
                        formContext.bindingData.changes.next({
                            type: ChangeType.UpdateErrors,
                            id,
                            path: paths,
                            isUdt: parentPathData.isUdt,
                            isGrid: parentPathData.isGrid,
                            value: validationError.value,
                            errors: errMsgObj
                        });
                        //}
                    });
                };
                // 展开验证结果
                const isValidList = resultList.map((result) => result.isValid);
                // 保存前先调用实体上的验证规则，全部通过之后才保存
                // 实体验证通过
                if (isValidList.filter(x => x).length === observableList.length) {
                    // 将错误信息更新到formControl上
                    formContext.bindingData.changes.next({
                        type: ChangeType.UpdateErrors,
                        path: []
                    });
                    // 验证成功后隐藏输入时的验证
                    if (formValid) {
                        const bindingObject = formContext.bindingData.getObject();
                        bindingObject && bindingObject.setShowValidationMsg(false);
                        const form = formContext.form;
                        if (form) {
                            form.setShowValidationMsg(false);
                        }
                    }
                }
                else {
                    // 实体验证有错误
                    entityValid = false;
                    resultList.forEach((result) => {
                        if (result.isValid) {
                            // 清除验证通过的错误
                            formContext.bindingData.changes.next({
                                type: ChangeType.UpdateErrors,
                                path: []
                            });
                        }
                        else {
                            handleErrors(result.errors);
                        }
                    });
                }
            });
        }), switchMap((resultList) => {
            let isValidated = true;
            const errors = [];
            resultList.forEach((result) => {
                if (!result.isValid) {
                    isValidated = false;
                }
                errors.push(...result.errors);
            });
            if (errors.length > 0) {
                this.collectValidationErrors(rootViewModel, errors, this.frameContext.namespace);
            }
            // rootViewModel.verifycationChanged.next(rootViewModel.verifyInformations);
            let verifyInformations = rootViewModel.verifyInformations;
            if (isModal && hasOwnVerifyDetailService) {
                verifyInformations = rootViewModel.verifyInformations.filter(item => item.namespace === namespace);
            }
            rootViewModel.verifycationChanged.next(verifyInformations);
            if (isValidated && formValid) {
                return of(true);
            }
            else {
                return empty();
            }
        }));
        return result$;
    }
    /**
     * 调用表单和实体上的验证规则, 通过后调用回调cb
     */
    validateAll() {
        // 组合表单只校验当前按钮所在的表单
        const entities = this.repository.entityCollection.getAllEntities();
        const namespace = this.frameContext.namespace;
        let frameContexts = [];
        if (namespace !== null) {
            // 存在命名空间，说明表单较新，可以依赖该特性
            frameContexts = this.frameContext.appContext.frameContextManager.getFrameContextsByNamespace(namespace);
        }
        else {
            // 表单较老，获取所有的上下文，在校验阶段过滤规则
            frameContexts = this.frameContext.appContext.frameContextManager.getFrameContexts();
        }
        let toValidate = false;
        const formErrors = [];
        frameContexts.forEach((frameContext) => {
            if (frameContext.form && frameContext.form.enableValidate) {
                toValidate = true;
            }
        });
        if (!toValidate || entities.length < 1) {
            return of(true);
        }
        const isModal = this.isInDialog();
        const hasOwnVerifyDetailService = this.hasOwnVerifyDetailService();
        let rootViewModel = this.frameContext.root.viewModel;
        if (isModal && hasOwnVerifyDetailService) {
            rootViewModel = this.frameContext.getVirtualRootFrameContext().viewModel;
        }
        let formValid = true;
        let entityValid = true;
        const formValidationRules = new Map();
        frameContexts.forEach((formContext) => {
            const bindingObject = formContext.bindingData.getObject();
            // 通知所有bindingData,
            bindingObject && bindingObject.setShowValidationMsg(true);
            if (formContext.form && formContext.form.enableValidate) {
                // 获取当前表单上的所有验证规则
                const currentFormValidationRules = formContext.form.getValidationRules();
                currentFormValidationRules.forEach((rules, path) => {
                    if (formValidationRules.has(path)) {
                        rules.forEach(rule => formValidationRules.get(path).push(rule));
                    }
                    else {
                        formValidationRules.set(path, [...rules]);
                    }
                });
                formContext.form.setShowValidationMsg(true);
                // 逐个调用表单的验证，验证前端表单规则
                if (!formContext.form.isFormValid()) {
                    formErrors.push(formContext.form);
                    formValid = false;
                }
            }
        });
        // 触发所有实体的validate事件
        const isMultiEntityValiate = entities.length > 0;
        // 验证所有实体
        const observableList = entities.map((entity, index) => entity.validate(undefined, undefined, formValidationRules, isMultiEntityValiate ? index : null, this.frameContext));
        const result$ = zip(...observableList).pipe(tap((resultList) => {
            frameContexts.forEach((formContext) => {
                if (!formContext.form.enableValidate) {
                    return;
                }
                const handleErrors = (errors) => {
                    errors.forEach((validationError) => {
                        if (validationError.children && validationError.children.length) {
                            handleErrors(validationError.children);
                        }
                        const errMsgObj = {};
                        let id = '';
                        const findId = (target) => {
                            if (target && target.data && target.data.id) {
                                id = target.data.id;
                                return;
                            }
                            else if (target[PARENT_CLASS]) {
                                findId(target[PARENT_CLASS]);
                            }
                        };
                        findId(validationError.target);
                        // 实体验证出错，需要将错误展示到界面上
                        // 实体不一定是当前行
                        let parentPathData = {
                            path: [],
                            isUdt: false,
                            isGrid: false
                        };
                        if (validationError.target) {
                            parentPathData = validationError.target.getPaths();
                        }
                        const bindingPath = '/' + parentPathData.path.join('/');
                        if (validationError.constraints) {
                            Object.keys(validationError.constraints).forEach(key => {
                                errMsgObj[key] = {
                                    name: validationError.constraints[key]
                                };
                                // if (this.frameContext.viewModel.bindingPath === bindingPath) {
                                //   rootViewModel['verifyInformations'].push({
                                //     id: id,
                                //     title: key,
                                //     msg: validationError.constraints[key],
                                //     type: 'warn'
                                //   })
                                // }
                            });
                        }
                        const paths = parentPathData.path.concat(validationError.property);
                        //if (this.frameContext.viewModel.bindingPath === bindingPath) {
                        // 将错误信息更新到formControl上
                        formContext.bindingData.changes.next({
                            type: ChangeType.UpdateErrors,
                            id,
                            path: paths,
                            isUdt: parentPathData.isUdt,
                            isGrid: parentPathData.isGrid,
                            value: validationError.value,
                            errors: errMsgObj
                        });
                        //}
                    });
                };
                // 展开验证结果
                const isValidList = resultList.map((result) => result.isValid);
                // 保存前先调用实体上的验证规则，全部通过之后才保存
                // 实体验证通过
                if (isValidList.filter(x => x).length === observableList.length) {
                    // 将错误信息更新到formControl上
                    formContext.bindingData.changes.next({
                        type: ChangeType.UpdateErrors,
                        path: []
                    });
                    // 验证成功后隐藏输入时的验证
                    if (formValid) {
                        const bindingObject = formContext.bindingData.getObject();
                        bindingObject && bindingObject.setShowValidationMsg(false);
                        const form = formContext.form;
                        if (form) {
                            form.setShowValidationMsg(false);
                        }
                    }
                }
                else {
                    // 实体验证有错误
                    entityValid = false;
                    resultList.forEach((result) => {
                        if (result.isValid) {
                            // 清除验证通过的错误
                            formContext.bindingData.changes.next({
                                type: ChangeType.UpdateErrors,
                                path: []
                            });
                        }
                        else {
                            handleErrors(result.errors);
                        }
                    });
                }
            });
        }), switchMap((resultList) => {
            let isValidated = true;
            const errors = [];
            resultList.forEach((result) => {
                if (!result.isValid) {
                    isValidated = false;
                }
                errors.push(...result.errors);
            });
            if (errors.length > 0) {
                this.collectValidationErrors(rootViewModel, errors, this.frameContext.namespace);
            }
            let verifyInformations = rootViewModel.verifyInformations;
            if (isModal && hasOwnVerifyDetailService) {
                verifyInformations = rootViewModel.verifyInformations.filter(item => item.namespace === namespace);
            }
            // 因为校验累加的缘故，导致之前的校验信息一直存在，只能通过校验结果来确定是否还有错误信息
            if (isValidated && formValid) {
                verifyInformations = rootViewModel.verifyInformations = [];
            }
            rootViewModel.verifycationChanged.next(verifyInformations);
            if (isValidated && formValid) {
                return of(true);
            }
            else {
                return empty();
            }
        }));
        return result$;
    }
    collectValidationErrors(rootViewModel, errors, namespace, filter = true) {
        if (filter) {
            rootViewModel.verifyInformations = rootViewModel.verifyInformations.filter(item => item.namespace !== namespace);
        }
        errors.forEach((validationError) => {
            if (validationError.children && validationError.children.length) {
                this.collectValidationErrors(rootViewModel, validationError.children, namespace, false);
            }
            let id = '';
            const findId = (target) => {
                if (target && target.data && target.data.id) {
                    id = target.data.id;
                    return;
                }
                else if (target[PARENT_CLASS]) {
                    findId(target[PARENT_CLASS]);
                }
            };
            findId(validationError.target);
            if (validationError.constraints) {
                const validationResultTypes = Object.keys(validationError.constraints);
                if (validationResultTypes.length) {
                    const offset = rootViewModel.verifyInformations.filter(item => item.namespace === namespace).length;
                    let index = rootViewModel.verifyInformations.findIndex(item => item.namespace === namespace);
                    index = index === -1 ? 0 : index + offset;
                    rootViewModel.verifyInformations.splice(index, 0, {
                        id: id,
                        namespace,
                        targetField: validationError.field,
                        index: validationError.index,
                        title: validationError.propertyName,
                        msg: validationError.constraints[validationResultTypes[0]],
                        frameContext: validationError.frameContext,
                        fullPath: validationError.fullPath,
                        type: validationResultTypes[0] === 'required' ? 'empty' : 'error'
                    });
                }
            }
        });
    }
    /**
     * 重置校验信息（仅当前表单）
     */
    resetValidation() {
        const isDialog = this.isInDialog();
        let rootViewModel = this.frameContext.root.viewModel;
        if (isDialog) {
            rootViewModel = this.frameContext.getVirtualRootFrameContext().viewModel;
        }
        let verifyInformations = rootViewModel.verifyInformations;
        if (verifyInformations.length) {
            const namespace = this.frameContext.namespace;
            if (namespace !== null) {
                verifyInformations = rootViewModel.verifyInformations.filter(item => item.namespace !== namespace);
            }
            rootViewModel.verifyInformations = verifyInformations;
            //rootViewModel.verifyInformations.splice(0, rootViewModel.verifyInformations.length);
        }
        rootViewModel.verifycationChanged.next(verifyInformations);
        return of(null);
    }
    /**
     * 是否在弹窗内部
     */
    isInDialog() {
        return this.frameContext && this.frameContext.getVirtualRootFrameContext() && this.frameContext.getVirtualRootFrameContext().frameComponent && this.frameContext.getVirtualRootFrameContext().frameComponent['isDialogRootComponent'] || false;
    }
    /**
     * 拥有独自的校验提示服务
     */
    hasOwnVerifyDetailService() {
        return this.frameContext.injector.get(VerifyDetailService, null) !== this.frameContext.root.appContext.injector.get(VerifyDetailService, null);
        ;
    }
}
ValidationService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
ValidationService.ctorParameters = () => [
    { type: Repository },
    { type: FrameContext }
];
export { ValidationService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmFsaWRhdGlvbi5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL3ZhbGlkYXRpb24uc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxrQ0FBa0M7QUFDbEMsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsVUFBVSxFQUFVLFlBQVksRUFBRSxZQUFZLEVBQUUsVUFBVSxFQUE4RCxNQUFNLGdCQUFnQixDQUFDO0FBQ3hKLE9BQU8sRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDaEQsT0FBTyxFQUFjLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMzQyxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDMUMsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQzlDLE9BQU8sRUFBRSxFQUFFLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUN4QyxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUUvRDs7O0dBR0c7QUFFSCxNQUNNLGlCQUFpQjtJQUlyQjs7T0FFRztJQUNILFlBQ1UsVUFBMkIsRUFDM0IsWUFBMEI7UUFEMUIsZUFBVSxHQUFWLFVBQVUsQ0FBaUI7UUFDM0IsaUJBQVksR0FBWixZQUFZLENBQWM7UUFQNUIsc0JBQWlCLEdBQUcsSUFBSSxPQUFPLEVBQU8sQ0FBQztRQUN2Qyx3QkFBbUIsR0FBRyxJQUFJLE9BQU8sRUFBTyxDQUFDO0lBUWpELENBQUM7SUFFRDs7T0FFRztJQUNJLFFBQVE7UUFDYixJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sRUFBRSxDQUFDLFNBQVMsQ0FDakMsQ0FBQyxNQUFnQixFQUFFLEVBQUU7WUFDbkIsS0FBSyxNQUFNLE1BQU0sSUFBSSxNQUFNLEVBQUU7Z0JBQzNCLE1BQU0s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QUUsQ0FBQyxJQUFJLENBQUMsU0FBUyxLQUFLLFNBQVMsQ0FBQyxDQUFDO2FBQ3BHO1lBQ0QsYUFBYSxDQUFDLGtCQUFrQixHQUFHLGtCQUFrQixDQUFDO1lBQ3RELHNGQUFzRjtTQUN2RjtRQUNELGFBQWEsQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsQ0FBQztRQUMzRCxPQUFPLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNsQixDQUFDO0lBQ0Q7O09BRUc7SUFDSyxVQUFVO1FBQ2hCLE9BQU8sSUFBSSxDQUFDLFlBQVksSUFBSSxJQUFJLENBQUMsWUFBWSxDQUFDLDBCQUEwQixFQUFFLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQywwQkFBMEIsRUFBRSxDQUFDLGNBQWMsSUFBSSxJQUFJLENBQUMsWUFBWSxDQUFDLDBCQUEwQixFQUFFLENBQUMsY0FBYyxDQUFDLHVCQUF1QixDQUFDLElBQUksS0FBSyxDQUFDO0lBQ2pQLENBQUM7SUFDRDs7T0FFRztJQUNLLHlCQUF5QjtRQUMvQixPQUFPLElBQUksQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBc0IsbUJBQW1CLEVBQUUsSUFBSSxDQUFDLEtBQUssSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQXNCLG1CQUFtQixFQUFFLElBQUksQ0FBQyxDQUFDO1FBQUEsQ0FBQztJQUM1TCxDQUFDOzs7WUE3ZUYsVUFBVTs7OztZQWJGLFVBQVU7WUFBVSxZQUFZOztBQTZmekMsT0FBTyxFQUFFLGlCQUFpQixFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyB0c2xpbnQ6ZGlzYWJsZTogbWF4LWxpbmUtbGVuZ3RoXHJcbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgUmVwb3NpdG9yeSwgRW50aXR5LCBGcmFtZUNvbnRleHQsIFBBUkVOVF9DTEFTUywgQ2hhbmdlVHlwZSwgVmFsaWRhdGlvblJlc3VsdCwgVmFsaWRhdGlvbkVycm9yLCBWYWxpZGF0ZVJ1bGUsIFZpZXdNb2RlbCB9IGZyb20gJ0BmYXJyaXMvZGV2a2l0JztcclxuaW1wb3J0IHsgdGFwLCBzd2l0Y2hNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IE9ic2VydmFibGUsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgemlwIH0gZnJvbSAncnhqcy9vYnNlcnZhYmxlL3ppcCc7XHJcbmltcG9ydCB7IGVtcHR5IH0gZnJvbSAncnhqcy9vYnNlcnZhYmxlL2VtcHR5JztcclxuaW1wb3J0IHsgb2YgfSBmcm9tICdyeGpzL29ic2VydmFibGUvb2YnO1xyXG5pbXBvcnQgeyBWZXJpZnlEZXRhaWxTZXJ2aWNlIH0gZnJvbSAnQGZhcnJpcy91aS12ZXJpZnktZGV0YWlsJztcclxuXHJcbi8qKlxyXG4gKiDooajljZXpqozor4HmnI3liqFcclxuICogQHNjb3BlIEZyYW1lQ29tcG9uZW50XHJcbiAqL1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5jbGFzcyBWYWxpZGF0aW9uU2VydmljZSB7XHJcblxyXG4gIHByaXZhdGUgdmFsaWRhdGlvblJlc3VsdHMgPSBuZXcgU3ViamVjdDxhbnk+KCk7XHJcbiAgcHJpdmF0ZSB2YWxpZGF0aW9uQWxsUmVzdWx0ID0gbmV3IFN1YmplY3Q8YW55PigpO1xyXG4gIC8qKlxyXG4gICAqIOaehOmAoOWHveaVsFxyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJpdmF0ZSByZXBvc2l0b3J5OiBSZXBvc2l0b3J5PGFueT4sXHJcbiAgICBwcml2YXRlIGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0XHJcbiAgKSB7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDpqozor4HooajljZXlhoXnmoTmiYDmnInooajljZVcclxuICAgKi9cclxuICBwdWJsaWMgdmFsaWRhdGUoKSB7XHJcbiAgICB0aGlzLnJlcG9zaXRvcnkuZ2V0TGlzdCgpLnN1YnNjcmliZShcclxuICAgICAgKHJlc3VsdDogRW50aXR5W10pID0+IHtcclxuICAgICAgICBmb3IgKGNvbnN0IGVudGl0eSBvZiByZXN1bHQpIHtcclxuICAgICAgICAgIGVudGl0eS52YWxpZGF0ZSgpLnN1YnNjcmliZSgocmVzdWx0OiBWYWxpZGF0aW9uUmVzdWx0KSA9PiB7XHJcbiAgICAgICAgICAgIGlmICghcmVzdWx0LmlzVmFsaWQpIHtcclxuICAgICAgICAgICAgICBhbGVydChyZXN1bHQubWVzc2FnZSk7XHJcbiAgICAgICAgICAgICAgdGhpcy52YWxpZGF0aW9uUmVzdWx0cy5uZXh0KHJlc3VsdCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgKTtcclxuICAgIHJldHVybiB0aGlzLnZhbGlkYXRpb25SZXN1bHRzO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmoKHpqozlvZPliY3ooYxcclxuICAgKi9cclxuICBwdWJsaWMgdmFsaWRhdGVDdXJyZW50Um93KCk6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICAvLyDnu4TlkIjooajljZXlj6rmoKHpqozlvZPliY3mjInpkq7miYDlnKjnmoTooajljZVcclxuICAgIGNvbnN0IHByaW1hcnlWYWx1ZSA9IHRoaXMuZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhLmxpc3QuY3VycmVudElkO1xyXG4gICAgY29uc3QgZW50aXRpZXM6IEVudGl0eVtdID0gW3RoaXMucmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLmdldEVudGl0eUJ5SWQocHJpbWFyeVZhbHVlKV07XHJcbiAgICBjb25zdCBuYW1lc3BhY2UgPSB0aGlzLmZyYW1lQ29udGV4dC5uYW1lc3BhY2U7XHJcbiAgICBsZXQgZnJhbWVDb250ZXh0cyA9IFtdO1xyXG4gICAgaWYgKG5hbWVzcGFjZSkge1xyXG4gICAgICAvLyDlrZjlnKjlkb3lkI3nqbrpl7TvvIzor7TmmI7ooajljZXovoPmlrDvvIzlj6/ku6Xkvp3otZbor6XnibnmgKdcclxuICAgICAgZnJhbWVDb250ZXh0cyA9IHRoaXMuZnJhbWVDb250ZXh0LmFwcENvbnRleHQuZnJhbWVDb250ZXh0TWFuYWdlci5nZXRGcmFtZUNvbnRleHRzQnlOYW1lc3BhY2UobmFtZXNwYWNlKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIC8vIOihqOWNlei+g+iAge+8jOiOt+WPluaJgOacieeahOS4iuS4i+aWh++8jOWcqOagoemqjOmYtuautei/h+a7pOinhOWImVxyXG4gICAgICBmcmFtZUNvbnRleHRzID0gdGhpcy5mcmFtZUNvbnRleHQuYXBwQ29udGV4dC5mcmFtZUNvbnRleHRNYW5hZ2VyLmdldEZyYW1lQ29udGV4dHMoKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBpc01vZGFsID0gdGhpcy5pc0luRGlhbG9nKCk7XHJcbiAgICBjb25zdCBoYXNPd25WZXJpZnlEZXRhaWxTZXJ2aWNlID0gdGhpcy5oYXNPd25WZXJpZnlEZXRhaWxTZXJ2aWNlKCk7XHJcbiAgICBsZXQgcm9vdFZpZXdNb2RlbCA9IHRoaXMuZnJhbWVDb250ZXh0LnJvb3Qudmlld01vZGVsO1xyXG4gICAgaWYgKGlzTW9kYWwgJiYgaGFzT3duVmVyaWZ5RGV0YWlsU2VydmljZSkge1xyXG4gICAgICByb290Vmlld01vZGVsID0gdGhpcy5mcmFtZUNvbnRleHQuZ2V0VmlydHVhbFJvb3RGcmFtZUNvbnRleHQoKS52aWV3TW9kZWw7XHJcbiAgICB9XHJcblxyXG4gICAgbGV0IHRvVmFsaWRhdGUgPSBmYWxzZTtcclxuICAgIGNvbnN0IGZvcm1FcnJvcnMgPSBbXTtcclxuICAgIGZyYW1lQ29udGV4dHMuZm9yRWFjaCgoZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQpID0+IHtcclxuICAgICAgaWYgKGZyYW1lQ29udGV4dC5mb3JtICYmIGZyYW1lQ29udGV4dC5mb3JtLmVuYWJsZVZhbGlkYXRlKSB7XHJcbiAgICAgICAgdG9WYWxpZGF0ZSA9IHRydWU7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgaWYgKCF0b1ZhbGlkYXRlIHx8IGVudGl0aWVzLmxlbmd0aCA8IDEpIHtcclxuICAgICAgcmV0dXJuIG9mKHRydWUpO1xyXG4gICAgfVxyXG4gICAgcm9vdFZpZXdNb2RlbC52ZXJpZnlJbmZvcm1hdGlvbnMgPSBbXTtcclxuICAgIGxldCBmb3JtVmFsaWQgPSB0cnVlO1xyXG4gICAgbGV0IGVudGl0eVZhbGlkID0gdHJ1ZTtcclxuICAgIGNvbnN0IGZvcm1WYWxpZGF0aW9uUnVsZXMgPSBuZXcgTWFwPHN0cmluZywgVmFsaWRhdGVSdWxlW10+KCk7XHJcbiAgICBmcmFtZUNvbnRleHRzLmZvckVhY2goKGZvcm1Db250ZXh0OiBGcmFtZUNvbnRleHQpID0+IHtcclxuICAgICAgY29uc3QgYmluZGluZ09iamVjdCA9IGZvcm1Db250ZXh0LmJpbmRpbmdEYXRhLmdldE9iamVjdCgpO1xyXG4gICAgICAvLyDpgJrnn6XmiYDmnIliaW5kaW5nRGF0YSxcclxuICAgICAgYmluZGluZ09iamVjdCAmJiBiaW5kaW5nT2JqZWN0LnNldFNob3dWYWxpZGF0aW9uTXNnKHRydWUpO1xyXG4gICAgICBpZiAoZm9ybUNvbnRleHQuZm9ybSAmJiBmb3JtQ29udGV4dC5mb3JtLmVuYWJsZVZhbGlkYXRlKSB7XHJcbiAgICAgICAgLy8g6I635Y+W5b2T5YmN6KGo5Y2V5LiK55qE5omA5pyJ6aqM6K+B6KeE5YiZXHJcbiAgICAgICAgY29uc3QgY3VycmVudEZvcm1WYWxpZGF0aW9uUnVsZXMgPSBmb3JtQ29udGV4dC5mb3JtLmdldFZhbGlkYXRpb25SdWxlcygpO1xyXG4gICAgICAgIGN1cnJlbnRGb3JtVmFsaWRhdGlvblJ1bGVzLmZvckVhY2goKHJ1bGVzLCBwYXRoKSA9PiB7XHJcbiAgICAgICAgICBpZiAoZm9ybVZhbGlkYXRpb25SdWxlcy5oYXMocGF0aCkpIHtcclxuICAgICAgICAgICAgcnVsZXMuZm9yRWFjaChydWxlID0+IGZvcm1WYWxpZGF0aW9uUnVsZXMuZ2V0KHBhdGgpLnB1c2gocnVsZSkpO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgZm9ybVZhbGlkYXRpb25SdWxlcy5zZXQocGF0aCwgWy4uLnJ1bGVzXSk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgZm9ybUNvbnRleHQuZm9ybS5zZXRTaG93VmFsaWRhdGlvbk1zZyh0cnVlKTtcclxuICAgICAgICAvLyDpgJDkuKrosIPnlKjooajljZXnmoTpqozor4HvvIzpqozor4HliY3nq6/ooajljZXop4TliJlcclxuICAgICAgICBpZiAoIWZvcm1Db250ZXh0LmZvcm0uaXNGb3JtVmFsaWQoKSkge1xyXG4gICAgICAgICAgZm9ybUVycm9ycy5wdXNoKGZvcm1Db250ZXh0LmZvcm0pO1xyXG4gICAgICAgICAgZm9ybVZhbGlkID0gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgICAvLyDpqozor4HmiYDmnInlrp7kvZNcclxuICAgIGNvbnN0IG9ic2VydmFibGVMaXN0ID0gZW50aXRpZXMubWFwKChlbnRpdHk6IEVudGl0eSkgPT4ge1xyXG4gICAgICBjb25zdCBpbmRleCA9IHRoaXMuZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhLmxpc3QuZ2V0SW5kZXhCeUlkKGVudGl0eS5wcmltYXJ5VmFsdWUpO1xyXG4gICAgICByZXR1cm4gZW50aXR5LnZhbGlkYXRlKHVuZGVmaW5lZCwgdW5kZWZpbmVkLCBmb3JtVmFsaWRhdGlvblJ1bGVzLCBudWxsLCB0aGlzLmZyYW1lQ29udGV4dCk7XHJcbiAgICB9KTtcclxuICAgIGNvbnN0IHJlc3VsdCQgPSB6aXAoLi4ub2JzZXJ2YWJsZUxpc3QpLnBpcGUoXHJcbiAgICAgIHRhcCgocmVzdWx0TGlzdCkgPT4ge1xyXG4gICAgICAgIGZyYW1lQ29udGV4dHMuZm9yRWFjaCgoZm9ybUNvbnRleHQ6IEZyYW1lQ29udGV4dCkgPT4ge1xyXG4gICAgICAgICAgaWYgKCFmb3JtQ29udGV4dC5mb3JtLmVuYWJsZVZhbGlkYXRlKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGNvbnN0IGhhbmRsZUVycm9ycyA9IChlcnJvcnM6IFZhbGlkYXRpb25FcnJvcltdKSA9PiB7XHJcbiAgICAgICAgICAgIGVycm9ycy5mb3JFYWNoKCh2YWxpZGF0aW9uRXJyb3I6IFZhbGlkYXRpb25FcnJvcikgPT4ge1xyXG4gICAgICAgICAgICAgIGlmICh2YWxpZGF0aW9uRXJyb3IuY2hpbGRyZW4gJiYgdmFsaWRhdGlvbkVycm9yLmNoaWxkcmVuLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgaGFuZGxlRXJyb3JzKHZhbGlkYXRpb25FcnJvci5jaGlsZHJlbik7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIGNvbnN0IGVyck1zZ09iaiA9IHt9O1xyXG4gICAgICAgICAgICAgIGxldCBpZCA9ICcnO1xyXG4gICAgICAgICAgICAgIGNvbnN0IGZpbmRJZCA9ICh0YXJnZXQ6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKHRhcmdldCAmJiB0YXJnZXQuZGF0YSAmJiB0YXJnZXQuZGF0YS5pZCkge1xyXG4gICAgICAgICAgICAgICAgICBpZCA9IHRhcmdldC5kYXRhLmlkO1xyXG4gICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRhcmdldFtQQVJFTlRfQ0xBU1NdKSB7XHJcbiAgICAgICAgICAgICAgICAgIGZpbmRJZCh0YXJnZXRbUEFSRU5UX0NMQVNTXSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICBmaW5kSWQodmFsaWRhdGlvbkVycm9yLnRhcmdldCk7XHJcblxyXG4gICAgICAgICAgICAgIC8vIOWunuS9k+mqjOivgeWHuumUme+8jOmcgOimgeWwhumUmeivr+WxleekuuWIsOeVjOmdouS4ilxyXG4gICAgICAgICAgICAgIC8vIOWunuS9k+S4jeS4gOWumuaYr+W9k+WJjeihjFxyXG4gICAgICAgICAgICAgIGxldCBwYXJlbnRQYXRoRGF0YSA9IHtcclxuICAgICAgICAgICAgICAgIHBhdGg6IFtdLFxyXG4gICAgICAgICAgICAgICAgaXNVZHQ6IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgaXNHcmlkOiBmYWxzZVxyXG4gICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgaWYgKHZhbGlkYXRpb25FcnJvci50YXJnZXQpIHtcclxuICAgICAgICAgICAgICAgIHBhcmVudFBhdGhEYXRhID0gdmFsaWRhdGlvbkVycm9yLnRhcmdldC5nZXRQYXRocygpO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICBjb25zdCBiaW5kaW5nUGF0aCA9ICcvJyArIHBhcmVudFBhdGhEYXRhLnBhdGguam9pbignLycpO1xyXG4gICAgICAgICAgICAgIGlmICh2YWxpZGF0aW9uRXJyb3IuY29uc3RyYWludHMpIHtcclxuICAgICAgICAgICAgICAgIE9iamVjdC5rZXlzKHZhbGlkYXRpb25FcnJvci5jb25zdHJhaW50cykuZm9yRWFjaChrZXkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICBlcnJNc2dPYmpba2V5XSA9IHtcclxuICAgICAgICAgICAgICAgICAgICBuYW1lOiB2YWxpZGF0aW9uRXJyb3IuY29uc3RyYWludHNba2V5XVxyXG4gICAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgICAvLyBpZiAodGhpcy5mcmFtZUNvbnRleHQudmlld01vZGVsLmJpbmRpbmdQYXRoID09PSBiaW5kaW5nUGF0aCkge1xyXG4gICAgICAgICAgICAgICAgICAvLyAgIHJvb3RWaWV3TW9kZWxbJ3ZlcmlmeUluZm9ybWF0aW9ucyddLnB1c2goe1xyXG4gICAgICAgICAgICAgICAgICAvLyAgICAgaWQ6IGlkLFxyXG4gICAgICAgICAgICAgICAgICAvLyAgICAgdGl0bGU6IGtleSxcclxuICAgICAgICAgICAgICAgICAgLy8gICAgIG1zZzogdmFsaWRhdGlvbkVycm9yLmNvbnN0cmFpbnRzW2tleV0sXHJcbiAgICAgICAgICAgICAgICAgIC8vICAgICB0eXBlOiAnd2FybidcclxuICAgICAgICAgICAgICAgICAgLy8gICB9KVxyXG4gICAgICAgICAgICAgICAgICAvLyB9XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgY29uc3QgcGF0aHMgPSBwYXJlbnRQYXRoRGF0YS5wYXRoLmNvbmNhdCh2YWxpZGF0aW9uRXJyb3IucHJvcGVydHkpO1xyXG5cclxuICAgICAgICAgICAgICAvL2lmICh0aGlzLmZyYW1lQ29udGV4dC52aWV3TW9kZWwuYmluZGluZ1BhdGggPT09IGJpbmRpbmdQYXRoKSB7XHJcbiAgICAgICAgICAgICAgLy8g5bCG6ZSZ6K+v5L+h5oGv5pu05paw5YiwZm9ybUNvbnRyb2zkuIpcclxuICAgICAgICAgICAgICBmb3JtQ29udGV4dC5iaW5kaW5nRGF0YS5jaGFuZ2VzLm5leHQoe1xyXG4gICAgICAgICAgICAgICAgdHlwZTogQ2hhbmdlVHlwZS5VcGRhdGVFcnJvcnMsXHJcbiAgICAgICAgICAgICAgICBpZCxcclxuICAgICAgICAgICAgICAgIHBhdGg6IHBhdGhzLFxyXG4gICAgICAgICAgICAgICAgaXNVZHQ6IHBhcmVudFBhdGhEYXRhLmlzVWR0LFxyXG4gICAgICAgICAgICAgICAgaXNHcmlkOiBwYXJlbnRQYXRoRGF0YS5pc0dyaWQsXHJcbiAgICAgICAgICAgICAgICB2YWx1ZTogdmFsaWRhdGlvbkVycm9yLnZhbHVlLFxyXG4gICAgICAgICAgICAgICAgZXJyb3JzOiBlcnJNc2dPYmpcclxuICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAvL31cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICB9O1xyXG4gICAgICAgICAgLy8g5bGV5byA6aqM6K+B57uT5p6cXHJcbiAgICAgICAgICBjb25zdCBpc1ZhbGlkTGlzdCA9IHJlc3VsdExpc3QubWFwKChyZXN1bHQ6IFZhbGlkYXRpb25SZXN1bHQpID0+IHJlc3VsdC5pc1ZhbGlkKTtcclxuICAgICAgICAgIC8vIOS/neWtmOWJjeWFiOiwg+eUqOWunuS9k+S4iueahOmqjOivgeinhOWIme+8jOWFqOmDqOmAmui/h+S5i+WQjuaJjeS/neWtmFxyXG4gICAgICAgICAgLy8g5a6e5L2T6aqM6K+B6YCa6L+HXHJcbiAgICAgICAgICBpZiAoaXNWYWxpZExpc3QuZmlsdGVyKHggPT4geCkubGVuZ3RoID09PSBvYnNlcnZhYmxlTGlzdC5sZW5ndGgpIHtcclxuICAgICAgICAgICAgLy8g5bCG6ZSZ6K+v5L+h5oGv5pu05paw5YiwZm9ybUNvbnRyb2zkuIpcclxuICAgICAgICAgICAgZm9ybUNvbnRleHQuYmluZGluZ0RhdGEuY2hhbmdlcy5uZXh0KHtcclxuICAgICAgICAgICAgICB0eXBlOiBDaGFuZ2VUeXBlLlVwZGF0ZUVycm9ycyxcclxuICAgICAgICAgICAgICBwYXRoOiBbXVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgLy8g6aqM6K+B5oiQ5Yqf5ZCO6ZqQ6JeP6L6T5YWl5pe255qE6aqM6K+BXHJcbiAgICAgICAgICAgIGlmIChmb3JtVmFsaWQpIHtcclxuICAgICAgICAgICAgICBjb25zdCBiaW5kaW5nT2JqZWN0ID0gZm9ybUNvbnRleHQuYmluZGluZ0RhdGEuZ2V0T2JqZWN0KCk7XHJcbiAgICAgICAgICAgICAgYmluZGluZ09iamVjdCAmJiBiaW5kaW5nT2JqZWN0LnNldFNob3dWYWxpZGF0aW9uTXNnKGZhbHNlKTtcclxuICAgICAgICAgICAgICBjb25zdCBmb3JtID0gZm9ybUNvbnRleHQuZm9ybTtcclxuICAgICAgICAgICAgICBpZiAoZm9ybSkge1xyXG4gICAgICAgICAgICAgICAgZm9ybS5zZXRTaG93VmFsaWRhdGlvbk1zZyhmYWxzZSk7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAvLyDlrp7kvZPpqozor4HmnInplJnor69cclxuICAgICAgICAgICAgZW50aXR5VmFsaWQgPSBmYWxzZTtcclxuICAgICAgICAgICAgcmVzdWx0TGlzdC5mb3JFYWNoKChyZXN1bHQ6IFZhbGlkYXRpb25SZXN1bHQpID0+IHtcclxuICAgICAgICAgICAgICBpZiAocmVzdWx0LmlzVmFsaWQpIHtcclxuICAgICAgICAgICAgICAgIC8vIOa4hemZpOmqjOivgemAmui/h+eahOmUmeivr1xyXG4gICAgICAgICAgICAgICAgZm9ybUNvbnRleHQuYmluZGluZ0RhdGEuY2hhbmdlcy5uZXh0KHtcclxuICAgICAgICAgICAgICAgICAgdHlwZTogQ2hhbmdlVHlwZS5VcGRhdGVFcnJvcnMsXHJcbiAgICAgICAgICAgICAgICAgIHBhdGg6IFtdXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgaGFuZGxlRXJyb3JzKHJlc3VsdC5lcnJvcnMpO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0pLFxyXG4gICAgICBzd2l0Y2hNYXAoKHJlc3VsdExpc3QpID0+IHtcclxuICAgICAgICBsZXQgaXNWYWxpZGF0ZWQgPSB0cnVlO1xyXG4gICAgICAgIGNvbnN0IGVycm9ycyA9IFtdO1xyXG4gICAgICAgIHJlc3VsdExpc3QuZm9yRWFjaCgocmVzdWx0OiBWYWxpZGF0aW9uUmVzdWx0KSA9PiB7XHJcbiAgICAgICAgICBpZiAoIXJlc3VsdC5pc1ZhbGlkKSB7XHJcbiAgICAgICAgICAgIGlzVmFsaWRhdGVkID0gZmFsc2U7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBlcnJvcnMucHVzaCguLi5yZXN1bHQuZXJyb3JzKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBpZiAoZXJyb3JzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgIHRoaXMuY29sbGVjdFZhbGlkYXRpb25FcnJvcnMocm9vdFZpZXdNb2RlbCwgZXJyb3JzLCB0aGlzLmZyYW1lQ29udGV4dC5uYW1lc3BhY2UpO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyByb290Vmlld01vZGVsLnZlcmlmeWNhdGlvbkNoYW5nZWQubmV4dChyb290Vmlld01vZGVsLnZlcmlmeUluZm9ybWF0aW9ucyk7XHJcbiAgICAgICAgbGV0IHZlcmlmeUluZm9ybWF0aW9ucyA9IHJvb3RWaWV3TW9kZWwudmVyaWZ5SW5mb3JtYXRpb25zO1xyXG4gICAgICAgIGlmIChpc01vZGFsICYmIGhhc093blZlcmlmeURldGFpbFNlcnZpY2UpIHtcclxuICAgICAgICAgIHZlcmlmeUluZm9ybWF0aW9ucyA9IHJvb3RWaWV3TW9kZWwudmVyaWZ5SW5mb3JtYXRpb25zLmZpbHRlcihpdGVtID0+IGl0ZW0ubmFtZXNwYWNlID09PSBuYW1lc3BhY2UpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByb290Vmlld01vZGVsLnZlcmlmeWNhdGlvbkNoYW5nZWQubmV4dCh2ZXJpZnlJbmZvcm1hdGlvbnMpO1xyXG4gICAgICAgIGlmIChpc1ZhbGlkYXRlZCAmJiBmb3JtVmFsaWQpIHtcclxuICAgICAgICAgIHJldHVybiBvZih0cnVlKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgcmV0dXJuIGVtcHR5KCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICAgIHJldHVybiByZXN1bHQkO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDosIPnlKjooajljZXlkozlrp7kvZPkuIrnmoTpqozor4Hop4TliJksIOmAmui/h+WQjuiwg+eUqOWbnuiwg2NiXHJcbiAgICovXHJcbiAgdmFsaWRhdGVBbGwoKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIC8vIOe7hOWQiOihqOWNleWPquagoemqjOW9k+WJjeaMiemSruaJgOWcqOeahOihqOWNlVxyXG4gICAgY29uc3QgZW50aXRpZXM6IEVudGl0eVtdID0gdGhpcy5yZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24uZ2V0QWxsRW50aXRpZXMoKTtcclxuICAgIGNvbnN0IG5hbWVzcGFjZSA9IHRoaXMuZnJhbWVDb250ZXh0Lm5hbWVzcGFjZTtcclxuICAgIGxldCBmcmFtZUNvbnRleHRzID0gW107XHJcbiAgICBpZiAobmFtZXNwYWNlICE9PSBudWxsKSB7XHJcbiAgICAgIC8vIOWtmOWcqOWRveWQjeepuumXtO+8jOivtOaYjuihqOWNlei+g+aWsO+8jOWPr+S7peS+nei1luivpeeJueaAp1xyXG4gICAgICBmcmFtZUNvbnRleHRzID0gdGhpcy5mcmFtZUNvbnRleHQuYXBwQ29udGV4dC5mcmFtZUNvbnRleHRNYW5hZ2VyLmdldEZyYW1lQ29udGV4dHNCeU5hbWVzcGFjZShuYW1lc3BhY2UpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgLy8g6KGo5Y2V6L6D6ICB77yM6I635Y+W5omA5pyJ55qE5LiK5LiL5paH77yM5Zyo5qCh6aqM6Zi25q616L+H5ruk6KeE5YiZXHJcbiAgICAgIGZyYW1lQ29udGV4dHMgPSB0aGlzLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0LmZyYW1lQ29udGV4dE1hbmFnZXIuZ2V0RnJhbWVDb250ZXh0cygpO1xyXG4gICAgfVxyXG5cclxuICAgIGxldCB0b1ZhbGlkYXRlID0gZmFsc2U7XHJcbiAgICBjb25zdCBmb3JtRXJyb3JzID0gW107XHJcbiAgICBmcmFtZUNvbnRleHRzLmZvckVhY2goKGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0KSA9PiB7XHJcbiAgICAgIGlmIChmcmFtZUNvbnRleHQuZm9ybSAmJiBmcmFtZUNvbnRleHQuZm9ybS5lbmFibGVWYWxpZGF0ZSkge1xyXG4gICAgICAgIHRvVmFsaWRhdGUgPSB0cnVlO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICAgIGlmICghdG9WYWxpZGF0ZSB8fCBlbnRpdGllcy5sZW5ndGggPCAxKSB7XHJcbiAgICAgIHJldHVybiBvZih0cnVlKTtcclxuICAgIH1cclxuICAgIGNvbnN0IGlzTW9kYWwgPSB0aGlzLmlzSW5EaWFsb2coKTtcclxuICAgIGNvbnN0IGhhc093blZlcmlmeURldGFpbFNlcnZpY2UgPSB0aGlzLmhhc093blZlcmlmeURldGFpbFNlcnZpY2UoKTtcclxuICAgIGxldCByb290Vmlld01vZGVsID0gdGhpcy5mcmFtZUNvbnRleHQucm9vdC52aWV3TW9kZWw7XHJcbiAgICBpZiAoaXNNb2RhbCAmJiBoYXNPd25WZXJpZnlEZXRhaWxTZXJ2aWNlKSB7XHJcbiAgICAgIHJvb3RWaWV3TW9kZWwgPSB0aGlzLmZyYW1lQ29udGV4dC5nZXRWaXJ0dWFsUm9vdEZyYW1lQ29udGV4dCgpLnZpZXdNb2RlbDtcclxuICAgIH1cclxuXHJcbiAgICBsZXQgZm9ybVZhbGlkID0gdHJ1ZTtcclxuICAgIGxldCBlbnRpdHlWYWxpZCA9IHRydWU7XHJcbiAgICBjb25zdCBmb3JtVmFsaWRhdGlvblJ1bGVzID0gbmV3IE1hcDxzdHJpbmcsIFZhbGlkYXRlUnVsZVtdPigpO1xyXG4gICAgZnJhbWVDb250ZXh0cy5mb3JFYWNoKChmb3JtQ29udGV4dDogRnJhbWVDb250ZXh0KSA9PiB7XHJcbiAgICAgIGNvbnN0IGJpbmRpbmdPYmplY3QgPSBmb3JtQ29udGV4dC5iaW5kaW5nRGF0YS5nZXRPYmplY3QoKTtcclxuICAgICAgLy8g6YCa55+l5omA5pyJYmluZGluZ0RhdGEsXHJcbiAgICAgIGJpbmRpbmdPYmplY3QgJiYgYmluZGluZ09iamVjdC5zZXRTaG93VmFsaWRhdGlvbk1zZyh0cnVlKTtcclxuICAgICAgaWYgKGZvcm1Db250ZXh0LmZvcm0gJiYgZm9ybUNvbnRleHQuZm9ybS5lbmFibGVWYWxpZGF0ZSkge1xyXG4gICAgICAgIC8vIOiOt+WPluW9k+WJjeihqOWNleS4iueahOaJgOaciemqjOivgeinhOWImVxyXG4gICAgICAgIGNvbnN0IGN1cnJlbnRGb3JtVmFsaWRhdGlvblJ1bGVzID0gZm9ybUNvbnRleHQuZm9ybS5nZXRWYWxpZGF0aW9uUnVsZXMoKTtcclxuICAgICAgICBjdXJyZW50Rm9ybVZhbGlkYXRpb25SdWxlcy5mb3JFYWNoKChydWxlcywgcGF0aCkgPT4ge1xyXG4gICAgICAgICAgaWYgKGZvcm1WYWxpZGF0aW9uUnVsZXMuaGFzKHBhdGgpKSB7XHJcbiAgICAgICAgICAgIHJ1bGVzLmZvckVhY2gocnVsZSA9PiBmb3JtVmFsaWRhdGlvblJ1bGVzLmdldChwYXRoKS5wdXNoKHJ1bGUpKTtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGZvcm1WYWxpZGF0aW9uUnVsZXMuc2V0KHBhdGgsIFsuLi5ydWxlc10pO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGZvcm1Db250ZXh0LmZvcm0uc2V0U2hvd1ZhbGlkYXRpb25Nc2codHJ1ZSk7XHJcbiAgICAgICAgLy8g6YCQ5Liq6LCD55So6KGo5Y2V55qE6aqM6K+B77yM6aqM6K+B5YmN56uv6KGo5Y2V6KeE5YiZXHJcbiAgICAgICAgaWYgKCFmb3JtQ29udGV4dC5mb3JtLmlzRm9ybVZhbGlkKCkpIHtcclxuICAgICAgICAgIGZvcm1FcnJvcnMucHVzaChmb3JtQ29udGV4dC5mb3JtKTtcclxuICAgICAgICAgIGZvcm1WYWxpZCA9IGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICAvLyDop6blj5HmiYDmnInlrp7kvZPnmoR2YWxpZGF0ZeS6i+S7tlxyXG4gICAgY29uc3QgaXNNdWx0aUVudGl0eVZhbGlhdGUgPSBlbnRpdGllcy5sZW5ndGggPiAwO1xyXG5cclxuICAgIC8vIOmqjOivgeaJgOacieWunuS9k1xyXG4gICAgY29uc3Qgb2JzZXJ2YWJsZUxpc3QgPSBlbnRpdGllcy5tYXAoKGVudGl0eTogRW50aXR5LCBpbmRleDogbnVtYmVyKSA9PlxyXG4gICAgICBlbnRpdHkudmFsaWRhdGUodW5kZWZpbmVkLCB1bmRlZmluZWQsIGZvcm1WYWxpZGF0aW9uUnVsZXMsIGlzTXVsdGlFbnRpdHlWYWxpYXRlID8gaW5kZXggOiBudWxsLCB0aGlzLmZyYW1lQ29udGV4dCkpO1xyXG4gICAgY29uc3QgcmVzdWx0JCA9IHppcCguLi5vYnNlcnZhYmxlTGlzdCkucGlwZShcclxuICAgICAgdGFwKChyZXN1bHRMaXN0KSA9PiB7XHJcbiAgICAgICAgZnJhbWVDb250ZXh0cy5mb3JFYWNoKChmb3JtQ29udGV4dDogRnJhbWVDb250ZXh0KSA9PiB7XHJcbiAgICAgICAgICBpZiAoIWZvcm1Db250ZXh0LmZvcm0uZW5hYmxlVmFsaWRhdGUpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgY29uc3QgaGFuZGxlRXJyb3JzID0gKGVycm9yczogVmFsaWRhdGlvbkVycm9yW10pID0+IHtcclxuICAgICAgICAgICAgZXJyb3JzLmZvckVhY2goKHZhbGlkYXRpb25FcnJvcjogVmFsaWRhdGlvbkVycm9yKSA9PiB7XHJcbiAgICAgICAgICAgICAgaWYgKHZhbGlkYXRpb25FcnJvci5jaGlsZHJlbiAmJiB2YWxpZGF0aW9uRXJyb3IuY2hpbGRyZW4ubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICBoYW5kbGVFcnJvcnModmFsaWRhdGlvbkVycm9yLmNoaWxkcmVuKTtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgY29uc3QgZXJyTXNnT2JqID0ge307XHJcbiAgICAgICAgICAgICAgbGV0IGlkID0gJyc7XHJcbiAgICAgICAgICAgICAgY29uc3QgZmluZElkID0gKHRhcmdldDogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAodGFyZ2V0ICYmIHRhcmdldC5kYXRhICYmIHRhcmdldC5kYXRhLmlkKSB7XHJcbiAgICAgICAgICAgICAgICAgIGlkID0gdGFyZ2V0LmRhdGEuaWQ7XHJcbiAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGFyZ2V0W1BBUkVOVF9DTEFTU10pIHtcclxuICAgICAgICAgICAgICAgICAgZmluZElkKHRhcmdldFtQQVJFTlRfQ0xBU1NdKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgIGZpbmRJZCh2YWxpZGF0aW9uRXJyb3IudGFyZ2V0KTtcclxuXHJcbiAgICAgICAgICAgICAgLy8g5a6e5L2T6aqM6K+B5Ye66ZSZ77yM6ZyA6KaB5bCG6ZSZ6K+v5bGV56S65Yiw55WM6Z2i5LiKXHJcbiAgICAgICAgICAgICAgLy8g5a6e5L2T5LiN5LiA5a6a5piv5b2T5YmN6KGMXHJcbiAgICAgICAgICAgICAgbGV0IHBhcmVudFBhdGhEYXRhID0ge1xyXG4gICAgICAgICAgICAgICAgcGF0aDogW10sXHJcbiAgICAgICAgICAgICAgICBpc1VkdDogZmFsc2UsXHJcbiAgICAgICAgICAgICAgICBpc0dyaWQ6IGZhbHNlXHJcbiAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICBpZiAodmFsaWRhdGlvbkVycm9yLnRhcmdldCkge1xyXG4gICAgICAgICAgICAgICAgcGFyZW50UGF0aERhdGEgPSB2YWxpZGF0aW9uRXJyb3IudGFyZ2V0LmdldFBhdGhzKCk7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIGNvbnN0IGJpbmRpbmdQYXRoID0gJy8nICsgcGFyZW50UGF0aERhdGEucGF0aC5qb2luKCcvJyk7XHJcbiAgICAgICAgICAgICAgaWYgKHZhbGlkYXRpb25FcnJvci5jb25zdHJhaW50cykge1xyXG4gICAgICAgICAgICAgICAgT2JqZWN0LmtleXModmFsaWRhdGlvbkVycm9yLmNvbnN0cmFpbnRzKS5mb3JFYWNoKGtleSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgIGVyck1zZ09ialtrZXldID0ge1xyXG4gICAgICAgICAgICAgICAgICAgIG5hbWU6IHZhbGlkYXRpb25FcnJvci5jb25zdHJhaW50c1trZXldXHJcbiAgICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICAgIC8vIGlmICh0aGlzLmZyYW1lQ29udGV4dC52aWV3TW9kZWwuYmluZGluZ1BhdGggPT09IGJpbmRpbmdQYXRoKSB7XHJcbiAgICAgICAgICAgICAgICAgIC8vICAgcm9vdFZpZXdNb2RlbFsndmVyaWZ5SW5mb3JtYXRpb25zJ10ucHVzaCh7XHJcbiAgICAgICAgICAgICAgICAgIC8vICAgICBpZDogaWQsXHJcbiAgICAgICAgICAgICAgICAgIC8vICAgICB0aXRsZToga2V5LFxyXG4gICAgICAgICAgICAgICAgICAvLyAgICAgbXNnOiB2YWxpZGF0aW9uRXJyb3IuY29uc3RyYWludHNba2V5XSxcclxuICAgICAgICAgICAgICAgICAgLy8gICAgIHR5cGU6ICd3YXJuJ1xyXG4gICAgICAgICAgICAgICAgICAvLyAgIH0pXHJcbiAgICAgICAgICAgICAgICAgIC8vIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICBjb25zdCBwYXRocyA9IHBhcmVudFBhdGhEYXRhLnBhdGguY29uY2F0KHZhbGlkYXRpb25FcnJvci5wcm9wZXJ0eSk7XHJcblxyXG4gICAgICAgICAgICAgIC8vaWYgKHRoaXMuZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5iaW5kaW5nUGF0aCA9PT0gYmluZGluZ1BhdGgpIHtcclxuICAgICAgICAgICAgICAvLyDlsIbplJnor6/kv6Hmga/mm7TmlrDliLBmb3JtQ29udHJvbOS4ilxyXG4gICAgICAgICAgICAgIGZvcm1Db250ZXh0LmJpbmRpbmdEYXRhLmNoYW5nZXMubmV4dCh7XHJcbiAgICAgICAgICAgICAgICB0eXBlOiBDaGFuZ2VUeXBlLlVwZGF0ZUVycm9ycyxcclxuICAgICAgICAgICAgICAgIGlkLFxyXG4gICAgICAgICAgICAgICAgcGF0aDogcGF0aHMsXHJcbiAgICAgICAgICAgICAgICBpc1VkdDogcGFyZW50UGF0aERhdGEuaXNVZHQsXHJcbiAgICAgICAgICAgICAgICBpc0dyaWQ6IHBhcmVudFBhdGhEYXRhLmlzR3JpZCxcclxuICAgICAgICAgICAgICAgIHZhbHVlOiB2YWxpZGF0aW9uRXJyb3IudmFsdWUsXHJcbiAgICAgICAgICAgICAgICBlcnJvcnM6IGVyck1zZ09ialxyXG4gICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgIC8vfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgIH07XHJcbiAgICAgICAgICAvLyDlsZXlvIDpqozor4Hnu5PmnpxcclxuICAgICAgICAgIGNvbnN0IGlzVmFsaWRMaXN0ID0gcmVzdWx0TGlzdC5tYXAoKHJlc3VsdDogVmFsaWRhdGlvblJlc3VsdCkgPT4gcmVzdWx0LmlzVmFsaWQpO1xyXG4gICAgICAgICAgLy8g5L+d5a2Y5YmN5YWI6LCD55So5a6e5L2T5LiK55qE6aqM6K+B6KeE5YiZ77yM5YWo6YOo6YCa6L+H5LmL5ZCO5omN5L+d5a2YXHJcbiAgICAgICAgICAvLyDlrp7kvZPpqozor4HpgJrov4dcclxuICAgICAgICAgIGlmIChpc1ZhbGlkTGlzdC5maWx0ZXIoeCA9PiB4KS5sZW5ndGggPT09IG9ic2VydmFibGVMaXN0Lmxlbmd0aCkge1xyXG4gICAgICAgICAgICAvLyDlsIbplJnor6/kv6Hmga/mm7TmlrDliLBmb3JtQ29udHJvbOS4ilxyXG4gICAgICAgICAgICBmb3JtQ29udGV4dC5iaW5kaW5nRGF0YS5jaGFuZ2VzLm5leHQoe1xyXG4gICAgICAgICAgICAgIHR5cGU6IENoYW5nZVR5cGUuVXBkYXRlRXJyb3JzLFxyXG4gICAgICAgICAgICAgIHBhdGg6IFtdXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAvLyDpqozor4HmiJDlip/lkI7pmpDol4/ovpPlhaXml7bnmoTpqozor4FcclxuICAgICAgICAgICAgaWYgKGZvcm1WYWxpZCkge1xyXG4gICAgICAgICAgICAgIGNvbnN0IGJpbmRpbmdPYmplY3QgPSBmb3JtQ29udGV4dC5iaW5kaW5nRGF0YS5nZXRPYmplY3QoKTtcclxuICAgICAgICAgICAgICBiaW5kaW5nT2JqZWN0ICYmIGJpbmRpbmdPYmplY3Quc2V0U2hvd1ZhbGlkYXRpb25Nc2coZmFsc2UpO1xyXG4gICAgICAgICAgICAgIGNvbnN0IGZvcm0gPSBmb3JtQ29udGV4dC5mb3JtO1xyXG4gICAgICAgICAgICAgIGlmIChmb3JtKSB7XHJcbiAgICAgICAgICAgICAgICBmb3JtLnNldFNob3dWYWxpZGF0aW9uTXNnKGZhbHNlKTtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIC8vIOWunuS9k+mqjOivgeaciemUmeivr1xyXG4gICAgICAgICAgICBlbnRpdHlWYWxpZCA9IGZhbHNlO1xyXG4gICAgICAgICAgICByZXN1bHRMaXN0LmZvckVhY2goKHJlc3VsdDogVmFsaWRhdGlvblJlc3VsdCkgPT4ge1xyXG4gICAgICAgICAgICAgIGlmIChyZXN1bHQuaXNWYWxpZCkge1xyXG4gICAgICAgICAgICAgICAgLy8g5riF6Zmk6aqM6K+B6YCa6L+H55qE6ZSZ6K+vXHJcbiAgICAgICAgICAgICAgICBmb3JtQ29udGV4dC5iaW5kaW5nRGF0YS5jaGFuZ2VzLm5leHQoe1xyXG4gICAgICAgICAgICAgICAgICB0eXBlOiBDaGFuZ2VUeXBlLlVwZGF0ZUVycm9ycyxcclxuICAgICAgICAgICAgICAgICAgcGF0aDogW11cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBoYW5kbGVFcnJvcnMocmVzdWx0LmVycm9ycyk7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgfSksXHJcbiAgICAgIHN3aXRjaE1hcCgocmVzdWx0TGlzdCkgPT4ge1xyXG4gICAgICAgIGxldCBpc1ZhbGlkYXRlZCA9IHRydWU7XHJcbiAgICAgICAgY29uc3QgZXJyb3JzID0gW107XHJcbiAgICAgICAgcmVzdWx0TGlzdC5mb3JFYWNoKChyZXN1bHQ6IFZhbGlkYXRpb25SZXN1bHQpID0+IHtcclxuICAgICAgICAgIGlmICghcmVzdWx0LmlzVmFsaWQpIHtcclxuICAgICAgICAgICAgaXNWYWxpZGF0ZWQgPSBmYWxzZTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGVycm9ycy5wdXNoKC4uLnJlc3VsdC5lcnJvcnMpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGlmIChlcnJvcnMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgdGhpcy5jb2xsZWN0VmFsaWRhdGlvbkVycm9ycyhyb290Vmlld01vZGVsLCBlcnJvcnMsIHRoaXMuZnJhbWVDb250ZXh0Lm5hbWVzcGFjZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGxldCB2ZXJpZnlJbmZvcm1hdGlvbnMgPSByb290Vmlld01vZGVsLnZlcmlmeUluZm9ybWF0aW9ucztcclxuICAgICAgICBpZiAoaXNNb2RhbCAmJiBoYXNPd25WZXJpZnlEZXRhaWxTZXJ2aWNlKSB7XHJcbiAgICAgICAgICB2ZXJpZnlJbmZvcm1hdGlvbnMgPSByb290Vmlld01vZGVsLnZlcmlmeUluZm9ybWF0aW9ucy5maWx0ZXIoaXRlbSA9PiBpdGVtLm5hbWVzcGFjZSA9PT0gbmFtZXNwYWNlKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8g5Zug5Li65qCh6aqM57Sv5Yqg55qE57yY5pWF77yM5a+86Ie05LmL5YmN55qE5qCh6aqM5L+h5oGv5LiA55u05a2Y5Zyo77yM5Y+q6IO96YCa6L+H5qCh6aqM57uT5p6c5p2l56Gu5a6a5piv5ZCm6L+Y5pyJ6ZSZ6K+v5L+h5oGvXHJcbiAgICAgICAgaWYgKGlzVmFsaWRhdGVkICYmIGZvcm1WYWxpZCkge1xyXG4gICAgICAgICAgdmVyaWZ5SW5mb3JtYXRpb25zID0gcm9vdFZpZXdNb2RlbC52ZXJpZnlJbmZvcm1hdGlvbnMgPSBbXTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcm9vdFZpZXdNb2RlbC52ZXJpZnljYXRpb25DaGFuZ2VkLm5leHQodmVyaWZ5SW5mb3JtYXRpb25zKTtcclxuICAgICAgICBpZiAoaXNWYWxpZGF0ZWQgJiYgZm9ybVZhbGlkKSB7XHJcbiAgICAgICAgICByZXR1cm4gb2YodHJ1ZSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHJldHVybiBlbXB0eSgpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgICByZXR1cm4gcmVzdWx0JDtcclxuICB9XHJcblxyXG4gIGNvbGxlY3RWYWxpZGF0aW9uRXJyb3JzKHJvb3RWaWV3TW9kZWw6IFZpZXdNb2RlbCwgZXJyb3JzOiBWYWxpZGF0aW9uRXJyb3JbXSwgbmFtZXNwYWNlOiBzdHJpbmcsIGZpbHRlcjogYm9vbGVhbiA9IHRydWUpIHtcclxuICAgIGlmIChmaWx0ZXIpIHtcclxuICAgICAgcm9vdFZpZXdNb2RlbC52ZXJpZnlJbmZvcm1hdGlvbnMgPSByb290Vmlld01vZGVsLnZlcmlmeUluZm9ybWF0aW9ucy5maWx0ZXIoaXRlbSA9PiBpdGVtLm5hbWVzcGFjZSAhPT0gbmFtZXNwYWNlKTtcclxuICAgIH1cclxuICAgIGVycm9ycy5mb3JFYWNoKCh2YWxpZGF0aW9uRXJyb3I6IFZhbGlkYXRpb25FcnJvcikgPT4ge1xyXG4gICAgICBpZiAodmFsaWRhdGlvbkVycm9yLmNoaWxkcmVuICYmIHZhbGlkYXRpb25FcnJvci5jaGlsZHJlbi5sZW5ndGgpIHtcclxuICAgICAgICB0aGlzLmNvbGxlY3RWYWxpZGF0aW9uRXJyb3JzKHJvb3RWaWV3TW9kZWwsIHZhbGlkYXRpb25FcnJvci5jaGlsZHJlbiwgbmFtZXNwYWNlLCBmYWxzZSk7XHJcbiAgICAgIH1cclxuICAgICAgbGV0IGlkID0gJyc7XHJcbiAgICAgIGNvbnN0IGZpbmRJZCA9ICh0YXJnZXQ6IGFueSkgPT4ge1xyXG4gICAgICAgIGlmICh0YXJnZXQgJiYgdGFyZ2V0LmRhdGEgJiYgdGFyZ2V0LmRhdGEuaWQpIHtcclxuICAgICAgICAgIGlkID0gdGFyZ2V0LmRhdGEuaWQ7XHJcbiAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfSBlbHNlIGlmICh0YXJnZXRbUEFSRU5UX0NMQVNTXSkge1xyXG4gICAgICAgICAgZmluZElkKHRhcmdldFtQQVJFTlRfQ0xBU1NdKTtcclxuICAgICAgICB9XHJcbiAgICAgIH07XHJcbiAgICAgIGZpbmRJZCh2YWxpZGF0aW9uRXJyb3IudGFyZ2V0KTtcclxuICAgICAgaWYgKHZhbGlkYXRpb25FcnJvci5jb25zdHJhaW50cykge1xyXG4gICAgICAgIGNvbnN0IHZhbGlkYXRpb25SZXN1bHRUeXBlcyA9IE9iamVjdC5rZXlzKHZhbGlkYXRpb25FcnJvci5jb25zdHJhaW50cyk7XHJcbiAgICAgICAgaWYgKHZhbGlkYXRpb25SZXN1bHRUeXBlcy5sZW5ndGgpIHtcclxuICAgICAgICAgIGNvbnN0IG9mZnNldCA9IHJvb3RWaWV3TW9kZWwudmVyaWZ5SW5mb3JtYXRpb25zLmZpbHRlcihpdGVtID0+IGl0ZW0ubmFtZXNwYWNlID09PSBuYW1lc3BhY2UpLmxlbmd0aDtcclxuICAgICAgICAgIGxldCBpbmRleCA9IHJvb3RWaWV3TW9kZWwudmVyaWZ5SW5mb3JtYXRpb25zLmZpbmRJbmRleChpdGVtID0+IGl0ZW0ubmFtZXNwYWNlID09PSBuYW1lc3BhY2UpO1xyXG4gICAgICAgICAgaW5kZXggPSBpbmRleCA9PT0gLTEgPyAwIDogaW5kZXggKyBvZmZzZXQ7XHJcbiAgICAgICAgICByb290Vmlld01vZGVsLnZlcmlmeUluZm9ybWF0aW9ucy5zcGxpY2UoaW5kZXgsIDAsIHtcclxuICAgICAgICAgICAgaWQ6IGlkLFxyXG4gICAgICAgICAgICBuYW1lc3BhY2UsXHJcbiAgICAgICAgICAgIHRhcmdldEZpZWxkOiB2YWxpZGF0aW9uRXJyb3IuZmllbGQsXHJcbiAgICAgICAgICAgIGluZGV4OiB2YWxpZGF0aW9uRXJyb3IuaW5kZXgsXHJcbiAgICAgICAgICAgIHRpdGxlOiB2YWxpZGF0aW9uRXJyb3IucHJvcGVydHlOYW1lLFxyXG4gICAgICAgICAgICBtc2c6IHZhbGlkYXRpb25FcnJvci5jb25zdHJhaW50c1t2YWxpZGF0aW9uUmVzdWx0VHlwZXNbMF1dLFxyXG4gICAgICAgICAgICBmcmFtZUNvbnRleHQ6IHZhbGlkYXRpb25FcnJvci5mcmFtZUNvbnRleHQsXHJcbiAgICAgICAgICAgIGZ1bGxQYXRoOiB2YWxpZGF0aW9uRXJyb3IuZnVsbFBhdGgsXHJcbiAgICAgICAgICAgIHR5cGU6IHZhbGlkYXRpb25SZXN1bHRUeXBlc1swXSA9PT0gJ3JlcXVpcmVkJyA/ICdlbXB0eScgOiAnZXJyb3InXHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDph43nva7moKHpqozkv6Hmga/vvIjku4XlvZPliY3ooajljZXvvIlcclxuICAgKi9cclxuICBwdWJsaWMgcmVzZXRWYWxpZGF0aW9uKCk6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICBjb25zdCBpc0RpYWxvZyA9IHRoaXMuaXNJbkRpYWxvZygpO1xyXG4gICAgbGV0IHJvb3RWaWV3TW9kZWwgPSB0aGlzLmZyYW1lQ29udGV4dC5yb290LnZpZXdNb2RlbDtcclxuICAgIGlmIChpc0RpYWxvZykge1xyXG4gICAgICByb290Vmlld01vZGVsID0gdGhpcy5mcmFtZUNvbnRleHQuZ2V0VmlydHVhbFJvb3RGcmFtZUNvbnRleHQoKS52aWV3TW9kZWw7XHJcbiAgICB9XHJcbiAgICBsZXQgdmVyaWZ5SW5mb3JtYXRpb25zID0gcm9vdFZpZXdNb2RlbC52ZXJpZnlJbmZvcm1hdGlvbnM7XHJcbiAgICBpZiAodmVyaWZ5SW5mb3JtYXRpb25zLmxlbmd0aCkge1xyXG4gICAgICBjb25zdCBuYW1lc3BhY2UgPSB0aGlzLmZyYW1lQ29udGV4dC5uYW1lc3BhY2U7XHJcbiAgICAgIGlmIChuYW1lc3BhY2UgIT09IG51bGwpIHtcclxuICAgICAgICB2ZXJpZnlJbmZvcm1hdGlvbnMgPSByb290Vmlld01vZGVsLnZlcmlmeUluZm9ybWF0aW9ucy5maWx0ZXIoaXRlbSA9PiBpdGVtLm5hbWVzcGFjZSAhPT0gbmFtZXNwYWNlKTtcclxuICAgICAgfVxyXG4gICAgICByb290Vmlld01vZGVsLnZlcmlmeUluZm9ybWF0aW9ucyA9IHZlcmlmeUluZm9ybWF0aW9ucztcclxuICAgICAgLy9yb290Vmlld01vZGVsLnZlcmlmeUluZm9ybWF0aW9ucy5zcGxpY2UoMCwgcm9vdFZpZXdNb2RlbC52ZXJpZnlJbmZvcm1hdGlvbnMubGVuZ3RoKTtcclxuICAgIH1cclxuICAgIHJvb3RWaWV3TW9kZWwudmVyaWZ5Y2F0aW9uQ2hhbmdlZC5uZXh0KHZlcmlmeUluZm9ybWF0aW9ucyk7XHJcbiAgICByZXR1cm4gb2YobnVsbCk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOaYr+WQpuWcqOW8ueeql+WGhemDqFxyXG4gICAqL1xyXG4gIHByaXZhdGUgaXNJbkRpYWxvZygpIHtcclxuICAgIHJldHVybiB0aGlzLmZyYW1lQ29udGV4dCAmJiB0aGlzLmZyYW1lQ29udGV4dC5nZXRWaXJ0dWFsUm9vdEZyYW1lQ29udGV4dCgpICYmIHRoaXMuZnJhbWVDb250ZXh0LmdldFZpcnR1YWxSb290RnJhbWVDb250ZXh0KCkuZnJhbWVDb21wb25lbnQgJiYgdGhpcy5mcmFtZUNvbnRleHQuZ2V0VmlydHVhbFJvb3RGcmFtZUNvbnRleHQoKS5mcmFtZUNvbXBvbmVudFsnaXNEaWFsb2dSb290Q29tcG9uZW50J10gfHwgZmFsc2U7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOaLpeacieeLrOiHqueahOagoemqjOaPkOekuuacjeWKoVxyXG4gICAqL1xyXG4gIHByaXZhdGUgaGFzT3duVmVyaWZ5RGV0YWlsU2VydmljZSgpIHtcclxuICAgIHJldHVybiB0aGlzLmZyYW1lQ29udGV4dC5pbmplY3Rvci5nZXQ8VmVyaWZ5RGV0YWlsU2VydmljZT4oVmVyaWZ5RGV0YWlsU2VydmljZSwgbnVsbCkgIT09IHRoaXMuZnJhbWVDb250ZXh0LnJvb3QuYXBwQ29udGV4dC5pbmplY3Rvci5nZXQ8VmVyaWZ5RGV0YWlsU2VydmljZT4oVmVyaWZ5RGV0YWlsU2VydmljZSwgbnVsbCk7O1xyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IHsgVmFsaWRhdGlvblNlcnZpY2UgfTtcclxuIl19