import * as tslib_1 from "tslib";
// tslint:disable: max-line-length
import { Injectable } from '@angular/core';
import { Repository, FrameContext, PARENT_CLASS, ChangeType } from '@farris/devkit';
import { tap, switchMap } from 'rxjs/operators';
import { Subject } from 'rxjs';
import { zip } from 'rxjs/observable/zip';
import { empty } from 'rxjs/observable/empty';
import { of } from 'rxjs/observable/of';
import { VerifyDetailService } from '@farris/ui-verify-detail';
/**
 * 表单验证服务
 * @scope FrameComponent
 */
var ValidationService = /** @class */ (function () {
    /**
     * 构造函数
     */
    function ValidationService(repository, frameContext) {
        this.repository = repository;
        this.frameContext = frameContext;
        this.validationResults = new Subject();
        this.validationAllResult = new Subject();
    }
    /**
     * 验证表单内的所有表单
     */
    ValidationService.prototype.validate = function () {
        var _this = this;
        this.repository.getList().subscribe(function (result) {
            var e_1, _a;
            try {
                for (var result_1 = tslib_1.__values(result), result_1_1 = result_1.next(); !result_1_1.done; result_1_1 = result_1.next()) {
                    var entity = result_1_1.value;
                    entity.validate().subscribe(function (result) {
                        if (!result.isValid) {
                            alert(result.message);
                            _this.validationResults.next(result);
                        }
                    });
                }
            }
            catch (e_1_1) { e_1 = { error: e_1_1 }; }
            finally {
                try {
                    if (result_1_1 && !result_1_1.done && (_a = result_1.return)) _a.call(result_1);
                }
                finally { if (e_1) throw e_1.error; }
            }
        });
        return this.validationResults;
    };
    /**
     * 校验当前行
     */
    ValidationService.prototype.validateCurrentRow = function () {
        var _this = this;
        // 组合表单只校验当前按钮所在的表单
        var primaryValue = this.frameContext.bindingData.list.currentId;
        var entities = [this.repository.entityCollection.getEntityById(primaryValue)];
        var namespace = this.frameContext.namespace;
        var frameContexts = [];
        if (namespace) {
            // 存在命名空间，说明表单较新，可以依赖该特性
            frameContexts = this.frameContext.appContext.frameContextManager.getFrameContextsByNamespace(namespace);
        }
        else {
            // 表单较老，获取所有的上下文，在校验阶段过滤规则
            frameContexts = this.frameContext.appContext.frameContextManager.getFrameContexts();
        }
        var isModal = this.isInDialog();
        var hasOwnVerifyDetailService = this.hasOwnVerifyDetailService();
        var rootViewModel = this.frameContext.root.viewModel;
        if (isModal && hasOwnVerifyDetailService) {
            rootViewModel = this.frameContext.getVirtualRootFrameContext().viewModel;
        }
        var toValidate = false;
        var formErrors = [];
        frameContexts.forEach(function (frameContext) {
            if (frameContext.form && frameContext.form.enableValidate) {
                toValidate = true;
            }
        });
        if (!toValidate || entities.length < 1) {
            return of(true);
        }
        rootViewModel.verifyInformations = [];
        var formValid = true;
        var entityValid = true;
        var formValidationRules = new Map();
        frameContexts.forEach(function (formContext) {
            var bindingObject = formContext.bindingData.getObject();
            // 通知所有bindingData,
            bindingObject && bindingObject.setShowValidationMsg(true);
            if (formContext.form && formContext.form.enableValidate) {
                // 获取当前表单上的所有验证规则
                var currentFormValidationRules = formContext.form.getValidationRules();
                currentFormValidationRules.forEach(function (rules, path) {
                    if (formValidationRules.has(path)) {
                        rules.forEach(function (rule) { return formValidationRules.get(path).push(rule); });
                    }
                    else {
                        formValidationRules.set(path, tslib_1.__spread(rules));
                    }
                });
                formContext.form.setShowValidationMsg(true);
                // 逐个调用表单的验证，验证前端表单规则
                if (!formContext.form.isFormValid()) {
                    formErrors.push(formContext.form);
                    formValid = false;
                }
            }
        });
        // 验证所有实体
        var observableList = entities.map(function (entity) {
            var index = _this.frameContext.bindingData.list.getIndexById(entity.primaryValue);
            return entity.validate(undefined, undefined, formValidationRules, null, _this.frameContext);
        });
        var result$ = zip.apply(void 0, tslib_1.__spread(observableList)).pipe(tap(function (resultList) {
            frameContexts.forEach(function (formContext) {
                if (!formContext.form.enableValidate) {
                    return;
                }
                var handleErrors = function (errors) {
                    errors.forEach(function (validationError) {
                        if (validationError.children && validationError.children.length) {
                            handleErrors(validationError.children);
                        }
                        var errMsgObj = {};
                        var id = '';
                        var findId = function (target) {
                            if (target && target.data && target.data.id) {
                                id = target.data.id;
                                return;
                            }
                            else if (target[PARENT_CLASS]) {
                                findId(target[PARENT_CLASS]);
                            }
                        };
                        findId(validationError.target);
                        // 实体验证出错，需要将错误展示到界面上
                        // 实体不一定是当前行
                        var parentPathData = {
                            path: [],
                            isUdt: false,
                            isGrid: false
                        };
                        if (validationError.target) {
                            parentPathData = validationError.target.getPaths();
                        }
                        var bindingPath = '/' + parentPathData.path.join('/');
                        if (validationError.constraints) {
                            Object.keys(validationError.constraints).forEach(function (key) {
                                errMsgObj[key] = {
                                    name: validationError.constraints[key]
                                };
                                // if (this.frameContext.viewModel.bindingPath === bindingPath) {
                                //   rootViewModel['verifyInformations'].push({
                                //     id: id,
                                //     title: key,
                                //     msg: validationError.constraints[key],
                                //     type: 'warn'
                                //   })
                                // }
                            });
                        }
                        var paths = parentPathData.path.concat(validationError.property);
                        //if (this.frameContext.viewModel.bindingPath === bindingPath) {
                        // 将错误信息更新到formControl上
                        formContext.bindingData.changes.next({
                            type: ChangeType.UpdateErrors,
                            id: id,
                            path: paths,
                            isUdt: parentPathData.isUdt,
                            isGrid: parentPathData.isGrid,
                            value: validationError.value,
                            errors: errMsgObj
                        });
                        //}
                    });
                };
                // 展开验证结果
                var isValidList = resultList.map(function (result) { return result.isValid; });
                // 保存前先调用实体上的验证规则，全部通过之后才保存
                // 实体验证通过
                if (isValidList.filter(function (x) { return x; }).length === observableList.length) {
                    // 将错误信息更新到formControl上
                    formContext.bindingData.changes.next({
                        type: ChangeType.UpdateErrors,
                        path: []
                    });
                    // 验证成功后隐藏输入时的验证
                    if (formValid) {
                        var bindingObject = formContext.bindingData.getObject();
                        bindingObject && bindingObject.setShowValidationMsg(false);
                        var form = formContext.form;
                        if (form) {
                            form.setShowValidationMsg(false);
                        }
                    }
                }
                else {
                    // 实体验证有错误
                    entityValid = false;
                    resultList.forEach(function (result) {
                        if (result.isValid) {
                            // 清除验证通过的错误
                            formContext.bindingData.changes.next({
                                type: ChangeType.UpdateErrors,
                                path: []
                            });
                        }
                        else {
                            handleErrors(result.errors);
                        }
                    });
                }
            });
        }), switchMap(function (resultList) {
            var isValidated = true;
            var errors = [];
            resultList.forEach(function (result) {
                if (!result.isValid) {
                    isValidated = false;
                }
                errors.push.apply(errors, tslib_1.__spread(result.errors));
            });
            if (errors.length > 0) {
                _this.collectValidationErrors(rootViewModel, errors, _this.frameContext.namespace);
            }
            // rootViewModel.verifycationChanged.next(rootViewModel.verifyInformations);
            var verifyInformations = rootViewModel.verifyInformations;
            if (isModal && hasOwnVerifyDetailService) {
                verifyInformations = rootViewModel.verifyInformations.filter(function (item) { return item.namespace === namespace; });
            }
            rootViewModel.verifycationChanged.next(verifyInformations);
            if (isValidated && formValid) {
                return of(true);
            }
            else {
                return empty();
            }
        }));
        return result$;
    };
    /**
     * 调用表单和实体上的验证规则, 通过后调用回调cb
     */
    ValidationService.prototype.validateAll = function () {
        var _this = this;
        // 组合表单只校验当前按钮所在的表单
        var entities = this.repository.entityCollection.getAllEntities();
        var namespace = this.frameContext.namespace;
        var frameContexts = [];
        if (namespace !== null) {
            // 存在命名空间，说明表单较新，可以依赖该特性
            frameContexts = this.frameContext.appContext.frameContextManager.getFrameContextsByNamespace(namespace);
        }
        else {
            // 表单较老，获取所有的上下文，在校验阶段过滤规则
            frameContexts = this.frameContext.appContext.frameContextManager.getFrameContexts();
        }
        var toValidate = false;
        var formErrors = [];
        frameContexts.forEach(function (frameContext) {
            if (frameContext.form && frameContext.form.enableValidate) {
                toValidate = true;
            }
        });
        if (!toValidate || entities.length < 1) {
            return of(true);
        }
        var isModal = this.isInDialog();
        var hasOwnVerifyDetailService = this.hasOwnVerifyDetailService();
        var rootViewModel = this.frameContext.root.viewModel;
        if (isModal && hasOwnVerifyDetailService) {
            rootViewModel = this.frameContext.getVirtualRootFrameContext().viewModel;
        }
        var formValid = true;
        var entityValid = true;
        var formValidationRules = new Map();
        frameContexts.forEach(function (formContext) {
            var bindingObject = formContext.bindingData.getObject();
            // 通知所有bindingData,
            bindingObject && bindingObject.setShowValidationMsg(true);
            if (formContext.form && formContext.form.enableValidate) {
                // 获取当前表单上的所有验证规则
                var currentFormValidationRules = formContext.form.getValidationRules();
                currentFormValidationRules.forEach(function (rules, path) {
                    if (formValidationRules.has(path)) {
                        rules.forEach(function (rule) { return formValidationRules.get(path).push(rule); });
                    }
                    else {
                        formValidationRules.set(path, tslib_1.__spread(rules));
                    }
                });
                formContext.form.setShowValidationMsg(true);
                // 逐个调用表单的验证，验证前端表单规则
                if (!formContext.form.isFormValid()) {
                    formErrors.push(formContext.form);
                    formValid = false;
                }
            }
        });
        // 触发所有实体的validate事件
        var isMultiEntityValiate = entities.length > 0;
        // 验证所有实体
        var observableList = entities.map(function (entity, index) {
            return entity.validate(undefined, undefined, formValidationRules, isMultiEntityValiate ? index : null, _this.frameContext);
        });
        var result$ = zip.apply(void 0, tslib_1.__spread(observableList)).pipe(tap(function (resultList) {
            frameContexts.forEach(function (formContext) {
                if (!formContext.form.enableValidate) {
                    return;
                }
                var handleErrors = function (errors) {
                    errors.forEach(function (validationError) {
                        if (validationError.children && validationError.children.length) {
                            handleErrors(validationError.children);
                        }
                        var errMsgObj = {};
                        var id = '';
                        var findId = function (target) {
                            if (target && target.data && target.data.id) {
                                id = target.data.id;
                                return;
                            }
                            else if (target[PARENT_CLASS]) {
                                findId(target[PARENT_CLASS]);
                            }
                        };
                        findId(validationError.target);
                        // 实体验证出错，需要将错误展示到界面上
                        // 实体不一定是当前行
                        var parentPathData = {
                            path: [],
                            isUdt: false,
                            isGrid: false
                        };
                        if (validationError.target) {
                            parentPathData = validationError.target.getPaths();
                        }
                        var bindingPath = '/' + parentPathData.path.join('/');
                        if (validationError.constraints) {
                            Object.keys(validationError.constraints).forEach(function (key) {
                                errMsgObj[key] = {
                                    name: validationError.constraints[key]
                                };
                                // if (this.frameContext.viewModel.bindingPath === bindingPath) {
                                //   rootViewModel['verifyInformations'].push({
                                //     id: id,
                                //     title: key,
                                //     msg: validationError.constraints[key],
                                //     type: 'warn'
                                //   })
                                // }
                            });
                        }
                        var paths = parentPathData.path.concat(validationError.property);
                        //if (this.frameContext.viewModel.bindingPath === bindingPath) {
                        // 将错误信息更新到formControl上
                        formContext.bindingData.changes.next({
                            type: ChangeType.UpdateErrors,
                            id: id,
                            path: paths,
                            isUdt: parentPathData.isUdt,
                            isGrid: parentPathData.isGrid,
                            value: validationError.value,
                            errors: errMsgObj
                        });
                        //}
                    });
                };
                // 展开验证结果
                var isValidList = resultList.map(function (result) { return result.isValid; });
                // 保存前先调用实体上的验证规则，全部通过之后才保存
                // 实体验证通过
                if (isValidList.filter(function (x) { return x; }).length === observableList.length) {
                    // 将错误信息更新到formControl上
                    formContext.bindingData.changes.next({
                        type: ChangeType.UpdateErrors,
                        path: []
                    });
                    // 验证成功后隐藏输入时的验证
                    if (formValid) {
                        var bindingObject = formContext.bindingData.getObject();
                        bindingObject && bindingObject.setShowValidationMsg(false);
                        var form = formContext.form;
                        if (form) {
                            form.setShowValidationMsg(false);
                        }
                    }
                }
                else {
                    // 实体验证有错误
                    entityValid = false;
                    resultList.forEach(function (result) {
                        if (result.isValid) {
                            // 清除验证通过的错误
                            formContext.bindingData.changes.next({
                                type: ChangeType.UpdateErrors,
                                path: []
                            });
                        }
                        else {
                            handleErrors(result.errors);
                        }
                    });
                }
            });
        }), switchMap(function (resultList) {
            var isValidated = true;
            var errors = [];
            resultList.forEach(function (result) {
                if (!result.isValid) {
                    isValidated = false;
                }
                errors.push.apply(errors, tslib_1.__spread(result.errors));
            });
            if (errors.length > 0) {
                _this.collectValidationErrors(rootViewModel, errors, _this.frameContext.namespace);
            }
            var verifyInformations = rootViewModel.verifyInformations;
            if (isModal && hasOwnVerifyDetailService) {
                verifyInformations = rootViewModel.verifyInformations.filter(function (item) { return item.namespace === namespace; });
            }
            // 因为校验累加的缘故，导致之前的校验信息一直存在，只能通过校验结果来确定是否还有错误信息
            if (isValidated && formValid) {
                verifyInformations = rootViewModel.verifyInformations = [];
            }
            rootViewModel.verifycationChanged.next(verifyInformations);
            if (isValidated && formValid) {
                return of(true);
            }
            else {
                return empty();
            }
        }));
        return result$;
    };
    ValidationService.prototype.collectValidationErrors = function (rootViewModel, errors, namespace, filter) {
        var _this = this;
        if (filter === void 0) { filter = true; }
        if (filter) {
            rootViewModel.verifyInformations = rootViewModel.verifyInformations.filter(function (item) { return item.namespace !== namespace; });
        }
        errors.forEach(function (validationError) {
            if (validationError.children && validationError.children.length) {
                _this.collectValidationErrors(rootViewModel, validationError.children, namespace, false);
            }
            var id = '';
            var findId = function (target) {
                if (target && target.data && target.data.id) {
                    id = target.data.id;
                    return;
                }
                else if (target[PARENT_CLASS]) {
                    findId(target[PARENT_CLASS]);
                }
            };
            findId(validationError.target);
            if (validationError.constraints) {
                var validationResultTypes = Object.keys(validationError.constraints);
                if (validationResultTypes.length) {
                    var offset = rootViewModel.verifyInformations.filter(function (item) { return item.namespace === namespace; }).length;
                    var index = rootViewModel.verifyInformations.findIndex(function (item) { return item.namespace === namespace; });
                    index = index === -1 ? 0 : index + offset;
                    rootViewModel.verifyInformations.splice(index, 0, {
                        id: id,
                        namespace: namespace,
                        targetField: validationError.field,
                        index: validationError.index,
                        title: validationError.propertyName,
                        msg: validationError.constraints[validationResultTypes[0]],
                        frameContext: validationError.frameContext,
                        fullPath: validationError.fullPath,
                        type: validationResultTypes[0] === 'required' ? 'empty' : 'error'
                    });
                }
            }
        });
    };
    /**
     * 重置校验信息（仅当前表单）
     */
    ValidationService.prototype.resetValidation = function () {
        var isDialog = this.isInDialog();
        var rootViewModel = this.frameContext.root.viewModel;
        if (isDialog) {
            rootViewModel = this.frameContext.getVirtualRootFrameContext().viewModel;
        }
        var verifyInformations = rootViewModel.verifyInformations;
        if (verifyInformations.length) {
            var namespace_1 = this.frameContext.namespace;
            if (namespace_1 !== null) {
                verifyInformations = rootViewModel.verifyInformations.filter(function (item) { return item.namespace !== namespace_1; });
            }
            rootViewModel.verifyInformations = verifyInformations;
            //rootViewModel.verifyInformations.splice(0, rootViewModel.verifyInformations.length);
        }
        rootViewModel.verifycationChanged.next(verifyInformations);
        return of(null);
    };
    /**
     * 是否在弹窗内部
     */
    ValidationService.prototype.isInDialog = function () {
        return this.frameContext && this.frameContext.getVirtualRootFrameContext() && this.frameContext.getVirtualRootFrameContext().frameComponent && this.frameContext.getVirtualRootFrameContext().frameComponent['isDialogRootComponent'] || false;
    };
    /**
     * 拥有独自的校验提示服务
     */
    ValidationService.prototype.hasOwnVerifyDetailService = function () {
        return this.frameContext.injector.get(VerifyDetailService, null) !== this.frameContext.root.appContext.injector.get(VerifyDetailService, null);
        ;
    };
    ValidationService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    ValidationService.ctorParameters = function () { return [
        { type: Repository },
        { type: FrameContext }
    ]; };
    return ValidationService;
}());
export { ValidationService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmFsaWRhdGlvbi5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL3ZhbGlkYXRpb24uc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsa0NBQWtDO0FBQ2xDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLFVBQVUsRUFBVSxZQUFZLEVBQUUsWUFBWSxFQUFFLFVBQVUsRUFBOEQsTUFBTSxnQkFBZ0IsQ0FBQztBQUN4SixPQUFPLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ2hELE9BQU8sRUFBYyxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDM0MsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQzFDLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUM5QyxPQUFPLEVBQUUsRUFBRSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDeEMsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFFL0Q7OztHQUdHO0FBRUg7SUFLRTs7T0FFRztJQUNILDJCQUNVLFVBQTJCLEVBQzNCLFlBQTBCO1FBRDFCLGVBQVUsR0FBVixVQUFVLENBQWlCO1FBQzNCLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBUDVCLHNCQUFpQixHQUFHLElBQUksT0FBTyxFQUFPLENBQUM7UUFDdkMsd0JBQW1CLEdBQUcsSUFBSSxPQUFPLEVBQU8sQ0FBQztJQVFqRCxDQUFDO0lBRUQ7O09BRUc7SUFDSSxvQ0FBUSxHQUFmO1FBQUEsaUJBY0M7UUFiQyxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sRUFBRSxDQUFDLFNBQVMsQ0FDakMsVUFBQyxNQUFnQjs7O2dCQUNmLEtBQXFCLElBQUEsV0FBQSxpQkFBQSxNQUFNLENBQUEsOEJBQUEsa0RBQUU7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YUFDcEc7WUFDRCxhQUFhLENBQUMsa0JBQWtCLEdBQUcsa0JBQWtCLENBQUM7WUFDdEQsc0ZBQXNGO1NBQ3ZGO1FBQ0QsYUFBYSxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1FBQzNELE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ2xCLENBQUM7SUFDRDs7T0FFRztJQUNLLHNDQUFVLEdBQWxCO1FBQ0UsT0FBTyxJQUFJLENBQUMsWUFBWSxJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMsMEJBQTBCLEVBQUUsSUFBSSxJQUFJLENBQUMsWUFBWSxDQUFDLDBCQUEwQixFQUFFLENBQUMsY0FBYyxJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMsMEJBQTBCLEVBQUUsQ0FBQyxjQUFjLENBQUMsdUJBQXVCLENBQUMsSUFBSSxLQUFLLENBQUM7SUFDalAsQ0FBQztJQUNEOztPQUVHO0lBQ0sscURBQXlCLEdBQWpDO1FBQ0UsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQXNCLG1CQUFtQixFQUFFLElBQUksQ0FBQyxLQUFLLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFzQixtQkFBbUIsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUFBLENBQUM7SUFDNUwsQ0FBQzs7Z0JBN2VGLFVBQVU7Ozs7Z0JBYkYsVUFBVTtnQkFBVSxZQUFZOztJQTJmekMsd0JBQUM7Q0FBQSxBQTllRCxJQThlQztBQUVELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gdHNsaW50OmRpc2FibGU6IG1heC1saW5lLWxlbmd0aFxyXG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IFJlcG9zaXRvcnksIEVudGl0eSwgRnJhbWVDb250ZXh0LCBQQVJFTlRfQ0xBU1MsIENoYW5nZVR5cGUsIFZhbGlkYXRpb25SZXN1bHQsIFZhbGlkYXRpb25FcnJvciwgVmFsaWRhdGVSdWxlLCBWaWV3TW9kZWwgfSBmcm9tICdAZmFycmlzL2RldmtpdCc7XHJcbmltcG9ydCB7IHRhcCwgc3dpdGNoTWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IHppcCB9IGZyb20gJ3J4anMvb2JzZXJ2YWJsZS96aXAnO1xyXG5pbXBvcnQgeyBlbXB0eSB9IGZyb20gJ3J4anMvb2JzZXJ2YWJsZS9lbXB0eSc7XHJcbmltcG9ydCB7IG9mIH0gZnJvbSAncnhqcy9vYnNlcnZhYmxlL29mJztcclxuaW1wb3J0IHsgVmVyaWZ5RGV0YWlsU2VydmljZSB9IGZyb20gJ0BmYXJyaXMvdWktdmVyaWZ5LWRldGFpbCc7XHJcblxyXG4vKipcclxuICog6KGo5Y2V6aqM6K+B5pyN5YqhXHJcbiAqIEBzY29wZSBGcmFtZUNvbXBvbmVudFxyXG4gKi9cclxuXHJcbkBJbmplY3RhYmxlKClcclxuY2xhc3MgVmFsaWRhdGlvblNlcnZpY2Uge1xyXG5cclxuICBwcml2YXRlIHZhbGlkYXRpb25SZXN1bHRzID0gbmV3IFN1YmplY3Q8YW55PigpO1xyXG4gIHByaXZhdGUgdmFsaWRhdGlvbkFsbFJlc3VsdCA9IG5ldyBTdWJqZWN0PGFueT4oKTtcclxuICAvKipcclxuICAgKiDmnoTpgKDlh73mlbBcclxuICAgKi9cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHByaXZhdGUgcmVwb3NpdG9yeTogUmVwb3NpdG9yeTxhbnk+LFxyXG4gICAgcHJpdmF0ZSBmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dFxyXG4gICkge1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6aqM6K+B6KGo5Y2V5YaF55qE5omA5pyJ6KGo5Y2VXHJcbiAgICovXHJcbiAgcHVibGljIHZhbGlkYXRlKCkge1xyXG4gICAgdGhpcy5yZXBvc2l0b3J5LmdldExpc3QoKS5zdWJzY3JpYmUoXHJcbiAgICAgIChyZXN1bHQ6IEVudGl0eVtdKSA9PiB7XHJcbiAgICAgICAgZm9yIChjb25zdCBlbnRpdHkgb2YgcmVzdWx0KSB7XHJcbiAgICAgICAgICBlbnRpdHkudmFsaWRhdGUoKS5zdWJzY3JpYmUoKHJlc3VsdDogVmFsaWRhdGlvblJlc3VsdCkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoIXJlc3VsdC5pc1ZhbGlkKSB7XHJcbiAgICAgICAgICAgICAgYWxlcnQocmVzdWx0Lm1lc3NhZ2UpO1xyXG4gICAgICAgICAgICAgIHRoaXMudmFsaWRhdGlvblJlc3VsdHMubmV4dChyZXN1bHQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICk7XHJcbiAgICByZXR1cm4gdGhpcy52YWxpZGF0aW9uUmVzdWx0cztcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5qCh6aqM5b2T5YmN6KGMXHJcbiAgICovXHJcbiAgcHVibGljIHZhbGlkYXRlQ3VycmVudFJvdygpOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgLy8g57uE5ZCI6KGo5Y2V5Y+q5qCh6aqM5b2T5YmN5oyJ6ZKu5omA5Zyo55qE6KGo5Y2VXHJcbiAgICBjb25zdCBwcmltYXJ5VmFsdWUgPSB0aGlzLmZyYW1lQ29udGV4dC5iaW5kaW5nRGF0YS5saXN0LmN1cnJlbnRJZDtcclxuICAgIGNvbnN0IGVudGl0aWVzOiBFbnRpdHlbXSA9IFt0aGlzLnJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi5nZXRFbnRpdHlCeUlkKHByaW1hcnlWYWx1ZSldO1xyXG4gICAgY29uc3QgbmFtZXNwYWNlID0gdGhpcy5mcmFtZUNvbnRleHQubmFtZXNwYWNlO1xyXG4gICAgbGV0IGZyYW1lQ29udGV4dHMgPSBbXTtcclxuICAgIGlmIChuYW1lc3BhY2UpIHtcclxuICAgICAgLy8g5a2Y5Zyo5ZG95ZCN56m66Ze077yM6K+05piO6KGo5Y2V6L6D5paw77yM5Y+v5Lul5L6d6LWW6K+l54m55oCnXHJcbiAgICAgIGZyYW1lQ29udGV4dHMgPSB0aGlzLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0LmZyYW1lQ29udGV4dE1hbmFnZXIuZ2V0RnJhbWVDb250ZXh0c0J5TmFtZXNwYWNlKG5hbWVzcGFjZSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAvLyDooajljZXovoPogIHvvIzojrflj5bmiYDmnInnmoTkuIrkuIvmlofvvIzlnKjmoKHpqozpmLbmrrXov4fmu6Top4TliJlcclxuICAgICAgZnJhbWVDb250ZXh0cyA9IHRoaXMuZnJhbWVDb250ZXh0LmFwcENvbnRleHQuZnJhbWVDb250ZXh0TWFuYWdlci5nZXRGcmFtZUNvbnRleHRzKCk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgaXNNb2RhbCA9IHRoaXMuaXNJbkRpYWxvZygpO1xyXG4gICAgY29uc3QgaGFzT3duVmVyaWZ5RGV0YWlsU2VydmljZSA9IHRoaXMuaGFzT3duVmVyaWZ5RGV0YWlsU2VydmljZSgpO1xyXG4gICAgbGV0IHJvb3RWaWV3TW9kZWwgPSB0aGlzLmZyYW1lQ29udGV4dC5yb290LnZpZXdNb2RlbDtcclxuICAgIGlmIChpc01vZGFsICYmIGhhc093blZlcmlmeURldGFpbFNlcnZpY2UpIHtcclxuICAgICAgcm9vdFZpZXdNb2RlbCA9IHRoaXMuZnJhbWVDb250ZXh0LmdldFZpcnR1YWxSb290RnJhbWVDb250ZXh0KCkudmlld01vZGVsO1xyXG4gICAgfVxyXG5cclxuICAgIGxldCB0b1ZhbGlkYXRlID0gZmFsc2U7XHJcbiAgICBjb25zdCBmb3JtRXJyb3JzID0gW107XHJcbiAgICBmcmFtZUNvbnRleHRzLmZvckVhY2goKGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0KSA9PiB7XHJcbiAgICAgIGlmIChmcmFtZUNvbnRleHQuZm9ybSAmJiBmcmFtZUNvbnRleHQuZm9ybS5lbmFibGVWYWxpZGF0ZSkge1xyXG4gICAgICAgIHRvVmFsaWRhdGUgPSB0cnVlO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICAgIGlmICghdG9WYWxpZGF0ZSB8fCBlbnRpdGllcy5sZW5ndGggPCAxKSB7XHJcbiAgICAgIHJldHVybiBvZih0cnVlKTtcclxuICAgIH1cclxuICAgIHJvb3RWaWV3TW9kZWwudmVyaWZ5SW5mb3JtYXRpb25zID0gW107XHJcbiAgICBsZXQgZm9ybVZhbGlkID0gdHJ1ZTtcclxuICAgIGxldCBlbnRpdHlWYWxpZCA9IHRydWU7XHJcbiAgICBjb25zdCBmb3JtVmFsaWRhdGlvblJ1bGVzID0gbmV3IE1hcDxzdHJpbmcsIFZhbGlkYXRlUnVsZVtdPigpO1xyXG4gICAgZnJhbWVDb250ZXh0cy5mb3JFYWNoKChmb3JtQ29udGV4dDogRnJhbWVDb250ZXh0KSA9PiB7XHJcbiAgICAgIGNvbnN0IGJpbmRpbmdPYmplY3QgPSBmb3JtQ29udGV4dC5iaW5kaW5nRGF0YS5nZXRPYmplY3QoKTtcclxuICAgICAgLy8g6YCa55+l5omA5pyJYmluZGluZ0RhdGEsXHJcbiAgICAgIGJpbmRpbmdPYmplY3QgJiYgYmluZGluZ09iamVjdC5zZXRTaG93VmFsaWRhdGlvbk1zZyh0cnVlKTtcclxuICAgICAgaWYgKGZvcm1Db250ZXh0LmZvcm0gJiYgZm9ybUNvbnRleHQuZm9ybS5lbmFibGVWYWxpZGF0ZSkge1xyXG4gICAgICAgIC8vIOiOt+WPluW9k+WJjeihqOWNleS4iueahOaJgOaciemqjOivgeinhOWImVxyXG4gICAgICAgIGNvbnN0IGN1cnJlbnRGb3JtVmFsaWRhdGlvblJ1bGVzID0gZm9ybUNvbnRleHQuZm9ybS5nZXRWYWxpZGF0aW9uUnVsZXMoKTtcclxuICAgICAgICBjdXJyZW50Rm9ybVZhbGlkYXRpb25SdWxlcy5mb3JFYWNoKChydWxlcywgcGF0aCkgPT4ge1xyXG4gICAgICAgICAgaWYgKGZvcm1WYWxpZGF0aW9uUnVsZXMuaGFzKHBhdGgpKSB7XHJcbiAgICAgICAgICAgIHJ1bGVzLmZvckVhY2gocnVsZSA9PiBmb3JtVmFsaWRhdGlvblJ1bGVzLmdldChwYXRoKS5wdXNoKHJ1bGUpKTtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGZvcm1WYWxpZGF0aW9uUnVsZXMuc2V0KHBhdGgsIFsuLi5ydWxlc10pO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGZvcm1Db250ZXh0LmZvcm0uc2V0U2hvd1ZhbGlkYXRpb25Nc2codHJ1ZSk7XHJcbiAgICAgICAgLy8g6YCQ5Liq6LCD55So6KGo5Y2V55qE6aqM6K+B77yM6aqM6K+B5YmN56uv6KGo5Y2V6KeE5YiZXHJcbiAgICAgICAgaWYgKCFmb3JtQ29udGV4dC5mb3JtLmlzRm9ybVZhbGlkKCkpIHtcclxuICAgICAgICAgIGZvcm1FcnJvcnMucHVzaChmb3JtQ29udGV4dC5mb3JtKTtcclxuICAgICAgICAgIGZvcm1WYWxpZCA9IGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfSk7XHJcblxyXG4gICAgLy8g6aqM6K+B5omA5pyJ5a6e5L2TXHJcbiAgICBjb25zdCBvYnNlcnZhYmxlTGlzdCA9IGVudGl0aWVzLm1hcCgoZW50aXR5OiBFbnRpdHkpID0+IHtcclxuICAgICAgY29uc3QgaW5kZXggPSB0aGlzLmZyYW1lQ29udGV4dC5iaW5kaW5nRGF0YS5saXN0LmdldEluZGV4QnlJZChlbnRpdHkucHJpbWFyeVZhbHVlKTtcclxuICAgICAgcmV0dXJuIGVudGl0eS52YWxpZGF0ZSh1bmRlZmluZWQsIHVuZGVmaW5lZCwgZm9ybVZhbGlkYXRpb25SdWxlcywgbnVsbCwgdGhpcy5mcmFtZUNvbnRleHQpO1xyXG4gICAgfSk7XHJcbiAgICBjb25zdCByZXN1bHQkID0gemlwKC4uLm9ic2VydmFibGVMaXN0KS5waXBlKFxyXG4gICAgICB0YXAoKHJlc3VsdExpc3QpID0+IHtcclxuICAgICAgICBmcmFtZUNvbnRleHRzLmZvckVhY2goKGZvcm1Db250ZXh0OiBGcmFtZUNvbnRleHQpID0+IHtcclxuICAgICAgICAgIGlmICghZm9ybUNvbnRleHQuZm9ybS5lbmFibGVWYWxpZGF0ZSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBjb25zdCBoYW5kbGVFcnJvcnMgPSAoZXJyb3JzOiBWYWxpZGF0aW9uRXJyb3JbXSkgPT4ge1xyXG4gICAgICAgICAgICBlcnJvcnMuZm9yRWFjaCgodmFsaWRhdGlvbkVycm9yOiBWYWxpZGF0aW9uRXJyb3IpID0+IHtcclxuICAgICAgICAgICAgICBpZiAodmFsaWRhdGlvbkVycm9yLmNoaWxkcmVuICYmIHZhbGlkYXRpb25FcnJvci5jaGlsZHJlbi5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgIGhhbmRsZUVycm9ycyh2YWxpZGF0aW9uRXJyb3IuY2hpbGRyZW4pO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICBjb25zdCBlcnJNc2dPYmogPSB7fTtcclxuICAgICAgICAgICAgICBsZXQgaWQgPSAnJztcclxuICAgICAgICAgICAgICBjb25zdCBmaW5kSWQgPSAodGFyZ2V0OiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmICh0YXJnZXQgJiYgdGFyZ2V0LmRhdGEgJiYgdGFyZ2V0LmRhdGEuaWQpIHtcclxuICAgICAgICAgICAgICAgICAgaWQgPSB0YXJnZXQuZGF0YS5pZDtcclxuICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0YXJnZXRbUEFSRU5UX0NMQVNTXSkge1xyXG4gICAgICAgICAgICAgICAgICBmaW5kSWQodGFyZ2V0W1BBUkVOVF9DTEFTU10pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgZmluZElkKHZhbGlkYXRpb25FcnJvci50YXJnZXQpO1xyXG5cclxuICAgICAgICAgICAgICAvLyDlrp7kvZPpqozor4Hlh7rplJnvvIzpnIDopoHlsIbplJnor6/lsZXnpLrliLDnlYzpnaLkuIpcclxuICAgICAgICAgICAgICAvLyDlrp7kvZPkuI3kuIDlrprmmK/lvZPliY3ooYxcclxuICAgICAgICAgICAgICBsZXQgcGFyZW50UGF0aERhdGEgPSB7XHJcbiAgICAgICAgICAgICAgICBwYXRoOiBbXSxcclxuICAgICAgICAgICAgICAgIGlzVWR0OiBmYWxzZSxcclxuICAgICAgICAgICAgICAgIGlzR3JpZDogZmFsc2VcclxuICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgIGlmICh2YWxpZGF0aW9uRXJyb3IudGFyZ2V0KSB7XHJcbiAgICAgICAgICAgICAgICBwYXJlbnRQYXRoRGF0YSA9IHZhbGlkYXRpb25FcnJvci50YXJnZXQuZ2V0UGF0aHMoKTtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgY29uc3QgYmluZGluZ1BhdGggPSAnLycgKyBwYXJlbnRQYXRoRGF0YS5wYXRoLmpvaW4oJy8nKTtcclxuICAgICAgICAgICAgICBpZiAodmFsaWRhdGlvbkVycm9yLmNvbnN0cmFpbnRzKSB7XHJcbiAgICAgICAgICAgICAgICBPYmplY3Qua2V5cyh2YWxpZGF0aW9uRXJyb3IuY29uc3RyYWludHMpLmZvckVhY2goa2V5ID0+IHtcclxuICAgICAgICAgICAgICAgICAgZXJyTXNnT2JqW2tleV0gPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbmFtZTogdmFsaWRhdGlvbkVycm9yLmNvbnN0cmFpbnRzW2tleV1cclxuICAgICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgICAgLy8gaWYgKHRoaXMuZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5iaW5kaW5nUGF0aCA9PT0gYmluZGluZ1BhdGgpIHtcclxuICAgICAgICAgICAgICAgICAgLy8gICByb290Vmlld01vZGVsWyd2ZXJpZnlJbmZvcm1hdGlvbnMnXS5wdXNoKHtcclxuICAgICAgICAgICAgICAgICAgLy8gICAgIGlkOiBpZCxcclxuICAgICAgICAgICAgICAgICAgLy8gICAgIHRpdGxlOiBrZXksXHJcbiAgICAgICAgICAgICAgICAgIC8vICAgICBtc2c6IHZhbGlkYXRpb25FcnJvci5jb25zdHJhaW50c1trZXldLFxyXG4gICAgICAgICAgICAgICAgICAvLyAgICAgdHlwZTogJ3dhcm4nXHJcbiAgICAgICAgICAgICAgICAgIC8vICAgfSlcclxuICAgICAgICAgICAgICAgICAgLy8gfVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIGNvbnN0IHBhdGhzID0gcGFyZW50UGF0aERhdGEucGF0aC5jb25jYXQodmFsaWRhdGlvbkVycm9yLnByb3BlcnR5KTtcclxuXHJcbiAgICAgICAgICAgICAgLy9pZiAodGhpcy5mcmFtZUNvbnRleHQudmlld01vZGVsLmJpbmRpbmdQYXRoID09PSBiaW5kaW5nUGF0aCkge1xyXG4gICAgICAgICAgICAgIC8vIOWwhumUmeivr+S/oeaBr+abtOaWsOWIsGZvcm1Db250cm9s5LiKXHJcbiAgICAgICAgICAgICAgZm9ybUNvbnRleHQuYmluZGluZ0RhdGEuY2hhbmdlcy5uZXh0KHtcclxuICAgICAgICAgICAgICAgIHR5cGU6IENoYW5nZVR5cGUuVXBkYXRlRXJyb3JzLFxyXG4gICAgICAgICAgICAgICAgaWQsXHJcbiAgICAgICAgICAgICAgICBwYXRoOiBwYXRocyxcclxuICAgICAgICAgICAgICAgIGlzVWR0OiBwYXJlbnRQYXRoRGF0YS5pc1VkdCxcclxuICAgICAgICAgICAgICAgIGlzR3JpZDogcGFyZW50UGF0aERhdGEuaXNHcmlkLFxyXG4gICAgICAgICAgICAgICAgdmFsdWU6IHZhbGlkYXRpb25FcnJvci52YWx1ZSxcclxuICAgICAgICAgICAgICAgIGVycm9yczogZXJyTXNnT2JqXHJcbiAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgLy99XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgfTtcclxuICAgICAgICAgIC8vIOWxleW8gOmqjOivgee7k+aenFxyXG4gICAgICAgICAgY29uc3QgaXNWYWxpZExpc3QgPSByZXN1bHRMaXN0Lm1hcCgocmVzdWx0OiBWYWxpZGF0aW9uUmVzdWx0KSA9PiByZXN1bHQuaXNWYWxpZCk7XHJcbiAgICAgICAgICAvLyDkv53lrZjliY3lhYjosIPnlKjlrp7kvZPkuIrnmoTpqozor4Hop4TliJnvvIzlhajpg6jpgJrov4fkuYvlkI7miY3kv53lrZhcclxuICAgICAgICAgIC8vIOWunuS9k+mqjOivgemAmui/h1xyXG4gICAgICAgICAgaWYgKGlzVmFsaWRMaXN0LmZpbHRlcih4ID0+IHgpLmxlbmd0aCA9PT0gb2JzZXJ2YWJsZUxpc3QubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIC8vIOWwhumUmeivr+S/oeaBr+abtOaWsOWIsGZvcm1Db250cm9s5LiKXHJcbiAgICAgICAgICAgIGZvcm1Db250ZXh0LmJpbmRpbmdEYXRhLmNoYW5nZXMubmV4dCh7XHJcbiAgICAgICAgICAgICAgdHlwZTogQ2hhbmdlVHlwZS5VcGRhdGVFcnJvcnMsXHJcbiAgICAgICAgICAgICAgcGF0aDogW11cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIC8vIOmqjOivgeaIkOWKn+WQjumakOiXj+i+k+WFpeaXtueahOmqjOivgVxyXG4gICAgICAgICAgICBpZiAoZm9ybVZhbGlkKSB7XHJcbiAgICAgICAgICAgICAgY29uc3QgYmluZGluZ09iamVjdCA9IGZvcm1Db250ZXh0LmJpbmRpbmdEYXRhLmdldE9iamVjdCgpO1xyXG4gICAgICAgICAgICAgIGJpbmRpbmdPYmplY3QgJiYgYmluZGluZ09iamVjdC5zZXRTaG93VmFsaWRhdGlvbk1zZyhmYWxzZSk7XHJcbiAgICAgICAgICAgICAgY29uc3QgZm9ybSA9IGZvcm1Db250ZXh0LmZvcm07XHJcbiAgICAgICAgICAgICAgaWYgKGZvcm0pIHtcclxuICAgICAgICAgICAgICAgIGZvcm0uc2V0U2hvd1ZhbGlkYXRpb25Nc2coZmFsc2UpO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgLy8g5a6e5L2T6aqM6K+B5pyJ6ZSZ6K+vXHJcbiAgICAgICAgICAgIGVudGl0eVZhbGlkID0gZmFsc2U7XHJcbiAgICAgICAgICAgIHJlc3VsdExpc3QuZm9yRWFjaCgocmVzdWx0OiBWYWxpZGF0aW9uUmVzdWx0KSA9PiB7XHJcbiAgICAgICAgICAgICAgaWYgKHJlc3VsdC5pc1ZhbGlkKSB7XHJcbiAgICAgICAgICAgICAgICAvLyDmuIXpmaTpqozor4HpgJrov4fnmoTplJnor69cclxuICAgICAgICAgICAgICAgIGZvcm1Db250ZXh0LmJpbmRpbmdEYXRhLmNoYW5nZXMubmV4dCh7XHJcbiAgICAgICAgICAgICAgICAgIHR5cGU6IENoYW5nZVR5cGUuVXBkYXRlRXJyb3JzLFxyXG4gICAgICAgICAgICAgICAgICBwYXRoOiBbXVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGhhbmRsZUVycm9ycyhyZXN1bHQuZXJyb3JzKTtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICB9KSxcclxuICAgICAgc3dpdGNoTWFwKChyZXN1bHRMaXN0KSA9PiB7XHJcbiAgICAgICAgbGV0IGlzVmFsaWRhdGVkID0gdHJ1ZTtcclxuICAgICAgICBjb25zdCBlcnJvcnMgPSBbXTtcclxuICAgICAgICByZXN1bHRMaXN0LmZvckVhY2goKHJlc3VsdDogVmFsaWRhdGlvblJlc3VsdCkgPT4ge1xyXG4gICAgICAgICAgaWYgKCFyZXN1bHQuaXNWYWxpZCkge1xyXG4gICAgICAgICAgICBpc1ZhbGlkYXRlZCA9IGZhbHNlO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgZXJyb3JzLnB1c2goLi4ucmVzdWx0LmVycm9ycyk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgaWYgKGVycm9ycy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICB0aGlzLmNvbGxlY3RWYWxpZGF0aW9uRXJyb3JzKHJvb3RWaWV3TW9kZWwsIGVycm9ycywgdGhpcy5mcmFtZUNvbnRleHQubmFtZXNwYWNlKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gcm9vdFZpZXdNb2RlbC52ZXJpZnljYXRpb25DaGFuZ2VkLm5leHQocm9vdFZpZXdNb2RlbC52ZXJpZnlJbmZvcm1hdGlvbnMpO1xyXG4gICAgICAgIGxldCB2ZXJpZnlJbmZvcm1hdGlvbnMgPSByb290Vmlld01vZGVsLnZlcmlmeUluZm9ybWF0aW9ucztcclxuICAgICAgICBpZiAoaXNNb2RhbCAmJiBoYXNPd25WZXJpZnlEZXRhaWxTZXJ2aWNlKSB7XHJcbiAgICAgICAgICB2ZXJpZnlJbmZvcm1hdGlvbnMgPSByb290Vmlld01vZGVsLnZlcmlmeUluZm9ybWF0aW9ucy5maWx0ZXIoaXRlbSA9PiBpdGVtLm5hbWVzcGFjZSA9PT0gbmFtZXNwYWNlKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcm9vdFZpZXdNb2RlbC52ZXJpZnljYXRpb25DaGFuZ2VkLm5leHQodmVyaWZ5SW5mb3JtYXRpb25zKTtcclxuICAgICAgICBpZiAoaXNWYWxpZGF0ZWQgJiYgZm9ybVZhbGlkKSB7XHJcbiAgICAgICAgICByZXR1cm4gb2YodHJ1ZSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHJldHVybiBlbXB0eSgpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgICByZXR1cm4gcmVzdWx0JDtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6LCD55So6KGo5Y2V5ZKM5a6e5L2T5LiK55qE6aqM6K+B6KeE5YiZLCDpgJrov4flkI7osIPnlKjlm57osINjYlxyXG4gICAqL1xyXG4gIHZhbGlkYXRlQWxsKCk6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICAvLyDnu4TlkIjooajljZXlj6rmoKHpqozlvZPliY3mjInpkq7miYDlnKjnmoTooajljZVcclxuICAgIGNvbnN0IGVudGl0aWVzOiBFbnRpdHlbXSA9IHRoaXMucmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLmdldEFsbEVudGl0aWVzKCk7XHJcbiAgICBjb25zdCBuYW1lc3BhY2UgPSB0aGlzLmZyYW1lQ29udGV4dC5uYW1lc3BhY2U7XHJcbiAgICBsZXQgZnJhbWVDb250ZXh0cyA9IFtdO1xyXG4gICAgaWYgKG5hbWVzcGFjZSAhPT0gbnVsbCkge1xyXG4gICAgICAvLyDlrZjlnKjlkb3lkI3nqbrpl7TvvIzor7TmmI7ooajljZXovoPmlrDvvIzlj6/ku6Xkvp3otZbor6XnibnmgKdcclxuICAgICAgZnJhbWVDb250ZXh0cyA9IHRoaXMuZnJhbWVDb250ZXh0LmFwcENvbnRleHQuZnJhbWVDb250ZXh0TWFuYWdlci5nZXRGcmFtZUNvbnRleHRzQnlOYW1lc3BhY2UobmFtZXNwYWNlKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIC8vIOihqOWNlei+g+iAge+8jOiOt+WPluaJgOacieeahOS4iuS4i+aWh++8jOWcqOagoemqjOmYtuautei/h+a7pOinhOWImVxyXG4gICAgICBmcmFtZUNvbnRleHRzID0gdGhpcy5mcmFtZUNvbnRleHQuYXBwQ29udGV4dC5mcmFtZUNvbnRleHRNYW5hZ2VyLmdldEZyYW1lQ29udGV4dHMoKTtcclxuICAgIH1cclxuXHJcbiAgICBsZXQgdG9WYWxpZGF0ZSA9IGZhbHNlO1xyXG4gICAgY29uc3QgZm9ybUVycm9ycyA9IFtdO1xyXG4gICAgZnJhbWVDb250ZXh0cy5mb3JFYWNoKChmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCkgPT4ge1xyXG4gICAgICBpZiAoZnJhbWVDb250ZXh0LmZvcm0gJiYgZnJhbWVDb250ZXh0LmZvcm0uZW5hYmxlVmFsaWRhdGUpIHtcclxuICAgICAgICB0b1ZhbGlkYXRlID0gdHJ1ZTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICBpZiAoIXRvVmFsaWRhdGUgfHwgZW50aXRpZXMubGVuZ3RoIDwgMSkge1xyXG4gICAgICByZXR1cm4gb2YodHJ1ZSk7XHJcbiAgICB9XHJcbiAgICBjb25zdCBpc01vZGFsID0gdGhpcy5pc0luRGlhbG9nKCk7XHJcbiAgICBjb25zdCBoYXNPd25WZXJpZnlEZXRhaWxTZXJ2aWNlID0gdGhpcy5oYXNPd25WZXJpZnlEZXRhaWxTZXJ2aWNlKCk7XHJcbiAgICBsZXQgcm9vdFZpZXdNb2RlbCA9IHRoaXMuZnJhbWVDb250ZXh0LnJvb3Qudmlld01vZGVsO1xyXG4gICAgaWYgKGlzTW9kYWwgJiYgaGFzT3duVmVyaWZ5RGV0YWlsU2VydmljZSkge1xyXG4gICAgICByb290Vmlld01vZGVsID0gdGhpcy5mcmFtZUNvbnRleHQuZ2V0VmlydHVhbFJvb3RGcmFtZUNvbnRleHQoKS52aWV3TW9kZWw7XHJcbiAgICB9XHJcblxyXG4gICAgbGV0IGZvcm1WYWxpZCA9IHRydWU7XHJcbiAgICBsZXQgZW50aXR5VmFsaWQgPSB0cnVlO1xyXG4gICAgY29uc3QgZm9ybVZhbGlkYXRpb25SdWxlcyA9IG5ldyBNYXA8c3RyaW5nLCBWYWxpZGF0ZVJ1bGVbXT4oKTtcclxuICAgIGZyYW1lQ29udGV4dHMuZm9yRWFjaCgoZm9ybUNvbnRleHQ6IEZyYW1lQ29udGV4dCkgPT4ge1xyXG4gICAgICBjb25zdCBiaW5kaW5nT2JqZWN0ID0gZm9ybUNvbnRleHQuYmluZGluZ0RhdGEuZ2V0T2JqZWN0KCk7XHJcbiAgICAgIC8vIOmAmuefpeaJgOaciWJpbmRpbmdEYXRhLFxyXG4gICAgICBiaW5kaW5nT2JqZWN0ICYmIGJpbmRpbmdPYmplY3Quc2V0U2hvd1ZhbGlkYXRpb25Nc2codHJ1ZSk7XHJcbiAgICAgIGlmIChmb3JtQ29udGV4dC5mb3JtICYmIGZvcm1Db250ZXh0LmZvcm0uZW5hYmxlVmFsaWRhdGUpIHtcclxuICAgICAgICAvLyDojrflj5blvZPliY3ooajljZXkuIrnmoTmiYDmnInpqozor4Hop4TliJlcclxuICAgICAgICBjb25zdCBjdXJyZW50Rm9ybVZhbGlkYXRpb25SdWxlcyA9IGZvcm1Db250ZXh0LmZvcm0uZ2V0VmFsaWRhdGlvblJ1bGVzKCk7XHJcbiAgICAgICAgY3VycmVudEZvcm1WYWxpZGF0aW9uUnVsZXMuZm9yRWFjaCgocnVsZXMsIHBhdGgpID0+IHtcclxuICAgICAgICAgIGlmIChmb3JtVmFsaWRhdGlvblJ1bGVzLmhhcyhwYXRoKSkge1xyXG4gICAgICAgICAgICBydWxlcy5mb3JFYWNoKHJ1bGUgPT4gZm9ybVZhbGlkYXRpb25SdWxlcy5nZXQocGF0aCkucHVzaChydWxlKSk7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBmb3JtVmFsaWRhdGlvblJ1bGVzLnNldChwYXRoLCBbLi4ucnVsZXNdKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgICBmb3JtQ29udGV4dC5mb3JtLnNldFNob3dWYWxpZGF0aW9uTXNnKHRydWUpO1xyXG4gICAgICAgIC8vIOmAkOS4quiwg+eUqOihqOWNleeahOmqjOivge+8jOmqjOivgeWJjeerr+ihqOWNleinhOWImVxyXG4gICAgICAgIGlmICghZm9ybUNvbnRleHQuZm9ybS5pc0Zvcm1WYWxpZCgpKSB7XHJcbiAgICAgICAgICBmb3JtRXJyb3JzLnB1c2goZm9ybUNvbnRleHQuZm9ybSk7XHJcbiAgICAgICAgICBmb3JtVmFsaWQgPSBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgLy8g6Kem5Y+R5omA5pyJ5a6e5L2T55qEdmFsaWRhdGXkuovku7ZcclxuICAgIGNvbnN0IGlzTXVsdGlFbnRpdHlWYWxpYXRlID0gZW50aXRpZXMubGVuZ3RoID4gMDtcclxuXHJcbiAgICAvLyDpqozor4HmiYDmnInlrp7kvZNcclxuICAgIGNvbnN0IG9ic2VydmFibGVMaXN0ID0gZW50aXRpZXMubWFwKChlbnRpdHk6IEVudGl0eSwgaW5kZXg6IG51bWJlcikgPT5cclxuICAgICAgZW50aXR5LnZhbGlkYXRlKHVuZGVmaW5lZCwgdW5kZWZpbmVkLCBmb3JtVmFsaWRhdGlvblJ1bGVzLCBpc011bHRpRW50aXR5VmFsaWF0ZSA/IGluZGV4IDogbnVsbCwgdGhpcy5mcmFtZUNvbnRleHQpKTtcclxuICAgIGNvbnN0IHJlc3VsdCQgPSB6aXAoLi4ub2JzZXJ2YWJsZUxpc3QpLnBpcGUoXHJcbiAgICAgIHRhcCgocmVzdWx0TGlzdCkgPT4ge1xyXG4gICAgICAgIGZyYW1lQ29udGV4dHMuZm9yRWFjaCgoZm9ybUNvbnRleHQ6IEZyYW1lQ29udGV4dCkgPT4ge1xyXG4gICAgICAgICAgaWYgKCFmb3JtQ29udGV4dC5mb3JtLmVuYWJsZVZhbGlkYXRlKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGNvbnN0IGhhbmRsZUVycm9ycyA9IChlcnJvcnM6IFZhbGlkYXRpb25FcnJvcltdKSA9PiB7XHJcbiAgICAgICAgICAgIGVycm9ycy5mb3JFYWNoKCh2YWxpZGF0aW9uRXJyb3I6IFZhbGlkYXRpb25FcnJvcikgPT4ge1xyXG4gICAgICAgICAgICAgIGlmICh2YWxpZGF0aW9uRXJyb3IuY2hpbGRyZW4gJiYgdmFsaWRhdGlvbkVycm9yLmNoaWxkcmVuLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgaGFuZGxlRXJyb3JzKHZhbGlkYXRpb25FcnJvci5jaGlsZHJlbik7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIGNvbnN0IGVyck1zZ09iaiA9IHt9O1xyXG4gICAgICAgICAgICAgIGxldCBpZCA9ICcnO1xyXG4gICAgICAgICAgICAgIGNvbnN0IGZpbmRJZCA9ICh0YXJnZXQ6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKHRhcmdldCAmJiB0YXJnZXQuZGF0YSAmJiB0YXJnZXQuZGF0YS5pZCkge1xyXG4gICAgICAgICAgICAgICAgICBpZCA9IHRhcmdldC5kYXRhLmlkO1xyXG4gICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRhcmdldFtQQVJFTlRfQ0xBU1NdKSB7XHJcbiAgICAgICAgICAgICAgICAgIGZpbmRJZCh0YXJnZXRbUEFSRU5UX0NMQVNTXSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICBmaW5kSWQodmFsaWRhdGlvbkVycm9yLnRhcmdldCk7XHJcblxyXG4gICAgICAgICAgICAgIC8vIOWunuS9k+mqjOivgeWHuumUme+8jOmcgOimgeWwhumUmeivr+WxleekuuWIsOeVjOmdouS4ilxyXG4gICAgICAgICAgICAgIC8vIOWunuS9k+S4jeS4gOWumuaYr+W9k+WJjeihjFxyXG4gICAgICAgICAgICAgIGxldCBwYXJlbnRQYXRoRGF0YSA9IHtcclxuICAgICAgICAgICAgICAgIHBhdGg6IFtdLFxyXG4gICAgICAgICAgICAgICAgaXNVZHQ6IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgaXNHcmlkOiBmYWxzZVxyXG4gICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgaWYgKHZhbGlkYXRpb25FcnJvci50YXJnZXQpIHtcclxuICAgICAgICAgICAgICAgIHBhcmVudFBhdGhEYXRhID0gdmFsaWRhdGlvbkVycm9yLnRhcmdldC5nZXRQYXRocygpO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICBjb25zdCBiaW5kaW5nUGF0aCA9ICcvJyArIHBhcmVudFBhdGhEYXRhLnBhdGguam9pbignLycpO1xyXG4gICAgICAgICAgICAgIGlmICh2YWxpZGF0aW9uRXJyb3IuY29uc3RyYWludHMpIHtcclxuICAgICAgICAgICAgICAgIE9iamVjdC5rZXlzKHZhbGlkYXRpb25FcnJvci5jb25zdHJhaW50cykuZm9yRWFjaChrZXkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICBlcnJNc2dPYmpba2V5XSA9IHtcclxuICAgICAgICAgICAgICAgICAgICBuYW1lOiB2YWxpZGF0aW9uRXJyb3IuY29uc3RyYWludHNba2V5XVxyXG4gICAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgICAvLyBpZiAodGhpcy5mcmFtZUNvbnRleHQudmlld01vZGVsLmJpbmRpbmdQYXRoID09PSBiaW5kaW5nUGF0aCkge1xyXG4gICAgICAgICAgICAgICAgICAvLyAgIHJvb3RWaWV3TW9kZWxbJ3ZlcmlmeUluZm9ybWF0aW9ucyddLnB1c2goe1xyXG4gICAgICAgICAgICAgICAgICAvLyAgICAgaWQ6IGlkLFxyXG4gICAgICAgICAgICAgICAgICAvLyAgICAgdGl0bGU6IGtleSxcclxuICAgICAgICAgICAgICAgICAgLy8gICAgIG1zZzogdmFsaWRhdGlvbkVycm9yLmNvbnN0cmFpbnRzW2tleV0sXHJcbiAgICAgICAgICAgICAgICAgIC8vICAgICB0eXBlOiAnd2FybidcclxuICAgICAgICAgICAgICAgICAgLy8gICB9KVxyXG4gICAgICAgICAgICAgICAgICAvLyB9XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgY29uc3QgcGF0aHMgPSBwYXJlbnRQYXRoRGF0YS5wYXRoLmNvbmNhdCh2YWxpZGF0aW9uRXJyb3IucHJvcGVydHkpO1xyXG5cclxuICAgICAgICAgICAgICAvL2lmICh0aGlzLmZyYW1lQ29udGV4dC52aWV3TW9kZWwuYmluZGluZ1BhdGggPT09IGJpbmRpbmdQYXRoKSB7XHJcbiAgICAgICAgICAgICAgLy8g5bCG6ZSZ6K+v5L+h5oGv5pu05paw5YiwZm9ybUNvbnRyb2zkuIpcclxuICAgICAgICAgICAgICBmb3JtQ29udGV4dC5iaW5kaW5nRGF0YS5jaGFuZ2VzLm5leHQoe1xyXG4gICAgICAgICAgICAgICAgdHlwZTogQ2hhbmdlVHlwZS5VcGRhdGVFcnJvcnMsXHJcbiAgICAgICAgICAgICAgICBpZCxcclxuICAgICAgICAgICAgICAgIHBhdGg6IHBhdGhzLFxyXG4gICAgICAgICAgICAgICAgaXNVZHQ6IHBhcmVudFBhdGhEYXRhLmlzVWR0LFxyXG4gICAgICAgICAgICAgICAgaXNHcmlkOiBwYXJlbnRQYXRoRGF0YS5pc0dyaWQsXHJcbiAgICAgICAgICAgICAgICB2YWx1ZTogdmFsaWRhdGlvbkVycm9yLnZhbHVlLFxyXG4gICAgICAgICAgICAgICAgZXJyb3JzOiBlcnJNc2dPYmpcclxuICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAvL31cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICB9O1xyXG4gICAgICAgICAgLy8g5bGV5byA6aqM6K+B57uT5p6cXHJcbiAgICAgICAgICBjb25zdCBpc1ZhbGlkTGlzdCA9IHJlc3VsdExpc3QubWFwKChyZXN1bHQ6IFZhbGlkYXRpb25SZXN1bHQpID0+IHJlc3VsdC5pc1ZhbGlkKTtcclxuICAgICAgICAgIC8vIOS/neWtmOWJjeWFiOiwg+eUqOWunuS9k+S4iueahOmqjOivgeinhOWIme+8jOWFqOmDqOmAmui/h+S5i+WQjuaJjeS/neWtmFxyXG4gICAgICAgICAgLy8g5a6e5L2T6aqM6K+B6YCa6L+HXHJcbiAgICAgICAgICBpZiAoaXNWYWxpZExpc3QuZmlsdGVyKHggPT4geCkubGVuZ3RoID09PSBvYnNlcnZhYmxlTGlzdC5sZW5ndGgpIHtcclxuICAgICAgICAgICAgLy8g5bCG6ZSZ6K+v5L+h5oGv5pu05paw5YiwZm9ybUNvbnRyb2zkuIpcclxuICAgICAgICAgICAgZm9ybUNvbnRleHQuYmluZGluZ0RhdGEuY2hhbmdlcy5uZXh0KHtcclxuICAgICAgICAgICAgICB0eXBlOiBDaGFuZ2VUeXBlLlVwZGF0ZUVycm9ycyxcclxuICAgICAgICAgICAgICBwYXRoOiBbXVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgLy8g6aqM6K+B5oiQ5Yqf5ZCO6ZqQ6JeP6L6T5YWl5pe255qE6aqM6K+BXHJcbiAgICAgICAgICAgIGlmIChmb3JtVmFsaWQpIHtcclxuICAgICAgICAgICAgICBjb25zdCBiaW5kaW5nT2JqZWN0ID0gZm9ybUNvbnRleHQuYmluZGluZ0RhdGEuZ2V0T2JqZWN0KCk7XHJcbiAgICAgICAgICAgICAgYmluZGluZ09iamVjdCAmJiBiaW5kaW5nT2JqZWN0LnNldFNob3dWYWxpZGF0aW9uTXNnKGZhbHNlKTtcclxuICAgICAgICAgICAgICBjb25zdCBmb3JtID0gZm9ybUNvbnRleHQuZm9ybTtcclxuICAgICAgICAgICAgICBpZiAoZm9ybSkge1xyXG4gICAgICAgICAgICAgICAgZm9ybS5zZXRTaG93VmFsaWRhdGlvbk1zZyhmYWxzZSk7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAvLyDlrp7kvZPpqozor4HmnInplJnor69cclxuICAgICAgICAgICAgZW50aXR5VmFsaWQgPSBmYWxzZTtcclxuICAgICAgICAgICAgcmVzdWx0TGlzdC5mb3JFYWNoKChyZXN1bHQ6IFZhbGlkYXRpb25SZXN1bHQpID0+IHtcclxuICAgICAgICAgICAgICBpZiAocmVzdWx0LmlzVmFsaWQpIHtcclxuICAgICAgICAgICAgICAgIC8vIOa4hemZpOmqjOivgemAmui/h+eahOmUmeivr1xyXG4gICAgICAgICAgICAgICAgZm9ybUNvbnRleHQuYmluZGluZ0RhdGEuY2hhbmdlcy5uZXh0KHtcclxuICAgICAgICAgICAgICAgICAgdHlwZTogQ2hhbmdlVHlwZS5VcGRhdGVFcnJvcnMsXHJcbiAgICAgICAgICAgICAgICAgIHBhdGg6IFtdXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgaGFuZGxlRXJyb3JzKHJlc3VsdC5lcnJvcnMpO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0pLFxyXG4gICAgICBzd2l0Y2hNYXAoKHJlc3VsdExpc3QpID0+IHtcclxuICAgICAgICBsZXQgaXNWYWxpZGF0ZWQgPSB0cnVlO1xyXG4gICAgICAgIGNvbnN0IGVycm9ycyA9IFtdO1xyXG4gICAgICAgIHJlc3VsdExpc3QuZm9yRWFjaCgocmVzdWx0OiBWYWxpZGF0aW9uUmVzdWx0KSA9PiB7XHJcbiAgICAgICAgICBpZiAoIXJlc3VsdC5pc1ZhbGlkKSB7XHJcbiAgICAgICAgICAgIGlzVmFsaWRhdGVkID0gZmFsc2U7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBlcnJvcnMucHVzaCguLi5yZXN1bHQuZXJyb3JzKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBpZiAoZXJyb3JzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgIHRoaXMuY29sbGVjdFZhbGlkYXRpb25FcnJvcnMocm9vdFZpZXdNb2RlbCwgZXJyb3JzLCB0aGlzLmZyYW1lQ29udGV4dC5uYW1lc3BhY2UpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBsZXQgdmVyaWZ5SW5mb3JtYXRpb25zID0gcm9vdFZpZXdNb2RlbC52ZXJpZnlJbmZvcm1hdGlvbnM7XHJcbiAgICAgICAgaWYgKGlzTW9kYWwgJiYgaGFzT3duVmVyaWZ5RGV0YWlsU2VydmljZSkge1xyXG4gICAgICAgICAgdmVyaWZ5SW5mb3JtYXRpb25zID0gcm9vdFZpZXdNb2RlbC52ZXJpZnlJbmZvcm1hdGlvbnMuZmlsdGVyKGl0ZW0gPT4gaXRlbS5uYW1lc3BhY2UgPT09IG5hbWVzcGFjZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIOWboOS4uuagoemqjOe0r+WKoOeahOe8mOaVhe+8jOWvvOiHtOS5i+WJjeeahOagoemqjOS/oeaBr+S4gOebtOWtmOWcqO+8jOWPquiDvemAmui/h+agoemqjOe7k+aenOadpeehruWumuaYr+WQpui/mOaciemUmeivr+S/oeaBr1xyXG4gICAgICAgIGlmIChpc1ZhbGlkYXRlZCAmJiBmb3JtVmFsaWQpIHtcclxuICAgICAgICAgIHZlcmlmeUluZm9ybWF0aW9ucyA9IHJvb3RWaWV3TW9kZWwudmVyaWZ5SW5mb3JtYXRpb25zID0gW107XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJvb3RWaWV3TW9kZWwudmVyaWZ5Y2F0aW9uQ2hhbmdlZC5uZXh0KHZlcmlmeUluZm9ybWF0aW9ucyk7XHJcbiAgICAgICAgaWYgKGlzVmFsaWRhdGVkICYmIGZvcm1WYWxpZCkge1xyXG4gICAgICAgICAgcmV0dXJuIG9mKHRydWUpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICByZXR1cm4gZW1wdHkoKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gICAgcmV0dXJuIHJlc3VsdCQ7XHJcbiAgfVxyXG5cclxuICBjb2xsZWN0VmFsaWRhdGlvbkVycm9ycyhyb290Vmlld01vZGVsOiBWaWV3TW9kZWwsIGVycm9yczogVmFsaWRhdGlvbkVycm9yW10sIG5hbWVzcGFjZTogc3RyaW5nLCBmaWx0ZXI6IGJvb2xlYW4gPSB0cnVlKSB7XHJcbiAgICBpZiAoZmlsdGVyKSB7XHJcbiAgICAgIHJvb3RWaWV3TW9kZWwudmVyaWZ5SW5mb3JtYXRpb25zID0gcm9vdFZpZXdNb2RlbC52ZXJpZnlJbmZvcm1hdGlvbnMuZmlsdGVyKGl0ZW0gPT4gaXRlbS5uYW1lc3BhY2UgIT09IG5hbWVzcGFjZSk7XHJcbiAgICB9XHJcbiAgICBlcnJvcnMuZm9yRWFjaCgodmFsaWRhdGlvbkVycm9yOiBWYWxpZGF0aW9uRXJyb3IpID0+IHtcclxuICAgICAgaWYgKHZhbGlkYXRpb25FcnJvci5jaGlsZHJlbiAmJiB2YWxpZGF0aW9uRXJyb3IuY2hpbGRyZW4ubGVuZ3RoKSB7XHJcbiAgICAgICAgdGhpcy5jb2xsZWN0VmFsaWRhdGlvbkVycm9ycyhyb290Vmlld01vZGVsLCB2YWxpZGF0aW9uRXJyb3IuY2hpbGRyZW4sIG5hbWVzcGFjZSwgZmFsc2UpO1xyXG4gICAgICB9XHJcbiAgICAgIGxldCBpZCA9ICcnO1xyXG4gICAgICBjb25zdCBmaW5kSWQgPSAodGFyZ2V0OiBhbnkpID0+IHtcclxuICAgICAgICBpZiAodGFyZ2V0ICYmIHRhcmdldC5kYXRhICYmIHRhcmdldC5kYXRhLmlkKSB7XHJcbiAgICAgICAgICBpZCA9IHRhcmdldC5kYXRhLmlkO1xyXG4gICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH0gZWxzZSBpZiAodGFyZ2V0W1BBUkVOVF9DTEFTU10pIHtcclxuICAgICAgICAgIGZpbmRJZCh0YXJnZXRbUEFSRU5UX0NMQVNTXSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9O1xyXG4gICAgICBmaW5kSWQodmFsaWRhdGlvbkVycm9yLnRhcmdldCk7XHJcbiAgICAgIGlmICh2YWxpZGF0aW9uRXJyb3IuY29uc3RyYWludHMpIHtcclxuICAgICAgICBjb25zdCB2YWxpZGF0aW9uUmVzdWx0VHlwZXMgPSBPYmplY3Qua2V5cyh2YWxpZGF0aW9uRXJyb3IuY29uc3RyYWludHMpO1xyXG4gICAgICAgIGlmICh2YWxpZGF0aW9uUmVzdWx0VHlwZXMubGVuZ3RoKSB7XHJcbiAgICAgICAgICBjb25zdCBvZmZzZXQgPSByb290Vmlld01vZGVsLnZlcmlmeUluZm9ybWF0aW9ucy5maWx0ZXIoaXRlbSA9PiBpdGVtLm5hbWVzcGFjZSA9PT0gbmFtZXNwYWNlKS5sZW5ndGg7XHJcbiAgICAgICAgICBsZXQgaW5kZXggPSByb290Vmlld01vZGVsLnZlcmlmeUluZm9ybWF0aW9ucy5maW5kSW5kZXgoaXRlbSA9PiBpdGVtLm5hbWVzcGFjZSA9PT0gbmFtZXNwYWNlKTtcclxuICAgICAgICAgIGluZGV4ID0gaW5kZXggPT09IC0xID8gMCA6IGluZGV4ICsgb2Zmc2V0O1xyXG4gICAgICAgICAgcm9vdFZpZXdNb2RlbC52ZXJpZnlJbmZvcm1hdGlvbnMuc3BsaWNlKGluZGV4LCAwLCB7XHJcbiAgICAgICAgICAgIGlkOiBpZCxcclxuICAgICAgICAgICAgbmFtZXNwYWNlLFxyXG4gICAgICAgICAgICB0YXJnZXRGaWVsZDogdmFsaWRhdGlvbkVycm9yLmZpZWxkLFxyXG4gICAgICAgICAgICBpbmRleDogdmFsaWRhdGlvbkVycm9yLmluZGV4LFxyXG4gICAgICAgICAgICB0aXRsZTogdmFsaWRhdGlvbkVycm9yLnByb3BlcnR5TmFtZSxcclxuICAgICAgICAgICAgbXNnOiB2YWxpZGF0aW9uRXJyb3IuY29uc3RyYWludHNbdmFsaWRhdGlvblJlc3VsdFR5cGVzWzBdXSxcclxuICAgICAgICAgICAgZnJhbWVDb250ZXh0OiB2YWxpZGF0aW9uRXJyb3IuZnJhbWVDb250ZXh0LFxyXG4gICAgICAgICAgICBmdWxsUGF0aDogdmFsaWRhdGlvbkVycm9yLmZ1bGxQYXRoLFxyXG4gICAgICAgICAgICB0eXBlOiB2YWxpZGF0aW9uUmVzdWx0VHlwZXNbMF0gPT09ICdyZXF1aXJlZCcgPyAnZW1wdHknIDogJ2Vycm9yJ1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6YeN572u5qCh6aqM5L+h5oGv77yI5LuF5b2T5YmN6KGo5Y2V77yJXHJcbiAgICovXHJcbiAgcHVibGljIHJlc2V0VmFsaWRhdGlvbigpOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgY29uc3QgaXNEaWFsb2cgPSB0aGlzLmlzSW5EaWFsb2coKTtcclxuICAgIGxldCByb290Vmlld01vZGVsID0gdGhpcy5mcmFtZUNvbnRleHQucm9vdC52aWV3TW9kZWw7XHJcbiAgICBpZiAoaXNEaWFsb2cpIHtcclxuICAgICAgcm9vdFZpZXdNb2RlbCA9IHRoaXMuZnJhbWVDb250ZXh0LmdldFZpcnR1YWxSb290RnJhbWVDb250ZXh0KCkudmlld01vZGVsO1xyXG4gICAgfVxyXG4gICAgbGV0IHZlcmlmeUluZm9ybWF0aW9ucyA9IHJvb3RWaWV3TW9kZWwudmVyaWZ5SW5mb3JtYXRpb25zO1xyXG4gICAgaWYgKHZlcmlmeUluZm9ybWF0aW9ucy5sZW5ndGgpIHtcclxuICAgICAgY29uc3QgbmFtZXNwYWNlID0gdGhpcy5mcmFtZUNvbnRleHQubmFtZXNwYWNlO1xyXG4gICAgICBpZiAobmFtZXNwYWNlICE9PSBudWxsKSB7XHJcbiAgICAgICAgdmVyaWZ5SW5mb3JtYXRpb25zID0gcm9vdFZpZXdNb2RlbC52ZXJpZnlJbmZvcm1hdGlvbnMuZmlsdGVyKGl0ZW0gPT4gaXRlbS5uYW1lc3BhY2UgIT09IG5hbWVzcGFjZSk7XHJcbiAgICAgIH1cclxuICAgICAgcm9vdFZpZXdNb2RlbC52ZXJpZnlJbmZvcm1hdGlvbnMgPSB2ZXJpZnlJbmZvcm1hdGlvbnM7XHJcbiAgICAgIC8vcm9vdFZpZXdNb2RlbC52ZXJpZnlJbmZvcm1hdGlvbnMuc3BsaWNlKDAsIHJvb3RWaWV3TW9kZWwudmVyaWZ5SW5mb3JtYXRpb25zLmxlbmd0aCk7XHJcbiAgICB9XHJcbiAgICByb290Vmlld01vZGVsLnZlcmlmeWNhdGlvbkNoYW5nZWQubmV4dCh2ZXJpZnlJbmZvcm1hdGlvbnMpO1xyXG4gICAgcmV0dXJuIG9mKG51bGwpO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmmK/lkKblnKjlvLnnqpflhoXpg6hcclxuICAgKi9cclxuICBwcml2YXRlIGlzSW5EaWFsb2coKSB7XHJcbiAgICByZXR1cm4gdGhpcy5mcmFtZUNvbnRleHQgJiYgdGhpcy5mcmFtZUNvbnRleHQuZ2V0VmlydHVhbFJvb3RGcmFtZUNvbnRleHQoKSAmJiB0aGlzLmZyYW1lQ29udGV4dC5nZXRWaXJ0dWFsUm9vdEZyYW1lQ29udGV4dCgpLmZyYW1lQ29tcG9uZW50ICYmIHRoaXMuZnJhbWVDb250ZXh0LmdldFZpcnR1YWxSb290RnJhbWVDb250ZXh0KCkuZnJhbWVDb21wb25lbnRbJ2lzRGlhbG9nUm9vdENvbXBvbmVudCddIHx8IGZhbHNlO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmi6XmnInni6zoh6rnmoTmoKHpqozmj5DnpLrmnI3liqFcclxuICAgKi9cclxuICBwcml2YXRlIGhhc093blZlcmlmeURldGFpbFNlcnZpY2UoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5mcmFtZUNvbnRleHQuaW5qZWN0b3IuZ2V0PFZlcmlmeURldGFpbFNlcnZpY2U+KFZlcmlmeURldGFpbFNlcnZpY2UsIG51bGwpICE9PSB0aGlzLmZyYW1lQ29udGV4dC5yb290LmFwcENvbnRleHQuaW5qZWN0b3IuZ2V0PFZlcmlmeURldGFpbFNlcnZpY2U+KFZlcmlmeURldGFpbFNlcnZpY2UsIG51bGwpOztcclxuICB9XHJcbn1cclxuXHJcbmV4cG9ydCB7IFZhbGlkYXRpb25TZXJ2aWNlIH07XHJcbiJdfQ==