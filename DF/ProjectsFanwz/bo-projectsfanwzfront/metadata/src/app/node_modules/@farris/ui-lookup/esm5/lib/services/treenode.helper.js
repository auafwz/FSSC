/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
var TreeNodeHelper = /** @class */ (function () {
    function TreeNodeHelper(instance) {
        this.instance = instance;
        this.flatAllNodes = [];
    }
    /**
     * @param {?} treeNode
     * @return {?}
     */
    TreeNodeHelper.prototype.getTreeInfo = /**
     * @param {?} treeNode
     * @return {?}
     */
    function (treeNode) {
        if (treeNode.data[this.treeInfo.dataField]) {
            return treeNode.data[this.treeInfo.dataField];
        }
        /** @type {?} */
        var data = treeNode.data;
        if (data && this.treeInfo.dataField) {
            /** @type {?} */
            var treeInfoDataField_1 = this.treeInfo.dataField.toLowerCase();
            /** @type {?} */
            var dataField = Object.keys(treeNode.data).find((/**
             * @param {?} n
             * @return {?}
             */
            function (n) {
                return n.toLowerCase() === treeInfoDataField_1;
            }));
            if (dataField) {
                return data[dataField];
            }
            else {
                console.error("\u672A\u627E\u5230\u6811\u5F62\u4FE1\u606F\u6570\u636E\u5B57\u6BB5\u3010" + this.treeInfo.dataField + "\u3011");
            }
        }
        else {
            console.error("\u672A\u627E\u5230\u6811\u5F62\u4FE1\u606F\u6570\u636E\u5B57\u6BB5\u3010" + this.treeInfo.dataField + "\u3011");
        }
    };
    /**
     * @param {?} treeNode
     * @return {?}
     */
    TreeNodeHelper.prototype.getTreeNodeLayer = /**
     * @param {?} treeNode
     * @return {?}
     */
    function (treeNode) {
        return this.getTreeInfo(treeNode)[this.treeInfo.layerField];
    };
    /** 更新节点的展开状态。 根据组件中 expandLevel 的值决定
     * -1：不展开，0：全部展开，>0 展开到指定级数
     */
    /**
     * 更新节点的展开状态。 根据组件中 expandLevel 的值决定
     * -1：不展开，0：全部展开，>0 展开到指定级数
     * @param {?} treeNodes
     * @param {?=} treeInfo
     * @return {?}
     */
    TreeNodeHelper.prototype.updateTreeNodeExpanded = /**
     * 更新节点的展开状态。 根据组件中 expandLevel 的值决定
     * -1：不展开，0：全部展开，>0 展开到指定级数
     * @param {?} treeNodes
     * @param {?=} treeInfo
     * @return {?}
     */
    function (treeNodes, treeInfo) {
        var _this = this;
        if (treeInfo === void 0) { treeInfo = null; }
        if (treeInfo) {
            this.treeInfo = treeInfo;
        }
        else {
            this.treeInfo = this.instance.treeInfo;
        }
        /** @type {?} */
        var expandLevel = this.instance.expandLevel;
        if (expandLevel === -1) {
            return;
        }
        if (!this.flatAllNodes.length) {
            this.flatAllNodes = this.treeData2Flat(null, treeNodes, 0, []);
        }
        treeNodes.forEach((/**
         * @param {?} tn
         * @return {?}
         */
        function (tn) {
            tn.expanded = _this.shoudExpand(expandLevel, _this.getTreeNodeLayer(tn));
            if (_this.isSelectNodeParent(tn)) {
                tn.expanded = true;
            }
            if (tn.children && tn.children.length) {
                _this.updateTreeNodeExpanded(tn.children, treeInfo);
            }
            else {
                tn.leaf = true;
            }
        }));
    };
    /**
     * @private
     * @param {?} parent
     * @param {?} nodes
     * @param {?} level
     * @param {?} parentIds
     * @return {?}
     */
    TreeNodeHelper.prototype.treeData2Flat = /**
     * @private
     * @param {?} parent
     * @param {?} nodes
     * @param {?} level
     * @param {?} parentIds
     * @return {?}
     */
    function (parent, nodes, level, parentIds) {
        var _this = this;
        /** @type {?} */
        var idField = this.instance.idField;
        /** @type {?} */
        var arr = [];
        if (nodes && nodes.length) {
            nodes.forEach((/**
             * @param {?} node
             * @param {?} index
             * @return {?}
             */
            function (node, index) {
                // node.parent = parent;
                // node.parent = parent;
                /** @type {?} */
                var parents = [];
                if (parent) {
                    /** @type {?} */
                    var parentID = parent.data[idField];
                    /** @type {?} */
                    var _parents = parentIds || [];
                    parents = parents.concat(_parents.map((/**
                     * @param {?} n
                     * @return {?}
                     */
                    function (n) { return n; })));
                    parents.push(parentID);
                }
                /** @type {?} */
                var rowNode = {
                    id: node.data[idField],
                    node: node,
                    level: level,
                    parents: parents,
                };
                arr.push(rowNode);
                arr = arr.concat(_this.treeData2Flat(node, node.children, level + 1, parents));
            }));
        }
        return arr;
    };
    /**
     * @private
     * @param {?} expandLevel
     * @param {?} nodeLayer
     * @return {?}
     */
    TreeNodeHelper.prototype.shoudExpand = /**
     * @private
     * @param {?} expandLevel
     * @param {?} nodeLayer
     * @return {?}
     */
    function (expandLevel, nodeLayer) {
        if (expandLevel === -1) {
            // -1 为不展开
            return false;
        }
        else if (expandLevel === 0) {
            // 0 为全部展开
            return true;
        }
        else {
            // 没有启用分层加载，通过展开层级确定是否展开该节点
            return nodeLayer <= expandLevel;
        }
    };
    /**
     * @private
     * @param {?} treeNode
     * @return {?}
     */
    TreeNodeHelper.prototype.isSelectNodeParent = /**
     * @private
     * @param {?} treeNode
     * @return {?}
     */
    function (treeNode) {
        var _this = this;
        if (this.instance.navSelectedIds) {
            /** @type {?} */
            var allParentIds = this.flatAllNodes.find((/**
             * @param {?} f
             * @return {?}
             */
            function (f) { return f.id === _this.instance.navSelectedIds; })).parents;
            if (allParentIds && allParentIds.length) {
                return allParentIds.includes(treeNode.id);
            }
            return false;
        }
        return false;
    };
    /**
     * @param {?} treeNode
     * @return {?}
     */
    TreeNodeHelper.prototype.getLeafNode = /**
     * @param {?} treeNode
     * @return {?}
     */
    function (treeNode) {
        if (treeNode && (!treeNode.children || !treeNode.children.length)) {
            return treeNode;
        }
        else {
            if (treeNode.children.length === 1) {
                return this.getLeafNode(treeNode.children[0]);
            }
            else {
                return treeNode.children;
            }
        }
    };
    /**
     * @param {?} items
     * @param {?=} result
     * @return {?}
     */
    TreeNodeHelper.prototype.flatTreeNodes = /**
     * @param {?} items
     * @param {?=} result
     * @return {?}
     */
    function (items, result) {
        var _this = this;
        if (result === void 0) { result = []; }
        items = items || [];
        return items.reduce((/**
         * @param {?} c
         * @param {?} n
         * @return {?}
         */
        function (c, n) {
            c.push(n);
            if (n.children && n.children.length) {
                _this.flatTreeNodes(n.children, c);
            }
            return c;
        }), result);
    };
    return TreeNodeHelper;
}());
export { TreeNodeHelper };
if (false) {
    /** @type {?} */
    TreeNodeHelper.prototype.treeInfo;
    /** @type {?} */
    TreeNodeHelper.prototype.flatAllNodes;
    /**
     * @type {?}
     * @private
     */
    TreeNodeHelper.prototype.instance;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJlZW5vZGUuaGVscGVyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy91aS1sb29rdXAvIiwic291cmNlcyI6WyJsaWIvc2VydmljZXMvdHJlZW5vZGUuaGVscGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFJQTtJQUdJLHdCQUFvQixRQUE2QjtRQUE3QixhQUFRLEdBQVIsUUFBUSxDQUFxQjtRQURqRCxpQkFBWSxHQUFHLEVBQUUsQ0FBQztJQUNtQyxDQUFDOzs7OztJQUV0RCxvQ0FBVzs7OztJQUFYLFVBQVksUUFBa0I7UUFDMUIsSUFBSSxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLEVBQUU7WUFDeEMsT0FBTyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLENBQUM7U0FDakQ7O1lBRUssSUFBSSxHQUFHLFFBQVEsQ0FBQyxJQUFJO1FBQzFCLElBQUksSUFBSSxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxFQUFFOztnQkFFM0IsbUJBQWlCLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsV0FBVyxFQUFFOztnQkFDekQsU0FBUyxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUk7Ozs7WUFBQyxVQUFBLENBQUM7Z0JBQy9DLE9BQU8sQ0FBQyxDQUFDLFdBQVcsRUFBRSxLQUFLLG1CQUFpQixDQUFDO1lBQ2pELENBQUMsRUFBQztZQUNGLElBQUksU0FBUyxFQUFFO2dCQUNYLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO2FBQzFCO2lCQUFNO2dCQUNILE9BQU8sQ0FBQyxLQUFLLENBQUMsNkVBQWUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxTQUFTLFdBQUcsQ0FBQyxDQUFDO2FBQzVEO1NBQ0o7YUFBTTtZQUNILE9BQU8sQ0FBQyxLQUFLLENBQUMsNkVBQWUsSUFBSSxD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QUFRLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxFQUFFO1lBQy9ELE9BQU8sUUFBUSxDQUFDO1NBQ25CO2FBQU07WUFDSCxJQUFJLFFBQVEsQ0FBQyxRQUFRLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtnQkFDaEMsT0FBTyxJQUFJLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQzthQUNqRDtpQkFBTTtnQkFDSCxPQUFPLFFBQVEsQ0FBQyxRQUFRLENBQUM7YUFDNUI7U0FDSjtJQUNMLENBQUM7Ozs7OztJQUVELHNDQUFhOzs7OztJQUFiLFVBQWMsS0FBSyxFQUFFLE1BQVc7UUFBaEMsaUJBU0M7UUFUb0IsdUJBQUEsRUFBQSxXQUFXO1FBQzVCLEtBQUssR0FBRyxLQUFLLElBQUksRUFBRSxDQUFDO1FBQ3BCLE9BQVEsS0FBSyxDQUFDLE1BQU07Ozs7O1FBQUMsVUFBQyxDQUFDLEVBQUUsQ0FBQztZQUN0QixDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ1YsSUFBSSxDQUFDLENBQUMsUUFBUSxJQUFJLENBQUMsQ0FBQyxRQUFRLENBQUMsTUFBTSxFQUFFO2dCQUNqQyxLQUFJLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDLENBQUM7YUFDckM7WUFDRCxPQUFPLENBQUMsQ0FBQztRQUNiLENBQUMsR0FBRSxNQUFNLENBQUMsQ0FBQztJQUNmLENBQUM7SUFDTCxxQkFBQztBQUFELENBQUMsQUF0SUQsSUFzSUM7Ozs7SUFySUcsa0NBQW1COztJQUNuQixzQ0FBa0I7Ozs7O0lBQ04sa0NBQXFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVHJlZU5vZGUgfSBmcm9tICdAZmFycmlzL3VpLXRyZWV0YWJsZSc7XHJcbmltcG9ydCB7IExvb2t1cEdyaWRDb21wb25lbnQgfSBmcm9tICcuLi9sb29rdXAtZ3JpZC5jb21wb25lbnQnO1xyXG5pbXBvcnQgeyBUcmVlSW5mbyB9IGZyb20gJy4uL2xvb2t1cC1ncmlkLW9wdGlvbnMnO1xyXG5cclxuZXhwb3J0IGNsYXNzIFRyZWVOb2RlSGVscGVyIHtcclxuICAgIHRyZWVJbmZvOiBUcmVlSW5mbztcclxuICAgIGZsYXRBbGxOb2RlcyA9IFtdO1xyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBpbnN0YW5jZTogTG9va3VwR3JpZENvbXBvbmVudCkgeyB9XHJcblxyXG4gICAgZ2V0VHJlZUluZm8odHJlZU5vZGU6IFRyZWVOb2RlKSB7XHJcbiAgICAgICAgaWYgKHRyZWVOb2RlLmRhdGFbdGhpcy50cmVlSW5mby5kYXRhRmllbGRdKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0cmVlTm9kZS5kYXRhW3RoaXMudHJlZUluZm8uZGF0YUZpZWxkXTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IGRhdGEgPSB0cmVlTm9kZS5kYXRhO1xyXG4gICAgICAgIGlmIChkYXRhICYmIHRoaXMudHJlZUluZm8uZGF0YUZpZWxkKSB7XHJcblxyXG4gICAgICAgICAgICBjb25zdCB0cmVlSW5mb0RhdGFGaWVsZCA9IHRoaXMudHJlZUluZm8uZGF0YUZpZWxkLnRvTG93ZXJDYXNlKCk7XHJcbiAgICAgICAgICAgIGNvbnN0IGRhdGFGaWVsZCA9IE9iamVjdC5rZXlzKHRyZWVOb2RlLmRhdGEpLmZpbmQobiA9PiB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbi50b0xvd2VyQ2FzZSgpID09PSB0cmVlSW5mb0RhdGFGaWVsZDtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIGlmIChkYXRhRmllbGQpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBkYXRhW2RhdGFGaWVsZF07XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGDmnKrmib7liLDmoJHlvaLkv6Hmga/mlbDmja7lrZfmrrXjgJAke3RoaXMudHJlZUluZm8uZGF0YUZpZWxkfeOAkWApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgY29uc29sZS5lcnJvcihg5pyq5om+5Yiw5qCR5b2i5L+h5oGv5pWw5o2u5a2X5q6144CQJHt0aGlzLnRyZWVJbmZvLmRhdGFGaWVsZH3jgJFgKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0VHJlZU5vZGVMYXllcih0cmVlTm9kZTogVHJlZU5vZGUpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5nZXRUcmVlSW5mbyh0cmVlTm9kZSlbdGhpcy50cmVlSW5mby5sYXllckZpZWxkXTtcclxuICAgIH1cclxuICAgIC8qKiDmm7TmlrDoioLngrnnmoTlsZXlvIDnirbmgIHjgIIg5qC55o2u57uE5Lu25LitIGV4cGFuZExldmVsIOeahOWAvOWGs+WumlxyXG4gICAgICogLTHvvJrkuI3lsZXlvIDvvIww77ya5YWo6YOo5bGV5byA77yMPjAg5bGV5byA5Yiw5oyH5a6a57qn5pWwXHJcbiAgICAgKi9cclxuICAgIHVwZGF0ZVRyZWVOb2RlRXhwYW5kZWQodHJlZU5vZGVzOiBUcmVlTm9kZVtdLCB0cmVlSW5mbzogVHJlZUluZm8gPSBudWxsKSB7XHJcbiAgICAgICAgaWYgKHRyZWVJbmZvKSB7XHJcbiAgICAgICAgICAgIHRoaXMudHJlZUluZm8gPSB0cmVlSW5mbztcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLnRyZWVJbmZvID0gdGhpcy5pbnN0YW5jZS50cmVlSW5mbztcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgZXhwYW5kTGV2ZWwgPSB0aGlzLmluc3RhbmNlLmV4cGFuZExldmVsO1xyXG4gICAgICAgIGlmIChleHBhbmRMZXZlbCA9PT0gLTEpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoIXRoaXMuZmxhdEFsbE5vZGVzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICB0aGlzLmZsYXRBbGxOb2RlcyA9IHRoaXMudHJlZURhdGEyRmxhdChudWxsLCB0cmVlTm9kZXMsIDAsIFtdKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRyZWVOb2Rlcy5mb3JFYWNoKCh0bjogVHJlZU5vZGUpID0+IHtcclxuICAgICAgICAgICAgdG4uZXhwYW5kZWQgPSB0aGlzLnNob3VkRXhwYW5kKGV4cGFuZExldmVsLCB0aGlzLmdldFRyZWVOb2RlTGF5ZXIodG4pKTtcclxuICAgICAgICAgICAgaWYgKHRoaXMuaXNTZWxlY3ROb2RlUGFyZW50KHRuKSkge1xyXG4gICAgICAgICAgICAgICAgdG4uZXhwYW5kZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmICh0bi5jaGlsZHJlbiAmJiB0bi5jaGlsZHJlbi5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlVHJlZU5vZGVFeHBhbmRlZCh0bi5jaGlsZHJlbiwgdHJlZUluZm8pO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdG4ubGVhZiA9IHRydWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHRyZWVEYXRhMkZsYXQocGFyZW50LCBub2RlcywgbGV2ZWwsIHBhcmVudElkcykge1xyXG4gICAgICAgIGNvbnN0IGlkRmllbGQgPSB0aGlzLmluc3RhbmNlLmlkRmllbGQ7XHJcbiAgICAgICAgbGV0IGFyciA9IFtdO1xyXG4gICAgICAgIGlmIChub2RlcyAmJiBub2Rlcy5sZW5ndGgpIHtcclxuXHJcbiAgICAgICAgICAgIG5vZGVzLmZvckVhY2goKG5vZGUsIGluZGV4KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAvLyBub2RlLnBhcmVudCA9IHBhcmVudDtcclxuXHJcbiAgICAgICAgICAgICAgICBsZXQgcGFyZW50cyA9IFtdO1xyXG4gICAgICAgICAgICAgICAgaWYgKHBhcmVudCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHBhcmVudElEID0gcGFyZW50LmRhdGFbaWRGaWVsZF07XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgX3BhcmVudHMgPSBwYXJlbnRJZHMgfHwgW107XHJcbiAgICAgICAgICAgICAgICAgICAgcGFyZW50cyA9IHBhcmVudHMuY29uY2F0KF9wYXJlbnRzLm1hcChuID0+IG4pKTtcclxuICAgICAgICAgICAgICAgICAgICBwYXJlbnRzLnB1c2gocGFyZW50SUQpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgY29uc3Qgcm93Tm9kZSA9IHtcclxuICAgICAgICAgICAgICAgICAgICBpZDogbm9kZS5kYXRhW2lkRmllbGRdLFxyXG4gICAgICAgICAgICAgICAgICAgIG5vZGUsXHJcbiAgICAgICAgICAgICAgICAgICAgbGV2ZWwsXHJcbiAgICAgICAgICAgICAgICAgICAgcGFyZW50cyxcclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICBhcnIucHVzaChyb3dOb2RlKTtcclxuICAgICAgICAgICAgICAgIGFyciA9IGFyci5jb25jYXQodGhpcy50cmVlRGF0YTJGbGF0KG5vZGUsIG5vZGUuY2hpbGRyZW4sIGxldmVsICsgMSwgcGFyZW50cykpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGFycjtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHNob3VkRXhwYW5kKGV4cGFuZExldmVsOiBudW1iZXIsIG5vZGVMYXllcjogbnVtYmVyKSB7XHJcbiAgICAgICAgaWYgKGV4cGFuZExldmVsID09PSAtMSkge1xyXG4gICAgICAgICAgICAvLyAtMSDkuLrkuI3lsZXlvIBcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoZXhwYW5kTGV2ZWwgPT09IDApIHtcclxuICAgICAgICAgICAgLy8gMCDkuLrlhajpg6jlsZXlvIBcclxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgLy8g5rKh5pyJ5ZCv55So5YiG5bGC5Yqg6L2977yM6YCa6L+H5bGV5byA5bGC57qn56Gu5a6a5piv5ZCm5bGV5byA6K+l6IqC54K5XHJcbiAgICAgICAgICAgIHJldHVybiBub2RlTGF5ZXIgPD0gZXhwYW5kTGV2ZWw7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgaXNTZWxlY3ROb2RlUGFyZW50KHRyZWVOb2RlKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuaW5zdGFuY2UubmF2U2VsZWN0ZWRJZHMpIHtcclxuICAgICAgICAgICAgY29uc3QgYWxsUGFyZW50SWRzOiBzdHJpbmdbXSA9IHRoaXMuZmxhdEFsbE5vZGVzLmZpbmQoZiA9PiBmLmlkID09PSB0aGlzLmluc3RhbmNlLm5hdlNlbGVjdGVkSWRzKS5wYXJlbnRzO1xyXG4gICAgICAgICAgICBpZiAoYWxsUGFyZW50SWRzICYmIGFsbFBhcmVudElkcy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBhbGxQYXJlbnRJZHMuaW5jbHVkZXModHJlZU5vZGUuaWQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG5cclxuICAgIGdldExlYWZOb2RlKHRyZWVOb2RlOiBUcmVlTm9kZSkge1xyXG4gICAgICAgIGlmICh0cmVlTm9kZSAmJiAoIXRyZWVOb2RlLmNoaWxkcmVuIHx8ICF0cmVlTm9kZS5jaGlsZHJlbi5sZW5ndGgpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0cmVlTm9kZTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBpZiAodHJlZU5vZGUuY2hpbGRyZW4ubGVuZ3RoID09PSAxKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRMZWFmTm9kZSh0cmVlTm9kZS5jaGlsZHJlblswXSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJlZU5vZGUuY2hpbGRyZW47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZmxhdFRyZWVOb2RlcyhpdGVtcywgcmVzdWx0ID0gW10pIHtcclxuICAgICAgICBpdGVtcyA9IGl0ZW1zIHx8IFtdO1xyXG4gICAgICAgIHJldHVybiAgaXRlbXMucmVkdWNlKChjLCBuKSA9PiB7XHJcbiAgICAgICAgICAgIGMucHVzaChuKTtcclxuICAgICAgICAgICAgaWYgKG4uY2hpbGRyZW4gJiYgbi5jaGlsZHJlbi5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZmxhdFRyZWVOb2RlcyhuLmNoaWxkcmVuLCBjKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gYztcclxuICAgICAgICB9LCByZXN1bHQpO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==