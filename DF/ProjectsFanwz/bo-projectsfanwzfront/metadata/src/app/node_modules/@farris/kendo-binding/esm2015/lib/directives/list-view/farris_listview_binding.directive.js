import { Directive, HostListener, Output, EventEmitter, Input } from '@angular/core';
import { BindingData, ViewModel } from '@farris/devkit';
import { ListViewComponent } from '@farris/ui-list-view';
export class FarrisListViewBindingDirective {
    constructor(bindingData, viewModel, listview) {
        this.bindingData = bindingData;
        this.viewModel = viewModel;
        this.listview = listview;
        this.supportPaged = true;
        /**
         * 选中行切换事件
         */
        this.selectedRowChange = new EventEmitter();
    }
    /**
     * 主键
     */
    get primaryKey() {
        return this.bindingList.primaryKey;
    }
    ngOnInit() {
        // 绑定数据
        this.bindData();
        this.registerBindingDataChangeEvent();
    }
    ngOnChanges() {
        this.bindData();
    }
    ngOnDestroy() {
        this.unRegisterBindingDataChangeEvent();
    }
    /**
     * 获取分页信息
     */
    getPagingInfo() {
        const bindingPath = this.viewModel.bindingPath;
        const bindingData = this.viewModel.bindingData;
        let pagingInfo = bindingData.pagingInfo;
        if (bindingPath === '/') {
            return pagingInfo;
        }
        else {
            const bindingPaths = bindingPath.substr(1).split('/').filter(item => !!item && item.length > 0).map(item => {
                return item.substring(0, item.length - 1);
            });
            bindingPaths.forEach(path => {
                pagingInfo = pagingInfo && pagingInfo[path];
            });
            return pagingInfo;
        }
    }
    /**
     * 设置listview属性
     */
    setListViewPageProps() {
        const data = this.bindingList.toJSON();
        let skip = 0;
        const { pageIndex = 1, pageSize = 0 } = this.getPagingInfo() || {};
        let { total = 0 } = this.getPagingInfo() || {};
        if (pageIndex > 0) {
            skip = (pageIndex - 1) * pageSize;
        }
        if (pageSize === 0 && total === 0) {
            total = data.length;
        }
        this.listview.supportPaging = this.supportPaged;
        this.listview.pageIndex = pageIndex;
        this.listview.pageSize = pageSize;
        this.listview.total = total;
        let currentPage = pageIndex;
        const itemsPerPage = pageSize;
        let totalItems = total;
        if (pageSize === 0) {
            // this.listview.supportPaging = false;
            this.listview.pageIndex = pageIndex;
            this.listview.total = total;
            currentPage = 1;
            totalItems = total;
        }
        if (this.listview.paginationOptions) {
            this.listview.paginationOptions.itemsPerPage = itemsPerPage;
            this.listview.paginationOptions.currentPage = currentPage;
            this.listview.paginationOptions.pageList = this.listview.pageList;
            this.listview.paginationOptions.totalItems = totalItems;
        }
        const listViewChangeDetectRef = this.listview['cdr'];
        if (listViewChangeDetectRef) {
            listViewChangeDetectRef.detectChanges();
        }
        const paginationDirective = this.listview.pager && this.listview.pager['paginationDirective'];
        if (paginationDirective && paginationDirective.service) {
            try {
                paginationDirective.service.instances[this.listview.pager.id] = Object.assign({}, this.listview.paginationOptions);
                paginationDirective.service.setTotalItems(totalItems);
                paginationDirective.changeDetectorRef.detectChanges();
            }
            catch (_a) { }
        }
    }
    /*
     * 获取绑定数据
     */
    get bindingList() {
        // 根实体
        if (this.viewModel.bindingPath === '/' || !this.viewModel.bindingPath) {
            return this.bindingData.list;
        }
        // 子实体
        let bindingPath = this.viewModel.bindingPath.substr(1);
        bindingPath = bindingPath[0].toLowerCase() + bindingPath.substring(1, bindingPath.length);
        const paths = bindingPath.split('/');
        const filteredPaths = paths.filter((part) => {
            return part !== '';
        });
        return this.bindingData.getValue(filteredPaths);
    }
    /* 绑定数据 */
    bindData() {
        this.setListViewPageProps();
        const data = this.bindingList.toArray();
        this.listview.setData(data);
    }
    /*
         * 发射选中行切换事件
         * @description 统一单选模式和多选模式下的行切换事件
         */
    fireSelectedRowChange(selectedRowContext) {
        this.selectedRowChange.emit(selectedRowContext);
    }
    /**
     * 设置BindingList的当前行
     * @param id 当前行内码
     */
    setSelectionIdToBindingData(id) {
        this.bindingList.setCurrentId(id, true);
    }
    /**
     * 数据源发生变更
     * @param change 变更
     */
    onBindingDataChange(change) {
        this.bindData();
        this.updateSelectedRow(change);
    }
    /**
     * 设置当前行
     * @param change 变更
     */
    updateSelectedRow(change) {
        if (!this.bindingList || !this.bindingList.currentId) {
            return;
        }
        if (this.viewModel && this.viewModel.frameContext.bindingData.rowSelectedEventSuspend === true) {
            return;
        }
        const { id = null } = this.listview.clickItem || {};
        const currentId = this.bindingList.currentId;
        // grid当前行与bingingList当前行一致，无须切换
        if (id === currentId) {
            return;
        }
        this.selectRow(this.bindingList.currentId);
    }
    selectRow(id) {
        if (this.listview && typeof this.listview.selectRow === 'function') {
            this.listview.selectRow(id);
        }
    }
    /**
     * 注册bindingdata变化事件
     */
    registerBindingDataChangeEvent() {
        this.bindingDataChangeEvent = this.bindingData.changes.subscribe((change) => {
            this.onBindingDataChange(change);
        });
    }
    /**
     * 取消bindingdata变化订阅
     */
    unRegisterBindingDataChangeEvent() {
        this.bindingDataChangeEvent.unsubscribe();
    }
    setChecks(ids) {
        this.viewModel.uiState.setPropertyValue('ids', ids);
    }
    /* 切换行事件 */
    changeRow(event) {
        const { index, data, checkChangeEvent } = event;
        if (checkChangeEvent === false || !event.hasOwnProperty('checkChangeEvent')) {
            if (data && Array.isArray(data) && data.length > 0) {
                const id = data[0] && data[0][this.primaryKey] || null;
                if (id) {
                    this.setSelectionIdToBindingData(id);
                }
            }
            this.listview.activeIndex = index;
            this.fireSelectedRowChange(event);
        }
    }
    /**
     * 切换页码触发事件
     * @param event 切换页码参数
     */
    pageChangedHandler(event) {
        let pageIndex = event.pageInfo.pageIndex;
        const pageSize = event.pageInfo.pageSize;
        if (pageIndex < 1) {
            pageIndex = 1;
        }
        const skip = (pageIndex - 1) * pageSize;
        this.bindingData.setPagingInfo(skip, pageSize, this.bindingData.bindingPath);
    }
    /**
     * 设置每页数据条数触发事件
     * @param event 切换页码参数
     */
    pageSizeChangedHandler(event) {
        const { pageIndex, pageSize } = event.pageInfo;
        const skip = (pageIndex - 1) * (+pageSize);
        this.bindingData.setPagingInfo(skip, pageSize, this.bindingData.bindingPath);
    }
    checkValuesChange(event) {
        const ids = event;
        this.setChecks(ids);
    }
}
FarrisListViewBindingDirective.decorators = [
    { type: Directive, args: [{
                selector: '[farrisListviewBinding]'
            },] }
];
/** @nocollapse */
FarrisListViewBindingDirective.ctorParameters = () => [
    { type: BindingData },
    { type: ViewModel },
    { type: ListViewComponent }
];
FarrisListViewBindingDirective.propDecorators = {
    supportPaged: [{ type: Input }],
    selectedRowChange: [{ type: Output }],
    changeRow: [{ type: HostListener, args: ['listClick', ['$event'],] }],
    pageChangedHandler: [{ type: HostListener, args: ['pageChanged', ['$event'],] }],
    pageSizeChangedHandler: [{ type: HostListener, args: ['pageSizeChanged', ['$event'],] }],
    checkValuesChange: [{ type: HostListener, args: ['checkValuesChange', ['$event'],] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmFycmlzX2xpc3R2aWV3X2JpbmRpbmcuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9rZW5kby1iaW5kaW5nLyIsInNvdXJjZXMiOlsibGliL2RpcmVjdGl2ZXMvbGlzdC12aWV3L2ZhcnJpc19saXN0dmlld19iaW5kaW5nLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsU0FBUyxFQUFVLFlBQVksRUFBRSxNQUFNLEVBQUUsWUFBWSxFQUF3QixLQUFLLEVBQXFCLE1BQU0sZUFBZSxDQUFDO0FBQ3RJLE9BQU8sRUFBRSxXQUFXLEVBQWUsU0FBUyxFQUFzQixNQUFNLGdCQUFnQixDQUFDO0FBQ3pGLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBTXpELE1BQU0sT0FBTyw4QkFBOEI7SUFnQnpDLFlBQ1UsV0FBd0IsRUFDeEIsU0FBb0IsRUFDcEIsUUFBMkI7UUFGM0IsZ0JBQVcsR0FBWCxXQUFXLENBQWE7UUFDeEIsY0FBUyxHQUFULFNBQVMsQ0FBVztRQUNwQixhQUFRLEdBQVIsUUFBUSxDQUFtQjtRQVQ1QixpQkFBWSxHQUFZLElBQUksQ0FBQztRQUN0Qzs7V0FFRztRQUNPLHNCQUFpQixHQUFzQixJQUFJLFlBQVksRUFBTyxDQUFDO0lBT3pFLENBQUM7SUFsQkQ7O09BRUc7SUFDSCxJQUFjLFVBQVU7UUFDdEIsT0FBTyxJQUFJLENBQUMsV0FBVyxDQUFDLFVBQVUsQ0FBQztJQUNyQyxDQUFDO0lBZUQsUUFBUTtRQUNOLE9BQU87UUFDUCxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDaEIsSUFBSSxDQUFDLDhCQUE4QixFQUFFLENBQUM7SUFFeEMsQ0FBQztJQUVELFdBQVc7UUFDVCxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDbEIsQ0FBQztJQUVELFdBQVc7UUFDVCxJQUFJLENBQUMsZ0NBQWdDLEVBQUUsQ0FBQztJQUMxQyxDQUFDO0lBRUQ7O09B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QVEsRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBQy9FLENBQUM7SUFFRDs7O09BR0c7SUFFSSxzQkFBc0IsQ0FBQyxLQUFVO1FBQ3RDLE1BQU0sRUFBRSxTQUFTLEVBQUUsUUFBUSxFQUFFLEdBQUcsS0FBSyxDQUFDLFFBQVEsQ0FBQztRQUMvQyxNQUFNLElBQUksR0FBRyxDQUFDLFNBQVMsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDM0MsSUFBSSxDQUFDLFdBQVcsQ0FBQyxhQUFhLENBQUMsSUFBSSxFQUFFLFFBQVEsRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBQy9FLENBQUM7SUFFTSxpQkFBaUIsQ0FBQyxLQUFVO1FBQ2pDLE1BQU0sR0FBRyxHQUFHLEtBQUssQ0FBQztRQUNsQixJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3RCLENBQUM7OztZQXRQRixTQUFTLFNBQUM7Z0JBQ1QsUUFBUSxFQUFFLHlCQUF5QjthQUNwQzs7OztZQUxRLFdBQVc7WUFBZSxTQUFTO1lBQ25DLGlCQUFpQjs7OzJCQWdCdkIsS0FBSztnQ0FJTCxNQUFNO3dCQXdMTixZQUFZLFNBQUMsV0FBVyxFQUFFLENBQUMsUUFBUSxDQUFDO2lDQW1CcEMsWUFBWSxTQUFDLGFBQWEsRUFBRSxDQUFDLFFBQVEsQ0FBQztxQ0FldEMsWUFBWSxTQUFDLGlCQUFpQixFQUFFLENBQUMsUUFBUSxDQUFDO2dDQU0xQyxZQUFZLFNBQUMsbUJBQW1CLEVBQUUsQ0FBQyxRQUFRLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgRGlyZWN0aXZlLCBPbkluaXQsIEhvc3RMaXN0ZW5lciwgT3V0cHV0LCBFdmVudEVtaXR0ZXIsIE9uRGVzdHJveSwgT25DaGFuZ2VzLCBJbnB1dCwgQ2hhbmdlRGV0ZWN0b3JSZWYgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgQmluZGluZ0RhdGEsIEJpbmRpbmdMaXN0LCBWaWV3TW9kZWwsIENoYW5nZVR5cGUsIENoYW5nZSB9IGZyb20gJ0BmYXJyaXMvZGV2a2l0JztcclxuaW1wb3J0IHsgTGlzdFZpZXdDb21wb25lbnQgfSBmcm9tICdAZmFycmlzL3VpLWxpc3Qtdmlldyc7XHJcbmltcG9ydCB7IFBhZ2luYXRpb25Db250cm9sc0RpcmVjdGl2ZSB9IGZyb20gJ0BmYXJyaXMvdWktZGF0YWdyaWQnO1xyXG5ARGlyZWN0aXZlKHtcclxuICBzZWxlY3RvcjogJ1tmYXJyaXNMaXN0dmlld0JpbmRpbmddJ1xyXG59KVxyXG5cclxuZXhwb3J0IGNsYXNzIEZhcnJpc0xpc3RWaWV3QmluZGluZ0RpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95LCBPbkNoYW5nZXMge1xyXG4gIGJpbmRpbmdEYXRhQ2hhbmdlRXZlbnQ6IFN1YnNjcmlwdGlvbjtcclxuXHJcbiAgLyoqXHJcbiAgICog5Li76ZSuXHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIGdldCBwcmltYXJ5S2V5KCkge1xyXG4gICAgcmV0dXJuIHRoaXMuYmluZGluZ0xpc3QucHJpbWFyeUtleTtcclxuICB9XHJcblxyXG4gIEBJbnB1dCgpIHN1cHBvcnRQYWdlZDogYm9vbGVhbiA9IHRydWU7XHJcbiAgLyoqXHJcbiAgICog6YCJ5Lit6KGM5YiH5o2i5LqL5Lu2XHJcbiAgICovXHJcbiAgQE91dHB1dCgpIHNlbGVjdGVkUm93Q2hhbmdlOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xyXG5cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHByaXZhdGUgYmluZGluZ0RhdGE6IEJpbmRpbmdEYXRhLFxyXG4gICAgcHJpdmF0ZSB2aWV3TW9kZWw6IFZpZXdNb2RlbCxcclxuICAgIHByaXZhdGUgbGlzdHZpZXc6IExpc3RWaWV3Q29tcG9uZW50KSB7XHJcblxyXG4gIH1cclxuXHJcbiAgbmdPbkluaXQoKSB7XHJcbiAgICAvLyDnu5HlrprmlbDmja5cclxuICAgIHRoaXMuYmluZERhdGEoKTtcclxuICAgIHRoaXMucmVnaXN0ZXJCaW5kaW5nRGF0YUNoYW5nZUV2ZW50KCk7XHJcblxyXG4gIH1cclxuXHJcbiAgbmdPbkNoYW5nZXMoKSB7XHJcbiAgICB0aGlzLmJpbmREYXRhKCk7XHJcbiAgfVxyXG5cclxuICBuZ09uRGVzdHJveSgpIHtcclxuICAgIHRoaXMudW5SZWdpc3RlckJpbmRpbmdEYXRhQ2hhbmdlRXZlbnQoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluWIhumhteS/oeaBr1xyXG4gICAqL1xyXG4gIHByb3RlY3RlZCBnZXRQYWdpbmdJbmZvKCkge1xyXG4gICAgY29uc3QgYmluZGluZ1BhdGggPSB0aGlzLnZpZXdNb2RlbC5iaW5kaW5nUGF0aDtcclxuICAgIGNvbnN0IGJpbmRpbmdEYXRhID0gdGhpcy52aWV3TW9kZWwuYmluZGluZ0RhdGE7XHJcbiAgICBsZXQgcGFnaW5nSW5mbyA9IGJpbmRpbmdEYXRhLnBhZ2luZ0luZm87XHJcbiAgICBpZiAoYmluZGluZ1BhdGggPT09ICcvJykge1xyXG4gICAgICByZXR1cm4gcGFnaW5nSW5mbztcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGNvbnN0IGJpbmRpbmdQYXRocyA9IGJpbmRpbmdQYXRoLnN1YnN0cigxKS5zcGxpdCgnLycpLmZpbHRlcihpdGVtID0+ICEhaXRlbSAmJiBpdGVtLmxlbmd0aCA+IDApLm1hcChpdGVtID0+IHtcclxuICAgICAgICByZXR1cm4gaXRlbS5zdWJzdHJpbmcoMCwgaXRlbS5sZW5ndGggLSAxKTtcclxuICAgICAgfSk7XHJcbiAgICAgIGJpbmRpbmdQYXRocy5mb3JFYWNoKHBhdGggPT4ge1xyXG4gICAgICAgIHBhZ2luZ0luZm8gPSBwYWdpbmdJbmZvICYmIHBhZ2luZ0luZm9bcGF0aF07XHJcbiAgICAgIH0pO1xyXG4gICAgICByZXR1cm4gcGFnaW5nSW5mbztcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiuvue9rmxpc3R2aWV35bGe5oCnXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBzZXRMaXN0Vmlld1BhZ2VQcm9wcygpIHtcclxuICAgIGNvbnN0IGRhdGEgPSB0aGlzLmJpbmRpbmdMaXN0LnRvSlNPTigpO1xyXG4gICAgbGV0IHNraXAgPSAwO1xyXG4gICAgY29uc3QgeyBwYWdlSW5kZXggPSAxLCBwYWdlU2l6ZSA9IDAgfSA9IHRoaXMuZ2V0UGFnaW5nSW5mbygpIHx8IHt9O1xyXG4gICAgbGV0IHsgdG90YWwgPSAwIH0gPSB0aGlzLmdldFBhZ2luZ0luZm8oKSB8fCB7fTtcclxuICAgIGlmIChwYWdlSW5kZXggPiAwKSB7XHJcbiAgICAgIHNraXAgPSAocGFnZUluZGV4IC0gMSkgKiBwYWdlU2l6ZTtcclxuICAgIH1cclxuICAgIGlmIChwYWdlU2l6ZSA9PT0gMCAmJiB0b3RhbCA9PT0gMCkge1xyXG4gICAgICB0b3RhbCA9IGRhdGEubGVuZ3RoO1xyXG4gICAgfVxyXG4gICAgdGhpcy5saXN0dmlldy5zdXBwb3J0UGFnaW5nID0gdGhpcy5zdXBwb3J0UGFnZWQ7XHJcbiAgICB0aGlzLmxpc3R2aWV3LnBhZ2VJbmRleCA9IHBhZ2VJbmRleDtcclxuICAgIHRoaXMubGlzdHZpZXcucGFnZVNpemUgPSBwYWdlU2l6ZTtcclxuICAgIHRoaXMubGlzdHZpZXcudG90YWwgPSB0b3RhbDtcclxuICAgIGxldCBjdXJyZW50UGFnZSA9IHBhZ2VJbmRleDtcclxuICAgIGNvbnN0IGl0ZW1zUGVyUGFnZSA9IHBhZ2VTaXplO1xyXG4gICAgbGV0IHRvdGFsSXRlbXMgPSB0b3RhbDtcclxuICAgIGlmIChwYWdlU2l6ZSA9PT0gMCkge1xyXG4gICAgICAvLyB0aGlzLmxpc3R2aWV3LnN1cHBvcnRQYWdpbmcgPSBmYWxzZTtcclxuICAgICAgdGhpcy5saXN0dmlldy5wYWdlSW5kZXggPSBwYWdlSW5kZXg7XHJcbiAgICAgIHRoaXMubGlzdHZpZXcudG90YWwgPSB0b3RhbDtcclxuICAgICAgY3VycmVudFBhZ2UgPSAxO1xyXG4gICAgICB0b3RhbEl0ZW1zID0gdG90YWw7XHJcbiAgICB9XHJcbiAgICBpZiAodGhpcy5saXN0dmlldy5wYWdpbmF0aW9uT3B0aW9ucykge1xyXG4gICAgICB0aGlzLmxpc3R2aWV3LnBhZ2luYXRpb25PcHRpb25zLml0ZW1zUGVyUGFnZSA9IGl0ZW1zUGVyUGFnZTtcclxuICAgICAgdGhpcy5saXN0dmlldy5wYWdpbmF0aW9uT3B0aW9ucy5jdXJyZW50UGFnZSA9IGN1cnJlbnRQYWdlO1xyXG4gICAgICB0aGlzLmxpc3R2aWV3LnBhZ2luYXRpb25PcHRpb25zLnBhZ2VMaXN0ID0gdGhpcy5saXN0dmlldy5wYWdlTGlzdDtcclxuICAgICAgdGhpcy5saXN0dmlldy5wYWdpbmF0aW9uT3B0aW9ucy50b3RhbEl0ZW1zID0gdG90YWxJdGVtcztcclxuICAgIH1cclxuICAgIGNvbnN0IGxpc3RWaWV3Q2hhbmdlRGV0ZWN0UmVmOiBDaGFuZ2VEZXRlY3RvclJlZiA9IHRoaXMubGlzdHZpZXdbJ2NkciddIGFzIENoYW5nZURldGVjdG9yUmVmO1xyXG4gICAgaWYgKGxpc3RWaWV3Q2hhbmdlRGV0ZWN0UmVmKSB7XHJcbiAgICAgIGxpc3RWaWV3Q2hhbmdlRGV0ZWN0UmVmLmRldGVjdENoYW5nZXMoKTtcclxuICAgIH1cclxuICAgIGNvbnN0IHBhZ2luYXRpb25EaXJlY3RpdmUgPSB0aGlzLmxpc3R2aWV3LnBhZ2VyICYmIHRoaXMubGlzdHZpZXcucGFnZXJbJ3BhZ2luYXRpb25EaXJlY3RpdmUnXTtcclxuICAgIGlmIChwYWdpbmF0aW9uRGlyZWN0aXZlICYmIHBhZ2luYXRpb25EaXJlY3RpdmUuc2VydmljZSkge1xyXG4gICAgICB0cnkge1xyXG4gICAgICAgIHBhZ2luYXRpb25EaXJlY3RpdmUuc2VydmljZS5pbnN0YW5jZXNbdGhpcy5saXN0dmlldy5wYWdlci5pZF0gPSB7IC4uLnRoaXMubGlzdHZpZXcucGFnaW5hdGlvbk9wdGlvbnMgfTtcclxuICAgICAgICBwYWdpbmF0aW9uRGlyZWN0aXZlLnNlcnZpY2Uuc2V0VG90YWxJdGVtcyh0b3RhbEl0ZW1zKTtcclxuICAgICAgICBwYWdpbmF0aW9uRGlyZWN0aXZlLmNoYW5nZURldGVjdG9yUmVmLmRldGVjdENoYW5nZXMoKTtcclxuICAgICAgfSBjYXRjaCB7IH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qXHJcbiAgICog6I635Y+W57uR5a6a5pWw5o2uXHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIGdldCBiaW5kaW5nTGlzdCgpOiBCaW5kaW5nTGlzdCB7XHJcbiAgICAvLyDmoLnlrp7kvZNcclxuICAgIGlmICh0aGlzLnZpZXdNb2RlbC5iaW5kaW5nUGF0aCA9PT0gJy8nIHx8ICF0aGlzLnZpZXdNb2RlbC5iaW5kaW5nUGF0aCkge1xyXG4gICAgICByZXR1cm4gdGhpcy5iaW5kaW5nRGF0YS5saXN0O1xyXG4gICAgfVxyXG4gICAgLy8g5a2Q5a6e5L2TXHJcbiAgICBsZXQgYmluZGluZ1BhdGggPSB0aGlzLnZpZXdNb2RlbC5iaW5kaW5nUGF0aC5zdWJzdHIoMSk7XHJcbiAgICBiaW5kaW5nUGF0aCA9IGJpbmRpbmdQYXRoWzBdLnRvTG93ZXJDYXNlKCkgKyBiaW5kaW5nUGF0aC5zdWJzdHJpbmcoMSwgYmluZGluZ1BhdGgubGVuZ3RoKTtcclxuICAgIGNvbnN0IHBhdGhzID0gYmluZGluZ1BhdGguc3BsaXQoJy8nKTtcclxuXHJcbiAgICBjb25zdCBmaWx0ZXJlZFBhdGhzID0gcGF0aHMuZmlsdGVyKChwYXJ0OiBzdHJpbmcpID0+IHtcclxuICAgICAgcmV0dXJuIHBhcnQgIT09ICcnO1xyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gdGhpcy5iaW5kaW5nRGF0YS5nZXRWYWx1ZShmaWx0ZXJlZFBhdGhzKTtcclxuICB9XHJcblxyXG4gIC8qIOe7keWumuaVsOaNriAqL1xyXG4gIHByaXZhdGUgYmluZERhdGEoKSB7XHJcbiAgICB0aGlzLnNldExpc3RWaWV3UGFnZVByb3BzKCk7XHJcbiAgICBjb25zdCBkYXRhID0gdGhpcy5iaW5kaW5nTGlzdC50b0FycmF5KCk7XHJcbiAgICB0aGlzLmxpc3R2aWV3LnNldERhdGEoZGF0YSk7XHJcbiAgfVxyXG5cclxuICAvKlxyXG4gICAgICAgKiDlj5HlsITpgInkuK3ooYzliIfmjaLkuovku7ZcclxuICAgICAgICogQGRlc2NyaXB0aW9uIOe7n+S4gOWNlemAieaooeW8j+WSjOWkmumAieaooeW8j+S4i+eahOihjOWIh+aNouS6i+S7tlxyXG4gICAgICAgKi9cclxuICBwcm90ZWN0ZWQgZmlyZVNlbGVjdGVkUm93Q2hhbmdlKHNlbGVjdGVkUm93Q29udGV4dDogYW55KSB7XHJcbiAgICB0aGlzLnNlbGVjdGVkUm93Q2hhbmdlLmVtaXQoc2VsZWN0ZWRSb3dDb250ZXh0KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiuvue9rkJpbmRpbmdMaXN055qE5b2T5YmN6KGMXHJcbiAgICogQHBhcmFtIGlkIOW9k+WJjeihjOWGheeggVxyXG4gICAqL1xyXG4gIHByb3RlY3RlZCBzZXRTZWxlY3Rpb25JZFRvQmluZGluZ0RhdGEoaWQ6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgdGhpcy5iaW5kaW5nTGlzdC5zZXRDdXJyZW50SWQoaWQsIHRydWUpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5pWw5o2u5rqQ5Y+R55Sf5Y+Y5pu0XHJcbiAgICogQHBhcmFtIGNoYW5nZSDlj5jmm7RcclxuICAgKi9cclxuICBwcm90ZWN0ZWQgb25CaW5kaW5nRGF0YUNoYW5nZShjaGFuZ2U6IENoYW5nZSkge1xyXG4gICAgdGhpcy5iaW5kRGF0YSgpO1xyXG4gICAgdGhpcy51cGRhdGVTZWxlY3RlZFJvdyhjaGFuZ2UpO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDorr7nva7lvZPliY3ooYxcclxuICAgKiBAcGFyYW0gY2hhbmdlIOWPmOabtFxyXG4gICAqL1xyXG4gIHByaXZhdGUgdXBkYXRlU2VsZWN0ZWRSb3coY2hhbmdlPzogQ2hhbmdlKSB7XHJcbiAgICBpZiAoIXRoaXMuYmluZGluZ0xpc3QgfHwgIXRoaXMuYmluZGluZ0xpc3QuY3VycmVudElkKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGlmICh0aGlzLnZpZXdNb2RlbCAmJiB0aGlzLnZpZXdNb2RlbC5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEucm93U2VsZWN0ZWRFdmVudFN1c3BlbmQgPT09IHRydWUpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgY29uc3QgeyBpZCA9IG51bGwgfSA9IHRoaXMubGlzdHZpZXcuY2xpY2tJdGVtIHx8IHt9O1xyXG4gICAgY29uc3QgY3VycmVudElkID0gdGhpcy5iaW5kaW5nTGlzdC5jdXJyZW50SWQ7XHJcbiAgICAvLyBncmlk5b2T5YmN6KGM5LiOYmluZ2luZ0xpc3TlvZPliY3ooYzkuIDoh7TvvIzml6DpobvliIfmjaJcclxuICAgIGlmIChpZCA9PT0gY3VycmVudElkKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIHRoaXMuc2VsZWN0Um93KHRoaXMuYmluZGluZ0xpc3QuY3VycmVudElkKTtcclxuICB9XHJcbiAgcHJvdGVjdGVkIHNlbGVjdFJvdyhpZDogYW55KSB7XHJcbiAgICBpZiAodGhpcy5saXN0dmlldyAmJiB0eXBlb2YgdGhpcy5saXN0dmlldy5zZWxlY3RSb3cgPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgdGhpcy5saXN0dmlldy5zZWxlY3RSb3coaWQpO1xyXG4gICAgfVxyXG4gIH1cclxuICAvKipcclxuICAgKiDms6jlhoxiaW5kaW5nZGF0YeWPmOWMluS6i+S7tlxyXG4gICAqL1xyXG4gIHByaXZhdGUgcmVnaXN0ZXJCaW5kaW5nRGF0YUNoYW5nZUV2ZW50KCkge1xyXG4gICAgdGhpcy5iaW5kaW5nRGF0YUNoYW5nZUV2ZW50ID0gdGhpcy5iaW5kaW5nRGF0YS5jaGFuZ2VzLnN1YnNjcmliZSgoY2hhbmdlOiBDaGFuZ2UpID0+IHtcclxuICAgICAgdGhpcy5vbkJpbmRpbmdEYXRhQ2hhbmdlKGNoYW5nZSk7XHJcbiAgICB9KTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5Y+W5raIYmluZGluZ2RhdGHlj5jljJborqLpmIVcclxuICAgKi9cclxuICBwcml2YXRlIHVuUmVnaXN0ZXJCaW5kaW5nRGF0YUNoYW5nZUV2ZW50KCkge1xyXG4gICAgdGhpcy5iaW5kaW5nRGF0YUNoYW5nZUV2ZW50LnVuc3Vic2NyaWJlKCk7XHJcbiAgfVxyXG4gIHByaXZhdGUgc2V0Q2hlY2tzKGlkczogc3RyaW5nW10pIHtcclxuICAgIHRoaXMudmlld01vZGVsLnVpU3RhdGUuc2V0UHJvcGVydHlWYWx1ZSgnaWRzJywgaWRzKTtcclxuICB9XHJcbiAgLyog5YiH5o2i6KGM5LqL5Lu2ICovXHJcbiAgQEhvc3RMaXN0ZW5lcignbGlzdENsaWNrJywgWyckZXZlbnQnXSlcclxuICBjaGFuZ2VSb3coZXZlbnQ6IGFueSkge1xyXG4gICAgY29uc3QgeyBpbmRleCwgZGF0YSwgY2hlY2tDaGFuZ2VFdmVudCB9ID0gZXZlbnQ7XHJcbiAgICBpZiAoY2hlY2tDaGFuZ2VFdmVudCA9PT0gZmFsc2UgfHwgIWV2ZW50Lmhhc093blByb3BlcnR5KCdjaGVja0NoYW5nZUV2ZW50JykpIHtcclxuICAgICAgaWYgKGRhdGEgJiYgQXJyYXkuaXNBcnJheShkYXRhKSAmJiBkYXRhLmxlbmd0aCA+IDApIHtcclxuICAgICAgICBjb25zdCBpZCA9IGRhdGFbMF0gJiYgZGF0YVswXVt0aGlzLnByaW1hcnlLZXldIHx8IG51bGw7XHJcbiAgICAgICAgaWYgKGlkKSB7XHJcbiAgICAgICAgICB0aGlzLnNldFNlbGVjdGlvbklkVG9CaW5kaW5nRGF0YShpZCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIHRoaXMubGlzdHZpZXcuYWN0aXZlSW5kZXggPSBpbmRleDtcclxuICAgICAgdGhpcy5maXJlU2VsZWN0ZWRSb3dDaGFuZ2UoZXZlbnQpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5YiH5o2i6aG156CB6Kem5Y+R5LqL5Lu2XHJcbiAgICogQHBhcmFtIGV2ZW50IOWIh+aNoumhteeggeWPguaVsFxyXG4gICAqL1xyXG4gIEBIb3N0TGlzdGVuZXIoJ3BhZ2VDaGFuZ2VkJywgWyckZXZlbnQnXSlcclxuICBwdWJsaWMgcGFnZUNoYW5nZWRIYW5kbGVyKGV2ZW50OiBhbnkpIHtcclxuICAgIGxldCBwYWdlSW5kZXggPSBldmVudC5wYWdlSW5mby5wYWdlSW5kZXg7XHJcbiAgICBjb25zdCBwYWdlU2l6ZSA9IGV2ZW50LnBhZ2VJbmZvLnBhZ2VTaXplO1xyXG4gICAgaWYgKHBhZ2VJbmRleCA8IDEpIHtcclxuICAgICAgcGFnZUluZGV4ID0gMTtcclxuICAgIH1cclxuICAgIGNvbnN0IHNraXAgPSAocGFnZUluZGV4IC0gMSkgKiBwYWdlU2l6ZTtcclxuICAgIHRoaXMuYmluZGluZ0RhdGEuc2V0UGFnaW5nSW5mbyhza2lwLCBwYWdlU2l6ZSwgdGhpcy5iaW5kaW5nRGF0YS5iaW5kaW5nUGF0aCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDorr7nva7mr4/pobXmlbDmja7mnaHmlbDop6blj5Hkuovku7ZcclxuICAgKiBAcGFyYW0gZXZlbnQg5YiH5o2i6aG156CB5Y+C5pWwXHJcbiAgICovXHJcbiAgQEhvc3RMaXN0ZW5lcigncGFnZVNpemVDaGFuZ2VkJywgWyckZXZlbnQnXSlcclxuICBwdWJsaWMgcGFnZVNpemVDaGFuZ2VkSGFuZGxlcihldmVudDogYW55KSB7XHJcbiAgICBjb25zdCB7IHBhZ2VJbmRleCwgcGFnZVNpemUgfSA9IGV2ZW50LnBhZ2VJbmZvO1xyXG4gICAgY29uc3Qgc2tpcCA9IChwYWdlSW5kZXggLSAxKSAqICgrcGFnZVNpemUpO1xyXG4gICAgdGhpcy5iaW5kaW5nRGF0YS5zZXRQYWdpbmdJbmZvKHNraXAsIHBhZ2VTaXplLCB0aGlzLmJpbmRpbmdEYXRhLmJpbmRpbmdQYXRoKTtcclxuICB9XHJcbiAgQEhvc3RMaXN0ZW5lcignY2hlY2tWYWx1ZXNDaGFuZ2UnLCBbJyRldmVudCddKVxyXG4gIHB1YmxpYyBjaGVja1ZhbHVlc0NoYW5nZShldmVudDogYW55KSB7XHJcbiAgICBjb25zdCBpZHMgPSBldmVudDtcclxuICAgIHRoaXMuc2V0Q2hlY2tzKGlkcyk7XHJcbiAgfVxyXG59XHJcbiJdfQ==