/**
 * @fileoverview added by tsickle
 * Generated from: lib/ffileupload-adapt-unifile.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { UploadServerService, UploadStatus } from '@farris/extend-file-upload';
import { Observable, forkJoin } from 'rxjs';
import { UploadService, GspFormUploadListEntity, GspFormRemoveListEntity, GspFormDocInfo, GspFormUploadEntity, OperatingModes } from '@gsp-svc/formdoc-upload';
import { FFileUploadAdaptUnifileConfigService } from './ffileupload-adapt-unifile.config';
import * as i0 from "@angular/core";
import * as i1 from "@gsp-svc/formdoc-upload";
import * as i2 from "./ffileupload-adapt-unifile.config";
export class FfileuploadAdaptUnifileService extends UploadServerService {
    /**
     * @param {?} uploadSer
     * @param {?} configSer
     */
    constructor(uploadSer, configSer) {
        super();
        this.uploadSer = uploadSer;
        this.configSer = configSer;
        // 暂时用于简单合并
        this.bufferSize = 1024 * 1024; // 1024 * 1024
        this.uploadedChunk = {};
        this.fileTotalChunk = {};
        this.extendData = this.configSer.getConfig();
    }
    /**
     * @private
     * @return {?}
     */
    uuid() {
        /** @type {?} */
        let S4 = (/**
         * @return {?}
         */
        function () {
            return (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1);
        });
        /** @type {?} */
        let nGuid = S4() + S4() + S4() + S4() + S4() + S4() + S4() + S4();
        return nGuid;
    }
    /**
     * 删除文件
     * @param {?} files
     * @param {?} event
     * @param {?} extendService
     * @return {?}
     */
    remove(files, event, extendService) {
        return this.innerRemoveList(files, event, extendService);
    }
    /**
     * @private
     * @param {?} files
     * @param {?} event
     * @param {?=} extendService
     * @return {?}
     */
    innerRemoveList(files, event, extendService = null) {
        return new Observable((/**
         * @param {?} observer
         * @return {?}
         */
        observer => {
            /** @type {?} */
            let removeFileInfo = new GspFormRemoveListEntity;
            /** @type {?} */
            let metadataIdList = [];
            files.forEach((/**
             * @param {?} fileItem
             * @return {?}
             */
            fileItem => {
                if (fileItem['response']) {
                    metadataIdList.push(fileItem['response']['metadataId']);
                }
            }));
            removeFileInfo.mode = this.getFinallyConfig('mode', extendService);
            /** @type {?} */
            let rootId = this.getFinallyConfig('rootId', extendService);
            removeFileInfo.metadataIdList = [].concat(metadataIdList);
            this.uploadSer.removeList(metadataIdList, rootId).subscribe((/**
             * @param {?} result
             * @return {?}
             */
            result => {
                // 没有需要整合的服务器端返回数据
                observer.next({ type: 'removed', files: files });
            }), (/**
             * @param {?} error
             * @return {?}
             */
            error => {
                observer.error(error);
                observer.complete();
            }), (/**
             * @return {?}
             */
            () => {
                observer.complete();
            }));
        }));
    }
    /**
     * 上传文件
     * @param {?} files
     * @param {?} event
     * @param {?} extendService
     * @return {?}
     */
    upload(files, event, extendService) {
        return this.innerUploadList(files, event, extendService);
    }
    /**
     * 内部上传方式
     * @private
     * @param {?} files
     * @param {?} event
     * @param {?} extendService
     * @return {?}
     */
    innerUploadList(files, event, extendService) {
        return new Observable((/**
         * @param {?} observer
         * @return {?}
         */
        observer => {
            /** @type {?} */
            let uploadInfo = new GspFormUploadListEntity;
            uploadInfo.formId = this.getFinallyConfig('formId', extendService);
            uploadInfo.mode = this.getFinallyConfig('mode', extendService);
            /** @type {?} */
            let rootId = this.getFinallyConfig('rootId', extendService);
            uploadInfo.docInfoList = [];
            /** @type {?} */
            let readerObserable = [];
            files.forEach((/**
             * @param {?} fileItem
             * @return {?}
             */
            (fileItem) => {
                /** @type {?} */
                let sub = new Observable((/**
                 * @param {?} obser
                 * @return {?}
                 */
                obser => {
                    /** @type {?} */
                    let reader = new FileReader();
                    // 暂不处理异常
                    reader.readAsBinaryString(fileItem.nativeFile);
                    reader.onload = (/**
                     * @param {?} e
                     * @return {?}
                     */
                    (e) => {
                        /** @type {?} */
                        let info = (/** @type {?} */ ({ 'fileName': '', 'fileContent': '' }));
                        info['fileName'] = fileItem.name;
                        info['fileContent'] = btoa(reader.result.toString());
                        // 如果data里有数据，并且属性是配置的扩展属性
                        if (event.hasOwnProperty('data') && event['data'] && event['data'].hasOwnProperty('extProperty')) {
                            // 
                            info['extProperty'] = event['data']['extProperty'];
                        }
                        uploadInfo.docInfoList.push(info);
                        obser.next();
                        obser.complete();
                    });
                }));
                readerObserable.push(sub);
            }));
            forkJoin(readerObserable).subscribe((/**
             * @param {?} datas
             * @return {?}
             */
            datas => {
                //     metadataId: string;
                //  fileName: string;
                this.uploadSer.uploadList(uploadInfo, rootId).subscribe((/**
                 * @param {?} result
                 * @return {?}
                 */
                result => {
                    if (result.error) {
                        // 此接口一旦出现问题，所有附件都上传不通过
                        observer.error(this.errorInfoFormat(result.error, files));
                        observer.complete();
                        return;
                    }
                    // 合并返回结果到此处
                    result.forEach((/**
                     * @param {?} item
                     * @return {?}
                     */
                    item => {
                        /** @type {?} */
                        var findIndex = this.findFileIndexByFileName(files, item.fileName);
                        if (findIndex > -1) {
                            files[findIndex]['response'] = item;
                            files[findIndex]['progress']['status'] = UploadStatus.Done;
                        }
                    }));
                    observer.next({ type: 'done', files: files });
                }), (/**
                 * @param {?} error
                 * @return {?}
                 */
                error => {
                    observer.error(this.errorInfoFormat(error, files));
                    observer.complete();
                }), (/**
                 * @return {?}
                 */
                () => {
                    observer.complete();
                }));
            }));
        }));
    }
    ;
    /**
     * 分片加载
     * @param {?} file
     * @param {?} event
     * @param {?} extendService
     * @return {?}
     */
    multipartUpload(file, event, extendService) {
        return new Observable((/**
         * @param {?} observer
         * @return {?}
         */
        observer => {
            // let fileInfo: FileInfo;
            /** @type {?} */
            let uuid = this.uuid();
            // let uuid = UUID.UUID();
            //reader.readAsBinaryString(selectedFile);
            //reader.onload = (e) => {
            /** @type {?} */
            let fileName = file.name;
            // fileInfo = {
            //   id: uuid,
            //   name: fileName,
            //   type: file.type,
            //   source: "",
            //   size: this.formatFileSize(file.size),
            //   fileSize: file.size,
            //   picListDisplayName: this.getMultipartDisplayName(fileName),
            //   queueListDisplayName: fileName,
            //   //content: reader.result.toString(),
            //   hasUploaded: false,
            //   mouseOn: false,
            //   selectd: false,
            //   isUploading: true,
            //   uploadResult: false,
            //   uploadProcess: 0,
            //   errorMessage: "",
            //   extensionDropListId: 0,
            //   extensionName: ""
            // }
            /** @type {?} */
            let chunkTotal = Math.ceil(file.size / this.bufferSize);
            // 标记当前附件总的分片数
            this.fileTotalChunk[uuid] = chunkTotal;
            /** @type {?} */
            let chunkIndex = 0;
            // 标记当前附件成功的分片数
            this.uploadedChunk[uuid] = 0;
            while (chunkIndex < chunkTotal) {
                /** @type {?} */
                let uploadInfo = new GspFormUploadEntity;
                uploadInfo.mode = OperatingModes.Temp;
                uploadInfo.formId = this.getFinallyConfig('formId', extendService);
                uploadInfo.rootId = this.getFinallyConfig('rootId', extendService);
                /** @type {?} */
                let docInfo = new GspFormDocInfo;
                docInfo.fileName = fileName;
                docInfo.metadataId = uuid;
                docInfo.total = chunkTotal;
                // 如果data里有数据，并且属性是配置的扩展属性
                if (event.hasOwnProperty('data') && event['data'] && event['data'].hasOwnProperty('extProperty')) {
                    docInfo['extProperty'] = (/** @type {?} */ (event['data']['extProperty']));
                }
                // 下一个文件大小
                /** @type {?} */
                let nextSize = Math.min((chunkIndex + 1) * this.bufferSize, file.size);
                // File类型
                /** @type {?} */
                let fileData = file['nativeFile'].slice(chunkIndex * this.bufferSize, nextSize);
                // 读取文件
                /** @type {?} */
                let reader = new FileReader();
                reader.readAsBinaryString(fileData);
                /** @type {?} */
                let innerIndex = chunkIndex;
                reader.onload = (/**
                 * @return {?}
                 */
                () => {
                    // 附件上传
                    docInfo.fileContent = btoa(reader.result.toString());
                    docInfo.index = innerIndex;
                    uploadInfo.docInfo = docInfo;
                    /** @type {?} */
                    let info = uploadInfo;
                    this.uploadSer.uploadFile(info).subscribe((/**
                     * @param {?} result
                     * @return {?}
                     */
                    result => {
                        if (result && result.error) {
                            // 分片上传有返回结果就是报错了
                            observer.error(this.errorInfoFormat(result.error, [file]));
                            observer.complete();
                            return;
                        }
                        else {
                            this.uploadedChunk[uuid]++;
                            if (this.uploadedChunk[docInfo.metadataId] == this.fileTotalChunk[docInfo.metadataId]) {
                                // 判断是所有分片都上传完成
                                file.progress = {
                                    status: UploadStatus.Done,
                                    data: {
                                        percentage: 100
                                    }
                                };
                                file.response = docInfo;
                                delete this.uploadedChunk[uuid];
                                delete this.fileTotalChunk[uuid];
                                observer.next({ type: 'done', files: [file] });
                                observer.complete();
                            }
                            else {
                                // 分片上传正常
                                /** @type {?} */
                                const percentage = Number.parseInt((this.uploadedChunk[uuid] / this.fileTotalChunk[uuid] * 100).toFixed(0));
                                // 判断未上传完成
                                file.progress = {
                                    status: UploadStatus.Uploading,
                                    data: {
                                        percentage: percentage
                                    }
                                };
                                observer.next({ type: 'uploading', files: [file] });
                            }
                        }
                    }), (/**
                     * @param {?} error
                     * @return {?}
                     */
                    error => {
                        delete this.uploadedChunk[uuid];
                        delete this.fileTotalChunk[uuid];
                        observer.error(this.errorInfoFormat(error, [file]));
                        observer.complete();
                    }));
                });
                chunkIndex = chunkIndex + 1;
            }
        }));
    }
    /**
     * 获取分片的附件大小
     * @private
     * @param {?} size
     * @return {?}
     */
    formatFileSize(size) {
        if (size < 102400)
            return (size / 1024).toFixed(1) + "K";
        else if (size < 1024 * 1024)
            return (size / 1024).toFixed(0) + "K";
        else if (size < 100 * 1024 * 1024)
            return (size / 1024 / 1024).toFixed(1) + "M";
        else if (size < 1024 * 1024 * 1024)
            return (size / 1024 / 1024).toFixed(0) + "M";
        else
            return (size / 1024 / 1024 / 1024).toFixed(1) + "G";
    }
    /**
     * 获取分片的 附件名称
     * @private
     * @param {?} fileName
     * @return {?}
     */
    getMultipartDisplayName(fileName) {
        if (fileName.length <= 10)
            return fileName;
        else {
            /** @type {?} */
            let headContent = fileName.substring(0, 2);
            /** @type {?} */
            let tailContent = fileName.substring(fileName.lastIndexOf('.') - 2);
            return headContent + "…" + tailContent;
        }
    }
    /**
     * @private
     * @param {?} error
     * @param {?} files
     * @return {?}
     */
    errorInfoFormat(error, files) {
        // 
        /** @type {?} */
        let errorFiles = files.map((/**
         * @param {?} item
         * @return {?}
         */
        item => {
            return { id: item.id, name: item.name };
        }));
        if (error) {
            return Object.assign(error, { files: errorFiles }, { message: error['Message'] || error['extensionMessage'] || '上传失败', type: 'error' });
        }
        else {
            return Object.assign({ files: errorFiles }, { message: '上传失败', type: 'error' });
        }
    }
    /**
     * 返回最终属性值
     * @private
     * @param {?} key
     * @param {?} extendValue
     * @return {?}
     */
    getFinallyConfig(key, extendValue) {
        if (extendValue && extendValue.hasOwnProperty(key)) {
            return extendValue[key];
        }
        return this.extendData[key];
    }
    /**
     * @private
     * @param {?} files
     * @param {?} fileName
     * @return {?}
     */
    findFileIndexByFileName(files, fileName) {
        // 按照肯定能找到文件来处理
        /** @type {?} */
        let findIndex = files.findIndex((/**
         * @param {?} file
         * @return {?}
         */
        file => file.name == fileName));
        return findIndex;
    }
}
// 1024 * 1024
FfileuploadAdaptUnifileService.previous = 0;
FfileuploadAdaptUnifileService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
/** @nocollapse */
FfileuploadAdaptUnifileService.ctorParameters = () => [
    { type: UploadService },
    { type: FFileUploadAdaptUnifileConfigService }
];
/** @nocollapse */ FfileuploadAdaptUnifileService.ngInjectableDef = i0.defineInjectable({ factory: function FfileuploadAdaptUnifileService_Factory() { return new FfileuploadAdaptUnifileService(i0.inject(i1.UploadService), i0.inject(i2.FFileUploadAdaptUnifileConfigService)); }, token: FfileuploadAdaptUnifileService, providedIn: "root" });
if (false) {
    /**
     * @type {?}
     * @private
     */
    FfileuploadAdaptUnifileService.previous;
    /** @type {?} */
    FfileuploadAdaptUnifileService.prototype.extendData;
    /** @type {?} */
    FfileuploadAdaptUnifileService.prototype.bufferSize;
    /**
     * @type {?}
     * @private
     */
    FfileuploadAdaptUnifileService.prototype.uploadedChunk;
    /**
     * @type {?}
     * @private
     */
    FfileuploadAdaptUnifileService.prototype.fileTotalChunk;
    /**
     * @type {?}
     * @private
     */
    FfileuploadAdaptUnifileService.prototype.uploadSer;
    /**
     * @type {?}
     * @private
     */
    FfileuploadAdaptUnifileService.prototype.configSer;
    /* Skipping unhandled member: ;*/
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmZpbGV1cGxvYWQtYWRhcHQtdW5pZmlsZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9leHRlbmQtZmlsZXVwbG9hZC1hZGFwdC11bmlmaWxlLyIsInNvdXJjZXMiOlsibGliL2ZmaWxldXBsb2FkLWFkYXB0LXVuaWZpbGUuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLG1CQUFtQixFQUEyQixZQUFZLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUN4RyxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUM1QyxPQUFPLEVBQUUsYUFBYSxFQUFFLHVCQUF1QixFQUFFLHVCQUF1QixFQUFFLGNBQWMsRUFBRSxtQkFBbUIsRUFBWSxjQUFjLEVBQXNCLE1BQU0seUJBQXlCLENBQUM7QUFDN0wsT0FBTyxFQUFFLG9DQUFvQyxFQUFpQyxNQUFNLG9DQUFvQyxDQUFDOzs7O0FBS3pILE1BQU0sT0FBTyw4QkFBK0IsU0FBUSxtQkFBbUI7Ozs7O0lBT3JFLFlBQW9CLFNBQXdCLEVBQVUsU0FBK0M7UUFDbkcsS0FBSyxFQUFFLENBQUM7UUFEVSxjQUFTLEdBQVQsU0FBUyxDQUFlO1FBQVUsY0FBUyxHQUFULFNBQVMsQ0FBc0M7O1FBTHJHLGVBQVUsR0FBRyxJQUFJLEdBQUMsSUFBSSxDQUFDLENBQUEsY0FBYztRQUU3QixrQkFBYSxHQUFHLEVBQUUsQ0FBQztRQUNuQixtQkFBYyxHQUFHLEVBQUUsQ0FBQztRQUkxQixJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsU0FBUyxFQUFFLENBQUM7SUFDL0MsQ0FBQzs7Ozs7SUFFTyxJQUFJOztZQUNMLEVBQUU7OztRQUFHO1lBQ1IsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxD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LFVBQVUsRUFBRSxFQUFFLEVBQUUsT0FBTyxFQUFFLEtBQUssQ0FBQyxTQUFTLENBQUMsSUFBSSxLQUFLLENBQUMsa0JBQWtCLENBQUMsSUFBSSxNQUFNLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxDQUFDLENBQUM7U0FDekk7YUFBTTtZQUNMLE9BQU8sTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEtBQUssRUFBRSxVQUFVLEVBQUUsRUFBRSxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxDQUFDLENBQUM7U0FDakY7SUFDSCxDQUFDOzs7Ozs7OztJQU9PLGdCQUFnQixDQUFDLEdBQUcsRUFBRSxXQUFXO1FBQ3ZDLElBQUksV0FBVyxJQUFJLFdBQVcsQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDbEQsT0FBTyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUM7U0FDekI7UUFDRCxPQUFPLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDOUIsQ0FBQzs7Ozs7OztJQUVPLHVCQUF1QixDQUFDLEtBQW1CLEVBQUUsUUFBUTs7O1lBRXZELFNBQVMsR0FBRyxLQUFLLENBQUMsU0FBUzs7OztRQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLElBQUksSUFBSSxRQUFRLEVBQUM7UUFDOUQsT0FBTyxTQUFTLENBQUM7SUFDbkIsQ0FBQzs7O0FBOVNjLHVDQUFRLEdBQUcsQ0FBQyxDQUFDOztZQU43QixVQUFVLFNBQUM7Z0JBQ1YsVUFBVSxFQUFFLE1BQU07YUFDbkI7Ozs7WUFMUSxhQUFhO1lBQ2Isb0NBQW9DOzs7Ozs7OztJQVEzQyx3Q0FBNEI7O0lBRjVCLG9EQUFXOztJQUNYLG9EQUF1Qjs7Ozs7SUFFdkIsdURBQTJCOzs7OztJQUMzQix3REFBNEI7Ozs7O0lBRWhCLG1EQUFnQzs7Ozs7SUFBRSxtREFBdUQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IFVwbG9hZFNlcnZlclNlcnZpY2UsIFVwbG9hZEZpbGUsIFVwbG9hZElucHV0LCBVcGxvYWRTdGF0dXMgfSBmcm9tICdAZmFycmlzL2V4dGVuZC1maWxlLXVwbG9hZCc7XHJcbmltcG9ydCB7IE9ic2VydmFibGUsIGZvcmtKb2luIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IFVwbG9hZFNlcnZpY2UsIEdzcEZvcm1VcGxvYWRMaXN0RW50aXR5LCBHc3BGb3JtUmVtb3ZlTGlzdEVudGl0eSwgR3NwRm9ybURvY0luZm8sIEdzcEZvcm1VcGxvYWRFbnRpdHksIEZpbGVJbmZvLCBPcGVyYXRpbmdNb2RlcywgR3NwRG9jTWV0YVByb3BlcnR5IH0gZnJvbSAnQGdzcC1zdmMvZm9ybWRvYy11cGxvYWQnO1xyXG5pbXBvcnQgeyBGRmlsZVVwbG9hZEFkYXB0VW5pZmlsZUNvbmZpZ1NlcnZpY2UsIEZGaWxlVXBsb2FkQWRhcHRVbmlmaWxlQ29uZmlnIH0gZnJvbSAnLi9mZmlsZXVwbG9hZC1hZGFwdC11bmlmaWxlLmNvbmZpZyc7XHJcblxyXG5ASW5qZWN0YWJsZSh7XHJcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBGZmlsZXVwbG9hZEFkYXB0VW5pZmlsZVNlcnZpY2UgZXh0ZW5kcyBVcGxvYWRTZXJ2ZXJTZXJ2aWNlIHtcclxuICBleHRlbmREYXRhOy8vIOaaguaXtueUqOS6jueugOWNleWQiOW5tlxyXG4gIGJ1ZmZlclNpemUgPSAxMDI0KjEwMjQ7Ly8gMTAyNCAqIDEwMjRcclxuICBwcml2YXRlIHN0YXRpYyBwcmV2aW91cyA9IDA7XHJcbiAgcHJpdmF0ZSB1cGxvYWRlZENodW5rID0ge307XHJcbiAgcHJpdmF0ZSBmaWxlVG90YWxDaHVuayA9IHt9O1xyXG5cclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHVwbG9hZFNlcjogVXBsb2FkU2VydmljZSwgcHJpdmF0ZSBjb25maWdTZXI6IEZGaWxlVXBsb2FkQWRhcHRVbmlmaWxlQ29uZmlnU2VydmljZSkge1xyXG4gICAgc3VwZXIoKTtcclxuICAgIHRoaXMuZXh0ZW5kRGF0YSA9IHRoaXMuY29uZmlnU2VyLmdldENvbmZpZygpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSB1dWlkKCkge1xyXG4gICAgbGV0ICBTNCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgcmV0dXJuICgoKDEgKyBNYXRoLnJhbmRvbSgpKSAqIDB4MTAwMDApIHwgMCkudG9TdHJpbmcoMTYpLnN1YnN0cmluZygxKTtcclxuICAgIH07XHJcbiAgICBsZXQgbkd1aWQgPSBTNCgpICsgUzQoKSArICBTNCgpICsgIFM0KCkgKyAgUzQoKSArICBTNCgpICsgUzQoKSArIFM0KCk7XHJcbiAgICByZXR1cm4gbkd1aWQ7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOWIoOmZpOaWh+S7tlxyXG4gICAqIEBwYXJhbSBmaWxlIFxyXG4gICAqIEBwYXJhbSBldmVudCBcclxuICAgKi9cclxuICByZW1vdmUoZmlsZXM6IFVwbG9hZEZpbGVbXSwgZXZlbnQ6IFVwbG9hZElucHV0LCBleHRlbmRTZXJ2aWNlOiBGRmlsZVVwbG9hZEFkYXB0VW5pZmlsZUNvbmZpZyk6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICByZXR1cm4gdGhpcy5pbm5lclJlbW92ZUxpc3QoZmlsZXMsIGV2ZW50LCBleHRlbmRTZXJ2aWNlKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgaW5uZXJSZW1vdmVMaXN0KGZpbGVzOiBVcGxvYWRGaWxlW10sIGV2ZW50OiBVcGxvYWRJbnB1dCwgZXh0ZW5kU2VydmljZSA9IG51bGwpOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgcmV0dXJuIG5ldyBPYnNlcnZhYmxlKG9ic2VydmVyID0+IHtcclxuICAgICAgbGV0IHJlbW92ZUZpbGVJbmZvID0gbmV3IEdzcEZvcm1SZW1vdmVMaXN0RW50aXR5O1xyXG4gICAgICBsZXQgbWV0YWRhdGFJZExpc3QgPSBbXTtcclxuICAgICAgZmlsZXMuZm9yRWFjaChmaWxlSXRlbSA9PiB7XHJcbiAgICAgICAgaWYgKGZpbGVJdGVtWydyZXNwb25zZSddKSB7XHJcbiAgICAgICAgICBtZXRhZGF0YUlkTGlzdC5wdXNoKGZpbGVJdGVtWydyZXNwb25zZSddWydtZXRhZGF0YUlkJ10pO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcblxyXG4gICAgICByZW1vdmVGaWxlSW5mby5tb2RlID0gdGhpcy5nZXRGaW5hbGx5Q29uZmlnKCdtb2RlJywgZXh0ZW5kU2VydmljZSk7XHJcbiAgICAgIGxldCByb290SWQgPSB0aGlzLmdldEZpbmFsbHlDb25maWcoJ3Jvb3RJZCcsIGV4dGVuZFNlcnZpY2UpO1xyXG4gICAgICByZW1vdmVGaWxlSW5mby5tZXRhZGF0YUlkTGlzdCA9IFtdLmNvbmNhdChtZXRhZGF0YUlkTGlzdCk7XHJcblxyXG4gICAgICB0aGlzLnVwbG9hZFNlci5yZW1vdmVMaXN0KG1ldGFkYXRhSWRMaXN0LCByb290SWQpLnN1YnNjcmliZShyZXN1bHQgPT4ge1xyXG4gICAgICAgIC8vIOayoeaciemcgOimgeaVtOWQiOeahOacjeWKoeWZqOerr+i/lOWbnuaVsOaNrlxyXG4gICAgICAgIG9ic2VydmVyLm5leHQoeyB0eXBlOiAncmVtb3ZlZCcsIGZpbGVzOiBmaWxlcyB9KTtcclxuICAgICAgfSwgZXJyb3IgPT4ge1xyXG4gICAgICAgIG9ic2VydmVyLmVycm9yKGVycm9yKTtcclxuICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xyXG4gICAgICB9LCAoKSA9PiB7XHJcbiAgICAgICAgb2JzZXJ2ZXIuY29tcGxldGUoKTtcclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5LiK5Lyg5paH5Lu2XHJcbiAgICogQHBhcmFtIGZpbGUgXHJcbiAgICogQHBhcmFtIGV2ZW50IFxyXG4gICAqL1xyXG4gIHVwbG9hZChmaWxlczogVXBsb2FkRmlsZVtdLCBldmVudDogVXBsb2FkSW5wdXQsIGV4dGVuZFNlcnZpY2U6IEZGaWxlVXBsb2FkQWRhcHRVbmlmaWxlQ29uZmlnKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIHJldHVybiB0aGlzLmlubmVyVXBsb2FkTGlzdChmaWxlcywgZXZlbnQsIGV4dGVuZFNlcnZpY2UpO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDlhoXpg6jkuIrkvKDmlrnlvI9cclxuICAgKiBAcGFyYW0gZmlsZXMgXHJcbiAgICogQHBhcmFtIGV2ZW50IFxyXG4gICAqIEBwYXJhbSBleHRlbmRTZXJ2aWNlIFxyXG4gICAqL1xyXG4gIHByaXZhdGUgaW5uZXJVcGxvYWRMaXN0KGZpbGVzOiBVcGxvYWRGaWxlW10sIGV2ZW50OiBVcGxvYWRJbnB1dCwgZXh0ZW5kU2VydmljZTogRkZpbGVVcGxvYWRBZGFwdFVuaWZpbGVDb25maWcpOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgcmV0dXJuIG5ldyBPYnNlcnZhYmxlKG9ic2VydmVyID0+IHtcclxuXHJcbiAgICAgIGxldCB1cGxvYWRJbmZvID0gbmV3IEdzcEZvcm1VcGxvYWRMaXN0RW50aXR5O1xyXG4gICAgICB1cGxvYWRJbmZvLmZvcm1JZCA9IHRoaXMuZ2V0RmluYWxseUNvbmZpZygnZm9ybUlkJywgZXh0ZW5kU2VydmljZSk7XHJcbiAgICAgIHVwbG9hZEluZm8ubW9kZSA9IHRoaXMuZ2V0RmluYWxseUNvbmZpZygnbW9kZScsIGV4dGVuZFNlcnZpY2UpO1xyXG5cclxuICAgICAgbGV0IHJvb3RJZCA9IHRoaXMuZ2V0RmluYWxseUNvbmZpZygncm9vdElkJywgZXh0ZW5kU2VydmljZSk7XHJcbiAgICAgIHVwbG9hZEluZm8uZG9jSW5mb0xpc3QgPSBbXTtcclxuICAgICAgbGV0IHJlYWRlck9ic2VyYWJsZTogT2JzZXJ2YWJsZTxhbnk+W10gPSBbXTtcclxuICAgICAgZmlsZXMuZm9yRWFjaCgoZmlsZUl0ZW06IFVwbG9hZEZpbGUpID0+IHtcclxuICAgICAgICBsZXQgc3ViID0gbmV3IE9ic2VydmFibGUob2JzZXIgPT4ge1xyXG4gICAgICAgICAgbGV0IHJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKCk7XHJcbiAgICAgICAgICAvLyDmmoLkuI3lpITnkIblvILluLhcclxuICAgICAgICAgIHJlYWRlci5yZWFkQXNCaW5hcnlTdHJpbmcoZmlsZUl0ZW0ubmF0aXZlRmlsZSk7XHJcbiAgICAgICAgICByZWFkZXIub25sb2FkID0gKGUpID0+IHtcclxuICAgICAgICAgICAgbGV0IGluZm8gPSB7ICdmaWxlTmFtZSc6ICcnLCAnZmlsZUNvbnRlbnQnOiAnJyB9IGFzIGFueTtcclxuICAgICAgICAgICAgaW5mb1snZmlsZU5hbWUnXSA9IGZpbGVJdGVtLm5hbWU7XHJcbiAgICAgICAgICAgIGluZm9bJ2ZpbGVDb250ZW50J10gPSBidG9hKHJlYWRlci5yZXN1bHQudG9TdHJpbmcoKSk7XHJcbiAgICAgICAgICAgIC8vIOWmguaenGRhdGHph4zmnInmlbDmja7vvIzlubbkuJTlsZ7mgKfmmK/phY3nva7nmoTmianlsZXlsZ7mgKdcclxuICAgICAgICAgICAgaWYgKGV2ZW50Lmhhc093blByb3BlcnR5KCdkYXRhJykgJiYgZXZlbnRbJ2RhdGEnXSAmJiBldmVudFsnZGF0YSddLmhhc093blByb3BlcnR5KCdleHRQcm9wZXJ0eScpKSB7XHJcbiAgICAgICAgICAgICAgLy8gXHJcbiAgICAgICAgICAgICAgaW5mb1snZXh0UHJvcGVydHknXSA9IGV2ZW50WydkYXRhJ11bJ2V4dFByb3BlcnR5J107XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdXBsb2FkSW5mby5kb2NJbmZvTGlzdC5wdXNoKGluZm8pO1xyXG4gICAgICAgICAgICBvYnNlci5uZXh0KCk7XHJcbiAgICAgICAgICAgIG9ic2VyLmNvbXBsZXRlKCk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcmVhZGVyT2JzZXJhYmxlLnB1c2goc3ViKTtcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBmb3JrSm9pbihyZWFkZXJPYnNlcmFibGUpLnN1YnNjcmliZShkYXRhcyA9PiB7XHJcbiAgICAgICAgLy8gICAgIG1ldGFkYXRhSWQ6IHN0cmluZztcclxuICAgICAgICAvLyAgZmlsZU5hbWU6IHN0cmluZztcclxuICAgICAgICB0aGlzLnVwbG9hZFNlci51cGxvYWRMaXN0KHVwbG9hZEluZm8sIHJvb3RJZCkuc3Vic2NyaWJlKHJlc3VsdCA9PiB7XHJcbiAgICAgICAgICBpZiAocmVzdWx0LmVycm9yKSB7XHJcbiAgICAgICAgICAgIC8vIOatpOaOpeWPo+S4gOaXpuWHuueOsOmXrumimO+8jOaJgOaciemZhOS7tumDveS4iuS8oOS4jemAmui/h1xyXG4gICAgICAgICAgICBvYnNlcnZlci5lcnJvcih0aGlzLmVycm9ySW5mb0Zvcm1hdChyZXN1bHQuZXJyb3IsIGZpbGVzKSk7XHJcbiAgICAgICAgICAgIG9ic2VydmVyLmNvbXBsZXRlKCk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIC8vIOWQiOW5tui/lOWbnue7k+aenOWIsOatpOWkhFxyXG4gICAgICAgICAgcmVzdWx0LmZvckVhY2goaXRlbSA9PiB7XHJcbiAgICAgICAgICAgIHZhciBmaW5kSW5kZXggPSB0aGlzLmZpbmRGaWxlSW5kZXhCeUZpbGVOYW1lKGZpbGVzLCBpdGVtLmZpbGVOYW1lKTtcclxuICAgICAgICAgICAgaWYgKGZpbmRJbmRleCA+IC0xKSB7XHJcbiAgICAgICAgICAgICAgZmlsZXNbZmluZEluZGV4XVsncmVzcG9uc2UnXSA9IGl0ZW07XHJcbiAgICAgICAgICAgICAgZmlsZXNbZmluZEluZGV4XVsncHJvZ3Jlc3MnXVsnc3RhdHVzJ10gPSBVcGxvYWRTdGF0dXMuRG9uZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgb2JzZXJ2ZXIubmV4dCh7IHR5cGU6ICdkb25lJywgZmlsZXM6IGZpbGVzIH0pO1xyXG5cclxuICAgICAgICB9LCBlcnJvciA9PiB7XHJcbiAgICAgICAgICBvYnNlcnZlci5lcnJvcih0aGlzLmVycm9ySW5mb0Zvcm1hdChlcnJvciwgZmlsZXMpKTtcclxuICAgICAgICAgIG9ic2VydmVyLmNvbXBsZXRlKCk7XHJcbiAgICAgICAgfSwgKCkgPT4ge1xyXG4gICAgICAgICAgb2JzZXJ2ZXIuY29tcGxldGUoKTtcclxuICAgICAgICB9KTtcclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuICB9O1xyXG4gIC8qKlxyXG4gICAqIOWIhueJh+WKoOi9vVxyXG4gICAqIEBwYXJhbSBmaWxlIFxyXG4gICAqIEBwYXJhbSBldmVudCBcclxuICAgKiBAcGFyYW0gZXh0ZW5kU2VydmljZSBcclxuICAgKi9cclxuICBtdWx0aXBhcnRVcGxvYWQoZmlsZTogVXBsb2FkRmlsZSwgZXZlbnQ6IFVwbG9hZElucHV0LCBleHRlbmRTZXJ2aWNlOiBGRmlsZVVwbG9hZEFkYXB0VW5pZmlsZUNvbmZpZyk6IE9ic2VydmFibGU8YW55PiB7XHJcblxyXG4gICAgcmV0dXJuIG5ldyBPYnNlcnZhYmxlKG9ic2VydmVyID0+IHtcclxuXHJcbiAgICAgLy8gbGV0IGZpbGVJbmZvOiBGaWxlSW5mbztcclxuICAgICAgbGV0IHV1aWQgPSB0aGlzLnV1aWQoKTtcclxuICAgICAgLy8gbGV0IHV1aWQgPSBVVUlELlVVSUQoKTtcclxuICAgICAgLy9yZWFkZXIucmVhZEFzQmluYXJ5U3RyaW5nKHNlbGVjdGVkRmlsZSk7XHJcbiAgICAgIC8vcmVhZGVyLm9ubG9hZCA9IChlKSA9PiB7XHJcbiAgICAgIGxldCBmaWxlTmFtZSA9IGZpbGUubmFtZTtcclxuICAgICAgLy8gZmlsZUluZm8gPSB7XHJcbiAgICAgIC8vICAgaWQ6IHV1aWQsXHJcbiAgICAgIC8vICAgbmFtZTogZmlsZU5hbWUsXHJcbiAgICAgIC8vICAgdHlwZTogZmlsZS50eXBlLFxyXG4gICAgICAvLyAgIHNvdXJjZTogXCJcIixcclxuICAgICAgLy8gICBzaXplOiB0aGlzLmZvcm1hdEZpbGVTaXplKGZpbGUuc2l6ZSksXHJcbiAgICAgIC8vICAgZmlsZVNpemU6IGZpbGUuc2l6ZSxcclxuICAgICAgLy8gICBwaWNMaXN0RGlzcGxheU5hbWU6IHRoaXMuZ2V0TXVsdGlwYXJ0RGlzcGxheU5hbWUoZmlsZU5hbWUpLFxyXG4gICAgICAvLyAgIHF1ZXVlTGlzdERpc3BsYXlOYW1lOiBmaWxlTmFtZSxcclxuICAgICAgLy8gICAvL2NvbnRlbnQ6IHJlYWRlci5yZXN1bHQudG9TdHJpbmcoKSxcclxuICAgICAgLy8gICBoYXNVcGxvYWRlZDogZmFsc2UsXHJcbiAgICAgIC8vICAgbW91c2VPbjogZmFsc2UsXHJcbiAgICAgIC8vICAgc2VsZWN0ZDogZmFsc2UsXHJcbiAgICAgIC8vICAgaXNVcGxvYWRpbmc6IHRydWUsXHJcbiAgICAgIC8vICAgdXBsb2FkUmVzdWx0OiBmYWxzZSxcclxuICAgICAgLy8gICB1cGxvYWRQcm9jZXNzOiAwLFxyXG4gICAgICAvLyAgIGVycm9yTWVzc2FnZTogXCJcIixcclxuICAgICAgLy8gICBleHRlbnNpb25Ecm9wTGlzdElkOiAwLFxyXG4gICAgICAvLyAgIGV4dGVuc2lvbk5hbWU6IFwiXCJcclxuICAgICAgLy8gfVxyXG5cclxuICAgICAgbGV0IGNodW5rVG90YWw6IG51bWJlciA9IE1hdGguY2VpbChmaWxlLnNpemUgLyB0aGlzLmJ1ZmZlclNpemUpO1xyXG4gICAgICAvLyDmoIforrDlvZPliY3pmYTku7bmgLvnmoTliIbniYfmlbBcclxuICAgICAgdGhpcy5maWxlVG90YWxDaHVua1t1dWlkXSA9IGNodW5rVG90YWw7XHJcbiAgICAgIGxldCBjaHVua0luZGV4OiBudW1iZXIgPSAwO1xyXG4gICAgICAvLyDmoIforrDlvZPliY3pmYTku7bmiJDlip/nmoTliIbniYfmlbBcclxuICAgICAgdGhpcy51cGxvYWRlZENodW5rW3V1aWRdID0gMDtcclxuICAgICAgd2hpbGUgKGNodW5rSW5kZXggPCBjaHVua1RvdGFsKSB7XHJcbiAgICAgICAgbGV0IHVwbG9hZEluZm8gPSBuZXcgR3NwRm9ybVVwbG9hZEVudGl0eTtcclxuICAgICAgICB1cGxvYWRJbmZvLm1vZGUgPSBPcGVyYXRpbmdNb2Rlcy5UZW1wO1xyXG4gICAgICAgIHVwbG9hZEluZm8uZm9ybUlkID0gdGhpcy5nZXRGaW5hbGx5Q29uZmlnKCdmb3JtSWQnLCBleHRlbmRTZXJ2aWNlKTtcclxuICAgICAgICB1cGxvYWRJbmZvLnJvb3RJZCA9IHRoaXMuZ2V0RmluYWxseUNvbmZpZygncm9vdElkJywgZXh0ZW5kU2VydmljZSk7XHJcblxyXG4gICAgICAgIGxldCBkb2NJbmZvOiBHc3BGb3JtRG9jSW5mbyA9IG5ldyBHc3BGb3JtRG9jSW5mbztcclxuICAgICAgICBkb2NJbmZvLmZpbGVOYW1lID0gZmlsZU5hbWU7XHJcbiAgICAgICAgZG9jSW5mby5tZXRhZGF0YUlkID0gdXVpZDtcclxuICAgICAgICBkb2NJbmZvLnRvdGFsID0gY2h1bmtUb3RhbDtcclxuICAgICAgICAvLyDlpoLmnpxkYXRh6YeM5pyJ5pWw5o2u77yM5bm25LiU5bGe5oCn5piv6YWN572u55qE5omp5bGV5bGe5oCnXHJcbiAgICAgICAgaWYgKGV2ZW50Lmhhc093blByb3BlcnR5KCdkYXRhJykgJiYgZXZlbnRbJ2RhdGEnXSAmJiBldmVudFsnZGF0YSddLmhhc093blByb3BlcnR5KCdleHRQcm9wZXJ0eScpKSB7XHJcbiAgICAgICAgICBkb2NJbmZvWydleHRQcm9wZXJ0eSddID0gZXZlbnRbJ2RhdGEnXVsnZXh0UHJvcGVydHknXSBhcyBHc3BEb2NNZXRhUHJvcGVydHk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIOS4i+S4gOS4quaWh+S7tuWkp+Wwj1xyXG4gICAgICAgIGxldCBuZXh0U2l6ZSA9IE1hdGgubWluKChjaHVua0luZGV4ICsgMSkgKiB0aGlzLmJ1ZmZlclNpemUsIGZpbGUuc2l6ZSk7XHJcbiAgICAgICAgLy8gRmlsZeexu+Wei1xyXG4gICAgICAgIGxldCBmaWxlRGF0YSA9IGZpbGVbJ25hdGl2ZUZpbGUnXS5zbGljZShjaHVua0luZGV4ICogdGhpcy5idWZmZXJTaXplLCBuZXh0U2l6ZSk7XHJcbiAgICAgICAgLy8g6K+75Y+W5paH5Lu2XHJcbiAgICAgICAgbGV0IHJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKCk7XHJcbiAgICAgICAgcmVhZGVyLnJlYWRBc0JpbmFyeVN0cmluZyhmaWxlRGF0YSk7XHJcbiAgICAgICAgbGV0IGlubmVySW5kZXggPSBjaHVua0luZGV4O1xyXG4gICAgICAgIHJlYWRlci5vbmxvYWQgPSAoKSA9PiB7XHJcbiAgICAgICAgICAvLyDpmYTku7bkuIrkvKBcclxuICAgICAgICAgIGRvY0luZm8uZmlsZUNvbnRlbnQgPSBidG9hKHJlYWRlci5yZXN1bHQudG9TdHJpbmcoKSk7XHJcbiAgICAgICAgICBkb2NJbmZvLmluZGV4ID0gaW5uZXJJbmRleDtcclxuXHJcbiAgICAgICAgICB1cGxvYWRJbmZvLmRvY0luZm8gPSBkb2NJbmZvO1xyXG4gICAgICAgICAgbGV0IGluZm8gPSB1cGxvYWRJbmZvO1xyXG5cclxuICAgICAgICAgIHRoaXMudXBsb2FkU2VyLnVwbG9hZEZpbGUoaW5mbykuc3Vic2NyaWJlKHJlc3VsdCA9PiB7XHJcbiAgICAgICAgICAgIGlmIChyZXN1bHQgJiYgcmVzdWx0LmVycm9yKSB7XHJcbiAgICAgICAgICAgICAgLy8g5YiG54mH5LiK5Lyg5pyJ6L+U5Zue57uT5p6c5bCx5piv5oql6ZSZ5LqGXHJcbiAgICAgICAgICAgICAgb2JzZXJ2ZXIuZXJyb3IodGhpcy5lcnJvckluZm9Gb3JtYXQocmVzdWx0LmVycm9yLCBbZmlsZV0pKTtcclxuICAgICAgICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xyXG4gICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICB0aGlzLnVwbG9hZGVkQ2h1bmtbdXVpZF0rKztcclxuICAgICAgICAgICAgICBpZiAodGhpcy51cGxvYWRlZENodW5rW2RvY0luZm8ubWV0YWRhdGFJZF0gPT0gdGhpcy5maWxlVG90YWxDaHVua1tkb2NJbmZvLm1ldGFkYXRhSWRdKSB7XHJcbiAgICAgICAgICAgICAgICAvLyDliKTmlq3mmK/miYDmnInliIbniYfpg73kuIrkvKDlrozmiJBcclxuICAgICAgICAgICAgICAgIGZpbGUucHJvZ3Jlc3MgPSB7XHJcbiAgICAgICAgICAgICAgICAgIHN0YXR1czogVXBsb2FkU3RhdHVzLkRvbmUsXHJcbiAgICAgICAgICAgICAgICAgIGRhdGE6IHtcclxuICAgICAgICAgICAgICAgICAgICBwZXJjZW50YWdlOiAxMDBcclxuICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgIGZpbGUucmVzcG9uc2U9ZG9jSW5mbztcclxuICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLnVwbG9hZGVkQ2h1bmtbdXVpZF07XHJcbiAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5maWxlVG90YWxDaHVua1t1dWlkXTtcclxuICAgICAgICAgICAgICAgIG9ic2VydmVyLm5leHQoeyB0eXBlOiAnZG9uZScsIGZpbGVzOiBbZmlsZV0gfSk7XHJcbiAgICAgICAgICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xyXG5cclxuICAgICAgICAgICAgICB9IGVsc2UgeyAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAvLyDliIbniYfkuIrkvKDmraPluLhcclxuICAgICAgICAgICAgICAgIGNvbnN0IHBlcmNlbnRhZ2UgPSBOdW1iZXIucGFyc2VJbnQoKHRoaXMudXBsb2FkZWRDaHVua1t1dWlkXSAvIHRoaXMuZmlsZVRvdGFsQ2h1bmtbdXVpZF0gKiAxMDApLnRvRml4ZWQoMCkpO1xyXG4gICAgICAgICAgICAgICAgLy8g5Yik5pat5pyq5LiK5Lyg5a6M5oiQXHJcbiAgICAgICAgICAgICAgICBmaWxlLnByb2dyZXNzID0ge1xyXG4gICAgICAgICAgICAgICAgICBzdGF0dXM6IFVwbG9hZFN0YXR1cy5VcGxvYWRpbmcsXHJcbiAgICAgICAgICAgICAgICAgIGRhdGE6IHtcclxuICAgICAgICAgICAgICAgICAgICBwZXJjZW50YWdlOiBwZXJjZW50YWdlXHJcbiAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICBvYnNlcnZlci5uZXh0KHsgdHlwZTogJ3VwbG9hZGluZycsIGZpbGVzOiBbZmlsZV0gfSk7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9LCBlcnJvciA9PiB7XHJcbiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLnVwbG9hZGVkQ2h1bmtbdXVpZF07XHJcbiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmZpbGVUb3RhbENodW5rW3V1aWRdO1xyXG4gICAgICAgICAgICBvYnNlcnZlci5lcnJvcih0aGlzLmVycm9ySW5mb0Zvcm1hdChlcnJvciwgW2ZpbGVdKSk7XHJcbiAgICAgICAgICAgIG9ic2VydmVyLmNvbXBsZXRlKCk7XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY2h1bmtJbmRleCA9IGNodW5rSW5kZXggKyAxO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6I635Y+W5YiG54mH55qE6ZmE5Lu25aSn5bCPXHJcbiAgICogQHBhcmFtIHNpemUgXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBmb3JtYXRGaWxlU2l6ZShzaXplOiBudW1iZXIpIHtcclxuICAgIGlmIChzaXplIDwgMTAyNDAwKVxyXG4gICAgICByZXR1cm4gKHNpemUgLyAxMDI0KS50b0ZpeGVkKDEpICsgXCJLXCI7XHJcbiAgICBlbHNlIGlmIChzaXplIDwgMTAyNCAqIDEwMjQpXHJcbiAgICAgIHJldHVybiAoc2l6ZSAvIDEwMjQpLnRvRml4ZWQoMCkgKyBcIktcIjtcclxuICAgIGVsc2UgaWYgKHNpemUgPCAxMDAgKiAxMDI0ICogMTAyNClcclxuICAgICAgcmV0dXJuIChzaXplIC8gMTAyNCAvIDEwMjQpLnRvRml4ZWQoMSkgKyBcIk1cIjtcclxuICAgIGVsc2UgaWYgKHNpemUgPCAxMDI0ICogMTAyNCAqIDEwMjQpXHJcbiAgICAgIHJldHVybiAoc2l6ZSAvIDEwMjQgLyAxMDI0KS50b0ZpeGVkKDApICsgXCJNXCI7XHJcbiAgICBlbHNlXHJcbiAgICAgIHJldHVybiAoc2l6ZSAvIDEwMjQgLyAxMDI0IC8gMTAyNCkudG9GaXhlZCgxKSArIFwiR1wiO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDojrflj5bliIbniYfnmoQg6ZmE5Lu25ZCN56ewXHJcbiAgICogQHBhcmFtIGZpbGVOYW1lIFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0TXVsdGlwYXJ0RGlzcGxheU5hbWUoZmlsZU5hbWU6IHN0cmluZykge1xyXG4gICAgaWYgKGZpbGVOYW1lLmxlbmd0aCA8PSAxMClcclxuICAgICAgcmV0dXJuIGZpbGVOYW1lO1xyXG4gICAgZWxzZSB7XHJcbiAgICAgIGxldCBoZWFkQ29udGVudCA9IGZpbGVOYW1lLnN1YnN0cmluZygwLCAyKTtcclxuICAgICAgbGV0IHRhaWxDb250ZW50ID0gZmlsZU5hbWUuc3Vic3RyaW5nKGZpbGVOYW1lLmxhc3RJbmRleE9mKCcuJykgLSAyKTtcclxuICAgICAgcmV0dXJuIGhlYWRDb250ZW50ICsgXCLigKZcIiArIHRhaWxDb250ZW50O1xyXG4gICAgfVxyXG4gIH1cclxuICBwcml2YXRlIGVycm9ySW5mb0Zvcm1hdChlcnJvciwgZmlsZXMpIHtcclxuICAgIC8vIFxyXG4gICAgbGV0IGVycm9yRmlsZXMgPSBmaWxlcy5tYXAoaXRlbSA9PiB7XHJcbiAgICAgIHJldHVybiB7IGlkOiBpdGVtLmlkLCBuYW1lOiBpdGVtLm5hbWUgfTtcclxuICAgIH0pO1xyXG4gICAgaWYgKGVycm9yKSB7XHJcbiAgICAgIHJldHVybiBPYmplY3QuYXNzaWduKGVycm9yLCB7IGZpbGVzOiBlcnJvckZpbGVzIH0sIHsgbWVzc2FnZTogZXJyb3JbJ01lc3NhZ2UnXSB8fCBlcnJvclsnZXh0ZW5zaW9uTWVzc2FnZSddIHx8ICfkuIrkvKDlpLHotKUnLCB0eXBlOiAnZXJyb3InIH0pO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oeyBmaWxlczogZXJyb3JGaWxlcyB9LCB7IG1lc3NhZ2U6ICfkuIrkvKDlpLHotKUnLCB0eXBlOiAnZXJyb3InIH0pO1xyXG4gICAgfVxyXG4gIH1cclxuICAvKipcclxuICAgKiDov5Tlm57mnIDnu4jlsZ7mgKflgLxcclxuICAgKiBAcGFyYW0ga2V5IFxyXG4gICAqIEBwYXJhbSBjb25maWdWYWx1ZSBcclxuICAgKiBAcGFyYW0gZXh0ZW5kVmFsdWUgXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXRGaW5hbGx5Q29uZmlnKGtleSwgZXh0ZW5kVmFsdWUpIHtcclxuICAgIGlmIChleHRlbmRWYWx1ZSAmJiBleHRlbmRWYWx1ZS5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7XHJcbiAgICAgIHJldHVybiBleHRlbmRWYWx1ZVtrZXldO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHRoaXMuZXh0ZW5kRGF0YVtrZXldO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBmaW5kRmlsZUluZGV4QnlGaWxlTmFtZShmaWxlczogVXBsb2FkRmlsZVtdLCBmaWxlTmFtZSkge1xyXG4gICAgLy8g5oyJ54Wn6IKv5a6a6IO95om+5Yiw5paH5Lu25p2l5aSE55CGXHJcbiAgICBsZXQgZmluZEluZGV4ID0gZmlsZXMuZmluZEluZGV4KGZpbGUgPT4gZmlsZS5uYW1lID09IGZpbGVOYW1lKTtcclxuICAgIHJldHVybiBmaW5kSW5kZXg7XHJcbiAgfVxyXG5cclxufVxyXG5cclxuIl19