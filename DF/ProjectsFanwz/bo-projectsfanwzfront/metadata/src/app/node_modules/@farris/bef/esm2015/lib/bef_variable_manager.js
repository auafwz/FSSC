/**
 * @fileoverview added by tsickle
 * Generated from: lib/bef_variable_manager.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/*
 * @Author: Witt
 * @Date: 2019-03-05 19:55:44
 * @Last Modified by: Witt
 * @Last Modified time: 2019-03-13 20:35:29
 */
import { format } from 'date-fns';
import { AppContext, FrameContext } from '@farris/devkit';
import { ChangeDetailType } from './types';
import { BefChangeUtil } from './bef_change_util';
import { Injector, Optional } from '@angular/core';
/**
 * Be变量管理器
 */
class BefVariableManager {
    /**
     * 构造函数
     * @param {?} appContext
     * @param {?} ngVariables
     * @param {?} injector
     */
    constructor(appContext, ngVariables, injector) {
        this.appContext = appContext;
        this.ngVariables = ngVariables;
        this.injector = injector;
        this.ngVariableMap = new Map();
        this.innerValueMap = new Map();
        // 重新组织变量元数据
        Object.keys(ngVariables).forEach((/**
         * @param {?} propName
         * @return {?}
         */
        (propName) => {
            this.ngVariableMap.set(propName, ngVariables[propName]);
        }));
    }
    /**
     * 获取变更集
     * @param {?} changeDetail
     * @return {?}
     */
    handleChangeDetail(changeDetail) {
        /** @type {?} */
        const changeInfo = changeDetail.ChangeInfo;
        Object.keys(changeInfo).forEach((/**
         * @param {?} varName
         * @return {?}
         */
        (varName) => {
            // 变量元数据
            /** @type {?} */
            const ngVariable = this.ngVariableMap.get(varName);
            if (!ngVariable) {
                return;
            }
            /** @type {?} */
            const mapping = ngVariable.mapping;
            // 更新UIState变更
            /** @type {?} */
            const newValue = changeInfo[varName];
            /** @type {?} */
            const oldValue = this.innerValueMap.get(varName);
            if (oldValue === newValue) {
                return;
            }
            // 更新值
            this.setValueToUIState(mapping, newValue);
            this.innerValueMap.set(varName, newValue);
        }));
    }
    /**
     * Build ChangeDetail instance for all variables.
     * @return {?}
     */
    buildChangeDetail() {
        /** @type {?} */
        const changeDetail = BefChangeUtil.createEmpty(ChangeDetailType.Modify);
        this.ngVariableMap.forEach((/**
         * @param {?} ngVariable
         * @param {?} varName
         * @return {?}
         */
        (ngVariable, varName) => {
            /** @type {?} */
            const mapping = ngVariable.mapping;
            /** @type {?} */
            const newValue = this.getValueFromUIState(mapping);
            /** @type {?} */
            const oldValue = this.innerValueMap.get(varName);
            if (this.isValueEqual(newValue, oldValue) === false) {
                // 不清除变更，请求成功后清除变更
                // this.innerValueMap.set(varName, newValue);
                this.appendToChangeInfo(changeDetail, varName, newValue);
            }
        }));
        if (Object.keys(changeDetail.ChangeInfo).length === 0) {
            return null;
        }
        return changeDetail;
    }
    /**
     * Clear variable values cached in the innerValueMap property.
     * @return {?}
     */
    reset() {
        this.innerValueMap.clear();
    }
    /**
     * 清空vo变量变更集
     * @param {?} changeDetail
     * @return {?}
     */
    clearChanges(changeDetail) {
        if (!changeDetail || Object.keys(changeDetail.ChangeInfo).length === 0) {
            return;
        }
        Object.keys(changeDetail.ChangeInfo).forEach((/**
         * @param {?} key
         * @return {?}
         */
        (key) => {
            /** @type {?} */
            const ngVariable = this.ngVariableMap.get(key);
            if (!ngVariable) {
                return;
            }
            /** @type {?} */
            const mapping = ngVariable.mapping;
            /** @type {?} */
            const newValue = this.getValueFromUIState(mapping);
            this.innerValueMap.set(key, newValue);
        }));
    }
    /**
     * Append changed variable to ChangeDetail instance.
     * @private
     * @param {?} changeDetail
     * @param {?} varName
     * @param {?} varValue
     * @return {?}
     */
    appendToChangeInfo(changeDetail, varName, varValue) {
        if (this.isUdtVariable(varValue) === true) {
            /** @type {?} */
            const udtVarChangeDetail = BefChangeUtil.createEmpty(ChangeDetailType.Modify);
            udtVarChangeDetail.ChangeInfo = varValue;
            changeDetail.ChangeInfo[varName] = udtVarChangeDetail;
        }
        else {
            changeDetail.ChangeInfo[varName] = varValue;
        }
    }
    /**
     * 从UIState上获取值
     * @private
     * @param {?} mapping
     * @return {?}
     */
    getValueFromUIState(mapping) {
        /** @type {?} */
        const uiState = this.getRootUIState();
        // 计算value
        /** @type {?} */
        const mappingArray = mapping.split('.');
        /** @type {?} */
        const value = mappingArray.reduce((/**
         * @param {?} accumulator
         * @param {?} currentValue
         * @return {?}
         */
        (accumulator, currentValue) => {
            return accumulator ? accumulator[currentValue] : null;
        }), uiState);
        if (value instanceof Date) {
            return format(value, 'yyyy-MM-dd HH:mm:ss');
        }
        return value;
    }
    /**
     * 获取根组件上的UIState
     * @private
     * @return {?}
     */
    getRootUIState() {
        /** @type {?} */
        let rootFrameContext = this.appContext.frameContextManager.getRootFrameContext();
        if (this.injector) {
            /** @type {?} */
            const frameContext = this.injector.get(FrameContext, null);
            if (frameContext) {
                /** @type {?} */
                const virtualRootFrameContext = frameContext.getVirtualRootFrameContext();
                rootFrameContext = virtualRootFrameContext || rootFrameContext;
            }
        }
        if (!rootFrameContext) {
            return;
        }
        return rootFrameContext.uiState;
    }
    /**
     * 值比较
     * \@todo 临时采用这种方式
     * @private
     * @param {?} srcValue
     * @param {?} dstValue
     * @return {?}
     */
    isValueEqual(srcValue, dstValue) {
        return JSON.stringify(srcValue) === JSON.stringify(dstValue);
    }
    /**
     * Check if the object is a plain object
     * @private
     * @param {?} obj
     * @return {?}
     */
    isUdtVariable(obj) {
        return obj && obj.constructor &&
            obj.toString() === '[object Object]' &&
            obj.constructor.prototype.hasOwnProperty('isPrototypeOf');
    }
    /**
     * 设置值到UIState
     * \@todo：
     * 1、服务器端不支持；
     * 2、日期类型处理方案待定。
     * @private
     * @param {?} mapping
     * @param {?} value
     * @return {?}
     */
    setValueToUIState(mapping, value) {
        /** @type {?} */
        const uiState = this.getRootUIState();
        uiState[mapping] = value;
    }
}
/** @nocollapse */
BefVariableManager.ctorParameters = () => [
    { type: AppContext },
    { type: undefined },
    { type: Injector, decorators: [{ type: Optional }] }
];
if (false) {
    /**
     * 变量元数据
     * @type {?}
     * @private
     */
    BefVariableManager.prototype.ngVariableMap;
    /**
     * 设置值
     * @type {?}
     * @private
     */
    BefVariableManager.prototype.innerValueMap;
    /**
     * @type {?}
     * @private
     */
    BefVariableManager.prototype.appContext;
    /**
     * @type {?}
     * @private
     */
    BefVariableManager.prototype.ngVariables;
    /**
     * @type {?}
     * @private
     */
    BefVariableManager.prototype.injector;
}
export { BefVariableManager };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmVmX3ZhcmlhYmxlX21hbmFnZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2JlZi8iLCJzb3VyY2VzIjpbImxpYi9iZWZfdmFyaWFibGVfbWFuYWdlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQU1BLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDbEMsT0FBTyxFQUFFLFVBQVUsRUFBRSxZQUFZLEVBQVcsTUFBTSxnQkFBZ0IsQ0FBQztBQUNuRSxPQUFPLEVBQUUsZ0JBQWdCLEVBQWdCLE1BQU0sU0FBUyxDQUFDO0FBRXpELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNsRCxPQUFPLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQzs7OztBQU1uRCxNQUFNLGtCQUFrQjs7Ozs7OztJQWV0QixZQUFvQixVQUFzQixFQUFVLFdBQWdCLEVBQXNCLFFBQWtCO1FBQXhGLGVBQVUsR0FBVixVQUFVLENBQVk7UUFBVSxnQkFBVyxHQUFYLFdBQVcsQ0FBSztRQUFzQixhQUFRLEdBQVIsUUFBUSxDQUFVO1FBRTFHLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxHQUFHLEVBQXNCLENBQUM7UUFDbkQsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLEdBQUcsRUFBZSxDQUFDO1FBRTVDLFlBQVk7UUFDWixNQUFNLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLE9BQU87Ozs7UUFBQyxDQUFDLFFBQWdCLEVBQUUsRUFBRTtZQUNwRCxJQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUUsV0FBVyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7UUFDMUQsQ0FBQyxFQUFDLENBQUM7SUFDTCxDQUFDOzs7Ozs7SUFLTSxrQkFBa0IsQ0FBQyxZQUEwQjs7Y0FDNUMsVUFBVSxHQUFHLFlBQVksQ0FBQyxVQUFVO1FBQzFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsT0FBTzs7OztRQUFDLENBQUMsT0FBZSxFQUFFLEVBQUU7OztrQkFFNUMsVUFBVSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQztZQUNsRCxJQUFJLENBQUMsVUFBVSxFQUFFO2dCQUNmLE9BQU87YUFDUjs7a0JBQ0ssT0FBTyxHQUFHLFVBQVUsQ0FBQyxPQUFPOzs7a0JBRzVCLFFBQVEsR0FBRyxVQUFVLENBQUMsT0FBTyxDQUFDOztrQkFDOUIsUUFBUSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQztZQUVoRCxJQUFJLFFBQVEsS0FBSyxRQUFRLEVBQUU7Z0JBQ3pCLE9BQU87YUFDUjtZQUNELE1BQU07WUFDTixJQUFJLENBQUMsaUJBQWlCLENBQUMsT0FBTyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1lBQzFDLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxRQUFRLENBQUMsQ0FBQztRQUM1QyxDQUFDLEVBQUMsQ0FBQztJQUNMLENBQUM7Ozs7O0lBS00saUJBQWlCOztjQUNoQixZQUFZLEdBQUcsYUFBYSxDQUFDLFdBQVcsQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLENBQUM7UUFDdkUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPOzs7OztRQUFDLENBQUMsVUFBc0IsRUFBRSxPQUFlLEVBQUUsRUFBRTs7a0JBQy9ELE9BQU8sR0FBRyxVQUFVLENBQUMsT0FBTzs7a0JBQzVCLFFBQVEsR0FBRyxJQUFJLENBQUMsbUJBQW1CLENBQUMsT0FBTyxDQUFDOztrQkFDNUMsUUFBUSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQztZQUNoRCxJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMsUUFBUSxFQUFFLFFBQVEsQ0FBQyxLQUFLLEtBQUssRUFBRTtnQkFDbkQsa0JBQWtCO2dCQUNsQiw2Q0FBNkM7Z0JBQzdDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxZQUFZLEVBQUUsT0FBTyxFQUFFLFFBQVEsQ0FBQyxDQUFDO2FBQzFEO1FBQ0gsQ0FBQyxFQUFDLENBQUM7UUFFSCxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7WUFDckQsT0FBTyxJQUFJLENBQUM7U0FDYjtRQUVELE9BQU8sWUFBWSxDQUFDO0lBQ3RCLENBQUM7Ozs7O0lBS00sS0FBSztRQUNWLElBQUksQ0FBQyxhQUFhLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDN0IsQ0FBQzs7Ozs7O0lBSU0sWUFBWSxDQUFDLFlBQTBCO1FBQzVDLElBQUksQ0FBQyxZQUFZLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtZQUN0RSxPQUFPO1NBQ1I7UUFDRCxNQUFNLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsQ0FBQyxPQUFPOzs7O1FBQUMsQ0FBQyxHQUFXLEVBQUUsRUFBRTs7a0JBQ3JELFVBQVUsR0FBZSxJQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUM7WUFDMUQsSUFBSSxDQUFDLFVBQVUsRUFBRTtnQkFDZixPQUFPO2FBQ1I7O2tCQUNLLE9BQU8sR0FBRyxVQUFVLENBQUMsT0FBTzs7a0JBQzVCLFFBQVEsR0FBRyxJQUFJLENBQUMsbUJBQW1CLENBQUMsT0FBTyxDQUFDO1lBQ2xELElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxRQUFRLENBQUMsQ0FBQztRQUN4QyxDQUFDLEVBQUMsQ0FBQztJQUNMLENBQUM7Ozs7Ozs7OztJQUlPLGtCQUFrQixDQUFDLFlBQTBCLEVBQUUsT0FBZSxFQUFFLFFBQWE7UUFDbkYsSUFBSSxJQUFJLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxLQUFLLElBQUksRUFBRTs7a0JBQ25DLGtCQUFrQixHQUFHLGFBQWEsQ0FBQyxXQUFXLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxDQUFDO1lBQzdFLGtCQUFrQixDQUFDLFVBQVUsR0FBRyxRQUFRLENBQUM7WUFDekMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsR0FBRyxrQkFBa0IsQ0FBQztTQUN2RDthQUFNO1lBQ0wsWUFBWSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsR0FBRyxRQUFRLENBQUM7U0FDN0M7SUFDSCxDQUFDOzs7Ozs7O0lBS08sbUJBQW1CLENBQUMsT0FBZTs7Y0FDbkMsT0FBTyxHQUFHLElBQUksQ0FBQyxjQUFjLEVBQUU7OztjQUcvQixZQUFZLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUM7O2NBQ2pDLEtBQUssR0FBRyxZQUFZLENBQUMsTUFBTTs7Ozs7UUFBQyxDQUFDLFdBQWdCLEVBQUUsWUFBaUIsRUFBRSxFQUFFO1lBQ3hFLE9BQU8sV0FBVyxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztRQUN4RCxDQUFDLEdBQUUsT0FBTyxDQUFDO1FBRVgsSUFBSSxLQUFLLFlBQVksSUFBSSxFQUFFO1lBQ3pCLE9BQU8sTUFBTSxDQUFDLEtBQUssRUFBRSxxQkFBcUIsQ0FBQyxDQUFDO1NBQzdDO1FBQ0QsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDOzs7Ozs7SUFLTyxjQUFjOztZQUVoQixnQkFBZ0IsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLG1CQUFtQixDQUFDLG1CQUFtQixFQUFFO1FBQ2hGLElBQUksSUFBSSxDQUFDLFFBQVEsRUFBRTs7a0JBQ1gsWUFBWSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFlLFlBQVksRUFBRSxJQUFJLENBQUM7WUFDeEUsSUFBSSxZQUFZLEVBQUU7O3NCQUNWLHVCQUF1QixHQUFHLFlBQVksQ0FBQywwQkFBMEIsRUFBRTtnQkFDekUsZ0JBQWdCLEdBQUcsdUJBQXVCLElBQUksZ0JBQWdCLENBQUM7YUFDaEU7U0FDRjtRQUNELElBQUksQ0FBQyxnQkFBZ0IsRUFBRTtZQUNyQixPQUFPO1NBQ1I7UUFDRCxPQUFPLGdCQUFnQixDQUFDLE9BQU8sQ0FBQztJQUNsQyxDQUFDOzs7Ozs7Ozs7SUFNTyxZQUFZLENBQUMsUUFBYSxFQUFFLFFBQWE7UUFDL0MsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxLQUFLLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDL0QsQ0FBQzs7Ozs7OztJQUtPLGFBQWEsQ0FBQyxHQUFRO1FBQzVCLE9BQU8sR0FBRyxJQUFJLEdBQUcsQ0FBQyxXQUFXO1lBQzNCLEdBQUcsQ0FBQyxRQUFRLEVBQUUsS0FBSyxpQkFBaUI7WUFDcEMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsY0FBYyxDQUFDLGVBQWUsQ0FBQyxDQUFDO0lBQzlELENBQUM7Ozs7Ozs7Ozs7O0lBU08saUJBQWlCLENBQUMsT0FBZSxFQUFFLEtBQVU7O2NBQzdDLE9BQU8sR0FBRyxJQUFJLENBQUMsY0FBYyxFQUFFO1FBQ3JDLE9BQU8sQ0FBQyxPQUFPLENBQUMsR0FBRyxLQUFLLENBQUM7SUFDM0IsQ0FBQzs7OztZQXpMTSxVQUFVOztZQUlWLFFBQVEsdUJBcUJ3RCxRQUFROzs7Ozs7OztJQVYvRSwyQ0FBK0M7Ozs7OztJQUsvQywyQ0FBd0M7Ozs7O0lBSzVCLHdDQUE4Qjs7Ozs7SUFBRSx5Q0FBd0I7Ozs7O0lBQUUsc0NBQXNDOztBQXFLOUcsT0FBTyxFQUFFLGtCQUFrQixFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxyXG4gKiBAQXV0aG9yOiBXaXR0XHJcbiAqIEBEYXRlOiAyMDE5LTAzLTA1IDE5OjU1OjQ0XHJcbiAqIEBMYXN0IE1vZGlmaWVkIGJ5OiBXaXR0XHJcbiAqIEBMYXN0IE1vZGlmaWVkIHRpbWU6IDIwMTktMDMtMTMgMjA6MzU6MjlcclxuICovXHJcbmltcG9ydCB7IGZvcm1hdCB9IGZyb20gJ2RhdGUtZm5zJztcclxuaW1wb3J0IHsgQXBwQ29udGV4dCwgRnJhbWVDb250ZXh0LCBVSVN0YXRlIH0gZnJvbSAnQGZhcnJpcy9kZXZraXQnO1xyXG5pbXBvcnQgeyBDaGFuZ2VEZXRhaWxUeXBlLCBDaGFuZ2VEZXRhaWwgfSBmcm9tICcuL3R5cGVzJztcclxuaW1wb3J0IHsgTmdWYXJpYWJsZSB9IGZyb20gJy4vZGVjb3JhdG9ycyc7XHJcbmltcG9ydCB7IEJlZkNoYW5nZVV0aWwgfSBmcm9tICcuL2JlZl9jaGFuZ2VfdXRpbCc7XHJcbmltcG9ydCB7IEluamVjdG9yLCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5cclxuXHJcbi8qKlxyXG4gKiBCZeWPmOmHj+euoeeQhuWZqFxyXG4gKi9cclxuY2xhc3MgQmVmVmFyaWFibGVNYW5hZ2VyIHtcclxuXHJcbiAgLyoqXHJcbiAgICog5Y+Y6YeP5YWD5pWw5o2uXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBuZ1ZhcmlhYmxlTWFwOiBNYXA8c3RyaW5nLCBOZ1ZhcmlhYmxlPjtcclxuXHJcbiAgLyoqXHJcbiAgICog6K6+572u5YC8XHJcbiAgICovXHJcbiAgcHJpdmF0ZSBpbm5lclZhbHVlTWFwOiBNYXA8c3RyaW5nLCBhbnk+O1xyXG5cclxuICAvKipcclxuICAgKiDmnoTpgKDlh73mlbBcclxuICAgKi9cclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGFwcENvbnRleHQ6IEFwcENvbnRleHQsIHByaXZhdGUgbmdWYXJpYWJsZXM6IGFueSwgQE9wdGlvbmFsKCkgcHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IpIHtcclxuXHJcbiAgICB0aGlzLm5nVmFyaWFibGVNYXAgPSBuZXcgTWFwPHN0cmluZywgTmdWYXJpYWJsZT4oKTtcclxuICAgIHRoaXMuaW5uZXJWYWx1ZU1hcCA9IG5ldyBNYXA8c3RyaW5nLCBhbnk+KCk7XHJcblxyXG4gICAgLy8g6YeN5paw57uE57uH5Y+Y6YeP5YWD5pWw5o2uXHJcbiAgICBPYmplY3Qua2V5cyhuZ1ZhcmlhYmxlcykuZm9yRWFjaCgocHJvcE5hbWU6IHN0cmluZykgPT4ge1xyXG4gICAgICB0aGlzLm5nVmFyaWFibGVNYXAuc2V0KHByb3BOYW1lLCBuZ1ZhcmlhYmxlc1twcm9wTmFtZV0pO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDojrflj5blj5jmm7Tpm4ZcclxuICAgKi9cclxuICBwdWJsaWMgaGFuZGxlQ2hhbmdlRGV0YWlsKGNoYW5nZURldGFpbDogQ2hhbmdlRGV0YWlsKTogdm9pZCB7XHJcbiAgICBjb25zdCBjaGFuZ2VJbmZvID0gY2hhbmdlRGV0YWlsLkNoYW5nZUluZm87XHJcbiAgICBPYmplY3Qua2V5cyhjaGFuZ2VJbmZvKS5mb3JFYWNoKCh2YXJOYW1lOiBzdHJpbmcpID0+IHtcclxuICAgICAgLy8g5Y+Y6YeP5YWD5pWw5o2uXHJcbiAgICAgIGNvbnN0IG5nVmFyaWFibGUgPSB0aGlzLm5nVmFyaWFibGVNYXAuZ2V0KHZhck5hbWUpO1xyXG4gICAgICBpZiAoIW5nVmFyaWFibGUpIHtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuICAgICAgY29uc3QgbWFwcGluZyA9IG5nVmFyaWFibGUubWFwcGluZztcclxuXHJcbiAgICAgIC8vIOabtOaWsFVJU3RhdGXlj5jmm7RcclxuICAgICAgY29uc3QgbmV3VmFsdWUgPSBjaGFuZ2VJbmZvW3Zhck5hbWVdO1xyXG4gICAgICBjb25zdCBvbGRWYWx1ZSA9IHRoaXMuaW5uZXJWYWx1ZU1hcC5nZXQodmFyTmFtZSk7XHJcblxyXG4gICAgICBpZiAob2xkVmFsdWUgPT09IG5ld1ZhbHVlKSB7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcbiAgICAgIC8vIOabtOaWsOWAvFxyXG4gICAgICB0aGlzLnNldFZhbHVlVG9VSVN0YXRlKG1hcHBpbmcsIG5ld1ZhbHVlKTtcclxuICAgICAgdGhpcy5pbm5lclZhbHVlTWFwLnNldCh2YXJOYW1lLCBuZXdWYWx1ZSk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEJ1aWxkIENoYW5nZURldGFpbCBpbnN0YW5jZSBmb3IgYWxsIHZhcmlhYmxlcy5cclxuICAgKi9cclxuICBwdWJsaWMgYnVpbGRDaGFuZ2VEZXRhaWwoKTogQ2hhbmdlRGV0YWlsIHtcclxuICAgIGNvbnN0IGNoYW5nZURldGFpbCA9IEJlZkNoYW5nZVV0aWwuY3JlYXRlRW1wdHkoQ2hhbmdlRGV0YWlsVHlwZS5Nb2RpZnkpO1xyXG4gICAgdGhpcy5uZ1ZhcmlhYmxlTWFwLmZvckVhY2goKG5nVmFyaWFibGU6IE5nVmFyaWFibGUsIHZhck5hbWU6IHN0cmluZykgPT4ge1xyXG4gICAgICBjb25zdCBtYXBwaW5nID0gbmdWYXJpYWJsZS5tYXBwaW5nO1xyXG4gICAgICBjb25zdCBuZXdWYWx1ZSA9IHRoaXMuZ2V0VmFsdWVGcm9tVUlTdGF0ZShtYXBwaW5nKTtcclxuICAgICAgY29uc3Qgb2xkVmFsdWUgPSB0aGlzLmlubmVyVmFsdWVNYXAuZ2V0KHZhck5hbWUpO1xyXG4gICAgICBpZiAodGhpcy5pc1ZhbHVlRXF1YWwobmV3VmFsdWUsIG9sZFZhbHVlKSA9PT0gZmFsc2UpIHtcclxuICAgICAgICAvLyDkuI3muIXpmaTlj5jmm7TvvIzor7fmsYLmiJDlip/lkI7muIXpmaTlj5jmm7RcclxuICAgICAgICAvLyB0aGlzLmlubmVyVmFsdWVNYXAuc2V0KHZhck5hbWUsIG5ld1ZhbHVlKTtcclxuICAgICAgICB0aGlzLmFwcGVuZFRvQ2hhbmdlSW5mbyhjaGFuZ2VEZXRhaWwsIHZhck5hbWUsIG5ld1ZhbHVlKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcblxyXG4gICAgaWYgKE9iamVjdC5rZXlzKGNoYW5nZURldGFpbC5DaGFuZ2VJbmZvKS5sZW5ndGggPT09IDApIHtcclxuICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIGNoYW5nZURldGFpbDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIENsZWFyIHZhcmlhYmxlIHZhbHVlcyBjYWNoZWQgaW4gdGhlIGlubmVyVmFsdWVNYXAgcHJvcGVydHkuXHJcbiAgICovXHJcbiAgcHVibGljIHJlc2V0KCkge1xyXG4gICAgdGhpcy5pbm5lclZhbHVlTWFwLmNsZWFyKCk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOa4heepunZv5Y+Y6YeP5Y+Y5pu06ZuGXHJcbiAgICovXHJcbiAgcHVibGljIGNsZWFyQ2hhbmdlcyhjaGFuZ2VEZXRhaWw6IENoYW5nZURldGFpbCkge1xyXG4gICAgaWYgKCFjaGFuZ2VEZXRhaWwgfHwgT2JqZWN0LmtleXMoY2hhbmdlRGV0YWlsLkNoYW5nZUluZm8pLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBPYmplY3Qua2V5cyhjaGFuZ2VEZXRhaWwuQ2hhbmdlSW5mbykuZm9yRWFjaCgoa2V5OiBzdHJpbmcpID0+IHtcclxuICAgICAgY29uc3QgbmdWYXJpYWJsZTogTmdWYXJpYWJsZSA9IHRoaXMubmdWYXJpYWJsZU1hcC5nZXQoa2V5KTtcclxuICAgICAgaWYgKCFuZ1ZhcmlhYmxlKSB7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcbiAgICAgIGNvbnN0IG1hcHBpbmcgPSBuZ1ZhcmlhYmxlLm1hcHBpbmc7XHJcbiAgICAgIGNvbnN0IG5ld1ZhbHVlID0gdGhpcy5nZXRWYWx1ZUZyb21VSVN0YXRlKG1hcHBpbmcpO1xyXG4gICAgICB0aGlzLmlubmVyVmFsdWVNYXAuc2V0KGtleSwgbmV3VmFsdWUpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIEFwcGVuZCBjaGFuZ2VkIHZhcmlhYmxlIHRvIENoYW5nZURldGFpbCBpbnN0YW5jZS5cclxuICAgKi9cclxuICBwcml2YXRlIGFwcGVuZFRvQ2hhbmdlSW5mbyhjaGFuZ2VEZXRhaWw6IENoYW5nZURldGFpbCwgdmFyTmFtZTogc3RyaW5nLCB2YXJWYWx1ZTogYW55KTogdm9pZCB7XHJcbiAgICBpZiAodGhpcy5pc1VkdFZhcmlhYmxlKHZhclZhbHVlKSA9PT0gdHJ1ZSkge1xyXG4gICAgICBjb25zdCB1ZHRWYXJDaGFuZ2VEZXRhaWwgPSBCZWZDaGFuZ2VVdGlsLmNyZWF0ZUVtcHR5KENoYW5nZURldGFpbFR5cGUuTW9kaWZ5KTtcclxuICAgICAgdWR0VmFyQ2hhbmdlRGV0YWlsLkNoYW5nZUluZm8gPSB2YXJWYWx1ZTtcclxuICAgICAgY2hhbmdlRGV0YWlsLkNoYW5nZUluZm9bdmFyTmFtZV0gPSB1ZHRWYXJDaGFuZ2VEZXRhaWw7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBjaGFuZ2VEZXRhaWwuQ2hhbmdlSW5mb1t2YXJOYW1lXSA9IHZhclZhbHVlO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5LuOVUlTdGF0ZeS4iuiOt+WPluWAvFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0VmFsdWVGcm9tVUlTdGF0ZShtYXBwaW5nOiBzdHJpbmcpOiBhbnkge1xyXG4gICAgY29uc3QgdWlTdGF0ZSA9IHRoaXMuZ2V0Um9vdFVJU3RhdGUoKTtcclxuXHJcbiAgICAvLyDorqHnrpd2YWx1ZVxyXG4gICAgY29uc3QgbWFwcGluZ0FycmF5ID0gbWFwcGluZy5zcGxpdCgnLicpO1xyXG4gICAgY29uc3QgdmFsdWUgPSBtYXBwaW5nQXJyYXkucmVkdWNlKChhY2N1bXVsYXRvcjogYW55LCBjdXJyZW50VmFsdWU6IGFueSkgPT4ge1xyXG4gICAgICByZXR1cm4gYWNjdW11bGF0b3IgPyBhY2N1bXVsYXRvcltjdXJyZW50VmFsdWVdIDogbnVsbDtcclxuICAgIH0sIHVpU3RhdGUpO1xyXG5cclxuICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIERhdGUpIHtcclxuICAgICAgcmV0dXJuIGZvcm1hdCh2YWx1ZSwgJ3l5eXktTU0tZGQgSEg6bW06c3MnKTtcclxuICAgIH1cclxuICAgIHJldHVybiB2YWx1ZTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluaguee7hOS7tuS4iueahFVJU3RhdGVcclxuICAgKi9cclxuICBwcml2YXRlIGdldFJvb3RVSVN0YXRlKCk6IFVJU3RhdGUge1xyXG5cclxuICAgIGxldCByb290RnJhbWVDb250ZXh0ID0gdGhpcy5hcHBDb250ZXh0LmZyYW1lQ29udGV4dE1hbmFnZXIuZ2V0Um9vdEZyYW1lQ29udGV4dCgpO1xyXG4gICAgaWYgKHRoaXMuaW5qZWN0b3IpIHtcclxuICAgICAgY29uc3QgZnJhbWVDb250ZXh0ID0gdGhpcy5pbmplY3Rvci5nZXQ8RnJhbWVDb250ZXh0PihGcmFtZUNvbnRleHQsIG51bGwpO1xyXG4gICAgICBpZiAoZnJhbWVDb250ZXh0KSB7XHJcbiAgICAgICAgY29uc3QgdmlydHVhbFJvb3RGcmFtZUNvbnRleHQgPSBmcmFtZUNvbnRleHQuZ2V0VmlydHVhbFJvb3RGcmFtZUNvbnRleHQoKTtcclxuICAgICAgICByb290RnJhbWVDb250ZXh0ID0gdmlydHVhbFJvb3RGcmFtZUNvbnRleHQgfHwgcm9vdEZyYW1lQ29udGV4dDtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgaWYgKCFyb290RnJhbWVDb250ZXh0KSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIHJldHVybiByb290RnJhbWVDb250ZXh0LnVpU3RhdGU7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDlgLzmr5TovoNcclxuICAgKiBAdG9kbyDkuLTml7bph4fnlKjov5nnp43mlrnlvI9cclxuICAgKi9cclxuICBwcml2YXRlIGlzVmFsdWVFcXVhbChzcmNWYWx1ZTogYW55LCBkc3RWYWx1ZTogYW55KTogYm9vbGVhbiB7XHJcbiAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkoc3JjVmFsdWUpID09PSBKU09OLnN0cmluZ2lmeShkc3RWYWx1ZSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBDaGVjayBpZiB0aGUgb2JqZWN0IGlzIGEgcGxhaW4gb2JqZWN0XHJcbiAgICovXHJcbiAgcHJpdmF0ZSBpc1VkdFZhcmlhYmxlKG9iajogYW55KTogYm9vbGVhbiB7XHJcbiAgICByZXR1cm4gb2JqICYmIG9iai5jb25zdHJ1Y3RvciAmJlxyXG4gICAgICBvYmoudG9TdHJpbmcoKSA9PT0gJ1tvYmplY3QgT2JqZWN0XScgJiZcclxuICAgICAgb2JqLmNvbnN0cnVjdG9yLnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eSgnaXNQcm90b3R5cGVPZicpO1xyXG4gIH1cclxuXHJcblxyXG4gIC8qKlxyXG4gICAqIOiuvue9ruWAvOWIsFVJU3RhdGVcclxuICAgKiBAdG9kb++8mlxyXG4gICAqIDHjgIHmnI3liqHlmajnq6/kuI3mlK/mjIHvvJtcclxuICAgKiAy44CB5pel5pyf57G75Z6L5aSE55CG5pa55qGI5b6F5a6a44CCXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBzZXRWYWx1ZVRvVUlTdGF0ZShtYXBwaW5nOiBzdHJpbmcsIHZhbHVlOiBhbnkpOiB2b2lkIHtcclxuICAgIGNvbnN0IHVpU3RhdGUgPSB0aGlzLmdldFJvb3RVSVN0YXRlKCk7XHJcbiAgICB1aVN0YXRlW21hcHBpbmddID0gdmFsdWU7XHJcbiAgfVxyXG5cclxuXHJcbn1cclxuXHJcbmV4cG9ydCB7IEJlZlZhcmlhYmxlTWFuYWdlciB9O1xyXG4iXX0=