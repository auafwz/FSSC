import { Injectable } from '@angular/core';
import { of, from, EMPTY } from 'rxjs';
import { every, concatMap, switchMap, take, tap } from 'rxjs/operators';
import { RuntimeFrameworkService } from './rtf-service';
import { MenuStateService } from './menu-state.service';
import { TAB_EVENT } from './types';
import { QuerystringService } from './querystring';
import { UID } from '@farris/devkit';
/**
 * 导航事件服务
 * @scope FormModule
 */
export class NavigationEventService {
    constructor(runtimeFrameworkService, menuStateService, querystringService) {
        this.runtimeFrameworkService = runtimeFrameworkService;
        this.menuStateService = menuStateService;
        this.querystringService = querystringService;
        this.onClosedListeners = new Map();
        this.onClosingListeners = new Map();
        this.onTabSwitchListeners = new Map();
    }
    get querystrings() {
        const params = this.querystringService.parse(window.location.hash);
        // 修正formToken
        if (params) {
            params.formToken = this.runtimeFrameworkService.formToken;
        }
        return params;
    }
    /**
     * 注册事件
     */
    registerEvent() {
        const options = this.querystrings;
        this.params = options;
        // 注册标签页切换事件
        this.runtimeFrameworkService.addEventListener(TAB_EVENT.onTabSwitched, (e) => this.handleTabSwitchEvent(e), options);
        // 注册标签页关闭后事件
        this.runtimeFrameworkService.addEventListener(TAB_EVENT.onTabClosed, (e) => this.handleTabClosedEvent(e), options);
        // 注册标签页关闭前事件
        this.runtimeFrameworkService.addEventListener(TAB_EVENT.onTabClosing, (e) => this.handleTabClosingEvent(e), options);
    }
    /**
     * 处理标签页切换事件
     */
    handleTabSwitchEvent(e) {
        if (!e) {
            return;
        }
        // 选中的表单为系统表单，只能返回id，没有tabId
        const eventTabId = e.tabId || e.id || null;
        if (!eventTabId) {
            return;
        }
        const options = this.params; // this.querystrings;
        const tabId = options.tabId || options.funcId || options.appId;
        const menuState = this.menuStateService.getMenuState(eventTabId);
        if (!!tabId && tabId === eventTabId && !!menuState && menuState.length > 0) {
            this.formReload();
        }
        this.fireTabSwitchEvent(e);
    }
    /**
     * 触发tab切换事件
     * @param e e
     */
    fireTabSwitchEvent(e) {
        if (!this.onTabSwitchListeners || this.onTabSwitchListeners.size < 1) {
            return;
        }
        this.onTabSwitchListeners.forEach((handle, key, map) => {
            if (typeof handle === 'function') {
                handle(e);
            }
        });
    }
    /**
     * 标签页关闭前事件
     */
    handleTabClosingEvent(e) {
        if (!e) {
            return;
        }
        // 要关闭的表单为系统表单，只能返回id，没有tabId
        const eventTabId = e.tabId || e.id || null;
        const options = this.params; // this.querystrings;
        const tabId = options.tabId || options.funcId || options.appId;
        if (!!eventTabId && !!tabId && tabId === eventTabId) {
            this.fireTabClosingEvent(e).subscribe(result => {
                if (result) {
                    setTimeout(() => this.removeMenuState(eventTabId), 500);
                    const formEventServices = window['formEventServices'];
                    if (formEventServices.has(eventTabId)) {
                        formEventServices.delete(eventTabId);
                        window['formEventServices'] = formEventServices;
                    }
                    if (!(e && e.hasOwnProperty('token'))) {
                        e = Object.assign({}, e, { token: options.formToken });
                    }
                    this.runtimeFrameworkService.closeMenu(e);
                }
            });
        }
    }
    /**
     * 触发关闭前事件
     */
    fireTabClosingEvent(e) {
        if (!this.onClosingListeners || this.onClosingListeners.size < 1) {
            return of(true);
        }
        const listeners = this.onClosingListeners.values();
        const result$ = from(listeners);
        // 用户拒绝
        let userRejected = false;
        return result$.pipe(concatMap(handle => {
            if (userRejected) {
                return EMPTY;
            }
            return handle(e).pipe(take(1), tap(result => userRejected = !result), switchMap(result => of(result)));
        }), every(result => result));
    }
    /**
     * 标签页关闭后事件
     */
    handleTabClosedEvent(e) {
        if (!e) {
            return;
        }
        const options = this.params; // this.querystrings;
        const tabId = options.tabId || options.funcId || options.appId;
        const eventTabId = e.tabId || e.id || null;
        if (tabId === eventTabId) {
            return;
        }
        const menuState = this.menuStateService.getMenuState(tabId, eventTabId);
        if (!!eventTabId && !!menuState && menuState.length > 0) {
            this.removeMenuState(eventTabId);
            this.formReload();
        }
        this.fireTabClosedEvent(e);
    }
    removeMenuState(tabId) {
        if (this['context']) {
            this.menuStateService.removeMenu(tabId);
        }
    }
    /**
     * 触发关闭后事件
     * @param e event
     */
    fireTabClosedEvent(e) {
        if (!this.onClosedListeners || this.onClosedListeners.size < 1) {
            return;
        }
        this.onClosedListeners.forEach((handle, key, map) => {
            if (typeof handle === 'function') {
                handle(e);
            }
        });
    }
    // #endregion
    /**
     * 注册事件监听器
     * @param eventType 事件类型 onTabClosed
     * @param handler 处理器
     */
    addEventListener(eventType, handler) {
        const key = UID.create();
        if (eventType === TAB_EVENT.onTabClosed) {
            this.onClosedListeners.set(key, handler);
            return key;
        }
        else if (eventType === TAB_EVENT.onTabClosing) {
            this.onClosingListeners.set(key, handler);
            return key;
        }
        else if (eventType === TAB_EVENT.onTabSwitched) {
            this.onTabSwitchListeners.set(key, handler);
            return key;
        }
        return null;
    }
    /**
     * 移除事件监听器
     * @param eventType 事件类型
     * @param key 事件标识
     */
    removeEventListener(eventType, key) {
        if (eventType === TAB_EVENT.onTabClosed) {
            return this.onClosedListeners.delete(key);
        }
        else if (eventType === TAB_EVENT.onTabClosing) {
            return this.onClosingListeners.delete(key);
        }
        return false;
    }
    /**
     * 清空事件监听器
     * @param eventType 事件类型
     */
    clearEventListener(eventType) {
        if (eventType === TAB_EVENT.onTabClosed) {
            this.onClosedListeners.clear();
        }
        else if (eventType === TAB_EVENT.onTabClosing) {
            this.onClosingListeners.clear();
        }
    }
    /**
     * 刷新组件数据
     */
    formReload() {
        try {
            // tslint:disable-next-line: no-string-literal
            this['context']['frameContext']['appContext']['refresh']();
        }
        catch (_a) { }
    }
}
NavigationEventService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
NavigationEventService.ctorParameters = () => [
    { type: RuntimeFrameworkService },
    { type: MenuStateService },
    { type: QuerystringService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmF2aWdhdGlvbi1ldmVudC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL25hdmlnYXRpb24tZXZlbnQuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFZLE1BQU0sZUFBZSxDQUFDO0FBQ3JELE9BQU8sRUFBYyxFQUFFLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNuRCxPQUFPLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXhFLE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN4RCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUN4RCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQ3BDLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNuRCxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFckM7OztHQUdHO0FBRUgsTUFBTSxPQUFPLHNCQUFzQjtJQVlqQyxZQUNVLHVCQUFnRCxFQUNoRCxnQkFBa0MsRUFDbEMsa0JBQXNDO1FBRnRDLDRCQUF1QixHQUF2Qix1QkFBdUIsQ0FBeUI7UUFDaEQscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUNsQyx1QkFBa0IsR0FBbEIsa0JBQWtCLENBQW9CO1FBRTlDLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxJQUFJLEdBQUcsRUFBMEMsQ0FBQztRQUMzRSxJQUFJLENBQUMsa0JBQWtCLEdBQUcsSUFBSSxHQUFHLEVBQXlELENBQUM7UUFDM0YsSUFBSSxDQUFDLG9CQUFvQixHQUFHLElBQUksR0FBRyxFQUEwQyxDQUFDO0lBQ2hGLENBQUM7SUFD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a0JBQWtCLENBQUMsS0FBSyxFQUFFLENBQUM7U0FDakM7SUFDSCxDQUFDO0lBQ0Q7O09BRUc7SUFDSyxVQUFVO1FBQ2hCLElBQUk7WUFDRiw4Q0FBOEM7WUFDOUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUM7U0FDNUQ7UUFBQyxXQUFNLEdBQUc7SUFDYixDQUFDOzs7WUE3TkYsVUFBVTs7OztZQVZGLHVCQUF1QjtZQUN2QixnQkFBZ0I7WUFFaEIsa0JBQWtCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgT3B0aW9uYWwgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgb2YsIGZyb20sIEVNUFRZIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IGV2ZXJ5LCBjb25jYXRNYXAsIHN3aXRjaE1hcCwgdGFrZSwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBBcHBPcHRpb25zIH0gZnJvbSAnQGdzcC1zeXMvcnRmLWNvbW1vbic7XHJcbmltcG9ydCB7IFJ1bnRpbWVGcmFtZXdvcmtTZXJ2aWNlIH0gZnJvbSAnLi9ydGYtc2VydmljZSc7XHJcbmltcG9ydCB7IE1lbnVTdGF0ZVNlcnZpY2UgfSBmcm9tICcuL21lbnUtc3RhdGUuc2VydmljZSc7XHJcbmltcG9ydCB7IFRBQl9FVkVOVCB9IGZyb20gJy4vdHlwZXMnO1xyXG5pbXBvcnQgeyBRdWVyeXN0cmluZ1NlcnZpY2UgfSBmcm9tICcuL3F1ZXJ5c3RyaW5nJztcclxuaW1wb3J0IHsgVUlEIH0gZnJvbSAnQGZhcnJpcy9kZXZraXQnO1xyXG5cclxuLyoqXHJcbiAqIOWvvOiIquS6i+S7tuacjeWKoVxyXG4gKiBAc2NvcGUgRm9ybU1vZHVsZVxyXG4gKi9cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgTmF2aWdhdGlvbkV2ZW50U2VydmljZSB7XHJcbiAgLyoqXHJcbiAgICog5YWz6Zet5ZCO5LqL5Lu25aSE55CG5ZmoXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBvbkNsb3NlZExpc3RlbmVyczogTWFwPHN0cmluZywgKG9wdGlvbnM/OiBBcHBPcHRpb25zKSA9PiB2b2lkPjtcclxuICAvKipcclxuICAgKiDlhbPpl63liY3lpITnkIblmahcclxuICAgKi9cclxuICBwcml2YXRlIG9uQ2xvc2luZ0xpc3RlbmVyczogTWFwPHN0cmluZywgKG9wdGlvbnM/OiBBcHBPcHRpb25zKSA9PiBPYnNlcnZhYmxlPGJvb2xlYW4+PjtcclxuICBwcml2YXRlIG9uVGFiU3dpdGNoTGlzdGVuZXJzOiBNYXA8c3RyaW5nLCAob3B0aW9ucz86IEFwcE9wdGlvbnMpID0+IHZvaWQ+O1xyXG4gIHByaXZhdGUgcGFyYW1zOiB7IFtwcm9wTmFtZTogc3RyaW5nXTogYW55IH07XHJcblxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJpdmF0ZSBydW50aW1lRnJhbWV3b3JrU2VydmljZTogUnVudGltZUZyYW1ld29ya1NlcnZpY2UsXHJcbiAgICBwcml2YXRlIG1lbnVTdGF0ZVNlcnZpY2U6IE1lbnVTdGF0ZVNlcnZpY2UsXHJcbiAgICBwcml2YXRlIHF1ZXJ5c3RyaW5nU2VydmljZTogUXVlcnlzdHJpbmdTZXJ2aWNlXHJcbiAgKSB7XHJcbiAgICB0aGlzLm9uQ2xvc2VkTGlzdGVuZXJzID0gbmV3IE1hcDxzdHJpbmcsIChvcHRpb25zPzogQXBwT3B0aW9ucykgPT4gdm9pZD4oKTtcclxuICAgIHRoaXMub25DbG9zaW5nTGlzdGVuZXJzID0gbmV3IE1hcDxzdHJpbmcsIChvcHRpb25zPzogQXBwT3B0aW9ucykgPT4gT2JzZXJ2YWJsZTxib29sZWFuPj4oKTtcclxuICAgIHRoaXMub25UYWJTd2l0Y2hMaXN0ZW5lcnMgPSBuZXcgTWFwPHN0cmluZywgKG9wdGlvbnM/OiBBcHBPcHRpb25zKSA9PiB2b2lkPigpO1xyXG4gIH1cclxuICBwcml2YXRlIGdldCBxdWVyeXN0cmluZ3MoKSB7XHJcbiAgICBjb25zdCBwYXJhbXMgPSB0aGlzLnF1ZXJ5c3RyaW5nU2VydmljZS5wYXJzZSh3aW5kb3cubG9jYXRpb24uaGFzaCk7XHJcbiAgICAvLyDkv67mraNmb3JtVG9rZW5cclxuICAgIGlmIChwYXJhbXMpIHtcclxuICAgICAgcGFyYW1zLmZvcm1Ub2tlbiA9IHRoaXMucnVudGltZUZyYW1ld29ya1NlcnZpY2UuZm9ybVRva2VuO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHBhcmFtcztcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5rOo5YaM5LqL5Lu2XHJcbiAgICovXHJcbiAgcHVibGljIHJlZ2lzdGVyRXZlbnQoKSB7XHJcbiAgICBjb25zdCBvcHRpb25zID0gdGhpcy5xdWVyeXN0cmluZ3M7XHJcbiAgICB0aGlzLnBhcmFtcyA9IG9wdGlvbnM7XHJcbiAgICAvLyDms6jlhozmoIfnrb7pobXliIfmjaLkuovku7ZcclxuICAgIHRoaXMucnVudGltZUZyYW1ld29ya1NlcnZpY2UuYWRkRXZlbnRMaXN0ZW5lcihUQUJfRVZFTlQub25UYWJTd2l0Y2hlZCwgKGUpID0+IHRoaXMuaGFuZGxlVGFiU3dpdGNoRXZlbnQoZSksIG9wdGlvbnMpO1xyXG4gICAgLy8g5rOo5YaM5qCH562+6aG15YWz6Zet5ZCO5LqL5Lu2XHJcbiAgICB0aGlzLnJ1bnRpbWVGcmFtZXdvcmtTZXJ2aWNlLmFkZEV2ZW50TGlzdGVuZXIoVEFCX0VWRU5ULm9uVGFiQ2xvc2VkLCAoZSkgPT4gdGhpcy5oYW5kbGVUYWJDbG9zZWRFdmVudChlKSwgb3B0aW9ucyk7XHJcbiAgICAvLyDms6jlhozmoIfnrb7pobXlhbPpl63liY3kuovku7ZcclxuICAgIHRoaXMucnVudGltZUZyYW1ld29ya1NlcnZpY2UuYWRkRXZlbnRMaXN0ZW5lcihUQUJfRVZFTlQub25UYWJDbG9zaW5nLCAoZSkgPT4gdGhpcy5oYW5kbGVUYWJDbG9zaW5nRXZlbnQoZSksIG9wdGlvbnMpO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDlpITnkIbmoIfnrb7pobXliIfmjaLkuovku7ZcclxuICAgKi9cclxuICBwcml2YXRlIGhhbmRsZVRhYlN3aXRjaEV2ZW50KGU6IGFueSkge1xyXG4gICAgaWYgKCFlKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIC8vIOmAieS4reeahOihqOWNleS4uuezu+e7n+ihqOWNle+8jOWPquiDvei/lOWbnmlk77yM5rKh5pyJdGFiSWRcclxuICAgIGNvbnN0IGV2ZW50VGFiSWQgPSBlLnRhYklkIHx8IGUuaWQgfHwgbnVsbDtcclxuICAgIGlmICghZXZlbnRUYWJJZCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBjb25zdCBvcHRpb25zID0gdGhpcy5wYXJhbXM7IC8vIHRoaXMucXVlcnlzdHJpbmdzO1xyXG4gICAgY29uc3QgdGFiSWQgPSBvcHRpb25zLnRhYklkIHx8IG9wdGlvbnMuZnVuY0lkIHx8IG9wdGlvbnMuYXBwSWQ7XHJcbiAgICBjb25zdCBtZW51U3RhdGUgPSB0aGlzLm1lbnVTdGF0ZVNlcnZpY2UuZ2V0TWVudVN0YXRlKGV2ZW50VGFiSWQpO1xyXG4gICAgaWYgKCEhdGFiSWQgJiYgdGFiSWQgPT09IGV2ZW50VGFiSWQgJiYgISFtZW51U3RhdGUgJiYgbWVudVN0YXRlLmxlbmd0aCA+IDApIHtcclxuICAgICAgdGhpcy5mb3JtUmVsb2FkKCk7XHJcbiAgICB9XHJcbiAgICB0aGlzLmZpcmVUYWJTd2l0Y2hFdmVudChlKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6Kem5Y+RdGFi5YiH5o2i5LqL5Lu2XHJcbiAgICogQHBhcmFtIGUgZVxyXG4gICAqL1xyXG4gIHByaXZhdGUgZmlyZVRhYlN3aXRjaEV2ZW50KGU6IGFueSkge1xyXG4gICAgaWYgKCF0aGlzLm9uVGFiU3dpdGNoTGlzdGVuZXJzIHx8IHRoaXMub25UYWJTd2l0Y2hMaXN0ZW5lcnMuc2l6ZSA8IDEpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgdGhpcy5vblRhYlN3aXRjaExpc3RlbmVycy5mb3JFYWNoKChoYW5kbGUsIGtleSwgbWFwKSA9PiB7XHJcbiAgICAgIGlmICh0eXBlb2YgaGFuZGxlID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgICAgaGFuZGxlKGUpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5qCH562+6aG15YWz6Zet5YmN5LqL5Lu2XHJcbiAgICovXHJcbiAgcHJpdmF0ZSBoYW5kbGVUYWJDbG9zaW5nRXZlbnQoZTogYW55KSB7XHJcbiAgICBpZiAoIWUpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgLy8g6KaB5YWz6Zet55qE6KGo5Y2V5Li657O757uf6KGo5Y2V77yM5Y+q6IO96L+U5ZueaWTvvIzmsqHmnIl0YWJJZFxyXG4gICAgY29uc3QgZXZlbnRUYWJJZCA9IGUudGFiSWQgfHwgZS5pZCB8fCBudWxsO1xyXG4gICAgY29uc3Qgb3B0aW9ucyA9IHRoaXMucGFyYW1zOyAvLyB0aGlzLnF1ZXJ5c3RyaW5ncztcclxuICAgIGNvbnN0IHRhYklkID0gb3B0aW9ucy50YWJJZCB8fCBvcHRpb25zLmZ1bmNJZCB8fCBvcHRpb25zLmFwcElkO1xyXG4gICAgaWYgKCEhZXZlbnRUYWJJZCAmJiAhIXRhYklkICYmIHRhYklkID09PSBldmVudFRhYklkKSB7XHJcbiAgICAgIHRoaXMuZmlyZVRhYkNsb3NpbmdFdmVudChlKS5zdWJzY3JpYmUocmVzdWx0ID0+IHtcclxuICAgICAgICBpZiAocmVzdWx0KSB7XHJcbiAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMucmVtb3ZlTWVudVN0YXRlKGV2ZW50VGFiSWQpLCA1MDApO1xyXG4gICAgICAgICAgY29uc3QgZm9ybUV2ZW50U2VydmljZXM6IE1hcDxzdHJpbmcsIGFueT4gPSB3aW5kb3dbJ2Zvcm1FdmVudFNlcnZpY2VzJ107XHJcbiAgICAgICAgICBpZiAoZm9ybUV2ZW50U2VydmljZXMuaGFzKGV2ZW50VGFiSWQpKSB7XHJcbiAgICAgICAgICAgIGZvcm1FdmVudFNlcnZpY2VzLmRlbGV0ZShldmVudFRhYklkKTtcclxuICAgICAgICAgICAgd2luZG93Wydmb3JtRXZlbnRTZXJ2aWNlcyddID0gZm9ybUV2ZW50U2VydmljZXM7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBpZiAoIShlICYmIGUuaGFzT3duUHJvcGVydHkoJ3Rva2VuJykpKSB7XHJcbiAgICAgICAgICAgIGUgPSBPYmplY3QuYXNzaWduKHt9LCBlLCB7IHRva2VuOiBvcHRpb25zLmZvcm1Ub2tlbiB9KTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIHRoaXMucnVudGltZUZyYW1ld29ya1NlcnZpY2UuY2xvc2VNZW51KGUpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOinpuWPkeWFs+mXreWJjeS6i+S7tlxyXG4gICAqL1xyXG4gIHByaXZhdGUgZmlyZVRhYkNsb3NpbmdFdmVudChlOiBhbnkpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcclxuICAgIGlmICghdGhpcy5vbkNsb3NpbmdMaXN0ZW5lcnMgfHwgdGhpcy5vbkNsb3NpbmdMaXN0ZW5lcnMuc2l6ZSA8IDEpIHtcclxuICAgICAgcmV0dXJuIG9mKHRydWUpO1xyXG4gICAgfVxyXG4gICAgY29uc3QgbGlzdGVuZXJzID0gdGhpcy5vbkNsb3NpbmdMaXN0ZW5lcnMudmFsdWVzKCk7XHJcbiAgICBjb25zdCByZXN1bHQkID0gZnJvbShsaXN0ZW5lcnMpO1xyXG4gICAgLy8g55So5oi35ouS57udXHJcbiAgICBsZXQgdXNlclJlamVjdGVkID0gZmFsc2U7XHJcbiAgICByZXR1cm4gcmVzdWx0JC5waXBlKFxyXG4gICAgICBjb25jYXRNYXAoaGFuZGxlID0+IHtcclxuICAgICAgICBpZiAodXNlclJlamVjdGVkKSB7XHJcbiAgICAgICAgICByZXR1cm4gRU1QVFk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBoYW5kbGUoZSkucGlwZShcclxuICAgICAgICAgIHRha2UoMSksXHJcbiAgICAgICAgICB0YXAocmVzdWx0ID0+IHVzZXJSZWplY3RlZCA9ICFyZXN1bHQpLFxyXG4gICAgICAgICAgc3dpdGNoTWFwKHJlc3VsdCA9PiBvZihyZXN1bHQpKVxyXG4gICAgICAgICk7XHJcbiAgICAgIH0pLFxyXG4gICAgICBldmVyeShyZXN1bHQgPT4gcmVzdWx0KVxyXG4gICAgKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5qCH562+6aG15YWz6Zet5ZCO5LqL5Lu2XHJcbiAgICovXHJcbiAgcHJpdmF0ZSBoYW5kbGVUYWJDbG9zZWRFdmVudChlOiBhbnkpIHtcclxuICAgIGlmICghZSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBjb25zdCBvcHRpb25zID0gdGhpcy5wYXJhbXM7IC8vIHRoaXMucXVlcnlzdHJpbmdzO1xyXG4gICAgY29uc3QgdGFiSWQgPSBvcHRpb25zLnRhYklkIHx8IG9wdGlvbnMuZnVuY0lkIHx8IG9wdGlvbnMuYXBwSWQ7XHJcbiAgICBjb25zdCBldmVudFRhYklkID0gZS50YWJJZCB8fCBlLmlkIHx8IG51bGw7XHJcbiAgICBpZiAodGFiSWQgPT09IGV2ZW50VGFiSWQpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgY29uc3QgbWVudVN0YXRlID0gdGhpcy5tZW51U3RhdGVTZXJ2aWNlLmdldE1lbnVTdGF0ZSh0YWJJZCwgZXZlbnRUYWJJZCk7XHJcbiAgICBpZiAoISFldmVudFRhYklkICYmICEhbWVudVN0YXRlICYmIG1lbnVTdGF0ZS5sZW5ndGggPiAwKSB7XHJcbiAgICAgIHRoaXMucmVtb3ZlTWVudVN0YXRlKGV2ZW50VGFiSWQpO1xyXG4gICAgICB0aGlzLmZvcm1SZWxvYWQoKTtcclxuICAgIH1cclxuICAgIHRoaXMuZmlyZVRhYkNsb3NlZEV2ZW50KGUpO1xyXG4gIH1cclxuICBwcml2YXRlIHJlbW92ZU1lbnVTdGF0ZSh0YWJJZDogc3RyaW5nKSB7XHJcbiAgICBpZiAodGhpc1snY29udGV4dCddKSB7XHJcbiAgICAgIHRoaXMubWVudVN0YXRlU2VydmljZS5yZW1vdmVNZW51KHRhYklkKTtcclxuICAgIH1cclxuICB9XHJcbiAgLyoqXHJcbiAgICog6Kem5Y+R5YWz6Zet5ZCO5LqL5Lu2XHJcbiAgICogQHBhcmFtIGUgZXZlbnRcclxuICAgKi9cclxuICBwcml2YXRlIGZpcmVUYWJDbG9zZWRFdmVudChlOiBhbnkpIHtcclxuICAgIGlmICghdGhpcy5vbkNsb3NlZExpc3RlbmVycyB8fCB0aGlzLm9uQ2xvc2VkTGlzdGVuZXJzLnNpemUgPCAxKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIHRoaXMub25DbG9zZWRMaXN0ZW5lcnMuZm9yRWFjaCgoaGFuZGxlLCBrZXksIG1hcCkgPT4ge1xyXG4gICAgICBpZiAodHlwZW9mIGhhbmRsZSA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICAgIGhhbmRsZShlKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG4gIC8vICNlbmRyZWdpb25cclxuICAvKipcclxuICAgKiDms6jlhozkuovku7bnm5HlkKzlmahcclxuICAgKiBAcGFyYW0gZXZlbnRUeXBlIOS6i+S7tuexu+WeiyBvblRhYkNsb3NlZFxyXG4gICAqIEBwYXJhbSBoYW5kbGVyIOWkhOeQhuWZqFxyXG4gICAqL1xyXG4gIHB1YmxpYyBhZGRFdmVudExpc3RlbmVyKGV2ZW50VHlwZTogc3RyaW5nLCBoYW5kbGVyOiAob3B0aW9uczogQXBwT3B0aW9ucykgPT4gYW55KTogc3RyaW5nIHtcclxuICAgIGNvbnN0IGtleSA9IFVJRC5jcmVhdGUoKTtcclxuICAgIGlmIChldmVudFR5cGUgPT09IFRBQl9FVkVOVC5vblRhYkNsb3NlZCkge1xyXG4gICAgICB0aGlzLm9uQ2xvc2VkTGlzdGVuZXJzLnNldChrZXksIGhhbmRsZXIpO1xyXG4gICAgICByZXR1cm4ga2V5O1xyXG4gICAgfSBlbHNlIGlmIChldmVudFR5cGUgPT09IFRBQl9FVkVOVC5vblRhYkNsb3NpbmcpIHtcclxuICAgICAgdGhpcy5vbkNsb3NpbmdMaXN0ZW5lcnMuc2V0KGtleSwgaGFuZGxlcik7XHJcbiAgICAgIHJldHVybiBrZXk7XHJcbiAgICB9IGVsc2UgaWYgKGV2ZW50VHlwZSA9PT0gVEFCX0VWRU5ULm9uVGFiU3dpdGNoZWQpIHtcclxuICAgICAgdGhpcy5vblRhYlN3aXRjaExpc3RlbmVycy5zZXQoa2V5LCBoYW5kbGVyKTtcclxuICAgICAgcmV0dXJuIGtleTtcclxuICAgIH1cclxuICAgIHJldHVybiBudWxsO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDnp7vpmaTkuovku7bnm5HlkKzlmahcclxuICAgKiBAcGFyYW0gZXZlbnRUeXBlIOS6i+S7tuexu+Wei1xyXG4gICAqIEBwYXJhbSBrZXkg5LqL5Lu25qCH6K+GXHJcbiAgICovXHJcbiAgcHVibGljIHJlbW92ZUV2ZW50TGlzdGVuZXIoZXZlbnRUeXBlOiBzdHJpbmcsIGtleTogc3RyaW5nKSB7XHJcbiAgICBpZiAoZXZlbnRUeXBlID09PSBUQUJfRVZFTlQub25UYWJDbG9zZWQpIHtcclxuICAgICAgcmV0dXJuIHRoaXMub25DbG9zZWRMaXN0ZW5lcnMuZGVsZXRlKGtleSk7XHJcbiAgICB9IGVsc2UgaWYgKGV2ZW50VHlwZSA9PT0gVEFCX0VWRU5ULm9uVGFiQ2xvc2luZykge1xyXG4gICAgICByZXR1cm4gdGhpcy5vbkNsb3NpbmdMaXN0ZW5lcnMuZGVsZXRlKGtleSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gZmFsc2U7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOa4heepuuS6i+S7tuebkeWQrOWZqFxyXG4gICAqIEBwYXJhbSBldmVudFR5cGUg5LqL5Lu257G75Z6LXHJcbiAgICovXHJcbiAgcHVibGljIGNsZWFyRXZlbnRMaXN0ZW5lcihldmVudFR5cGU6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgaWYgKGV2ZW50VHlwZSA9PT0gVEFCX0VWRU5ULm9uVGFiQ2xvc2VkKSB7XHJcbiAgICAgIHRoaXMub25DbG9zZWRMaXN0ZW5lcnMuY2xlYXIoKTtcclxuICAgIH0gZWxzZSBpZiAoZXZlbnRUeXBlID09PSBUQUJfRVZFTlQub25UYWJDbG9zaW5nKSB7XHJcbiAgICAgIHRoaXMub25DbG9zaW5nTGlzdGVuZXJzLmNsZWFyKCk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOWIt+aWsOe7hOS7tuaVsOaNrlxyXG4gICAqL1xyXG4gIHByaXZhdGUgZm9ybVJlbG9hZCgpIHtcclxuICAgIHRyeSB7XHJcbiAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogbm8tc3RyaW5nLWxpdGVyYWxcclxuICAgICAgdGhpc1snY29udGV4dCddWydmcmFtZUNvbnRleHQnXVsnYXBwQ29udGV4dCddWydyZWZyZXNoJ10oKTtcclxuICAgIH0gY2F0Y2ggeyB9XHJcbiAgfVxyXG59XHJcbiJdfQ==