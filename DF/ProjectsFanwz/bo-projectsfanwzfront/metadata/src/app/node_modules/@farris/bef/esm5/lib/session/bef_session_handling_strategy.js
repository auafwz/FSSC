/**
 * @fileoverview added by tsickle
 * Generated from: lib/session/bef_session_handling_strategy.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
/*
 * @Author: Witt
 * @Date: 2018-10-11 20:32:02
 * @Last Modified by: Witt
 * @Last Modified time: 2020-03-03 16:46:39
 */
import { HttpHeaders } from '@angular/common/http';
import { of } from 'rxjs';
import { tap } from 'rxjs/operators';
import { HttpHeaderUtil } from '../utils/index';
import { HttpService } from '../http_service';
import { AppContext } from '@farris/devkit';
/**
 * BefSession处理策略类
 * @abstract
 */
var /**
 * BefSession处理策略类
 * @abstract
 */
BefSessionHandlingStrategy = /** @class */ (function () {
    /**
     * 构造函数
     */
    function BefSessionHandlingStrategy(storageStrategy, frmSessionService) {
        this.storageStrategy = storageStrategy;
        this.frmSessionService = frmSessionService;
    }
    /**
     * 框架SessionId（用户的或者功能菜单的）
     */
    /**
     * 框架SessionId（用户的或者功能菜单的）
     * @protected
     * @param {?=} runtimeContext
     * @return {?}
     */
    BefSessionHandlingStrategy.prototype.getFrmSessionId = /**
     * 框架SessionId（用户的或者功能菜单的）
     * @protected
     * @param {?=} runtimeContext
     * @return {?}
     */
    function (runtimeContext) {
        return this.frmSessionService.getCurrentSessionId(runtimeContext);
    };
    Object.defineProperty(BefSessionHandlingStrategy.prototype, "frmSessionId", {
        get: /**
         * @protected
         * @return {?}
         */
        function () {
            return this.frmSessionService.getCurrentSessionId();
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 获取框架SessionId
     */
    /**
     * 获取框架SessionId
     * @param {?=} runtimeContext
     * @return {?}
     */
    BefSessionHandlingStrategy.prototype.getFrameworkSessionId = /**
     * 获取框架SessionId
     * @param {?=} runtimeContext
     * @return {?}
     */
    function (runtimeContext) {
        return this.getFrmSessionId(runtimeContext);
    };
    /**
     * 从缓存中获取BeSession
     */
    /**
     * 从缓存中获取BeSession
     * @protected
     * @param {?=} runtimeContext
     * @return {?}
     */
    BefSessionHandlingStrategy.prototype.getSessionIdFromStorage = /**
     * 从缓存中获取BeSession
     * @protected
     * @param {?=} runtimeContext
     * @return {?}
     */
    function (runtimeContext) {
        /** @type {?} */
        var sessionStorageKey = this.getSessionStorageKey(runtimeContext);
        /** @type {?} */
        var beSessionId = this.storageStrategy.getItem(sessionStorageKey);
        return beSessionId;
    };
    return BefSessionHandlingStrategy;
}());
if (false) {
    /**
     * 存储策略
     * @type {?}
     * @protected
     */
    BefSessionHandlingStrategy.prototype.storageStrategy;
    /**
     * 框架Session服务
     * @type {?}
     * @protected
     */
    BefSessionHandlingStrategy.prototype.frmSessionService;
    /**
     * 获取SessionId
     * @abstract
     * @return {?}
     */
    BefSessionHandlingStrategy.prototype.getSessionId = function () { };
    /**
     * @abstract
     * @param {?} sessionId
     * @return {?}
     */
    BefSessionHandlingStrategy.prototype.setSessionId = function (sessionId) { };
    /**
     * @abstract
     * @return {?}
     */
    BefSessionHandlingStrategy.prototype.clearSessionId = function () { };
    /**
     * @abstract
     * @param {?} headers
     * @param {?=} runtimeContext
     * @return {?}
     */
    BefSessionHandlingStrategy.prototype.extendRequestHeaders = function (headers, runtimeContext) { };
    /**
     * @abstract
     * @param {?} headers
     * @return {?}
     */
    BefSessionHandlingStrategy.prototype.handleReponseHeaders = function (headers) { };
    /**
     * @abstract
     * @protected
     * @param {?=} runtimeContext
     * @return {?}
     */
    BefSessionHandlingStrategy.prototype.getSessionStorageKey = function (runtimeContext) { };
}
/**
 * 隔离的BeSession处理策略（此策略必须保证injector为null的情况下正常影讯性）
 * \@summary
 * ----------------------------------------
 * 处理原则：
 * 1、通过createSession创建；
 * 2、每个Repository拥有独立的BeSession；
 * 3、访问BE的EAPI时，通过header里的SessionId传递；
 * ----------------------------------------
 * 兼容性考虑：
 * 1、有产品部直接new BeSessionService()，没有传递
 */
var /**
 * 隔离的BeSession处理策略（此策略必须保证injector为null的情况下正常影讯性）
 * \@summary
 * ----------------------------------------
 * 处理原则：
 * 1、通过createSession创建；
 * 2、每个Repository拥有独立的BeSession；
 * 3、访问BE的EAPI时，通过header里的SessionId传递；
 * ----------------------------------------
 * 兼容性考虑：
 * 1、有产品部直接new BeSessionService()，没有传递
 */
BefSeparatedSessionHandlingStrategy = /** @class */ (function (_super) {
    tslib_1.__extends(BefSeparatedSessionHandlingStrategy, _super);
    /**
     * 构造函数
     */
    function BefSeparatedSessionHandlingStrategy(storageStrategy, frmSessionService, httpClient, beBaseUri, injector) {
        var _this = _super.call(this, storageStrategy, frmSessionService) || this;
        _this.beSessionUri = beBaseUri;
        _this.httpClient = httpClient;
        _this.httpService = new HttpService(_this.httpClient);
        _this.injector = injector;
        return _this;
    }
    /**
     * 获取BeSessionId
     */
    /**
     * 获取BeSessionId
     * @return {?}
     */
    BefSeparatedSessionHandlingStrategy.prototype.getSessionId = /**
     * 获取BeSessionId
     * @return {?}
     */
    function () {
        /** @type {?} */
        var beSessionId = this.getSessionIdFromStorage();
        if (beSessionId) {
            return of(beSessionId);
        }
        return this.createSession();
    };
    /**
     * 设置BeSessionId
     */
    /**
     * 设置BeSessionId
     * @param {?} sessionId
     * @return {?}
     */
    BefSeparatedSessionHandlingStrategy.prototype.setSessionId = /**
     * 设置BeSessionId
     * @param {?} sessionId
     * @return {?}
     */
    function (sessionId) {
        /** @type {?} */
        var sessionKey = this.getSessionStorageKey();
        this.storageStrategy.setItem(sessionKey, sessionId);
    };
    /**
     * 清空Sessionid
     */
    /**
     * 清空Sessionid
     * @return {?}
     */
    BefSeparatedSessionHandlingStrategy.prototype.clearSessionId = /**
     * 清空Sessionid
     * @return {?}
     */
    function () {
        /** @type {?} */
        var sessionKey = this.getSessionStorageKey();
        // this.storageStrategy.removeItem(sessionKey);
        this.storageStrategy.clear(this.frmSessionId, sessionKey);
    };
    /**
     * 扩展Session相关头信息
     */
    /**
     * 扩展Session相关头信息
     * @param {?} headers
     * @param {?=} runtimeContext
     * @return {?}
     */
    BefSeparatedSessionHandlingStrategy.prototype.extendRequestHeaders = /**
     * 扩展Session相关头信息
     * @param {?} headers
     * @param {?=} runtimeContext
     * @return {?}
     */
    function (headers, runtimeContext) {
        /** @type {?} */
        var frmSessionId = this.getFrameworkSessionId(runtimeContext);
        /** @type {?} */
        var beSessionId = this.getSessionIdFromStorage(runtimeContext);
        headers = HttpHeaderUtil.appendCafRuntimeCommonVariable(headers, frmSessionId);
        if (beSessionId) {
            headers = HttpHeaderUtil.appendCafRuntimeContext(headers, beSessionId);
            headers = HttpHeaderUtil.appendSessionId(headers, beSessionId);
        }
        // const appContext = this.injector.get<AppContext>(AppContext, null);
        //if (appContext) {
        // const appId = appContext.ApplicationId;
        headers = HttpHeaderUtil.appendFuncInstId(headers, this.beSessionUri);
        // }
        // headers = HttpHeaderUtil.appendRequireMessage(headers, true);
        return headers;
    };
    /**
     * 处理服务器端返回的headers
     */
    /**
     * 处理服务器端返回的headers
     * @param {?} headers
     * @return {?}
     */
    BefSeparatedSessionHandlingStrategy.prototype.handleReponseHeaders = /**
     * 处理服务器端返回的headers
     * @param {?} headers
     * @return {?}
     */
    function (headers) {
        console.log(headers);
    };
    /**
     * 创建BeSessionId
     */
    /**
     * 创建BeSessionId
     * @return {?}
     */
    BefSeparatedSessionHandlingStrategy.prototype.createSession = /**
     * 创建BeSessionId
     * @return {?}
     */
    function () {
        var _this = this;
        /** @type {?} */
        var params = {
            responseType: 'text'
        };
        if (!!this.frmSessionId) {
            /** @type {?} */
            var appContext = this.injector.get(AppContext, null);
            params.headers = new HttpHeaders({ SessionId: this.frmSessionId });
            params.headers = params.headers.append('X-CAF-Runtime-CommonVariable', this.frmSessionId);
            //if (appContext) {
            // const appId = appContext.ApplicationId;
            params.headers = params.headers.append('Func-Inst-Id', this.beSessionUri);
            //}
            params.headers = HttpHeaderUtil.toJson(params.headers);
        }
        return this.httpService.request('POST', this.beSessionUri, params).pipe(tap((/**
         * @param {?} beSessionId
         * @return {?}
         */
        function (beSessionId) {
            _this.setSessionId(beSessionId);
        })));
    };
    /**
     * @return {?}
     */
    BefSeparatedSessionHandlingStrategy.prototype.extendHttpHeader = /**
     * @return {?}
     */
    function () {
    };
    /**
     * 获取某个Repository对应的BeSession的唯一key
     * @summary
     * 1、在使用独立BeSession的组合表单中，需要通过BeSessionUri隔离；
     * 2、在Debug模式下，FrmSessionId=UserSessionid，如果只用它作key，
     */
    /**
     * 获取某个Repository对应的BeSession的唯一key
     * \@summary
     * 1、在使用独立BeSession的组合表单中，需要通过BeSessionUri隔离；
     * 2、在Debug模式下，FrmSessionId=UserSessionid，如果只用它作key，
     * @protected
     * @param {?=} runtimeContext
     * @return {?}
     */
    BefSeparatedSessionHandlingStrategy.prototype.getSessionStorageKey = /**
     * 获取某个Repository对应的BeSession的唯一key
     * \@summary
     * 1、在使用独立BeSession的组合表单中，需要通过BeSessionUri隔离；
     * 2、在Debug模式下，FrmSessionId=UserSessionid，如果只用它作key，
     * @protected
     * @param {?=} runtimeContext
     * @return {?}
     */
    function (runtimeContext) {
        /** @type {?} */
        var sessionId = null;
        if (runtimeContext) {
            sessionId = this.getFrameworkSessionId(runtimeContext);
        }
        else {
            sessionId = this.frmSessionId;
        }
        return sessionId + "_" + this.beSessionUri;
    };
    return BefSeparatedSessionHandlingStrategy;
}(BefSessionHandlingStrategy));
if (false) {
    /**
     * @type {?}
     * @private
     */
    BefSeparatedSessionHandlingStrategy.prototype.injector;
    /**
     * 创建Session的的EAPI地址
     * @type {?}
     * @private
     */
    BefSeparatedSessionHandlingStrategy.prototype.beSessionUri;
    /**
     * httpClient
     * @type {?}
     * @private
     */
    BefSeparatedSessionHandlingStrategy.prototype.httpClient;
    /**
     * @type {?}
     * @private
     */
    BefSeparatedSessionHandlingStrategy.prototype.httpService;
}
var BefUnifiedSessionHandlingStrategy = /** @class */ (function (_super) {
    tslib_1.__extends(BefUnifiedSessionHandlingStrategy, _super);
    /**
     * 构造函数
     */
    function BefUnifiedSessionHandlingStrategy(storageStrategy, frmSessionService, beBaseUri, injector) {
        var _this = _super.call(this, storageStrategy, frmSessionService) || this;
        _this.beSessionUri = beBaseUri;
        _this.injector = injector;
        return _this;
    }
    /**
     * @return {?}
     */
    BefUnifiedSessionHandlingStrategy.prototype.getSessionId = /**
     * @return {?}
     */
    function () {
        /** @type {?} */
        var sessionKey = this.getSessionStorageKey();
        /** @type {?} */
        var sessionId = this.storageStrategy.getItem(sessionKey);
        return of(sessionId);
        // return of(null);
    };
    /**
     * 设置BeSessionId
     */
    /**
     * 设置BeSessionId
     * @param {?} sessionId
     * @return {?}
     */
    BefUnifiedSessionHandlingStrategy.prototype.setSessionId = /**
     * 设置BeSessionId
     * @param {?} sessionId
     * @return {?}
     */
    function (sessionId) {
        /** @type {?} */
        var sessionKey = this.getSessionStorageKey();
        this.storageStrategy.setItem(sessionKey, sessionId);
    };
    /**
     * 清空Sessionid
     */
    /**
     * 清空Sessionid
     * @return {?}
     */
    BefUnifiedSessionHandlingStrategy.prototype.clearSessionId = /**
     * 清空Sessionid
     * @return {?}
     */
    function () {
        /** @type {?} */
        var sessionKey = this.getSessionStorageKey();
        this.storageStrategy.removeItem(sessionKey);
    };
    /**
     * 扩展Session相关头信息
     */
    /**
     * 扩展Session相关头信息
     * @param {?} headers
     * @param {?=} runtimeContext
     * @return {?}
     */
    BefUnifiedSessionHandlingStrategy.prototype.extendRequestHeaders = /**
     * 扩展Session相关头信息
     * @param {?} headers
     * @param {?=} runtimeContext
     * @return {?}
     */
    function (headers, runtimeContext) {
        /** @type {?} */
        var frmSessionId = this.getFrameworkSessionId(runtimeContext);
        /** @type {?} */
        var beSessionId = this.getSessionIdFromStorage(runtimeContext);
        // headers = HttpHeaderUtil.appendRequireMessage(headers, true);
        /** @type {?} */
        var appContext = this.injector.get(AppContext, null);
        if (appContext) {
            /** @type {?} */
            var token = appContext.Token;
            headers = HttpHeaderUtil.appendFuncInstId(headers, token);
        }
        headers = HttpHeaderUtil.appendCafRuntimeCommonVariable(headers, frmSessionId);
        if (beSessionId) {
            headers = HttpHeaderUtil.appendCafRuntimeContext(headers, beSessionId);
        }
        return headers;
    };
    /**
     * 处理服务器端返回的headers
     */
    /**
     * 处理服务器端返回的headers
     * @param {?} headers
     * @return {?}
     */
    BefUnifiedSessionHandlingStrategy.prototype.handleReponseHeaders = /**
     * 处理服务器端返回的headers
     * @param {?} headers
     * @return {?}
     */
    function (headers) {
        console.log(headers);
    };
    /**
     * 获取某个Repository对应的BeSession的唯一key
     * @summary
     */
    /**
     * 获取某个Repository对应的BeSession的唯一key
     * \@summary
     * @protected
     * @param {?=} runtimeContext
     * @return {?}
     */
    BefUnifiedSessionHandlingStrategy.prototype.getSessionStorageKey = /**
     * 获取某个Repository对应的BeSession的唯一key
     * \@summary
     * @protected
     * @param {?=} runtimeContext
     * @return {?}
     */
    function (runtimeContext) {
        // const isDebug = false;
        // if (isDebug) {
        //   return `${this.frmSessionId}_${this.beSessionUri}`;
        // } else {
        //   return this.frmSessionId;
        // }
        /** @type {?} */
        var sessionId = null;
        if (runtimeContext) {
            sessionId = this.getFrameworkSessionId(runtimeContext);
        }
        else {
            sessionId = this.frmSessionId;
        }
        return sessionId + "_" + this.beSessionUri;
    };
    return BefUnifiedSessionHandlingStrategy;
}(BefSessionHandlingStrategy));
if (false) {
    /**
     * 创建Session的的EAPI地址
     * @type {?}
     * @private
     */
    BefUnifiedSessionHandlingStrategy.prototype.beSessionUri;
    /**
     * @type {?}
     * @private
     */
    BefUnifiedSessionHandlingStrategy.prototype.injector;
}
export { BefSessionHandlingStrategy, BefSeparatedSessionHandlingStrategy, BefUnifiedSessionHandlingStrategy };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmVmX3Nlc3Npb25faGFuZGxpbmdfc3RyYXRlZ3kuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2JlZi8iLCJzb3VyY2VzIjpbImxpYi9zZXNzaW9uL2JlZl9zZXNzaW9uX2hhbmRsaW5nX3N0cmF0ZWd5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztBQU9BLE9BQU8sRUFBYyxXQUFXLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUMvRCxPQUFPLEVBQWMsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3RDLE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUVyQyxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFaEQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBRTlDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQzs7Ozs7QUFJNUM7Ozs7O0lBcUJFOztPQUVHO0lBQ0gsb0NBQVksZUFBeUMsRUFBRSxpQkFBMEM7UUFDL0YsSUFBSSxDQUFDLGVBQWUsR0FBRyxlQUFlLENBQUM7UUFDdkMsSUFBSSxDQUFDLGlCQUFpQixHQUFHLGlCQUFpQixDQUFDO0lBQzdDLENBQUM7SUFoQkQ7O09BRUc7Ozs7Ozs7SUFDTyxvREFBZTs7Ozs7O0lBQXpCLFVBQTBCLGNBQW9CO1FBQzVDLE9BQU8sSUFBSSxDQUFDLGlCQUFpQixDQUFDLG1CQUFtQixDQUFDLGNBQWMsQ0FBQyxDQUFDO0lBQ3BFLENBQUM7SUFDRCxzQkFBYyxvREFBWTs7Ozs7UUFBMUI7WUFDRSxPQUFPLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxtQkFBbUIsRUFBRSxDQUFDO1FBQ3RELENBQUM7OztPQUFBO0lBb0JEOztPQUVHOzs7Ozs7SUFDSSwwREFBcUI7Ozs7O0lBQTVCLFVBQTZCLGNBQW9CO1FBQy9DLE9BQU8sSUFBSSxDQUFDLGVBQWUsQ0FBQyxjQUFjLENBQUMsQ0FBQztJQUM5QyxD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QUFTLEdBQUcsSUFBSSxDQUFDLHFCQUFxQixDQUFDLGNBQWMsQ0FBQyxDQUFDO1NBQ3hEO2FBQU07WUFDTCxTQUFTLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQztTQUMvQjtRQUNELE9BQVUsU0FBUyxTQUFJLElBQUksQ0FBQyxZQUFjLENBQUM7SUFDN0MsQ0FBQztJQUNILHdDQUFDO0FBQUQsQ0FBQyxBQXhGRCxDQUFnRCwwQkFBMEIsR0F3RnpFOzs7Ozs7O0lBbkZDLHlEQUE2Qjs7Ozs7SUFDN0IscURBQTJCOztBQW9GN0IsT0FBTyxFQUFFLDBCQUEwQixFQUFFLG1DQUFtQyxFQUFFLGlDQUFpQyxFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxyXG4gKiBAQXV0aG9yOiBXaXR0XHJcbiAqIEBEYXRlOiAyMDE4LTEwLTExIDIwOjMyOjAyXHJcbiAqIEBMYXN0IE1vZGlmaWVkIGJ5OiBXaXR0XHJcbiAqIEBMYXN0IE1vZGlmaWVkIHRpbWU6IDIwMjAtMDMtMDMgMTY6NDY6MzlcclxuICovXHJcblxyXG5pbXBvcnQgeyBIdHRwQ2xpZW50LCBIdHRwSGVhZGVycyB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcclxuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgb2YgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBGcmFtZXdvcmtTZXNzaW9uU2VydmljZSB9IGZyb20gJy4uL2ZyYW1ld29ya19zZXNzaW9uX3NlcnZpY2UnO1xyXG5pbXBvcnQgeyBIdHRwSGVhZGVyVXRpbCB9IGZyb20gJy4uL3V0aWxzL2luZGV4JztcclxuaW1wb3J0IHsgQmVTZXNzaW9uU3RvcmFnZVN0cmF0ZWd5IH0gZnJvbSAnLi9iZWZfc2Vzc2lvbl9zdG9yYWdlX3N0cmF0ZWd5JztcclxuaW1wb3J0IHsgSHR0cFNlcnZpY2UgfSBmcm9tICcuLi9odHRwX3NlcnZpY2UnO1xyXG5pbXBvcnQgeyBJbmplY3RvciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBBcHBDb250ZXh0IH0gZnJvbSAnQGZhcnJpcy9kZXZraXQnO1xyXG4vKipcclxuICogQmVmU2Vzc2lvbuWkhOeQhuetlueVpeexu1xyXG4gKi9cclxuYWJzdHJhY3QgY2xhc3MgQmVmU2Vzc2lvbkhhbmRsaW5nU3RyYXRlZ3kge1xyXG5cclxuICAvKipcclxuICAgKiDlrZjlgqjnrZbnlaVcclxuICAgKi9cclxuICBwcm90ZWN0ZWQgc3RvcmFnZVN0cmF0ZWd5OiBCZVNlc3Npb25TdG9yYWdlU3RyYXRlZ3k7XHJcblxyXG4gIC8qKlxyXG4gICAqIOahhuaetlNlc3Npb27mnI3liqFcclxuICAgKi9cclxuICBwcm90ZWN0ZWQgZnJtU2Vzc2lvblNlcnZpY2U6IEZyYW1ld29ya1Nlc3Npb25TZXJ2aWNlO1xyXG4gIC8qKlxyXG4gICAqIOahhuaetlNlc3Npb25JZO+8iOeUqOaIt+eahOaIluiAheWKn+iDveiPnOWNleeahO+8iVxyXG4gICAqL1xyXG4gIHByb3RlY3RlZCBnZXRGcm1TZXNzaW9uSWQocnVudGltZUNvbnRleHQ/OiBhbnkpOiBzdHJpbmcge1xyXG4gICAgcmV0dXJuIHRoaXMuZnJtU2Vzc2lvblNlcnZpY2UuZ2V0Q3VycmVudFNlc3Npb25JZChydW50aW1lQ29udGV4dCk7XHJcbiAgfVxyXG4gIHByb3RlY3RlZCBnZXQgZnJtU2Vzc2lvbklkKCk6IHN0cmluZyB7XHJcbiAgICByZXR1cm4gdGhpcy5mcm1TZXNzaW9uU2VydmljZS5nZXRDdXJyZW50U2Vzc2lvbklkKCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmnoTpgKDlh73mlbBcclxuICAgKi9cclxuICBjb25zdHJ1Y3RvcihzdG9yYWdlU3RyYXRlZ3k6IEJlU2Vzc2lvblN0b3JhZ2VTdHJhdGVneSwgZnJtU2Vzc2lvblNlcnZpY2U6IEZyYW1ld29ya1Nlc3Npb25TZXJ2aWNlKSB7XHJcbiAgICB0aGlzLnN0b3JhZ2VTdHJhdGVneSA9IHN0b3JhZ2VTdHJhdGVneTtcclxuICAgIHRoaXMuZnJtU2Vzc2lvblNlcnZpY2UgPSBmcm1TZXNzaW9uU2VydmljZTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPllNlc3Npb25JZFxyXG4gICAqL1xyXG4gIHB1YmxpYyBhYnN0cmFjdCBnZXRTZXNzaW9uSWQoKTogT2JzZXJ2YWJsZTxzdHJpbmc+O1xyXG4gIHB1YmxpYyBhYnN0cmFjdCBzZXRTZXNzaW9uSWQoc2Vzc2lvbklkKTogdm9pZDtcclxuICBwdWJsaWMgYWJzdHJhY3QgY2xlYXJTZXNzaW9uSWQoKTogdm9pZDtcclxuICBwdWJsaWMgYWJzdHJhY3QgZXh0ZW5kUmVxdWVzdEhlYWRlcnMoaGVhZGVyczogSHR0cEhlYWRlcnMsIHJ1bnRpbWVDb250ZXh0PzogYW55KTogSHR0cEhlYWRlcnM7XHJcbiAgcHVibGljIGFic3RyYWN0IGhhbmRsZVJlcG9uc2VIZWFkZXJzKGhlYWRlcnM6IEh0dHBIZWFkZXJzKTogdm9pZDtcclxuICBwcm90ZWN0ZWQgYWJzdHJhY3QgZ2V0U2Vzc2lvblN0b3JhZ2VLZXkocnVudGltZUNvbnRleHQ/OiBhbnkpOiBzdHJpbmc7XHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluahhuaetlNlc3Npb25JZFxyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXRGcmFtZXdvcmtTZXNzaW9uSWQocnVudGltZUNvbnRleHQ/OiBhbnkpIHtcclxuICAgIHJldHVybiB0aGlzLmdldEZybVNlc3Npb25JZChydW50aW1lQ29udGV4dCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDku47nvJPlrZjkuK3ojrflj5ZCZVNlc3Npb25cclxuICAgKi9cclxuICBwcm90ZWN0ZWQgZ2V0U2Vzc2lvbklkRnJvbVN0b3JhZ2UocnVudGltZUNvbnRleHQ/OiBhbnkpIHtcclxuICAgIGNvbnN0IHNlc3Npb25TdG9yYWdlS2V5ID0gdGhpcy5nZXRTZXNzaW9uU3RvcmFnZUtleShydW50aW1lQ29udGV4dCk7XHJcbiAgICBjb25zdCBiZVNlc3Npb25JZCA9IHRoaXMuc3RvcmFnZVN0cmF0ZWd5LmdldEl0ZW0oc2Vzc2lvblN0b3JhZ2VLZXkpO1xyXG4gICAgcmV0dXJuIGJlU2Vzc2lvbklkO1xyXG4gIH1cclxufVxyXG5cclxuLyoqXHJcbiAqIOmalOemu+eahEJlU2Vzc2lvbuWkhOeQhuetlueVpe+8iOatpOetlueVpeW/hemhu+S/neivgWluamVjdG9y5Li6bnVsbOeahOaDheWGteS4i+ato+W4uOW9seiur+aAp++8iVxyXG4gKiBAc3VtbWFyeVxyXG4gKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXHJcbiAqIOWkhOeQhuWOn+WIme+8mlxyXG4gKiAx44CB6YCa6L+HY3JlYXRlU2Vzc2lvbuWIm+W7uu+8m1xyXG4gKiAy44CB5q+P5LiqUmVwb3NpdG9yeeaLpeacieeLrOeri+eahEJlU2Vzc2lvbu+8m1xyXG4gKiAz44CB6K6/6ZeuQkXnmoRFQVBJ5pe277yM6YCa6L+HaGVhZGVy6YeM55qEU2Vzc2lvbklk5Lyg6YCS77ybXHJcbiAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cclxuICog5YW85a655oCn6ICD6JmR77yaXHJcbiAqIDHjgIHmnInkuqflk4Hpg6jnm7TmjqVuZXcgQmVTZXNzaW9uU2VydmljZSgp77yM5rKh5pyJ5Lyg6YCSXHJcbiAqL1xyXG5jbGFzcyBCZWZTZXBhcmF0ZWRTZXNzaW9uSGFuZGxpbmdTdHJhdGVneSBleHRlbmRzIEJlZlNlc3Npb25IYW5kbGluZ1N0cmF0ZWd5IHtcclxuICBwcml2YXRlIGluamVjdG9yOiBJbmplY3RvcjtcclxuICAvKipcclxuICAgKiDliJvlu7pTZXNzaW9u55qE55qERUFQSeWcsOWdgFxyXG4gICAqL1xyXG4gIHByaXZhdGUgYmVTZXNzaW9uVXJpOiBzdHJpbmc7XHJcblxyXG4gIC8qKlxyXG4gICAqIGh0dHBDbGllbnRcclxuICAgKi9cclxuICBwcml2YXRlIGh0dHBDbGllbnQ6IEh0dHBDbGllbnQ7XHJcblxyXG4gIHByaXZhdGUgaHR0cFNlcnZpY2U6IEh0dHBTZXJ2aWNlO1xyXG4gIC8qKlxyXG4gICAqIOaehOmAoOWHveaVsFxyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgc3RvcmFnZVN0cmF0ZWd5OiBCZVNlc3Npb25TdG9yYWdlU3RyYXRlZ3ksIGZybVNlc3Npb25TZXJ2aWNlOiBGcmFtZXdvcmtTZXNzaW9uU2VydmljZSxcclxuICAgIGh0dHBDbGllbnQ6IEh0dHBDbGllbnQsIGJlQmFzZVVyaTogc3RyaW5nLCBpbmplY3RvcjogSW5qZWN0b3JcclxuICApIHtcclxuICAgIHN1cGVyKHN0b3JhZ2VTdHJhdGVneSwgZnJtU2Vzc2lvblNlcnZpY2UpO1xyXG4gICAgdGhpcy5iZVNlc3Npb25VcmkgPSBiZUJhc2VVcmk7XHJcbiAgICB0aGlzLmh0dHBDbGllbnQgPSBodHRwQ2xpZW50O1xyXG4gICAgdGhpcy5odHRwU2VydmljZSA9IG5ldyBIdHRwU2VydmljZSh0aGlzLmh0dHBDbGllbnQpO1xyXG4gICAgdGhpcy5pbmplY3RvciA9IGluamVjdG9yO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6I635Y+WQmVTZXNzaW9uSWRcclxuICAgKi9cclxuICBwdWJsaWMgZ2V0U2Vzc2lvbklkKCk6IE9ic2VydmFibGU8c3RyaW5nPiB7XHJcbiAgICBjb25zdCBiZVNlc3Npb25JZCA9IHRoaXMuZ2V0U2Vzc2lvbklkRnJvbVN0b3JhZ2UoKTtcclxuICAgIGlmIChiZVNlc3Npb25JZCkge1xyXG4gICAgICByZXR1cm4gb2YoYmVTZXNzaW9uSWQpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHRoaXMuY3JlYXRlU2Vzc2lvbigpO1xyXG5cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiuvue9rkJlU2Vzc2lvbklkXHJcbiAgICovXHJcbiAgcHVibGljIHNldFNlc3Npb25JZChzZXNzaW9uSWQ6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgY29uc3Qgc2Vzc2lvbktleSA9IHRoaXMuZ2V0U2Vzc2lvblN0b3JhZ2VLZXkoKTtcclxuICAgIHRoaXMuc3RvcmFnZVN0cmF0ZWd5LnNldEl0ZW0oc2Vzc2lvbktleSwgc2Vzc2lvbklkKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOa4heepulNlc3Npb25pZFxyXG4gICAqL1xyXG4gIHB1YmxpYyBjbGVhclNlc3Npb25JZCgpIHtcclxuICAgIGNvbnN0IHNlc3Npb25LZXkgPSB0aGlzLmdldFNlc3Npb25TdG9yYWdlS2V5KCk7XHJcbiAgICAvLyB0aGlzLnN0b3JhZ2VTdHJhdGVneS5yZW1vdmVJdGVtKHNlc3Npb25LZXkpO1xyXG4gICAgdGhpcy5zdG9yYWdlU3RyYXRlZ3kuY2xlYXIodGhpcy5mcm1TZXNzaW9uSWQsIHNlc3Npb25LZXkpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5omp5bGVU2Vzc2lvbuebuOWFs+WktOS/oeaBr1xyXG4gICAqL1xyXG4gIHB1YmxpYyBleHRlbmRSZXF1ZXN0SGVhZGVycyhoZWFkZXJzOiBIdHRwSGVhZGVycywgcnVudGltZUNvbnRleHQ/OiBhbnkpOiBIdHRwSGVhZGVycyB7XHJcbiAgICBjb25zdCBmcm1TZXNzaW9uSWQgPSB0aGlzLmdldEZyYW1ld29ya1Nlc3Npb25JZChydW50aW1lQ29udGV4dCk7XHJcbiAgICBjb25zdCBiZVNlc3Npb25JZCA9IHRoaXMuZ2V0U2Vzc2lvbklkRnJvbVN0b3JhZ2UocnVudGltZUNvbnRleHQpO1xyXG4gICAgaGVhZGVycyA9IEh0dHBIZWFkZXJVdGlsLmFwcGVuZENhZlJ1bnRpbWVDb21tb25WYXJpYWJsZShoZWFkZXJzLCBmcm1TZXNzaW9uSWQpO1xyXG4gICAgaWYgKGJlU2Vzc2lvbklkKSB7XHJcbiAgICAgIGhlYWRlcnMgPSBIdHRwSGVhZGVyVXRpbC5hcHBlbmRDYWZSdW50aW1lQ29udGV4dChoZWFkZXJzLCBiZVNlc3Npb25JZCk7XHJcbiAgICAgIGhlYWRlcnMgPSBIdHRwSGVhZGVyVXRpbC5hcHBlbmRTZXNzaW9uSWQoaGVhZGVycywgYmVTZXNzaW9uSWQpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIGNvbnN0IGFwcENvbnRleHQgPSB0aGlzLmluamVjdG9yLmdldDxBcHBDb250ZXh0PihBcHBDb250ZXh0LCBudWxsKTtcclxuICAgIC8vaWYgKGFwcENvbnRleHQpIHtcclxuICAgIC8vIGNvbnN0IGFwcElkID0gYXBwQ29udGV4dC5BcHBsaWNhdGlvbklkO1xyXG4gICAgaGVhZGVycyA9IEh0dHBIZWFkZXJVdGlsLmFwcGVuZEZ1bmNJbnN0SWQoaGVhZGVycywgdGhpcy5iZVNlc3Npb25VcmkpO1xyXG4gICAgLy8gfVxyXG4gICAgLy8gaGVhZGVycyA9IEh0dHBIZWFkZXJVdGlsLmFwcGVuZFJlcXVpcmVNZXNzYWdlKGhlYWRlcnMsIHRydWUpO1xyXG4gICAgcmV0dXJuIGhlYWRlcnM7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDlpITnkIbmnI3liqHlmajnq6/ov5Tlm57nmoRoZWFkZXJzXHJcbiAgICovXHJcbiAgcHVibGljIGhhbmRsZVJlcG9uc2VIZWFkZXJzKGhlYWRlcnM6IEh0dHBIZWFkZXJzKTogdm9pZCB7XHJcbiAgICBjb25zb2xlLmxvZyhoZWFkZXJzKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWIm+W7ukJlU2Vzc2lvbklkXHJcbiAgICovXHJcbiAgcHVibGljIGNyZWF0ZVNlc3Npb24oKTogT2JzZXJ2YWJsZTxzdHJpbmc+IHtcclxuICAgIGNvbnN0IHBhcmFtczogeyBbcHJvcE5hbWU6IHN0cmluZ106IGFueSB9ID0ge1xyXG4gICAgICByZXNwb25zZVR5cGU6ICd0ZXh0J1xyXG4gICAgfTtcclxuICAgIGlmICghIXRoaXMuZnJtU2Vzc2lvbklkKSB7XHJcbiAgICAgIGNvbnN0IGFwcENvbnRleHQgPSB0aGlzLmluamVjdG9yLmdldDxBcHBDb250ZXh0PihBcHBDb250ZXh0LCBudWxsKTtcclxuICAgICAgcGFyYW1zLmhlYWRlcnMgPSBuZXcgSHR0cEhlYWRlcnMoeyBTZXNzaW9uSWQ6IHRoaXMuZnJtU2Vzc2lvbklkIH0pO1xyXG4gICAgICBwYXJhbXMuaGVhZGVycyA9IHBhcmFtcy5oZWFkZXJzLmFwcGVuZCgnWC1DQUYtUnVudGltZS1Db21tb25WYXJpYWJsZScsIHRoaXMuZnJtU2Vzc2lvbklkKTtcclxuICAgICAgLy9pZiAoYXBwQ29udGV4dCkge1xyXG4gICAgICAvLyBjb25zdCBhcHBJZCA9IGFwcENvbnRleHQuQXBwbGljYXRpb25JZDtcclxuICAgICAgcGFyYW1zLmhlYWRlcnMgPSBwYXJhbXMuaGVhZGVycy5hcHBlbmQoJ0Z1bmMtSW5zdC1JZCcsIHRoaXMuYmVTZXNzaW9uVXJpKTtcclxuICAgICAgLy99XHJcbiAgICAgIHBhcmFtcy5oZWFkZXJzID0gSHR0cEhlYWRlclV0aWwudG9Kc29uKHBhcmFtcy5oZWFkZXJzKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gdGhpcy5odHRwU2VydmljZS5yZXF1ZXN0KCdQT1NUJywgdGhpcy5iZVNlc3Npb25VcmksIHBhcmFtcykucGlwZShcclxuICAgICAgdGFwKChiZVNlc3Npb25JZDogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgdGhpcy5zZXRTZXNzaW9uSWQoYmVTZXNzaW9uSWQpO1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBleHRlbmRIdHRwSGVhZGVyKCkge1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6I635Y+W5p+Q5LiqUmVwb3NpdG9yeeWvueW6lOeahEJlU2Vzc2lvbueahOWUr+S4gGtleVxyXG4gICAqIEBzdW1tYXJ5XHJcbiAgICogMeOAgeWcqOS9v+eUqOeLrOeri0JlU2Vzc2lvbueahOe7hOWQiOihqOWNleS4re+8jOmcgOimgemAmui/h0JlU2Vzc2lvblVyaemalOemu++8m1xyXG4gICAqIDLjgIHlnKhEZWJ1Z+aooeW8j+S4i++8jEZybVNlc3Npb25JZD1Vc2VyU2Vzc2lvbmlk77yM5aaC5p6c5Y+q55So5a6D5L2ca2V577yMXHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIGdldFNlc3Npb25TdG9yYWdlS2V5KHJ1bnRpbWVDb250ZXh0PzogYW55KTogc3RyaW5nIHtcclxuICAgIGxldCBzZXNzaW9uSWQgPSBudWxsO1xyXG4gICAgaWYgKHJ1bnRpbWVDb250ZXh0KSB7XHJcbiAgICAgIHNlc3Npb25JZCA9IHRoaXMuZ2V0RnJhbWV3b3JrU2Vzc2lvbklkKHJ1bnRpbWVDb250ZXh0KTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHNlc3Npb25JZCA9IHRoaXMuZnJtU2Vzc2lvbklkO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGAke3Nlc3Npb25JZH1fJHt0aGlzLmJlU2Vzc2lvblVyaX1gO1xyXG4gIH1cclxuXHJcbn1cclxuXHJcblxyXG5jbGFzcyBCZWZVbmlmaWVkU2Vzc2lvbkhhbmRsaW5nU3RyYXRlZ3kgZXh0ZW5kcyBCZWZTZXNzaW9uSGFuZGxpbmdTdHJhdGVneSB7XHJcblxyXG4gIC8qKlxyXG4gICAqIOWIm+W7ulNlc3Npb27nmoTnmoRFQVBJ5Zyw5Z2AXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBiZVNlc3Npb25Vcmk6IHN0cmluZztcclxuICBwcml2YXRlIGluamVjdG9yOiBJbmplY3RvcjtcclxuXHJcbiAgLyoqXHJcbiAgICog5p6E6YCg5Ye95pWwXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBzdG9yYWdlU3RyYXRlZ3k6IEJlU2Vzc2lvblN0b3JhZ2VTdHJhdGVneSwgZnJtU2Vzc2lvblNlcnZpY2U6IEZyYW1ld29ya1Nlc3Npb25TZXJ2aWNlLCBiZUJhc2VVcmk6IHN0cmluZywgaW5qZWN0b3I6IEluamVjdG9yXHJcbiAgKSB7XHJcbiAgICBzdXBlcihzdG9yYWdlU3RyYXRlZ3ksIGZybVNlc3Npb25TZXJ2aWNlKTtcclxuICAgIHRoaXMuYmVTZXNzaW9uVXJpID0gYmVCYXNlVXJpO1xyXG4gICAgdGhpcy5pbmplY3RvciA9IGluamVjdG9yO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGdldFNlc3Npb25JZCgpOiBPYnNlcnZhYmxlPHN0cmluZz4ge1xyXG4gICAgY29uc3Qgc2Vzc2lvbktleSA9IHRoaXMuZ2V0U2Vzc2lvblN0b3JhZ2VLZXkoKTtcclxuICAgIGNvbnN0IHNlc3Npb25JZCA9IHRoaXMuc3RvcmFnZVN0cmF0ZWd5LmdldEl0ZW0oc2Vzc2lvbktleSk7XHJcbiAgICByZXR1cm4gb2Yoc2Vzc2lvbklkKVxyXG4gICAgLy8gcmV0dXJuIG9mKG51bGwpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6K6+572uQmVTZXNzaW9uSWRcclxuICAgKi9cclxuICBwdWJsaWMgc2V0U2Vzc2lvbklkKHNlc3Npb25JZDogc3RyaW5nKTogdm9pZCB7XHJcbiAgICBjb25zdCBzZXNzaW9uS2V5ID0gdGhpcy5nZXRTZXNzaW9uU3RvcmFnZUtleSgpO1xyXG4gICAgdGhpcy5zdG9yYWdlU3RyYXRlZ3kuc2V0SXRlbShzZXNzaW9uS2V5LCBzZXNzaW9uSWQpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5riF56m6U2Vzc2lvbmlkXHJcbiAgICovXHJcbiAgcHVibGljIGNsZWFyU2Vzc2lvbklkKCkge1xyXG4gICAgY29uc3Qgc2Vzc2lvbktleSA9IHRoaXMuZ2V0U2Vzc2lvblN0b3JhZ2VLZXkoKTtcclxuICAgIHRoaXMuc3RvcmFnZVN0cmF0ZWd5LnJlbW92ZUl0ZW0oc2Vzc2lvbktleSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmianlsZVTZXNzaW9u55u45YWz5aS05L+h5oGvXHJcbiAgICovXHJcbiAgcHVibGljIGV4dGVuZFJlcXVlc3RIZWFkZXJzKGhlYWRlcnM6IEh0dHBIZWFkZXJzLCBydW50aW1lQ29udGV4dD86IGFueSk6IEh0dHBIZWFkZXJzIHtcclxuICAgIGNvbnN0IGZybVNlc3Npb25JZCA9IHRoaXMuZ2V0RnJhbWV3b3JrU2Vzc2lvbklkKHJ1bnRpbWVDb250ZXh0KTtcclxuICAgIGNvbnN0IGJlU2Vzc2lvbklkID0gdGhpcy5nZXRTZXNzaW9uSWRGcm9tU3RvcmFnZShydW50aW1lQ29udGV4dCk7XHJcbiAgICAvLyBoZWFkZXJzID0gSHR0cEhlYWRlclV0aWwuYXBwZW5kUmVxdWlyZU1lc3NhZ2UoaGVhZGVycywgdHJ1ZSk7XHJcbiAgICBjb25zdCBhcHBDb250ZXh0ID0gdGhpcy5pbmplY3Rvci5nZXQ8QXBwQ29udGV4dD4oQXBwQ29udGV4dCwgbnVsbCk7XHJcbiAgICBpZiAoYXBwQ29udGV4dCkge1xyXG4gICAgICBjb25zdCB0b2tlbiA9IGFwcENvbnRleHQuVG9rZW47XHJcbiAgICAgIGhlYWRlcnMgPSBIdHRwSGVhZGVyVXRpbC5hcHBlbmRGdW5jSW5zdElkKGhlYWRlcnMsIHRva2VuKTtcclxuICAgIH1cclxuICAgIGhlYWRlcnMgPSBIdHRwSGVhZGVyVXRpbC5hcHBlbmRDYWZSdW50aW1lQ29tbW9uVmFyaWFibGUoaGVhZGVycywgZnJtU2Vzc2lvbklkKTtcclxuICAgIGlmIChiZVNlc3Npb25JZCkge1xyXG4gICAgICBoZWFkZXJzID0gSHR0cEhlYWRlclV0aWwuYXBwZW5kQ2FmUnVudGltZUNvbnRleHQoaGVhZGVycywgYmVTZXNzaW9uSWQpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGhlYWRlcnM7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDlpITnkIbmnI3liqHlmajnq6/ov5Tlm57nmoRoZWFkZXJzXHJcbiAgICovXHJcbiAgcHVibGljIGhhbmRsZVJlcG9uc2VIZWFkZXJzKGhlYWRlcnM6IEh0dHBIZWFkZXJzKTogdm9pZCB7XHJcbiAgICBjb25zb2xlLmxvZyhoZWFkZXJzKTtcclxuICB9XHJcblxyXG5cclxuICAvKipcclxuICAgKiDojrflj5bmn5DkuKpSZXBvc2l0b3J55a+55bqU55qEQmVTZXNzaW9u55qE5ZSv5LiAa2V5XHJcbiAgICogQHN1bW1hcnlcclxuICAgKi9cclxuICBwcm90ZWN0ZWQgZ2V0U2Vzc2lvblN0b3JhZ2VLZXkocnVudGltZUNvbnRleHQ/OiBhbnkpOiBzdHJpbmcge1xyXG4gICAgLy8gY29uc3QgaXNEZWJ1ZyA9IGZhbHNlO1xyXG4gICAgLy8gaWYgKGlzRGVidWcpIHtcclxuICAgIC8vICAgcmV0dXJuIGAke3RoaXMuZnJtU2Vzc2lvbklkfV8ke3RoaXMuYmVTZXNzaW9uVXJpfWA7XHJcbiAgICAvLyB9IGVsc2Uge1xyXG4gICAgLy8gICByZXR1cm4gdGhpcy5mcm1TZXNzaW9uSWQ7XHJcbiAgICAvLyB9XHJcbiAgICBsZXQgc2Vzc2lvbklkID0gbnVsbDtcclxuICAgIGlmIChydW50aW1lQ29udGV4dCkge1xyXG4gICAgICBzZXNzaW9uSWQgPSB0aGlzLmdldEZyYW1ld29ya1Nlc3Npb25JZChydW50aW1lQ29udGV4dCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBzZXNzaW9uSWQgPSB0aGlzLmZybVNlc3Npb25JZDtcclxuICAgIH1cclxuICAgIHJldHVybiBgJHtzZXNzaW9uSWR9XyR7dGhpcy5iZVNlc3Npb25Vcml9YDtcclxuICB9XHJcbn1cclxuXHJcbmV4cG9ydCB7IEJlZlNlc3Npb25IYW5kbGluZ1N0cmF0ZWd5LCBCZWZTZXBhcmF0ZWRTZXNzaW9uSGFuZGxpbmdTdHJhdGVneSwgQmVmVW5pZmllZFNlc3Npb25IYW5kbGluZ1N0cmF0ZWd5IH07XHJcbiJdfQ==