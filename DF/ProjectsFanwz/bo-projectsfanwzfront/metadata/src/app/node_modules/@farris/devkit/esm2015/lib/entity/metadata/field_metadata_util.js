import * as tslib_1 from "tslib";
import { MetadataUtil } from '../../metadata/index';
import { NG_FIELD, NG_OBJECT, NG_Dynamic, NG_LIST } from './field_decorator';
import { Cacheable, DefaultCacheProvider } from '../../cache';
/**
 * 属性注解器通用方法
 */
export class FieldMetadataUtil {
    /**
     * 获取实体所有的简单属性元数据
     * @param target 实体类型
     * @returns 形如：{[propName: string]: NgObjectProperty}
     */
    static getNgFields(target) {
        return MetadataUtil.getPropsMetadatasByName(target, NG_FIELD);
    }
    /**
     * 获取某个简单属性的元数据
     */
    static getNgField(target, propName) {
        const ngFields = this.getNgFields(target);
        const ngField = ngFields[propName];
        return ngField;
    }
    /**
     * 获取实体属性在原始数据中的属性名
     */
    static getDataField(target, propName) {
        const ngField = this.getNgField(target, propName);
        return ngField.dataField || propName;
    }
    /**
     * 获取标注为NgObject的属性的元数据
     * @param target 实体类型
     * @returns 形如：{[propName: string]: NgObjectProperty}
     */
    static getNgObjects(target) {
        return MetadataUtil.getPropsMetadatasByName(target, NG_OBJECT);
    }
    static getNgDynamic(target) {
        return MetadataUtil.getPropsMetadatasByName(target, NG_Dynamic);
    }
    /**
     * 获取标注为NgList的属性的元数据
     * @param target 实体类型
     * @returns 形如：{[propName: string]: NgListProperty}
     */
    static getNgList(target) {
        return MetadataUtil.getPropsMetadatasByName(target, NG_LIST);
    }
    /**
     * 获取实体标注为主键的属性元数据
     * @param target 实体类型
     */
    static getPrimaryFieldMetadata(target) {
        const ngFieldObj = FieldMetadataUtil.getNgFields(target);
        const primaryKey = Object.keys(ngFieldObj).find((prop) => {
            return ngFieldObj[prop].primary;
        });
        if (primaryKey) {
            const propMeta = ngFieldObj[primaryKey];
            propMeta.property = primaryKey;
            if (!propMeta.dataField) {
                propMeta.dataField = primaryKey;
            }
            return propMeta;
        }
        return undefined;
    }
    /**
     * 获取主键名称，没有主键时返回空字符串
     */
    static getPrimaryKey(entityType) {
        const primaryNgField = this.getPrimaryFieldMetadata(entityType);
        if (!primaryNgField) {
            return '';
        }
        return primaryNgField.property;
    }
    // static udtMap = {};
    /**
     * 获取NgField 的验证规则元数据
     * @param target 实体类Type
     */
    static getValidationMetadata(target) {
        const fieldMetadatas = FieldMetadataUtil.getNgFields(target);
        // this.udtMap = Object.assign(this.udtMap || {}, FieldMetadataUtil.getNgObjects(target) || {});
        // let udtParentName = '';
        // Object.keys(this.udtMap).forEach(key => {
        //   // 当前实体是udt类型时
        //   if (this.udtMap[key].type.name === target.name) {
        //     // 找出当前udt实体的父级信息
        //     udtParentName = key;
        //   }
        // });
        const metadatas = {};
        // let primaryId = '';
        // let udtPrimaryId = '';
        // 不进行验证的属性名
        // const excludeIDs = [];
        // 排除udt的主键
        // Object.keys(fieldMetadatas).forEach(key => {
        //   if (fieldMetadatas[key].primary || fieldMetadatas[key].foreign) {
        //     primaryId = fieldMetadatas[key].dataField;
        //     udtPrimaryId = fieldMetadatas[key].dataField + '_ID';
        //     excludeIDs.push(fieldMetadatas[key].dataField);
        //   }
        // });
        Object.keys(fieldMetadatas).forEach(key => {
            if (fieldMetadatas[key].primary || fieldMetadatas[key].foreign) {
                return;
            }
            const validRules = fieldMetadatas[key].validRules;
            // if (excludeIDs.indexOf(key) > -1) {
            //   return;
            // }
            if (validRules && validRules.length) {
                validRules.map(rule => {
                    rule.property = key;
                    rule['targetName'] = target.name;
                });
                metadatas[key] = validRules;
            }
        });
        return metadatas;
    }
    static getValidationMetadataWithPath(object) {
        const target = object.constructor;
        const fieldMetadatas = FieldMetadataUtil.getNgFields(target);
        const parentPaths = object.getPaths().path || [];
        const metadatas = {};
        Object.keys(fieldMetadatas).forEach(key => {
            if (fieldMetadatas[key].primary || fieldMetadatas[key].foreign) {
                return;
            }
            const validRules = fieldMetadatas[key].validRules;
            if (validRules && validRules.length) {
                const propertyPath = parentPaths.concat([]);
                propertyPath.push(key);
                const property = propertyPath.join('.');
                validRules.map(rule => {
                    rule.property = key;
                    rule['targetName'] = target.name;
                    rule['path'] = property;
                });
                metadatas[key] = validRules;
            }
        });
        return metadatas;
    }
}
tslib_1.__decorate([
    Cacheable({ key: ((context, args) => args[0]), provider: new DefaultCacheProvider() }),
    tslib_1.__metadata("design:type", Function),
    tslib_1.__metadata("design:paramtypes", [Object]),
    tslib_1.__metadata("design:returntype", Object)
], FieldMetadataUtil, "getNgFields", null);
tslib_1.__decorate([
    Cacheable({ key: ((context, args) => args[0]), provider: new DefaultCacheProvider() }),
    tslib_1.__metadata("design:type", Function),
    tslib_1.__metadata("design:paramtypes", [Object]),
    tslib_1.__metadata("design:returntype", Object)
], FieldMetadataUtil, "getNgObjects", null);
tslib_1.__decorate([
    Cacheable({ key: ((context, args) => args[0]), provider: new DefaultCacheProvider() }),
    tslib_1.__metadata("design:type", Function),
    tslib_1.__metadata("design:paramtypes", [Object]),
    tslib_1.__metadata("design:returntype", Object)
], FieldMetadataUtil, "getNgList", null);
tslib_1.__decorate([
    Cacheable({ key: ((context, args) => args[0]), provider: new DefaultCacheProvider() }),
    tslib_1.__metadata("design:type", Function),
    tslib_1.__metadata("design:paramtypes", [Object]),
    tslib_1.__metadata("design:returntype", Object)
], FieldMetadataUtil, "getPrimaryFieldMetadata", null);
tslib_1.__decorate([
    Cacheable({ key: ((context, args) => args[0]), provider: new DefaultCacheProvider() }),
    tslib_1.__metadata("design:type", Function),
    tslib_1.__metadata("design:paramtypes", [Object]),
    tslib_1.__metadata("design:returntype", void 0)
], FieldMetadataUtil, "getPrimaryKey", null);
tslib_1.__decorate([
    Cacheable({ key: ((context, args) => args[0]), provider: new DefaultCacheProvider() }),
    tslib_1.__metadata("design:type", Function),
    tslib_1.__metadata("design:paramtypes", [Object]),
    tslib_1.__metadata("design:returntype", Object)
], FieldMetadataUtil, "getValidationMetadata", null);
tslib_1.__decorate([
    Cacheable({ key: ((context, args) => args[0]), provider: new DefaultCacheProvider() }),
    tslib_1.__metadata("design:type", Function),
    tslib_1.__metadata("design:paramtypes", [Object]),
    tslib_1.__metadata("design:returntype", Object)
], FieldMetadataUtil, "getValidationMetadataWithPath", null);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmllbGRfbWV0YWRhdGFfdXRpbC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL2VudGl0eS9tZXRhZGF0YS9maWVsZF9tZXRhZGF0YV91dGlsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDcEQsT0FBTyxFQUNMLFFBQVEsRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFFLE9BQU8sRUFDekMsTUFBTSxtQkFBbUIsQ0FBQztBQUUzQixPQUFPLEVBQUUsU0FBUyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sYUFBYSxDQUFDO0FBRTlEOztHQUVHO0FBQ0gsTUFBTSxPQUFPLGlCQUFpQjtJQUM1Qjs7OztPQUlHO0lBRUgsTUFBTSxDQUFDLFdBQVcsQ0FBQyxNQUFXO1FBQzVCLE9BQU8sWUFBWSxDQUFDLHVCQUF1QixDQUFDLE1BQU0sRUFBRSxRQUFRLENBQUMsQ0FBQztJQUNoRSxDQUFDO0lBRUQ7O09BRUc7SUFDSCxNQUFNLENBQUMsVUFBVSxDQUFDLE1BQVcsRUFBRSxRQUFnQjtRQUM3QyxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQzFDLE1BQU0sT0FBTyxHQUFHLFFBQVEsQ0FBQyxRQUFRLENBQW9CLENBQUM7UUFDdEQsT0FBTyxPQUFPLENBQUM7SUFDakIsQ0FBQztJQUVEOztPQUVHO0lBQ0gsTUFBTSxDQUFDLFlBQVksQ0FBQyxNQUFXLEVBQUUsUUFBZ0I7UUFDL0MsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFDbEQsT0FBTyxPQUFPLENBQUMsU0FBUyxJQUFJLFFBQVEsQ0FBQztJQUN2QyxDQUFDO0lBRUQ7Ozs7T0FJRztJQUVILE1BQU0sQ0FBQyxZQUFZLENBQUMsTUFBVztRQUM3QixPQUFPLFlBQVksQ0FBQyx1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QURFLFNBQVMsQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUMsT0FBWSxFQUFFLElBQVcsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsUUFBUSxFQUFFLElBQUksb0JBQW9CLEVBQUUsRUFBRSxDQUFDOzs7O29EQTBDbkc7QUFFRDtJQURDLFNBQVMsQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUMsT0FBWSxFQUFFLElBQVcsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsUUFBUSxFQUFFLElBQUksb0JBQW9CLEVBQUUsRUFBRSxDQUFDOzs7OzREQTBCbEciLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBNZXRhZGF0YVV0aWwgfSBmcm9tICcuLi8uLi9tZXRhZGF0YS9pbmRleCc7XHJcbmltcG9ydCB7XHJcbiAgTkdfRklFTEQsIE5HX09CSkVDVCwgTkdfRHluYW1pYywgTkdfTElTVCwgTmdGaWVsZFByb3BlcnR5LCBOZ09iamVjdFByb3BlcnR5LCBOZ0xpc3RQcm9wZXJ0eVxyXG59IGZyb20gJy4vZmllbGRfZGVjb3JhdG9yJztcclxuaW1wb3J0IHsgVmFsaWRhdGVSdWxlIH0gZnJvbSAnLi4vdmFsaWRhdG9yL3R5cGVzJztcclxuaW1wb3J0IHsgQ2FjaGVhYmxlLCBEZWZhdWx0Q2FjaGVQcm92aWRlciB9IGZyb20gJy4uLy4uL2NhY2hlJztcclxuXHJcbi8qKlxyXG4gKiDlsZ7mgKfms6jop6PlmajpgJrnlKjmlrnms5VcclxuICovXHJcbmV4cG9ydCBjbGFzcyBGaWVsZE1ldGFkYXRhVXRpbCB7XHJcbiAgLyoqXHJcbiAgICog6I635Y+W5a6e5L2T5omA5pyJ55qE566A5Y2V5bGe5oCn5YWD5pWw5o2uXHJcbiAgICogQHBhcmFtIHRhcmdldCDlrp7kvZPnsbvlnotcclxuICAgKiBAcmV0dXJucyDlvaLlpoLvvJp7W3Byb3BOYW1lOiBzdHJpbmddOiBOZ09iamVjdFByb3BlcnR5fVxyXG4gICAqL1xyXG4gIEBDYWNoZWFibGUoeyBrZXk6ICgoY29udGV4dDogYW55LCBhcmdzOiBhbnlbXSkgPT4gYXJnc1swXSksIHByb3ZpZGVyOiBuZXcgRGVmYXVsdENhY2hlUHJvdmlkZXIoKSB9KVxyXG4gIHN0YXRpYyBnZXROZ0ZpZWxkcyh0YXJnZXQ6IGFueSk6IHsgW3Byb3BOYW1lOiBzdHJpbmddOiBOZ0ZpZWxkUHJvcGVydHkgfSB7XHJcbiAgICByZXR1cm4gTWV0YWRhdGFVdGlsLmdldFByb3BzTWV0YWRhdGFzQnlOYW1lKHRhcmdldCwgTkdfRklFTEQpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6I635Y+W5p+Q5Liq566A5Y2V5bGe5oCn55qE5YWD5pWw5o2uXHJcbiAgICovXHJcbiAgc3RhdGljIGdldE5nRmllbGQodGFyZ2V0OiBhbnksIHByb3BOYW1lOiBzdHJpbmcpOiBOZ0ZpZWxkUHJvcGVydHkge1xyXG4gICAgY29uc3QgbmdGaWVsZHMgPSB0aGlzLmdldE5nRmllbGRzKHRhcmdldCk7XHJcbiAgICBjb25zdCBuZ0ZpZWxkID0gbmdGaWVsZHNbcHJvcE5hbWVdIGFzIE5nRmllbGRQcm9wZXJ0eTtcclxuICAgIHJldHVybiBuZ0ZpZWxkO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6I635Y+W5a6e5L2T5bGe5oCn5Zyo5Y6f5aeL5pWw5o2u5Lit55qE5bGe5oCn5ZCNXHJcbiAgICovXHJcbiAgc3RhdGljIGdldERhdGFGaWVsZCh0YXJnZXQ6IGFueSwgcHJvcE5hbWU6IHN0cmluZykge1xyXG4gICAgY29uc3QgbmdGaWVsZCA9IHRoaXMuZ2V0TmdGaWVsZCh0YXJnZXQsIHByb3BOYW1lKTtcclxuICAgIHJldHVybiBuZ0ZpZWxkLmRhdGFGaWVsZCB8fCBwcm9wTmFtZTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluagh+azqOS4uk5nT2JqZWN055qE5bGe5oCn55qE5YWD5pWw5o2uXHJcbiAgICogQHBhcmFtIHRhcmdldCDlrp7kvZPnsbvlnotcclxuICAgKiBAcmV0dXJucyDlvaLlpoLvvJp7W3Byb3BOYW1lOiBzdHJpbmddOiBOZ09iamVjdFByb3BlcnR5fVxyXG4gICAqL1xyXG4gIEBDYWNoZWFibGUoeyBrZXk6ICgoY29udGV4dDogYW55LCBhcmdzOiBhbnlbXSkgPT4gYXJnc1swXSksIHByb3ZpZGVyOiBuZXcgRGVmYXVsdENhY2hlUHJvdmlkZXIoKSB9KVxyXG4gIHN0YXRpYyBnZXROZ09iamVjdHModGFyZ2V0OiBhbnkpOiB7IFtwcm9wTmFtZTogc3RyaW5nXTogTmdPYmplY3RQcm9wZXJ0eSB9IHtcclxuICAgIHJldHVybiBNZXRhZGF0YVV0aWwuZ2V0UHJvcHNNZXRhZGF0YXNCeU5hbWUodGFyZ2V0LCBOR19PQkpFQ1QpO1xyXG4gIH1cclxuXHJcbiAgc3RhdGljIGdldE5nRHluYW1pYyh0YXJnZXQ6IGFueSk6IHsgW3Byb3BOYW1lOiBzdHJpbmddOiBOZ09iamVjdFByb3BlcnR5IH0ge1xyXG4gICAgcmV0dXJuIE1ldGFkYXRhVXRpbC5nZXRQcm9wc01ldGFkYXRhc0J5TmFtZSh0YXJnZXQsIE5HX0R5bmFtaWMpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6I635Y+W5qCH5rOo5Li6TmdMaXN055qE5bGe5oCn55qE5YWD5pWw5o2uXHJcbiAgICogQHBhcmFtIHRhcmdldCDlrp7kvZPnsbvlnotcclxuICAgKiBAcmV0dXJucyDlvaLlpoLvvJp7W3Byb3BOYW1lOiBzdHJpbmddOiBOZ0xpc3RQcm9wZXJ0eX1cclxuICAgKi9cclxuICBAQ2FjaGVhYmxlKHsga2V5OiAoKGNvbnRleHQ6IGFueSwgYXJnczogYW55W10pID0+IGFyZ3NbMF0pLCBwcm92aWRlcjogbmV3IERlZmF1bHRDYWNoZVByb3ZpZGVyKCkgfSlcclxuICBzdGF0aWMgZ2V0TmdMaXN0KHRhcmdldDogYW55KTogeyBbcHJvcE5hbWU6IHN0cmluZ106IE5nTGlzdFByb3BlcnR5IH0ge1xyXG4gICAgcmV0dXJuIE1ldGFkYXRhVXRpbC5nZXRQcm9wc01ldGFkYXRhc0J5TmFtZSh0YXJnZXQsIE5HX0xJU1QpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6I635Y+W5a6e5L2T5qCH5rOo5Li65Li76ZSu55qE5bGe5oCn5YWD5pWw5o2uXHJcbiAgICogQHBhcmFtIHRhcmdldCDlrp7kvZPnsbvlnotcclxuICAgKi9cclxuICBAQ2FjaGVhYmxlKHsga2V5OiAoKGNvbnRleHQ6IGFueSwgYXJnczogYW55W10pID0+IGFyZ3NbMF0pLCBwcm92aWRlcjogbmV3IERlZmF1bHRDYWNoZVByb3ZpZGVyKCkgfSlcclxuICBzdGF0aWMgZ2V0UHJpbWFyeUZpZWxkTWV0YWRhdGEodGFyZ2V0OiBhbnkpOiBOZ0ZpZWxkUHJvcGVydHkgfCB1bmRlZmluZWQge1xyXG4gICAgY29uc3QgbmdGaWVsZE9iaiA9IEZpZWxkTWV0YWRhdGFVdGlsLmdldE5nRmllbGRzKHRhcmdldCk7XHJcbiAgICBjb25zdCBwcmltYXJ5S2V5ID0gT2JqZWN0LmtleXMobmdGaWVsZE9iaikuZmluZCgocHJvcDogc3RyaW5nKSA9PiB7XHJcbiAgICAgIHJldHVybiBuZ0ZpZWxkT2JqW3Byb3BdLnByaW1hcnk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpZiAocHJpbWFyeUtleSkge1xyXG4gICAgICBjb25zdCBwcm9wTWV0YSA9IG5nRmllbGRPYmpbcHJpbWFyeUtleV07XHJcbiAgICAgIHByb3BNZXRhLnByb3BlcnR5ID0gcHJpbWFyeUtleTtcclxuICAgICAgaWYgKCFwcm9wTWV0YS5kYXRhRmllbGQpIHtcclxuICAgICAgICBwcm9wTWV0YS5kYXRhRmllbGQgPSBwcmltYXJ5S2V5O1xyXG4gICAgICB9XHJcblxyXG4gICAgICByZXR1cm4gcHJvcE1ldGE7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6I635Y+W5Li76ZSu5ZCN56ew77yM5rKh5pyJ5Li76ZSu5pe26L+U5Zue56m65a2X56ym5LiyXHJcbiAgICovXHJcbiAgQENhY2hlYWJsZSh7IGtleTogKChjb250ZXh0OiBhbnksIGFyZ3M6IGFueVtdKSA9PiBhcmdzWzBdKSwgcHJvdmlkZXI6IG5ldyBEZWZhdWx0Q2FjaGVQcm92aWRlcigpIH0pXHJcbiAgc3RhdGljIGdldFByaW1hcnlLZXkoZW50aXR5VHlwZTogYW55KSB7XHJcbiAgICBjb25zdCBwcmltYXJ5TmdGaWVsZCA9IHRoaXMuZ2V0UHJpbWFyeUZpZWxkTWV0YWRhdGEoZW50aXR5VHlwZSk7XHJcbiAgICBpZiAoIXByaW1hcnlOZ0ZpZWxkKSB7XHJcbiAgICAgIHJldHVybiAnJztcclxuICAgIH1cclxuICAgIHJldHVybiBwcmltYXJ5TmdGaWVsZC5wcm9wZXJ0eTtcclxuICB9XHJcblxyXG4gIC8vIHN0YXRpYyB1ZHRNYXAgPSB7fTtcclxuXHJcbiAgLyoqXHJcbiAgICog6I635Y+WTmdGaWVsZCDnmoTpqozor4Hop4TliJnlhYPmlbDmja5cclxuICAgKiBAcGFyYW0gdGFyZ2V0IOWunuS9k+exu1R5cGVcclxuICAgKi9cclxuICAgQENhY2hlYWJsZSh7IGtleTogKChjb250ZXh0OiBhbnksIGFyZ3M6IGFueVtdKSA9PiBhcmdzWzBdKSwgcHJvdmlkZXI6IG5ldyBEZWZhdWx0Q2FjaGVQcm92aWRlcigpIH0pXHJcbiAgc3RhdGljIGdldFZhbGlkYXRpb25NZXRhZGF0YSh0YXJnZXQ6IGFueSk6IHsgW2tleTogc3RyaW5nXTogVmFsaWRhdGVSdWxlW10gfSB7XHJcbiAgICBjb25zdCBmaWVsZE1ldGFkYXRhcyA9IEZpZWxkTWV0YWRhdGFVdGlsLmdldE5nRmllbGRzKHRhcmdldCk7XHJcbiAgICAvLyB0aGlzLnVkdE1hcCA9IE9iamVjdC5hc3NpZ24odGhpcy51ZHRNYXAgfHwge30sIEZpZWxkTWV0YWRhdGFVdGlsLmdldE5nT2JqZWN0cyh0YXJnZXQpIHx8IHt9KTtcclxuICAgIC8vIGxldCB1ZHRQYXJlbnROYW1lID0gJyc7XHJcbiAgICAvLyBPYmplY3Qua2V5cyh0aGlzLnVkdE1hcCkuZm9yRWFjaChrZXkgPT4ge1xyXG4gICAgLy8gICAvLyDlvZPliY3lrp7kvZPmmK91ZHTnsbvlnovml7ZcclxuICAgIC8vICAgaWYgKHRoaXMudWR0TWFwW2tleV0udHlwZS5uYW1lID09PSB0YXJnZXQubmFtZSkge1xyXG4gICAgLy8gICAgIC8vIOaJvuWHuuW9k+WJjXVkdOWunuS9k+eahOeItue6p+S/oeaBr1xyXG4gICAgLy8gICAgIHVkdFBhcmVudE5hbWUgPSBrZXk7XHJcbiAgICAvLyAgIH1cclxuICAgIC8vIH0pO1xyXG4gICAgY29uc3QgbWV0YWRhdGFzOiB7IFtrZXk6IHN0cmluZ106IFZhbGlkYXRlUnVsZVtdIH0gPSB7fTtcclxuICAgIC8vIGxldCBwcmltYXJ5SWQgPSAnJztcclxuICAgIC8vIGxldCB1ZHRQcmltYXJ5SWQgPSAnJztcclxuICAgIC8vIOS4jei/m+ihjOmqjOivgeeahOWxnuaAp+WQjVxyXG4gICAgLy8gY29uc3QgZXhjbHVkZUlEcyA9IFtdO1xyXG4gICAgLy8g5o6S6ZmkdWR055qE5Li76ZSuXHJcbiAgICAvLyBPYmplY3Qua2V5cyhmaWVsZE1ldGFkYXRhcykuZm9yRWFjaChrZXkgPT4ge1xyXG4gICAgLy8gICBpZiAoZmllbGRNZXRhZGF0YXNba2V5XS5wcmltYXJ5IHx8IGZpZWxkTWV0YWRhdGFzW2tleV0uZm9yZWlnbikge1xyXG4gICAgLy8gICAgIHByaW1hcnlJZCA9IGZpZWxkTWV0YWRhdGFzW2tleV0uZGF0YUZpZWxkO1xyXG4gICAgLy8gICAgIHVkdFByaW1hcnlJZCA9IGZpZWxkTWV0YWRhdGFzW2tleV0uZGF0YUZpZWxkICsgJ19JRCc7XHJcbiAgICAvLyAgICAgZXhjbHVkZUlEcy5wdXNoKGZpZWxkTWV0YWRhdGFzW2tleV0uZGF0YUZpZWxkKTtcclxuICAgIC8vICAgfVxyXG4gICAgLy8gfSk7XHJcbiAgICBPYmplY3Qua2V5cyhmaWVsZE1ldGFkYXRhcykuZm9yRWFjaChrZXkgPT4ge1xyXG4gICAgICBpZiAoZmllbGRNZXRhZGF0YXNba2V5XS5wcmltYXJ5IHx8IGZpZWxkTWV0YWRhdGFzW2tleV0uZm9yZWlnbikge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG4gICAgICBjb25zdCB2YWxpZFJ1bGVzID0gZmllbGRNZXRhZGF0YXNba2V5XS52YWxpZFJ1bGVzO1xyXG4gICAgICAvLyBpZiAoZXhjbHVkZUlEcy5pbmRleE9mKGtleSkgPiAtMSkge1xyXG4gICAgICAvLyAgIHJldHVybjtcclxuICAgICAgLy8gfVxyXG4gICAgICBpZiAodmFsaWRSdWxlcyAmJiB2YWxpZFJ1bGVzLmxlbmd0aCkge1xyXG4gICAgICAgIHZhbGlkUnVsZXMubWFwKHJ1bGUgPT4ge1xyXG4gICAgICAgICAgcnVsZS5wcm9wZXJ0eSA9IGtleTtcclxuICAgICAgICAgIHJ1bGVbJ3RhcmdldE5hbWUnXSA9IHRhcmdldC5uYW1lO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIG1ldGFkYXRhc1trZXldID0gdmFsaWRSdWxlcztcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gbWV0YWRhdGFzO1xyXG4gIH1cclxuICBAQ2FjaGVhYmxlKHsga2V5OiAoKGNvbnRleHQ6IGFueSwgYXJnczogYW55W10pID0+IGFyZ3NbMF0pLCBwcm92aWRlcjogbmV3IERlZmF1bHRDYWNoZVByb3ZpZGVyKCkgfSlcclxuICBzdGF0aWMgZ2V0VmFsaWRhdGlvbk1ldGFkYXRhV2l0aFBhdGgob2JqZWN0OiBhbnkpOiB7IFtrZXk6IHN0cmluZ106IFZhbGlkYXRlUnVsZVtdIH0ge1xyXG4gICAgY29uc3QgdGFyZ2V0ID0gb2JqZWN0LmNvbnN0cnVjdG9yO1xyXG4gICAgY29uc3QgZmllbGRNZXRhZGF0YXMgPSBGaWVsZE1ldGFkYXRhVXRpbC5nZXROZ0ZpZWxkcyh0YXJnZXQpO1xyXG4gICAgY29uc3QgcGFyZW50UGF0aHMgPSBvYmplY3QuZ2V0UGF0aHMoKS5wYXRoIHx8IFtdO1xyXG4gICAgY29uc3QgbWV0YWRhdGFzOiB7IFtrZXk6IHN0cmluZ106IFZhbGlkYXRlUnVsZVtdIH0gPSB7fTtcclxuXHJcbiAgICBPYmplY3Qua2V5cyhmaWVsZE1ldGFkYXRhcykuZm9yRWFjaChrZXkgPT4ge1xyXG4gICAgICBpZiAoZmllbGRNZXRhZGF0YXNba2V5XS5wcmltYXJ5IHx8IGZpZWxkTWV0YWRhdGFzW2tleV0uZm9yZWlnbikge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG4gICAgICBjb25zdCB2YWxpZFJ1bGVzID0gZmllbGRNZXRhZGF0YXNba2V5XS52YWxpZFJ1bGVzO1xyXG5cclxuICAgICAgaWYgKHZhbGlkUnVsZXMgJiYgdmFsaWRSdWxlcy5sZW5ndGgpIHtcclxuICAgICAgICBjb25zdCBwcm9wZXJ0eVBhdGggPSBwYXJlbnRQYXRocy5jb25jYXQoW10pO1xyXG4gICAgICAgIHByb3BlcnR5UGF0aC5wdXNoKGtleSk7XHJcbiAgICAgICAgY29uc3QgcHJvcGVydHkgPSBwcm9wZXJ0eVBhdGguam9pbignLicpO1xyXG4gICAgICAgIHZhbGlkUnVsZXMubWFwKHJ1bGUgPT4ge1xyXG4gICAgICAgICAgcnVsZS5wcm9wZXJ0eSA9IGtleTtcclxuICAgICAgICAgIHJ1bGVbJ3RhcmdldE5hbWUnXSA9IHRhcmdldC5uYW1lO1xyXG4gICAgICAgICAgcnVsZVsncGF0aCddID0gcHJvcGVydHk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgbWV0YWRhdGFzW2tleV0gPSB2YWxpZFJ1bGVzO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICAgIHJldHVybiBtZXRhZGF0YXM7XHJcbiAgfVxyXG59XHJcbiJdfQ==