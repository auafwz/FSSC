/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { map, switchMap } from 'rxjs/operators';
import { of } from 'rxjs';
import { Injectable, Injector, InjectionToken, ComponentFactoryResolver, ApplicationRef } from '@angular/core';
import { BsModalService } from '@farris/ui-modal';
import { MessagerService } from '@farris/ui-messager';
import { DatagridSettingsComponent } from './datagrid-settings.component';
import { cloneDeep } from 'lodash-es';
import { LocaleService } from '@farris/ui-locale';
import { IdService } from '@farris/ui-common';
import { SimpleColumnsComponent } from './simple-mode/simple-columns.component';
/** @type {?} */
export const GRID_SETTINGS_WEBAPI = new InjectionToken(' Farris DataGrid User Setting WebApi URI.');
export class DatagridSettingsService {
    /**
     * @param {?} injector
     * @param {?} modalSer
     * @param {?} messager
     * @param {?} idService
     * @param {?} localeSer
     */
    constructor(injector, modalSer, messager, idService, localeSer) {
        this.injector = injector;
        this.modalSer = modalSer;
        this.messager = messager;
        this.idService = idService;
        this.localeSer = localeSer;
        this.multiSortMsg = '列表中未开启多列排序的功能。 请检查！';
        this.columnsSortableMsg = '未开启列的排序功能。请检查！';
        this.notSupportHeaderGroupMsg = '暂不支持多表头设置';
        this.notShowDialog = '多表头暂不支持列显示设置；同时未启用列排序功能。';
        this.gridInstance = null;
        this.gridRefs = null;
        this.saving = false;
        this.cfr = null;
        this.app = null;
        this.cfr = this.injector.get(ComponentFactoryResolver);
        this.app = this.injector.get(ApplicationRef);
    }
    /**
     * @param {?=} id
     * @return {?}
     */
    destroy(id) {
        if (id && this.gridRefs && this.gridRefs[id]) {
            delete this.gridRefs[id];
        }
        else {
            this.gridRefs = null;
        }
    }
    /**
     * @param {?} dg
     * @return {?}
     */
    registerGridInstance(dg) {
        if (!dg) {
            console.log('DatagridSettingService: grid instance is null.');
            return;
        }
        /** @type {?} */
        const id = dg.id;
        this.gridRefs = this.gridRefs || {};
        if (!this.gridRefs[id]) {
            this.gridRefs[id] = dg;
        }
    }
    /**
     * @param {?} dgID
     * @return {?}
     */
    getGridInstance(dgID) {
        return this.gridRefs ? this.gridRefs[dgID] : null;
    }
    /**
     * @return {?}
     */
    getSearchTypes() {
        return [
            { value: 'all', title: this.localeSer.getValue('datagrid.settings.allColumns') },
            { value: 'visible', title: this.localeSer.getValue('datagrid.settings.visibleColumns') },
            { value: 'hidden', title: this.localeSer.getValue('datagrid.settings.hiddenColumns') }
        ];
    }
    /**
     * @param {?} gridInstance
     * @return {?}
     */
    showSimple(gridInstance) {
        /** @type {?} */
        const columns = this.convertColumnsToSimple(gridInstance.columns);
        columns[0] = columns[0].filter((/**
         * @param {?} n
         * @return {?}
         */
        n => n.field && n.field !== gridInstance.ControlPanelFeild));
        /** @type {?} */
        const searchTypes = this.getSearchTypes();
        if (this.cfr) {
            /** @type {?} */
            const cmpFactory = this.cfr.resolveComponentFactory(SimpleColumnsComponent);
            /** @type {?} */
            let simpleRef = cmpFactory.create(this.injector);
            this.app.attachView(simpleRef.hostView);
            simpleRef.instance.columns = columns;
            simpleRef.instance.seartTypes = searchTypes;
            simpleRef.instance.gridInstance = gridInstance;
            if (document.querySelector('#page-wrapper')) {
                simpleRef.instance.top = 76;
            }
            document.body.appendChild(simpleRef.location.nativeElement);
            simpleRef.instance.closed.subscribe((/**
             * @return {?}
             */
            () => {
                simpleRef.location.nativeElement.remove();
                simpleRef.destroy();
                simpleRef = null;
            }));
            simpleRef.instance.advanced.subscribe((/**
             * @return {?}
             */
            () => {
                this.showAdvanced(gridInstance);
            }));
            simpleRef.instance.submit.subscribe((/**
             * @param {?} e
             * @return {?}
             */
            (e) => {
                e.target.disabled = true;
                if (this.saving) {
                    return;
                }
                if (!this.saving) {
                    this.updateGridView(e, gridInstance, e.target);
                }
            }));
            simpleRef.hostView.detectChanges();
            return simpleRef;
        }
    }
    /**
     * @param {?} gridInstance
     * @param {?=} opts
     * @return {?}
     */
    show(gridInstance, opts) {
        this.registerGridInstance(gridInstance);
        if (gridInstance.enableSimpleMode) {
            return this.showSimple(gridInstance);
        }
        else {
            return this.showAdvanced(gridInstance, opts);
        }
    }
    /**
     * @private
     * @param {?} gridInstance
     * @param {?=} opts
     * @return {?}
     */
    showAdvanced(gridInstance, opts) {
        /** @type {?} */
        let _editColSortInfo = true;
        /** @type {?} */
        const editColSortInfo = this.canSetColumnSort(gridInstance);
        if (editColSortInfo !== true) {
            // this.messager.warning(msg);
            // return;
            _editColSortInfo = false;
        }
        /** @type {?} */
        const showSetColumnsTab = !this.isHeaderGroup(gridInstance);
        /** @type {?} */
        const getActiveTabIndex = (/**
         * @return {?}
         */
        () => {
            if (showSetColumnsTab) {
                return 1;
            }
            else {
                if (_editColSortInfo) {
                    return 2;
                }
                else {
                    return -1;
                }
            }
        });
        /** @type {?} */
        const activeTabIndex = getActiveTabIndex();
        if (activeTabIndex === -1) {
            this.messager.warning(this.notShowDialog);
            return;
        }
        /** @type {?} */
        const columns = this.convertColumnsToSimple(gridInstance.columns);
        columns[0] = columns[0].filter((/**
         * @param {?} n
         * @return {?}
         */
        n => n.field && n.field !== gridInstance.ControlPanelFeild));
        /** @type {?} */
        const treeData = this.convertColumns2TreeData(cloneDeep(columns), true);
        /** @type {?} */
        const viewColumnsTreeData = this.convertColumns2TreeData(cloneDeep(columns), false);
        this.checkViewTreeNodes(viewColumnsTreeData);
        /** @type {?} */
        let modalRef = null;
        /** @type {?} */
        const okText = this.localeSer.getValue('datagrid.settings.ok') || '确定';
        /** @type {?} */
        const cancelText = this.localeSer.getValue('datagrid.settings.cancel') || '取消';
        /** @type {?} */
        const resetText = this.localeSer.getValue('datagrid.settings.reset') || '重置';
        /** @type {?} */
        const defaultOpts = {
            width: 760, height: 560, showHeader: false, title: '控制面板',
            initialState: {
                columns,
                sortTreeData: treeData,
                viewTreeData: viewColumnsTreeData,
                gridInstance,
                canSetColumnSort: _editColSortInfo,
                canSetColumnVisible: showSetColumnsTab,
                activeTabIndex
            },
            showButtons: false
        };
        /** @type {?} */
        const modalOpts = Object.assign(defaultOpts, opts || {});
        modalRef = this.modalSer.show(DatagridSettingsComponent, modalOpts);
        /** @type {?} */
        const instance = (/** @type {?} */ (modalRef.content));
        instance.enableReset = true;
        instance.modalRef = modalRef;
        instance.canSetColumnSort = _editColSortInfo;
        instance.canSetColumnVisible = !this.isHeaderGroup(gridInstance);
        instance.submitHandle.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        (e) => {
            e.target.disabled = true;
            if (this.saving) {
                return;
            }
            if (!this.saving) {
                this.updateGridView(modalRef, gridInstance, e.target);
            }
        }));
        instance.cancelHandle.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        (e) => {
            modalRef.close();
        }));
        instance.concise.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        (e) => {
            modalRef.close();
            this.showSimple(gridInstance);
        }));
        /** @type {?} */
        const modalContainer = (/** @type {?} */ (modalRef.dialog.instance));
        modalContainer.draggbar.handle = instance.header.nativeElement;
        return modalRef;
    }
    /**
     * @private
     * @param {?} gridInstance
     * @return {?}
     */
    canSetColumnSort(gridInstance) {
        if (gridInstance.multiSort && this.hasEnableSortColumns(gridInstance)) {
            return true;
        }
        else {
            if (!this.hasEnableSortColumns(gridInstance)) {
                return this.columnsSortableMsg;
            }
            else if (!gridInstance.multiSort) {
                return this.multiSortMsg;
            }
        }
    }
    /**
     * @private
     * @param {?} gridInstance
     * @return {?}
     */
    hasEnableSortColumns(gridInstance) {
        /** @type {?} */
        const sortColumnsCount = gridInstance.flatColumns.reduce((/**
         * @param {?} c
         * @param {?} r
         * @return {?}
         */
        (c, r) => {
            if (r.sortable) {
                return c + 1;
            }
            return c;
        }), 0);
        return sortColumnsCount > 0;
    }
    /**
     * @private
     * @param {?} grid
     * @return {?}
     */
    isHeaderGroup(grid) {
        /** @type {?} */
        const flag = grid.columns.length > 1;
        if (flag) {
            return this.notSupportHeaderGroupMsg;
        }
        return flag;
    }
    /**
     * @private
     * @param {?} cols
     * @param {?} rowIndex
     * @param {?} colStartIndex
     * @param {?} colCount
     * @param {?=} forSort
     * @return {?}
     */
    getChilds(cols, rowIndex, colStartIndex, colCount, forSort = false) {
        /** @type {?} */
        const childCols = [];
        /** @type {?} */
        let _count = colStartIndex;
        if (!cols[rowIndex]) {
            return [];
        }
        cols[rowIndex].slice().forEach((/**
         * @param {?} element
         * @return {?}
         */
        element => {
            _count = _count + element.colspan;
            if (_count <= colCount) {
                childCols.push(element);
            }
        }));
        cols[rowIndex].splice(0, childCols.length);
        return childCols.map((/**
         * @param {?} c
         * @param {?} i
         * @return {?}
         */
        (c, i) => {
            /** @type {?} */
            let n = {
                data: c,
                selectable: forSort ? !!c.sortable : true
            };
            if (c.colspan && c.colspan > 1) {
                n = {
                    data: c,
                    selectable: false,
                    expanded: true,
                    children: this.getChilds(cols, rowIndex + 1, 0, c.colspan)
                };
            }
            return n;
        }));
    }
    /**
     * @param {?} cols
     * @param {?=} forSort
     * @return {?}
     */
    convertColumns2TreeData(cols, forSort = false) {
        /** @type {?} */
        const columns = cols.map((/**
         * @param {?} c
         * @return {?}
         */
        (c) => {
            c.map((/**
             * @param {?} _
             * @return {?}
             */
            (_) => {
                _.colspan = _.colspan || 1;
                return _;
            }));
            return c;
        }));
        if (columns.length === 1) {
            return columns[0].map((/**
             * @param {?} c
             * @return {?}
             */
            c => {
                return {
                    data: c,
                    selectable: forSort ? !!c.sortable : true
                };
            }));
        }
        else {
            return columns[0].map((/**
             * @param {?} c
             * @param {?} i
             * @return {?}
             */
            (c, i) => {
                if (c.colspan && c.colspan > 1) {
                    return {
                        data: c,
                        selectable: false,
                        expanded: true,
                        children: this.getChilds(columns, 1, 0, c.colspan, forSort)
                    };
                }
                else {
                    return {
                        data: c,
                        selectable: forSort ? !!c.sortable : true
                    };
                }
            }));
        }
    }
    /**
     * @private
     * @param {?} treeNodes
     * @return {?}
     */
    checkViewTreeNodes(treeNodes) {
        treeNodes.forEach((/**
         * @param {?} tn
         * @return {?}
         */
        (tn) => {
            if (!tn.children || !tn.children.length) {
                tn.selectable = true;
            }
            else {
                tn.selectable = false;
                this.checkViewTreeNodes(tn.children);
            }
        }));
    }
    /**
     * @private
     * @param {?} cols
     * @return {?}
     */
    convertColumnsToSimple(cols) {
        // 移除设置列
        return cols.map((/**
         * @param {?} _cols
         * @return {?}
         */
        (_cols) => {
            return _cols.map((/**
             * @param {?} c
             * @return {?}
             */
            (c) => {
                if (c.field !== '_datagrid-setting-control_') {
                    return {
                        field: c.field,
                        title: c.title,
                        colspan: c.colspan,
                        rowspan: c.rowspan,
                        sortable: c.sortable,
                        order: c.order,
                        halign: c.halign || 'left',
                        align: c.align || 'left',
                        visible: c.visible,
                        allowGrouping: c.allowGrouping,
                        groupFooter: c.groupFooter,
                        footer: c.footer,
                        width: c.width || 100,
                        dataType: c.dataType || 'string'
                    };
                }
            })).filter((/**
             * @param {?} n
             * @return {?}
             */
            n => n));
        }));
    }
    /**
     * @private
     * @param {?} gridInstance
     * @return {?}
     */
    resetGridView(gridInstance) {
        if (!gridInstance) {
            return;
        }
        /** @type {?} */
        const dfs = gridInstance.dfs;
        if (dfs) {
            /** @type {?} */
            const options = dfs['_state'].initialOptions;
            if (options.sort) {
                if (options.sort.sortName) {
                    gridInstance.sortName = options.sort.sortName;
                }
                if (options.sort.sortOrder) {
                    gridInstance.sortOrder = options.sort.sortOrder;
                }
            }
            gridInstance.groupField = options.groupField || '';
            // TODO: 还需要修正默认列的显示顺序
            if (options.columnFields && options.columnFields.length) {
                /** @type {?} */
                const newColumns = [];
                options.columnFields.forEach((/**
                 * @param {?} c
                 * @return {?}
                 */
                c => {
                    /** @type {?} */
                    const col = gridInstance.columns[0].find((/**
                     * @param {?} n
                     * @return {?}
                     */
                    (n) => n.field === c.field));
                    if (col) {
                        col.visible = c.visible;
                        col.halign = c.halign;
                        col.align = c.align;
                        col.width = c.width;
                        col.footer = c.footer;
                        col.groupFooter = c.groupFooter;
                        newColumns.push(col);
                    }
                }));
                gridInstance.columns[0] = newColumns;
            }
            // gridInstance['checkOptions']();
            gridInstance['columnsChanged']();
        }
    }
    /**
     * @private
     * @param {?} modalRef
     * @param {?} gridInstance
     * @param {?=} btn
     * @return {?}
     */
    updateGridView(modalRef, gridInstance, btn = null) {
        /** @type {?} */
        const settings = modalRef.content;
        if (settings) {
            /** @type {?} */
            const key = this.createConfigKey(gridInstance.id);
            const { sortInfo, viewColumns, columnFormat, groupFields } = settings;
            this.saving = true;
            /** @type {?} */
            let groupField = '';
            if (gridInstance.groupRows && groupFields && groupFields.length) {
                groupField = groupFields.join(',');
            }
            gridInstance.groupField = groupField;
            this.setUserConfig(key, { sortInfo, viewColumns, groupField, columnFormat }).subscribe((/**
             * @return {?}
             */
            () => {
                if (btn) {
                    btn.disabled = false;
                }
                this.saving = false;
                modalRef.close();
                if (sortInfo && Object.keys(sortInfo).length) {
                    const { sortName, sortOrder } = sortInfo;
                    if (sortName && sortName.length) {
                        gridInstance.sort(sortName.join(','), sortOrder.join(','));
                    }
                    else {
                        gridInstance.clearSort();
                    }
                }
                else {
                    gridInstance.clearSort();
                }
                if (viewColumns && viewColumns.length) {
                    gridInstance.columns = gridInstance.columns.map((/**
                     * @param {?} cols
                     * @return {?}
                     */
                    cols => {
                        this.updateColumnFormat(cols, columnFormat, gridInstance);
                        return this.newVisibleOrderColumns(cols, viewColumns, columnFormat);
                    }));
                }
                gridInstance.columnsChanged(true);
            }));
        }
        else {
            modalRef.close();
        }
    }
    /**
     * @param {?} cols
     * @param {?} viewColumns
     * @param {?} columnFormat
     * @return {?}
     */
    newVisibleOrderColumns(cols, viewColumns, columnFormat) {
        /** @type {?} */
        const hideColumns = [];
        cols.forEach((/**
         * @param {?} element
         * @param {?} index
         * @return {?}
         */
        (element, index) => {
            if (this.isNewAddColumn(element.field, columnFormat) && element.field !== '_datagrid-setting-control_') {
                viewColumns.push(element.field);
            }
            else {
                element.visible = viewColumns.includes(element.field);
                if (!element.visible) {
                    hideColumns.push(element);
                }
            }
        }));
        // 清理不存在的列
        /** @type {?} */
        let newCols = viewColumns.map((/**
         * @param {?} field
         * @return {?}
         */
        field => {
            return cols.find((/**
             * @param {?} c
             * @return {?}
             */
            c => c.field === field));
        })).filter((/**
         * @param {?} n
         * @return {?}
         */
        n => n));
        if (hideColumns.length) {
            newCols = newCols.concat(hideColumns);
        }
        return newCols.filter((/**
         * @param {?} c
         * @return {?}
         */
        c => c && c.field && c.field !== '_datagrid-setting-control_'));
    }
    /**
     * 是否为新增加的字段
     * 新增的字段，需要在列表中展示出来，并保存到个性化设置中
     * @private
     * @param {?} field
     * @param {?} columns
     * @return {?}
     */
    isNewAddColumn(field, columns) {
        return !columns.find((/**
         * @param {?} c
         * @return {?}
         */
        c => c.field === field));
    }
    /**
     * @param {?} cols
     * @param {?} columnFormat
     * @param {?} gridInstance
     * @return {?}
     */
    updateColumnFormat(cols, columnFormat, gridInstance) {
        if (columnFormat && columnFormat.length) {
            cols.forEach((/**
             * @param {?} col
             * @return {?}
             */
            col => {
                /** @type {?} */
                const formatCol = columnFormat.find((/**
                 * @param {?} f
                 * @return {?}
                 */
                f => f.field === col.field));
                if (formatCol) {
                    col.width = formatCol.width;
                    col.halign = formatCol.halign || 'left';
                    col.align = formatCol.align || 'left';
                    if (gridInstance.groupRows && (col.allowGrouping || col.allowGrouping === undefined)) {
                        if (!col.groupFooter) {
                            col.groupFooter = formatCol.groupFooter;
                        }
                        if (col.groupFooter && col.groupFooter.options) {
                            col.groupFooter.options.text = formatCol.groupFooter.options.text || '';
                            col.groupFooter.options.calculationType =
                                formatCol.groupFooter.options.calculationType !== undefined &&
                                    formatCol.groupFooter.options.calculationType !== null ?
                                    parseInt(formatCol.groupFooter.options.calculationType, 10) : -1;
                        }
                    }
                    if (gridInstance.showFooter && !gridInstance.footerTemplate) {
                        if (!col.footer) {
                            col.footer = formatCol.footer;
                        }
                        if (col.footer && col.footer.options) {
                            col.footer.options.text = formatCol.footer.options.text || '';
                            col.footer.options.calculationType =
                                formatCol.footer.options.calculationType !== undefined &&
                                    formatCol.footer.options.calculationType !== null ?
                                    parseInt(formatCol.footer.options.calculationType, 10) : -1;
                        }
                    }
                }
            }));
        }
    }
    // 创建唯一key, 由uri + gridId 组成，并混淆
    /**
     * @private
     * @param {?} gridId
     * @return {?}
     */
    createConfigKey(gridId) {
        /** @type {?} */
        const grid = this.getGridInstance(gridId);
        if (grid) {
            return grid.dgs.createConfigKey(gridId);
        }
        else {
            console.log('DatagridSettingService: Can not find the grid instance.');
        }
    }
    /**
     * @param {?} gridId
     * @return {?}
     */
    saveUserConfig(gridId) {
        /** @type {?} */
        const gridInstance = this.getGridInstance(gridId);
        /** @type {?} */
        const key = this.createConfigKey(gridId);
        /** @type {?} */
        const config = { sortInfo: {}, viewColumns: [], groupField: '', columnFormat: [] };
        if (gridInstance) {
            const { sortName, sortOrder, columns } = gridInstance;
            if (sortName) {
                /** @type {?} */
                const sortInfo = {
                    sortName: sortName.split(','),
                    sortOrder: sortOrder.split(',')
                };
                config.sortInfo = sortInfo;
            }
            /** @type {?} */
            const viewColumns = columns[0].filter((/**
             * @param {?} n
             * @return {?}
             */
            n => n.visible || n.visible === undefined)).map((/**
             * @param {?} n
             * @return {?}
             */
            n => n.field));
            config.viewColumns = viewColumns;
            config.columnFormat = this.convertColumnsToSimple(columns)[0];
            if (gridInstance.groupRows) {
                config.groupField = gridInstance.groupField;
            }
        }
        return this.setUserConfig(key, config);
    }
    /**
     * @param {?} key
     * @param {?} config
     * @return {?}
     */
    setUserConfig(key, config) {
        /** @type {?} */
        const LOCALEID = this.localeSer.localeId;
        /** @type {?} */
        const currentConfig = localStorage.getItem(key);
        /** @type {?} */
        const _config = (currentConfig ? JSON.parse(currentConfig) : {}) || {};
        if (config) {
            if (_config) {
                _config[LOCALEID] = config;
            }
            localStorage.setItem(key, JSON.stringify(_config));
        }
        else {
            localStorage.removeItem(key);
        }
        if (this.httpRestService) {
            // 保存至数据库
            return this._saveUserConfig(key, config ? _config : '');
        }
        return of(true);
    }
    /**
     * @param {?} key
     * @return {?}
     */
    getUserConfig(key) {
        if (this.httpRestService) {
            return this._getUserConfig(key);
        }
        else {
            /** @type {?} */
            const config = localStorage.getItem(key);
            if (config) {
                /** @type {?} */
                const con = JSON.parse(config);
                if (con[this.localeSer.localeId]) {
                    return of(con[this.localeSer.localeId]);
                }
                else {
                    if (Object.keys(con).indexOf('viewColumns') > -1) {
                        return of(con);
                    }
                    return null;
                }
            }
            else {
                return of(null);
            }
        }
    }
    /**
     * @param {?} gridID
     * @return {?}
     */
    getSettings(gridID) {
        /** @type {?} */
        const key = this.createConfigKey(gridID);
        return this.getUserConfig(key);
    }
    /**
     * @private
     * @param {?} key
     * @param {?} config
     * @return {?}
     */
    _saveUserConfig(key, config) {
        try {
            /** @type {?} */
            const userConfigSetting = {
                configkey1: key,
                configkey2: '',
                configkey3: '',
                textvalue: config ? JSON.stringify(config) : ''
            };
            return this.httpRestService.saveUserSettings(userConfigSetting);
        }
        catch (e) {
            console.error(e);
        }
    }
    /**
     * @param {?} gridInstance
     * @param {?} modalRef
     * @return {?}
     */
    resetUserConfig(gridInstance, modalRef) {
        /** @type {?} */
        const restorDefaultText = this.localeSer.getValue('datagrid.settings.restoreDefaultSettingsText') || '确认要恢复默认设置吗？';
        this.messager.confirm(restorDefaultText).pipe(switchMap((/**
         * @param {?} t
         * @return {?}
         */
        (t) => {
            if (t) {
                /** @type {?} */
                const key = this.createConfigKey(gridInstance.id);
                return this.setUserConfig(key, '');
            }
            return of(t);
        }))).subscribe((/**
         * @param {?} t
         * @return {?}
         */
        (t) => {
            if (t) {
                this.resetGridView(gridInstance);
                modalRef.close();
            }
        }));
    }
    /**
     * @private
     * @param {?} key
     * @return {?}
     */
    _getUserConfig(key) {
        try {
            return this.httpRestService.getUserSettings(key).pipe(map((/**
             * @param {?} ucs
             * @return {?}
             */
            (ucs) => {
                if (ucs && ucs.textValue) {
                    /** @type {?} */
                    const c = JSON.parse(ucs.textValue);
                    if (c) {
                        if (c[this.localeSer.localeId]) {
                            localStorage.setItem(key, ucs.textValue);
                            return c[this.localeSer.localeId];
                        }
                        else {
                            localStorage.setItem(key, JSON.stringify({ [this.localeSer.localeId]: c }));
                            if (Object.keys(c).indexOf('viewColumns') > -1) {
                                return c;
                            }
                            return null;
                        }
                    }
                    return null;
                }
                return null;
            })));
        }
        catch (e) {
            console.error(e);
        }
    }
}
DatagridSettingsService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
DatagridSettingsService.ctorParameters = () => [
    { type: Injector },
    { type: BsModalService },
    { type: MessagerService },
    { type: IdService },
    { type: LocaleService }
];
if (false) {
    /**
     * @type {?}
     * @private
     */
    DatagridSettingsService.prototype.multiSortMsg;
    /**
     * @type {?}
     * @private
     */
    DatagridSettingsService.prototype.columnsSortableMsg;
    /**
     * @type {?}
     * @private
     */
    DatagridSettingsService.prototype.notSupportHeaderGroupMsg;
    /**
     * @type {?}
     * @private
     */
    DatagridSettingsService.prototype.notShowDialog;
    /** @type {?} */
    DatagridSettingsService.prototype.httpRestService;
    /** @type {?} */
    DatagridSettingsService.prototype.gridInstance;
    /**
     * @type {?}
     * @private
     */
    DatagridSettingsService.prototype.gridRefs;
    /**
     * @type {?}
     * @private
     */
    DatagridSettingsService.prototype.saving;
    /**
     * @type {?}
     * @private
     */
    DatagridSettingsService.prototype.cfr;
    /**
     * @type {?}
     * @private
     */
    DatagridSettingsService.prototype.app;
    /**
     * @type {?}
     * @private
     */
    DatagridSettingsService.prototype.injector;
    /**
     * @type {?}
     * @private
     */
    DatagridSettingsService.prototype.modalSer;
    /**
     * @type {?}
     * @private
     */
    DatagridSettingsService.prototype.messager;
    /**
     * @type {?}
     * @private
     */
    DatagridSettingsService.prototype.idService;
    /**
     * @type {?}
     * @private
     */
    DatagridSettingsService.prototype.localeSer;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YWdyaWQtc2V0dGluZ3Muc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvdWktZGF0YWdyaWQtc2V0dGluZ3MvIiwic291cmNlcyI6WyJsaWIvZGF0YWdyaWQtc2V0dGluZ3Muc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQU8sTUFBTSxnQkFBZ0IsQ0FBQztBQUNyRCxPQUFPLEVBQWMsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3RDLE9BQU8sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLGNBQWMsRUFBRSx3QkFBd0IsRUFBRSxjQUFjLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFL0csT0FBTyxFQUFFLGNBQWMsRUFBeUMsTUFBTSxrQkFBa0IsQ0FBQztBQUN6RixPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDdEQsT0FBTyxFQUFFLHlCQUF5QixFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFDMUUsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUN0QyxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFFbEQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQzlDLE9BQU8sRUFBRSxzQkFBc0IsRUFBRSxNQUFNLHdDQUF3QyxDQUFDOztBQUVoRixNQUFNLE9BQU8sb0JBQW9CLEdBQUksSUFBSSxjQUFjLENBQUMsMkNBQTJDLENBQUM7QUFHcEcsTUFBTSxPQUFPLHVCQUF1Qjs7Ozs7Ozs7SUFjaEMsWUFBb0IsUUFBa0IsRUFBVSxRQUF3QixFQUNwRCxRQUF5QixFQUFVLFNBQW9CLEVBQ3ZELFNBQXdCO1FBRnhCLGFBQVEsR0FBUixRQUFRLENBQVU7UUFBVSxhQUFRLEdBQVIsUUFBUSxDQUFnQjtRQUNwRCxhQUFRLEdBQVIsUUFBUSxDQUFpQjtRQUFVLGNBQVMsR0FBVCxT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QyxTQUFTLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxFQUFDLENBQUMsQ0FBQyxDQUFDOzRCQUMxRSxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFO2dDQUM1QyxPQUFPLENBQUMsQ0FBQzs2QkFDWjs0QkFDRCxPQUFPLElBQUksQ0FBQzt5QkFDZjtxQkFFSjtvQkFDRCxPQUFPLElBQUksQ0FBQztpQkFDZjtnQkFDRCxPQUFPLElBQUksQ0FBQztZQUNoQixDQUFDLEVBQUMsQ0FDTCxDQUFDO1NBQ0w7UUFBQyxPQUFPLENBQUMsRUFBRTtZQUNSLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDcEI7SUFDTCxDQUFDOzs7WUE1b0JKLFVBQVU7Ozs7WUFiVSxRQUFRO1lBRXBCLGNBQWM7WUFDZCxlQUFlO1lBS2YsU0FBUztZQUZULGFBQWE7Ozs7Ozs7SUFVbEIsK0NBQTZDOzs7OztJQUM3QyxxREFBOEM7Ozs7O0lBQzlDLDJEQUErQzs7Ozs7SUFDL0MsZ0RBQW1EOztJQUVuRCxrREFBNEI7O0lBQzVCLCtDQUF5Qjs7Ozs7SUFDekIsMkNBQTREOzs7OztJQUU1RCx5Q0FBdUI7Ozs7O0lBQ3ZCLHNDQUE2Qzs7Ozs7SUFDN0Msc0NBQW1DOzs7OztJQUN2QiwyQ0FBMEI7Ozs7O0lBQUUsMkNBQWdDOzs7OztJQUM1RCwyQ0FBaUM7Ozs7O0lBQUUsNENBQTRCOzs7OztJQUMvRCw0Q0FBZ0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBtYXAsIHN3aXRjaE1hcCwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBvZiB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBJbmplY3RhYmxlLCBJbmplY3RvciwgSW5qZWN0aW9uVG9rZW4sIENvbXBvbmVudEZhY3RvcnlSZXNvbHZlciwgQXBwbGljYXRpb25SZWYgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgRGF0YWdyaWRDb21wb25lbnQsIERhdGFDb2x1bW4gfSBmcm9tICdAZmFycmlzL3VpLWRhdGFncmlkJztcclxuaW1wb3J0IHsgQnNNb2RhbFNlcnZpY2UsIE1vZGFsT3B0aW9ucywgTW9kYWxDb250YWluZXJDb21wb25lbnQgfSBmcm9tICdAZmFycmlzL3VpLW1vZGFsJztcclxuaW1wb3J0IHsgTWVzc2FnZXJTZXJ2aWNlIH0gZnJvbSAnQGZhcnJpcy91aS1tZXNzYWdlcic7XHJcbmltcG9ydCB7IERhdGFncmlkU2V0dGluZ3NDb21wb25lbnQgfSBmcm9tICcuL2RhdGFncmlkLXNldHRpbmdzLmNvbXBvbmVudCc7XHJcbmltcG9ydCB7IGNsb25lRGVlcCB9IGZyb20gJ2xvZGFzaC1lcyc7XHJcbmltcG9ydCB7IExvY2FsZVNlcnZpY2UgfSBmcm9tICdAZmFycmlzL3VpLWxvY2FsZSc7XHJcbmltcG9ydCB7IFRyZWVOb2RlIH0gZnJvbSAnQGZhcnJpcy91aS10cmVldGFibGUnO1xyXG5pbXBvcnQgeyBJZFNlcnZpY2UgfSBmcm9tICdAZmFycmlzL3VpLWNvbW1vbic7XHJcbmltcG9ydCB7IFNpbXBsZUNvbHVtbnNDb21wb25lbnQgfSBmcm9tICcuL3NpbXBsZS1tb2RlL3NpbXBsZS1jb2x1bW5zLmNvbXBvbmVudCc7XHJcblxyXG5leHBvcnQgY29uc3QgR1JJRF9TRVRUSU5HU19XRUJBUEkgPSAgbmV3IEluamVjdGlvblRva2VuKCcgRmFycmlzIERhdGFHcmlkIFVzZXIgU2V0dGluZyBXZWJBcGkgVVJJLicpO1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgRGF0YWdyaWRTZXR0aW5nc1NlcnZpY2Uge1xyXG5cclxuICAgIHByaXZhdGUgbXVsdGlTb3J0TXNnID0gJ+WIl+ihqOS4reacquW8gOWQr+WkmuWIl+aOkuW6j+eahOWKn+iDveOAgiDor7fmo4Dmn6XvvIEnO1xyXG4gICAgcHJpdmF0ZSBjb2x1bW5zU29ydGFibGVNc2cgPSAn5pyq5byA5ZCv5YiX55qE5o6S5bqP5Yqf6IO944CC6K+35qOA5p+l77yBJztcclxuICAgIHByaXZhdGUgbm90U3VwcG9ydEhlYWRlckdyb3VwTXNnID0gJ+aaguS4jeaUr+aMgeWkmuihqOWktOiuvue9ric7XHJcbiAgICBwcml2YXRlIG5vdFNob3dEaWFsb2cgPSAn5aSa6KGo5aS05pqC5LiN5pSv5oyB5YiX5pi+56S66K6+572u77yb5ZCM5pe25pyq5ZCv55So5YiX5o6S5bqP5Yqf6IO944CCJztcclxuXHJcbiAgICBwdWJsaWMgaHR0cFJlc3RTZXJ2aWNlOiBhbnk7XHJcbiAgICBncmlkSW5zdGFuY2U6IGFueSA9IG51bGw7XHJcbiAgICBwcml2YXRlIGdyaWRSZWZzOiB7W2tleTogc3RyaW5nXTogRGF0YWdyaWRDb21wb25lbnR9ID0gbnVsbDtcclxuXHJcbiAgICBwcml2YXRlIHNhdmluZyA9IGZhbHNlO1xyXG4gICAgcHJpdmF0ZSBjZnI6IENvbXBvbmVudEZhY3RvcnlSZXNvbHZlciA9IG51bGw7XHJcbiAgICBwcml2YXRlIGFwcDogQXBwbGljYXRpb25SZWYgPSBudWxsO1xyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IsIHByaXZhdGUgbW9kYWxTZXI6IEJzTW9kYWxTZXJ2aWNlLFxyXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBtZXNzYWdlcjogTWVzc2FnZXJTZXJ2aWNlLCBwcml2YXRlIGlkU2VydmljZTogSWRTZXJ2aWNlLFxyXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBsb2NhbGVTZXI6IExvY2FsZVNlcnZpY2UpIHtcclxuXHJcbiAgICAgICAgdGhpcy5jZnIgPSB0aGlzLmluamVjdG9yLmdldChDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIpO1xyXG4gICAgICAgIHRoaXMuYXBwID0gdGhpcy5pbmplY3Rvci5nZXQoQXBwbGljYXRpb25SZWYpO1xyXG4gICAgfVxyXG5cclxuICAgIGRlc3Ryb3koaWQ/OiBzdHJpbmcpIHtcclxuICAgICAgICBpZiAoaWQgJiYgdGhpcy5ncmlkUmVmcyAmJiB0aGlzLmdyaWRSZWZzW2lkXSkge1xyXG4gICAgICAgICAgICBkZWxldGUgdGhpcy5ncmlkUmVmc1tpZF07XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5ncmlkUmVmcyA9IG51bGw7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHJlZ2lzdGVyR3JpZEluc3RhbmNlKGRnOiBEYXRhZ3JpZENvbXBvbmVudCkge1xyXG4gICAgICAgIGlmICghZGcpIHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coJ0RhdGFncmlkU2V0dGluZ1NlcnZpY2U6IGdyaWQgaW5zdGFuY2UgaXMgbnVsbC4nKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBpZCA9IGRnLmlkO1xyXG4gICAgICAgIHRoaXMuZ3JpZFJlZnMgPSB0aGlzLmdyaWRSZWZzIHx8IHt9O1xyXG4gICAgICAgIGlmICghdGhpcy5ncmlkUmVmc1tpZF0pIHtcclxuICAgICAgICAgICAgdGhpcy5ncmlkUmVmc1tpZF0gPSBkZztcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0R3JpZEluc3RhbmNlKGRnSUQ6IHN0cmluZykge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmdyaWRSZWZzID8gdGhpcy5ncmlkUmVmc1tkZ0lEXSA6IG51bGw7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0U2VhcmNoVHlwZXMoKSB7XHJcbiAgICAgICAgcmV0dXJuIFtcclxuICAgICAgICAgICAgeyB2YWx1ZTogJ2FsbCcsIHRpdGxlOiB0aGlzLmxvY2FsZVNlci5nZXRWYWx1ZSgnZGF0YWdyaWQuc2V0dGluZ3MuYWxsQ29sdW1ucycpIH0sXHJcbiAgICAgICAgICAgIHsgdmFsdWU6ICd2aXNpYmxlJywgdGl0bGU6IHRoaXMubG9jYWxlU2VyLmdldFZhbHVlKCdkYXRhZ3JpZC5zZXR0aW5ncy52aXNpYmxlQ29sdW1ucycpIH0sXHJcbiAgICAgICAgICAgIHsgdmFsdWU6ICdoaWRkZW4nLCB0aXRsZTogdGhpcy5sb2NhbGVTZXIuZ2V0VmFsdWUoJ2RhdGFncmlkLnNldHRpbmdzLmhpZGRlbkNvbHVtbnMnKSB9XHJcbiAgICAgICAgXTtcclxuICAgIH1cclxuXHJcbiAgICBzaG93U2ltcGxlKGdyaWRJbnN0YW5jZTogRGF0YWdyaWRDb21wb25lbnQpIHtcclxuICAgICAgICBjb25zdCBjb2x1bW5zID0gdGhpcy5jb252ZXJ0Q29sdW1uc1RvU2ltcGxlKGdyaWRJbnN0YW5jZS5jb2x1bW5zKTtcclxuICAgICAgICBjb2x1bW5zWzBdID0gY29sdW1uc1swXS5maWx0ZXIobiA9PiBuLmZpZWxkICYmIG4uZmllbGQgIT09IGdyaWRJbnN0YW5jZS5Db250cm9sUGFuZWxGZWlsZCk7XHJcblxyXG4gICAgICAgIGNvbnN0IHNlYXJjaFR5cGVzID0gdGhpcy5nZXRTZWFyY2hUeXBlcygpO1xyXG5cclxuICAgICAgICBpZiAodGhpcy5jZnIpIHtcclxuICAgICAgICAgICAgY29uc3QgY21wRmFjdG9yeSA9IHRoaXMuY2ZyLnJlc29sdmVDb21wb25lbnRGYWN0b3J5KFNpbXBsZUNvbHVtbnNDb21wb25lbnQpO1xyXG4gICAgICAgICAgICBsZXQgc2ltcGxlUmVmID0gY21wRmFjdG9yeS5jcmVhdGUodGhpcy5pbmplY3Rvcik7XHJcbiAgICAgICAgICAgIHRoaXMuYXBwLmF0dGFjaFZpZXcoc2ltcGxlUmVmLmhvc3RWaWV3KTtcclxuICAgICAgICAgICAgc2ltcGxlUmVmLmluc3RhbmNlLmNvbHVtbnMgPSBjb2x1bW5zO1xyXG4gICAgICAgICAgICBzaW1wbGVSZWYuaW5zdGFuY2Uuc2VhcnRUeXBlcyA9IHNlYXJjaFR5cGVzO1xyXG4gICAgICAgICAgICBzaW1wbGVSZWYuaW5zdGFuY2UuZ3JpZEluc3RhbmNlID0gZ3JpZEluc3RhbmNlO1xyXG5cclxuICAgICAgICAgICAgaWYgKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNwYWdlLXdyYXBwZXInKSkge1xyXG4gICAgICAgICAgICAgICAgc2ltcGxlUmVmLmluc3RhbmNlLnRvcCA9IDc2O1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHNpbXBsZVJlZi5sb2NhdGlvbi5uYXRpdmVFbGVtZW50KTtcclxuXHJcblxyXG4gICAgICAgICAgICBzaW1wbGVSZWYuaW5zdGFuY2UuY2xvc2VkLnN1YnNjcmliZSggKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgc2ltcGxlUmVmLmxvY2F0aW9uLm5hdGl2ZUVsZW1lbnQucmVtb3ZlKCk7XHJcbiAgICAgICAgICAgICAgICBzaW1wbGVSZWYuZGVzdHJveSgpO1xyXG4gICAgICAgICAgICAgICAgc2ltcGxlUmVmID0gbnVsbDtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBzaW1wbGVSZWYuaW5zdGFuY2UuYWR2YW5jZWQuc3Vic2NyaWJlKCgpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMuc2hvd0FkdmFuY2VkKGdyaWRJbnN0YW5jZSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgc2ltcGxlUmVmLmluc3RhbmNlLnN1Ym1pdC5zdWJzY3JpYmUoIChlOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgIGUudGFyZ2V0LmRpc2FibGVkID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLnNhdmluZykge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmICghdGhpcy5zYXZpbmcpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUdyaWRWaWV3KGUsIGdyaWRJbnN0YW5jZSwgZS50YXJnZXQpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIHNpbXBsZVJlZi5ob3N0Vmlldy5kZXRlY3RDaGFuZ2VzKCk7XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gc2ltcGxlUmVmO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcblxyXG4gICAgc2hvdyhncmlkSW5zdGFuY2U6IERhdGFncmlkQ29tcG9uZW50LCBvcHRzPzogTW9kYWxPcHRpb25zKSB7XHJcbiAgICAgICAgdGhpcy5yZWdpc3RlckdyaWRJbnN0YW5jZShncmlkSW5zdGFuY2UpO1xyXG5cclxuICAgICAgICBpZiAoZ3JpZEluc3RhbmNlLmVuYWJsZVNpbXBsZU1vZGUpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2hvd1NpbXBsZShncmlkSW5zdGFuY2UpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnNob3dBZHZhbmNlZChncmlkSW5zdGFuY2UsIG9wdHMpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHNob3dBZHZhbmNlZChncmlkSW5zdGFuY2U6IERhdGFncmlkQ29tcG9uZW50LCBvcHRzPzogTW9kYWxPcHRpb25zKSB7XHJcbiAgICAgICAgbGV0IF9lZGl0Q29sU29ydEluZm8gPSB0cnVlO1xyXG4gICAgICAgIGNvbnN0IGVkaXRDb2xTb3J0SW5mbyA9IHRoaXMuY2FuU2V0Q29sdW1uU29ydChncmlkSW5zdGFuY2UpO1xyXG4gICAgICAgIGlmIChlZGl0Q29sU29ydEluZm8gIT09IHRydWUpIHtcclxuICAgICAgICAgICAgLy8gdGhpcy5tZXNzYWdlci53YXJuaW5nKG1zZyk7XHJcbiAgICAgICAgICAgIC8vIHJldHVybjtcclxuICAgICAgICAgICAgX2VkaXRDb2xTb3J0SW5mbyA9IGZhbHNlO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3Qgc2hvd1NldENvbHVtbnNUYWIgPSAhdGhpcy5pc0hlYWRlckdyb3VwKGdyaWRJbnN0YW5jZSk7XHJcbiAgICAgICAgY29uc3QgZ2V0QWN0aXZlVGFiSW5kZXggPSAoKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChzaG93U2V0Q29sdW1uc1RhYikge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIDE7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoX2VkaXRDb2xTb3J0SW5mbykge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiAyO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gLTE7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG4gICAgICAgIGNvbnN0IGFjdGl2ZVRhYkluZGV4ID0gZ2V0QWN0aXZlVGFiSW5kZXgoKTtcclxuXHJcbiAgICAgICAgaWYgKGFjdGl2ZVRhYkluZGV4ID09PSAtMSkge1xyXG4gICAgICAgICAgICB0aGlzLm1lc3NhZ2VyLndhcm5pbmcodGhpcy5ub3RTaG93RGlhbG9nKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgY29sdW1ucyA9IHRoaXMuY29udmVydENvbHVtbnNUb1NpbXBsZShncmlkSW5zdGFuY2UuY29sdW1ucyk7XHJcbiAgICAgICAgY29sdW1uc1swXSA9IGNvbHVtbnNbMF0uZmlsdGVyKG4gPT4gbi5maWVsZCAmJiBuLmZpZWxkICE9PSBncmlkSW5zdGFuY2UuQ29udHJvbFBhbmVsRmVpbGQpO1xyXG4gICAgICAgIGNvbnN0IHRyZWVEYXRhID0gdGhpcy5jb252ZXJ0Q29sdW1uczJUcmVlRGF0YShjbG9uZURlZXAoY29sdW1ucyksIHRydWUpO1xyXG4gICAgICAgIGNvbnN0IHZpZXdDb2x1bW5zVHJlZURhdGEgPSB0aGlzLmNvbnZlcnRDb2x1bW5zMlRyZWVEYXRhKGNsb25lRGVlcChjb2x1bW5zKSwgZmFsc2UpO1xyXG4gICAgICAgIHRoaXMuY2hlY2tWaWV3VHJlZU5vZGVzKHZpZXdDb2x1bW5zVHJlZURhdGEpO1xyXG5cclxuICAgICAgICBsZXQgbW9kYWxSZWYgPSBudWxsO1xyXG5cclxuICAgICAgICBjb25zdCBva1RleHQgPSB0aGlzLmxvY2FsZVNlci5nZXRWYWx1ZSgnZGF0YWdyaWQuc2V0dGluZ3Mub2snKSB8fCAn56Gu5a6aJztcclxuICAgICAgICBjb25zdCBjYW5jZWxUZXh0ID0gdGhpcy5sb2NhbGVTZXIuZ2V0VmFsdWUoJ2RhdGFncmlkLnNldHRpbmdzLmNhbmNlbCcpIHx8ICflj5bmtognO1xyXG4gICAgICAgIGNvbnN0IHJlc2V0VGV4dCA9ICB0aGlzLmxvY2FsZVNlci5nZXRWYWx1ZSgnZGF0YWdyaWQuc2V0dGluZ3MucmVzZXQnKSB8fCAn6YeN572uJztcclxuXHJcblxyXG4gICAgICAgIGNvbnN0IGRlZmF1bHRPcHRzID0ge1xyXG4gICAgICAgICAgICB3aWR0aDogNzYwLCBoZWlnaHQ6IDU2MCwgc2hvd0hlYWRlcjogZmFsc2UsIHRpdGxlOiAn5o6n5Yi26Z2i5p2/JyxcclxuICAgICAgICAgICAgaW5pdGlhbFN0YXRlOiB7XHJcbiAgICAgICAgICAgICAgICBjb2x1bW5zLFxyXG4gICAgICAgICAgICAgICAgc29ydFRyZWVEYXRhOiB0cmVlRGF0YSxcclxuICAgICAgICAgICAgICAgIHZpZXdUcmVlRGF0YTogdmlld0NvbHVtbnNUcmVlRGF0YSxcclxuICAgICAgICAgICAgICAgIGdyaWRJbnN0YW5jZSxcclxuICAgICAgICAgICAgICAgIGNhblNldENvbHVtblNvcnQ6IF9lZGl0Q29sU29ydEluZm8sXHJcbiAgICAgICAgICAgICAgICBjYW5TZXRDb2x1bW5WaXNpYmxlOiBzaG93U2V0Q29sdW1uc1RhYixcclxuICAgICAgICAgICAgICAgIGFjdGl2ZVRhYkluZGV4XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIHNob3dCdXR0b25zOiBmYWxzZVxyXG4gICAgICAgIH07XHJcbiAgICAgICAgY29uc3QgbW9kYWxPcHRzID0gT2JqZWN0LmFzc2lnbihkZWZhdWx0T3B0cywgb3B0cyB8fCB7fSk7XHJcblxyXG4gICAgICAgIG1vZGFsUmVmID0gdGhpcy5tb2RhbFNlci5zaG93KERhdGFncmlkU2V0dGluZ3NDb21wb25lbnQsIG1vZGFsT3B0cyk7XHJcbiAgICAgICAgY29uc3QgaW5zdGFuY2UgPSBtb2RhbFJlZi5jb250ZW50IGFzIERhdGFncmlkU2V0dGluZ3NDb21wb25lbnQ7XHJcbiAgICAgICAgaW5zdGFuY2UuZW5hYmxlUmVzZXQgPSB0cnVlO1xyXG4gICAgICAgIGluc3RhbmNlLm1vZGFsUmVmID0gbW9kYWxSZWY7XHJcbiAgICAgICAgaW5zdGFuY2UuY2FuU2V0Q29sdW1uU29ydCA9IF9lZGl0Q29sU29ydEluZm87XHJcbiAgICAgICAgaW5zdGFuY2UuY2FuU2V0Q29sdW1uVmlzaWJsZSA9ICF0aGlzLmlzSGVhZGVyR3JvdXAoZ3JpZEluc3RhbmNlKTtcclxuXHJcbiAgICAgICAgaW5zdGFuY2Uuc3VibWl0SGFuZGxlLnN1YnNjcmliZSgoZSkgPT4ge1xyXG4gICAgICAgICAgICBlLnRhcmdldC5kaXNhYmxlZCA9IHRydWU7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLnNhdmluZykge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmICghdGhpcy5zYXZpbmcpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlR3JpZFZpZXcobW9kYWxSZWYsIGdyaWRJbnN0YW5jZSwgZS50YXJnZXQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGluc3RhbmNlLmNhbmNlbEhhbmRsZS5zdWJzY3JpYmUoKGUpID0+IHtcclxuICAgICAgICAgICAgbW9kYWxSZWYuY2xvc2UoKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgaW5zdGFuY2UuY29uY2lzZS5zdWJzY3JpYmUoKGUpID0+IHtcclxuICAgICAgICAgICAgbW9kYWxSZWYuY2xvc2UoKTtcclxuICAgICAgICAgICAgdGhpcy5zaG93U2ltcGxlKGdyaWRJbnN0YW5jZSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGNvbnN0IG1vZGFsQ29udGFpbmVyID0gbW9kYWxSZWYuZGlhbG9nLmluc3RhbmNlIGFzIE1vZGFsQ29udGFpbmVyQ29tcG9uZW50O1xyXG4gICAgICAgIG1vZGFsQ29udGFpbmVyLmRyYWdnYmFyLmhhbmRsZSA9IGluc3RhbmNlLmhlYWRlci5uYXRpdmVFbGVtZW50O1xyXG4gICAgICAgIHJldHVybiBtb2RhbFJlZjtcclxuICAgIH1cclxuXHJcblxyXG5cclxuICAgIHByaXZhdGUgY2FuU2V0Q29sdW1uU29ydChncmlkSW5zdGFuY2U6IERhdGFncmlkQ29tcG9uZW50KSB7XHJcbiAgICAgICAgaWYgKGdyaWRJbnN0YW5jZS5tdWx0aVNvcnQgJiYgdGhpcy5oYXNFbmFibGVTb3J0Q29sdW1ucyhncmlkSW5zdGFuY2UpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlmICghdGhpcy5oYXNFbmFibGVTb3J0Q29sdW1ucyhncmlkSW5zdGFuY2UpKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jb2x1bW5zU29ydGFibGVNc2c7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoIWdyaWRJbnN0YW5jZS5tdWx0aVNvcnQpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLm11bHRpU29ydE1zZztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGhhc0VuYWJsZVNvcnRDb2x1bW5zKGdyaWRJbnN0YW5jZTogRGF0YWdyaWRDb21wb25lbnQpIHtcclxuICAgICAgICBjb25zdCBzb3J0Q29sdW1uc0NvdW50ID0gZ3JpZEluc3RhbmNlLmZsYXRDb2x1bW5zLnJlZHVjZSgoYywgcikgPT4ge1xyXG4gICAgICAgICAgICBpZiAoci5zb3J0YWJsZSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGMgKyAxO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBjO1xyXG4gICAgICAgIH0sIDApO1xyXG5cclxuICAgICAgICByZXR1cm4gc29ydENvbHVtbnNDb3VudCA+IDA7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBpc0hlYWRlckdyb3VwKGdyaWQ6IERhdGFncmlkQ29tcG9uZW50KSB7XHJcbiAgICAgICAgY29uc3QgZmxhZyA9IGdyaWQuY29sdW1ucy5sZW5ndGggPiAxO1xyXG4gICAgICAgIGlmIChmbGFnKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLm5vdFN1cHBvcnRIZWFkZXJHcm91cE1zZztcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGZsYWc7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXRDaGlsZHMoY29scywgcm93SW5kZXgsIGNvbFN0YXJ0SW5kZXgsIGNvbENvdW50LCBmb3JTb3J0ID0gZmFsc2UpIHtcclxuICAgICAgICBjb25zdCBjaGlsZENvbHMgPSBbXTtcclxuICAgICAgICBsZXQgX2NvdW50ID0gY29sU3RhcnRJbmRleDtcclxuICAgICAgICBpZiAoIWNvbHNbcm93SW5kZXhdKSB7XHJcbiAgICAgICAgICAgIHJldHVybiAgW107XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb2xzW3Jvd0luZGV4XS5zbGljZSgpLmZvckVhY2goZWxlbWVudCA9PiB7XHJcbiAgICAgICAgICAgIF9jb3VudCA9IF9jb3VudCArIGVsZW1lbnQuY29sc3BhbjtcclxuICAgICAgICAgICAgaWYgKCBfY291bnQgPD0gY29sQ291bnQgKSB7XHJcbiAgICAgICAgICAgICAgICBjaGlsZENvbHMucHVzaChlbGVtZW50KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBjb2xzW3Jvd0luZGV4XS5zcGxpY2UoMCwgY2hpbGRDb2xzLmxlbmd0aCk7XHJcblxyXG4gICAgICAgIHJldHVybiBjaGlsZENvbHMubWFwKChjLCBpKSA9PiB7XHJcbiAgICAgICAgICAgIGxldCBuOiBhbnkgPSB7XHJcbiAgICAgICAgICAgICAgICBkYXRhOiBjLFxyXG4gICAgICAgICAgICAgICAgc2VsZWN0YWJsZTogZm9yU29ydCA/ICEhYy5zb3J0YWJsZSA6IHRydWVcclxuICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgIGlmIChjLmNvbHNwYW4gJiYgYy5jb2xzcGFuID4gMSkge1xyXG4gICAgICAgICAgICAgICAgbiA9IHtcclxuICAgICAgICAgICAgICAgICAgICBkYXRhOiBjLFxyXG4gICAgICAgICAgICAgICAgICAgIHNlbGVjdGFibGU6IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgICAgIGV4cGFuZGVkOiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgICAgIGNoaWxkcmVuOiB0aGlzLmdldENoaWxkcyhjb2xzLCByb3dJbmRleCArIDEsIDAgLCBjLmNvbHNwYW4pXHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBuO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgY29udmVydENvbHVtbnMyVHJlZURhdGEoY29sczogRGF0YUNvbHVtbltdW10sIGZvclNvcnQgPSBmYWxzZSkge1xyXG4gICAgICAgIGNvbnN0IGNvbHVtbnMgPSBjb2xzLm1hcCgoYzogYW55KSA9PiB7XHJcbiAgICAgICAgICAgIGMubWFwKChfKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBfLmNvbHNwYW4gPSBfLmNvbHNwYW4gfHwgMTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBfO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgcmV0dXJuIGM7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgaWYgKGNvbHVtbnMubGVuZ3RoID09PSAxKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBjb2x1bW5zWzBdLm1hcChjID0+IHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICAgICAgZGF0YTogYyxcclxuICAgICAgICAgICAgICAgICAgICBzZWxlY3RhYmxlOiBmb3JTb3J0ID8gISFjLnNvcnRhYmxlIDogdHJ1ZVxyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuIGNvbHVtbnNbMF0ubWFwKChjLCBpKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoYy5jb2xzcGFuICYmIGMuY29sc3BhbiA+IDEpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkYXRhOiBjLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RhYmxlOiBmYWxzZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgZXhwYW5kZWQ6IHRydWUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkcmVuOiB0aGlzLmdldENoaWxkcyhjb2x1bW5zLCAxLCAwLCBjLmNvbHNwYW4sIGZvclNvcnQpXHJcbiAgICAgICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZGF0YTogYyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0YWJsZTogZm9yU29ydCA/ICEhYy5zb3J0YWJsZSA6IHRydWVcclxuICAgICAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG5cclxuICAgIHByaXZhdGUgY2hlY2tWaWV3VHJlZU5vZGVzKHRyZWVOb2RlczogVHJlZU5vZGVbXSkge1xyXG4gICAgICAgIHRyZWVOb2Rlcy5mb3JFYWNoKCh0bjogVHJlZU5vZGUpID0+IHtcclxuICAgICAgICAgICAgaWYgKCF0bi5jaGlsZHJlbiB8fCAhdG4uY2hpbGRyZW4ubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICB0bi5zZWxlY3RhYmxlID0gdHJ1ZTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRuLnNlbGVjdGFibGUgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgIHRoaXMuY2hlY2tWaWV3VHJlZU5vZGVzKHRuLmNoaWxkcmVuKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgY29udmVydENvbHVtbnNUb1NpbXBsZShjb2xzOiBhbnkpIHtcclxuICAgICAgICAvLyDnp7vpmaTorr7nva7liJdcclxuICAgICAgICByZXR1cm4gY29scy5tYXAoIChfY29sczogRGF0YUNvbHVtbltdKSA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiBfY29scy5tYXAoIChjOiBEYXRhQ29sdW1uKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoYy5maWVsZCAhPT0gJ19kYXRhZ3JpZC1zZXR0aW5nLWNvbnRyb2xfJykge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZpZWxkOiBjLmZpZWxkLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aXRsZTogYy50aXRsZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29sc3BhbjogYy5jb2xzcGFuLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICByb3dzcGFuOiBjLnJvd3NwYW4sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNvcnRhYmxlOiBjLnNvcnRhYmxlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBvcmRlcjogYy5vcmRlcixcclxuICAgICAgICAgICAgICAgICAgICAgICAgaGFsaWduOiBjLmhhbGlnbiB8fCAnbGVmdCcsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGFsaWduOiBjLmFsaWduIHx8ICdsZWZ0JyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmlzaWJsZTogYy52aXNpYmxlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBhbGxvd0dyb3VwaW5nOiBjLmFsbG93R3JvdXBpbmcsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGdyb3VwRm9vdGVyOiBjLmdyb3VwRm9vdGVyLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBmb290ZXI6IGMuZm9vdGVyLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB3aWR0aDogYy53aWR0aCB8fCAxMDAsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFUeXBlOiBjLmRhdGFUeXBlIHx8ICdzdHJpbmcnXHJcbiAgICAgICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSkuZmlsdGVyKG4gPT4gbik7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSByZXNldEdyaWRWaWV3KGdyaWRJbnN0YW5jZTogYW55KSB7XHJcbiAgICAgICAgaWYgKCFncmlkSW5zdGFuY2UpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBkZnMgPSBncmlkSW5zdGFuY2UuZGZzO1xyXG4gICAgICAgIGlmIChkZnMpIHtcclxuICAgICAgICAgICAgY29uc3Qgb3B0aW9ucyA9IGRmc1snX3N0YXRlJ10uaW5pdGlhbE9wdGlvbnM7XHJcblxyXG4gICAgICAgICAgICBpZiAob3B0aW9ucy5zb3J0KSB7XHJcbiAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5zb3J0LnNvcnROYW1lKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZ3JpZEluc3RhbmNlLnNvcnROYW1lID0gb3B0aW9ucy5zb3J0LnNvcnROYW1lO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuc29ydC5zb3J0T3JkZXIpIHtcclxuICAgICAgICAgICAgICAgICAgICBncmlkSW5zdGFuY2Uuc29ydE9yZGVyID0gb3B0aW9ucy5zb3J0LnNvcnRPcmRlcjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgZ3JpZEluc3RhbmNlLmdyb3VwRmllbGQgPSBvcHRpb25zLmdyb3VwRmllbGQgfHwgJyc7XHJcbiAgICAgICAgICAgIC8vIFRPRE86IOi/mOmcgOimgeS/ruato+m7mOiupOWIl+eahOaYvuekuumhuuW6j1xyXG4gICAgICAgICAgICBpZiAob3B0aW9ucy5jb2x1bW5GaWVsZHMgJiYgb3B0aW9ucy5jb2x1bW5GaWVsZHMubGVuZ3RoKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgY29uc3QgbmV3Q29sdW1ucyA9IFtdO1xyXG4gICAgICAgICAgICAgICAgb3B0aW9ucy5jb2x1bW5GaWVsZHMuZm9yRWFjaChjID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBjb2wgPSBncmlkSW5zdGFuY2UuY29sdW1uc1swXS5maW5kKChuOiBhbnkpID0+IG4uZmllbGQgPT09IGMuZmllbGQpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChjb2wpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29sLnZpc2libGUgPSBjLnZpc2libGU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbC5oYWxpZ24gPSBjLmhhbGlnbjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29sLmFsaWduID0gYy5hbGlnbjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29sLndpZHRoID0gYy53aWR0aDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29sLmZvb3RlciA9IGMuZm9vdGVyO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb2wuZ3JvdXBGb290ZXIgPSBjLmdyb3VwRm9vdGVyO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBuZXdDb2x1bW5zLnB1c2goY29sKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICBncmlkSW5zdGFuY2UuY29sdW1uc1swXSA9IG5ld0NvbHVtbnM7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIC8vIGdyaWRJbnN0YW5jZVsnY2hlY2tPcHRpb25zJ10oKTtcclxuICAgICAgICAgICAgZ3JpZEluc3RhbmNlWydjb2x1bW5zQ2hhbmdlZCddKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgdXBkYXRlR3JpZFZpZXcobW9kYWxSZWYsIGdyaWRJbnN0YW5jZSwgYnRuID0gbnVsbCkge1xyXG4gICAgICAgIGNvbnN0IHNldHRpbmdzID0gbW9kYWxSZWYuY29udGVudDtcclxuXHJcbiAgICAgICAgaWYgKHNldHRpbmdzKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGtleSA9IHRoaXMuY3JlYXRlQ29uZmlnS2V5KGdyaWRJbnN0YW5jZS5pZCk7XHJcbiAgICAgICAgICAgIGNvbnN0IHsgc29ydEluZm8sIHZpZXdDb2x1bW5zLCBjb2x1bW5Gb3JtYXQsIGdyb3VwRmllbGRzIH0gPSBzZXR0aW5ncztcclxuXHJcbiAgICAgICAgICAgIHRoaXMuc2F2aW5nID0gdHJ1ZTtcclxuXHJcbiAgICAgICAgICAgIGxldCBncm91cEZpZWxkID0gJyc7XHJcbiAgICAgICAgICAgIGlmIChncmlkSW5zdGFuY2UuZ3JvdXBSb3dzICYmIGdyb3VwRmllbGRzICYmIGdyb3VwRmllbGRzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgZ3JvdXBGaWVsZCA9IGdyb3VwRmllbGRzLmpvaW4oJywnKSA7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZ3JpZEluc3RhbmNlLmdyb3VwRmllbGQgPSBncm91cEZpZWxkO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5zZXRVc2VyQ29uZmlnKGtleSwgeyBzb3J0SW5mbywgdmlld0NvbHVtbnMsIGdyb3VwRmllbGQsIGNvbHVtbkZvcm1hdCB9KS5zdWJzY3JpYmUoICgpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChidG4pIHtcclxuICAgICAgICAgICAgICAgICAgICBidG4uZGlzYWJsZWQgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHRoaXMuc2F2aW5nID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICBtb2RhbFJlZi5jbG9zZSgpO1xyXG5cclxuICAgICAgICAgICAgICAgIGlmIChzb3J0SW5mbyAmJiBPYmplY3Qua2V5cyhzb3J0SW5mbykubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgeyBzb3J0TmFtZSwgc29ydE9yZGVyIH0gPSBzb3J0SW5mbztcclxuICAgICAgICAgICAgICAgICAgICBpZiAoc29ydE5hbWUgJiYgc29ydE5hbWUubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGdyaWRJbnN0YW5jZS5zb3J0KHNvcnROYW1lLmpvaW4oJywnKSwgc29ydE9yZGVyLmpvaW4oJywnKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZ3JpZEluc3RhbmNlLmNsZWFyU29ydCgpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZ3JpZEluc3RhbmNlLmNsZWFyU29ydCgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGlmICh2aWV3Q29sdW1ucyAmJiB2aWV3Q29sdW1ucy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgICAgICBncmlkSW5zdGFuY2UuY29sdW1ucyA9IGdyaWRJbnN0YW5jZS5jb2x1bW5zLm1hcChjb2xzID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy51cGRhdGVDb2x1bW5Gb3JtYXQoY29scywgY29sdW1uRm9ybWF0LCBncmlkSW5zdGFuY2UpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5uZXdWaXNpYmxlT3JkZXJDb2x1bW5zKGNvbHMsIHZpZXdDb2x1bW5zLCBjb2x1bW5Gb3JtYXQpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGdyaWRJbnN0YW5jZS5jb2x1bW5zQ2hhbmdlZCh0cnVlKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgbW9kYWxSZWYuY2xvc2UoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG5cclxuICAgIG5ld1Zpc2libGVPcmRlckNvbHVtbnMoY29sczogYW55LCB2aWV3Q29sdW1uczogYW55LCBjb2x1bW5Gb3JtYXQ6IGFueSkge1xyXG4gICAgICAgIGNvbnN0IGhpZGVDb2x1bW5zID0gW107XHJcbiAgICAgICAgY29scy5mb3JFYWNoKChlbGVtZW50LCBpbmRleCkgPT4ge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5pc05ld0FkZENvbHVtbihlbGVtZW50LmZpZWxkLCBjb2x1bW5Gb3JtYXQpICYmIGVsZW1lbnQuZmllbGQgIT09ICdfZGF0YWdyaWQtc2V0dGluZy1jb250cm9sXycpIHtcclxuICAgICAgICAgICAgICAgIHZpZXdDb2x1bW5zLnB1c2goZWxlbWVudC5maWVsZCk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBlbGVtZW50LnZpc2libGUgPSB2aWV3Q29sdW1ucy5pbmNsdWRlcyhlbGVtZW50LmZpZWxkKTtcclxuICAgICAgICAgICAgICAgIGlmICghZWxlbWVudC52aXNpYmxlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaGlkZUNvbHVtbnMucHVzaChlbGVtZW50KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICAvLyDmuIXnkIbkuI3lrZjlnKjnmoTliJdcclxuICAgICAgICBsZXQgbmV3Q29scyA9IHZpZXdDb2x1bW5zLm1hcCggZmllbGQgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gY29scy5maW5kKGMgPT4gYy5maWVsZCA9PT0gZmllbGQpO1xyXG4gICAgICAgIH0pLmZpbHRlcihuID0+IG4pO1xyXG5cclxuICAgICAgICBpZiAoaGlkZUNvbHVtbnMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIG5ld0NvbHMgPSBuZXdDb2xzLmNvbmNhdChoaWRlQ29sdW1ucyk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gbmV3Q29scy5maWx0ZXIoYyA9PiBjICYmIGMuZmllbGQgJiYgYy5maWVsZCAhPT0gJ19kYXRhZ3JpZC1zZXR0aW5nLWNvbnRyb2xfJyApO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5piv5ZCm5Li65paw5aKe5Yqg55qE5a2X5q61XHJcbiAgICAgKiDmlrDlop7nmoTlrZfmrrXvvIzpnIDopoHlnKjliJfooajkuK3lsZXnpLrlh7rmnaXvvIzlubbkv53lrZjliLDkuKrmgKfljJborr7nva7kuK1cclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBpc05ld0FkZENvbHVtbihmaWVsZDogYW55LCBjb2x1bW5zOiBhbnkpIHtcclxuICAgICAgICByZXR1cm4gIWNvbHVtbnMuZmluZChjID0+IGMuZmllbGQgPT09IGZpZWxkKTtcclxuICAgIH1cclxuXHJcblxyXG4gICAgdXBkYXRlQ29sdW1uRm9ybWF0KGNvbHM6IGFueVtdLCBjb2x1bW5Gb3JtYXQ6IGFueVtdLCBncmlkSW5zdGFuY2UpIHtcclxuICAgICAgICBpZiAoY29sdW1uRm9ybWF0ICYmIGNvbHVtbkZvcm1hdC5sZW5ndGgpIHtcclxuICAgICAgICAgICAgY29scy5mb3JFYWNoKGNvbCA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBmb3JtYXRDb2wgPSBjb2x1bW5Gb3JtYXQuZmluZChmPT4gZi5maWVsZCA9PT0gY29sLmZpZWxkKTtcclxuICAgICAgICAgICAgICAgIGlmIChmb3JtYXRDb2wpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb2wud2lkdGggPSBmb3JtYXRDb2wud2lkdGg7XHJcbiAgICAgICAgICAgICAgICAgICAgY29sLmhhbGlnbiA9IGZvcm1hdENvbC5oYWxpZ24gfHwgJ2xlZnQnO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbC5hbGlnbiA9IGZvcm1hdENvbC5hbGlnbiB8fCAnbGVmdCc7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChncmlkSW5zdGFuY2UuZ3JvdXBSb3dzICYmIChjb2wuYWxsb3dHcm91cGluZyB8fCBjb2wuYWxsb3dHcm91cGluZyA9PT0gdW5kZWZpbmVkKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWNvbC5ncm91cEZvb3Rlcikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sLmdyb3VwRm9vdGVyID0gZm9ybWF0Q29sLmdyb3VwRm9vdGVyO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29sLmdyb3VwRm9vdGVyICYmIGNvbC5ncm91cEZvb3Rlci5vcHRpb25zKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2wuZ3JvdXBGb290ZXIub3B0aW9ucy50ZXh0ID0gZm9ybWF0Q29sLmdyb3VwRm9vdGVyLm9wdGlvbnMudGV4dCB8fCAnJztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbC5ncm91cEZvb3Rlci5vcHRpb25zLmNhbGN1bGF0aW9uVHlwZSA9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9ybWF0Q29sLmdyb3VwRm9vdGVyLm9wdGlvbnMuY2FsY3VsYXRpb25UeXBlICE9PSB1bmRlZmluZWQgJiZcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JtYXRDb2wuZ3JvdXBGb290ZXIub3B0aW9ucy5jYWxjdWxhdGlvblR5cGUgIT09IG51bGwgP1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcnNlSW50KGZvcm1hdENvbC5ncm91cEZvb3Rlci5vcHRpb25zLmNhbGN1bGF0aW9uVHlwZSwgMTApIDogLTE7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChncmlkSW5zdGFuY2Uuc2hvd0Zvb3RlciAmJiAhZ3JpZEluc3RhbmNlLmZvb3RlclRlbXBsYXRlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghY29sLmZvb3Rlcikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sLmZvb3RlciA9IGZvcm1hdENvbC5mb290ZXI7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb2wuZm9vdGVyICYmIGNvbC5mb290ZXIub3B0aW9ucykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sLmZvb3Rlci5vcHRpb25zLnRleHQgPSBmb3JtYXRDb2wuZm9vdGVyLm9wdGlvbnMudGV4dCB8fCAnJztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbC5mb290ZXIub3B0aW9ucy5jYWxjdWxhdGlvblR5cGUgPVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1hdENvbC5mb290ZXIub3B0aW9ucy5jYWxjdWxhdGlvblR5cGUgIT09IHVuZGVmaW5lZCAmJlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1hdENvbC5mb290ZXIub3B0aW9ucy5jYWxjdWxhdGlvblR5cGUgIT09IG51bGwgP1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcnNlSW50KGZvcm1hdENvbC5mb290ZXIub3B0aW9ucy5jYWxjdWxhdGlvblR5cGUsIDEwKSA6IC0xO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLy8g5Yib5bu65ZSv5LiAa2V5LCDnlLF1cmkgKyBncmlkSWQg57uE5oiQ77yM5bm25re35reGXHJcbiAgICBwcml2YXRlIGNyZWF0ZUNvbmZpZ0tleShncmlkSWQ6IHN0cmluZykge1xyXG4gICAgICAgIGNvbnN0IGdyaWQgPSB0aGlzLmdldEdyaWRJbnN0YW5jZShncmlkSWQpO1xyXG4gICAgICAgIGlmIChncmlkKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBncmlkLmRncy5jcmVhdGVDb25maWdLZXkoZ3JpZElkKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZygnRGF0YWdyaWRTZXR0aW5nU2VydmljZTogQ2FuIG5vdCBmaW5kIHRoZSBncmlkIGluc3RhbmNlLicpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICB9XHJcblxyXG4gICAgc2F2ZVVzZXJDb25maWcoZ3JpZElkOiBzdHJpbmcpIHtcclxuICAgICAgICBjb25zdCBncmlkSW5zdGFuY2UgPSB0aGlzLmdldEdyaWRJbnN0YW5jZShncmlkSWQpO1xyXG4gICAgICAgIGNvbnN0IGtleSA9IHRoaXMuY3JlYXRlQ29uZmlnS2V5KGdyaWRJZCk7XHJcbiAgICAgICAgY29uc3QgY29uZmlnID0ge3NvcnRJbmZvOiB7fSwgdmlld0NvbHVtbnM6IFtdLCBncm91cEZpZWxkOiAnJywgY29sdW1uRm9ybWF0OiBbXX07XHJcblxyXG4gICAgICAgIGlmIChncmlkSW5zdGFuY2UpIHtcclxuICAgICAgICAgICAgY29uc3QgeyBzb3J0TmFtZSwgc29ydE9yZGVyLCBjb2x1bW5zfSA9IGdyaWRJbnN0YW5jZTtcclxuICAgICAgICAgICAgaWYgKHNvcnROYW1lKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBzb3J0SW5mbyA9IHtcclxuICAgICAgICAgICAgICAgICAgICBzb3J0TmFtZTogc29ydE5hbWUuc3BsaXQoJywnKSxcclxuICAgICAgICAgICAgICAgICAgICBzb3J0T3JkZXI6IHNvcnRPcmRlci5zcGxpdCgnLCcpXHJcbiAgICAgICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgICAgIGNvbmZpZy5zb3J0SW5mbyA9IHNvcnRJbmZvO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBjb25zdCB2aWV3Q29sdW1ucyA9IGNvbHVtbnNbMF0uZmlsdGVyKG4gPT4gbi52aXNpYmxlIHx8IG4udmlzaWJsZSA9PT0gdW5kZWZpbmVkKS5tYXAobiA9PiBuLmZpZWxkKTtcclxuICAgICAgICAgICAgY29uZmlnLnZpZXdDb2x1bW5zID0gdmlld0NvbHVtbnM7XHJcbiAgICAgICAgICAgIGNvbmZpZy5jb2x1bW5Gb3JtYXQgPSB0aGlzLmNvbnZlcnRDb2x1bW5zVG9TaW1wbGUoY29sdW1ucylbMF07XHJcblxyXG4gICAgICAgICAgICBpZiAoZ3JpZEluc3RhbmNlLmdyb3VwUm93cykge1xyXG4gICAgICAgICAgICAgICAgY29uZmlnLmdyb3VwRmllbGQgPSBncmlkSW5zdGFuY2UuZ3JvdXBGaWVsZDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHRoaXMuc2V0VXNlckNvbmZpZyhrZXksIGNvbmZpZyk7XHJcbiAgICB9XHJcblxyXG4gICAgc2V0VXNlckNvbmZpZyhrZXk6IHN0cmluZywgY29uZmlnOiBhbnkpOiBPYnNlcnZhYmxlPGFueT4ge1xyXG5cclxuICAgICAgICBjb25zdCBMT0NBTEVJRCA9IHRoaXMubG9jYWxlU2VyLmxvY2FsZUlkO1xyXG4gICAgICAgIGNvbnN0IGN1cnJlbnRDb25maWcgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShrZXkpO1xyXG4gICAgICAgIGNvbnN0IF9jb25maWcgPSAoY3VycmVudENvbmZpZyA/IEpTT04ucGFyc2UoY3VycmVudENvbmZpZykgOiB7IH0pIHx8IHt9O1xyXG4gICAgICAgIGlmIChjb25maWcpIHtcclxuICAgICAgICAgICAgaWYgKF9jb25maWcpIHtcclxuICAgICAgICAgICAgICAgIF9jb25maWdbTE9DQUxFSURdID0gY29uZmlnO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShrZXksIEpTT04uc3RyaW5naWZ5KF9jb25maWcpKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbShrZXkpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodGhpcy5odHRwUmVzdFNlcnZpY2UpIHtcclxuICAgICAgICAgICAgLy8g5L+d5a2Y6Iez5pWw5o2u5bqTXHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLl9zYXZlVXNlckNvbmZpZyhrZXksICBjb25maWcgPyBfY29uZmlnIDogICcnKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBvZih0cnVlKTtcclxuICAgIH1cclxuXHJcbiAgICBnZXRVc2VyQ29uZmlnKGtleSk6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICAgICAgaWYgKHRoaXMuaHR0cFJlc3RTZXJ2aWNlKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLl9nZXRVc2VyQ29uZmlnKGtleSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgY29uc3QgY29uZmlnID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oa2V5KTtcclxuICAgICAgICAgICAgaWYgKGNvbmZpZykge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgY29uID0gSlNPTi5wYXJzZShjb25maWcpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGNvblt0aGlzLmxvY2FsZVNlci5sb2NhbGVJZF0pIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gb2YoY29uW3RoaXMubG9jYWxlU2VyLmxvY2FsZUlkXSk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChPYmplY3Qua2V5cyhjb24pLmluZGV4T2YoJ3ZpZXdDb2x1bW5zJykgPiAtMSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gb2YoY29uKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gb2YobnVsbCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0U2V0dGluZ3MoZ3JpZElEOiBzdHJpbmcpIHtcclxuICAgICAgICBjb25zdCBrZXkgPSB0aGlzLmNyZWF0ZUNvbmZpZ0tleShncmlkSUQpO1xyXG4gICAgICAgIHJldHVybiB0aGlzLmdldFVzZXJDb25maWcoa2V5KTtcclxuICAgIH1cclxuXHJcblxyXG4gICAgcHJpdmF0ZSBfc2F2ZVVzZXJDb25maWcoa2V5LCBjb25maWcpIHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBjb25zdCB1c2VyQ29uZmlnU2V0dGluZyA9IHtcclxuICAgICAgICAgICAgICAgIGNvbmZpZ2tleTE6IGtleSxcclxuICAgICAgICAgICAgICAgIGNvbmZpZ2tleTI6ICcnLFxyXG4gICAgICAgICAgICAgICAgY29uZmlna2V5MzogJycsXHJcbiAgICAgICAgICAgICAgICB0ZXh0dmFsdWU6IGNvbmZpZyA/IEpTT04uc3RyaW5naWZ5KGNvbmZpZykgOiAgJydcclxuICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmh0dHBSZXN0U2VydmljZS5zYXZlVXNlclNldHRpbmdzKHVzZXJDb25maWdTZXR0aW5nKTtcclxuICAgICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHJlc2V0VXNlckNvbmZpZyhncmlkSW5zdGFuY2UsIG1vZGFsUmVmKSB7XHJcbiAgICAgICAgY29uc3QgcmVzdG9yRGVmYXVsdFRleHQgPSB0aGlzLmxvY2FsZVNlci5nZXRWYWx1ZSgnZGF0YWdyaWQuc2V0dGluZ3MucmVzdG9yZURlZmF1bHRTZXR0aW5nc1RleHQnKSB8fCAn56Gu6K6k6KaB5oGi5aSN6buY6K6k6K6+572u5ZCX77yfJztcclxuICAgICAgICB0aGlzLm1lc3NhZ2VyLmNvbmZpcm0ocmVzdG9yRGVmYXVsdFRleHQpLnBpcGUoXHJcbiAgICAgICAgICAgIHN3aXRjaE1hcCggKHQ6IGJvb2xlYW4pID0+IHtcclxuICAgICAgICAgICAgICAgIGlmICh0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qga2V5ID0gdGhpcy5jcmVhdGVDb25maWdLZXkoZ3JpZEluc3RhbmNlLmlkKTtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5zZXRVc2VyQ29uZmlnKGtleSwgJycpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIG9mKHQpO1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICkuc3Vic2NyaWJlKCh0OiBib29sZWFuKSA9PiB7XHJcbiAgICAgICAgICAgIGlmICh0KSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlc2V0R3JpZFZpZXcoZ3JpZEluc3RhbmNlKTtcclxuICAgICAgICAgICAgICAgIG1vZGFsUmVmLmNsb3NlKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIF9nZXRVc2VyQ29uZmlnKGtleSkge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmh0dHBSZXN0U2VydmljZS5nZXRVc2VyU2V0dGluZ3Moa2V5KS5waXBlKFxyXG4gICAgICAgICAgICAgICAgbWFwKCh1Y3M6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh1Y3MgJiYgdWNzLnRleHRWYWx1ZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjID0gSlNPTi5wYXJzZSh1Y3MudGV4dFZhbHVlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGMpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjW3RoaXMubG9jYWxlU2VyLmxvY2FsZUlkXSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKGtleSwgdWNzLnRleHRWYWx1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNbdGhpcy5sb2NhbGVTZXIubG9jYWxlSWRdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShrZXksIEpTT04uc3RyaW5naWZ5KHtbdGhpcy5sb2NhbGVTZXIubG9jYWxlSWRdOiBjfSkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChPYmplY3Qua2V5cyhjKS5pbmRleE9mKCd2aWV3Q29sdW1ucycpID4gLTEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGM7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgY29uc29sZS5lcnJvcihlKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG59XHJcbiJdfQ==