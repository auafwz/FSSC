/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { cloneDeep } from 'lodash-es';
import { FavoriteAction, LookupGridDisplayType } from '../lookup-displaytype';
import { of } from 'rxjs';
import { map, switchMap, tap } from 'rxjs/operators';
// 帮助默认个性化数据
/** @type {?} */
var DefaultUserConfig = {
    tabIndex: 'datalist',
    favorite: null,
    size: null
};
var LookupHttpManager = /** @class */ (function () {
    function LookupHttpManager(ins) {
        this.ins = ins;
        // 每次帮助打开后，更新此值，做为个性化数据的初始值；
        // 关闭窗口时，与此进行对比。如果一样，则不保存；
        this._originalPersonalConfig = DefaultUserConfig;
    }
    /**
     * @private
     * @return {?}
     */
    LookupHttpManager.prototype.disablePagination = /**
     * @private
     * @return {?}
     */
    function () {
        return {
            pageIndex: 1,
            pageSize: 500
        };
    };
    /** 构造查询参数 */
    /**
     * 构造查询参数
     * @param {?=} event
     * @param {?=} type
     * @return {?}
     */
    LookupHttpManager.prototype.buildQueryParams = /**
     * 构造查询参数
     * @param {?=} event
     * @param {?=} type
     * @return {?}
     */
    function (event, type) {
        if (type === void 0) { type = 'all'; }
        /** @type {?} */
        var params = {};
        if (this.ins.condition) {
            params.condition = cloneDeep(this.ins.condition);
        }
        /** @type {?} */
        var searchParam = { category: type };
        if (this.ins.isDoublleList() && this.ins.navigationFilter && type !== 'all') {
            if (this.ins.navigationFilter.idValue && type !== 'textchange') {
                params.relationFilter = tslib_1.__spread(this.ins.navigationFilter.idValue);
            }
        }
        if (event) {
            if (type === 'fav' || type === 'selected') {
                event.pageInfo = this.disablePagination();
            }
            if (event.pageInfo) {
                params.pageIndex = event.pageInfo.pageIndex;
                params.pageSize = event.pageInfo.pageSize;
            }
            if (event.search) {
                /** @type {?} */
                var sfield = event.search.field;
                if (sfield && sfield === '*') {
                    sfield = '*';
                }
                searchParam.searchField = sfield;
                searchParam.searchValue = event.search.value;
            }
            if (event.sortName) {
                searchParam.sortName = event.sortName;
            }
            if (event.sortOrder) {
                searchParam.sortOrder = event.sortOrder;
            }
        }
        if (type === 'fav' && event.favoriteIds) {
            searchParam.favoriteIds = event.favoriteIds;
        }
        if (this.ins.isTree() || this.ins.displayType === LookupGridDisplayType.NavTreeList) {
            params.enableFullTree = this.ins.enableFullTree;
        }
        // 查询时不构造完整树
        if (type === 'textchange') {
            params.enableFullTree = false;
        }
        if (type === 'selected') {
            searchParam.category = 'fav';
            params.enableFullTree = false;
            searchParam.favoriteIds = event.favoriteIds;
        }
        params.searchValue = JSON.stringify(searchParam);
        params.loadTreeDataType = this.ins.loadTreeDataType;
        params.customData = this.ins.customData;
        if (this.ins.helpId) {
            params.helpId = this.ins.helpId;
        }
        if (event.selectedInfo) {
            params.selectedInfo = event.selectedInfo;
        }
        return params;
    };
    /**
     * @param {?=} event
     * @param {?=} type
     * @return {?}
     */
    LookupHttpManager.prototype.getData = /**
     * @param {?=} event
     * @param {?=} type
     * @return {?}
     */
    function (event, type) {
        if (type === void 0) { type = 'all'; }
        /** @type {?} */
        var uri = this.ins.gridOptions.uri;
        /** @type {?} */
        var params = this.buildQueryParams(event, type);
        if (uri || this.ins.beUri) {
            if (this.ins.beUri && this.ins.columns && this.ins.columns.length) {
                /** @type {?} */
                var allSearchFields = this.ins.columns.map((/**
                 * @param {?} col
                 * @return {?}
                 */
                function (col) { return col.searchField; })).filter((/**
                 * @param {?} f
                 * @return {?}
                 */
                function (f) { return f; }));
                if (!params.condition) {
                    params.condition = {};
                }
                if (!this.ins.isTree() && this.ins.pagination) {
                    var _a = tslib_1.__assign({}, params), _b = _a.pageSize, pageSize = _b === void 0 ? this.ins.pageSize || 20 : _b, pageIndex = _a.pageIndex;
                    params.condition.pagination = { pageSize: pageSize, pageIndex: pageIndex };
                }
                else {
                    params.condition.pagination = { isUsePagination: false };
                }
                /** @type {?} */
                var searchParam = JSON.parse(params.searchValue);
                if (searchParam.searchValue) {
                    params.condition = this.ins.lookupUtils.mergeCondition(params.condition, allSearchFields, {
                        field: searchParam.searchField,
                        value: searchParam.searchValue
                    });
                }
            }
            /** @type {?} */
            var _uri = this.ins.beUri || uri;
            if (this.ins.http) {
                this.ins.http.context = this.ins.context;
            }
            if (this.ins._searchResult) {
                return of(this.ins._searchResult);
            }
            if (type !== 'allChildren') {
                return this.ins.http.getData(_uri, params);
            }
            else {
                /** @type {?} */
                var params1 = {
                    searchValue: JSON.stringify({ category: type }),
                    parentsIds: event.parentsIds,
                    customData: params.customData,
                    helpId: params.helpId
                };
                return this.ins.http.getData(_uri, params1);
            }
        }
        else {
            return of(false);
        }
    };
    // getFavoriteData(params) {
    //     return this.getData(params, 'fav');
    // }
    // getFavoriteData(params) {
    //     return this.getData(params, 'fav');
    // }
    /**
     * @param {?} selIds
     * @return {?}
     */
    LookupHttpManager.prototype.getSelecedItems = 
    // getFavoriteData(params) {
    //     return this.getData(params, 'fav');
    // }
    /**
     * @param {?} selIds
     * @return {?}
     */
    function (selIds) {
        return this.getData({ favoriteIds: selIds }, 'selected');
    };
    /**
     * @return {?}
     */
    LookupHttpManager.prototype.getPersonalConfig = /**
     * @return {?}
     */
    function () {
        /** @type {?} */
        var defaultConf = cloneDeep(DefaultUserConfig);
        /** @type {?} */
        var key = this.ins.personalConfigService._newKey;
        /** @type {?} */
        var _conf = this.ins.personalConfigService.getPersonalData(key);
        if (!_conf || !Object.keys(_conf).length) {
            _conf = defaultConf;
        }
        /** @type {?} */
        var req = of(_conf);
        if (this.ins.favoriteDataFrom === 'locale' || this.ins.isTabChanged) {
            return req;
        }
        if (this.ins.http && this.ins.http['getUserSettings']) {
            return this.ins.http['getUserSettings'](key).pipe(map((/**
             * @param {?} ucs
             * @return {?}
             */
            function (ucs) {
                if (ucs) {
                    return ucs.textValue ? JSON.parse(ucs.textValue) : defaultConf;
                }
                return defaultConf;
            })));
        }
        else {
            return req;
        }
    };
    /**
     * @param {?=} event
     * @param {?=} type
     * @return {?}
     */
    LookupHttpManager.prototype.lookupRequest = /**
     * @param {?=} event
     * @param {?=} type
     * @return {?}
     */
    function (event, type) {
        var _this = this;
        if (type === void 0) { type = 'all'; }
        if (!this.ins.usePersionalConf) {
            return this.getData(event, type);
        }
        /** @type {?} */
        var req = this.getPersonalConfig();
        return req.pipe(tap((/**
         * @param {?} c
         * @return {?}
         */
        function (c) {
            _this.ins.personalConf = c;
            _this.ins.personalConfigService.savePersonalConfig(c);
            if (!_this.ins.isTabChanged) {
                _this._originalPersonalConfig = cloneDeep(c);
            }
        })), switchMap((/**
         * @param {?} c
         * @return {?}
         */
        function (c) {
            var tabIndex = c.tabIndex, favorite = c.favorite, size = c.size;
            if (!_this.ins.isTabChanged) {
                _this.ins.activeTab = tabIndex || 'datalist';
            }
            if (size) {
                _this.ins.dialogWidth = size.width;
                _this.ins.dialogHeight = size.height;
                _this.ins.dialog.reSize({ width: size.width, height: size.height });
            }
            if (_this.ins.activeTab === 'datalist') {
                return _this.getData(event, type);
            }
            else if (_this.ins.activeTab === 'favorite') {
                /** @type {?} */
                var favIds = favorite ? favorite[_this.ins.localService.localeId] : [];
                if (!favIds || !favIds.length) {
                    return _this.getData(event, type).pipe(map((/**
                     * @param {?} r
                     * @return {?}
                     */
                    function (r) {
                        if (r) {
                            r.items = [];
                        }
                        return r;
                    })));
                }
                /** @type {?} */
                var _fids = favIds.filter((/**
                 * @param {?} n
                 * @return {?}
                 */
                function (n) { return n; }));
                event.favoriteIds = favIds;
                return _this.getData(event, 'fav');
            }
            else if (_this.ins.activeTab === 'selected') {
                /** @type {?} */
                var selIds = _this.ins.displayValue ? _this.ins.displayValue.split(',') : [];
                /** @type {?} */
                var _sids = selIds.filter((/**
                 * @param {?} n
                 * @return {?}
                 */
                function (n) { return n; }));
                return _this.getSelecedItems(_sids);
            }
        })));
    };
    // 保存个性化数据
    // 保存个性化数据
    /**
     * @param {?} action
     * @return {?}
     */
    LookupHttpManager.prototype.submitFavoriteData = 
    // 保存个性化数据
    /**
     * @param {?} action
     * @return {?}
     */
    function (action) {
        var _this = this;
        // 如果数据与默认的数据一至则不保存。
        if (JSON.stringify(this.ins.personalConf) === JSON.stringify(this._originalPersonalConfig)) {
            return;
        }
        /** @type {?} */
        var msg = '';
        if (action === FavoriteAction.add) {
            msg = this.ins.addFavoriteSuccess;
        }
        else if (action === FavoriteAction.delete) {
            msg = this.ins.delFavoriteSuccess;
        }
        this.ins.personalConfigService.savePersonalConfig(this.ins.personalConf || {});
        if (this.ins.favoriteDataFrom !== 'locale') {
            this._originalPersonalConfig = cloneDeep(this.ins.personalConf);
            /** @type {?} */
            var configData = {
                configkey1: this.ins.personalConfigService.personalConfigKey,
                configkey2: '',
                configkey3: '',
                textvalue: JSON.stringify(this.ins.personalConf)
            };
            if (this.ins.http && this.ins.http['saveUserSettings']) {
                this.ins.savingFaoriteData = true;
                this.ins.showLoading();
                return this.ins.http['saveUserSettings'](configData).subscribe((/**
                 * @param {?} r
                 * @return {?}
                 */
                function (r) {
                    _this.ins.savingFaoriteData = false;
                    _this.ins.closeLoading();
                    if (msg) {
                        _this.ins.notifyService.success(msg);
                    }
                }));
            }
        }
        else {
            if (msg) {
                this.ins.notifyService.success(msg);
            }
        }
    };
    return LookupHttpManager;
}());
export { LookupHttpManager };
if (false) {
    /**
     * @type {?}
     * @private
     */
    LookupHttpManager.prototype._originalPersonalConfig;
    /**
     * @type {?}
     * @private
     */
    LookupHttpManager.prototype.ins;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaHR0cC1tYW5hZ2VyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy91aS1sb29rdXAvIiwic291cmNlcyI6WyJsaWIvc2VydmljZXMvaHR0cC1tYW5hZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBR0EsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUN0QyxPQUFPLEVBQUUsY0FBYyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDOUUsT0FBTyxFQUFjLEVBQUUsRUFBWSxNQUFNLE1BQU0sQ0FBQztBQUNoRCxPQUFPLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQWdCLE1BQU0sZ0JBQWdCLENBQUM7OztJQUc3RCxpQkFBaUIsR0FBRztJQUN0QixRQUFRLEVBQUUsVUFBVTtJQUNwQixRQUFRLEVBQUUsSUFBSTtJQUNkLElBQUksRUFBRSxJQUFJO0NBQ2I7QUFDRDtJQUtJLDJCQUFvQixHQUF3QjtRQUF4QixRQUFHLEdBQUgsR0FBRyxDQUFxQjs7O1FBRnBDLDRCQUF1QixHQUFHLGlCQUFpQixDQUFDO0lBRUosQ0FBQzs7Ozs7SUFFekMsNkNBQWlCOzs7O0lBQXpCO1FBQ0ksT0FBTztZQUNILFNBQVMsRUFBRSxDQUFDO1lBQ1osUUFBUSxFQUFFLEdBQUc7U0FDaEIsQ0FBQztJQUNOLENBQUM7SUFFRCxhQUFhOzs7Ozs7O0lBQ2IsNENBQWdCOzs7Ozs7SUFBaEIsVUFBaUIsS0FBVyxFQUFFLElBQTRCO1FBQTVCLHFCQUFBLEVBQUEsWUFBNEI7O1lBQ2hELE1BQU0sR0FBaUIsRUFBRTtRQUUvQixJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxFQUFFO1lBQ3BCLE1BQU0sQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUM7U0FDcEQ7O1lBRUssV0FBVyxHQUFnQixFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUU7UUFDbkQsSUFB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LEVBQUU7Z0JBQ0wsSUFBSSxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO2FBQ3ZDO1NBQ0o7SUFDTCxDQUFDO0lBRUwsd0JBQUM7QUFBRCxDQUFDLEFBMVJELElBMFJDOzs7Ozs7O0lBdlJHLG9EQUFvRDs7Ozs7SUFFeEMsZ0NBQWdDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUmVtb3RlUGFyYW1zLCBTZWFyY2hQYXJhbSwgVXNlckZhdm9yaXRlRGF0YSB9IGZyb20gJy4uL2h0dHAvUmVtb3RlUGFyYW1zJztcclxuaW1wb3J0IHsgTE9BRF9EQVRBX1RZUEUgfSBmcm9tICcuLi9sb29rdXAtZ3JpZC1vcHRpb25zJztcclxuaW1wb3J0IHsgTG9va3VwR3JpZENvbXBvbmVudCB9IGZyb20gJy4uL2xvb2t1cC1ncmlkLmNvbXBvbmVudCc7XHJcbmltcG9ydCB7IGNsb25lRGVlcCB9IGZyb20gJ2xvZGFzaC1lcyc7XHJcbmltcG9ydCB7IEZhdm9yaXRlQWN0aW9uLCBMb29rdXBHcmlkRGlzcGxheVR5cGUgfSBmcm9tICcuLi9sb29rdXAtZGlzcGxheXR5cGUnO1xyXG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBvZiwgZm9ya0pvaW4gfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgbWFwLCBzd2l0Y2hNYXAsIHRhcCwgZGVib3VuY2VUaW1lIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5cclxuLy8g5biu5Yqp6buY6K6k5Liq5oCn5YyW5pWw5o2uXHJcbmNvbnN0IERlZmF1bHRVc2VyQ29uZmlnID0ge1xyXG4gICAgdGFiSW5kZXg6ICdkYXRhbGlzdCcsXHJcbiAgICBmYXZvcml0ZTogbnVsbCxcclxuICAgIHNpemU6IG51bGxcclxufTtcclxuZXhwb3J0IGNsYXNzIExvb2t1cEh0dHBNYW5hZ2VyIHtcclxuICAgIC8vIOavj+asoeW4ruWKqeaJk+W8gOWQju+8jOabtOaWsOatpOWAvO+8jOWBmuS4uuS4quaAp+WMluaVsOaNrueahOWIneWni+WAvO+8m1xyXG4gICAgLy8g5YWz6Zet56qX5Y+j5pe277yM5LiO5q2k6L+b6KGM5a+55q+U44CC5aaC5p6c5LiA5qC377yM5YiZ5LiN5L+d5a2Y77ybXHJcbiAgICBwcml2YXRlIF9vcmlnaW5hbFBlcnNvbmFsQ29uZmlnID0gRGVmYXVsdFVzZXJDb25maWc7XHJcblxyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBpbnM6IExvb2t1cEdyaWRDb21wb25lbnQpIHsgfVxyXG5cclxuICAgIHByaXZhdGUgZGlzYWJsZVBhZ2luYXRpb24oKSB7XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgcGFnZUluZGV4OiAxLFxyXG4gICAgICAgICAgICBwYWdlU2l6ZTogNTAwXHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICAvKiog5p6E6YCg5p+l6K+i5Y+C5pWwICovXHJcbiAgICBidWlsZFF1ZXJ5UGFyYW1zKGV2ZW50PzogYW55LCB0eXBlOiBMT0FEX0RBVEFfVFlQRSA9ICdhbGwnKSB7XHJcbiAgICAgICAgY29uc3QgcGFyYW1zOiBSZW1vdGVQYXJhbXMgPSB7fTtcclxuXHJcbiAgICAgICAgaWYgKHRoaXMuaW5zLmNvbmRpdGlvbikge1xyXG4gICAgICAgICAgICBwYXJhbXMuY29uZGl0aW9uID0gY2xvbmVEZWVwKHRoaXMuaW5zLmNvbmRpdGlvbik7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBzZWFyY2hQYXJhbTogU2VhcmNoUGFyYW0gPSB7IGNhdGVnb3J5OiB0eXBlIH07XHJcbiAgICAgICAgaWYgKHRoaXMuaW5zLmlzRG91YmxsZUxpc3QoKSAmJiB0aGlzLmlucy5uYXZpZ2F0aW9uRmlsdGVyICYmIHR5cGUgIT09ICdhbGwnKSB7XHJcblxyXG4gICAgICAgICAgICBpZiAodGhpcy5pbnMubmF2aWdhdGlvbkZpbHRlci5pZFZhbHVlICYmIHR5cGUgIT09ICd0ZXh0Y2hhbmdlJykge1xyXG4gICAgICAgICAgICAgICAgcGFyYW1zLnJlbGF0aW9uRmlsdGVyID0gWy4uLnRoaXMuaW5zLm5hdmlnYXRpb25GaWx0ZXIuaWRWYWx1ZV07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGV2ZW50KSB7XHJcblxyXG4gICAgICAgICAgICBpZiAodHlwZSA9PT0gJ2ZhdicgfHwgdHlwZSA9PT0gJ3NlbGVjdGVkJykge1xyXG4gICAgICAgICAgICAgICAgZXZlbnQucGFnZUluZm8gPSB0aGlzLmRpc2FibGVQYWdpbmF0aW9uKCk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcblxyXG4gICAgICAgICAgICBpZiAoZXZlbnQucGFnZUluZm8pIHtcclxuICAgICAgICAgICAgICAgIHBhcmFtcy5wYWdlSW5kZXggPSBldmVudC5wYWdlSW5mby5wYWdlSW5kZXg7XHJcbiAgICAgICAgICAgICAgICBwYXJhbXMucGFnZVNpemUgPSBldmVudC5wYWdlSW5mby5wYWdlU2l6ZTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKGV2ZW50LnNlYXJjaCkge1xyXG4gICAgICAgICAgICAgICAgbGV0IHNmaWVsZCA9IGV2ZW50LnNlYXJjaC5maWVsZDtcclxuICAgICAgICAgICAgICAgIGlmIChzZmllbGQgJiYgc2ZpZWxkID09PSAnKicpIHtcclxuICAgICAgICAgICAgICAgICAgICBzZmllbGQgPSAnKic7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgc2VhcmNoUGFyYW0uc2VhcmNoRmllbGQgPSBzZmllbGQ7XHJcbiAgICAgICAgICAgICAgICBzZWFyY2hQYXJhbS5zZWFyY2hWYWx1ZSA9IGV2ZW50LnNlYXJjaC52YWx1ZTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKGV2ZW50LnNvcnROYW1lKSB7XHJcbiAgICAgICAgICAgICAgICBzZWFyY2hQYXJhbS5zb3J0TmFtZSA9IGV2ZW50LnNvcnROYW1lO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChldmVudC5zb3J0T3JkZXIpIHtcclxuICAgICAgICAgICAgICAgIHNlYXJjaFBhcmFtLnNvcnRPcmRlciA9IGV2ZW50LnNvcnRPcmRlcjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHR5cGUgPT09ICdmYXYnICYmIGV2ZW50LmZhdm9yaXRlSWRzKSB7XHJcbiAgICAgICAgICAgIHNlYXJjaFBhcmFtLmZhdm9yaXRlSWRzID0gZXZlbnQuZmF2b3JpdGVJZHM7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodGhpcy5pbnMuaXNUcmVlKCkgfHwgdGhpcy5pbnMuZGlzcGxheVR5cGUgPT09IExvb2t1cEdyaWREaXNwbGF5VHlwZS5OYXZUcmVlTGlzdCkge1xyXG4gICAgICAgICAgICBwYXJhbXMuZW5hYmxlRnVsbFRyZWUgPSB0aGlzLmlucy5lbmFibGVGdWxsVHJlZTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIOafpeivouaXtuS4jeaehOmAoOWujOaVtOagkVxyXG4gICAgICAgIGlmICh0eXBlID09PSAndGV4dGNoYW5nZScpIHtcclxuICAgICAgICAgICAgcGFyYW1zLmVuYWJsZUZ1bGxUcmVlID0gZmFsc2U7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodHlwZSA9PT0gJ3NlbGVjdGVkJykge1xyXG4gICAgICAgICAgICBzZWFyY2hQYXJhbS5jYXRlZ29yeSA9ICdmYXYnO1xyXG4gICAgICAgICAgICBwYXJhbXMuZW5hYmxlRnVsbFRyZWUgPSBmYWxzZTtcclxuICAgICAgICAgICAgc2VhcmNoUGFyYW0uZmF2b3JpdGVJZHMgPSBldmVudC5mYXZvcml0ZUlkcztcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHBhcmFtcy5zZWFyY2hWYWx1ZSA9IEpTT04uc3RyaW5naWZ5KHNlYXJjaFBhcmFtKTtcclxuICAgICAgICBwYXJhbXMubG9hZFRyZWVEYXRhVHlwZSA9IHRoaXMuaW5zLmxvYWRUcmVlRGF0YVR5cGU7XHJcblxyXG4gICAgICAgIHBhcmFtcy5jdXN0b21EYXRhID0gdGhpcy5pbnMuY3VzdG9tRGF0YTtcclxuXHJcbiAgICAgICAgaWYgKHRoaXMuaW5zLmhlbHBJZCkge1xyXG4gICAgICAgICAgICBwYXJhbXMuaGVscElkID0gdGhpcy5pbnMuaGVscElkO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKGV2ZW50LnNlbGVjdGVkSW5mbykge1xyXG4gICAgICAgICAgICBwYXJhbXMuc2VsZWN0ZWRJbmZvID0gZXZlbnQuc2VsZWN0ZWRJbmZvO1xyXG4gICAgICAgIH1cclxuXHJcblxyXG4gICAgICAgIHJldHVybiBwYXJhbXM7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIGdldERhdGEoZXZlbnQ/OiBhbnksIHR5cGU6IExPQURfREFUQV9UWVBFID0gJ2FsbCcpOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgICAgIGNvbnN0IHVyaSA9IHRoaXMuaW5zLmdyaWRPcHRpb25zLnVyaTtcclxuICAgICAgICBjb25zdCBwYXJhbXMgPSB0aGlzLmJ1aWxkUXVlcnlQYXJhbXMoZXZlbnQsIHR5cGUpO1xyXG5cclxuICAgICAgICBpZiAodXJpIHx8IHRoaXMuaW5zLmJlVXJpKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmlucy5iZVVyaSAmJiB0aGlzLmlucy5jb2x1bW5zICYmIHRoaXMuaW5zLmNvbHVtbnMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBhbGxTZWFyY2hGaWVsZHMgPSB0aGlzLmlucy5jb2x1bW5zLm1hcChjb2wgPT4gY29sLnNlYXJjaEZpZWxkKS5maWx0ZXIoZiA9PiBmKTtcclxuICAgICAgICAgICAgICAgIGlmICghcGFyYW1zLmNvbmRpdGlvbikge1xyXG4gICAgICAgICAgICAgICAgICAgIHBhcmFtcy5jb25kaXRpb24gPSB7fTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaW5zLmlzVHJlZSgpICYmIHRoaXMuaW5zLnBhZ2luYXRpb24pIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCB7IHBhZ2VTaXplID0gdGhpcy5pbnMucGFnZVNpemUgfHwgMjAsIHBhZ2VJbmRleCB9ID0geyAuLi5wYXJhbXMgfTtcclxuICAgICAgICAgICAgICAgICAgICBwYXJhbXMuY29uZGl0aW9uLnBhZ2luYXRpb24gPSB7IHBhZ2VTaXplLCBwYWdlSW5kZXggfTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcGFyYW1zLmNvbmRpdGlvbi5wYWdpbmF0aW9uID0geyBpc1VzZVBhZ2luYXRpb246IGZhbHNlIH07XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBjb25zdCBzZWFyY2hQYXJhbSA9IEpTT04ucGFyc2UocGFyYW1zLnNlYXJjaFZhbHVlKTtcclxuICAgICAgICAgICAgICAgIGlmIChzZWFyY2hQYXJhbS5zZWFyY2hWYWx1ZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHBhcmFtcy5jb25kaXRpb24gPSB0aGlzLmlucy5sb29rdXBVdGlscy5tZXJnZUNvbmRpdGlvbihwYXJhbXMuY29uZGl0aW9uLCBhbGxTZWFyY2hGaWVsZHMsIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZmllbGQ6IHNlYXJjaFBhcmFtLnNlYXJjaEZpZWxkLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogc2VhcmNoUGFyYW0uc2VhcmNoVmFsdWVcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgY29uc3QgX3VyaSA9IHRoaXMuaW5zLmJlVXJpIHx8IHVyaTtcclxuXHJcbiAgICAgICAgICAgIGlmICh0aGlzLmlucy5odHRwKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmlucy5odHRwLmNvbnRleHQgPSB0aGlzLmlucy5jb250ZXh0O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmlucy5fc2VhcmNoUmVzdWx0KSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gb2YodGhpcy5pbnMuX3NlYXJjaFJlc3VsdCk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmICh0eXBlICE9PSAnYWxsQ2hpbGRyZW4nKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5pbnMuaHR0cC5nZXREYXRhKF91cmksIHBhcmFtcyk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBwYXJhbXMxID0ge1xyXG4gICAgICAgICAgICAgICAgICAgIHNlYXJjaFZhbHVlOiBKU09OLnN0cmluZ2lmeSh7IGNhdGVnb3J5OiB0eXBlIH0pLFxyXG4gICAgICAgICAgICAgICAgICAgIHBhcmVudHNJZHM6IGV2ZW50LnBhcmVudHNJZHMsXHJcbiAgICAgICAgICAgICAgICAgICAgY3VzdG9tRGF0YTogcGFyYW1zLmN1c3RvbURhdGEsXHJcbiAgICAgICAgICAgICAgICAgICAgaGVscElkOiBwYXJhbXMuaGVscElkXHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuaW5zLmh0dHAuZ2V0RGF0YShfdXJpLCBwYXJhbXMxKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiBvZihmYWxzZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vIGdldEZhdm9yaXRlRGF0YShwYXJhbXMpIHtcclxuICAgIC8vICAgICByZXR1cm4gdGhpcy5nZXREYXRhKHBhcmFtcywgJ2ZhdicpO1xyXG4gICAgLy8gfVxyXG5cclxuICAgIGdldFNlbGVjZWRJdGVtcyhzZWxJZHM6IGFueVtdKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0RGF0YSh7IGZhdm9yaXRlSWRzOiBzZWxJZHMgfSwgJ3NlbGVjdGVkJyk7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0UGVyc29uYWxDb25maWcoKSB7XHJcbiAgICAgICAgY29uc3QgZGVmYXVsdENvbmYgPSBjbG9uZURlZXAoRGVmYXVsdFVzZXJDb25maWcpO1xyXG4gICAgICAgIGNvbnN0IGtleSA9IHRoaXMuaW5zLnBlcnNvbmFsQ29uZmlnU2VydmljZS5fbmV3S2V5O1xyXG4gICAgICAgIGxldCBfY29uZiA9IHRoaXMuaW5zLnBlcnNvbmFsQ29uZmlnU2VydmljZS5nZXRQZXJzb25hbERhdGEoa2V5KTtcclxuXHJcbiAgICAgICAgaWYgKCFfY29uZiB8fCAhT2JqZWN0LmtleXMoX2NvbmYpLmxlbmd0aCkge1xyXG4gICAgICAgICAgICBfY29uZiA9IGRlZmF1bHRDb25mO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCByZXEgPSBvZihfY29uZik7XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmlucy5mYXZvcml0ZURhdGFGcm9tID09PSAnbG9jYWxlJyB8fCB0aGlzLmlucy5pc1RhYkNoYW5nZWQpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHJlcTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmlucy5odHRwICYmIHRoaXMuaW5zLmh0dHBbJ2dldFVzZXJTZXR0aW5ncyddKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmlucy5odHRwWydnZXRVc2VyU2V0dGluZ3MnXShrZXkpLnBpcGUoXHJcbiAgICAgICAgICAgICAgICBtYXAoKHVjczogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHVjcykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdWNzLnRleHRWYWx1ZSA/IEpTT04ucGFyc2UodWNzLnRleHRWYWx1ZSkgOiBkZWZhdWx0Q29uZjtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRlZmF1bHRDb25mO1xyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByZXR1cm4gcmVxO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBsb29rdXBSZXF1ZXN0KGV2ZW50PzogYW55LCB0eXBlOiBMT0FEX0RBVEFfVFlQRSA9ICdhbGwnKSB7XHJcbiAgICAgICAgaWYgKCF0aGlzLmlucy51c2VQZXJzaW9uYWxDb25mKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldERhdGEoZXZlbnQsIHR5cGUpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgcmVxID0gdGhpcy5nZXRQZXJzb25hbENvbmZpZygpO1xyXG5cclxuICAgICAgICByZXR1cm4gcmVxLnBpcGUoXHJcbiAgICAgICAgICAgIHRhcCgoYzogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmlucy5wZXJzb25hbENvbmYgPSBjO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5pbnMucGVyc29uYWxDb25maWdTZXJ2aWNlLnNhdmVQZXJzb25hbENvbmZpZyhjKTtcclxuICAgICAgICAgICAgICAgIGlmICghdGhpcy5pbnMuaXNUYWJDaGFuZ2VkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fb3JpZ2luYWxQZXJzb25hbENvbmZpZyA9IGNsb25lRGVlcChjKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICAgIHN3aXRjaE1hcCgoYzogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCB7IHRhYkluZGV4LCBmYXZvcml0ZSwgc2l6ZSB9ID0gYztcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaW5zLmlzVGFiQ2hhbmdlZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaW5zLmFjdGl2ZVRhYiA9IHRhYkluZGV4IHx8ICdkYXRhbGlzdCc7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKHNpemUpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmlucy5kaWFsb2dXaWR0aCA9IHNpemUud2lkdGg7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnMuZGlhbG9nSGVpZ2h0ID0gc2l6ZS5oZWlnaHQ7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnMuZGlhbG9nLnJlU2l6ZSh7IHdpZHRoOiBzaXplLndpZHRoLCBoZWlnaHQ6IHNpemUuaGVpZ2h0IH0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLmlucy5hY3RpdmVUYWIgPT09ICdkYXRhbGlzdCcpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXREYXRhKGV2ZW50LCB0eXBlKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5pbnMuYWN0aXZlVGFiID09PSAnZmF2b3JpdGUnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZmF2SWRzID0gZmF2b3JpdGUgPyBmYXZvcml0ZVt0aGlzLmlucy5sb2NhbFNlcnZpY2UubG9jYWxlSWRdIDogW107XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFmYXZJZHMgfHwgIWZhdklkcy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0RGF0YShldmVudCwgdHlwZSkucGlwZShcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hcChyID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByLml0ZW1zID0gW107XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IF9maWRzID0gZmF2SWRzLmZpbHRlcihuID0+IG4pO1xyXG4gICAgICAgICAgICAgICAgICAgIGV2ZW50LmZhdm9yaXRlSWRzID0gZmF2SWRzO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdldERhdGEoZXZlbnQsICdmYXYnKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5pbnMuYWN0aXZlVGFiID09PSAnc2VsZWN0ZWQnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2VsSWRzID0gdGhpcy5pbnMuZGlzcGxheVZhbHVlID8gdGhpcy5pbnMuZGlzcGxheVZhbHVlLnNwbGl0KCcsJykgOiBbXTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBfc2lkcyA9IHNlbElkcy5maWx0ZXIobiA9PiBuKTtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRTZWxlY2VkSXRlbXMoX3NpZHMpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8g5L+d5a2Y5Liq5oCn5YyW5pWw5o2uXHJcbiAgICBzdWJtaXRGYXZvcml0ZURhdGEoYWN0aW9uOiBhbnkgfCBGYXZvcml0ZUFjdGlvbikge1xyXG4gICAgICAgIC8vIOWmguaenOaVsOaNruS4jum7mOiupOeahOaVsOaNruS4gOiHs+WImeS4jeS/neWtmOOAglxyXG4gICAgICAgIGlmIChKU09OLnN0cmluZ2lmeSh0aGlzLmlucy5wZXJzb25hbENvbmYpID09PSBKU09OLnN0cmluZ2lmeSh0aGlzLl9vcmlnaW5hbFBlcnNvbmFsQ29uZmlnKSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBsZXQgbXNnID0gJyc7XHJcbiAgICAgICAgaWYgKGFjdGlvbiA9PT0gRmF2b3JpdGVBY3Rpb24uYWRkKSB7XHJcbiAgICAgICAgICAgIG1zZyA9IHRoaXMuaW5zLmFkZEZhdm9yaXRlU3VjY2VzcztcclxuICAgICAgICB9IGVsc2UgaWYgKGFjdGlvbiA9PT0gRmF2b3JpdGVBY3Rpb24uZGVsZXRlKSB7XHJcbiAgICAgICAgICAgIG1zZyA9IHRoaXMuaW5zLmRlbEZhdm9yaXRlU3VjY2VzcztcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuaW5zLnBlcnNvbmFsQ29uZmlnU2VydmljZS5zYXZlUGVyc29uYWxDb25maWcodGhpcy5pbnMucGVyc29uYWxDb25mIHx8IHt9KTtcclxuXHJcbiAgICAgICAgaWYgKHRoaXMuaW5zLmZhdm9yaXRlRGF0YUZyb20gIT09ICdsb2NhbGUnKSB7XHJcbiAgICAgICAgICAgIHRoaXMuX29yaWdpbmFsUGVyc29uYWxDb25maWcgPSBjbG9uZURlZXAodGhpcy5pbnMucGVyc29uYWxDb25mKTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IGNvbmZpZ0RhdGE6IFVzZXJGYXZvcml0ZURhdGEgPSB7XHJcbiAgICAgICAgICAgICAgICBjb25maWdrZXkxOiB0aGlzLmlucy5wZXJzb25hbENvbmZpZ1NlcnZpY2UucGVyc29uYWxDb25maWdLZXksXHJcbiAgICAgICAgICAgICAgICBjb25maWdrZXkyOiAnJyxcclxuICAgICAgICAgICAgICAgIGNvbmZpZ2tleTM6ICcnLFxyXG4gICAgICAgICAgICAgICAgdGV4dHZhbHVlOiBKU09OLnN0cmluZ2lmeSh0aGlzLmlucy5wZXJzb25hbENvbmYpXHJcbiAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICBpZiAodGhpcy5pbnMuaHR0cCAmJiB0aGlzLmlucy5odHRwWydzYXZlVXNlclNldHRpbmdzJ10pIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuaW5zLnNhdmluZ0Zhb3JpdGVEYXRhID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIHRoaXMuaW5zLnNob3dMb2FkaW5nKCk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5pbnMuaHR0cFsnc2F2ZVVzZXJTZXR0aW5ncyddKGNvbmZpZ0RhdGEpLnN1YnNjcmliZSgocikgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaW5zLnNhdmluZ0Zhb3JpdGVEYXRhID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnMuY2xvc2VMb2FkaW5nKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKG1zZykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmlucy5ub3RpZnlTZXJ2aWNlLnN1Y2Nlc3MobXNnKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlmIChtc2cpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuaW5zLm5vdGlmeVNlcnZpY2Uuc3VjY2Vzcyhtc2cpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxufVxyXG4iXX0=