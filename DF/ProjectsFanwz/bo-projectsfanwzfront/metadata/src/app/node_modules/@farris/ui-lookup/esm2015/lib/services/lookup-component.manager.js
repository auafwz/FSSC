/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { debounceTime, switchMap } from 'rxjs/operators';
import { LookupLeftComponent } from '../lookup-left.component';
export class LookupComponentManager {
    /**
     * @param {?} ins
     */
    constructor(ins) {
        this.ins = ins;
    }
    /**
     * @param {?=} type
     * @return {?}
     */
    getComponentInstance(type = 'datatable') {
        if (!this.ins.componentRef || !this.ins.componentRef.instance) {
            return null;
        }
        if (type === 'selected') {
            return this.ins.multiSelectDT;
        }
        /** @type {?} */
        let ins = this.ins.componentRef.instance;
        if (type === 'leftDataTable' || type === 'leftTree') {
            /** @type {?} */
            const leftRef = this.ins.leftComponentRef;
            if (!leftRef || !leftRef.instance || !leftRef.instance.cmpRef || !leftRef.instance.cmpRef.instance) {
                return null;
            }
            ins = this.ins.leftComponentRef.instance.cmpRef.instance;
        }
        if (type === 'fav') {
            ins = this.ins.favoritesComponentRef.instance;
        }
        switch (type) {
            case 'leftDataTable':
            case 'fav':
            case 'datatable':
                return (/** @type {?} */ (ins));
            case 'leftTree':
            case 'treetable':
                return (/** @type {?} */ (ins));
            default:
                if (this.ins.isTree()) {
                    return (/** @type {?} */ (ins));
                }
                return (/** @type {?} */ (ins));
        }
    }
    /**
     * @param {?} data
     * @return {?}
     */
    createComponentWithServerData(data) {
        if (this.ins.componentRef) {
            return;
        }
        this.ins.idField = data.idField || this.ins.idField;
        this.ins.textField = data.textField || this.ins.textField;
        this.ins.valueField = data.valueField || this.ins.valueField;
        this.ins.displayType = (data && data.displayType) || this.ins.displayType || 'LIST';
        this.ins.componentRef = this.createContent(this.ins.gridOptions);
        this.createFavoriteComponent();
        this.resizeComponent();
    }
    /**
     * @return {?}
     */
    createFavoriteComponent() {
        if (this.ins.useFavorite && !this.ins.favoritesComponentRef) {
            this.ins.favoriteColumns = this.ins.favHelper.getFavoriteColumns();
            /** @type {?} */
            const favoritesOptions = Object.assign({}, this.ins.gridOptions, {
                showFilterBar: false,
                pagination: false,
                columns: this.ins.favoriteColumns || []
            });
            this.ins.favoritesComponentRef = this.createFavoritesContent(favoritesOptions);
            this.resizeComponent('fav');
        }
    }
    /**
     * @param {?} opts
     * @return {?}
     */
    createContent(opts) {
        if (this.ins.componentRef) {
            return;
        }
        /** @type {?} */
        const type = this.ins.getComponentType();
        /** @type {?} */
        const dtFac = this.ins.cfr.resolveComponentFactory(type);
        /** @type {?} */
        let cmpRef = null;
        if (this.ins.isDoublleList()) {
            cmpRef = this.ins.centerContainer.createComponent(dtFac);
        }
        else {
            cmpRef = this.ins.contentContainer.createComponent(dtFac);
        }
        if (this.ins.isTree()) {
            opts.fit = true;
            opts.pagination = false;
        }
        else {
            opts.fill = true;
        }
        Object.assign(cmpRef.instance, opts, { allColumnsTitle: this.ins.allColumnsTitle });
        this.ins.componentRef = cmpRef;
        this.resizeComponent();
        return cmpRef;
    }
    // 创建收藏CMP
    /**
     * @param {?} opts
     * @return {?}
     */
    createFavoritesContent(opts) {
        /** @type {?} */
        const type = this.ins.getComponentType();
        /** @type {?} */
        const dtFac = this.ins.cfr.resolveComponentFactory(type);
        /** @type {?} */
        let cmpRef = null;
        cmpRef = this.ins.favoritesContainer.createComponent(dtFac);
        if (this.ins.isTree()) {
            opts.fit = true;
            opts.pagination = false;
        }
        else {
            opts.fill = true;
        }
        Object.assign(cmpRef.instance, opts, {
            width: this.ins.dialog.size.width - 20,
            height: this.ins.dialogMgr.getHeight()
        });
        // 订阅收藏夹列表中组件的相关事件
        this.ins.favHelper.initFavoriteComponentEvent(cmpRef);
        return cmpRef;
    }
    /**
     * @param {?=} type
     * @return {?}
     */
    resizeComponent(type = 'datatable') {
        /** @type {?} */
        const size = {
            width: this.ins.dialog.size.width - 20,
            height: this.ins.dialogMgr.getHeight()
        };
        if (this.ins.isDoublleList() && (type === 'datatable' || type === 'treetable')) {
            size.width = this.ins.dialog.size.width - this.ins.leftPanelWidth - 27;
        }
        this.getComponentInstance(type).resize(size);
    }
    /**
     * 创建左侧组件
     * @param {?} ops
     * @return {?}
     */
    createLeftComponent(ops) {
        /** @type {?} */
        let dtFac = null;
        if (this.ins.isDoublleList()) {
            dtFac = this.ins.cfr.resolveComponentFactory(LookupLeftComponent);
        }
        this.ins.leftComponentRef = this.ins.leftContainer.createComponent(dtFac);
        ops.height = this.ins.dialogMgr.getHeight();
        if (this.ins.dialogWidth < this.ins.navLookupDialogMinWidth) {
            this.ins.dialogWidth = this.ins.navLookupDialogMinWidth;
            this.ins.dialog.reSize({ width: this.ins.dialogWidth });
            this.ins.resizeCmp({ width: this.ins.dialog.size.width });
        }
        if (ops.width !== this.ins.leftPanel.width) {
            // 默认 1 : 2
            this.ins.leftPanel.resize({
                width: this.ins.leftPanel.width,
                height: ops.height
            });
            this.ins.resizeCmp({ width: this.ins.dialog.size.width });
        }
        // this.resizeComponent();
        this.ins.leftComponentRef.instance.lookupCmp = this.ins;
        this.ins.leftComponentRef.instance.navOptions = ops;
        this.ins.leftComponentRef.instance.selected
            .pipe(debounceTime(100), switchMap((/**
         * @param {?} d
         * @return {?}
         */
        (d) => {
            if (d && d.data) {
                this.ins.navigationFilter = {
                    selected: d.data,
                    idValue: this.getNavigationFilter(d.data),
                    searchField: '',
                    searchValue: ''
                };
            }
            else {
                this.ins.navigationFilter = undefined;
            }
            // 加载右侧数据
            /** @type {?} */
            const p = {
                pageInfo: {
                    pageIndex: this.ins.gridOptions.pageIndex,
                    pageSize: this.ins.gridOptions.pageSize
                }
            };
            Object.assign(p, { search: this.ins._searchState });
            return this.ins.httpMgr.getData(p, 'list');
        })))
            .subscribe((/**
         * @param {?} res
         * @return {?}
         */
        res => {
            this.ins.closeLoading();
            this.ins.loadDataWhenOpen = true;
            if (this.ins.useFavorite && !this.ins.isTree()) {
                this.ins.favHelper.updateFavoritesStatus(res.items);
            }
            this.ins.loadDataTableData(res);
            setTimeout((/**
             * @return {?}
             */
            () => {
                // 选中数据
                this.ins.selectionMgr.selectCurrentValue();
                this.ins.changeDetector.detectChanges();
            }));
        }));
        return this.ins.leftComponentRef.instance.createComponent();
    }
    // 获取关联数据, 右侧数据中 关联各字段的值
    /**
     * @private
     * @param {?} navRow
     * @return {?}
     */
    getNavigationFilter(navRow) {
        if (this.ins.navigationOptions.relations && this.ins.navigationOptions.relations.length) {
            /** @type {?} */
            const result = [];
            this.ins.navigationOptions.relations.forEach((/**
             * @param {?} r
             * @return {?}
             */
            r => {
                /** @type {?} */
                const k = r.groupField;
                /** @type {?} */
                const dField = r.helpField;
                /** @type {?} */
                const rf = { fieldName: dField, fieldValue: '' };
                rf.fieldValue = k.split('.').reduce((/**
                 * @param {?} o
                 * @param {?} c
                 * @return {?}
                 */
                (o, c) => {
                    return o[c];
                }), navRow);
                result.push(rf);
            }));
            return result;
        }
        return '';
    }
}
if (false) {
    /**
     * @type {?}
     * @private
     */
    LookupComponentManager.prototype.ins;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9va3VwLWNvbXBvbmVudC5tYW5hZ2VyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy91aS1sb29rdXAvIiwic291cmNlcyI6WyJsaWIvc2VydmljZXMvbG9va3VwLWNvbXBvbmVudC5tYW5hZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFHQSxPQUFPLEVBQUUsWUFBWSxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBR3pELE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBRy9ELE1BQU0sT0FBTyxzQkFBc0I7Ozs7SUFDL0IsWUFBb0IsR0FBd0I7UUFBeEIsUUFBRyxHQUFILEdBQUcsQ0FBcUI7SUFBRyxDQUFDOzs7OztJQUVoRCxvQkFBb0IsQ0FBQyxPQUE4QixXQUFXO1FBQzFELElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFlBQVksSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLFFBQVEsRUFBRTtZQUMzRCxPQUFPLElBQUksQ0FBQztTQUNmO1FBRUQsSUFBSSxJQUFJLEtBQUssVUFBVSxFQUFFO1lBQ3JCLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUM7U0FDakM7O1lBRUcsR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLFFBQVE7UUFFeEMsSUFBSSxJQUFJLEtBQUssZUFBZSxJQUFJLElBQUksS0FBSyxVQUFVLEVBQUU7O2tCQUMzQyxPQUFPLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0I7WUFDekMsSUFBSSxDQUFDLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLE1BQU0sSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRTtnQkFDaEcsT0FBTyxJQUFJLENBQUM7YUFDZjtZQUNELEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDO1NBQzVEO1FBRUQsSUFBSSxJQUFJLEtBQUssS0FBSyxFQUFFO1lBQ2hCLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLHFCQUFxQixDQUFDLFFBQVEsQ0FBQztTQUNqRDtRQUVELFFBQVEsSUFBSSxFQUFFO1lBQ1YsS0FBSyxlQUFlLENBQUM7WUFDckIsS0FBSyxLQUFLLENBQUM7WUFDWCxLQUFLLFdBQVc7Z0JBQ1osT0FBTyxtQkFBQSxHQUFHLEVBQXNCLENBQUM7WUFDckMsS0FBSyxVQUFVLENBQUM7WUFDaEIsS0FBSyxXQUFXO2dCQUNaLE9BQU8sbUJBQUEsR0FBRyxFQUFzQixDQUFDO1lBQ3JDO2dCQUNJLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsRUFBRTtvQkFDbkIsT0FBTyxtQkFBQSxHQUFHLEVBQXNCLENBQUM7aUJBQ3BDO2dCQUNELE9BQU8sbUJBQUEsR0FBRyxFQUFzQixDQUFDO1NBQ3hDO0lBQ0wsQ0FBQzs7Ozs7SUFFRCw2QkFBNkIsQ0FBQyxJQUFTO1FBQ25DLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxZQUFZLEVBQUU7WUFDdkIsT0FBTztTQUNWO1FBQ0QsSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLE9BQU8sSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQztRQUNwRCxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsU0FBUyxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDO1FBQzFELElBQUksQ0FBQyxHQUFHLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxVQUFVLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUM7UUFFN0QsSUFBSSxDQUFDLEdBQUcsQ0FBQyxXQUFXLEdBQUcsQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsV0FBVyxJQUFJLE1BQU0sQ0FBQztRQUNwRixJQUFJLENBQUMsR0FBRyxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDakUsSUFBSSxDQUFDLHVCQUF1QixFQUFFLENBQUM7UUFFL0IsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO0lBQzNCLENBQUM7Ozs7SUFHRCx1QkFBdUI7UUFDbkIsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLFdBQVcsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMscUJBQXFCLEVBQUU7WUFDekQsSUFBSSxDQUFDLEdBQUcsQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsa0JBQWtCLEVBQUUsQ0FBQzs7a0JBQzdELGdCQUFnQixHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsV0FBVyxFQUFFO2dCQUM3RCxhQUFhLEVBQUUsS0FBSztnQkFDcEIsVUFBVSxFQUFFLEtBQUs7Z0JBQ2pCLE9BQU8sRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLGVBQWUsSUFBSSxFQUFFO2FBQzFDLENBQUM7WUFDRixJQUFJLENBQUMsR0FBRyxDQUFDLHFCQUFxQixHQUFHLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1lBRS9FLElBQUksQ0FBQyxlQUFlLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDL0I7SUFDTCxDQUFDOzs7OztJQUdELGFBQWEsQ0FBQyxJQUFTO1FBRW5CLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxZQUFZLEVBQUU7WUFDdkIsT0FBTztTQUNWOztjQUVLLElBQUksR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLGdCQUFnQixFQUFFOztjQUVsQyxLQUFLLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsdUJBQXVCLENBQUMsSUFBSSxDQUFDOztZQUNwRCxNQUFNLEdBQUcsSUFBSTtRQUNqQixJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsYUFBYSxFQUFFLEVBQUU7WUFDMUIsTUFBTSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsZUFBZSxDQUFDLGVBQWUsQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUM1RDthQUFNO1lBQ0gsTUFBTSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLENBQUMsZUFBZSxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQzdEO1FBRUQsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRSxFQUFFO1lBQ25CLElBQUksQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDO1lBQ2hCLElBQUksQ0FBQyxVQUFVLEdBQUcsS0FBSyxDQUFDO1NBQzNCO2FBQU07WUFDSCxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztTQUNwQjtRQUVELE1BQU0sQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxJQUFJLEVBQUUsRUFBRSxlQUFlLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxlQUFlLEVBQUUsQ0FBQyxDQUFDO1FBRXBGLElBQUksQ0FBQyxHQUFHLENBQUMsWUFBWSxHQUFHLE1BQU0sQ0FBQztRQUMvQixJQUFJLENBQUMsZUFBZSxFQUFFLENBQUM7UUFDdkIsT0FBTyxNQUFNLENBQUM7SUFDbEIsQ0FBQzs7Ozs7O0lBR0Qsc0JBQXNCLENBQUMsSUFBUzs7Y0FFdEIsSUFBSSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLEVBQUU7O2NBRWxDLEtBQUssR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyx1QkFBdUIsQ0FBQyxJQUFJLENBQUM7O1lBQ3BELE1BQU0sR0FBRyxJQUFJO1FBQ2pCLE1BQU0sR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLGtCQUFrQixDQUFDLGVBQWUsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUU1RCxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLEVBQUU7WUFDbkIsSUFBSSxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUM7WUFDaEIsSUFBSSxDQUFDLFVBQVUsR0FBRyxLQUFLLENBQUM7U0FDM0I7YUFBTTtZQUNILElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1NBQ3BCO1FBRUQsTUFBTSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFFLElBQUksRUFBRTtZQUNqQyxLQUFLLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssR0FBRyxFQUFFO1lBQ3RDLE1BQU0sRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxTQUFTLEVBQUU7U0FDekMsQ0FBQyxDQUFDO1FBR0gsa0JBQWtCO1FBQ2xCLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLDBCQUEwQixDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBRXRELE9BQU8sTUFBTSxDQUFDO0lBQ2xCLENBQUM7Ozs7O0lBRUQsZUFBZSxDQUFDLE9BQThCLFdBQVc7O2NBQy9DLElBQUksR0FBRztZQUNULEtBQUssRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxHQUFHLEVBQUU7WUFDdEMsTUFBTSxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLFNBQVMsRUFBRTtTQUN6QztRQUVELElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxhQUFhLEVBQUUsSUFBSSxDQUFDLElBQUksS0FBSyxXQUFXLElBQUksSUFBSSxLQUFLLFdBQVcsQ0FBQyxFQUFFO1lBQzVFLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLGNBQWMsR0FBRyxFQUFFLENBQUM7U0FDMUU7UUFFRCxJQUFJLENBQUMsb0JBQW9CLENBQUMsSUFBSSxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ2pELENBQUM7Ozs7OztJQUdELG1CQUFtQixDQUFDLEdBQVE7O1lBQ3BCLEtBQUssR0FBRyxJQUFJO1FBQ2hCLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxhQUFhLEVBQUUsRUFBRTtZQUMxQixLQUFLLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsdUJBQXVCLENBQUMsbUJBQW1CLENBQUMsQ0FBQztTQUNyRTtRQUNELElBQUksQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsZUFBZSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzFFLEdBQUcsQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsU0FBUyxFQUFFLENBQUM7UUFFNUMsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLHVCQUF1QixFQUFFO1lBQ3pELElBQUksQ0FBQyxHQUFHLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsdUJBQXVCLENBQUM7WUFDeEQsSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQztZQUN4RCxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxFQUFFLEtBQUssRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQztTQUM3RDtRQUVELElBQUksR0FBRyxDQUFDLEtBQUssS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxLQUFLLEVBQUU7WUFDeEMsV0FBVztZQUNYLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQztnQkFDdEIsS0FBSyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLEtBQUs7Z0JBQy9CLE1BQU0sRUFBRSxHQUFHLENBQUMsTUFBTTthQUNyQixDQUFDLENBQUM7WUFDSCxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxFQUFFLEtBQUssRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQztTQUM3RDtRQUVELDBCQUEwQjtRQUUxQixJQUFJLENBQUMsR0FBRyxDQUFDLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQztRQUN4RCxJQUFJLENBQUMsR0FBRyxDQUFDLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxVQUFVLEdBQUcsR0FBRyxDQUFDO1FBR3BELElBQUksQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLENBQUMsUUFBUSxDQUFDLFFBQVE7YUFDdEMsSUFBSSxDQUNELFlBQVksQ0FBQyxHQUFHLENBQUMsRUFDakIsU0FBUzs7OztRQUFDLENBQUMsQ0FBTSxFQUFFLEVBQUU7WUFDakIsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksRUFBRTtnQkFDYixJQUFJLENBQUMsR0FBRyxDQUFDLGdCQUFnQixHQUFHO29CQUN4QixRQUFRLEVBQUUsQ0FBQyxDQUFDLElBQUk7b0JBQ2hCLE9BQU8sRUFBRSxJQUFJLENBQUMsbUJBQW1CLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztvQkFDekMsV0FBVyxFQUFFLEVBQUU7b0JBQ2YsV0FBVyxFQUFFLEVBQUU7aUJBQ2xCLENBQUM7YUFDTDtpQkFBTTtnQkFDSCxJQUFJLENBQUMsR0FBRyxDQUFDLGdCQUFnQixHQUFHLFNBQVMsQ0FBQzthQUN6Qzs7O2tCQUVLLENBQUMsR0FBRztnQkFDTixRQUFRLEVBQUU7b0JBQ04sU0FBUyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLFNBQVM7b0JBQ3pDLFFBQVEsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxRQUFRO2lCQUMxQzthQUNKO1lBQ0QsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsRUFBRSxNQUFNLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxZQUFZLEVBQUUsQ0FBQyxDQUFDO1lBQ3BELE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsRUFBRSxNQUFNLENBQUMsQ0FBQztRQUMvQyxDQUFDLEVBQUMsQ0FDTDthQUNBLFNBQVM7Ozs7UUFBQyxHQUFHLENBQUMsRUFBRTtZQUNiLElBQUksQ0FBQyxHQUFHLENBQUMsWUFBWSxFQUFFLENBQUM7WUFDeEIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsR0FBRyxJQUFJLENBQUM7WUFFakMsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLFdBQVcsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLEVBQUU7Z0JBQzVDLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLHFCQUFxQixDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQzthQUN2RDtZQUVELElBQUksQ0FBQyxHQUFHLENBQUMsaUJBQWlCLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDaEMsVUFBVTs7O1lBQUMsR0FBRyxFQUFFO2dCQUNaLE9BQU87Z0JBQ1AsSUFBSSxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsa0JBQWtCLEVBQUUsQ0FBQztnQkFDM0MsSUFBSSxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUMsYUFBYSxFQUFFLENBQUM7WUFDNUMsQ0FBQyxFQUFDLENBQUM7UUFDUCxDQUFDLEVBQUMsQ0FBQztRQUVQLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLENBQUMsZUFBZSxFQUFFLENBQUM7SUFDaEUsQ0FBQzs7Ozs7OztJQUdPLG1CQUFtQixDQUFDLE1BQVc7UUFDbkMsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLGlCQUFpQixDQUFDLFNBQVMsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLGlCQUFpQixDQUFDLFNBQVMsQ0FBQyxNQUFNLEVBQUU7O2tCQUMvRSxNQUFNLEdBQUcsRUFBRTtZQUNqQixJQUFJLENBQUMsR0FBRyxDQUFDLGlCQUFpQixDQUFDLFNBQVMsQ0FBQyxPQUFPOzs7O1lBQUMsQ0FBQyxDQUFDLEVBQUU7O3NCQUN2QyxDQUFDLEdBQUcsQ0FBQyxDQUFDLFVBQVU7O3NCQUNoQixNQUFNLEdBQUcsQ0FBQyxDQUFDLFNBQVM7O3NCQUNwQixFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxFQUFFLEVBQUU7Z0JBQ2hELEVBQUUsQ0FBQyxVQUFVLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNOzs7OztnQkFBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRTtvQkFDekMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ2hCLENBQUMsR0FBRSxNQUFNLENBQUMsQ0FBQztnQkFFWCxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQ3BCLENBQUMsRUFBQyxDQUFDO1lBQ0gsT0FBTyxNQUFNLENBQUM7U0FDakI7UUFFRCxPQUFPLEVBQUUsQ0FBQztJQUNkLENBQUM7Q0FDSjs7Ozs7O0lBNU9lLHFDQUFnQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudFJlZiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBEYXRhVGFibGVDb21wb25lbnQgfSBmcm9tICdAZmFycmlzL3VpLWRhdGF0YWJsZSc7XHJcbmltcG9ydCB7IFRyZWVUYWJsZUNvbXBvbmVudCB9IGZyb20gJ0BmYXJyaXMvdWktdHJlZXRhYmxlJztcclxuaW1wb3J0IHsgZGVib3VuY2VUaW1lLCBzd2l0Y2hNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IENvbXBvbmVudEluc3RhbmNlVHlwZSB9IGZyb20gJy4uL2xvb2t1cC1kaXNwbGF5dHlwZSc7XHJcbmltcG9ydCB7IExvb2t1cEdyaWRDb21wb25lbnQgfSBmcm9tICcuLi9sb29rdXAtZ3JpZC5jb21wb25lbnQnO1xyXG5pbXBvcnQgeyBMb29rdXBMZWZ0Q29tcG9uZW50IH0gZnJvbSAnLi4vbG9va3VwLWxlZnQuY29tcG9uZW50JztcclxuXHJcblxyXG5leHBvcnQgY2xhc3MgTG9va3VwQ29tcG9uZW50TWFuYWdlciB7XHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGluczogTG9va3VwR3JpZENvbXBvbmVudCkge31cclxuXHJcbiAgICBnZXRDb21wb25lbnRJbnN0YW5jZSh0eXBlOiBDb21wb25lbnRJbnN0YW5jZVR5cGUgPSAnZGF0YXRhYmxlJykge1xyXG4gICAgICAgIGlmICghdGhpcy5pbnMuY29tcG9uZW50UmVmIHx8ICF0aGlzLmlucy5jb21wb25lbnRSZWYuaW5zdGFuY2UpIHtcclxuICAgICAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodHlwZSA9PT0gJ3NlbGVjdGVkJykge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5pbnMubXVsdGlTZWxlY3REVDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGxldCBpbnMgPSB0aGlzLmlucy5jb21wb25lbnRSZWYuaW5zdGFuY2U7XHJcblxyXG4gICAgICAgIGlmICh0eXBlID09PSAnbGVmdERhdGFUYWJsZScgfHwgdHlwZSA9PT0gJ2xlZnRUcmVlJykge1xyXG4gICAgICAgICAgICBjb25zdCBsZWZ0UmVmID0gdGhpcy5pbnMubGVmdENvbXBvbmVudFJlZjtcclxuICAgICAgICAgICAgaWYgKCFsZWZ0UmVmIHx8ICFsZWZ0UmVmLmluc3RhbmNlIHx8ICFsZWZ0UmVmLmluc3RhbmNlLmNtcFJlZiB8fCAhbGVmdFJlZi5pbnN0YW5jZS5jbXBSZWYuaW5zdGFuY2UpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlucyA9IHRoaXMuaW5zLmxlZnRDb21wb25lbnRSZWYuaW5zdGFuY2UuY21wUmVmLmluc3RhbmNlO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHR5cGUgPT09ICdmYXYnKSB7XHJcbiAgICAgICAgICAgIGlucyA9IHRoaXMuaW5zLmZhdm9yaXRlc0NvbXBvbmVudFJlZi5pbnN0YW5jZTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHN3aXRjaCAodHlwZSkge1xyXG4gICAgICAgICAgICBjYXNlICdsZWZ0RGF0YVRhYmxlJzpcclxuICAgICAgICAgICAgY2FzZSAnZmF2JzpcclxuICAgICAgICAgICAgY2FzZSAnZGF0YXRhYmxlJzpcclxuICAgICAgICAgICAgICAgIHJldHVybiBpbnMgYXMgRGF0YVRhYmxlQ29tcG9uZW50O1xyXG4gICAgICAgICAgICBjYXNlICdsZWZ0VHJlZSc6XHJcbiAgICAgICAgICAgIGNhc2UgJ3RyZWV0YWJsZSc6XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gaW5zIGFzIFRyZWVUYWJsZUNvbXBvbmVudDtcclxuICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLmlucy5pc1RyZWUoKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBpbnMgYXMgVHJlZVRhYmxlQ29tcG9uZW50O1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGlucyBhcyBEYXRhVGFibGVDb21wb25lbnQ7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGNyZWF0ZUNvbXBvbmVudFdpdGhTZXJ2ZXJEYXRhKGRhdGE6IGFueSkge1xyXG4gICAgICAgIGlmICh0aGlzLmlucy5jb21wb25lbnRSZWYpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmlucy5pZEZpZWxkID0gZGF0YS5pZEZpZWxkIHx8IHRoaXMuaW5zLmlkRmllbGQ7XHJcbiAgICAgICAgdGhpcy5pbnMudGV4dEZpZWxkID0gZGF0YS50ZXh0RmllbGQgfHwgdGhpcy5pbnMudGV4dEZpZWxkO1xyXG4gICAgICAgIHRoaXMuaW5zLnZhbHVlRmllbGQgPSBkYXRhLnZhbHVlRmllbGQgfHwgdGhpcy5pbnMudmFsdWVGaWVsZDtcclxuXHJcbiAgICAgICAgdGhpcy5pbnMuZGlzcGxheVR5cGUgPSAoZGF0YSAmJiBkYXRhLmRpc3BsYXlUeXBlKSB8fCB0aGlzLmlucy5kaXNwbGF5VHlwZSB8fCAnTElTVCc7XHJcbiAgICAgICAgdGhpcy5pbnMuY29tcG9uZW50UmVmID0gdGhpcy5jcmVhdGVDb250ZW50KHRoaXMuaW5zLmdyaWRPcHRpb25zKTtcclxuICAgICAgICB0aGlzLmNyZWF0ZUZhdm9yaXRlQ29tcG9uZW50KCk7XHJcblxyXG4gICAgICAgIHRoaXMucmVzaXplQ29tcG9uZW50KCk7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIGNyZWF0ZUZhdm9yaXRlQ29tcG9uZW50KCkge1xyXG4gICAgICAgIGlmICh0aGlzLmlucy51c2VGYXZvcml0ZSAmJiAhdGhpcy5pbnMuZmF2b3JpdGVzQ29tcG9uZW50UmVmKSB7XHJcbiAgICAgICAgICAgIHRoaXMuaW5zLmZhdm9yaXRlQ29sdW1ucyA9IHRoaXMuaW5zLmZhdkhlbHBlci5nZXRGYXZvcml0ZUNvbHVtbnMoKTtcclxuICAgICAgICAgICAgY29uc3QgZmF2b3JpdGVzT3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oe30sIHRoaXMuaW5zLmdyaWRPcHRpb25zLCB7XHJcbiAgICAgICAgICAgICAgICBzaG93RmlsdGVyQmFyOiBmYWxzZSxcclxuICAgICAgICAgICAgICAgIHBhZ2luYXRpb246IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgY29sdW1uczogdGhpcy5pbnMuZmF2b3JpdGVDb2x1bW5zIHx8IFtdXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB0aGlzLmlucy5mYXZvcml0ZXNDb21wb25lbnRSZWYgPSB0aGlzLmNyZWF0ZUZhdm9yaXRlc0NvbnRlbnQoZmF2b3JpdGVzT3B0aW9ucyk7XHJcblxyXG4gICAgICAgICAgICB0aGlzLnJlc2l6ZUNvbXBvbmVudCgnZmF2Jyk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuXHJcbiAgICBjcmVhdGVDb250ZW50KG9wdHM6IGFueSk6IENvbXBvbmVudFJlZjxhbnk+IHtcclxuXHJcbiAgICAgICAgaWYgKHRoaXMuaW5zLmNvbXBvbmVudFJlZikge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCB0eXBlID0gdGhpcy5pbnMuZ2V0Q29tcG9uZW50VHlwZSgpO1xyXG5cclxuICAgICAgICBjb25zdCBkdEZhYyA9IHRoaXMuaW5zLmNmci5yZXNvbHZlQ29tcG9uZW50RmFjdG9yeSh0eXBlKTtcclxuICAgICAgICBsZXQgY21wUmVmID0gbnVsbDtcclxuICAgICAgICBpZiAodGhpcy5pbnMuaXNEb3VibGxlTGlzdCgpKSB7XHJcbiAgICAgICAgICAgIGNtcFJlZiA9IHRoaXMuaW5zLmNlbnRlckNvbnRhaW5lci5jcmVhdGVDb21wb25lbnQoZHRGYWMpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGNtcFJlZiA9IHRoaXMuaW5zLmNvbnRlbnRDb250YWluZXIuY3JlYXRlQ29tcG9uZW50KGR0RmFjKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmlucy5pc1RyZWUoKSkge1xyXG4gICAgICAgICAgICBvcHRzLmZpdCA9IHRydWU7XHJcbiAgICAgICAgICAgIG9wdHMucGFnaW5hdGlvbiA9IGZhbHNlO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIG9wdHMuZmlsbCA9IHRydWU7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBPYmplY3QuYXNzaWduKGNtcFJlZi5pbnN0YW5jZSwgb3B0cywgeyBhbGxDb2x1bW5zVGl0bGU6IHRoaXMuaW5zLmFsbENvbHVtbnNUaXRsZSB9KTtcclxuXHJcbiAgICAgICAgdGhpcy5pbnMuY29tcG9uZW50UmVmID0gY21wUmVmO1xyXG4gICAgICAgIHRoaXMucmVzaXplQ29tcG9uZW50KCk7XHJcbiAgICAgICAgcmV0dXJuIGNtcFJlZjtcclxuICAgIH1cclxuXHJcbiAgICAvLyDliJvlu7rmlLbol49DTVBcclxuICAgIGNyZWF0ZUZhdm9yaXRlc0NvbnRlbnQob3B0czogYW55KTogQ29tcG9uZW50UmVmPGFueT4ge1xyXG5cclxuICAgICAgICBjb25zdCB0eXBlID0gdGhpcy5pbnMuZ2V0Q29tcG9uZW50VHlwZSgpO1xyXG5cclxuICAgICAgICBjb25zdCBkdEZhYyA9IHRoaXMuaW5zLmNmci5yZXNvbHZlQ29tcG9uZW50RmFjdG9yeSh0eXBlKTtcclxuICAgICAgICBsZXQgY21wUmVmID0gbnVsbDtcclxuICAgICAgICBjbXBSZWYgPSB0aGlzLmlucy5mYXZvcml0ZXNDb250YWluZXIuY3JlYXRlQ29tcG9uZW50KGR0RmFjKTtcclxuXHJcbiAgICAgICAgaWYgKHRoaXMuaW5zLmlzVHJlZSgpKSB7XHJcbiAgICAgICAgICAgIG9wdHMuZml0ID0gdHJ1ZTtcclxuICAgICAgICAgICAgb3B0cy5wYWdpbmF0aW9uID0gZmFsc2U7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgb3B0cy5maWxsID0gdHJ1ZTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIE9iamVjdC5hc3NpZ24oY21wUmVmLmluc3RhbmNlLCBvcHRzLCB7XHJcbiAgICAgICAgICAgIHdpZHRoOiB0aGlzLmlucy5kaWFsb2cuc2l6ZS53aWR0aCAtIDIwLFxyXG4gICAgICAgICAgICBoZWlnaHQ6IHRoaXMuaW5zLmRpYWxvZ01nci5nZXRIZWlnaHQoKVxyXG4gICAgICAgIH0pO1xyXG5cclxuXHJcbiAgICAgICAgLy8g6K6i6ZiF5pS26JeP5aS55YiX6KGo5Lit57uE5Lu255qE55u45YWz5LqL5Lu2XHJcbiAgICAgICAgdGhpcy5pbnMuZmF2SGVscGVyLmluaXRGYXZvcml0ZUNvbXBvbmVudEV2ZW50KGNtcFJlZik7XHJcblxyXG4gICAgICAgIHJldHVybiBjbXBSZWY7XHJcbiAgICB9XHJcblxyXG4gICAgcmVzaXplQ29tcG9uZW50KHR5cGU6IENvbXBvbmVudEluc3RhbmNlVHlwZSA9ICdkYXRhdGFibGUnKSB7XHJcbiAgICAgICAgY29uc3Qgc2l6ZSA9IHtcclxuICAgICAgICAgICAgd2lkdGg6IHRoaXMuaW5zLmRpYWxvZy5zaXplLndpZHRoIC0gMjAsXHJcbiAgICAgICAgICAgIGhlaWdodDogdGhpcy5pbnMuZGlhbG9nTWdyLmdldEhlaWdodCgpXHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgaWYgKHRoaXMuaW5zLmlzRG91YmxsZUxpc3QoKSAmJiAodHlwZSA9PT0gJ2RhdGF0YWJsZScgfHwgdHlwZSA9PT0gJ3RyZWV0YWJsZScpKSB7XHJcbiAgICAgICAgICAgIHNpemUud2lkdGggPSB0aGlzLmlucy5kaWFsb2cuc2l6ZS53aWR0aCAtIHRoaXMuaW5zLmxlZnRQYW5lbFdpZHRoIC0gMjc7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLmdldENvbXBvbmVudEluc3RhbmNlKHR5cGUpLnJlc2l6ZShzaXplKTtcclxuICAgIH1cclxuXHJcbiAgICAvKiog5Yib5bu65bem5L6n57uE5Lu2ICovXHJcbiAgICBjcmVhdGVMZWZ0Q29tcG9uZW50KG9wczogYW55KSB7XHJcbiAgICAgICAgbGV0IGR0RmFjID0gbnVsbDtcclxuICAgICAgICBpZiAodGhpcy5pbnMuaXNEb3VibGxlTGlzdCgpKSB7XHJcbiAgICAgICAgICAgIGR0RmFjID0gdGhpcy5pbnMuY2ZyLnJlc29sdmVDb21wb25lbnRGYWN0b3J5KExvb2t1cExlZnRDb21wb25lbnQpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmlucy5sZWZ0Q29tcG9uZW50UmVmID0gdGhpcy5pbnMubGVmdENvbnRhaW5lci5jcmVhdGVDb21wb25lbnQoZHRGYWMpO1xyXG4gICAgICAgIG9wcy5oZWlnaHQgPSB0aGlzLmlucy5kaWFsb2dNZ3IuZ2V0SGVpZ2h0KCk7XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmlucy5kaWFsb2dXaWR0aCA8IHRoaXMuaW5zLm5hdkxvb2t1cERpYWxvZ01pbldpZHRoKSB7XHJcbiAgICAgICAgICAgIHRoaXMuaW5zLmRpYWxvZ1dpZHRoID0gdGhpcy5pbnMubmF2TG9va3VwRGlhbG9nTWluV2lkdGg7XHJcbiAgICAgICAgICAgIHRoaXMuaW5zLmRpYWxvZy5yZVNpemUoeyB3aWR0aDogdGhpcy5pbnMuZGlhbG9nV2lkdGggfSk7XHJcbiAgICAgICAgICAgIHRoaXMuaW5zLnJlc2l6ZUNtcCh7IHdpZHRoOiB0aGlzLmlucy5kaWFsb2cuc2l6ZS53aWR0aCB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChvcHMud2lkdGggIT09IHRoaXMuaW5zLmxlZnRQYW5lbC53aWR0aCkge1xyXG4gICAgICAgICAgICAvLyDpu5jorqQgMSA6IDJcclxuICAgICAgICAgICAgdGhpcy5pbnMubGVmdFBhbmVsLnJlc2l6ZSh7XHJcbiAgICAgICAgICAgICAgICB3aWR0aDogdGhpcy5pbnMubGVmdFBhbmVsLndpZHRoLFxyXG4gICAgICAgICAgICAgICAgaGVpZ2h0OiBvcHMuaGVpZ2h0XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB0aGlzLmlucy5yZXNpemVDbXAoeyB3aWR0aDogdGhpcy5pbnMuZGlhbG9nLnNpemUud2lkdGggfSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyB0aGlzLnJlc2l6ZUNvbXBvbmVudCgpO1xyXG5cclxuICAgICAgICB0aGlzLmlucy5sZWZ0Q29tcG9uZW50UmVmLmluc3RhbmNlLmxvb2t1cENtcCA9IHRoaXMuaW5zO1xyXG4gICAgICAgIHRoaXMuaW5zLmxlZnRDb21wb25lbnRSZWYuaW5zdGFuY2UubmF2T3B0aW9ucyA9IG9wcztcclxuXHJcblxyXG4gICAgICAgIHRoaXMuaW5zLmxlZnRDb21wb25lbnRSZWYuaW5zdGFuY2Uuc2VsZWN0ZWRcclxuICAgICAgICAgICAgLnBpcGUoXHJcbiAgICAgICAgICAgICAgICBkZWJvdW5jZVRpbWUoMTAwKSxcclxuICAgICAgICAgICAgICAgIHN3aXRjaE1hcCgoZDogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGQgJiYgZC5kYXRhKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaW5zLm5hdmlnYXRpb25GaWx0ZXIgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZDogZC5kYXRhLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWRWYWx1ZTogdGhpcy5nZXROYXZpZ2F0aW9uRmlsdGVyKGQuZGF0YSksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWFyY2hGaWVsZDogJycsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWFyY2hWYWx1ZTogJydcclxuICAgICAgICAgICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmlucy5uYXZpZ2F0aW9uRmlsdGVyID0gdW5kZWZpbmVkO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAvLyDliqDovb3lj7PkvqfmlbDmja5cclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBwYWdlSW5mbzoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFnZUluZGV4OiB0aGlzLmlucy5ncmlkT3B0aW9ucy5wYWdlSW5kZXgsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYWdlU2l6ZTogdGhpcy5pbnMuZ3JpZE9wdGlvbnMucGFnZVNpemVcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICAgICAgT2JqZWN0LmFzc2lnbihwLCB7IHNlYXJjaDogdGhpcy5pbnMuX3NlYXJjaFN0YXRlIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmlucy5odHRwTWdyLmdldERhdGEocCwgJ2xpc3QnKTtcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIClcclxuICAgICAgICAgICAgLnN1YnNjcmliZShyZXMgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5pbnMuY2xvc2VMb2FkaW5nKCk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmlucy5sb2FkRGF0YVdoZW5PcGVuID0gdHJ1ZTtcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5pbnMudXNlRmF2b3JpdGUgJiYgIXRoaXMuaW5zLmlzVHJlZSgpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnMuZmF2SGVscGVyLnVwZGF0ZUZhdm9yaXRlc1N0YXR1cyhyZXMuaXRlbXMpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIHRoaXMuaW5zLmxvYWREYXRhVGFibGVEYXRhKHJlcyk7XHJcbiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAvLyDpgInkuK3mlbDmja5cclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmlucy5zZWxlY3Rpb25NZ3Iuc2VsZWN0Q3VycmVudFZhbHVlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnMuY2hhbmdlRGV0ZWN0b3IuZGV0ZWN0Q2hhbmdlcygpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICByZXR1cm4gdGhpcy5pbnMubGVmdENvbXBvbmVudFJlZi5pbnN0YW5jZS5jcmVhdGVDb21wb25lbnQoKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyDojrflj5blhbPogZTmlbDmja4sIOWPs+S+p+aVsOaNruS4rSDlhbPogZTlkITlrZfmrrXnmoTlgLxcclxuICAgIHByaXZhdGUgZ2V0TmF2aWdhdGlvbkZpbHRlcihuYXZSb3c6IGFueSkge1xyXG4gICAgICAgIGlmICh0aGlzLmlucy5uYXZpZ2F0aW9uT3B0aW9ucy5yZWxhdGlvbnMgJiYgdGhpcy5pbnMubmF2aWdhdGlvbk9wdGlvbnMucmVsYXRpb25zLmxlbmd0aCkge1xyXG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBbXTtcclxuICAgICAgICAgICAgdGhpcy5pbnMubmF2aWdhdGlvbk9wdGlvbnMucmVsYXRpb25zLmZvckVhY2gociA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBrID0gci5ncm91cEZpZWxkO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZEZpZWxkID0gci5oZWxwRmllbGQ7XHJcbiAgICAgICAgICAgICAgICBjb25zdCByZiA9IHsgZmllbGROYW1lOiBkRmllbGQsIGZpZWxkVmFsdWU6ICcnIH07XHJcbiAgICAgICAgICAgICAgICByZi5maWVsZFZhbHVlID0gay5zcGxpdCgnLicpLnJlZHVjZSgobywgYykgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBvW2NdO1xyXG4gICAgICAgICAgICAgICAgfSwgbmF2Um93KTtcclxuXHJcbiAgICAgICAgICAgICAgICByZXN1bHQucHVzaChyZik7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuICcnO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==