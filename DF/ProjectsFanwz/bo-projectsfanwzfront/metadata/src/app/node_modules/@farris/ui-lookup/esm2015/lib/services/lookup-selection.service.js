/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { of, BehaviorSubject } from 'rxjs';
import { switchMap } from 'rxjs/operators';
import { FavoriteAction } from '../lookup-displaytype';
/**
 * @record
 */
export function SelectionState() { }
if (false) {
    /** @type {?} */
    SelectionState.prototype.selecteditems;
    /** @type {?} */
    SelectionState.prototype.favoriteItems;
    /** @type {?} */
    SelectionState.prototype.quickItems;
}
export class LookupSelectionService {
    /**
     * @param {?} ins
     */
    constructor(ins) {
        this.ins = ins;
        this.state = {
            selecteditems: [],
            favoriteItems: [],
            quickItems: []
        };
        this.state$ = new BehaviorSubject(this.state);
        this.selected$ = this.state$.pipe(switchMap((/**
         * @param {?} n
         * @return {?}
         */
        n => of(n.selecteditems))));
        this.favoriteItems$ = new BehaviorSubject({ items: this.state.favoriteItems, action: null });
        this.quickItems$ = this.state$.pipe(switchMap((/**
         * @param {?} n
         * @return {?}
         */
        n => of(n.quickItems))));
    }
    /**
     * @private
     * @return {?}
     */
    get idField() {
        return this.ins.idField;
    }
    /**
     * @param {?} items
     * @return {?}
     */
    initFavoriteItems(items) {
        this.state.favoriteItems = items || [];
    }
    //#region 收藏数据
    /**
     * @param {?} data
     * @param {?} action
     * @return {?}
     */
    updateFavoriteData(data, action) {
        if (this.ins.savingFaoriteData) {
            // console.log('%c太调皮了吧！', 'color: white');
            return;
        }
        if (action === FavoriteAction.add) {
            this.state.favoriteItems = this.state.favoriteItems.concat([data]);
        }
        else {
            this.state.favoriteItems = this.state.favoriteItems.filter((/**
             * @param {?} n
             * @return {?}
             */
            n => n[this.idField] !== data[this.idField]));
        }
        this.favoriteItems$.next({ items: this.state.favoriteItems, action });
    }
    //#endregion
    //#region 多选数据
    /**
     * @param {?} data
     * @return {?}
     */
    loadSelections(data) {
        this.state.selecteditems = [...data];
        this.state$.next(this.state);
    }
    /**
     * @return {?}
     */
    getSelections() {
        return [...this.state.selecteditems];
    }
    /**
     * @param {?} item
     * @return {?}
     */
    select(item) {
        if (item) {
            this.state.selecteditems = [...this.state.selecteditems, item];
            this.state$.next(this.state);
        }
    }
    /**
     * @param {?} pathcode
     * @return {?}
     */
    unselectByPathcode(pathcode) {
        const { dataField, pathField } = this.ins.treeInfo;
        this.state.selecteditems = this.state.selecteditems.filter((/**
         * @param {?} n
         * @return {?}
         */
        n => {
            return n[dataField][pathField] && n[dataField][pathField].indexOf(pathcode) !== 0;
        }));
    }
    /**
     * @param {?} data
     * @param {?=} checked
     * @return {?}
     */
    updateSelections(data, checked = true) {
        if (!Array.isArray(data)) {
            data = [data];
        }
        /** @type {?} */
        const items = [...data];
        /** @type {?} */
        const idField = this.idField;
        if (checked) {
            if (this.state.selecteditems && !this.state.selecteditems.length) {
                this.state.selecteditems = items;
            }
            else {
                /** @type {?} */
                const ids = items.map((/**
                 * @param {?} n
                 * @return {?}
                 */
                n => n[idField]));
                ids.forEach((/**
                 * @param {?} n
                 * @param {?} i
                 * @return {?}
                 */
                (n, i) => {
                    if (!this.state.selecteditems.find((/**
                     * @param {?} r
                     * @return {?}
                     */
                    r => r[idField] == n))) {
                        this.state.selecteditems.push(items[i]);
                    }
                }));
            }
        }
        else {
            if (data) {
                /** @type {?} */
                const ids2 = data.map((/**
                 * @param {?} n
                 * @return {?}
                 */
                n => n[idField]));
                this.state.selecteditems = this.state.selecteditems.filter((/**
                 * @param {?} n
                 * @return {?}
                 */
                n => {
                    return ids2.indexOf(n[idField]) === -1;
                }));
            }
        }
        this.state$.next(this.state);
    }
    /**
     * @param {?} id
     * @return {?}
     */
    unSelect(id) {
        if (id) {
            if (Array.isArray(id)) {
                this.state.selecteditems = this.state.selecteditems.filter((/**
                 * @param {?} n
                 * @return {?}
                 */
                n => {
                    return id.indexOf(n[this.idField]) === -1;
                }));
            }
            else {
                this.state.selecteditems = this.state.selecteditems.filter((/**
                 * @param {?} n
                 * @return {?}
                 */
                n => n[this.idField] != id));
            }
            this.state$.next(this.state);
        }
    }
    /**
     * @return {?}
     */
    clearSelections() {
        this.state.selecteditems = [];
        this.state$.next(this.state);
    }
}
if (false) {
    /**
     * @type {?}
     * @private
     */
    LookupSelectionService.prototype.state;
    /** @type {?} */
    LookupSelectionService.prototype.state$;
    /** @type {?} */
    LookupSelectionService.prototype.selected$;
    /** @type {?} */
    LookupSelectionService.prototype.favoriteItems$;
    /** @type {?} */
    LookupSelectionService.prototype.quickItems$;
    /**
     * @type {?}
     * @private
     */
    LookupSelectionService.prototype.ins;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9va3VwLXNlbGVjdGlvbi5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy91aS1sb29rdXAvIiwic291cmNlcyI6WyJsaWIvc2VydmljZXMvbG9va3VwLXNlbGVjdGlvbi5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQWMsRUFBRSxFQUFFLGVBQWUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUN2RCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDM0MsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLHVCQUF1QixDQUFDOzs7O0FBR3ZELG9DQUlDOzs7SUFIRyx1Q0FBcUI7O0lBQ3JCLHVDQUFxQjs7SUFDckIsb0NBQWtCOztBQUd0QixNQUFNLE9BQU8sc0JBQXNCOzs7O0lBd0IvQixZQUFvQixHQUF3QjtRQUF4QixRQUFHLEdBQUgsR0FBRyxDQUFxQjtRQXRCcEMsVUFBSyxHQUFtQjtZQUM1QixhQUFhLEVBQUUsRUFBRTtZQUNqQixhQUFhLEVBQUUsRUFBRTtZQUNqQixVQUFVLEVBQUUsRUFBRTtTQUNqQixDQUFDO1FBRUYsV0FBTSxHQUFvQyxJQUFJLGVBQWUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7UUFFMUUsY0FBUyxHQUFzQixJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FDM0MsU0FBUzs7OztRQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxhQUFhLENBQUMsRUFBQyxDQUN0QyxDQUFDO1FBRUYsbUJBQWMsR0FBeUIsSUFBSSxlQUFlLENBQUMsRUFBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxhQUFhLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7UUFFN0csZ0JBQVcsR0FBc0IsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQzdDLFNBQVM7Ozs7UUFBQyxDQUFDLENBQUMsRUFBRSxDQUFD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Q0FBQzs7Ozs7SUFFRCxRQUFRLENBQUMsRUFBTztRQUNaLElBQUksRUFBRSxFQUFFO1lBQ0osSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxFQUFFO2dCQUNuQixJQUFJLENBQUMsS0FBSyxDQUFDLGFBQWEsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBQyxNQUFNOzs7O2dCQUFDLENBQUMsQ0FBQyxFQUFFO29CQUMzRCxPQUFPLEVBQUUsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO2dCQUM5QyxDQUFDLEVBQUMsQ0FBQzthQUNOO2lCQUFNO2dCQUNILElBQUksQ0FBQyxLQUFLLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsYUFBYSxDQUFDLE1BQU07Ozs7Z0JBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsRUFBQyxDQUFDO2FBQzFGO1lBRUQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQ2hDO0lBQ0wsQ0FBQzs7OztJQUVELGVBQWU7UUFDWCxJQUFJLENBQUMsS0FBSyxDQUFDLGFBQWEsR0FBRyxFQUFFLENBQUM7UUFDOUIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ2pDLENBQUM7Q0FJSjs7Ozs7O0lBL0hHLHVDQUlFOztJQUVGLHdDQUEwRTs7SUFFMUUsMkNBRUU7O0lBRUYsZ0RBQTZHOztJQUU3Ryw2Q0FFRTs7Ozs7SUFNVSxxQ0FBZ0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBPYnNlcnZhYmxlLCBvZiwgQmVoYXZpb3JTdWJqZWN0IH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IHN3aXRjaE1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuaW1wb3J0IHsgRmF2b3JpdGVBY3Rpb24gfSBmcm9tICcuLi9sb29rdXAtZGlzcGxheXR5cGUnO1xyXG5pbXBvcnQgeyBMb29rdXBHcmlkQ29tcG9uZW50IH0gZnJvbSAnLi4vbG9va3VwLWdyaWQuY29tcG9uZW50JztcclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgU2VsZWN0aW9uU3RhdGUge1xyXG4gICAgc2VsZWN0ZWRpdGVtczogYW55W107XHJcbiAgICBmYXZvcml0ZUl0ZW1zOiBhbnlbXTtcclxuICAgIHF1aWNrSXRlbXM6IGFueVtdO1xyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgTG9va3VwU2VsZWN0aW9uU2VydmljZSB7XHJcblxyXG4gICAgcHJpdmF0ZSBzdGF0ZTogU2VsZWN0aW9uU3RhdGUgPSB7XHJcbiAgICAgICAgc2VsZWN0ZWRpdGVtczogW10sXHJcbiAgICAgICAgZmF2b3JpdGVJdGVtczogW10sXHJcbiAgICAgICAgcXVpY2tJdGVtczogW11cclxuICAgIH07XHJcblxyXG4gICAgc3RhdGUkOiBCZWhhdmlvclN1YmplY3Q8U2VsZWN0aW9uU3RhdGU+ID0gbmV3IEJlaGF2aW9yU3ViamVjdCh0aGlzLnN0YXRlKTtcclxuXHJcbiAgICBzZWxlY3RlZCQ6IE9ic2VydmFibGU8YW55W10+ID0gdGhpcy5zdGF0ZSQucGlwZShcclxuICAgICAgICBzd2l0Y2hNYXAobiA9PiBvZihuLnNlbGVjdGVkaXRlbXMpKVxyXG4gICAgKTtcclxuXHJcbiAgICBmYXZvcml0ZUl0ZW1zJDogQmVoYXZpb3JTdWJqZWN0PGFueT4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0KHtpdGVtczogdGhpcy5zdGF0ZS5mYXZvcml0ZUl0ZW1zLCBhY3Rpb246IG51bGwgfSk7XHJcblxyXG4gICAgcXVpY2tJdGVtcyQ6IE9ic2VydmFibGU8YW55W10+ID0gdGhpcy5zdGF0ZSQucGlwZShcclxuICAgICAgICBzd2l0Y2hNYXAobiA9PiBvZihuLnF1aWNrSXRlbXMpKVxyXG4gICAgKTtcclxuXHJcbiAgICBwcml2YXRlIGdldCBpZEZpZWxkKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmlucy5pZEZpZWxkO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgaW5zOiBMb29rdXBHcmlkQ29tcG9uZW50KSB7XHJcbiAgICB9XHJcblxyXG4gICAgaW5pdEZhdm9yaXRlSXRlbXMoaXRlbXM6IGFueVtdKSB7XHJcbiAgICAgICAgdGhpcy5zdGF0ZS5mYXZvcml0ZUl0ZW1zID0gaXRlbXMgfHwgW107XHJcbiAgICB9XHJcblxyXG5cclxuICAgIC8vI3JlZ2lvbiDmlLbol4/mlbDmja5cclxuXHJcbiAgICB1cGRhdGVGYXZvcml0ZURhdGEoZGF0YTogYW55LCBhY3Rpb246IEZhdm9yaXRlQWN0aW9uKSB7XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmlucy5zYXZpbmdGYW9yaXRlRGF0YSkge1xyXG4gICAgICAgICAgICAvLyBjb25zb2xlLmxvZygnJWPlpKrosIPnmq7kuoblkKfvvIEnLCAnY29sb3I6IHdoaXRlJyk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChhY3Rpb24gPT09IEZhdm9yaXRlQWN0aW9uLmFkZCkge1xyXG4gICAgICAgICAgICB0aGlzLnN0YXRlLmZhdm9yaXRlSXRlbXMgPSB0aGlzLnN0YXRlLmZhdm9yaXRlSXRlbXMuY29uY2F0KFtkYXRhXSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5zdGF0ZS5mYXZvcml0ZUl0ZW1zID0gdGhpcy5zdGF0ZS5mYXZvcml0ZUl0ZW1zLmZpbHRlcihuID0+IG5bdGhpcy5pZEZpZWxkXSAhPT0gZGF0YVt0aGlzLmlkRmllbGRdKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuZmF2b3JpdGVJdGVtcyQubmV4dCh7IGl0ZW1zOiB0aGlzLnN0YXRlLmZhdm9yaXRlSXRlbXMsIGFjdGlvbiB9KTtcclxuICAgIH1cclxuXHJcbiAgICAvLyNlbmRyZWdpb25cclxuXHJcbiAgICAvLyNyZWdpb24g5aSa6YCJ5pWw5o2uXHJcblxyXG4gICAgbG9hZFNlbGVjdGlvbnMoIGRhdGE6IFtdKSB7XHJcbiAgICAgICAgdGhpcy5zdGF0ZS5zZWxlY3RlZGl0ZW1zID0gWy4uLmRhdGFdO1xyXG4gICAgICAgIHRoaXMuc3RhdGUkLm5leHQodGhpcy5zdGF0ZSk7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0U2VsZWN0aW9ucygpIHtcclxuICAgICAgICByZXR1cm4gWy4uLnRoaXMuc3RhdGUuc2VsZWN0ZWRpdGVtc107XHJcbiAgICB9XHJcblxyXG4gICAgc2VsZWN0KGl0ZW06IGFueSkge1xyXG4gICAgICAgIGlmIChpdGVtKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc3RhdGUuc2VsZWN0ZWRpdGVtcyA9IFsuLi50aGlzLnN0YXRlLnNlbGVjdGVkaXRlbXMsIGl0ZW1dO1xyXG4gICAgICAgICAgICB0aGlzLnN0YXRlJC5uZXh0KHRoaXMuc3RhdGUpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICB1bnNlbGVjdEJ5UGF0aGNvZGUocGF0aGNvZGU6IHN0cmluZykge1xyXG4gICAgICAgIGNvbnN0IHsgZGF0YUZpZWxkLCBwYXRoRmllbGQgfSA9IHRoaXMuaW5zLnRyZWVJbmZvO1xyXG4gICAgICAgIHRoaXMuc3RhdGUuc2VsZWN0ZWRpdGVtcyA9IHRoaXMuc3RhdGUuc2VsZWN0ZWRpdGVtcy5maWx0ZXIobiA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiBuW2RhdGFGaWVsZF1bcGF0aEZpZWxkXSAmJiBuW2RhdGFGaWVsZF1bcGF0aEZpZWxkXS5pbmRleE9mKHBhdGhjb2RlKSAhPT0gMDtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICB1cGRhdGVTZWxlY3Rpb25zKGRhdGE6IGFueSwgY2hlY2tlZCA9IHRydWUpIHtcclxuXHJcbiAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KGRhdGEpKSB7XHJcbiAgICAgICAgICAgIGRhdGEgPSBbZGF0YV07XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBpdGVtcyA9IFsgLi4uZGF0YSBdO1xyXG4gICAgICAgIGNvbnN0IGlkRmllbGQgPSB0aGlzLmlkRmllbGQ7XHJcbiAgICAgICAgaWYgKGNoZWNrZWQpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUuc2VsZWN0ZWRpdGVtcyAmJiAhdGhpcy5zdGF0ZS5zZWxlY3RlZGl0ZW1zLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zdGF0ZS5zZWxlY3RlZGl0ZW1zID0gaXRlbXM7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBpZHMgPSBpdGVtcy5tYXAobiA9PiBuW2lkRmllbGRdKTtcclxuICAgICAgICAgICAgICAgIGlkcy5mb3JFYWNoKChuLCBpKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLnN0YXRlLnNlbGVjdGVkaXRlbXMuZmluZChyID0+IHJbaWRGaWVsZF0gPT0gbikpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0ZS5zZWxlY3RlZGl0ZW1zLnB1c2goaXRlbXNbaV0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgaWYgKGRhdGEpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGlkczIgPSBkYXRhLm1hcChuID0+IG5baWRGaWVsZF0pO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zdGF0ZS5zZWxlY3RlZGl0ZW1zID0gdGhpcy5zdGF0ZS5zZWxlY3RlZGl0ZW1zLmZpbHRlcihuID0+IHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gaWRzMi5pbmRleE9mKG5baWRGaWVsZF0pID09PSAtMTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLnN0YXRlJC5uZXh0KHRoaXMuc3RhdGUpO1xyXG4gICAgfVxyXG5cclxuICAgIHVuU2VsZWN0KGlkOiBhbnkpIHtcclxuICAgICAgICBpZiAoaWQpIHtcclxuICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoaWQpKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlLnNlbGVjdGVkaXRlbXMgPSB0aGlzLnN0YXRlLnNlbGVjdGVkaXRlbXMuZmlsdGVyKG4gPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBpZC5pbmRleE9mKG5bdGhpcy5pZEZpZWxkXSkgPT09IC0xO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlLnNlbGVjdGVkaXRlbXMgPSB0aGlzLnN0YXRlLnNlbGVjdGVkaXRlbXMuZmlsdGVyKG4gPT4gblt0aGlzLmlkRmllbGRdICE9IGlkKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgdGhpcy5zdGF0ZSQubmV4dCh0aGlzLnN0YXRlKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgY2xlYXJTZWxlY3Rpb25zKCkge1xyXG4gICAgICAgIHRoaXMuc3RhdGUuc2VsZWN0ZWRpdGVtcyA9IFtdO1xyXG4gICAgICAgIHRoaXMuc3RhdGUkLm5leHQodGhpcy5zdGF0ZSk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8jZW5kcmVnaW9uXHJcblxyXG59XHJcbiJdfQ==