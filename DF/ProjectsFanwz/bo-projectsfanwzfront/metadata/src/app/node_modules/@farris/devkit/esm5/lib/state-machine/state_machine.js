import { BehaviorSubject } from 'rxjs';
import { MetadataUtil } from '../metadata/index';
import { StateMachineContext } from './context';
import { State, initialUIState } from './types';
import { StateMachineEvent } from './state_machine_event';
/**
 * 预置界面效果处理
 */
export var effectHandlers = {
    /**
     * 预置状态迁移处理
     */
    transit: {
        /**
         * 执行状态迁移
         * @param stateMachine  状态机对象
         * @param stateName     下一状态的名称
         * @param preconditions 迁移条件
         */
        // tslint:disable-next-line: only-arrow-functions
        perform: function (statemachine, stateName, preconditons) {
            if (preconditons === void 0) { preconditons = []; }
            var nextState = statemachine.states[stateName];
            statemachine.context.transitTo(nextState.name);
            statemachine.render();
        }
    }
};
/**
 * 状态机
 *
 * ### 基本概念
 * 状态机中有三个重要的概念：
 * - 页面状态（State）：页面的整体状态，比如查看状态、编辑状态；
 * - 控件状态（RenderState）：控制具体控件的状态；
 * - 迁移动作（Action）：当动作发生时，将页面切换到指定的页面状态。
 *
 * ### 定义状态机
 *
 * **基本步骤**
 *
 * - 继承StateMachine基类，并添加NgStatemachine注解；
 * - 定义页面状态、控件状态、迁移动作。
 *
 * **状态机中的注解**
 *
 * - NgStatemachine：将类标记为状态机，并进行扩展；
 * - NgState：将属性标记为页面状态，通过initialState可以标记此状态是否为初始状态；
 * - NgRenderState：将属性标记为控件状态，通过render方法指定控件状态的切换规则，
 *   一般情况下是通过对页面状态进行逻辑运算来确定。
 * - NgAction：将属性标记为迁移动作，通过transitTo指定动作执行时要迁移到哪个页面状态。
 *
 * ```ts
 * @Injectable()
 * @NgStatemachine()
 * class SimpleStateMachine extends StateMachine {
 *
 *   // 查看状态，设置为初始状态
 *   @NgState({ initialState: true })
 *   viewState: State;
 *
 *   // 编辑状态
 *   @NgState()
 *   editState: State;
 *
 *   // 编辑按钮是否允许点击
 *   @NgRenderState({
 *     render: (context) => context.state === 'viewState'
 *   })
 *   canEdit: RenderState;
 *
 *   // 保存按钮是否允许点击
 *   @NgRenderState({
 *     render: (context) => context.state === 'editState'
 *   })
 *   canSave: RenderState;
 *
 *   // 输入控件是否允许输入
 *   @NgRenderState({
 *     render: (context) => context.state === 'editState'
 *   })
 *   canInput: RenderState;
 *
 *   // 迁移到编辑状态
 *   @NgAction({ transitTo: 'editState' })
 *   edit: Action;
 *
 *   // 迁移到查看状态
 *   @NgAction({ transitTo: 'viewState' })
 *   view: Action;
 * }
 * ```
 * 在上边的代码中做了如下定义：
 * - 两个页面状态：查看状态、编辑状态，
 * - 三个控件状态：分别用来控制编辑按钮、保存按钮、输入控件的状态，
 * - 两个迁移动作：view动作用来将页面切换到查看状态，edit动作用来将页面切换到编辑状态。
 *
 *
 * ### 在模板中使用状态机
 *
 * 模板中我们主要使用的是控件状态，多个控件可以共享一个控件状态。
 *
 * ```html
 * <button type="button" [disabled]="!viewModel.stateMachine.canEdit">编辑</button>
 * <button type="button" [disabled]="!viewModel.stateMachine.canSave">保存</button>
 * <input id="code" [disabled]="!viewModel.stateMachine.canInput" />
 * <input id="name" [disabled]="!viewModel.stateMachine.canInput" />
 * ```
 *
 * ### 执行状态迁移
 * 通过执行状态机上的动作来将页面切换到页面状态，进而改变控件状态。
 * 假设我们有这么一个场景，当用户点击保存按钮的时候，我们先执行保存，保存完成后将状态迁移到查看状态。
 * 我们可以定义一个CommandHandler，添加两个对应的任务，具体代码如下：
 * ```ts
 * @Injectable()
 * @NgCommandHandler({
 *   commandName: 'save'
 * })
 * class SaveHandler extends CommandHandler {
 *
 *   schedule() {
 *     this.addTask('save', () => {
 *       // 实现保存
 *     });
 *
 *     // 状态迁移
 *     this.addTask('transitState', ) => {
 *       this.stateMachine['view']();
 *     });
 *   }
 * }
 * ```
 */
var StateMachine = /** @class */ (function () {
    /**
     * 构造函数
     */
    function StateMachine() {
        var _this = this;
        this.isStateInited = false;
        var propsMetadatas = MetadataUtil.getPropsMetadatas(this.constructor);
        // 遍历所有属性装饰器，并调用相应的build方法
        if (propsMetadatas) {
            Object.keys(propsMetadatas).forEach(function (propName) {
                var propMetadatas = propsMetadatas[propName];
                propMetadatas.forEach(function (propMetadata) {
                    _this['build' + propMetadata.ngMetadataName](propName, propMetadata);
                });
            });
        }
        // if (!this.initialState) {
        //   throw new Error('请在NgState注解中指定状态机的初始状态。');
        // }
        this.stateChange = new BehaviorSubject(false);
        this.context = new StateMachineContext(this);
        this.stateMachineEvent = new StateMachineEvent(this);
    }
    // 状态机变更，为了在绑定数据之后执行状态机的操作，把render方法延后执行。
    StateMachine.prototype.initialize = function (frameContext, variableParseService) {
        this.appContext = frameContext.appContext;
        this.frameContext = frameContext;
        var stateMachineMetadata = this.appContext.metadata.stateMachine || this.collectionMetadata();
        this.metadatas = stateMachineMetadata;
        this.buildStateMachine(stateMachineMetadata);
        // if (!this.initialState) {
        //   throw new Error('请在NgState注解中指定状态机的初始状态。');
        // }
        this.context.initialize(variableParseService, this.initialState);
        this.stateMachineEvent.initialize(this.frameContext);
        this.render();
    };
    StateMachine.prototype.collectionMetadata = function () {
        var stateMachineMetadata = {
            states: {},
            renderStates: {},
            actions: {}
        };
        var propsMetadatas = MetadataUtil.getPropsMetadatas(this.constructor);
        if (propsMetadatas) {
            Object.keys(propsMetadatas).forEach(function (propName) {
                var propMetadatas = propsMetadatas[propName];
                propMetadatas.forEach(function (propMetadata) {
                    switch (propMetadata.ngMetadataName) {
                        case 'NgState':
                            stateMachineMetadata.states[propName] = propMetadata;
                            break;
                        case 'NgRenderState':
                            stateMachineMetadata.renderStates[propName] = propMetadata;
                            break;
                        case 'NgAction':
                            stateMachineMetadata.actions[propName] = propMetadata;
                            break;
                    }
                });
            });
        }
        return stateMachineMetadata;
    };
    StateMachine.prototype.buildStateMachine = function (metadata) {
        var _this = this;
        Object.keys(metadata.states).forEach(function (stateName) {
            _this.buildNgState(stateName, metadata.states[stateName]);
        });
        Object.keys(metadata.renderStates).forEach(function (renderStateName) {
            _this.buildNgRenderState(renderStateName, metadata.renderStates[renderStateName]);
        });
        Object.keys(metadata.actions).forEach(function (actionName) {
            _this.buildNgAction(actionName, metadata.actions[actionName]);
        });
    };
    /**
     * 构造状态
     * @param stateName 状态名称
     * @param ngState   状态对象
     */
    StateMachine.prototype.buildNgState = function (stateName, ngState) {
        this.states = this.states || {};
        this[stateName] = new State(stateName);
        this.states[stateName] = this[stateName];
        if (ngState.initialState) {
            this.initialState = this[stateName];
        }
    };
    /**
     * 构造界面状态
     * @param renderStateName 渲染状态名称
     * @param ngRenderState   渲染状态元数据
     */
    StateMachine.prototype.buildNgRenderState = function (renderStateName, ngRenderState) {
        this.renderStates = this.renderStates || {};
        this[renderStateName] = initialUIState;
        this.renderStates[renderStateName] = this[renderStateName];
        // 将renderState上指定的render加入到renders中
        this.renders = this.renders || {};
        this.renders[renderStateName] = ngRenderState.render;
    };
    /**
     * 构造动作
     * @param actionName 动作名称
     * @param ngAction   动作元数据
     */
    StateMachine.prototype.buildNgAction = function (actionName, ngAction) {
        var _this = this;
        this[actionName] = function () {
            effectHandlers.transit.perform(_this, ngAction.transitTo, ngAction.precondition);
        };
    };
    /**
     * 重新计算所有渲染状态的值
     * 当 state切换的时候，调用遍历所有的render方法，更改renderState
     */
    StateMachine.prototype.render = function () {
        for (var renderStateName in this.renderStates) {
            if (this.renderStates.hasOwnProperty(renderStateName) === false) {
                continue;
            }
            var stateRender = this.renders[renderStateName];
            if (!stateRender) {
                continue;
            }
            // 调用render方法，更新renderState
            this.renderStates[renderStateName] = stateRender(this.context);
            this[renderStateName] = this.renderStates[renderStateName];
        }
        this.stateChange.next(this.context.state);
    };
    return StateMachine;
}());
export { StateMachine };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhdGVfbWFjaGluZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL3N0YXRlLW1hY2hpbmUvc3RhdGVfbWFjaGluZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3ZDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNqRCxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFFaEQsT0FBTyxFQUNMLEtBQUssRUFBRSxjQUFjLEVBRXRCLE1BQU0sU0FBUyxDQUFDO0FBRWpCLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBd0IxRDs7R0FFRztBQUNILE1BQU0sQ0FBQyxJQUFNLGNBQWMsR0FBRztJQUU1Qjs7T0FFRztJQUNILE9BQU8sRUFBRTtRQUVQOzs7OztXQUtHO1FBQ0gsaURBQWlEO1FBQ2pELE9BQU8sRUFBRSxVQUFVLFlBQTBCLEVBQUUsU0FBaUIsRUFBRSxZQUF3QjtZQUF4Qiw2QkFBQSxFQUFBLGlCQUF3QjtZQUN4RixJQUFNLFNBQVMsR0FBVSxZQUFZLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQ3hELFlBQVksQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUMvQyxZQUFZLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDeEIsQ0FBQztLQUNGO0NBQ0YsQ0FBQztBQUVGOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQXdHRztBQUNIO0lBNENFOztPQUVHO0lBQ0g7UUFBQSxpQkFvQkM7UUFsRU8sa0JBQWEsR0FBRyxLQUFLLENBQUM7UUErQzVCLElBQU0sY0FBYyxHQUFHLFlBQVksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7UUFFeEUsMEJBQTBCO1FBQzFCLElBQUksY0FBYyxFQUFFO1lBQ2xCLE1BQU0sQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUMsT0FBTyxDQUFDLFVBQUMsUUFBZ0I7Z0JBQ25ELElBQU0sYUFBYSxHQUFHLGNBQWMsQ0FBQyxRQUFRLENBQUMsQ0FBQztnQkFDL0MsYUFBYSxDQUFDLE9BQU8sQ0FBQyxVQUFBLFlBQVk7b0JBQ2hDLEtBQUksQ0FBQyxPQUFPLEdBQUcsWUFBWSxDQUFDLGNBQWMsQ0FBQyxDQUFDLFFBQVEsRUFBRSxZQUFZLENBQUMsQ0FBQztnQkFDdEUsQ0FBQyxDQUFDLENBQUM7WUFDTCxDQUFDLENBQUMsQ0FBQztTQUNKO1FBRUQsNEJBQTRCO1FBQzVCLGdEQUFnRDtRQUNoRCxJQUFJO1FBRUosSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLGVBQWUsQ0FBTSxLQUFLLENBQUMsQ0FBQztRQUNuRCxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksbUJBQW1CLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDN0MsSUFBSSxDQUFDLGlCQUFpQixHQUFHLElBQUksaUJBQWlCLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDdkQsQ0FBQztJQUVELHlDQUF5QztJQUN6QyxpQ0FBVSxHQUFWLFVBQVcsWUFBMEIsRUFBRSxvQkFBMEM7UUFDL0UsSUFBSSxDQUFDLFVBQVUsR0FBRyxZQUFZLENBQUMsVUFBVSxDQUFDO1FBQzFDLElBQUksQ0FBQyxZQUFZLEdBQUcsWUFBWSxDQUFDO1FBQ2pDLElBQU0sb0JBQW9CLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsWUFBWSxJQUFJLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO1FBQ2hHLElBQUksQ0FBQyxTQUFTLEdBQUcsb0JBQW9CLENBQUM7UUFDdEMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLG9CQUFvQixDQUFDLENBQUM7UUFDN0MsNEJBQTRCO1FBQzVCLGdEQUFnRDtRQUNoRCxJQUFJO1FBQ0osSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsb0JBQW9CLEVBQUUsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQ2pFLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQ3JELElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztJQUNoQixDQUFDO0lBRU8seUNBQWtCLEdBQTFCO1FBS0UsSUFBTSxvQkFBb0IsR0FBRztZQUMzQixNQUFNLEVBQUUsRUFBRTtZQUNWLFlBQVksRUFBRSxFQUFFO1lBQ2hCLE9BQU8sRUFBRSxFQUFFO1NBQ1osQ0FBQztRQUNGLElBQU0sY0FBYyxHQUFHLFlBQVksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDeEUsSUFBSSxjQUFjLEVBQUU7WUFDbEIsTUFBTSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQyxPQUFPLENBQUMsVUFBQyxRQUFnQjtnQkFDbkQsSUFBTSxhQUFhLEdBQUcsY0FBYyxDQUFDLFFBQVEsQ0FBQyxDQUFDO2dCQUMvQyxhQUFhLENBQUMsT0FBTyxDQUFDLFVBQUEsWUFBWTtvQkFDaEMsUUFBUSxZQUFZLENBQUMsY0FBYyxFQUFFO3dCQUNuQyxLQUFLLFNBQVM7NEJBQ1osb0JBQW9CLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxHQUFHLFlBQVksQ0FBQzs0QkFDckQsTUFBTTt3QkFDUixLQUFLLGVBQWU7NEJBQ2xCLG9CQUFvQixDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsR0FBRyxZQUFZLENBQUM7NEJBQzNELE1BQU07d0JBQ1IsS0FBSyxVQUFVOzRCQUNiLG9CQUFvQixDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsR0FBRyxZQUFZLENBQUM7NEJBQ3RELE1BQU07cUJBQ1Q7Z0JBQ0gsQ0FBQyxDQUFDLENBQUM7WUFDTCxDQUFDLENBQUMsQ0FBQztTQUNKO1FBQ0QsT0FBTyxvQkFBb0IsQ0FBQztJQUM5QixDQUFDO0lBRU8sd0NBQWlCLEdBQXpCLFVBQTBCLFFBSXpCO1FBSkQsaUJBZ0JDO1FBWEMsTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsT0FBTyxDQUFDLFVBQUMsU0FBaUI7WUFDckQsS0FBSSxDQUFDLFlBQVksQ0FBQyxTQUFTLEVBQUUsUUFBUSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO1FBQzNELENBQUMsQ0FBQyxDQUFDO1FBRUgsTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLENBQUMsT0FBTyxDQUFDLFVBQUMsZUFBdUI7WUFDakUsS0FBSSxDQUFDLGtCQUFrQixDQUFDLGVBQWUsRUFBRSxRQUFRLENBQUMsWUFBWSxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUM7UUFDbkYsQ0FBQyxDQUFDLENBQUM7UUFFSCxNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxPQUFPLENBQUMsVUFBQyxVQUFrQjtZQUN2RCxLQUFJLENBQUMsYUFBYSxDQUFDLFVBQVUsRUFBRSxRQUFRLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7UUFDL0QsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQ7Ozs7T0FJRztJQUNLLG1DQUFZLEdBQXBCLFVBQXFCLFNBQWlCLEVBQUUsT0FBZ0I7UUFDdEQsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsTUFBTSxJQUFJLEVBQUUsQ0FBQztRQUNoQyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsSUFBSSxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDdkMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDekMsSUFBSSxPQUFPLENBQUMsWUFBWSxFQUFFO1lBQ3hCLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1NBQ3JDO0lBQ0gsQ0FBQztJQUVEOzs7O09BSUc7SUFDSyx5Q0FBa0IsR0FBMUIsVUFBMkIsZUFBdUIsRUFBRSxhQUE0QjtRQUM5RSxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxZQUFZLElBQUksRUFBRSxDQUFDO1FBQzVDLElBQUksQ0FBQyxlQUFlLENBQUMsR0FBRyxjQUFjLENBQUM7UUFDdkMsSUFBSSxDQUFDLFlBQVksQ0FBQyxlQUFlLENBQUMsR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUM7UUFFM0Qsb0NBQW9DO1FBQ3BDLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLE9BQU8sSUFBSSxFQUFFLENBQUM7UUFDbEMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxlQUFlLENBQUMsR0FBRyxhQUFhLENBQUMsTUFBTSxDQUFDO0lBQ3ZELENBQUM7SUFFRDs7OztPQUlHO0lBQ0ssb0NBQWEsR0FBckIsVUFBc0IsVUFBa0IsRUFBRSxRQUFrQjtRQUE1RCxpQkFJQztRQUhDLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRztZQUNqQixjQUFjLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxLQUFJLEVBQUUsUUFBUSxDQUFDLFNBQVMsRUFBRSxRQUFRLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDbEYsQ0FBQyxDQUFDO0lBQ0osQ0FBQztJQUVEOzs7T0FHRztJQUNILDZCQUFNLEdBQU47UUFDRSxLQUFLLElBQU0sZUFBZSxJQUFJLElBQUksQ0FBQyxZQUFZLEVBQUU7WUFFL0MsSUFBSSxJQUFJLENBQUMsWUFBWSxDQUFDLGNBQWMsQ0FBQyxlQUFlLENBQUMsS0FBSyxLQUFLLEVBQUU7Z0JBQy9ELFNBQVM7YUFDVjtZQUVELElBQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUM7WUFDbEQsSUFBSSxDQUFDLFdBQVcsRUFBRTtnQkFDaEIsU0FBUzthQUNWO1lBRUQsMkJBQTJCO1lBQzNCLElBQUksQ0FBQyxZQUFZLENBQUMsZUFBZSxDQUFDLEdBQUcsV0FBVyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUMvRCxJQUFJLENBQUMsZUFBZSxDQUFDLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxlQUFlLENBQUMsQ0FBQztTQUM1RDtRQUNELElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDNUMsQ0FBQztJQUNILG1CQUFDO0FBQUQsQ0FBQyxBQXBNRCxJQW9NQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBNZXRhZGF0YVV0aWwgfSBmcm9tICcuLi9tZXRhZGF0YS9pbmRleCc7XHJcbmltcG9ydCB7IFN0YXRlTWFjaGluZUNvbnRleHQgfSBmcm9tICcuL2NvbnRleHQnO1xyXG5pbXBvcnQgeyBOZ1N0YXRlLCBOZ0FjdGlvbiwgTmdSZW5kZXJTdGF0ZSB9IGZyb20gJy4vZGVjb3JhdG9ycyc7XHJcbmltcG9ydCB7XHJcbiAgU3RhdGUsIGluaXRpYWxVSVN0YXRlLCBFZmZlY3QsIFJlbmRlcixcclxuICBTdGF0ZURpY3Rpb25hcnksIFJlbmRlclN0YXRlRGljdGlvbmFyeSwgUmVuZGVyRGljdGlvbmFyeVxyXG59IGZyb20gJy4vdHlwZXMnO1xyXG5pbXBvcnQgeyBGcmFtZUNvbnRleHQgfSBmcm9tICcuLi9mcmFtZS9pbmRleCc7XHJcbmltcG9ydCB7IFN0YXRlTWFjaGluZUV2ZW50IH0gZnJvbSAnLi9zdGF0ZV9tYWNoaW5lX2V2ZW50JztcclxuaW1wb3J0IHsgVmFyaWFibGVQYXJzZVNlcnZpY2UgfSBmcm9tICcuLi92YXJpYWJsZS92YXJpYWJsZV9wYXJzZV9zZXJ2aWNlJztcclxuXHJcbi8qKlxyXG4gKiDnirbmgIHmnLrliJ3lp4vljJbphY3nva7lr7nosaFcclxuICovXHJcbmV4cG9ydCBpbnRlcmZhY2UgU3RhdGVNYWNoaW5lT3B0aW9uIHtcclxuXHJcbiAgLyoqXHJcbiAgICog55WM6Z2i5riy5p+T5o+P6L+wXHJcbiAgICovXHJcbiAgcmVuZGVycz86IHsgW2luZGV4OiBzdHJpbmddOiBSZW5kZXIgfTtcclxuXHJcbiAgLyoqXHJcbiAgICog54q25oCB6ZuG5ZCIXHJcbiAgICovXHJcbiAgc3RhdGVzPzogc3RyaW5nW107XHJcblxyXG4gIC8qKlxyXG4gICAqIOeKtuaAgeacuueVjOmdouaOp+WItuaViOaenFxyXG4gICAqL1xyXG4gIGVmZmVjdHM/OiB7IFtpbmRleDogc3RyaW5nXTogRWZmZWN0IH07XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDpooTnva7nlYzpnaLmlYjmnpzlpITnkIZcclxuICovXHJcbmV4cG9ydCBjb25zdCBlZmZlY3RIYW5kbGVycyA9IHtcclxuXHJcbiAgLyoqXHJcbiAgICog6aKE572u54q25oCB6L+B56e75aSE55CGXHJcbiAgICovXHJcbiAgdHJhbnNpdDoge1xyXG5cclxuICAgIC8qKlxyXG4gICAgICog5omn6KGM54q25oCB6L+B56e7XHJcbiAgICAgKiBAcGFyYW0gc3RhdGVNYWNoaW5lICDnirbmgIHmnLrlr7nosaFcclxuICAgICAqIEBwYXJhbSBzdGF0ZU5hbWUgICAgIOS4i+S4gOeKtuaAgeeahOWQjeensFxyXG4gICAgICogQHBhcmFtIHByZWNvbmRpdGlvbnMg6L+B56e75p2h5Lu2XHJcbiAgICAgKi9cclxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogb25seS1hcnJvdy1mdW5jdGlvbnNcclxuICAgIHBlcmZvcm06IGZ1bmN0aW9uIChzdGF0ZW1hY2hpbmU6IFN0YXRlTWFjaGluZSwgc3RhdGVOYW1lOiBzdHJpbmcsIHByZWNvbmRpdG9uczogYW55W10gPSBbXSkge1xyXG4gICAgICBjb25zdCBuZXh0U3RhdGU6IFN0YXRlID0gc3RhdGVtYWNoaW5lLnN0YXRlc1tzdGF0ZU5hbWVdO1xyXG4gICAgICBzdGF0ZW1hY2hpbmUuY29udGV4dC50cmFuc2l0VG8obmV4dFN0YXRlLm5hbWUpO1xyXG4gICAgICBzdGF0ZW1hY2hpbmUucmVuZGVyKCk7XHJcbiAgICB9XHJcbiAgfVxyXG59O1xyXG5cclxuLyoqXHJcbiAqIOeKtuaAgeaculxyXG4gKlxyXG4gKiAjIyMg5Z+65pys5qaC5b+1XHJcbiAqIOeKtuaAgeacuuS4reacieS4ieS4qumHjeimgeeahOamguW/te+8mlxyXG4gKiAtIOmhtemdoueKtuaAge+8iFN0YXRl77yJ77ya6aG16Z2i55qE5pW05L2T54q25oCB77yM5q+U5aaC5p+l55yL54q25oCB44CB57yW6L6R54q25oCB77ybXHJcbiAqIC0g5o6n5Lu254q25oCB77yIUmVuZGVyU3RhdGXvvInvvJrmjqfliLblhbfkvZPmjqfku7bnmoTnirbmgIHvvJtcclxuICogLSDov4Hnp7vliqjkvZzvvIhBY3Rpb27vvInvvJrlvZPliqjkvZzlj5HnlJ/ml7bvvIzlsIbpobXpnaLliIfmjaLliLDmjIflrprnmoTpobXpnaLnirbmgIHjgIJcclxuICpcclxuICogIyMjIOWumuS5ieeKtuaAgeaculxyXG4gKlxyXG4gKiAqKuWfuuacrOatpemqpCoqXHJcbiAqXHJcbiAqIC0g57un5om/U3RhdGVNYWNoaW5l5Z+657G777yM5bm25re75YqgTmdTdGF0ZW1hY2hpbmXms6jop6PvvJtcclxuICogLSDlrprkuYnpobXpnaLnirbmgIHjgIHmjqfku7bnirbmgIHjgIHov4Hnp7vliqjkvZzjgIJcclxuICpcclxuICogKirnirbmgIHmnLrkuK3nmoTms6jop6MqKlxyXG4gKlxyXG4gKiAtIE5nU3RhdGVtYWNoaW5l77ya5bCG57G75qCH6K6w5Li654q25oCB5py677yM5bm26L+b6KGM5omp5bGV77ybXHJcbiAqIC0gTmdTdGF0Ze+8muWwhuWxnuaAp+agh+iusOS4uumhtemdoueKtuaAge+8jOmAmui/h2luaXRpYWxTdGF0ZeWPr+S7peagh+iusOatpOeKtuaAgeaYr+WQpuS4uuWIneWni+eKtuaAge+8m1xyXG4gKiAtIE5nUmVuZGVyU3RhdGXvvJrlsIblsZ7mgKfmoIforrDkuLrmjqfku7bnirbmgIHvvIzpgJrov4dyZW5kZXLmlrnms5XmjIflrprmjqfku7bnirbmgIHnmoTliIfmjaLop4TliJnvvIxcclxuICogICDkuIDoiKzmg4XlhrXkuIvmmK/pgJrov4flr7npobXpnaLnirbmgIHov5vooYzpgLvovpHov5DnrpfmnaXnoa7lrprjgIJcclxuICogLSBOZ0FjdGlvbu+8muWwhuWxnuaAp+agh+iusOS4uui/geenu+WKqOS9nO+8jOmAmui/h3RyYW5zaXRUb+aMh+WumuWKqOS9nOaJp+ihjOaXtuimgei/geenu+WIsOWTquS4qumhtemdoueKtuaAgeOAglxyXG4gKlxyXG4gKiBgYGB0c1xyXG4gKiBASW5qZWN0YWJsZSgpXHJcbiAqIEBOZ1N0YXRlbWFjaGluZSgpXHJcbiAqIGNsYXNzIFNpbXBsZVN0YXRlTWFjaGluZSBleHRlbmRzIFN0YXRlTWFjaGluZSB7XHJcbiAqXHJcbiAqICAgLy8g5p+l55yL54q25oCB77yM6K6+572u5Li65Yid5aeL54q25oCBXHJcbiAqICAgQE5nU3RhdGUoeyBpbml0aWFsU3RhdGU6IHRydWUgfSlcclxuICogICB2aWV3U3RhdGU6IFN0YXRlO1xyXG4gKlxyXG4gKiAgIC8vIOe8lui+keeKtuaAgVxyXG4gKiAgIEBOZ1N0YXRlKClcclxuICogICBlZGl0U3RhdGU6IFN0YXRlO1xyXG4gKlxyXG4gKiAgIC8vIOe8lui+keaMiemSruaYr+WQpuWFgeiuuOeCueWHu1xyXG4gKiAgIEBOZ1JlbmRlclN0YXRlKHtcclxuICogICAgIHJlbmRlcjogKGNvbnRleHQpID0+IGNvbnRleHQuc3RhdGUgPT09ICd2aWV3U3RhdGUnXHJcbiAqICAgfSlcclxuICogICBjYW5FZGl0OiBSZW5kZXJTdGF0ZTtcclxuICpcclxuICogICAvLyDkv53lrZjmjInpkq7mmK/lkKblhYHorrjngrnlh7tcclxuICogICBATmdSZW5kZXJTdGF0ZSh7XHJcbiAqICAgICByZW5kZXI6IChjb250ZXh0KSA9PiBjb250ZXh0LnN0YXRlID09PSAnZWRpdFN0YXRlJ1xyXG4gKiAgIH0pXHJcbiAqICAgY2FuU2F2ZTogUmVuZGVyU3RhdGU7XHJcbiAqXHJcbiAqICAgLy8g6L6T5YWl5o6n5Lu25piv5ZCm5YWB6K646L6T5YWlXHJcbiAqICAgQE5nUmVuZGVyU3RhdGUoe1xyXG4gKiAgICAgcmVuZGVyOiAoY29udGV4dCkgPT4gY29udGV4dC5zdGF0ZSA9PT0gJ2VkaXRTdGF0ZSdcclxuICogICB9KVxyXG4gKiAgIGNhbklucHV0OiBSZW5kZXJTdGF0ZTtcclxuICpcclxuICogICAvLyDov4Hnp7vliLDnvJbovpHnirbmgIFcclxuICogICBATmdBY3Rpb24oeyB0cmFuc2l0VG86ICdlZGl0U3RhdGUnIH0pXHJcbiAqICAgZWRpdDogQWN0aW9uO1xyXG4gKlxyXG4gKiAgIC8vIOi/geenu+WIsOafpeeci+eKtuaAgVxyXG4gKiAgIEBOZ0FjdGlvbih7IHRyYW5zaXRUbzogJ3ZpZXdTdGF0ZScgfSlcclxuICogICB2aWV3OiBBY3Rpb247XHJcbiAqIH1cclxuICogYGBgXHJcbiAqIOWcqOS4iui+ueeahOS7o+eggeS4reWBmuS6huWmguS4i+WumuS5ie+8mlxyXG4gKiAtIOS4pOS4qumhtemdoueKtuaAge+8muafpeeci+eKtuaAgeOAgee8lui+keeKtuaAge+8jFxyXG4gKiAtIOS4ieS4quaOp+S7tueKtuaAge+8muWIhuWIq+eUqOadpeaOp+WItue8lui+keaMiemSruOAgeS/neWtmOaMiemSruOAgei+k+WFpeaOp+S7tueahOeKtuaAge+8jFxyXG4gKiAtIOS4pOS4qui/geenu+WKqOS9nO+8mnZpZXfliqjkvZznlKjmnaXlsIbpobXpnaLliIfmjaLliLDmn6XnnIvnirbmgIHvvIxlZGl05Yqo5L2c55So5p2l5bCG6aG16Z2i5YiH5o2i5Yiw57yW6L6R54q25oCB44CCXHJcbiAqXHJcbiAqXHJcbiAqICMjIyDlnKjmqKHmnb/kuK3kvb/nlKjnirbmgIHmnLpcclxuICpcclxuICog5qih5p2/5Lit5oiR5Lus5Li76KaB5L2/55So55qE5piv5o6n5Lu254q25oCB77yM5aSa5Liq5o6n5Lu25Y+v5Lul5YWx5Lqr5LiA5Liq5o6n5Lu254q25oCB44CCXHJcbiAqXHJcbiAqIGBgYGh0bWxcclxuICogPGJ1dHRvbiB0eXBlPVwiYnV0dG9uXCIgW2Rpc2FibGVkXT1cIiF2aWV3TW9kZWwuc3RhdGVNYWNoaW5lLmNhbkVkaXRcIj7nvJbovpE8L2J1dHRvbj5cclxuICogPGJ1dHRvbiB0eXBlPVwiYnV0dG9uXCIgW2Rpc2FibGVkXT1cIiF2aWV3TW9kZWwuc3RhdGVNYWNoaW5lLmNhblNhdmVcIj7kv53lrZg8L2J1dHRvbj5cclxuICogPGlucHV0IGlkPVwiY29kZVwiIFtkaXNhYmxlZF09XCIhdmlld01vZGVsLnN0YXRlTWFjaGluZS5jYW5JbnB1dFwiIC8+XHJcbiAqIDxpbnB1dCBpZD1cIm5hbWVcIiBbZGlzYWJsZWRdPVwiIXZpZXdNb2RlbC5zdGF0ZU1hY2hpbmUuY2FuSW5wdXRcIiAvPlxyXG4gKiBgYGBcclxuICpcclxuICogIyMjIOaJp+ihjOeKtuaAgei/geenu1xyXG4gKiDpgJrov4fmiafooYznirbmgIHmnLrkuIrnmoTliqjkvZzmnaXlsIbpobXpnaLliIfmjaLliLDpobXpnaLnirbmgIHvvIzov5vogIzmlLnlj5jmjqfku7bnirbmgIHjgIJcclxuICog5YGH6K6+5oiR5Lus5pyJ6L+Z5LmI5LiA5Liq5Zy65pmv77yM5b2T55So5oi354K55Ye75L+d5a2Y5oyJ6ZKu55qE5pe25YCZ77yM5oiR5Lus5YWI5omn6KGM5L+d5a2Y77yM5L+d5a2Y5a6M5oiQ5ZCO5bCG54q25oCB6L+B56e75Yiw5p+l55yL54q25oCB44CCXHJcbiAqIOaIkeS7rOWPr+S7peWumuS5ieS4gOS4qkNvbW1hbmRIYW5kbGVy77yM5re75Yqg5Lik5Liq5a+55bqU55qE5Lu75Yqh77yM5YW35L2T5Luj56CB5aaC5LiL77yaXHJcbiAqIGBgYHRzXHJcbiAqIEBJbmplY3RhYmxlKClcclxuICogQE5nQ29tbWFuZEhhbmRsZXIoe1xyXG4gKiAgIGNvbW1hbmROYW1lOiAnc2F2ZSdcclxuICogfSlcclxuICogY2xhc3MgU2F2ZUhhbmRsZXIgZXh0ZW5kcyBDb21tYW5kSGFuZGxlciB7XHJcbiAqXHJcbiAqICAgc2NoZWR1bGUoKSB7XHJcbiAqICAgICB0aGlzLmFkZFRhc2soJ3NhdmUnLCAoKSA9PiB7XHJcbiAqICAgICAgIC8vIOWunueOsOS/neWtmFxyXG4gKiAgICAgfSk7XHJcbiAqXHJcbiAqICAgICAvLyDnirbmgIHov4Hnp7tcclxuICogICAgIHRoaXMuYWRkVGFzaygndHJhbnNpdFN0YXRlJywgKSA9PiB7XHJcbiAqICAgICAgIHRoaXMuc3RhdGVNYWNoaW5lWyd2aWV3J10oKTtcclxuICogICAgIH0pO1xyXG4gKiAgIH1cclxuICogfVxyXG4gKiBgYGBcclxuICovXHJcbmV4cG9ydCBjbGFzcyBTdGF0ZU1hY2hpbmUge1xyXG4gIHByaXZhdGUgaXNTdGF0ZUluaXRlZCA9IGZhbHNlO1xyXG4gIC8qKlxyXG4gICAqIOWIneWni+eKtuaAgVxyXG4gICAqL1xyXG4gIHB1YmxpYyBpbml0aWFsU3RhdGU6IFN0YXRlO1xyXG5cclxuICAvKipcclxuICAgKiDnirbmgIHlrZflhbhcclxuICAgKi9cclxuICBwdWJsaWMgc3RhdGVzOiBTdGF0ZURpY3Rpb25hcnk7XHJcblxyXG4gIC8qKlxyXG4gICAqIOa4suafk+eKtuaAgeWtl+WFuFxyXG4gICAqL1xyXG4gIHB1YmxpYyByZW5kZXJTdGF0ZXM6IFJlbmRlclN0YXRlRGljdGlvbmFyeTtcclxuXHJcbiAgLyoqXHJcbiAgICog5riy5p+T5Zmo5a2X5YW4XHJcbiAgICovXHJcbiAgcHVibGljIHJlbmRlcnM6IFJlbmRlckRpY3Rpb25hcnk7XHJcblxyXG4gIC8qKlxyXG4gICAqIOeKtuaAgeacuuS4iuS4i+aWh1xyXG4gICAqL1xyXG4gIHB1YmxpYyBjb250ZXh0OiBTdGF0ZU1hY2hpbmVDb250ZXh0O1xyXG5cclxuICAvKipcclxuICAgKiDnirbmgIHlj5jmm7RcclxuICAgKi9cclxuICBwdWJsaWMgc3RhdGVDaGFuZ2U6IEJlaGF2aW9yU3ViamVjdDxzdHJpbmc+O1xyXG5cclxuICBwdWJsaWMgYXBwQ29udGV4dDogYW55O1xyXG5cclxuICBwdWJsaWMgZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQ7XHJcblxyXG4gIC8qKlxyXG4gICAqIOeKtuaAgeacuuS6i+S7tuebkeWQrFxyXG4gICAqL1xyXG4gIHB1YmxpYyBzdGF0ZU1hY2hpbmVFdmVudDogU3RhdGVNYWNoaW5lRXZlbnQ7XHJcbiAgLyoqXHJcbiAgICog54q25oCB5py65YWD5pWw5o2uXHJcbiAgICovXHJcbiAgcHVibGljIG1ldGFkYXRhczogeyBzdGF0ZXM6IHsgW3N0YXRlTmFtZTogc3RyaW5nXTogTmdTdGF0ZSB9LCByZW5kZXJTdGF0ZXM6IHsgW3JlbmRlclN0YXRlTmFtZTogc3RyaW5nXTogTmdSZW5kZXJTdGF0ZSB9LCBhY3Rpb25zOiB7IFthY3Rpb25OYW1lOiBzdHJpbmddOiBOZ0FjdGlvbiB9IH07XHJcbiAgLyoqXHJcbiAgICog5p6E6YCg5Ye95pWwXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IoKSB7XHJcbiAgICBjb25zdCBwcm9wc01ldGFkYXRhcyA9IE1ldGFkYXRhVXRpbC5nZXRQcm9wc01ldGFkYXRhcyh0aGlzLmNvbnN0cnVjdG9yKTtcclxuXHJcbiAgICAvLyDpgY3ljobmiYDmnInlsZ7mgKfoo4XppbDlmajvvIzlubbosIPnlKjnm7jlupTnmoRidWlsZOaWueazlVxyXG4gICAgaWYgKHByb3BzTWV0YWRhdGFzKSB7XHJcbiAgICAgIE9iamVjdC5rZXlzKHByb3BzTWV0YWRhdGFzKS5mb3JFYWNoKChwcm9wTmFtZTogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgY29uc3QgcHJvcE1ldGFkYXRhcyA9IHByb3BzTWV0YWRhdGFzW3Byb3BOYW1lXTtcclxuICAgICAgICBwcm9wTWV0YWRhdGFzLmZvckVhY2gocHJvcE1ldGFkYXRhID0+IHtcclxuICAgICAgICAgIHRoaXNbJ2J1aWxkJyArIHByb3BNZXRhZGF0YS5uZ01ldGFkYXRhTmFtZV0ocHJvcE5hbWUsIHByb3BNZXRhZGF0YSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIGlmICghdGhpcy5pbml0aWFsU3RhdGUpIHtcclxuICAgIC8vICAgdGhyb3cgbmV3IEVycm9yKCfor7flnKhOZ1N0YXRl5rOo6Kej5Lit5oyH5a6a54q25oCB5py655qE5Yid5aeL54q25oCB44CCJyk7XHJcbiAgICAvLyB9XHJcblxyXG4gICAgdGhpcy5zdGF0ZUNoYW5nZSA9IG5ldyBCZWhhdmlvclN1YmplY3Q8YW55PihmYWxzZSk7XHJcbiAgICB0aGlzLmNvbnRleHQgPSBuZXcgU3RhdGVNYWNoaW5lQ29udGV4dCh0aGlzKTtcclxuICAgIHRoaXMuc3RhdGVNYWNoaW5lRXZlbnQgPSBuZXcgU3RhdGVNYWNoaW5lRXZlbnQodGhpcyk7XHJcbiAgfVxyXG5cclxuICAvLyDnirbmgIHmnLrlj5jmm7TvvIzkuLrkuoblnKjnu5HlrprmlbDmja7kuYvlkI7miafooYznirbmgIHmnLrnmoTmk43kvZzvvIzmiopyZW5kZXLmlrnms5Xlu7blkI7miafooYzjgIJcclxuICBpbml0aWFsaXplKGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0LCB2YXJpYWJsZVBhcnNlU2VydmljZTogVmFyaWFibGVQYXJzZVNlcnZpY2UpIHtcclxuICAgIHRoaXMuYXBwQ29udGV4dCA9IGZyYW1lQ29udGV4dC5hcHBDb250ZXh0O1xyXG4gICAgdGhpcy5mcmFtZUNvbnRleHQgPSBmcmFtZUNvbnRleHQ7XHJcbiAgICBjb25zdCBzdGF0ZU1hY2hpbmVNZXRhZGF0YSA9IHRoaXMuYXBwQ29udGV4dC5tZXRhZGF0YS5zdGF0ZU1hY2hpbmUgfHwgdGhpcy5jb2xsZWN0aW9uTWV0YWRhdGEoKTtcclxuICAgIHRoaXMubWV0YWRhdGFzID0gc3RhdGVNYWNoaW5lTWV0YWRhdGE7XHJcbiAgICB0aGlzLmJ1aWxkU3RhdGVNYWNoaW5lKHN0YXRlTWFjaGluZU1ldGFkYXRhKTtcclxuICAgIC8vIGlmICghdGhpcy5pbml0aWFsU3RhdGUpIHtcclxuICAgIC8vICAgdGhyb3cgbmV3IEVycm9yKCfor7flnKhOZ1N0YXRl5rOo6Kej5Lit5oyH5a6a54q25oCB5py655qE5Yid5aeL54q25oCB44CCJyk7XHJcbiAgICAvLyB9XHJcbiAgICB0aGlzLmNvbnRleHQuaW5pdGlhbGl6ZSh2YXJpYWJsZVBhcnNlU2VydmljZSwgdGhpcy5pbml0aWFsU3RhdGUpO1xyXG4gICAgdGhpcy5zdGF0ZU1hY2hpbmVFdmVudC5pbml0aWFsaXplKHRoaXMuZnJhbWVDb250ZXh0KTtcclxuICAgIHRoaXMucmVuZGVyKCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGNvbGxlY3Rpb25NZXRhZGF0YSgpOiB7XHJcbiAgICBzdGF0ZXM6IHsgW3N0YXRlTmFtZTogc3RyaW5nXTogTmdTdGF0ZSB9LFxyXG4gICAgcmVuZGVyU3RhdGVzOiB7IFtyZW5kZXJTdGF0ZU5hbWU6IHN0cmluZ106IE5nUmVuZGVyU3RhdGUgfSxcclxuICAgIGFjdGlvbnM6IHsgW2FjdGlvbk5hbWU6IHN0cmluZ106IE5nQWN0aW9uIH1cclxuICB9IHtcclxuICAgIGNvbnN0IHN0YXRlTWFjaGluZU1ldGFkYXRhID0ge1xyXG4gICAgICBzdGF0ZXM6IHt9LFxyXG4gICAgICByZW5kZXJTdGF0ZXM6IHt9LFxyXG4gICAgICBhY3Rpb25zOiB7fVxyXG4gICAgfTtcclxuICAgIGNvbnN0IHByb3BzTWV0YWRhdGFzID0gTWV0YWRhdGFVdGlsLmdldFByb3BzTWV0YWRhdGFzKHRoaXMuY29uc3RydWN0b3IpO1xyXG4gICAgaWYgKHByb3BzTWV0YWRhdGFzKSB7XHJcbiAgICAgIE9iamVjdC5rZXlzKHByb3BzTWV0YWRhdGFzKS5mb3JFYWNoKChwcm9wTmFtZTogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgY29uc3QgcHJvcE1ldGFkYXRhcyA9IHByb3BzTWV0YWRhdGFzW3Byb3BOYW1lXTtcclxuICAgICAgICBwcm9wTWV0YWRhdGFzLmZvckVhY2gocHJvcE1ldGFkYXRhID0+IHtcclxuICAgICAgICAgIHN3aXRjaCAocHJvcE1ldGFkYXRhLm5nTWV0YWRhdGFOYW1lKSB7XHJcbiAgICAgICAgICAgIGNhc2UgJ05nU3RhdGUnOlxyXG4gICAgICAgICAgICAgIHN0YXRlTWFjaGluZU1ldGFkYXRhLnN0YXRlc1twcm9wTmFtZV0gPSBwcm9wTWV0YWRhdGE7XHJcbiAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgJ05nUmVuZGVyU3RhdGUnOlxyXG4gICAgICAgICAgICAgIHN0YXRlTWFjaGluZU1ldGFkYXRhLnJlbmRlclN0YXRlc1twcm9wTmFtZV0gPSBwcm9wTWV0YWRhdGE7XHJcbiAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgJ05nQWN0aW9uJzpcclxuICAgICAgICAgICAgICBzdGF0ZU1hY2hpbmVNZXRhZGF0YS5hY3Rpb25zW3Byb3BOYW1lXSA9IHByb3BNZXRhZGF0YTtcclxuICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gc3RhdGVNYWNoaW5lTWV0YWRhdGE7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGJ1aWxkU3RhdGVNYWNoaW5lKG1ldGFkYXRhOiB7XHJcbiAgICBzdGF0ZXM6IHsgW3N0YXRlTmFtZTogc3RyaW5nXTogTmdTdGF0ZSB9LFxyXG4gICAgcmVuZGVyU3RhdGVzOiB7IFtyZW5kZXJTdGF0ZU5hbWU6IHN0cmluZ106IE5nUmVuZGVyU3RhdGUgfSxcclxuICAgIGFjdGlvbnM6IHsgW2FjdGlvbk5hbWU6IHN0cmluZ106IE5nQWN0aW9uIH1cclxuICB9KSB7XHJcbiAgICBPYmplY3Qua2V5cyhtZXRhZGF0YS5zdGF0ZXMpLmZvckVhY2goKHN0YXRlTmFtZTogc3RyaW5nKSA9PiB7XHJcbiAgICAgIHRoaXMuYnVpbGROZ1N0YXRlKHN0YXRlTmFtZSwgbWV0YWRhdGEuc3RhdGVzW3N0YXRlTmFtZV0pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgT2JqZWN0LmtleXMobWV0YWRhdGEucmVuZGVyU3RhdGVzKS5mb3JFYWNoKChyZW5kZXJTdGF0ZU5hbWU6IHN0cmluZykgPT4ge1xyXG4gICAgICB0aGlzLmJ1aWxkTmdSZW5kZXJTdGF0ZShyZW5kZXJTdGF0ZU5hbWUsIG1ldGFkYXRhLnJlbmRlclN0YXRlc1tyZW5kZXJTdGF0ZU5hbWVdKTtcclxuICAgIH0pO1xyXG5cclxuICAgIE9iamVjdC5rZXlzKG1ldGFkYXRhLmFjdGlvbnMpLmZvckVhY2goKGFjdGlvbk5hbWU6IHN0cmluZykgPT4ge1xyXG4gICAgICB0aGlzLmJ1aWxkTmdBY3Rpb24oYWN0aW9uTmFtZSwgbWV0YWRhdGEuYWN0aW9uc1thY3Rpb25OYW1lXSk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOaehOmAoOeKtuaAgVxyXG4gICAqIEBwYXJhbSBzdGF0ZU5hbWUg54q25oCB5ZCN56ewXHJcbiAgICogQHBhcmFtIG5nU3RhdGUgICDnirbmgIHlr7nosaFcclxuICAgKi9cclxuICBwcml2YXRlIGJ1aWxkTmdTdGF0ZShzdGF0ZU5hbWU6IHN0cmluZywgbmdTdGF0ZTogTmdTdGF0ZSkge1xyXG4gICAgdGhpcy5zdGF0ZXMgPSB0aGlzLnN0YXRlcyB8fCB7fTtcclxuICAgIHRoaXNbc3RhdGVOYW1lXSA9IG5ldyBTdGF0ZShzdGF0ZU5hbWUpO1xyXG4gICAgdGhpcy5zdGF0ZXNbc3RhdGVOYW1lXSA9IHRoaXNbc3RhdGVOYW1lXTtcclxuICAgIGlmIChuZ1N0YXRlLmluaXRpYWxTdGF0ZSkge1xyXG4gICAgICB0aGlzLmluaXRpYWxTdGF0ZSA9IHRoaXNbc3RhdGVOYW1lXTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOaehOmAoOeVjOmdoueKtuaAgVxyXG4gICAqIEBwYXJhbSByZW5kZXJTdGF0ZU5hbWUg5riy5p+T54q25oCB5ZCN56ewXHJcbiAgICogQHBhcmFtIG5nUmVuZGVyU3RhdGUgICDmuLLmn5PnirbmgIHlhYPmlbDmja5cclxuICAgKi9cclxuICBwcml2YXRlIGJ1aWxkTmdSZW5kZXJTdGF0ZShyZW5kZXJTdGF0ZU5hbWU6IHN0cmluZywgbmdSZW5kZXJTdGF0ZTogTmdSZW5kZXJTdGF0ZSkge1xyXG4gICAgdGhpcy5yZW5kZXJTdGF0ZXMgPSB0aGlzLnJlbmRlclN0YXRlcyB8fCB7fTtcclxuICAgIHRoaXNbcmVuZGVyU3RhdGVOYW1lXSA9IGluaXRpYWxVSVN0YXRlO1xyXG4gICAgdGhpcy5yZW5kZXJTdGF0ZXNbcmVuZGVyU3RhdGVOYW1lXSA9IHRoaXNbcmVuZGVyU3RhdGVOYW1lXTtcclxuXHJcbiAgICAvLyDlsIZyZW5kZXJTdGF0ZeS4iuaMh+WumueahHJlbmRlcuWKoOWFpeWIsHJlbmRlcnPkuK1cclxuICAgIHRoaXMucmVuZGVycyA9IHRoaXMucmVuZGVycyB8fCB7fTtcclxuICAgIHRoaXMucmVuZGVyc1tyZW5kZXJTdGF0ZU5hbWVdID0gbmdSZW5kZXJTdGF0ZS5yZW5kZXI7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmnoTpgKDliqjkvZxcclxuICAgKiBAcGFyYW0gYWN0aW9uTmFtZSDliqjkvZzlkI3np7BcclxuICAgKiBAcGFyYW0gbmdBY3Rpb24gICDliqjkvZzlhYPmlbDmja5cclxuICAgKi9cclxuICBwcml2YXRlIGJ1aWxkTmdBY3Rpb24oYWN0aW9uTmFtZTogc3RyaW5nLCBuZ0FjdGlvbjogTmdBY3Rpb24pIHtcclxuICAgIHRoaXNbYWN0aW9uTmFtZV0gPSAoKSA9PiB7XHJcbiAgICAgIGVmZmVjdEhhbmRsZXJzLnRyYW5zaXQucGVyZm9ybSh0aGlzLCBuZ0FjdGlvbi50cmFuc2l0VG8sIG5nQWN0aW9uLnByZWNvbmRpdGlvbik7XHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6YeN5paw6K6h566X5omA5pyJ5riy5p+T54q25oCB55qE5YC8XHJcbiAgICog5b2TIHN0YXRl5YiH5o2i55qE5pe25YCZ77yM6LCD55So6YGN5Y6G5omA5pyJ55qEcmVuZGVy5pa55rOV77yM5pu05pS5cmVuZGVyU3RhdGVcclxuICAgKi9cclxuICByZW5kZXIoKSB7XHJcbiAgICBmb3IgKGNvbnN0IHJlbmRlclN0YXRlTmFtZSBpbiB0aGlzLnJlbmRlclN0YXRlcykge1xyXG5cclxuICAgICAgaWYgKHRoaXMucmVuZGVyU3RhdGVzLmhhc093blByb3BlcnR5KHJlbmRlclN0YXRlTmFtZSkgPT09IGZhbHNlKSB7XHJcbiAgICAgICAgY29udGludWU7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGNvbnN0IHN0YXRlUmVuZGVyID0gdGhpcy5yZW5kZXJzW3JlbmRlclN0YXRlTmFtZV07XHJcbiAgICAgIGlmICghc3RhdGVSZW5kZXIpIHtcclxuICAgICAgICBjb250aW51ZTtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8g6LCD55SocmVuZGVy5pa55rOV77yM5pu05pawcmVuZGVyU3RhdGVcclxuICAgICAgdGhpcy5yZW5kZXJTdGF0ZXNbcmVuZGVyU3RhdGVOYW1lXSA9IHN0YXRlUmVuZGVyKHRoaXMuY29udGV4dCk7XHJcbiAgICAgIHRoaXNbcmVuZGVyU3RhdGVOYW1lXSA9IHRoaXMucmVuZGVyU3RhdGVzW3JlbmRlclN0YXRlTmFtZV07XHJcbiAgICB9XHJcbiAgICB0aGlzLnN0YXRlQ2hhbmdlLm5leHQodGhpcy5jb250ZXh0LnN0YXRlKTtcclxuICB9XHJcbn1cclxuIl19