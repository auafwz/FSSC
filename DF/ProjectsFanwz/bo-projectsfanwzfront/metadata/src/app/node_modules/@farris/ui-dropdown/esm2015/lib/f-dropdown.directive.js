/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Directive, Input, Output, HostBinding, EventEmitter, ElementRef, Renderer2 } from '@angular/core';
import { Subject } from 'rxjs';
export class FDropdownDirective {
    /**
     * @param {?} elementRef
     * @param {?} render
     */
    constructor(elementRef, render) {
        this.render = render;
        // tslint:disable-next-line:no-input-rename
        this._internalOpen = false;
        // 计算宽度
        this._calculateMenu = false;
        // 是否自动纠正位置
        this.autoRectify = false;
        this.dpChangeEvent = new EventEmitter();
        this._placement = 'bottom'; // 记录 position
        // 记录 position
        this.isSubDP = false; // 是否是子下拉
        this.isOpenState = new Subject();
        this._seflEl = elementRef.nativeElement;
        this.isOpenState.subscribe((/**
         * @param {?} state
         * @return {?}
         */
        (state) => {
            if (this._internalOpen !== state) {
                this._internalOpen = state;
                if (this._internalOpen) {
                    this.render.addClass(this._seflEl, 'show');
                }
                else {
                    this.render.removeClass(this._seflEl, 'show');
                }
            }
        }));
    }
    // 在外面强制控制关闭状态
    /**
     * @param {?} value
     * @return {?}
     */
    set forceState(value) {
        if (value && value.length) {
            this.close();
        }
    }
    /**
     * @param {?} value
     * @return {?}
     */
    set openState(value) {
        this._internalOpen = value[0];
        this.isOpenState.next(value[0]);
    }
    // 是否是子下拉
    /**
     * @param {?} value
     * @return {?}
     */
    set placement(value) {
        // 如果相等
        if (!value) {
            return;
        }
        //
        if (value !== this._placement) {
            /** @type {?} */
            const newClsName = this._getClsName(value);
            /** @type {?} */
            const oldClsName = this._getClsName(this._placement);
            this.render.removeClass(this._seflEl, oldClsName);
            this.render.addClass(this._seflEl, newClsName);
            this._placement = value;
        }
    }
    /**
     * @return {?}
     */
    get placement() {
        return this._placement;
    }
    // @HostBinding('class.show')
    /**
     * @return {?}
     */
    get isOpen() {
        return this._internalOpen;
    }
    /**
     * @return {?}
     */
    get submenuCls() {
        return this.isSubDP;
    }
    /**
     * @return {?}
     */
    get dropdownCls() {
        return !this.isSubDP;
    }
    /**
     * @return {?}
     */
    ngOnInit() {
    }
    /**
     * @return {?}
     */
    getNativeElement() {
        return this._seflEl;
    }
    /**
     * @private
     * @return {?}
     */
    bindDocumentEvents() {
        //   this.ngzone.runOutsideAngular(() => {
        this.documentClickEventListener = this.onDocumentClick.bind(this);
        document.addEventListener('click', this.documentClickEventListener);
        // 绑定被操作native时触发
        this.selfDefineEventListener = this.onSelfDefineHandler.bind(this);
        this._seflEl.addEventListener('selfClose', this.selfDefineEventListener);
        // });
    }
    /**
     * @private
     * @return {?}
     */
    onSelfDefineHandler() {
        this.close();
    }
    /**
     * @private
     * @return {?}
     */
    unbindDocumentEvents() {
        if (this.documentClickEventListener) {
            document.removeEventListener('click', this.documentClickEventListener);
            this.documentClickEventListener = null;
        }
        if (this.selfDefineEventListener) {
            this._seflEl.removeEventListener('selfClose', this.selfDefineEventListener);
            this.selfDefineEventListener = null;
        }
    }
    /**
     * @private
     * @param {?} event
     * @return {?}
     */
    onDocumentClick(event) {
        // 如果已经关闭，不需要再响应
        if (!this._internalOpen) {
            return;
        }
        if (event.button !== 2 && !this.isEventFromToggle(event)) {
            this.close();
        }
    }
    // 判断menu展开时是否要计算
    /**
     * @return {?}
     */
    needToCalculate() {
        return this.autoRectify && this._calculateMenu;
    }
    /**
     * @param {?} value
     * @return {?}
     */
    resetCalculate(value) {
        this._calculateMenu = value;
    }
    /**
     * @return {?}
     */
    open() {
        if (!this._internalOpen) {
            this.closeSiblingDropdowns();
            this._calculateMenu = true;
            this.render.addClass(this._seflEl, 'show');
            this.isOpenState.next(true);
            this.dpChangeEvent.emit(true);
            // 执行绑定事件
            this.bindDocumentEvents();
        }
    }
    /**
     * @return {?}
     */
    close() {
        if (this._internalOpen) {
            this._calculateMenu = false;
            this.render.removeClass(this._seflEl, 'show');
            this.isOpenState.next(false);
            this.dpChangeEvent.emit(false);
            this.unbindDocumentEvents();
        }
    }
    /**
     * @return {?}
     */
    toggle() {
        if (this._internalOpen) {
            this.close();
        }
        else {
            this.open();
        }
    }
    /**
     * @return {?}
     */
    getOpenState() {
        return this.isOpenState;
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        this.isOpenState.unsubscribe();
        this.unbindDocumentEvents();
    }
    /**
     * @private
     * @return {?}
     */
    closeSiblingDropdowns() {
        /** @type {?} */
        let dpParentEl = this._seflEl.parentNode;
        if (dpParentEl && dpParentEl['className'].indexOf('dropdown-menu') > -1) {
            /** @type {?} */
            let dropdowns = dpParentEl.querySelectorAll('[fDropdown]');
            if (dropdowns && dropdowns.length > 1) {
                for (var k = 0; k < dropdowns.length; k++) {
                    if (dropdowns[k].className.indexOf('show')) {
                        // 触发事件试试
                        this.compatibleDispatchEvent(dropdowns[k], 'selfClose');
                        // dropdowns[k].dispatchEvent(new Event('selfClose'));
                    }
                }
            }
        }
    }
    /**
     * @private
     * @param {?} eventEl
     * @param {?} eventName
     * @return {?}
     */
    compatibleDispatchEvent(eventEl, eventName) {
        /** @type {?} */
        var event;
        if (typeof Event === "function") {
            event = new Event(eventName);
        }
        else {
            event = document.createEvent("Event");
            event.initEvent(eventName, false, false);
        }
        eventEl.dispatchEvent(event);
    }
    /**
     * @private
     * @param {?} position
     * @return {?}
     */
    _getClsName(position) {
        /** @type {?} */
        let className = '';
        switch (position) {
            case 'top-right':
            case 'top':
                // 朝上，朝上-朝右
                className = 'dropup';
                break;
            case 'top-left':
                // 朝上-朝左
                className = 'dropup-left';
                break;
            case 'left-bottom':
            case 'left':
                // 横向——朝左——朝下
                className = 'dropleft';
                break;
            case 'left-top':
                // 横向——朝左——朝上
                className = 'dropleft-up';
                break;
            case 'right-bottom':
            case 'right':
                // 横向——朝右——朝下
                className = 'dropright';
                break;
            case 'right-top':
                // 横向——朝右——朝上
                className = 'dropright-up';
                break;
            case 'bottom-left':
                // 朝下——朝左
                className = 'dropdown-left';
                break;
            case 'bottom-right':
                className = 'dropdown';
                break;
            default:
                // 朝下，朝下——朝右
                className = 'dropdown';
        }
        return className;
    }
    /**
     * @private
     * @param {?} event
     * @return {?}
     */
    isEventFromToggle(event) {
        /** @type {?} */
        const result = this.toggleElement && this.toggleElement.contains(event.target);
        return result;
    }
    /**
     * @return {?}
     */
    getRectifyReferenceEl() {
        /** @type {?} */
        var resultWidth = window.innerWidth;
        /** @type {?} */
        var resultHeight = window.innerHeight;
        // 横向计算
        if (this.rectifyReference) {
            resultWidth = this.rectifyReference.getBoundingClientRect().right;
        }
        // 纵向计算
        if (this.rectifyReferenceV) {
            resultWidth = this.rectifyReference.getBoundingClientRect().bottom;
        }
        return { width: resultWidth, height: resultHeight };
    }
}
FDropdownDirective.decorators = [
    { type: Directive, args: [{
                selector: '[fDropdown]',
                exportAs: 'fDropdown'
            },] }
];
/** @nocollapse */
FDropdownDirective.ctorParameters = () => [
    { type: ElementRef },
    { type: Renderer2 }
];
FDropdownDirective.propDecorators = {
    rectifyReference: [{ type: Input }],
    rectifyReferenceV: [{ type: Input }],
    autoRectify: [{ type: Input }],
    forceState: [{ type: Input, args: ['forceState',] }],
    openState: [{ type: Input, args: ['open',] }],
    dpChangeEvent: [{ type: Output }],
    isSubDP: [{ type: Input }],
    placement: [{ type: Input, args: ['placement',] }],
    submenuCls: [{ type: HostBinding, args: ['class.dropdown-submenu',] }],
    dropdownCls: [{ type: HostBinding, args: ['class.dropdown',] }]
};
if (false) {
    /** @type {?} */
    FDropdownDirective.prototype.toggleElement;
    /** @type {?} */
    FDropdownDirective.prototype.documentClickEventListener;
    /** @type {?} */
    FDropdownDirective.prototype.selfDefineEventListener;
    /**
     * @type {?}
     * @private
     */
    FDropdownDirective.prototype._seflEl;
    /**
     * @type {?}
     * @private
     */
    FDropdownDirective.prototype._internalOpen;
    /**
     * @type {?}
     * @private
     */
    FDropdownDirective.prototype._calculateMenu;
    /** @type {?} */
    FDropdownDirective.prototype.rectifyReference;
    /** @type {?} */
    FDropdownDirective.prototype.rectifyReferenceV;
    /** @type {?} */
    FDropdownDirective.prototype.autoRectify;
    /** @type {?} */
    FDropdownDirective.prototype.dpChangeEvent;
    /**
     * @type {?}
     * @private
     */
    FDropdownDirective.prototype._placement;
    /** @type {?} */
    FDropdownDirective.prototype.isSubDP;
    /**
     * @type {?}
     * @private
     */
    FDropdownDirective.prototype.isOpenState;
    /**
     * @type {?}
     * @private
     */
    FDropdownDirective.prototype.ngZone;
    /**
     * @type {?}
     * @private
     */
    FDropdownDirective.prototype.render;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZi1kcm9wZG93bi5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL3VpLWRyb3Bkb3duLyIsInNvdXJjZXMiOlsibGliL2YtZHJvcGRvd24uZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQ0gsU0FBUyxFQUNULEtBQUssRUFDTCxNQUFNLEVBQ04sV0FBVyxFQUNYLFlBQVksRUFDWixVQUFVLEVBQ1YsU0FBUyxFQUdaLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBYyxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFLM0MsTUFBTSxPQUFPLGtCQUFrQjs7Ozs7SUF1RTNCLFlBQ0ksVUFBc0IsRUFDZCxNQUFpQjtRQUFqQixXQUFNLEdBQU4sTUFBTSxDQUFXOztRQW5FckIsa0JBQWEsR0FBRyxLQUFLLENBQUM7O1FBRXRCLG1CQUFjLEdBQUcsS0FBSyxDQUFDOztRQU10QixnQkFBVyxHQUFHLEtBQUssQ0FBQztRQWVuQixrQkFBYSxHQUFHLElBQUksWUFBWSxFQUFXLENBQUM7UUFDOUMsZUFBVSxHQUFHLFFBQVEsQ0FBQyxDQUFDLGNBQWM7O1FBRXBDLFlBQU8sR0FBRyxLQUFLLENBQUMsQ0FBQyxTQUFTO1FBMEIzQixnQkFBVyxHQUFHLElBQUksT0FBTyxFQUFFLENBQUM7UUFpQmhDLElBQUksQ0FBQyxPQUFPLEdBQUcsVUFBVSxDQUFDLGFBQWEsQ0FBQztRQUN4QyxJQUFJLENBQUMsV0FBVyxDQUFDLFNBQVM7Ozs7UUFBQyxDQUFDLEtBQWMsRUFBRSxFQUFFO1lBQzFDLElBQUksSUFBSSxDQUFDLGFBQWEsS0FBSyxLQUFLLEVBQUU7Z0JBQzlCLElBQUksQ0FBQyxhQUFhLEdBQUcsS0FBSyxDQUFDO2dCQUMzQixJQUFJLElBQUksQ0FBQyxhQUFhLEVBQUU7b0JBQ3BCLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsTUFBTSxDQUFDLENBQUM7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QkFRbEIsS0FBSyxTQUFDLE1BQU07NEJBS1osTUFBTTtzQkFHTixLQUFLO3dCQUVMLEtBQUssU0FBQyxXQUFXO3lCQTJCakIsV0FBVyxTQUFDLHdCQUF3QjswQkFJcEMsV0FBVyxTQUFDLGdCQUFnQjs7OztJQWhFN0IsMkNBQW1COztJQUNuQix3REFBZ0M7O0lBQ2hDLHFEQUE2Qjs7Ozs7SUFDN0IscUNBQTZCOzs7OztJQUU3QiwyQ0FBOEI7Ozs7O0lBRTlCLDRDQUErQjs7SUFFL0IsOENBQTBCOztJQUUxQiwrQ0FBMkI7O0lBRTNCLHlDQUE2Qjs7SUFlN0IsMkNBQXNEOzs7OztJQUN0RCx3Q0FBOEI7O0lBRTlCLHFDQUF5Qjs7Ozs7SUEwQnpCLHlDQUFvQzs7Ozs7SUFXcEMsb0NBQWU7Ozs7O0lBSVgsb0NBQXlCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcclxuICAgIERpcmVjdGl2ZSxcclxuICAgIElucHV0LFxyXG4gICAgT3V0cHV0LFxyXG4gICAgSG9zdEJpbmRpbmcsXHJcbiAgICBFdmVudEVtaXR0ZXIsXHJcbiAgICBFbGVtZW50UmVmLFxyXG4gICAgUmVuZGVyZXIyLFxyXG4gICAgT25EZXN0cm95LFxyXG4gICAgT25Jbml0XHJcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IE9ic2VydmFibGUsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcclxuQERpcmVjdGl2ZSh7XHJcbiAgICBzZWxlY3RvcjogJ1tmRHJvcGRvd25dJyxcclxuICAgIGV4cG9ydEFzOiAnZkRyb3Bkb3duJ1xyXG59KVxyXG5leHBvcnQgY2xhc3MgRkRyb3Bkb3duRGlyZWN0aXZlIGltcGxlbWVudHMgT25EZXN0cm95LCBPbkluaXQge1xyXG4gICAgdG9nZ2xlRWxlbWVudDogYW55O1xyXG4gICAgZG9jdW1lbnRDbGlja0V2ZW50TGlzdGVuZXI6IGFueTtcclxuICAgIHNlbGZEZWZpbmVFdmVudExpc3RlbmVyOiBhbnk7XHJcbiAgICBwcml2YXRlIF9zZWZsRWw6IEhUTUxFbGVtZW50O1xyXG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWlucHV0LXJlbmFtZVxyXG4gICAgcHJpdmF0ZSBfaW50ZXJuYWxPcGVuID0gZmFsc2U7XHJcbiAgICAvLyDorqHnrpflrr3luqZcclxuICAgIHByaXZhdGUgX2NhbGN1bGF0ZU1lbnUgPSBmYWxzZTtcclxuICAgIC8vIOe6oOato+S9jee9rueahOWPgueFpyDmnIl3aW5kb3flkoxwYXJlbnTkuKTkuKrlgLxcclxuICAgIEBJbnB1dCgpIHJlY3RpZnlSZWZlcmVuY2U7XHJcbiAgICAvLyDnuqDmraPnurXlkJHkvY3nva7nmoTlj4LnhacgXHJcbiAgICBASW5wdXQoKSByZWN0aWZ5UmVmZXJlbmNlVjtcclxuICAgIC8vIOaYr+WQpuiHquWKqOe6oOato+S9jee9rlxyXG4gICAgQElucHV0KCkgYXV0b1JlY3RpZnkgPSBmYWxzZTtcclxuICAgIC8vIOWcqOWklumdouW8uuWItuaOp+WItuWFs+mXreeKtuaAgVxyXG4gICAgQElucHV0KCdmb3JjZVN0YXRlJylcclxuICAgIHNldCBmb3JjZVN0YXRlKHZhbHVlOiBBcnJheTxib29sZWFuPikge1xyXG5cclxuICAgICAgICBpZiAodmFsdWUgJiYgdmFsdWUubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIHRoaXMuY2xvc2UoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgQElucHV0KCdvcGVuJylcclxuICAgIHNldCBvcGVuU3RhdGUodmFsdWU6IGJvb2xlYW4pIHtcclxuICAgICAgICB0aGlzLl9pbnRlcm5hbE9wZW4gPSB2YWx1ZVswXTtcclxuICAgICAgICB0aGlzLmlzT3BlblN0YXRlLm5leHQodmFsdWVbMF0pO1xyXG4gICAgfVxyXG4gICAgQE91dHB1dCgpIGRwQ2hhbmdlRXZlbnQgPSBuZXcgRXZlbnRFbWl0dGVyPGJvb2xlYW4+KCk7XHJcbiAgICBwcml2YXRlIF9wbGFjZW1lbnQgPSAnYm90dG9tJzsgLy8g6K6w5b2VIHBvc2l0aW9uXHJcblxyXG4gICAgQElucHV0KCkgaXNTdWJEUCA9IGZhbHNlOyAvLyDmmK/lkKbmmK/lrZDkuIvmi4lcclxuXHJcbiAgICBASW5wdXQoJ3BsYWNlbWVudCcpXHJcbiAgICBzZXQgcGxhY2VtZW50KHZhbHVlKSB7XHJcbiAgICAgICAgLy8g5aaC5p6c55u4562JXHJcbiAgICAgICAgaWYgKCF2YWx1ZSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vXHJcbiAgICAgICAgaWYgKHZhbHVlICE9PSB0aGlzLl9wbGFjZW1lbnQpIHtcclxuICAgICAgICAgICAgY29uc3QgbmV3Q2xzTmFtZSA9IHRoaXMuX2dldENsc05hbWUodmFsdWUpO1xyXG4gICAgICAgICAgICBjb25zdCBvbGRDbHNOYW1lID0gdGhpcy5fZ2V0Q2xzTmFtZSh0aGlzLl9wbGFjZW1lbnQpO1xyXG4gICAgICAgICAgICB0aGlzLnJlbmRlci5yZW1vdmVDbGFzcyh0aGlzLl9zZWZsRWwsIG9sZENsc05hbWUpO1xyXG4gICAgICAgICAgICB0aGlzLnJlbmRlci5hZGRDbGFzcyh0aGlzLl9zZWZsRWwsIG5ld0Nsc05hbWUpO1xyXG4gICAgICAgICAgICB0aGlzLl9wbGFjZW1lbnQgPSB2YWx1ZTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBnZXQgcGxhY2VtZW50KCk6IHN0cmluZyB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX3BsYWNlbWVudDtcclxuICAgIH1cclxuXHJcbiAgICAvLyBASG9zdEJpbmRpbmcoJ2NsYXNzLnNob3cnKVxyXG4gICAgZ2V0IGlzT3BlbigpOiBib29sZWFuIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5faW50ZXJuYWxPcGVuO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgaXNPcGVuU3RhdGUgPSBuZXcgU3ViamVjdCgpO1xyXG5cclxuXHJcbiAgICBASG9zdEJpbmRpbmcoJ2NsYXNzLmRyb3Bkb3duLXN1Ym1lbnUnKVxyXG4gICAgZ2V0IHN1Ym1lbnVDbHMoKTogYm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuaXNTdWJEUDtcclxuICAgIH1cclxuICAgIEBIb3N0QmluZGluZygnY2xhc3MuZHJvcGRvd24nKVxyXG4gICAgZ2V0IGRyb3Bkb3duQ2xzKCk6IGJvb2xlYW4ge1xyXG4gICAgICAgIHJldHVybiAhdGhpcy5pc1N1YkRQO1xyXG4gICAgfVxyXG4gICAgcHJpdmF0ZSBuZ1pvbmU7XHJcblxyXG4gICAgY29uc3RydWN0b3IoXHJcbiAgICAgICAgZWxlbWVudFJlZjogRWxlbWVudFJlZixcclxuICAgICAgICBwcml2YXRlIHJlbmRlcjogUmVuZGVyZXIyXHJcbiAgICApIHtcclxuICAgICAgICB0aGlzLl9zZWZsRWwgPSBlbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQ7XHJcbiAgICAgICAgdGhpcy5pc09wZW5TdGF0ZS5zdWJzY3JpYmUoKHN0YXRlOiBib29sZWFuKSA9PiB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLl9pbnRlcm5hbE9wZW4gIT09IHN0YXRlKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLl9pbnRlcm5hbE9wZW4gPSBzdGF0ZTtcclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLl9pbnRlcm5hbE9wZW4pIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbmRlci5hZGRDbGFzcyh0aGlzLl9zZWZsRWwsICdzaG93Jyk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyLnJlbW92ZUNsYXNzKHRoaXMuX3NlZmxFbCwgJ3Nob3cnKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgbmdPbkluaXQoKSB7XHJcbiAgICB9XHJcbiAgICBnZXROYXRpdmVFbGVtZW50KCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9zZWZsRWw7XHJcbiAgICB9XHJcbiAgICBwcml2YXRlIGJpbmREb2N1bWVudEV2ZW50cygpIHtcclxuICAgICAgICAvLyAgIHRoaXMubmd6b25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IHtcclxuICAgICAgICB0aGlzLmRvY3VtZW50Q2xpY2tFdmVudExpc3RlbmVyID0gdGhpcy5vbkRvY3VtZW50Q2xpY2suYmluZCh0aGlzKTtcclxuICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIHRoaXMuZG9jdW1lbnRDbGlja0V2ZW50TGlzdGVuZXIpO1xyXG4gICAgICAgIC8vIOe7keWumuiiq+aTjeS9nG5hdGl2ZeaXtuinpuWPkVxyXG4gICAgICAgIHRoaXMuc2VsZkRlZmluZUV2ZW50TGlzdGVuZXIgPSB0aGlzLm9uU2VsZkRlZmluZUhhbmRsZXIuYmluZCh0aGlzKTtcclxuICAgICAgICB0aGlzLl9zZWZsRWwuYWRkRXZlbnRMaXN0ZW5lcignc2VsZkNsb3NlJywgdGhpcy5zZWxmRGVmaW5lRXZlbnRMaXN0ZW5lcik7XHJcbiAgICAgICAgLy8gfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBvblNlbGZEZWZpbmVIYW5kbGVyKCkge1xyXG4gICAgICAgIHRoaXMuY2xvc2UoKTtcclxuICAgIH1cclxuICAgIHByaXZhdGUgdW5iaW5kRG9jdW1lbnRFdmVudHMoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuZG9jdW1lbnRDbGlja0V2ZW50TGlzdGVuZXIpIHtcclxuICAgICAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcihcclxuICAgICAgICAgICAgICAgICdjbGljaycsXHJcbiAgICAgICAgICAgICAgICB0aGlzLmRvY3VtZW50Q2xpY2tFdmVudExpc3RlbmVyXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgIHRoaXMuZG9jdW1lbnRDbGlja0V2ZW50TGlzdGVuZXIgPSBudWxsO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodGhpcy5zZWxmRGVmaW5lRXZlbnRMaXN0ZW5lcikge1xyXG4gICAgICAgICAgICB0aGlzLl9zZWZsRWwucmVtb3ZlRXZlbnRMaXN0ZW5lcihcclxuICAgICAgICAgICAgICAgICdzZWxmQ2xvc2UnLFxyXG4gICAgICAgICAgICAgICAgdGhpcy5zZWxmRGVmaW5lRXZlbnRMaXN0ZW5lclxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgICAgICB0aGlzLnNlbGZEZWZpbmVFdmVudExpc3RlbmVyID0gbnVsbDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBwcml2YXRlIG9uRG9jdW1lbnRDbGljayhldmVudDogTW91c2VFdmVudCkge1xyXG4gICAgICAgIC8vIOWmguaenOW3sue7j+WFs+mXre+8jOS4jemcgOimgeWGjeWTjeW6lFxyXG4gICAgICAgIGlmICghdGhpcy5faW50ZXJuYWxPcGVuKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGV2ZW50LmJ1dHRvbiAhPT0gMiAmJiAhdGhpcy5pc0V2ZW50RnJvbVRvZ2dsZShldmVudCkpIHtcclxuICAgICAgICAgICAgdGhpcy5jbG9zZSgpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyDliKTmlq1tZW515bGV5byA5pe25piv5ZCm6KaB6K6h566XXHJcbiAgICBuZWVkVG9DYWxjdWxhdGUoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuYXV0b1JlY3RpZnkgJiYgdGhpcy5fY2FsY3VsYXRlTWVudTtcclxuICAgIH1cclxuICAgIHJlc2V0Q2FsY3VsYXRlKHZhbHVlKSB7XHJcbiAgICAgICAgdGhpcy5fY2FsY3VsYXRlTWVudSA9IHZhbHVlO1xyXG4gICAgfVxyXG4gICAgb3BlbigpIHtcclxuXHJcbiAgICAgICAgaWYgKCF0aGlzLl9pbnRlcm5hbE9wZW4pIHtcclxuICAgICAgICAgICAgdGhpcy5jbG9zZVNpYmxpbmdEcm9wZG93bnMoKTtcclxuICAgICAgICAgICAgdGhpcy5fY2FsY3VsYXRlTWVudSA9IHRydWU7XHJcbiAgICAgICAgICAgIHRoaXMucmVuZGVyLmFkZENsYXNzKHRoaXMuX3NlZmxFbCwgJ3Nob3cnKTtcclxuICAgICAgICAgICAgdGhpcy5pc09wZW5TdGF0ZS5uZXh0KHRydWUpO1xyXG4gICAgICAgICAgICB0aGlzLmRwQ2hhbmdlRXZlbnQuZW1pdCh0cnVlKTtcclxuICAgICAgICAgICAgLy8g5omn6KGM57uR5a6a5LqL5Lu2XHJcbiAgICAgICAgICAgIHRoaXMuYmluZERvY3VtZW50RXZlbnRzKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGNsb3NlKCkge1xyXG4gICAgICAgIGlmICh0aGlzLl9pbnRlcm5hbE9wZW4pIHtcclxuICAgICAgICAgICAgdGhpcy5fY2FsY3VsYXRlTWVudSA9IGZhbHNlO1xyXG4gICAgICAgICAgICB0aGlzLnJlbmRlci5yZW1vdmVDbGFzcyh0aGlzLl9zZWZsRWwsICdzaG93Jyk7XHJcbiAgICAgICAgICAgIHRoaXMuaXNPcGVuU3RhdGUubmV4dChmYWxzZSk7XHJcbiAgICAgICAgICAgIHRoaXMuZHBDaGFuZ2VFdmVudC5lbWl0KGZhbHNlKTtcclxuICAgICAgICAgICAgdGhpcy51bmJpbmREb2N1bWVudEV2ZW50cygpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICB0b2dnbGUoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuX2ludGVybmFsT3Blbikge1xyXG4gICAgICAgICAgICB0aGlzLmNsb3NlKCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5vcGVuKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgZ2V0T3BlblN0YXRlKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmlzT3BlblN0YXRlO1xyXG4gICAgfVxyXG4gICAgbmdPbkRlc3Ryb3koKSB7XHJcbiAgICAgICAgdGhpcy5pc09wZW5TdGF0ZS51bnN1YnNjcmliZSgpO1xyXG4gICAgICAgIHRoaXMudW5iaW5kRG9jdW1lbnRFdmVudHMoKTtcclxuICAgIH1cclxuICAgIHByaXZhdGUgY2xvc2VTaWJsaW5nRHJvcGRvd25zKCkge1xyXG4gICAgICAgIGxldCBkcFBhcmVudEVsID0gdGhpcy5fc2VmbEVsLnBhcmVudE5vZGU7XHJcbiAgICAgICAgaWYgKGRwUGFyZW50RWwgJiYgZHBQYXJlbnRFbFsnY2xhc3NOYW1lJ10uaW5kZXhPZignZHJvcGRvd24tbWVudScpID4gLTEpIHtcclxuICAgICAgICAgICAgbGV0IGRyb3Bkb3ducyA9IGRwUGFyZW50RWwucXVlcnlTZWxlY3RvckFsbCgnW2ZEcm9wZG93bl0nKTtcclxuICAgICAgICAgICAgaWYgKGRyb3Bkb3ducyAmJiBkcm9wZG93bnMubGVuZ3RoID4gMSkge1xyXG4gICAgICAgICAgICAgICAgZm9yICh2YXIgayA9IDA7IGsgPCBkcm9wZG93bnMubGVuZ3RoOyBrKyspIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZHJvcGRvd25zW2tdLmNsYXNzTmFtZS5pbmRleE9mKCdzaG93JykpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8g6Kem5Y+R5LqL5Lu26K+V6K+VXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY29tcGF0aWJsZURpc3BhdGNoRXZlbnQoZHJvcGRvd25zW2tdLCAnc2VsZkNsb3NlJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGRyb3Bkb3duc1trXS5kaXNwYXRjaEV2ZW50KG5ldyBFdmVudCgnc2VsZkNsb3NlJykpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHByaXZhdGUgY29tcGF0aWJsZURpc3BhdGNoRXZlbnQoZXZlbnRFbCwgZXZlbnROYW1lKSB7XHJcbiAgICAgICAgdmFyIGV2ZW50O1xyXG4gICAgICAgIGlmICh0eXBlb2YgRXZlbnQgPT09IFwiZnVuY3Rpb25cIikge1xyXG4gICAgICAgICAgICBldmVudCA9IG5ldyBFdmVudChldmVudE5hbWUpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGV2ZW50ID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQoXCJFdmVudFwiKTtcclxuICAgICAgICAgICAgZXZlbnQuaW5pdEV2ZW50KGV2ZW50TmFtZSwgZmFsc2UsIGZhbHNlKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZXZlbnRFbC5kaXNwYXRjaEV2ZW50KGV2ZW50KTtcclxuICAgIH1cclxuICAgIHByaXZhdGUgX2dldENsc05hbWUocG9zaXRpb246IHN0cmluZykge1xyXG4gICAgICAgIGxldCBjbGFzc05hbWUgPSAnJztcclxuICAgICAgICBzd2l0Y2ggKHBvc2l0aW9uKSB7XHJcbiAgICAgICAgICAgIGNhc2UgJ3RvcC1yaWdodCc6XHJcbiAgICAgICAgICAgIGNhc2UgJ3RvcCc6XHJcbiAgICAgICAgICAgICAgICAvLyDmnJ3kuIrvvIzmnJ3kuIot5pyd5Y+zXHJcbiAgICAgICAgICAgICAgICBjbGFzc05hbWUgPSAnZHJvcHVwJztcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlICd0b3AtbGVmdCc6XHJcbiAgICAgICAgICAgICAgICAvLyDmnJ3kuIot5pyd5bemXHJcbiAgICAgICAgICAgICAgICBjbGFzc05hbWUgPSAnZHJvcHVwLWxlZnQnO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgJ2xlZnQtYm90dG9tJzpcclxuICAgICAgICAgICAgY2FzZSAnbGVmdCc6XHJcbiAgICAgICAgICAgICAgICAvLyDmqKrlkJHigJTigJTmnJ3lt6bigJTigJTmnJ3kuItcclxuICAgICAgICAgICAgICAgIGNsYXNzTmFtZSA9ICdkcm9wbGVmdCc7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSAnbGVmdC10b3AnOlxyXG4gICAgICAgICAgICAgICAgLy8g5qiq5ZCR4oCU4oCU5pyd5bem4oCU4oCU5pyd5LiKXHJcbiAgICAgICAgICAgICAgICBjbGFzc05hbWUgPSAnZHJvcGxlZnQtdXAnO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgJ3JpZ2h0LWJvdHRvbSc6XHJcbiAgICAgICAgICAgIGNhc2UgJ3JpZ2h0JzpcclxuICAgICAgICAgICAgICAgIC8vIOaoquWQkeKAlOKAlOacneWPs+KAlOKAlOacneS4i1xyXG4gICAgICAgICAgICAgICAgY2xhc3NOYW1lID0gJ2Ryb3ByaWdodCc7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSAncmlnaHQtdG9wJzpcclxuICAgICAgICAgICAgICAgIC8vIOaoquWQkeKAlOKAlOacneWPs+KAlOKAlOacneS4ilxyXG4gICAgICAgICAgICAgICAgY2xhc3NOYW1lID0gJ2Ryb3ByaWdodC11cCc7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSAnYm90dG9tLWxlZnQnOlxyXG4gICAgICAgICAgICAgICAgLy8g5pyd5LiL4oCU4oCU5pyd5bemXHJcbiAgICAgICAgICAgICAgICBjbGFzc05hbWUgPSAnZHJvcGRvd24tbGVmdCc7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSAnYm90dG9tLXJpZ2h0JzpcclxuICAgICAgICAgICAgICAgIGNsYXNzTmFtZSA9ICdkcm9wZG93bic7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgIC8vIOacneS4i++8jOacneS4i+KAlOKAlOacneWPs1xyXG4gICAgICAgICAgICAgICAgY2xhc3NOYW1lID0gJ2Ryb3Bkb3duJztcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGNsYXNzTmFtZTtcclxuICAgIH1cclxuICAgIHByaXZhdGUgaXNFdmVudEZyb21Ub2dnbGUoZXZlbnQ6IE1vdXNlRXZlbnQpIHtcclxuICAgICAgICBjb25zdCByZXN1bHQgPVxyXG4gICAgICAgICAgICB0aGlzLnRvZ2dsZUVsZW1lbnQgJiYgdGhpcy50b2dnbGVFbGVtZW50LmNvbnRhaW5zKGV2ZW50LnRhcmdldCk7XHJcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH1cclxuXHJcbiAgICBnZXRSZWN0aWZ5UmVmZXJlbmNlRWwoKSB7XHJcbiAgICAgICAgXHJcbiAgICAgICAgdmFyIHJlc3VsdFdpZHRoID0gd2luZG93LmlubmVyV2lkdGgsIHJlc3VsdEhlaWdodCA9IHdpbmRvdy5pbm5lckhlaWdodDtcclxuICAgICAgICAvLyDmqKrlkJHorqHnrpdcclxuICAgICAgICBpZiAodGhpcy5yZWN0aWZ5UmVmZXJlbmNlKSB7XHJcbiAgICAgICAgICAgIHJlc3VsdFdpZHRoID0gdGhpcy5yZWN0aWZ5UmVmZXJlbmNlLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLnJpZ2h0O1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyDnurXlkJHorqHnrpdcclxuICAgICAgICBpZiAodGhpcy5yZWN0aWZ5UmVmZXJlbmNlVikge1xyXG4gICAgICAgICAgICByZXN1bHRXaWR0aCA9IHRoaXMucmVjdGlmeVJlZmVyZW5jZS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS5ib3R0b207XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB7IHdpZHRoOiByZXN1bHRXaWR0aCwgaGVpZ2h0OiByZXN1bHRIZWlnaHQgfTtcclxuXHJcbiAgICB9XHJcbn1cclxuXHJcbi8vIGV4cG9ydCBlbnVtIEZEcm9wZG93blBsYWNlbWVudHtcclxuLy8gICBcInRvcFwiLCBcInRvcC1sZWZ0XCIsIFwidG9wLXJpZ2h0XCIsIFwiYm90dG9tXCIsIFwiYm90dG9tLWxlZnRcIiwgXCJib3R0b20tcmlnaHRcIixcclxuLy8gICAqICAgIFwibGVmdFwiLCBcImxlZnQtdG9wXCIsIFwibGVmdC1ib3R0b21cIiwgXCJyaWdodFwiLCBcInJpZ2h0LXRvcFwiLCBcInJpZ2h0LWJvdHRvbVwiXHJcbi8vIH1cclxuIl19