import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { Repository } from '../repository/index';
import { ExpressionUtil } from '../utils/expression_util';
import { ENTITY_TEMPLATE } from './types';
var EntityDependencyResolver = /** @class */ (function () {
    function EntityDependencyResolver(repository) {
        this.repository = repository;
        this.entityTypeInfo = this.repository && this.repository.entityTypeInfo || null;
    }
    /**
     * 解析用户表达式中的实体依赖
     * @param expr 用户配置的完整表达式
     * @returns
     */
    EntityDependencyResolver.prototype.resolve = function (expr) {
        var groupFunctionDependencies = ExpressionUtil.getGroupFunctionDependency(expr, this.repository.entityTypeInfo);
        var entityDependencies = this.getEntityDependency(expr);
        // 去除错误的到子表的依赖
        if (groupFunctionDependencies && groupFunctionDependencies.length > 0 && entityDependencies && entityDependencies.length > 0) {
            groupFunctionDependencies.forEach(function (dep) {
                var index = entityDependencies.findIndex(function (item) { return dep.startsWith(item); });
                if (index !== -1) {
                    entityDependencies.splice(index, 1);
                }
            });
        }
        // 去重
        var merged = tslib_1.__spread(groupFunctionDependencies, entityDependencies);
        var deps = tslib_1.__spread(new Set(merged));
        return deps;
    };
    /**
     * 获取合法的实体属性表达式
     * @param entityPropertyExpression 实体属性表达式
     * @returns
     */
    EntityDependencyResolver.prototype.getValidEntityPropertyExpression = function (entityPropertyExpression) {
        var propPaths = entityPropertyExpression.split('.');
        var propInfo = null;
        try {
            propInfo = this.entityTypeInfo.getPropInfoByPath(propPaths);
        }
        catch (e) { }
        if (!propInfo) {
            if (propPaths.length > 1) {
                propPaths.pop();
                return this.getValidEntityPropertyExpression(propPaths.join('.'));
            }
            else {
                return null;
            }
        }
        else {
            return entityPropertyExpression.split('.');
        }
    };
    /**
     * 获取所有实体依赖
     * @param expr 表达式字符串
     * @returns
     */
    EntityDependencyResolver.prototype.getEntityDependency = function (expr) {
        var _this = this;
        var deps = [];
        if (this.entityTypeInfo) {
            // 使用正则匹配出所有实体
            var regex = new RegExp("[\\'\\\"]?\\s*(" + this.entityTypeInfo.entityInfo.nodeCode + "|" + this.entityTypeInfo.entityInfo.originalCode + ")[\\.\\[\\]a-zA-Z0-9_]+\\s*[\\'\\\"]?", 'g');
            var entityPropertyExpressions = expr.match(regex);
            if (Array.isArray(entityPropertyExpressions) && entityPropertyExpressions.length > 0) {
                // 解析出所有实体相关的字符串，以主实体名字开头，包含主实体属性或子表
                entityPropertyExpressions.forEach(function (item) {
                    if (item.indexOf('.') === -1) {
                        console.warn("\u65E0\u6548\u7684\u5B9E\u4F53\u8868\u8FBE\u5F0F:" + item);
                        return;
                    }
                    // 去空格
                    item = item.trim().replace(/\"/g, '');
                    var paths = ExpressionUtil.convertToNodeCode(item, _this.repository.entityTypeInfo);
                    item = paths.join('.');
                    // 截去主实体及点
                    item = item.substr(item.indexOf('.') + 1);
                    var dep = _this.getValidEntityPropertyExpression(item);
                    if (dep && Array.isArray(dep) && dep.length > 0) {
                        // 此处必须加上主实体的名字来区分依赖的是实体还是其他类型的数据
                        dep.splice(0, 0, ENTITY_TEMPLATE);
                        deps.push(dep.join('/'));
                    }
                });
            }
        }
        else {
            console.warn("\u83B7\u53D6\u5B9E\u4F53\u7C7B\u578B\u4FE1\u606F\u5931\u8D25\uFF0C\u8BF7\u91CD\u65B0\u7F16\u8BD1\u6539\u8868\u5355\u3002");
        }
        return deps;
    };
    EntityDependencyResolver.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    EntityDependencyResolver.ctorParameters = function () { return [
        { type: Repository }
    ]; };
    return EntityDependencyResolver;
}());
export { EntityDependencyResolver };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW50aXR5X2RlcGVuZGVuY3lfcmVzb2x2ZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2RldmtpdC8iLCJzb3VyY2VzIjpbImxpYi9yZXNvbHZlci9lbnRpdHlfZGVwZW5kZW5jeV9yZXNvbHZlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUUzQyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDakQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQzFELE9BQU8sRUFBRSxlQUFlLEVBQThCLE1BQU0sU0FBUyxDQUFDO0FBRXRFO0lBR0Usa0NBQW9CLFVBQTJCO1FBQTNCLGVBQVUsR0FBVixVQUFVLENBQWlCO1FBQzdDLElBQUksQ0FBQyxjQUFjLEdBQUcsSUFBSSxDQUFDLFVBQVUsSUFBSSxJQUFJLENBQUMsVUFBVSxDQUFDLGNBQWMsSUFBSSxJQUFJLENBQUM7SUFDbEYsQ0FBQztJQUNEOzs7O09BSUc7SUFDSSwwQ0FBTyxHQUFkLFVBQWUsSUFBWTtRQUN6QixJQUFNLHlCQUF5QixHQUFHLGNBQWMsQ0FBQywwQkFBMEIsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUNsSCxJQUFNLGtCQUFrQixHQUFHLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUMxRCxjQUFjO1FBQ2QsSUFBSSx5QkFBeUIsSUFBSSx5QkFBeUIsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxJQUFJLGtCQUFrQixJQUFJLGtCQUFrQixDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDNUgseUJBQXlCLENBQUMsT0FBTyxDQUFDLFVBQUMsR0FBVztnQkFDNUMsSUFBTSxLQUFLLEdBQUcsa0JBQWtCLENBQUMsU0FBUyxDQUFDLFVBQUEsSUFBSSxJQUFJLE9BQUEsR0FBRyxDQUFDLFVBQVUs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QUFDO29CQUN4RCxJQUFJLEdBQUcsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO3dCQUMvQyxpQ0FBaUM7d0JBQ2pDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxlQUFlLENBQUMsQ0FBQzt3QkFDbEMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7cUJBQzFCO2dCQUNILENBQUMsQ0FBQyxDQUFDO2FBQ0o7U0FDRjthQUFNO1lBQ0wsT0FBTyxDQUFDLElBQUksQ0FBQywwSEFBc0IsQ0FBQyxDQUFDO1NBQ3RDO1FBQ0QsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDOztnQkF0RkYsVUFBVTs7OztnQkFKRixVQUFVOztJQTRGbkIsK0JBQUM7Q0FBQSxBQXhGRCxJQXdGQztTQXZGWSx3QkFBd0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IERhdGFUeXBlSW5mbyB9IGZyb20gJy4uL2NvcmUvaW5kZXgnO1xyXG5pbXBvcnQgeyBSZXBvc2l0b3J5IH0gZnJvbSAnLi4vcmVwb3NpdG9yeS9pbmRleCc7XHJcbmltcG9ydCB7IEV4cHJlc3Npb25VdGlsIH0gZnJvbSAnLi4vdXRpbHMvZXhwcmVzc2lvbl91dGlsJztcclxuaW1wb3J0IHsgRU5USVRZX1RFTVBMQVRFLCBHUk9VUF9GVU5DVElPTlMsIElSZXNvbHZlciB9IGZyb20gJy4vdHlwZXMnO1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgRW50aXR5RGVwZW5kZW5jeVJlc29sdmVyIGltcGxlbWVudHMgSVJlc29sdmVyIHtcclxuICBwcml2YXRlIGVudGl0eVR5cGVJbmZvOiBEYXRhVHlwZUluZm87XHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZXBvc2l0b3J5OiBSZXBvc2l0b3J5PGFueT4pIHtcclxuICAgIHRoaXMuZW50aXR5VHlwZUluZm8gPSB0aGlzLnJlcG9zaXRvcnkgJiYgdGhpcy5yZXBvc2l0b3J5LmVudGl0eVR5cGVJbmZvIHx8IG51bGw7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOino+aekOeUqOaIt+ihqOi+vuW8j+S4reeahOWunuS9k+S+nei1llxyXG4gICAqIEBwYXJhbSBleHByIOeUqOaIt+mFjee9rueahOWujOaVtOihqOi+vuW8j1xyXG4gICAqIEByZXR1cm5zIFxyXG4gICAqL1xyXG4gIHB1YmxpYyByZXNvbHZlKGV4cHI6IHN0cmluZyk6IHN0cmluZ1tdIHtcclxuICAgIGNvbnN0IGdyb3VwRnVuY3Rpb25EZXBlbmRlbmNpZXMgPSBFeHByZXNzaW9uVXRpbC5nZXRHcm91cEZ1bmN0aW9uRGVwZW5kZW5jeShleHByLCB0aGlzLnJlcG9zaXRvcnkuZW50aXR5VHlwZUluZm8pO1xyXG4gICAgY29uc3QgZW50aXR5RGVwZW5kZW5jaWVzID0gdGhpcy5nZXRFbnRpdHlEZXBlbmRlbmN5KGV4cHIpO1xyXG4gICAgLy8g5Y676Zmk6ZSZ6K+v55qE5Yiw5a2Q6KGo55qE5L6d6LWWXHJcbiAgICBpZiAoZ3JvdXBGdW5jdGlvbkRlcGVuZGVuY2llcyAmJiBncm91cEZ1bmN0aW9uRGVwZW5kZW5jaWVzLmxlbmd0aCA+IDAgJiYgZW50aXR5RGVwZW5kZW5jaWVzICYmIGVudGl0eURlcGVuZGVuY2llcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgIGdyb3VwRnVuY3Rpb25EZXBlbmRlbmNpZXMuZm9yRWFjaCgoZGVwOiBzdHJpbmcpID0+IHtcclxuICAgICAgICBjb25zdCBpbmRleCA9IGVudGl0eURlcGVuZGVuY2llcy5maW5kSW5kZXgoaXRlbSA9PiBkZXAuc3RhcnRzV2l0aChpdGVtKSk7XHJcbiAgICAgICAgaWYgKGluZGV4ICE9PSAtMSkge1xyXG4gICAgICAgICAgZW50aXR5RGVwZW5kZW5jaWVzLnNwbGljZShpbmRleCwgMSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH1cclxuICAgIC8vIOWOu+mHjVxyXG4gICAgY29uc3QgbWVyZ2VkID0gWy4uLmdyb3VwRnVuY3Rpb25EZXBlbmRlbmNpZXMsIC4uLmVudGl0eURlcGVuZGVuY2llc107XHJcbiAgICBjb25zdCBkZXBzID0gWy4uLm5ldyBTZXQobWVyZ2VkKV07XHJcbiAgICByZXR1cm4gZGVwcztcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6I635Y+W5ZCI5rOV55qE5a6e5L2T5bGe5oCn6KGo6L6+5byPXHJcbiAgICogQHBhcmFtIGVudGl0eVByb3BlcnR5RXhwcmVzc2lvbiDlrp7kvZPlsZ7mgKfooajovr7lvI9cclxuICAgKiBAcmV0dXJucyBcclxuICAgKi9cclxuICBwcml2YXRlIGdldFZhbGlkRW50aXR5UHJvcGVydHlFeHByZXNzaW9uKGVudGl0eVByb3BlcnR5RXhwcmVzc2lvbjogc3RyaW5nKTogc3RyaW5nW10ge1xyXG4gICAgY29uc3QgcHJvcFBhdGhzID0gZW50aXR5UHJvcGVydHlFeHByZXNzaW9uLnNwbGl0KCcuJyk7XHJcbiAgICBsZXQgcHJvcEluZm8gPSBudWxsO1xyXG4gICAgdHJ5IHtcclxuICAgICAgcHJvcEluZm8gPSB0aGlzLmVudGl0eVR5cGVJbmZvLmdldFByb3BJbmZvQnlQYXRoKHByb3BQYXRocyk7XHJcbiAgICB9IGNhdGNoIChlKSB7IH1cclxuICAgIGlmICghcHJvcEluZm8pIHtcclxuICAgICAgaWYgKHByb3BQYXRocy5sZW5ndGggPiAxKSB7XHJcbiAgICAgICAgcHJvcFBhdGhzLnBvcCgpO1xyXG4gICAgICAgIHJldHVybiB0aGlzLmdldFZhbGlkRW50aXR5UHJvcGVydHlFeHByZXNzaW9uKHByb3BQYXRocy5qb2luKCcuJykpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICB9XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4gZW50aXR5UHJvcGVydHlFeHByZXNzaW9uLnNwbGl0KCcuJyk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluaJgOacieWunuS9k+S+nei1llxyXG4gICAqIEBwYXJhbSBleHByIOihqOi+vuW8j+Wtl+espuS4slxyXG4gICAqIEByZXR1cm5zIFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0RW50aXR5RGVwZW5kZW5jeShleHByOiBzdHJpbmcpOiBzdHJpbmdbXSB7XHJcbiAgICBjb25zdCBkZXBzID0gW107XHJcbiAgICBpZiAodGhpcy5lbnRpdHlUeXBlSW5mbykge1xyXG4gICAgICAvLyDkvb/nlKjmraPliJnljLnphY3lh7rmiYDmnInlrp7kvZNcclxuICAgICAgY29uc3QgcmVnZXggPSBuZXcgUmVnRXhwKGBbXFxcXCdcXFxcXCJdP1xcXFxzKigke3RoaXMuZW50aXR5VHlwZUluZm8uZW50aXR5SW5mby5ub2RlQ29kZX18JHt0aGlzLmVudGl0eVR5cGVJbmZvLmVudGl0eUluZm8ub3JpZ2luYWxDb2RlfSlbXFxcXC5cXFxcW1xcXFxdYS16QS1aMC05X10rXFxcXHMqW1xcXFwnXFxcXFwiXT9gLCAnZycpO1xyXG4gICAgICBjb25zdCBlbnRpdHlQcm9wZXJ0eUV4cHJlc3Npb25zOiBSZWdFeHBNYXRjaEFycmF5ID0gZXhwci5tYXRjaChyZWdleCk7XHJcbiAgICAgIGlmIChBcnJheS5pc0FycmF5KGVudGl0eVByb3BlcnR5RXhwcmVzc2lvbnMpICYmIGVudGl0eVByb3BlcnR5RXhwcmVzc2lvbnMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgIC8vIOino+aekOWHuuaJgOacieWunuS9k+ebuOWFs+eahOWtl+espuS4su+8jOS7peS4u+WunuS9k+WQjeWtl+W8gOWktO+8jOWMheWQq+S4u+WunuS9k+WxnuaAp+aIluWtkOihqFxyXG4gICAgICAgIGVudGl0eVByb3BlcnR5RXhwcmVzc2lvbnMuZm9yRWFjaCgoaXRlbTogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgICBpZiAoaXRlbS5pbmRleE9mKCcuJykgPT09IC0xKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUud2Fybihg5peg5pWI55qE5a6e5L2T6KGo6L6+5byPOiR7aXRlbX1gKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgLy8g5Y6756m65qC8XHJcbiAgICAgICAgICBpdGVtID0gaXRlbS50cmltKCkucmVwbGFjZSgvXFxcIi9nLCAnJyk7XHJcbiAgICAgICAgICBjb25zdCBwYXRocyA9IEV4cHJlc3Npb25VdGlsLmNvbnZlcnRUb05vZGVDb2RlKGl0ZW0sIHRoaXMucmVwb3NpdG9yeS5lbnRpdHlUeXBlSW5mbyk7XHJcbiAgICAgICAgICBpdGVtID0gcGF0aHMuam9pbignLicpO1xyXG4gICAgICAgICAgLy8g5oiq5Y675Li75a6e5L2T5Y+K54K5XHJcbiAgICAgICAgICBpdGVtID0gaXRlbS5zdWJzdHIoaXRlbS5pbmRleE9mKCcuJykgKyAxKTtcclxuICAgICAgICAgIGNvbnN0IGRlcCA9IHRoaXMuZ2V0VmFsaWRFbnRpdHlQcm9wZXJ0eUV4cHJlc3Npb24oaXRlbSk7XHJcbiAgICAgICAgICBpZiAoZGVwICYmIEFycmF5LmlzQXJyYXkoZGVwKSAmJiBkZXAubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAvLyDmraTlpITlv4XpobvliqDkuIrkuLvlrp7kvZPnmoTlkI3lrZfmnaXljLrliIbkvp3otZbnmoTmmK/lrp7kvZPov5jmmK/lhbbku5bnsbvlnovnmoTmlbDmja5cclxuICAgICAgICAgICAgZGVwLnNwbGljZSgwLCAwLCBFTlRJVFlfVEVNUExBVEUpO1xyXG4gICAgICAgICAgICBkZXBzLnB1c2goZGVwLmpvaW4oJy8nKSk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGNvbnNvbGUud2Fybihg6I635Y+W5a6e5L2T57G75Z6L5L+h5oGv5aSx6LSl77yM6K+36YeN5paw57yW6K+R5pS56KGo5Y2V44CCYCk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gZGVwcztcclxuICB9XHJcblxyXG59Il19