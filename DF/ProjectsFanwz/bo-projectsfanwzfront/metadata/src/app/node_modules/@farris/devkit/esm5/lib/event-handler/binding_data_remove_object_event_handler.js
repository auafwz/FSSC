import * as tslib_1 from "tslib";
import { Injectable } from "@angular/core";
import { EffectorManager } from "../effector/effector_manager";
import { Expression } from "../expression";
import { ENTITY_TEMPLATE } from "../resolver/index";
import { EventHandler } from "./event_handler";
/**
 * 删除数据时需要计算的表达式
 * 1、依赖被删除数据表的上级表达式（不考虑同表内的聚合依赖）
 */
var BindingDataRemoveObjectEventHandler = /** @class */ (function (_super) {
    tslib_1.__extends(BindingDataRemoveObjectEventHandler, _super);
    function BindingDataRemoveObjectEventHandler() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    /**
     * 过滤出需要计算的表达式
     * @param event event
     * @returns
     */
    BindingDataRemoveObjectEventHandler.prototype.filter = function (event) {
        var _this = this;
        if (this.expressionObjects && this.expressionObjects.length > 0) {
            // 找到聚合相关表达式
            var expressions = this.expressionObjects.filter(function (expressionObject) {
                if (expressionObject.ns !== event.ns || !expressionObject.deps || expressionObject.deps.length < 1) {
                    return false;
                }
                var info = _this.analysis(event, expressionObject);
                if (!info) {
                    return false;
                }
                // event.path like [id:xxxx] or [id:xxxx,子表s]
                var eventTablePaths = _this.buildEntityPath(event.path);
                // 主表删除
                if (eventTablePaths.length === 0) {
                    if (expressionObject.bindingType === Expression.ExpressionBindingType.Field) {
                        return false;
                    }
                }
                // 从表或从从表删除
                eventTablePaths.splice(0, 0, ENTITY_TEMPLATE);
                // eventEntityPath like ['ENTITY~','formEEUR1E1s'] // 从表新增
                // deps like ['ENTITY~/formEEUR1E1s/udt/udt_field','ENTITY~/formEEUR1E1s/ref/ref_udt/ref_udt_field']
                // 仅处理上级表达式
                if (info.eventTablePaths.length - 1 !== info.expressionTablePaths.length) {
                    return false;
                }
                // 不支持跨表
                if (!info.eventTablePaths.join(Expression.DEPENDENCY_SPLITER).startsWith(info.expressionTablePaths.join(Expression.DEPENDENCY_SPLITER))) {
                    return false;
                }
                var index = expressionObject.deps.findIndex(function (dep) {
                    // 依赖
                    if (!dep.startsWith(eventTablePaths.join(Expression.DEPENDENCY_SPLITER))) {
                        return false;
                    }
                    var deps = dep.split(Expression.DEPENDENCY_SPLITER).filter(function (p) { return p; }).slice(1);
                    var dependPathInfo = _this.getPathInfo(deps.join(Expression.DEPENDENCY_SPLITER));
                    if (dependPathInfo && dependPathInfo.paths.join(Expression.DEPENDENCY_SPLITER) === info.eventTablePaths.join(Expression.DEPENDENCY_SPLITER)) {
                        return true;
                    }
                    return false;
                });
                return index === -1 ? false : true;
            });
            return expressions;
        }
    };
    /**
     * 发布事件
     * @param event event
     */
    BindingDataRemoveObjectEventHandler.prototype.dispatch = function (event) {
        var _this = this;
        var expressions = this.filter(event);
        if (expressions && expressions.length > 0) {
            expressions.forEach(function (expressionObject) {
                var entityContext = _this.buildEntityContext(event, expressionObject);
                var context = _this.buildContext(expressionObject, event, entityContext);
                var result = _this.perform(expressionObject, context);
                if (result === undefined && !_this.isValidateOrRequiredExpression(expressionObject)) {
                    return;
                }
                expressionObject.result = _this.convertBooleanTypeExpressionResult(expressionObject, result);
                ;
                if (expressionObject.id) {
                    _this.expressionResult.set(expressionObject.id, expressionObject.result);
                }
                _this.effect(event, expressionObject);
            });
        }
    };
    /**
     * 删除副作用器
     * @param event event
     * @param expressionObject 表达式
     * @returns
     */
    BindingDataRemoveObjectEventHandler.prototype.effect = function (event, expressionObject) {
        var effectTo = expressionObject.bindingType;
        var eventPath = this.cleanEventPath(event.path);
        var effector = this.effectorFactory.getEffector(expressionObject);
        if (!effector) {
            return;
        }
        var info = this.analysis(event, expressionObject);
        if (!info) {
            console.warn("[BindingDataRemoveObjectEventHandler][analysis]\u83B7\u53D6\u8DEF\u5F84\u4FE1\u606F\u5931\u8D25\u3002");
            return;
        }
        var expressionPaths = expressionObject.path.split('/').filter(function (p) { return p; });
        if (effectTo === Expression.ExpressionBindingType.Field) {
            var paths = [];
            var propertyPaths = expressionPaths.slice(info.expressionTablePaths.length);
            // 删除场景仅需要计算事件表上面的表
            if (info.distance !== 0) {
                // 表达式和事件不在同一个表，即下级表删除了一批数据
                if (info.eventFromParent === true) {
                    // 在过滤时这种情况的应该就排除掉了
                    console.warn("[BindingDataRemoveObjectEventHandler][effect_error]");
                    return;
                }
                else if (info.eventFromChildren === true) {
                    var prevPaths = eventPath.slice(0, eventPath.length - 1);
                    var path = prevPaths.concat(propertyPaths);
                    paths.push(path);
                }
                else {
                    console.warn("[BindingDataRemoveObjectEventHandler][effect_error]");
                    return;
                }
            }
            EffectorManager.effect(effector, expressionObject, paths);
        }
        else if (effectTo === Expression.ExpressionBindingType.State) {
            console.error('not supported！');
        }
    };
    /**
     * 获取子表事件行
     * @param paths
     * @param event
     * @returns
     */
    BindingDataRemoveObjectEventHandler.prototype.getCurrentRowByEvent = function (paths, event) {
        return this.getCurrentRowByPaths(paths);
    };
    BindingDataRemoveObjectEventHandler.decorators = [
        { type: Injectable }
    ];
    return BindingDataRemoveObjectEventHandler;
}(EventHandler));
export { BindingDataRemoveObjectEventHandler };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmluZGluZ19kYXRhX3JlbW92ZV9vYmplY3RfZXZlbnRfaGFuZGxlci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL2V2ZW50LWhhbmRsZXIvYmluZGluZ19kYXRhX3JlbW92ZV9vYmplY3RfZXZlbnRfaGFuZGxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFDL0QsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDcEQsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBRS9DOzs7R0FHRztBQUNIO0lBQ3lELCtEQUFZO0lBRHJFOztJQWlJQSxDQUFDO0lBL0hDOzs7O09BSUc7SUFDSSxvREFBTSxHQUFiLFVBQWMsS0FBMkI7UUFBekMsaUJBK0NDO1FBOUNDLElBQUksSUFBSSxDQUFDLGlCQUFpQixJQUFJLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQy9ELFlBQVk7WUFDWixJQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsTUFBTSxDQUFDLFVBQUMsZ0JBQTZDO2dCQUM5RixJQUFJLGdCQUFnQixDQUFDLEVBQUUsS0FBSyxLQUFLLENBQUMsRUFBRSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxJQUFJLGdCQUFnQixDQUFDLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO29CQUNsRyxPQUFPLEtBQUssQ0FBQztpQkFDZDtnQkFDRCxJQUFNLElBQUksR0FBRyxLQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDO2dCQUNwRCxJQUFJLENBQUMs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QUFDLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1NBQ2pDO0lBQ0gsQ0FBQztJQUNEOzs7OztPQUtHO0lBQ0ksa0VBQW9CLEdBQTNCLFVBQTRCLEtBQWUsRUFBRSxLQUEyQjtRQUN0RSxPQUFPLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUMxQyxDQUFDOztnQkFoSUYsVUFBVTs7SUFpSVgsMENBQUM7Q0FBQSxBQWpJRCxDQUN5RCxZQUFZLEdBZ0lwRTtTQWhJWSxtQ0FBbUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcclxuaW1wb3J0IHsgRWZmZWN0b3JNYW5hZ2VyIH0gZnJvbSBcIi4uL2VmZmVjdG9yL2VmZmVjdG9yX21hbmFnZXJcIjtcclxuaW1wb3J0IHsgRXhwcmVzc2lvbiB9IGZyb20gXCIuLi9leHByZXNzaW9uXCI7XHJcbmltcG9ydCB7IEVOVElUWV9URU1QTEFURSB9IGZyb20gXCIuLi9yZXNvbHZlci9pbmRleFwiO1xyXG5pbXBvcnQgeyBFdmVudEhhbmRsZXIgfSBmcm9tIFwiLi9ldmVudF9oYW5kbGVyXCI7XHJcblxyXG4vKipcclxuICog5Yig6Zmk5pWw5o2u5pe26ZyA6KaB6K6h566X55qE6KGo6L6+5byPXHJcbiAqIDHjgIHkvp3otZbooqvliKDpmaTmlbDmja7ooajnmoTkuIrnuqfooajovr7lvI/vvIjkuI3ogIPomZHlkIzooajlhoXnmoTogZrlkIjkvp3otZbvvIlcclxuICovXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIEJpbmRpbmdEYXRhUmVtb3ZlT2JqZWN0RXZlbnRIYW5kbGVyIGV4dGVuZHMgRXZlbnRIYW5kbGVyIHtcclxuICAvKipcclxuICAgKiDov4fmu6Tlh7rpnIDopoHorqHnrpfnmoTooajovr7lvI9cclxuICAgKiBAcGFyYW0gZXZlbnQgZXZlbnRcclxuICAgKiBAcmV0dXJucyBcclxuICAgKi9cclxuICBwdWJsaWMgZmlsdGVyKGV2ZW50OiBFeHByZXNzaW9uLkV2ZW50QXJncykge1xyXG4gICAgaWYgKHRoaXMuZXhwcmVzc2lvbk9iamVjdHMgJiYgdGhpcy5leHByZXNzaW9uT2JqZWN0cy5sZW5ndGggPiAwKSB7XHJcbiAgICAgIC8vIOaJvuWIsOiBmuWQiOebuOWFs+ihqOi+vuW8j1xyXG4gICAgICBjb25zdCBleHByZXNzaW9ucyA9IHRoaXMuZXhwcmVzc2lvbk9iamVjdHMuZmlsdGVyKChleHByZXNzaW9uT2JqZWN0OiBFeHByZXNzaW9uLkV4cHJlc3Npb25PYmplY3QpID0+IHtcclxuICAgICAgICBpZiAoZXhwcmVzc2lvbk9iamVjdC5ucyAhPT0gZXZlbnQubnMgfHwgIWV4cHJlc3Npb25PYmplY3QuZGVwcyB8fCBleHByZXNzaW9uT2JqZWN0LmRlcHMubGVuZ3RoIDwgMSkge1xyXG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBpbmZvID0gdGhpcy5hbmFseXNpcyhldmVudCwgZXhwcmVzc2lvbk9iamVjdCk7XHJcbiAgICAgICAgaWYgKCFpbmZvKSB7XHJcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIGV2ZW50LnBhdGggbGlrZSBbaWQ6eHh4eF0gb3IgW2lkOnh4eHgs5a2Q6KGoc11cclxuICAgICAgICBjb25zdCBldmVudFRhYmxlUGF0aHMgPSB0aGlzLmJ1aWxkRW50aXR5UGF0aChldmVudC5wYXRoKTtcclxuICAgICAgICAvLyDkuLvooajliKDpmaRcclxuICAgICAgICBpZiAoZXZlbnRUYWJsZVBhdGhzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgICAgaWYgKGV4cHJlc3Npb25PYmplY3QuYmluZGluZ1R5cGUgPT09IEV4cHJlc3Npb24uRXhwcmVzc2lvbkJpbmRpbmdUeXBlLkZpZWxkKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgLy8g5LuO6KGo5oiW5LuO5LuO6KGo5Yig6ZmkXHJcbiAgICAgICAgZXZlbnRUYWJsZVBhdGhzLnNwbGljZSgwLCAwLCBFTlRJVFlfVEVNUExBVEUpO1xyXG4gICAgICAgIC8vIGV2ZW50RW50aXR5UGF0aCBsaWtlIFsnRU5USVRZficsJ2Zvcm1FRVVSMUUxcyddIC8vIOS7juihqOaWsOWinlxyXG4gICAgICAgIC8vIGRlcHMgbGlrZSBbJ0VOVElUWX4vZm9ybUVFVVIxRTFzL3VkdC91ZHRfZmllbGQnLCdFTlRJVFl+L2Zvcm1FRVVSMUUxcy9yZWYvcmVmX3VkdC9yZWZfdWR0X2ZpZWxkJ11cclxuICAgICAgICAvLyDku4XlpITnkIbkuIrnuqfooajovr7lvI9cclxuICAgICAgICBpZiAoaW5mby5ldmVudFRhYmxlUGF0aHMubGVuZ3RoIC0gMSAhPT0gaW5mby5leHByZXNzaW9uVGFibGVQYXRocy5sZW5ndGgpIHtcclxuICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8g5LiN5pSv5oyB6Leo6KGoXHJcbiAgICAgICAgaWYgKCFpbmZvLmV2ZW50VGFibGVQYXRocy5qb2luKEV4cHJlc3Npb24uREVQRU5ERU5DWV9TUExJVEVSKS5zdGFydHNXaXRoKGluZm8uZXhwcmVzc2lvblRhYmxlUGF0aHMuam9pbihFeHByZXNzaW9uLkRFUEVOREVOQ1lfU1BMSVRFUikpKSB7XHJcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IGluZGV4ID0gZXhwcmVzc2lvbk9iamVjdC5kZXBzLmZpbmRJbmRleCgoZGVwOiBzdHJpbmcpID0+IHtcclxuICAgICAgICAgIC8vIOS+nei1llxyXG4gICAgICAgICAgaWYgKCFkZXAuc3RhcnRzV2l0aChldmVudFRhYmxlUGF0aHMuam9pbihFeHByZXNzaW9uLkRFUEVOREVOQ1lfU1BMSVRFUikpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGNvbnN0IGRlcHMgPSBkZXAuc3BsaXQoRXhwcmVzc2lvbi5ERVBFTkRFTkNZX1NQTElURVIpLmZpbHRlcihwID0+IHApLnNsaWNlKDEpO1xyXG4gICAgICAgICAgY29uc3QgZGVwZW5kUGF0aEluZm8gPSB0aGlzLmdldFBhdGhJbmZvKGRlcHMuam9pbihFeHByZXNzaW9uLkRFUEVOREVOQ1lfU1BMSVRFUikpO1xyXG4gICAgICAgICAgaWYgKGRlcGVuZFBhdGhJbmZvICYmIGRlcGVuZFBhdGhJbmZvLnBhdGhzLmpvaW4oRXhwcmVzc2lvbi5ERVBFTkRFTkNZX1NQTElURVIpID09PSBpbmZvLmV2ZW50VGFibGVQYXRocy5qb2luKEV4cHJlc3Npb24uREVQRU5ERU5DWV9TUExJVEVSKSkge1xyXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9KTtcclxuICAgICAgICByZXR1cm4gaW5kZXggPT09IC0xID8gZmFsc2UgOiB0cnVlO1xyXG4gICAgICB9KTtcclxuICAgICAgcmV0dXJuIGV4cHJlc3Npb25zO1xyXG4gICAgfVxyXG4gIH1cclxuICAvKipcclxuICAgKiDlj5HluIPkuovku7ZcclxuICAgKiBAcGFyYW0gZXZlbnQgZXZlbnRcclxuICAgKi9cclxuICBwdWJsaWMgZGlzcGF0Y2goZXZlbnQ6IEV4cHJlc3Npb24uRXZlbnRBcmdzKSB7XHJcbiAgICBjb25zdCBleHByZXNzaW9ucyA9IHRoaXMuZmlsdGVyKGV2ZW50KTtcclxuICAgIGlmIChleHByZXNzaW9ucyAmJiBleHByZXNzaW9ucy5sZW5ndGggPiAwKSB7XHJcbiAgICAgIGV4cHJlc3Npb25zLmZvckVhY2goKGV4cHJlc3Npb25PYmplY3Q6IEV4cHJlc3Npb24uRXhwcmVzc2lvbk9iamVjdCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGVudGl0eUNvbnRleHQgPSB0aGlzLmJ1aWxkRW50aXR5Q29udGV4dChldmVudCwgZXhwcmVzc2lvbk9iamVjdCk7XHJcbiAgICAgICAgY29uc3QgY29udGV4dCA9IHRoaXMuYnVpbGRDb250ZXh0KGV4cHJlc3Npb25PYmplY3QsIGV2ZW50LCBlbnRpdHlDb250ZXh0KTtcclxuICAgICAgICBjb25zdCByZXN1bHQgPSB0aGlzLnBlcmZvcm0oZXhwcmVzc2lvbk9iamVjdCwgY29udGV4dCk7XHJcbiAgICAgICAgaWYgKHJlc3VsdCA9PT0gdW5kZWZpbmVkICYmICF0aGlzLmlzVmFsaWRhdGVPclJlcXVpcmVkRXhwcmVzc2lvbihleHByZXNzaW9uT2JqZWN0KSkge1xyXG4gICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBleHByZXNzaW9uT2JqZWN0LnJlc3VsdCA9IHRoaXMuY29udmVydEJvb2xlYW5UeXBlRXhwcmVzc2lvblJlc3VsdChleHByZXNzaW9uT2JqZWN0LCByZXN1bHQpOztcclxuICAgICAgICBpZiAoZXhwcmVzc2lvbk9iamVjdC5pZCkge1xyXG4gICAgICAgICAgdGhpcy5leHByZXNzaW9uUmVzdWx0LnNldChleHByZXNzaW9uT2JqZWN0LmlkLCBleHByZXNzaW9uT2JqZWN0LnJlc3VsdCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuZWZmZWN0KGV2ZW50LCBleHByZXNzaW9uT2JqZWN0KTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOWIoOmZpOWJr+S9nOeUqOWZqFxyXG4gICAqIEBwYXJhbSBldmVudCBldmVudFxyXG4gICAqIEBwYXJhbSBleHByZXNzaW9uT2JqZWN0IOihqOi+vuW8j1xyXG4gICAqIEByZXR1cm5zIFxyXG4gICAqL1xyXG4gIHB1YmxpYyBlZmZlY3QoZXZlbnQ6IEV4cHJlc3Npb24uRXZlbnRBcmdzLCBleHByZXNzaW9uT2JqZWN0OiBFeHByZXNzaW9uLkV4cHJlc3Npb25PYmplY3QpOiB2b2lkIHtcclxuICAgIGNvbnN0IGVmZmVjdFRvID0gZXhwcmVzc2lvbk9iamVjdC5iaW5kaW5nVHlwZTtcclxuICAgIGNvbnN0IGV2ZW50UGF0aCA9IHRoaXMuY2xlYW5FdmVudFBhdGgoZXZlbnQucGF0aCk7XHJcbiAgICBjb25zdCBlZmZlY3RvciA9IHRoaXMuZWZmZWN0b3JGYWN0b3J5LmdldEVmZmVjdG9yKGV4cHJlc3Npb25PYmplY3QpO1xyXG4gICAgaWYgKCFlZmZlY3Rvcikge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBjb25zdCBpbmZvID0gdGhpcy5hbmFseXNpcyhldmVudCwgZXhwcmVzc2lvbk9iamVjdCk7XHJcbiAgICBpZiAoIWluZm8pIHtcclxuICAgICAgY29uc29sZS53YXJuKGBbQmluZGluZ0RhdGFSZW1vdmVPYmplY3RFdmVudEhhbmRsZXJdW2FuYWx5c2lzXeiOt+WPlui3r+W+hOS/oeaBr+Wksei0peOAgmApO1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBjb25zdCBleHByZXNzaW9uUGF0aHMgPSBleHByZXNzaW9uT2JqZWN0LnBhdGguc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKTtcclxuICAgIGlmIChlZmZlY3RUbyA9PT0gRXhwcmVzc2lvbi5FeHByZXNzaW9uQmluZGluZ1R5cGUuRmllbGQpIHtcclxuICAgICAgY29uc3QgcGF0aHM6IGFueVtdW10gPSBbXTtcclxuICAgICAgY29uc3QgcHJvcGVydHlQYXRocyA9IGV4cHJlc3Npb25QYXRocy5zbGljZShpbmZvLmV4cHJlc3Npb25UYWJsZVBhdGhzLmxlbmd0aCk7XHJcbiAgICAgIC8vIOWIoOmZpOWcuuaZr+S7hemcgOimgeiuoeeul+S6i+S7tuihqOS4iumdoueahOihqFxyXG4gICAgICBpZiAoaW5mby5kaXN0YW5jZSAhPT0gMCkge1xyXG4gICAgICAgIC8vIOihqOi+vuW8j+WSjOS6i+S7tuS4jeWcqOWQjOS4gOS4quihqO+8jOWNs+S4i+e6p+ihqOWIoOmZpOS6huS4gOaJueaVsOaNrlxyXG4gICAgICAgIGlmIChpbmZvLmV2ZW50RnJvbVBhcmVudCA9PT0gdHJ1ZSkge1xyXG4gICAgICAgICAgLy8g5Zyo6L+H5ruk5pe26L+Z56eN5oOF5Ya155qE5bqU6K+l5bCx5o6S6Zmk5o6J5LqGXHJcbiAgICAgICAgICBjb25zb2xlLndhcm4oYFtCaW5kaW5nRGF0YVJlbW92ZU9iamVjdEV2ZW50SGFuZGxlcl1bZWZmZWN0X2Vycm9yXWApO1xyXG4gICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoaW5mby5ldmVudEZyb21DaGlsZHJlbiA9PT0gdHJ1ZSkge1xyXG4gICAgICAgICAgY29uc3QgcHJldlBhdGhzID0gZXZlbnRQYXRoLnNsaWNlKDAsIGV2ZW50UGF0aC5sZW5ndGggLSAxKTtcclxuICAgICAgICAgIGNvbnN0IHBhdGggPSBwcmV2UGF0aHMuY29uY2F0KHByb3BlcnR5UGF0aHMpO1xyXG4gICAgICAgICAgcGF0aHMucHVzaChwYXRoKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgY29uc29sZS53YXJuKGBbQmluZGluZ0RhdGFSZW1vdmVPYmplY3RFdmVudEhhbmRsZXJdW2VmZmVjdF9lcnJvcl1gKTtcclxuICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgRWZmZWN0b3JNYW5hZ2VyLmVmZmVjdChlZmZlY3RvciwgZXhwcmVzc2lvbk9iamVjdCwgcGF0aHMpO1xyXG4gICAgfSBlbHNlIGlmIChlZmZlY3RUbyA9PT0gRXhwcmVzc2lvbi5FeHByZXNzaW9uQmluZGluZ1R5cGUuU3RhdGUpIHtcclxuICAgICAgY29uc29sZS5lcnJvcignbm90IHN1cHBvcnRlZO+8gScpO1xyXG4gICAgfVxyXG4gIH1cclxuICAvKipcclxuICAgKiDojrflj5blrZDooajkuovku7booYxcclxuICAgKiBAcGFyYW0gcGF0aHMgXHJcbiAgICogQHBhcmFtIGV2ZW50IFxyXG4gICAqIEByZXR1cm5zIFxyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXRDdXJyZW50Um93QnlFdmVudChwYXRoczogc3RyaW5nW10sIGV2ZW50OiBFeHByZXNzaW9uLkV2ZW50QXJncyk6IG51bGwgfCB7IFtwcm9wOiBzdHJpbmddOiBhbnkgfSB7XHJcbiAgICByZXR1cm4gdGhpcy5nZXRDdXJyZW50Um93QnlQYXRocyhwYXRocyk7XHJcbiAgfVxyXG59Il19