/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { DatagridComponent } from './../datagrid.component';
import { Injectable } from '@angular/core';
import { delay } from 'rxjs/operators';
var SelectionModeService = /** @class */ (function () {
    function SelectionModeService(grid) {
        var _this = this;
        this.dgRef = null;
        this.oldSettings = null;
        this.selectStartEvent = null;
        this.events = null;
        this.dgRef = grid;
        if (this.dgRef.selectionMode === 'default') {
            grid.zone.runOutsideAngular((/**
             * @return {?}
             */
            function () {
                _this.events = _this.registerStopSelectionEvent();
            }));
        }
    }
    /**
     * @return {?}
     */
    SelectionModeService.prototype.removeEvents = /**
     * @return {?}
     */
    function () {
        if (this.events && this.events.length) {
            this.events.forEach((/**
             * @param {?} e
             * @return {?}
             */
            function (e) {
                e();
            }));
            this.events = null;
        }
    };
    /**
     * @return {?}
     */
    SelectionModeService.prototype.toggleMode = /**
     * @return {?}
     */
    function () {
        if (this.dgRef) {
            if (this.dgRef.selectionMode === 'default') {
                this.enableWindowsSelectionMode();
            }
            else {
                this.restoreSettings();
            }
        }
    };
    /**
     * @return {?}
     */
    SelectionModeService.prototype.enableWindowsSelectionMode = /**
     * @return {?}
     */
    function () {
        if (this.dgRef) {
            this.oldSettings = {
                showCheckbox: this.dgRef.showCheckbox,
                keepSelect: this.dgRef.keepSelect,
                onlySelectSelf: this.dgRef.onlySelectSelf,
                selectOnCheck: this.dgRef.selectOnCheck,
                checkOnSelect: this.dgRef.checkOnSelect
            };
            this.dgRef.showCheckbox = true;
            this.dgRef.keepSelect = true;
            this.dgRef.onlySelectSelf = false;
            this.dgRef.selectOnCheck = true;
            this.dgRef.checkOnSelect = true;
            this.dgRef.dfs.updateProperty('keepSelect', true);
            this.dgRef.dfs.updateProperty('onlySelectSelf', false);
            this.dgRef.dfs.updateProperty('selectOnCheck', true);
            this.dgRef.dfs.updateProperty('checkOnSelect', true);
        }
    };
    /**
     * @return {?}
     */
    SelectionModeService.prototype.restoreSettings = /**
     * @return {?}
     */
    function () {
        if (this.dgRef && this.oldSettings) {
            this.dgRef.showCheckbox = this.oldSettings.showCheckbox;
            this.dgRef.keepSelect = this.oldSettings.keepSelect;
            this.dgRef.onlySelectSelf = this.oldSettings.onlySelectSelf;
            this.dgRef.selectOnCheck = this.oldSettings.selectOnCheck;
            this.dgRef.checkOnSelect = this.oldSettings.checkOnSelect;
            this.dgRef.dfs.updateProperty('keepSelect', this.oldSettings.keepSelect);
            this.dgRef.dfs.updateProperty('onlySelectSelf', this.oldSettings.onlySelectSelf);
            this.dgRef.dfs.updateProperty('selectOnCheck', this.oldSettings.selectOnCheck);
            this.dgRef.dfs.updateProperty('checkOnSelect', this.oldSettings.checkOnSelect);
        }
    };
    /**
     * @private
     * @return {?}
     */
    SelectionModeService.prototype.registerStopSelectionEvent = /**
     * @private
     * @return {?}
     */
    function () {
        var _this = this;
        /** @type {?} */
        var kd = this.dgRef.render2.listen(document, 'keydown', (/**
         * @param {?} event
         * @return {?}
         */
        function (event) {
            if (event.ctrlKey || event.shiftKey) {
                _this.unselectable();
            }
        }));
        /** @type {?} */
        var ku = this.dgRef.render2.listen(document, 'keyup', (/**
         * @param {?} event
         * @return {?}
         */
        function (event) {
            if (event.ctrlKey || event.shiftKey || event.keyCode === 17 || event.keyCode === 16) {
                _this.enableSelectable();
            }
        }));
        return [kd, ku];
    };
    /**
     * @private
     * @return {?}
     */
    SelectionModeService.prototype.unselectable = /**
     * @private
     * @return {?}
     */
    function () {
        this.dgRef.render2.setAttribute(this.dgRef.dgContainer.nativeElement, 'unselectable', 'on');
        this.dgRef.render2.setAttribute(this.dgRef.dgContainer.nativeElement, 'onselectstart', 'return false');
        this.dgRef.render2.setStyle(this.dgRef.dgContainer.nativeElement, '-moz-user-select', 'none');
    };
    /**
     * @private
     * @return {?}
     */
    SelectionModeService.prototype.enableSelectable = /**
     * @private
     * @return {?}
     */
    function () {
        this.dgRef.render2.removeAttribute(this.dgRef.dgContainer.nativeElement, 'unselectable');
        this.dgRef.render2.removeAttribute(this.dgRef.dgContainer.nativeElement, 'onselectstart');
        this.dgRef.render2.removeStyle(this.dgRef.dgContainer.nativeElement, '-moz-user-select');
    };
    /**
     * @param {?} param
     * @return {?}
     */
    SelectionModeService.prototype.beforRowClick = /**
     * @param {?} param
     * @return {?}
     */
    function (param) {
        var _this = this;
        if (this.dgRef && this.dgRef.selectionMode === 'default') {
            /** @type {?} */
            var isSelected = this.dgRef.dfs.isRowSelected(param.id);
            /** @type {?} */
            var isCtrlKey = param.e.ctrlKey;
            /** @type {?} */
            var isShiftKey = param.e.shiftKey;
            this.dgRef.endEditing();
            if (!isCtrlKey && !isShiftKey) {
                if (!isSelected) {
                    this.dgRef.clearCheckeds();
                }
                else {
                    // 如果有多条选，移除其他选中行
                    /** @type {?} */
                    var currentPagerIds_1 = this.dgRef.getRows().map((/**
                     * @param {?} n
                     * @return {?}
                     */
                    function (n) { return n.id; }));
                    /** @type {?} */
                    var unCheckIDs = this.dgRef.checkValues.filter((/**
                     * @param {?} i
                     * @return {?}
                     */
                    function (i) { return currentPagerIds_1.includes(i) && i != param.id; }));
                    /** @type {?} */
                    var unSelectIds = this.dgRef.checkValues.filter((/**
                     * @param {?} n
                     * @return {?}
                     */
                    function (n) { return !currentPagerIds_1.includes(n); }));
                    // const unCheckIDs = this.dgRef.checkValues.filter(n => n != param.id);
                    if (unCheckIDs && unCheckIDs.length) {
                        this.dgRef.unCheckRows(unCheckIDs, true);
                        this.dgRef.clearSelections(tslib_1.__spread([param.id], unSelectIds));
                    }
                }
            }
            else {
                if (isShiftKey) {
                    /** @type {?} */
                    var focusIndex = this.dgRef.focusRowIndex;
                    if (focusIndex === -1) {
                        focusIndex = 0;
                    }
                    /** @type {?} */
                    var endIndex = param.rowIndex;
                    /** @type {?} */
                    var start = focusIndex;
                    /** @type {?} */
                    var end = endIndex;
                    if (focusIndex > endIndex) {
                        start = endIndex;
                        end = focusIndex;
                    }
                    /** @type {?} */
                    var data = this.dgRef.getRows();
                    /** @type {?} */
                    var checkedItems = tslib_1.__spread(data).splice(start, end - start + 1);
                    /** @type {?} */
                    var willCheckIds = checkedItems.map((/**
                     * @param {?} n
                     * @return {?}
                     */
                    function (n) {
                        return _this.dgRef.dfs.primaryId(n);
                    }));
                    if (!isCtrlKey) {
                        this.dgRef.clearCheckeds(false, false);
                    }
                    // this.dgRef.selectValues = willCheckIds;
                    this.dgRef.checkRows(willCheckIds, true);
                    return true;
                }
            }
            if (isSelected && isCtrlKey) {
                param.e.stopPropagation();
                // 执行取消选择
                this.dgRef.unCheckRow(param.id);
                return true;
            }
            this.dgRef.beforeSelect(param).pipe(delay(100)).subscribe((/**
             * @param {?} canSelect
             * @return {?}
             */
            function (canSelect) {
                if (canSelect) {
                    _this.dgRef.dfs.selectRow(param.rowIndex, param.rowData);
                    if (_this.dgRef.selectedRow) {
                        _this.dgRef.selectedRow.dr = param.dr;
                    }
                }
                _this.dgRef.rowClick.emit({ data: param.rowData, grid: _this.dgRef, dblclick: false });
                _this.dgRef.dgs.setSelecedRow.emit({ selected: true, id: _this.dgRef.dfs.primaryId(param.rowData) });
            }));
            return true;
        }
        return false;
    };
    /**
     * @return {?}
     */
    SelectionModeService.prototype.endRowClick = /**
     * @return {?}
     */
    function () {
        if (this.dgRef && this.dgRef.selectionMode === 'default') {
            this.dgRef.checkOnSelect = false;
        }
    };
    SelectionModeService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    SelectionModeService.ctorParameters = function () { return [
        { type: DatagridComponent }
    ]; };
    return SelectionModeService;
}());
export { SelectionModeService };
if (false) {
    /** @type {?} */
    SelectionModeService.prototype.dgRef;
    /**
     * @type {?}
     * @private
     */
    SelectionModeService.prototype.oldSettings;
    /**
     * @type {?}
     * @private
     */
    SelectionModeService.prototype.selectStartEvent;
    /**
     * @type {?}
     * @private
     */
    SelectionModeService.prototype.events;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VsZWN0aW9uLW1vZGUuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvdWktZGF0YWdyaWQvIiwic291cmNlcyI6WyJsaWIvc2VydmljZXMvc2VsZWN0aW9uLW1vZGUuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQzVELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXZDO0lBTUksOEJBQVksSUFBdUI7UUFBbkMsaUJBT0M7UUFYRCxVQUFLLEdBQXNCLElBQUksQ0FBQztRQUN4QixnQkFBVyxHQUFRLElBQUksQ0FBQztRQUN4QixxQkFBZ0IsR0FBUSxJQUFJLENBQUM7UUFDN0IsV0FBTSxHQUFHLElBQUksQ0FBQztRQUVsQixJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQztRQUNsQixJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsYUFBYSxLQUFLLFNBQVMsRUFBRTtZQUN4QyxJQUFJLENBQUMsSUFBSSxDQUFDLGlCQUFpQjs7O1lBQUM7Z0JBQ3hCLEtBQUksQ0FBQyxNQUFNLEdBQUcsS0FBSSxDQUFDLDBCQUEwQixFQUFFLENBQUM7WUFDcEQsQ0FBQyxFQUFDLENBQUM7U0FDTjtJQUNMLENBQUM7Ozs7SUFFRCwyQ0FBWTs7O0lBQVo7UUFDSSxJQUFJLElBQUksQ0FBQyxNQUFNLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUU7WUFDbkMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPOzs7O1lBQUMsVUFBQSxDQUFDO2dCQUNqQixDQUFDLEVBQUUsQ0FBQztZQUNSLENBQUMsRUFBQyxDQUFDO1lBRUgsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUM7U0FDdEI7SUFDTCxDQUFDOzs7O0lBRU0seUNBQVU7OztJQUFq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QkFDSjtnQkFDRCxLQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsRUFBRSxJQUFJLEVBQUUsS0FBSyxDQUFDLE9BQU8sRUFBRSxJQUFJLEVBQUUsS0FBSSxDQUFDLEtBQUssRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztnQkFDckYsS0FBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFLEtBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQ3ZHLENBQUMsRUFBQyxDQUFDO1lBRUgsT0FBTyxJQUFJLENBQUM7U0FDZjtRQUNELE9BQU8sS0FBSyxDQUFDO0lBQ2pCLENBQUM7Ozs7SUFFRCwwQ0FBVzs7O0lBQVg7UUFDSSxJQUFJLElBQUksQ0FBQyxLQUFLLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxhQUFhLEtBQUssU0FBUyxFQUFFO1lBQ3RELElBQUksQ0FBQyxLQUFLLENBQUMsYUFBYSxHQUFHLEtBQUssQ0FBQztTQUNwQztJQUNMLENBQUM7O2dCQXZMSixVQUFVOzs7O2dCQUpGLGlCQUFpQjs7SUE0TDFCLDJCQUFDO0NBQUEsQUF4TEQsSUF3TEM7U0F2TFksb0JBQW9COzs7SUFDN0IscUNBQWdDOzs7OztJQUNoQywyQ0FBZ0M7Ozs7O0lBQ2hDLGdEQUFxQzs7Ozs7SUFDckMsc0NBQXNCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGF0YWdyaWRDb21wb25lbnQgfSBmcm9tICcuLy4uL2RhdGFncmlkLmNvbXBvbmVudCc7XHJcbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgZGVsYXkgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBTZWxlY3Rpb25Nb2RlU2VydmljZSB7XHJcbiAgICBkZ1JlZjogRGF0YWdyaWRDb21wb25lbnQgPSBudWxsO1xyXG4gICAgcHJpdmF0ZSBvbGRTZXR0aW5nczogYW55ID0gbnVsbDtcclxuICAgIHByaXZhdGUgc2VsZWN0U3RhcnRFdmVudDogYW55ID0gbnVsbDtcclxuICAgIHByaXZhdGUgZXZlbnRzID0gbnVsbDtcclxuICAgIGNvbnN0cnVjdG9yKGdyaWQ6IERhdGFncmlkQ29tcG9uZW50KSB7XHJcbiAgICAgICAgdGhpcy5kZ1JlZiA9IGdyaWQ7XHJcbiAgICAgICAgaWYgKHRoaXMuZGdSZWYuc2VsZWN0aW9uTW9kZSA9PT0gJ2RlZmF1bHQnKSB7XHJcbiAgICAgICAgICAgIGdyaWQuem9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmV2ZW50cyA9IHRoaXMucmVnaXN0ZXJTdG9wU2VsZWN0aW9uRXZlbnQoKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHJlbW92ZUV2ZW50cygpIHtcclxuICAgICAgICBpZiAodGhpcy5ldmVudHMgJiYgdGhpcy5ldmVudHMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZXZlbnRzLmZvckVhY2goZSA9PiB7XHJcbiAgICAgICAgICAgICAgICBlKCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5ldmVudHMgPSBudWxsO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgdG9nZ2xlTW9kZSgpIHtcclxuICAgICAgICBpZiAodGhpcy5kZ1JlZikge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5kZ1JlZi5zZWxlY3Rpb25Nb2RlID09PSAnZGVmYXVsdCcpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZW5hYmxlV2luZG93c1NlbGVjdGlvbk1vZGUoKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMucmVzdG9yZVNldHRpbmdzKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGVuYWJsZVdpbmRvd3NTZWxlY3Rpb25Nb2RlKCkge1xyXG4gICAgICAgIGlmICh0aGlzLmRnUmVmKSB7XHJcbiAgICAgICAgICAgIHRoaXMub2xkU2V0dGluZ3MgPSB7XHJcbiAgICAgICAgICAgICAgICBzaG93Q2hlY2tib3g6IHRoaXMuZGdSZWYuc2hvd0NoZWNrYm94LFxyXG4gICAgICAgICAgICAgICAga2VlcFNlbGVjdDogdGhpcy5kZ1JlZi5rZWVwU2VsZWN0LFxyXG4gICAgICAgICAgICAgICAgb25seVNlbGVjdFNlbGY6IHRoaXMuZGdSZWYub25seVNlbGVjdFNlbGYsXHJcbiAgICAgICAgICAgICAgICBzZWxlY3RPbkNoZWNrOiB0aGlzLmRnUmVmLnNlbGVjdE9uQ2hlY2ssXHJcbiAgICAgICAgICAgICAgICBjaGVja09uU2VsZWN0OiB0aGlzLmRnUmVmLmNoZWNrT25TZWxlY3RcclxuICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuZGdSZWYuc2hvd0NoZWNrYm94ID0gdHJ1ZTtcclxuICAgICAgICAgICAgdGhpcy5kZ1JlZi5rZWVwU2VsZWN0ID0gdHJ1ZTtcclxuICAgICAgICAgICAgdGhpcy5kZ1JlZi5vbmx5U2VsZWN0U2VsZiA9IGZhbHNlO1xyXG4gICAgICAgICAgICB0aGlzLmRnUmVmLnNlbGVjdE9uQ2hlY2sgPSB0cnVlO1xyXG4gICAgICAgICAgICB0aGlzLmRnUmVmLmNoZWNrT25TZWxlY3QgPSB0cnVlO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5kZ1JlZi5kZnMudXBkYXRlUHJvcGVydHkoJ2tlZXBTZWxlY3QnLCB0cnVlKTtcclxuICAgICAgICAgICAgdGhpcy5kZ1JlZi5kZnMudXBkYXRlUHJvcGVydHkoJ29ubHlTZWxlY3RTZWxmJywgZmFsc2UpO1xyXG4gICAgICAgICAgICB0aGlzLmRnUmVmLmRmcy51cGRhdGVQcm9wZXJ0eSgnc2VsZWN0T25DaGVjaycsIHRydWUpO1xyXG4gICAgICAgICAgICB0aGlzLmRnUmVmLmRmcy51cGRhdGVQcm9wZXJ0eSgnY2hlY2tPblNlbGVjdCcsIHRydWUpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgcmVzdG9yZVNldHRpbmdzKCkge1xyXG4gICAgICAgIGlmICh0aGlzLmRnUmVmICYmIHRoaXMub2xkU2V0dGluZ3MpIHtcclxuICAgICAgICAgICAgdGhpcy5kZ1JlZi5zaG93Q2hlY2tib3ggPSB0aGlzLm9sZFNldHRpbmdzLnNob3dDaGVja2JveDtcclxuICAgICAgICAgICAgdGhpcy5kZ1JlZi5rZWVwU2VsZWN0ID0gdGhpcy5vbGRTZXR0aW5ncy5rZWVwU2VsZWN0O1xyXG4gICAgICAgICAgICB0aGlzLmRnUmVmLm9ubHlTZWxlY3RTZWxmID0gdGhpcy5vbGRTZXR0aW5ncy5vbmx5U2VsZWN0U2VsZjtcclxuICAgICAgICAgICAgdGhpcy5kZ1JlZi5zZWxlY3RPbkNoZWNrID0gdGhpcy5vbGRTZXR0aW5ncy5zZWxlY3RPbkNoZWNrO1xyXG4gICAgICAgICAgICB0aGlzLmRnUmVmLmNoZWNrT25TZWxlY3QgPSB0aGlzLm9sZFNldHRpbmdzLmNoZWNrT25TZWxlY3Q7XHJcblxyXG5cclxuICAgICAgICAgICAgdGhpcy5kZ1JlZi5kZnMudXBkYXRlUHJvcGVydHkoJ2tlZXBTZWxlY3QnLCB0aGlzLm9sZFNldHRpbmdzLmtlZXBTZWxlY3QpO1xyXG4gICAgICAgICAgICB0aGlzLmRnUmVmLmRmcy51cGRhdGVQcm9wZXJ0eSgnb25seVNlbGVjdFNlbGYnLCB0aGlzLm9sZFNldHRpbmdzLm9ubHlTZWxlY3RTZWxmKTtcclxuICAgICAgICAgICAgdGhpcy5kZ1JlZi5kZnMudXBkYXRlUHJvcGVydHkoJ3NlbGVjdE9uQ2hlY2snLCB0aGlzLm9sZFNldHRpbmdzLnNlbGVjdE9uQ2hlY2spO1xyXG4gICAgICAgICAgICB0aGlzLmRnUmVmLmRmcy51cGRhdGVQcm9wZXJ0eSgnY2hlY2tPblNlbGVjdCcsIHRoaXMub2xkU2V0dGluZ3MuY2hlY2tPblNlbGVjdCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuXHJcbiAgICBwcml2YXRlIHJlZ2lzdGVyU3RvcFNlbGVjdGlvbkV2ZW50KCkge1xyXG4gICAgICAgIGNvbnN0IGtkID0gdGhpcy5kZ1JlZi5yZW5kZXIyLmxpc3Rlbihkb2N1bWVudCwgJ2tleWRvd24nLCAoZXZlbnQ6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXZlbnQuY3RybEtleSB8fCBldmVudC5zaGlmdEtleSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy51bnNlbGVjdGFibGUoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBjb25zdCBrdSA9IHRoaXMuZGdSZWYucmVuZGVyMi5saXN0ZW4oZG9jdW1lbnQsICdrZXl1cCcsIChldmVudDogYW55KSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChldmVudC5jdHJsS2V5IHx8IGV2ZW50LnNoaWZ0S2V5IHx8IGV2ZW50LmtleUNvZGUgPT09IDE3IHx8IGV2ZW50LmtleUNvZGUgPT09IDE2KSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmVuYWJsZVNlbGVjdGFibGUoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICByZXR1cm4gWyBrZCwga3VdO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgdW5zZWxlY3RhYmxlKCkge1xyXG4gICAgICAgIHRoaXMuZGdSZWYucmVuZGVyMi5zZXRBdHRyaWJ1dGUodGhpcy5kZ1JlZi5kZ0NvbnRhaW5lci5uYXRpdmVFbGVtZW50LCAndW5zZWxlY3RhYmxlJywgJ29uJyk7XHJcbiAgICAgICAgdGhpcy5kZ1JlZi5yZW5kZXIyLnNldEF0dHJpYnV0ZSh0aGlzLmRnUmVmLmRnQ29udGFpbmVyLm5hdGl2ZUVsZW1lbnQsICdvbnNlbGVjdHN0YXJ0JywgJ3JldHVybiBmYWxzZScpO1xyXG4gICAgICAgIHRoaXMuZGdSZWYucmVuZGVyMi5zZXRTdHlsZSh0aGlzLmRnUmVmLmRnQ29udGFpbmVyLm5hdGl2ZUVsZW1lbnQsICctbW96LXVzZXItc2VsZWN0JywgJ25vbmUnKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGVuYWJsZVNlbGVjdGFibGUoKSB7XHJcbiAgICAgICAgdGhpcy5kZ1JlZi5yZW5kZXIyLnJlbW92ZUF0dHJpYnV0ZSh0aGlzLmRnUmVmLmRnQ29udGFpbmVyLm5hdGl2ZUVsZW1lbnQsICd1bnNlbGVjdGFibGUnKTtcclxuICAgICAgICB0aGlzLmRnUmVmLnJlbmRlcjIucmVtb3ZlQXR0cmlidXRlKHRoaXMuZGdSZWYuZGdDb250YWluZXIubmF0aXZlRWxlbWVudCwgJ29uc2VsZWN0c3RhcnQnKTtcclxuICAgICAgICB0aGlzLmRnUmVmLnJlbmRlcjIucmVtb3ZlU3R5bGUodGhpcy5kZ1JlZi5kZ0NvbnRhaW5lci5uYXRpdmVFbGVtZW50LCAnLW1vei11c2VyLXNlbGVjdCcpO1xyXG4gICAgfVxyXG5cclxuICAgIGJlZm9yUm93Q2xpY2socGFyYW06IGFueSkge1xyXG4gICAgICAgIGlmICh0aGlzLmRnUmVmICYmIHRoaXMuZGdSZWYuc2VsZWN0aW9uTW9kZSA9PT0gJ2RlZmF1bHQnKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGlzU2VsZWN0ZWQgPSB0aGlzLmRnUmVmLmRmcy5pc1Jvd1NlbGVjdGVkKHBhcmFtLmlkKTtcclxuICAgICAgICAgICAgY29uc3QgaXNDdHJsS2V5ID0gcGFyYW0uZS5jdHJsS2V5O1xyXG4gICAgICAgICAgICBjb25zdCBpc1NoaWZ0S2V5ID0gcGFyYW0uZS5zaGlmdEtleTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuZGdSZWYuZW5kRWRpdGluZygpO1xyXG5cclxuICAgICAgICAgICAgaWYgKCFpc0N0cmxLZXkgJiYgIWlzU2hpZnRLZXkpIHtcclxuICAgICAgICAgICAgICAgIGlmICghaXNTZWxlY3RlZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZGdSZWYuY2xlYXJDaGVja2VkcygpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAvLyDlpoLmnpzmnInlpJrmnaHpgInvvIznp7vpmaTlhbbku5bpgInkuK3ooYxcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBjdXJyZW50UGFnZXJJZHMgPSB0aGlzLmRnUmVmLmdldFJvd3MoKS5tYXAobiA9PiBuLmlkKTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCB1bkNoZWNrSURzID0gdGhpcy5kZ1JlZi5jaGVja1ZhbHVlcy5maWx0ZXIoaSA9PiBjdXJyZW50UGFnZXJJZHMuaW5jbHVkZXMoaSkgJiYgaSAhPSBwYXJhbS5pZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdW5TZWxlY3RJZHMgPSB0aGlzLmRnUmVmLmNoZWNrVmFsdWVzLmZpbHRlcihuID0+ICFjdXJyZW50UGFnZXJJZHMuaW5jbHVkZXMobikpO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIGNvbnN0IHVuQ2hlY2tJRHMgPSB0aGlzLmRnUmVmLmNoZWNrVmFsdWVzLmZpbHRlcihuID0+IG4gIT0gcGFyYW0uaWQpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh1bkNoZWNrSURzICYmIHVuQ2hlY2tJRHMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGdSZWYudW5DaGVja1Jvd3ModW5DaGVja0lEcywgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGdSZWYuY2xlYXJTZWxlY3Rpb25zKFtwYXJhbS5pZCwgLi4udW5TZWxlY3RJZHNdKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoaXNTaGlmdEtleSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCBmb2N1c0luZGV4ID0gdGhpcy5kZ1JlZi5mb2N1c1Jvd0luZGV4O1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChmb2N1c0luZGV4ID09PSAtMSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBmb2N1c0luZGV4ID0gMDtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGVuZEluZGV4ID0gcGFyYW0ucm93SW5kZXg7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IHN0YXJ0ID0gZm9jdXNJbmRleDtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgZW5kID0gZW5kSW5kZXg7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGZvY3VzSW5kZXggPiBlbmRJbmRleCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzdGFydCA9IGVuZEluZGV4O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBlbmQgPSBmb2N1c0luZGV4O1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGF0YSA9IHRoaXMuZGdSZWYuZ2V0Um93cygpO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGNoZWNrZWRJdGVtcyA9IFsuLi5kYXRhXS5zcGxpY2Uoc3RhcnQsIGVuZCAtIHN0YXJ0ICsgMSk7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgd2lsbENoZWNrSWRzID0gY2hlY2tlZEl0ZW1zLm1hcChuID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZGdSZWYuZGZzLnByaW1hcnlJZChuKTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFpc0N0cmxLZXkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kZ1JlZi5jbGVhckNoZWNrZWRzKGZhbHNlLCBmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIC8vIHRoaXMuZGdSZWYuc2VsZWN0VmFsdWVzID0gd2lsbENoZWNrSWRzO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZGdSZWYuY2hlY2tSb3dzKHdpbGxDaGVja0lkcywgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChpc1NlbGVjdGVkICYmIGlzQ3RybEtleSkge1xyXG4gICAgICAgICAgICAgICAgcGFyYW0uZS5zdG9wUHJvcGFnYXRpb24oKTtcclxuICAgICAgICAgICAgICAgIC8vIOaJp+ihjOWPlua2iOmAieaLqVxyXG4gICAgICAgICAgICAgICAgdGhpcy5kZ1JlZi51bkNoZWNrUm93KHBhcmFtLmlkKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMuZGdSZWYuYmVmb3JlU2VsZWN0KHBhcmFtKS5waXBlKFxyXG4gICAgICAgICAgICAgICAgZGVsYXkoMTAwKVxyXG4gICAgICAgICAgICApLnN1YnNjcmliZSgoY2FuU2VsZWN0OiBib29sZWFuKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoY2FuU2VsZWN0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kZ1JlZi5kZnMuc2VsZWN0Um93KHBhcmFtLnJvd0luZGV4LCBwYXJhbS5yb3dEYXRhKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5kZ1JlZi5zZWxlY3RlZFJvdykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRnUmVmLnNlbGVjdGVkUm93LmRyID0gcGFyYW0uZHI7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgdGhpcy5kZ1JlZi5yb3dDbGljay5lbWl0KHsgZGF0YTogcGFyYW0ucm93RGF0YSwgZ3JpZDogdGhpcy5kZ1JlZiwgZGJsY2xpY2s6IGZhbHNlIH0pO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5kZ1JlZi5kZ3Muc2V0U2VsZWNlZFJvdy5lbWl0KHsgc2VsZWN0ZWQ6IHRydWUsIGlkOiB0aGlzLmRnUmVmLmRmcy5wcmltYXJ5SWQocGFyYW0ucm93RGF0YSkgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuXHJcbiAgICBlbmRSb3dDbGljaygpIHtcclxuICAgICAgICBpZiAodGhpcy5kZ1JlZiAmJiB0aGlzLmRnUmVmLnNlbGVjdGlvbk1vZGUgPT09ICdkZWZhdWx0Jykge1xyXG4gICAgICAgICAgICB0aGlzLmRnUmVmLmNoZWNrT25TZWxlY3QgPSBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuXHJcbiJdfQ==