import { Directive, Input, Injector, NgZone, } from '@angular/core';
import { of } from 'rxjs';
import { BindingData, ViewModel } from '@farris/devkit';
import { DatagridComponent } from '@farris/ui-datagrid';
import { isNumber } from 'lodash-es';
import { DateTimeHelperService } from '@farris/ui-common/date';
import { RuntimeStateService } from '@farris/ui-common';
import { DialogService } from '@farris/ui-dialog';
export class EditableDirective {
    constructor(bindingData, viewModel, grid, dateService, injector, rts, dialogSer, ngZone) {
        this.bindingData = bindingData;
        this.viewModel = viewModel;
        this.grid = grid;
        this.dateService = dateService;
        this.injector = injector;
        this.rts = rts;
        this.dialogSer = dialogSer;
        this.ngZone = ngZone;
        /**
         * 编辑时取消分组
         */
        this.disableGroupOnEditing = true;
        /**
         * 临时记录grid分组字段
         */
        this.groupFields = [];
    }
    get bindingList() {
        // 根实体
        if (this.viewModel.bindingPath === '/' || !this.viewModel.bindingPath) {
            return this.bindingData.list;
        }
        // 子实体
        let bindingPath = this.viewModel.bindingPath.substr(1);
        bindingPath = bindingPath[0].toLowerCase() + bindingPath.substring(1, bindingPath.length);
        const paths = bindingPath.split('/');
        const filteredPaths = paths.filter((part) => {
            return part !== '';
        });
        return this.bindingData.getValue(filteredPaths);
    }
    ngOnInit() {
        this.apply();
    }
    ngOnChanges(changes) {
        this.apply();
    }
    ngOnDestroy() {
        this.detach();
    }
    /**
     * 应用属性
     */
    apply() {
        if (!this.grid) {
            return;
        }
        this.handleGroupStatus();
        if (this.gridEditable) {
            // if(!this.grid.remoteFilter){
            //   this.grid.clearCondition();
            // }
            this.grid.editable = true;
            this.grid.disableHeader(true);
            this.handleBeginEditEvent();
            this.handleAfterEditEvent();
            this.handleEndEditEvent();
        }
        else {
            this.grid.editable = false;
            this.grid.disableHeader(false);
            if (this.grid && typeof this.grid.sort === 'function' && this.grid.sortName) {
                this.grid.sort();
            }
            this.detach();
        }
    }
    /**
     * 编辑时取消分组
     */
    handleGroupStatus() {
        if (this.disableGroupOnEditing === false) {
            return;
        }
        const groupField = this.grid && this.grid.groupField || null;
        if (groupField) {
            if (this.gridEditable) {
                this.groupFields = [groupField];
                this.grid.setGroupFields('');
            }
        }
        else {
            if (this.groupFields && this.groupFields.length > 0) {
                const groupField = this.groupFields.pop();
                if (this.groupFields.length > 0) {
                    this.groupFields = [];
                }
                this.grid.setGroupFields(groupField);
            }
        }
    }
    /**
     * 处理开始编辑事件
     */
    handleBeginEditEvent() {
        this.beginEditSubscription = this.grid.beginEdit.subscribe((e) => {
            if (!e) {
                return;
            }
            const column = e.column;
            if (column && column.editor) {
                const editorInstance = e.editor.componentRef.instance;
                if (!editorInstance || !editorInstance.instance) {
                    return;
                }
                let mapFields = editorInstance.instance.mapFields;
                if (column.editor.type === 'lookup' || column.editor.type === 'PersonnelSelector' || column.editor.type === 'external-integration') {
                    editorInstance.instance.selectedData.subscribe((data) => {
                        mapFields = editorInstance.instance.mapFields;
                        this.lookupMapping(data, mapFields);
                    });
                }
                if (column.editor.type === 'combo-lookup') {
                    editorInstance.instance.valueChange.subscribe((e) => {
                        mapFields = editorInstance.instance.mapFields;
                        this.lookupMapping(e.selections || [], mapFields);
                    });
                }
                if (editorInstance.instance.clear) {
                    editorInstance.instance.clear.subscribe(() => {
                        this.lookupMapping(null, mapFields);
                    });
                }
                if (column.editor.type === 'combolist') {
                    if (mapFields) {
                        editorInstance.instance.valueChange.subscribe(e => {
                            const pathArr = this.getBindingPathArray();
                            this.viewModel.bindingData.setValue(pathArr.concat(mapFields.split('.')), editorInstance.instance.selectedValues, true, true);
                        });
                    }
                }
            }
        });
    }
    /**
     * 处理编辑事件
     */
    handleAfterEditEvent() {
        this.grid.afterEdit = (rowIndex, rowData, column, editor) => {
            if (this.dialogSer.hasDialogOpened()) {
                return of(false);
            }
            if (this.rts) {
                // 帮助组件文本变化后去查询
                if (this.rts.getFormState('lookup.pending')) {
                    return of(false);
                }
            }
            // 更新数据源
            if (!editor || !editor.formControl) {
                return of(false);
            }
            return of(true);
        };
    }
    /**
     * 处理结束编辑事件
     */
    handleEndEditEvent() {
        this.endEditSubscription = this.grid && this.grid.endEdit && this.grid.endEdit.subscribe((event) => {
            const { value = undefined, column = undefined, rowData = {} } = event || {};
            const primaryValue = rowData && rowData[this.grid.idField] || null;
            this.updateBindingData(value, column, primaryValue);
        });
    }
    /*
     * 给列表赋值 或给formcontrol赋值
     */
    updateBindingData(value, column, primaryValue) {
        if (!column) {
            return;
        }
        const currentColumnType = column.dataType;
        // 同时判断gridOption的列对象
        const fieldPaths = column.field.split('.');
        // 是否为大数
        const isBigNumber = column && column.editor && column.editor.options && column.editor.options.bigNumber;
        // 存在行编辑器
        if (currentColumnType === 'date') {
            let dateStr = this.dateService.formatTo(value, 'yyyy-MM-dd');
            // if (!dateStr) {
            //   dateStr = '0001-01-01T00:00:00';
            // }
            this.updateBindingList(primaryValue, fieldPaths.join('.'), dateStr);
        }
        else if (currentColumnType === 'datetime') {
            // if (!value) {
            //   value = '0001-01-01T00:00:00';
            // }
            this.updateBindingList(primaryValue, fieldPaths.join('.'), value);
        }
        else if (currentColumnType === 'number' && !isBigNumber) {
            if (value === null || value === undefined) {
                this.updateBindingList(primaryValue, fieldPaths.join('.'), null);
            }
            else {
                this.updateBindingList(primaryValue, fieldPaths.join('.'), Number(value));
            }
        }
        else {
            this.updateBindingList(primaryValue, fieldPaths.join('.'), value);
        }
    }
    updateBindingList(primaryValue, propertyName, value) {
        const viewModel = this.viewModel || null;
        if (!viewModel || !propertyName) {
            return;
        }
        // 更新主表部分行的字段
        const propertyNames = propertyName.split('.').filter(item => item);
        const bindingPath = this.getBindingPathArray();
        // 取出来的一定是bindingList
        const list = this.bindingData.getValue(bindingPath);
        // 修改的是当前行
        if (list && primaryValue === list.currentItem.primaryKeyValue) {
            const paths = bindingPath.concat(propertyNames);
            this.bindingData.setValue(paths, value, true, true);
            return;
        }
        const bindingObject = this.bindingList.findById(primaryValue);
        if (!bindingObject) {
            return;
        }
        if (propertyNames.length < 2) {
            bindingObject.setValue(propertyName, value, true, true);
        }
        else {
            let targetBindingObject = null;
            const fpaths = propertyNames.slice(0, propertyNames.length - 1);
            const targetPropertyName = propertyNames[propertyNames.length - 1];
            fpaths.forEach(prop => {
                targetBindingObject = targetBindingObject && targetBindingObject[prop] || bindingObject[prop];
            });
            // todo:需要添加值变化事件
            targetBindingObject.setValue(targetPropertyName, value, true, true);
        }
    }
    detach() {
        if (this.beginEditSubscription && typeof this.beginEditSubscription.unsubscribe === 'function') {
            this.beginEditSubscription.unsubscribe();
        }
        if (this.endEditSubscription && typeof this.endEditSubscription.unsubscribe === 'function') {
            this.endEditSubscription.unsubscribe();
        }
    }
    //#region 帮助字段映射
    lookupMapping(helpData, mapFields) {
        if (!mapFields) {
            return;
        }
        // 关闭变更检测
        const appContext = this.viewModel.frameContext.appContext;
        appContext.changeDetectionController.detach();
        const pathArr = this.getBindingPathArray();
        let helpFields = Object.keys(mapFields);
        const primaryInfo = this.getMapFieldsPrimaryKey(mapFields, pathArr);
        let primaryKeys = primaryInfo && primaryInfo.map(item => item.primaryKey) || [];
        const primaryFields = primaryInfo && primaryInfo.map(item => item.primaryField) || [];
        // 去重
        if (primaryKeys && primaryKeys.length > 0) {
            primaryKeys = [...new Set(primaryKeys)];
            helpFields = this.sortMapFieldKeys(helpFields, primaryKeys);
        }
        if (!helpData) {
            helpFields.reverse();
        }
        helpFields.forEach((f) => {
            let val = '';
            if (helpData) {
                if (helpData instanceof Array) {
                    val = helpData.map((h) => {
                        return this.getValue(f, h);
                    }).join(',');
                }
                else {
                    val = this.getValue(f, helpData);
                }
            }
            let mappings = mapFields[f].split(',');
            const headMappings = mappings.filter(p => primaryFields.includes(p));
            const leftMappings = mappings.filter(p => !primaryFields.includes(p));
            if (!helpData) {
                mappings = [].concat(leftMappings).concat(headMappings);
            }
            else {
                mappings = [].concat(headMappings).concat(leftMappings);
            }
            mappings.forEach((ff) => {
                if (!helpData) {
                    this.viewModel.bindingData.clearValue(pathArr.concat(ff.split('.')), true, true);
                }
                else {
                    this.viewModel.bindingData.setValue(pathArr.concat(ff.split('.')), val, true, true);
                }
            });
        });
        // 重新打开变更检测
        appContext.changeDetectionController.reattach();
    }
    getValue(f, data) {
        let val = '';
        if (f.indexOf('.') === -1) {
            val = data[f];
        }
        else {
            val = f.split('.').reduce((a, b) => {
                return a[b];
            }, data);
        }
        return val;
    }
    getBindingPathArray() {
        const path = this.viewModel.bindingPath;
        if (path) {
            return path.split('/').filter(n => n !== '');
        }
        return [];
    }
    isNumberValue(field, data) {
        const currentVal = this.getValue(field, data);
        return isNumber(currentVal);
    }
    //#endregion
    /**
     *
     * @param mapFields  格式形如：{id: "assoField.assoField", code: "assoField.assoField_Code", name: "assoField.assoField_Name"} 或者 {id:'vid',code:'code',name:'name'}
     */
    getMapFieldsPrimaryKey(mapFields, bindingPaths) {
        if (!mapFields || Object.keys(mapFields).length < 1) {
            return null;
        }
        const results = [];
        // let primaryField = null;
        try {
            const entityTypeInfo = this.viewModel.frameContext.repository.entityTypeInfo;
            Object.keys(mapFields).forEach((key) => {
                const mapField = mapFields[key];
                if (mapField && typeof mapField === 'string') {
                    const mappings = mapField.split(',').filter(p => p);
                    mappings.forEach((item) => {
                        let paths = item.split('.');
                        if (bindingPaths && bindingPaths.length > 0) {
                            paths = bindingPaths.concat(paths);
                        }
                        const propInfo = entityTypeInfo.getPropInfoByPath(paths);
                        if (propInfo && propInfo.metadataInfo && propInfo.metadataInfo.primary === true) {
                            results.push({
                                primaryKey: key,
                                primaryField: item
                            });
                        }
                    });
                }
            });
        }
        catch (e) {
            console.error(e);
        }
        return results;
    }
    sortMapFieldKeys(keys, primaryKeys) {
        if (!primaryKeys || primaryKeys.length < 1 || !keys || keys.length < 1) {
            return keys;
        }
        // 过滤出非主键映射字段
        keys = keys.filter(p => !primaryKeys.includes(p));
        return [].concat(primaryKeys).concat(keys);
    }
}
EditableDirective.decorators = [
    { type: Directive, args: [{
                selector: '[farris-datagrid-editable]'
            },] }
];
/** @nocollapse */
EditableDirective.ctorParameters = () => [
    { type: BindingData },
    { type: ViewModel },
    { type: DatagridComponent },
    { type: DateTimeHelperService },
    { type: Injector },
    { type: RuntimeStateService },
    { type: DialogService },
    { type: NgZone }
];
EditableDirective.propDecorators = {
    gridEditable: [{ type: Input, args: ['farris-datagrid-editable',] }],
    disableGroupOnEditing: [{ type: Input, args: ['disableGroupOnEditing',] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZWRpdGFibGUuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9rZW5kby1iaW5kaW5nLyIsInNvdXJjZXMiOlsibGliL2RpcmVjdGl2ZXMvZmFycmlzLWRhdGFncmlkL2VkaXRhYmxlLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0wsU0FBUyxFQUErQyxLQUFLLEVBQ0MsUUFBUSxFQUFFLE1BQU0sR0FDL0UsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLEVBQUUsRUFBZ0IsTUFBTSxNQUFNLENBQUM7QUFDeEMsT0FBTyxFQUNMLFdBQVcsRUFDbUIsU0FBUyxFQUN4QyxNQUFNLGdCQUFnQixDQUFDO0FBQ3hCLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBRXhELE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDckMsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDL0QsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDeEQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBS2xELE1BQU0sT0FBTyxpQkFBaUI7SUErQjVCLFlBQ1MsV0FBd0IsRUFDeEIsU0FBb0IsRUFDcEIsSUFBdUIsRUFDdEIsV0FBa0MsRUFDbkMsUUFBa0IsRUFDakIsR0FBd0IsRUFDekIsU0FBd0IsRUFDeEIsTUFBYztRQVBkLGdCQUFXLEdBQVgsV0FBVyxDQUFhO1FBQ3hCLGNBQVMsR0FBVCxTQUFTLENBQVc7UUFDcEIsU0FBSSxHQUFKLElBQUksQ0FBbUI7UUFDdEIsZ0JBQVcsR0FBWCxXQUFXLENBQXVCO1FBQ25DLGFBQVEsR0FBUixRQUFRLENBQVU7UUFDakIsUUFBRyxHQUFILEdBQUcsQ0FBcUI7UUFDekIsY0FBUyxHQUFULFNBQVMsQ0FBZTtRQUN4QixXQUFNLEdBQU4sTUFBTSxDQUFR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QyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2xELE9BQU8sRUFBRSxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDN0MsQ0FBQzs7O1lBL1hGLFNBQVMsU0FBQztnQkFDVCxRQUFRLEVBQUUsNEJBQTRCO2FBQ3ZDOzs7O1lBWkMsV0FBVztZQUNtQixTQUFTO1lBRWhDLGlCQUFpQjtZQUdqQixxQkFBcUI7WUFWa0MsUUFBUTtZQVcvRCxtQkFBbUI7WUFDbkIsYUFBYTtZQVpvRCxNQUFNOzs7MkJBcUI3RSxLQUFLLFNBQUMsMEJBQTBCO29DQUloQyxLQUFLLFNBQUMsdUJBQXVCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcclxuICBEaXJlY3RpdmUsIE9uSW5pdCwgT25DaGFuZ2VzLCBPbkRlc3Ryb3ksIFNpbXBsZUNoYW5nZXMsIElucHV0LCBIb3N0TGlzdGVuZXIsIE9wdGlvbmFsLFxyXG4gIEV2ZW50RW1pdHRlciwgT3V0cHV0LCBFbGVtZW50UmVmLCBDb250ZW50Q2hpbGRyZW4sIFF1ZXJ5TGlzdCwgSW5qZWN0b3IsIE5nWm9uZSxcclxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgb2YsIFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQge1xyXG4gIEJpbmRpbmdEYXRhLCBCaW5kaW5nTGlzdCwgQ2hhbmdlLCBDaGFuZ2VUeXBlLFxyXG4gIEZyYW1lRXZlbnRCdXMsIFVJU3RhdGUsIEZvcm0sIFZpZXdNb2RlbCwgRGF0YVR5cGVJbmZvLCBEYXRhUHJvcEluZm9cclxufSBmcm9tICdAZmFycmlzL2RldmtpdCc7XHJcbmltcG9ydCB7IERhdGFncmlkQ29tcG9uZW50IH0gZnJvbSAnQGZhcnJpcy91aS1kYXRhZ3JpZCc7XHJcblxyXG5pbXBvcnQgeyBpc051bWJlciB9IGZyb20gJ2xvZGFzaC1lcyc7XHJcbmltcG9ydCB7IERhdGVUaW1lSGVscGVyU2VydmljZSB9IGZyb20gJ0BmYXJyaXMvdWktY29tbW9uL2RhdGUnO1xyXG5pbXBvcnQgeyBSdW50aW1lU3RhdGVTZXJ2aWNlIH0gZnJvbSAnQGZhcnJpcy91aS1jb21tb24nO1xyXG5pbXBvcnQgeyBEaWFsb2dTZXJ2aWNlIH0gZnJvbSAnQGZhcnJpcy91aS1kaWFsb2cnO1xyXG5cclxuQERpcmVjdGl2ZSh7XHJcbiAgc2VsZWN0b3I6ICdbZmFycmlzLWRhdGFncmlkLWVkaXRhYmxlXSdcclxufSlcclxuZXhwb3J0IGNsYXNzIEVkaXRhYmxlRGlyZWN0aXZlIGltcGxlbWVudHMgT25Jbml0LCBPbkNoYW5nZXMsIE9uRGVzdHJveSB7XHJcbiAgLyoqXHJcbiAgICogZ3JpZOaYr+WQpuWPr+S7pee8lui+kVxyXG4gICAqL1xyXG4gIEBJbnB1dCgnZmFycmlzLWRhdGFncmlkLWVkaXRhYmxlJykgZ3JpZEVkaXRhYmxlOiBib29sZWFuO1xyXG4gIC8qKlxyXG4gICAqIOe8lui+keaXtuWPlua2iOWIhue7hFxyXG4gICAqL1xyXG4gIEBJbnB1dCgnZGlzYWJsZUdyb3VwT25FZGl0aW5nJykgZGlzYWJsZUdyb3VwT25FZGl0aW5nOiBib29sZWFuID0gdHJ1ZTtcclxuXHJcbiAgcHJpdmF0ZSBiZWdpbkVkaXRTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcclxuICBwcml2YXRlIGVuZEVkaXRTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcclxuICAvKipcclxuICAgKiDkuLTml7borrDlvZVncmlk5YiG57uE5a2X5q61XHJcbiAgICovXHJcbiAgcHJpdmF0ZSBncm91cEZpZWxkczogYW55W10gPSBbXTtcclxuICBwcm90ZWN0ZWQgZ2V0IGJpbmRpbmdMaXN0KCk6IEJpbmRpbmdMaXN0IHtcclxuICAgIC8vIOagueWunuS9k1xyXG4gICAgaWYgKHRoaXMudmlld01vZGVsLmJpbmRpbmdQYXRoID09PSAnLycgfHwgIXRoaXMudmlld01vZGVsLmJpbmRpbmdQYXRoKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLmJpbmRpbmdEYXRhLmxpc3Q7XHJcbiAgICB9XHJcbiAgICAvLyDlrZDlrp7kvZNcclxuICAgIGxldCBiaW5kaW5nUGF0aCA9IHRoaXMudmlld01vZGVsLmJpbmRpbmdQYXRoLnN1YnN0cigxKTtcclxuICAgIGJpbmRpbmdQYXRoID0gYmluZGluZ1BhdGhbMF0udG9Mb3dlckNhc2UoKSArIGJpbmRpbmdQYXRoLnN1YnN0cmluZygxLCBiaW5kaW5nUGF0aC5sZW5ndGgpO1xyXG4gICAgY29uc3QgcGF0aHMgPSBiaW5kaW5nUGF0aC5zcGxpdCgnLycpO1xyXG5cclxuICAgIGNvbnN0IGZpbHRlcmVkUGF0aHMgPSBwYXRocy5maWx0ZXIoKHBhcnQ6IHN0cmluZykgPT4ge1xyXG4gICAgICByZXR1cm4gcGFydCAhPT0gJyc7XHJcbiAgICB9KTtcclxuICAgIHJldHVybiB0aGlzLmJpbmRpbmdEYXRhLmdldFZhbHVlKGZpbHRlcmVkUGF0aHMpO1xyXG4gIH1cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHB1YmxpYyBiaW5kaW5nRGF0YTogQmluZGluZ0RhdGEsXHJcbiAgICBwdWJsaWMgdmlld01vZGVsOiBWaWV3TW9kZWwsXHJcbiAgICBwdWJsaWMgZ3JpZDogRGF0YWdyaWRDb21wb25lbnQsXHJcbiAgICBwcml2YXRlIGRhdGVTZXJ2aWNlOiBEYXRlVGltZUhlbHBlclNlcnZpY2UsXHJcbiAgICBwdWJsaWMgaW5qZWN0b3I6IEluamVjdG9yLFxyXG4gICAgcHJpdmF0ZSBydHM6IFJ1bnRpbWVTdGF0ZVNlcnZpY2UsXHJcbiAgICBwdWJsaWMgZGlhbG9nU2VyOiBEaWFsb2dTZXJ2aWNlLFxyXG4gICAgcHVibGljIG5nWm9uZTogTmdab25lXHJcbiAgKSB7IH1cclxuXHJcbiAgbmdPbkluaXQoKSB7XHJcbiAgICB0aGlzLmFwcGx5KCk7XHJcbiAgfVxyXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpIHtcclxuICAgIHRoaXMuYXBwbHkoKTtcclxuICB9XHJcbiAgbmdPbkRlc3Ryb3koKSB7XHJcbiAgICB0aGlzLmRldGFjaCgpO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDlupTnlKjlsZ7mgKdcclxuICAgKi9cclxuICBwcml2YXRlIGFwcGx5KCkge1xyXG4gICAgaWYgKCF0aGlzLmdyaWQpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgdGhpcy5oYW5kbGVHcm91cFN0YXR1cygpO1xyXG4gICAgaWYgKHRoaXMuZ3JpZEVkaXRhYmxlKSB7XHJcbiAgICAgIC8vIGlmKCF0aGlzLmdyaWQucmVtb3RlRmlsdGVyKXtcclxuICAgICAgLy8gICB0aGlzLmdyaWQuY2xlYXJDb25kaXRpb24oKTtcclxuICAgICAgLy8gfVxyXG4gICAgICB0aGlzLmdyaWQuZWRpdGFibGUgPSB0cnVlO1xyXG4gICAgICB0aGlzLmdyaWQuZGlzYWJsZUhlYWRlcih0cnVlKTtcclxuICAgICAgdGhpcy5oYW5kbGVCZWdpbkVkaXRFdmVudCgpO1xyXG4gICAgICB0aGlzLmhhbmRsZUFmdGVyRWRpdEV2ZW50KCk7XHJcbiAgICAgIHRoaXMuaGFuZGxlRW5kRWRpdEV2ZW50KCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLmdyaWQuZWRpdGFibGUgPSBmYWxzZTtcclxuICAgICAgdGhpcy5ncmlkLmRpc2FibGVIZWFkZXIoZmFsc2UpO1xyXG4gICAgICBpZiAodGhpcy5ncmlkICYmIHR5cGVvZiB0aGlzLmdyaWQuc29ydCA9PT0gJ2Z1bmN0aW9uJyAmJiB0aGlzLmdyaWQuc29ydE5hbWUpIHtcclxuICAgICAgICB0aGlzLmdyaWQuc29ydCgpO1xyXG4gICAgICB9XHJcbiAgICAgIHRoaXMuZGV0YWNoKCk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOe8lui+keaXtuWPlua2iOWIhue7hFxyXG4gICAqL1xyXG4gIHByaXZhdGUgaGFuZGxlR3JvdXBTdGF0dXMoKSB7XHJcbiAgICBpZiAodGhpcy5kaXNhYmxlR3JvdXBPbkVkaXRpbmcgPT09IGZhbHNlKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGNvbnN0IGdyb3VwRmllbGQgPSB0aGlzLmdyaWQgJiYgdGhpcy5ncmlkLmdyb3VwRmllbGQgfHwgbnVsbDtcclxuICAgIGlmIChncm91cEZpZWxkKSB7XHJcbiAgICAgIGlmICh0aGlzLmdyaWRFZGl0YWJsZSkge1xyXG4gICAgICAgIHRoaXMuZ3JvdXBGaWVsZHMgPSBbZ3JvdXBGaWVsZF07XHJcbiAgICAgICAgdGhpcy5ncmlkLnNldEdyb3VwRmllbGRzKCcnKTtcclxuICAgICAgfVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgaWYgKHRoaXMuZ3JvdXBGaWVsZHMgJiYgdGhpcy5ncm91cEZpZWxkcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgY29uc3QgZ3JvdXBGaWVsZCA9IHRoaXMuZ3JvdXBGaWVsZHMucG9wKCk7XHJcbiAgICAgICAgaWYgKHRoaXMuZ3JvdXBGaWVsZHMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgdGhpcy5ncm91cEZpZWxkcyA9IFtdO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmdyaWQuc2V0R3JvdXBGaWVsZHMoZ3JvdXBGaWVsZCk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcbiAgLyoqXHJcbiAgICog5aSE55CG5byA5aeL57yW6L6R5LqL5Lu2XHJcbiAgICovXHJcbiAgcHJpdmF0ZSBoYW5kbGVCZWdpbkVkaXRFdmVudCgpIHtcclxuICAgIHRoaXMuYmVnaW5FZGl0U3Vic2NyaXB0aW9uID0gdGhpcy5ncmlkLmJlZ2luRWRpdC5zdWJzY3JpYmUoKGU6IGFueSkgPT4ge1xyXG4gICAgICBpZiAoIWUpIHtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuICAgICAgY29uc3QgY29sdW1uID0gZS5jb2x1bW47XHJcbiAgICAgIGlmIChjb2x1bW4gJiYgY29sdW1uLmVkaXRvcikge1xyXG4gICAgICAgIGNvbnN0IGVkaXRvckluc3RhbmNlID0gZS5lZGl0b3IuY29tcG9uZW50UmVmLmluc3RhbmNlO1xyXG4gICAgICAgIGlmICghZWRpdG9ySW5zdGFuY2UgfHwgIWVkaXRvckluc3RhbmNlLmluc3RhbmNlKSB7XHJcbiAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGxldCBtYXBGaWVsZHMgPSBlZGl0b3JJbnN0YW5jZS5pbnN0YW5jZS5tYXBGaWVsZHM7XHJcbiAgICAgICAgaWYgKGNvbHVtbi5lZGl0b3IudHlwZSA9PT0gJ2xvb2t1cCcgfHwgY29sdW1uLmVkaXRvci50eXBlID09PSAnUGVyc29ubmVsU2VsZWN0b3InIHx8IGNvbHVtbi5lZGl0b3IudHlwZSA9PT0gJ2V4dGVybmFsLWludGVncmF0aW9uJykge1xyXG4gICAgICAgICAgZWRpdG9ySW5zdGFuY2UuaW5zdGFuY2Uuc2VsZWN0ZWREYXRhLnN1YnNjcmliZSgoZGF0YTogYW55KSA9PiB7XHJcbiAgICAgICAgICAgIG1hcEZpZWxkcyA9IGVkaXRvckluc3RhbmNlLmluc3RhbmNlLm1hcEZpZWxkcztcclxuICAgICAgICAgICAgdGhpcy5sb29rdXBNYXBwaW5nKGRhdGEsIG1hcEZpZWxkcyk7XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChjb2x1bW4uZWRpdG9yLnR5cGUgPT09ICdjb21iby1sb29rdXAnKSB7XHJcbiAgICAgICAgICBlZGl0b3JJbnN0YW5jZS5pbnN0YW5jZS52YWx1ZUNoYW5nZS5zdWJzY3JpYmUoKGU6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICBtYXBGaWVsZHMgPSBlZGl0b3JJbnN0YW5jZS5pbnN0YW5jZS5tYXBGaWVsZHM7XHJcbiAgICAgICAgICAgIHRoaXMubG9va3VwTWFwcGluZyhlLnNlbGVjdGlvbnMgfHwgW10sIG1hcEZpZWxkcyk7XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGVkaXRvckluc3RhbmNlLmluc3RhbmNlLmNsZWFyKSB7XHJcbiAgICAgICAgICBlZGl0b3JJbnN0YW5jZS5pbnN0YW5jZS5jbGVhci5zdWJzY3JpYmUoKCkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLmxvb2t1cE1hcHBpbmcobnVsbCwgbWFwRmllbGRzKTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoY29sdW1uLmVkaXRvci50eXBlID09PSAnY29tYm9saXN0Jykge1xyXG4gICAgICAgICAgaWYgKG1hcEZpZWxkcykge1xyXG4gICAgICAgICAgICBlZGl0b3JJbnN0YW5jZS5pbnN0YW5jZS52YWx1ZUNoYW5nZS5zdWJzY3JpYmUoZSA9PiB7XHJcbiAgICAgICAgICAgICAgY29uc3QgcGF0aEFyciA9IHRoaXMuZ2V0QmluZGluZ1BhdGhBcnJheSgpO1xyXG4gICAgICAgICAgICAgIHRoaXMudmlld01vZGVsLmJpbmRpbmdEYXRhLnNldFZhbHVlKHBhdGhBcnIuY29uY2F0KG1hcEZpZWxkcy5zcGxpdCgnLicpKSwgZWRpdG9ySW5zdGFuY2UuaW5zdGFuY2Uuc2VsZWN0ZWRWYWx1ZXMsIHRydWUsIHRydWUpO1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOWkhOeQhue8lui+keS6i+S7tlxyXG4gICAqL1xyXG4gIHByaXZhdGUgaGFuZGxlQWZ0ZXJFZGl0RXZlbnQoKSB7XHJcbiAgICB0aGlzLmdyaWQuYWZ0ZXJFZGl0ID0gKHJvd0luZGV4LCByb3dEYXRhLCBjb2x1bW4sIGVkaXRvcikgPT4ge1xyXG4gICAgICBpZiAodGhpcy5kaWFsb2dTZXIuaGFzRGlhbG9nT3BlbmVkKCkpIHtcclxuICAgICAgICByZXR1cm4gb2YoZmFsc2UpO1xyXG4gICAgICB9XHJcbiAgICAgIGlmICh0aGlzLnJ0cykge1xyXG4gICAgICAgIC8vIOW4ruWKqee7hOS7tuaWh+acrOWPmOWMluWQjuWOu+afpeivolxyXG4gICAgICAgIGlmICh0aGlzLnJ0cy5nZXRGb3JtU3RhdGUoJ2xvb2t1cC5wZW5kaW5nJykpIHtcclxuICAgICAgICAgIHJldHVybiBvZihmYWxzZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIC8vIOabtOaWsOaVsOaNrua6kFxyXG4gICAgICBpZiAoIWVkaXRvciB8fCAhZWRpdG9yLmZvcm1Db250cm9sKSB7XHJcbiAgICAgICAgcmV0dXJuIG9mKGZhbHNlKTtcclxuICAgICAgfVxyXG4gICAgICByZXR1cm4gb2YodHJ1ZSk7XHJcbiAgICB9O1xyXG4gIH1cclxuICAvKipcclxuICAgKiDlpITnkIbnu5PmnZ/nvJbovpHkuovku7ZcclxuICAgKi9cclxuICBwcml2YXRlIGhhbmRsZUVuZEVkaXRFdmVudCgpIHtcclxuICAgIHRoaXMuZW5kRWRpdFN1YnNjcmlwdGlvbiA9IHRoaXMuZ3JpZCAmJiB0aGlzLmdyaWQuZW5kRWRpdCAmJiB0aGlzLmdyaWQuZW5kRWRpdC5zdWJzY3JpYmUoKGV2ZW50OiBhbnkpID0+IHtcclxuICAgICAgY29uc3QgeyB2YWx1ZSA9IHVuZGVmaW5lZCwgY29sdW1uID0gdW5kZWZpbmVkLCByb3dEYXRhID0ge30gfSA9IGV2ZW50IHx8IHt9O1xyXG4gICAgICBjb25zdCBwcmltYXJ5VmFsdWUgPSByb3dEYXRhICYmIHJvd0RhdGFbdGhpcy5ncmlkLmlkRmllbGRdIHx8IG51bGw7XHJcbiAgICAgIHRoaXMudXBkYXRlQmluZGluZ0RhdGEodmFsdWUsIGNvbHVtbiwgcHJpbWFyeVZhbHVlKTtcclxuICAgIH0pO1xyXG4gIH1cclxuICAvKlxyXG4gICAqIOe7meWIl+ihqOi1i+WAvCDmiJbnu5lmb3JtY29udHJvbOi1i+WAvFxyXG4gICAqL1xyXG4gIHByaXZhdGUgdXBkYXRlQmluZGluZ0RhdGEodmFsdWU6IGFueSwgY29sdW1uOiBhbnksIHByaW1hcnlWYWx1ZT86IGFueSkge1xyXG4gICAgaWYgKCFjb2x1bW4pIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgY29uc3QgY3VycmVudENvbHVtblR5cGUgPSBjb2x1bW4uZGF0YVR5cGU7XHJcbiAgICAvLyDlkIzml7bliKTmlq1ncmlkT3B0aW9u55qE5YiX5a+56LGhXHJcblxyXG4gICAgY29uc3QgZmllbGRQYXRocyA9IGNvbHVtbi5maWVsZC5zcGxpdCgnLicpO1xyXG4gICAgLy8g5piv5ZCm5Li65aSn5pWwXHJcbiAgICBjb25zdCBpc0JpZ051bWJlciA9IGNvbHVtbiAmJiBjb2x1bW4uZWRpdG9yICYmIGNvbHVtbi5lZGl0b3Iub3B0aW9ucyAmJiBjb2x1bW4uZWRpdG9yLm9wdGlvbnMuYmlnTnVtYmVyO1xyXG4gICAgLy8g5a2Y5Zyo6KGM57yW6L6R5ZmoXHJcbiAgICBpZiAoY3VycmVudENvbHVtblR5cGUgPT09ICdkYXRlJykge1xyXG4gICAgICBsZXQgZGF0ZVN0ciA9IHRoaXMuZGF0ZVNlcnZpY2UuZm9ybWF0VG8odmFsdWUsICd5eXl5LU1NLWRkJyk7XHJcbiAgICAgIC8vIGlmICghZGF0ZVN0cikge1xyXG4gICAgICAvLyAgIGRhdGVTdHIgPSAnMDAwMS0wMS0wMVQwMDowMDowMCc7XHJcbiAgICAgIC8vIH1cclxuICAgICAgdGhpcy51cGRhdGVCaW5kaW5nTGlzdChwcmltYXJ5VmFsdWUsIGZpZWxkUGF0aHMuam9pbignLicpLCBkYXRlU3RyKTtcclxuICAgIH0gZWxzZSBpZiAoY3VycmVudENvbHVtblR5cGUgPT09ICdkYXRldGltZScpIHtcclxuICAgICAgLy8gaWYgKCF2YWx1ZSkge1xyXG4gICAgICAvLyAgIHZhbHVlID0gJzAwMDEtMDEtMDFUMDA6MDA6MDAnO1xyXG4gICAgICAvLyB9XHJcbiAgICAgIHRoaXMudXBkYXRlQmluZGluZ0xpc3QocHJpbWFyeVZhbHVlLCBmaWVsZFBhdGhzLmpvaW4oJy4nKSwgdmFsdWUpO1xyXG4gICAgfSBlbHNlIGlmIChjdXJyZW50Q29sdW1uVHlwZSA9PT0gJ251bWJlcicgJiYgIWlzQmlnTnVtYmVyKSB7XHJcbiAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgdGhpcy51cGRhdGVCaW5kaW5nTGlzdChwcmltYXJ5VmFsdWUsIGZpZWxkUGF0aHMuam9pbignLicpLCBudWxsKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICB0aGlzLnVwZGF0ZUJpbmRpbmdMaXN0KHByaW1hcnlWYWx1ZSwgZmllbGRQYXRocy5qb2luKCcuJyksIE51bWJlcih2YWx1ZSkpO1xyXG4gICAgICB9XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLnVwZGF0ZUJpbmRpbmdMaXN0KHByaW1hcnlWYWx1ZSwgZmllbGRQYXRocy5qb2luKCcuJyksIHZhbHVlKTtcclxuICAgIH1cclxuICB9XHJcbiAgcHJpdmF0ZSB1cGRhdGVCaW5kaW5nTGlzdChwcmltYXJ5VmFsdWU6IGFueSwgcHJvcGVydHlOYW1lOiBzdHJpbmcsIHZhbHVlOiBhbnkpIHtcclxuICAgIGNvbnN0IHZpZXdNb2RlbCA9IHRoaXMudmlld01vZGVsIHx8IG51bGw7XHJcbiAgICBpZiAoIXZpZXdNb2RlbCB8fCAhcHJvcGVydHlOYW1lKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIC8vIOabtOaWsOS4u+ihqOmDqOWIhuihjOeahOWtl+autVxyXG4gICAgY29uc3QgcHJvcGVydHlOYW1lcyA9IHByb3BlcnR5TmFtZS5zcGxpdCgnLicpLmZpbHRlcihpdGVtID0+IGl0ZW0pO1xyXG4gICAgY29uc3QgYmluZGluZ1BhdGggPSB0aGlzLmdldEJpbmRpbmdQYXRoQXJyYXkoKTtcclxuICAgIC8vIOWPluWHuuadpeeahOS4gOWumuaYr2JpbmRpbmdMaXN0XHJcbiAgICBjb25zdCBsaXN0ID0gdGhpcy5iaW5kaW5nRGF0YS5nZXRWYWx1ZShiaW5kaW5nUGF0aCkgYXMgQmluZGluZ0xpc3Q7XHJcbiAgICAvLyDkv67mlLnnmoTmmK/lvZPliY3ooYxcclxuICAgIGlmIChsaXN0ICYmIHByaW1hcnlWYWx1ZSA9PT0gbGlzdC5jdXJyZW50SXRlbS5wcmltYXJ5S2V5VmFsdWUpIHtcclxuICAgICAgY29uc3QgcGF0aHMgPSBiaW5kaW5nUGF0aC5jb25jYXQocHJvcGVydHlOYW1lcyk7XHJcbiAgICAgIHRoaXMuYmluZGluZ0RhdGEuc2V0VmFsdWUocGF0aHMsIHZhbHVlLCB0cnVlLCB0cnVlKTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgY29uc3QgYmluZGluZ09iamVjdCA9IHRoaXMuYmluZGluZ0xpc3QuZmluZEJ5SWQocHJpbWFyeVZhbHVlKTtcclxuICAgIGlmICghYmluZGluZ09iamVjdCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBpZiAocHJvcGVydHlOYW1lcy5sZW5ndGggPCAyKSB7XHJcbiAgICAgIGJpbmRpbmdPYmplY3Quc2V0VmFsdWUocHJvcGVydHlOYW1lLCB2YWx1ZSwgdHJ1ZSwgdHJ1ZSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBsZXQgdGFyZ2V0QmluZGluZ09iamVjdCA9IG51bGw7XHJcbiAgICAgIGNvbnN0IGZwYXRocyA9IHByb3BlcnR5TmFtZXMuc2xpY2UoMCwgcHJvcGVydHlOYW1lcy5sZW5ndGggLSAxKTtcclxuICAgICAgY29uc3QgdGFyZ2V0UHJvcGVydHlOYW1lID0gcHJvcGVydHlOYW1lc1twcm9wZXJ0eU5hbWVzLmxlbmd0aCAtIDFdO1xyXG4gICAgICBmcGF0aHMuZm9yRWFjaChwcm9wID0+IHtcclxuICAgICAgICB0YXJnZXRCaW5kaW5nT2JqZWN0ID0gdGFyZ2V0QmluZGluZ09iamVjdCAmJiB0YXJnZXRCaW5kaW5nT2JqZWN0W3Byb3BdIHx8IGJpbmRpbmdPYmplY3RbcHJvcF07XHJcbiAgICAgIH0pO1xyXG4gICAgICAvLyB0b2RvOumcgOimgea3u+WKoOWAvOWPmOWMluS6i+S7tlxyXG4gICAgICB0YXJnZXRCaW5kaW5nT2JqZWN0LnNldFZhbHVlKHRhcmdldFByb3BlcnR5TmFtZSwgdmFsdWUsIHRydWUsIHRydWUpO1xyXG4gICAgfVxyXG4gIH1cclxuICBwcml2YXRlIGRldGFjaCgpIHtcclxuICAgIGlmICh0aGlzLmJlZ2luRWRpdFN1YnNjcmlwdGlvbiAmJiB0eXBlb2YgdGhpcy5iZWdpbkVkaXRTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUgPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgdGhpcy5iZWdpbkVkaXRTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcclxuICAgIH1cclxuICAgIGlmICh0aGlzLmVuZEVkaXRTdWJzY3JpcHRpb24gJiYgdHlwZW9mIHRoaXMuZW5kRWRpdFN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICB0aGlzLmVuZEVkaXRTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vI3JlZ2lvbiDluK7liqnlrZfmrrXmmKDlsIRcclxuXHJcbiAgcHJpdmF0ZSBsb29rdXBNYXBwaW5nKGhlbHBEYXRhOiBhbnksIG1hcEZpZWxkczogYW55KSB7XHJcbiAgICBpZiAoIW1hcEZpZWxkcykge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICAvLyDlhbPpl63lj5jmm7Tmo4DmtYtcclxuICAgIGNvbnN0IGFwcENvbnRleHQgPSB0aGlzLnZpZXdNb2RlbC5mcmFtZUNvbnRleHQuYXBwQ29udGV4dDtcclxuICAgIGFwcENvbnRleHQuY2hhbmdlRGV0ZWN0aW9uQ29udHJvbGxlci5kZXRhY2goKTtcclxuXHJcbiAgICBjb25zdCBwYXRoQXJyID0gdGhpcy5nZXRCaW5kaW5nUGF0aEFycmF5KCk7XHJcbiAgICBsZXQgaGVscEZpZWxkcyA9IE9iamVjdC5rZXlzKG1hcEZpZWxkcyk7XHJcbiAgICBjb25zdCBwcmltYXJ5SW5mbyA9IHRoaXMuZ2V0TWFwRmllbGRzUHJpbWFyeUtleShtYXBGaWVsZHMsIHBhdGhBcnIpO1xyXG5cclxuICAgIGxldCBwcmltYXJ5S2V5cyA9IHByaW1hcnlJbmZvICYmIHByaW1hcnlJbmZvLm1hcChpdGVtID0+IGl0ZW0ucHJpbWFyeUtleSkgfHwgW107XHJcbiAgICBjb25zdCBwcmltYXJ5RmllbGRzID0gcHJpbWFyeUluZm8gJiYgcHJpbWFyeUluZm8ubWFwKGl0ZW0gPT4gaXRlbS5wcmltYXJ5RmllbGQpIHx8IFtdO1xyXG4gICAgLy8g5Y676YeNXHJcbiAgICBpZiAocHJpbWFyeUtleXMgJiYgcHJpbWFyeUtleXMubGVuZ3RoID4gMCkge1xyXG4gICAgICBwcmltYXJ5S2V5cyA9IFsuLi5uZXcgU2V0KHByaW1hcnlLZXlzKV07XHJcbiAgICAgIGhlbHBGaWVsZHMgPSB0aGlzLnNvcnRNYXBGaWVsZEtleXMoaGVscEZpZWxkcywgcHJpbWFyeUtleXMpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICghaGVscERhdGEpIHtcclxuICAgICAgaGVscEZpZWxkcy5yZXZlcnNlKCk7XHJcbiAgICB9XHJcbiAgICBoZWxwRmllbGRzLmZvckVhY2goKGY6IGFueSkgPT4ge1xyXG4gICAgICBsZXQgdmFsOiBhbnkgPSAnJztcclxuICAgICAgaWYgKGhlbHBEYXRhKSB7XHJcbiAgICAgICAgaWYgKGhlbHBEYXRhIGluc3RhbmNlb2YgQXJyYXkpIHtcclxuICAgICAgICAgIHZhbCA9IGhlbHBEYXRhLm1hcCgoaDogYW55KSA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldFZhbHVlKGYsIGgpO1xyXG4gICAgICAgICAgfSkuam9pbignLCcpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICB2YWwgPSB0aGlzLmdldFZhbHVlKGYsIGhlbHBEYXRhKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGxldCBtYXBwaW5nczogYW55W10gPSBtYXBGaWVsZHNbZl0uc3BsaXQoJywnKTtcclxuICAgICAgY29uc3QgaGVhZE1hcHBpbmdzID0gbWFwcGluZ3MuZmlsdGVyKHAgPT4gcHJpbWFyeUZpZWxkcy5pbmNsdWRlcyhwKSk7XHJcbiAgICAgIGNvbnN0IGxlZnRNYXBwaW5ncyA9IG1hcHBpbmdzLmZpbHRlcihwID0+ICFwcmltYXJ5RmllbGRzLmluY2x1ZGVzKHApKTtcclxuICAgICAgaWYgKCFoZWxwRGF0YSkge1xyXG4gICAgICAgIG1hcHBpbmdzID0gW10uY29uY2F0KGxlZnRNYXBwaW5ncykuY29uY2F0KGhlYWRNYXBwaW5ncyk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgbWFwcGluZ3MgPSBbXS5jb25jYXQoaGVhZE1hcHBpbmdzKS5jb25jYXQobGVmdE1hcHBpbmdzKTtcclxuICAgICAgfVxyXG4gICAgICBtYXBwaW5ncy5mb3JFYWNoKChmZjogYW55KSA9PiB7XHJcbiAgICAgICAgaWYgKCFoZWxwRGF0YSkge1xyXG4gICAgICAgICAgdGhpcy52aWV3TW9kZWwuYmluZGluZ0RhdGEuY2xlYXJWYWx1ZShwYXRoQXJyLmNvbmNhdChmZi5zcGxpdCgnLicpKSwgdHJ1ZSwgdHJ1ZSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHRoaXMudmlld01vZGVsLmJpbmRpbmdEYXRhLnNldFZhbHVlKHBhdGhBcnIuY29uY2F0KGZmLnNwbGl0KCcuJykpLCB2YWwsIHRydWUsIHRydWUpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICAvLyDph43mlrDmiZPlvIDlj5jmm7Tmo4DmtYtcclxuICAgIGFwcENvbnRleHQuY2hhbmdlRGV0ZWN0aW9uQ29udHJvbGxlci5yZWF0dGFjaCgpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXRWYWx1ZShmOiBzdHJpbmcsIGRhdGE6IGFueSkge1xyXG4gICAgbGV0IHZhbCA9ICcnO1xyXG4gICAgaWYgKGYuaW5kZXhPZignLicpID09PSAtMSkge1xyXG4gICAgICB2YWwgPSBkYXRhW2ZdO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdmFsID0gZi5zcGxpdCgnLicpLnJlZHVjZSgoYSwgYikgPT4ge1xyXG4gICAgICAgIHJldHVybiBhW2JdO1xyXG4gICAgICB9LCBkYXRhKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gdmFsO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXRCaW5kaW5nUGF0aEFycmF5KCk6IGFueVtdIHtcclxuICAgIGNvbnN0IHBhdGggPSB0aGlzLnZpZXdNb2RlbC5iaW5kaW5nUGF0aDtcclxuICAgIGlmIChwYXRoKSB7XHJcbiAgICAgIHJldHVybiBwYXRoLnNwbGl0KCcvJykuZmlsdGVyKG4gPT4gbiAhPT0gJycpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIFtdO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBpc051bWJlclZhbHVlKGZpZWxkLCBkYXRhKSB7XHJcbiAgICBjb25zdCBjdXJyZW50VmFsID0gdGhpcy5nZXRWYWx1ZShmaWVsZCwgZGF0YSk7XHJcbiAgICByZXR1cm4gaXNOdW1iZXIoY3VycmVudFZhbCk7XHJcbiAgfVxyXG5cclxuICAvLyNlbmRyZWdpb25cclxuICAvKipcclxuICAgKiBcclxuICAgKiBAcGFyYW0gbWFwRmllbGRzICDmoLzlvI/lvaLlpoLvvJp7aWQ6IFwiYXNzb0ZpZWxkLmFzc29GaWVsZFwiLCBjb2RlOiBcImFzc29GaWVsZC5hc3NvRmllbGRfQ29kZVwiLCBuYW1lOiBcImFzc29GaWVsZC5hc3NvRmllbGRfTmFtZVwifSDmiJbogIUge2lkOid2aWQnLGNvZGU6J2NvZGUnLG5hbWU6J25hbWUnfVxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0TWFwRmllbGRzUHJpbWFyeUtleShtYXBGaWVsZHM6IGFueSwgYmluZGluZ1BhdGhzOiBzdHJpbmdbXSk6IEFycmF5PHsgcHJpbWFyeUtleTogc3RyaW5nLCBwcmltYXJ5RmllbGQ6IHN0cmluZyB9PiB7XHJcbiAgICBpZiAoIW1hcEZpZWxkcyB8fCBPYmplY3Qua2V5cyhtYXBGaWVsZHMpLmxlbmd0aCA8IDEpIHtcclxuICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcbiAgICBjb25zdCByZXN1bHRzID0gW107XHJcbiAgICAvLyBsZXQgcHJpbWFyeUZpZWxkID0gbnVsbDtcclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IGVudGl0eVR5cGVJbmZvOiBEYXRhVHlwZUluZm8gPSB0aGlzLnZpZXdNb2RlbC5mcmFtZUNvbnRleHQucmVwb3NpdG9yeS5lbnRpdHlUeXBlSW5mbztcclxuICAgICAgT2JqZWN0LmtleXMobWFwRmllbGRzKS5mb3JFYWNoKChrZXk6IHN0cmluZykgPT4ge1xyXG4gICAgICAgIGNvbnN0IG1hcEZpZWxkID0gbWFwRmllbGRzW2tleV07XHJcbiAgICAgICAgaWYgKG1hcEZpZWxkICYmIHR5cGVvZiBtYXBGaWVsZCA9PT0gJ3N0cmluZycpIHtcclxuICAgICAgICAgIGNvbnN0IG1hcHBpbmdzID0gbWFwRmllbGQuc3BsaXQoJywnKS5maWx0ZXIocCA9PiBwKTtcclxuICAgICAgICAgIG1hcHBpbmdzLmZvckVhY2goKGl0ZW06IHN0cmluZykgPT4ge1xyXG4gICAgICAgICAgICBsZXQgcGF0aHMgPSBpdGVtLnNwbGl0KCcuJyk7XHJcbiAgICAgICAgICAgIGlmIChiaW5kaW5nUGF0aHMgJiYgYmluZGluZ1BhdGhzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICBwYXRocyA9IGJpbmRpbmdQYXRocy5jb25jYXQocGF0aHMpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNvbnN0IHByb3BJbmZvOiBEYXRhUHJvcEluZm8gPSBlbnRpdHlUeXBlSW5mby5nZXRQcm9wSW5mb0J5UGF0aChwYXRocyk7XHJcbiAgICAgICAgICAgIGlmIChwcm9wSW5mbyAmJiBwcm9wSW5mby5tZXRhZGF0YUluZm8gJiYgcHJvcEluZm8ubWV0YWRhdGFJbmZvLnByaW1hcnkgPT09IHRydWUpIHtcclxuICAgICAgICAgICAgICByZXN1bHRzLnB1c2goe1xyXG4gICAgICAgICAgICAgICAgcHJpbWFyeUtleToga2V5LFxyXG4gICAgICAgICAgICAgICAgcHJpbWFyeUZpZWxkOiBpdGVtXHJcbiAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoZSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcmVzdWx0cztcclxuICB9XHJcbiAgcHJpdmF0ZSBzb3J0TWFwRmllbGRLZXlzKGtleXM6IHN0cmluZ1tdLCBwcmltYXJ5S2V5czogc3RyaW5nW10pOiBzdHJpbmdbXSB7XHJcbiAgICBpZiAoIXByaW1hcnlLZXlzIHx8IHByaW1hcnlLZXlzLmxlbmd0aCA8IDEgfHwgIWtleXMgfHwga2V5cy5sZW5ndGggPCAxKSB7XHJcbiAgICAgIHJldHVybiBrZXlzO1xyXG4gICAgfVxyXG4gICAgLy8g6L+H5ruk5Ye66Z2e5Li76ZSu5pig5bCE5a2X5q61XHJcbiAgICBrZXlzID0ga2V5cy5maWx0ZXIocCA9PiAhcHJpbWFyeUtleXMuaW5jbHVkZXMocCkpO1xyXG4gICAgcmV0dXJuIFtdLmNvbmNhdChwcmltYXJ5S2V5cykuY29uY2F0KGtleXMpO1xyXG4gIH1cclxufVxyXG4iXX0=