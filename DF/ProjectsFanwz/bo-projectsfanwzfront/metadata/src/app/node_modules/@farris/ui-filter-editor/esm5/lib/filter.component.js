/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { LocaleService } from '@farris/ui-locale';
/*
 * @Author: 疯狂秀才(Lucas Huang)
 * @Date: 2018-12-04 10:43:42
 * @LastEditors: 疯狂秀才(Lucas Huang)
 * @LastEditTime: 2019-10-17 17:34:39
 * @Company: Inspur
 * @Version: v0.0.1
 */
import { Component, Input, EventEmitter, Output, Injector, ElementRef, ComponentFactoryResolver, TemplateRef, ViewChild, forwardRef, HostListener, HostBinding, ChangeDetectorRef } from '@angular/core';
import { NG_VALUE_ACCESSOR } from '@angular/forms';
import { cloneDeep } from 'lodash-es';
import { BsModalService } from '@farris/ui-modal';
import { LookupComponent } from '@farris/ui-lookup';
import { Compare } from '@farris/ui-common/types';
import { FilterService } from './services/filter.service';
import { FilterEditorComponent } from './components/filter-editor.component';
import { CommonUtils } from '@farris/ui-common';
/** @type {?} */
export var FILTER_LOOKUPGRID_VALUE_ACCESSOR = {
    provide: NG_VALUE_ACCESSOR,
    useExisting: forwardRef((/**
     * @return {?}
     */
    function () { return FilterComponent; })),
    multi: true
};
/**
 * @record
 */
export function FILTER_FIELD_EDITOR() { }
if (false) {
    /** @type {?} */
    FILTER_FIELD_EDITOR.prototype.type;
    /** @type {?|undefined} */
    FILTER_FIELD_EDITOR.prototype.options;
}
var FilterComponent = /** @class */ (function (_super) {
    tslib_1.__extends(FilterComponent, _super);
    function FilterComponent(injector, cfr, modalService, el, filterService) {
        var _this = _super.call(this, injector, el) || this;
        _this.cfr = cfr;
        _this.modalService = modalService;
        _this.el = el;
        _this.filterService = filterService;
        _this.hostCls = 'f-cmp-inputgroup';
        _this.text = '';
        _this.conditions = [];
        _this.originalData = [];
        /**
         * 字段数据
         */
        _this.columns = [];
        _this.showCode = false;
        _this.showSql = false;
        _this.enableExpress = false;
        _this.fieldEditor = { type: 'select', options: {} };
        _this.enableClear = true;
        _this.returnType = 'object';
        _this.openDialog = new EventEmitter();
        _this.showExpress = new EventEmitter();
        _this.showClearButton = false;
        _this.cd = null;
        _this.commonUtils = null;
        _this.filterService.conditionsChanged.subscribe((/**
         * @param {?} conditionList
         * @return {?}
         */
        function (conditionList) {
            _this.conditions = conditionList;
        }));
        _this.localeService = _this.injector.get(LocaleService);
        _this.cd = _this.injector.get(ChangeDetectorRef);
        _this.commonUtils = _this.injector.get(CommonUtils, null) || new CommonUtils();
        return _this;
    }
    /**
     * @return {?}
     */
    FilterComponent.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
    };
    /**
     * @param {?} event
     * @return {?}
     */
    FilterComponent.prototype.onmouseover = /**
     * @param {?} event
     * @return {?}
     */
    function (event) {
        this.showClearButton = true;
    };
    /**
     * @param {?} event
     * @return {?}
     */
    FilterComponent.prototype.onmouseleave = /**
     * @param {?} event
     * @return {?}
     */
    function (event) {
        this.showClearButton = false;
    };
    /**
     * @return {?}
     */
    FilterComponent.prototype.showDialog = /**
     * @return {?}
     */
    function () {
        var _this = this;
        if (!this.disabled) {
            if (this.fieldEditor && this.fieldEditor.type === 'combo-tree') {
                this.fieldEditor.options = this.fieldEditor.options || {};
                if (this.fieldEditor.options.autoWidth === undefined) {
                    this.fieldEditor.options.autoWidth = true;
                }
                if (!this.fieldEditor.options.columns) {
                    this.fieldEditor.options.columns = [{ field: 'label', title: 'label', width: 100 }];
                }
                if (!this.fieldEditor.options.textField) {
                    this.fieldEditor.options.textField = 'label';
                }
                if (!this.fieldEditor.options.idField) {
                    this.fieldEditor.options.idField = 'value';
                }
            }
            /** @type {?} */
            var filterEditorFactory = this.cfr.resolveComponentFactory(FilterEditorComponent);
            this.filterEditorRef = filterEditorFactory.create(this.injector);
            this.filterEditorRef.instance.columns = this.columns;
            this.filterEditorRef.instance.conditions = this.conditions;
            this.originalData = cloneDeep(this.conditions);
            this.dlgRef = this.modalService.show(this.filterEditorRef, {
                width: 800, height: 500,
                title: this.localeService.getValue('filterEditor.title'),
                enableScroll: false,
                minHeight: 398, minWidth: 798,
                iconCls: 'k-icon k-i-filter',
                buttons: this.btnRef,
                dialogFooterStyles: { background: '#F4F6F9' },
                buttonAlign: 'right',
                initialState: {
                    showCode: this.showCode,
                    showSql: this.showSql,
                    enableExpress: this.enableExpress,
                    fieldEditor: this.fieldEditor
                },
                closed: (/**
                 * @param {?} isCloseButtonClick
                 * @return {?}
                 */
                function (isCloseButtonClick) {
                    if (isCloseButtonClick) {
                        _this.cancel();
                    }
                })
            });
            this.filterEditorRef.instance.height = this.dlgRef.dialog.instance.getContainerSize().height;
            this.filterEditorRef.instance.showExpress.subscribe((/**
             * @param {?} $event
             * @return {?}
             */
            function ($event) {
                _this.showExpress.emit($event);
            }));
            this.dlgRef.dialog.instance.resized.subscribe((/**
             * @param {?} size
             * @return {?}
             */
            function (size) {
                _this.filterEditorRef.instance.height = size.containerHeight;
            }));
            this.filterEditorRef.changeDetectorRef.detectChanges();
            this.dlgRef.dialog.changeDetectorRef.reattach();
            this.openDialog.emit();
        }
    };
    /**
     * @param {?} val
     * @return {?}
     */
    FilterComponent.prototype.writeValue = /**
     * @param {?} val
     * @return {?}
     */
    function (val) {
        if (val) {
            if (typeof val === 'string') {
                val = JSON.parse(val);
            }
            this.conditions = val || [];
            this.text = this.commonUtils.buildSqlWhere(this.conditions);
        }
    };
    /**
     * @return {?}
     */
    FilterComponent.prototype.save = /**
     * @return {?}
     */
    function () {
        if (this.conditions.length) {
            this.conditions = this.conditions.filter((/**
             * @param {?} c
             * @return {?}
             */
            function (c) { return c.filterField; }));
            // 转换in 操作符的value 值
            this.conditions = this.conditions.map((/**
             * @param {?} con
             * @return {?}
             */
            function (con) {
                /** @type {?} */
                var cp = parseInt('' + con.compare, 10);
                if (cp === Compare.In || cp === Compare.NotIn) {
                    con.value = con.value.replace(/,/g, '\r\n');
                }
                return con;
            }));
            this.text = this.commonUtils.buildSqlWhere(this.conditions);
        }
        else {
            this.text = '';
        }
        if (this.cd) {
            this.cd.detectChanges();
        }
        this.closeDialog();
    };
    /**
     * @return {?}
     */
    FilterComponent.prototype.cancel = /**
     * @return {?}
     */
    function () {
        this.conditions = this.originalData;
        this.closeDialog();
    };
    /**
     * @return {?}
     */
    FilterComponent.prototype.closeDialog = /**
     * @return {?}
     */
    function () {
        this.updateModel();
        this.filterEditorRef = null;
        this.dlgRef.close();
    };
    /**
     * @return {?}
     */
    FilterComponent.prototype.clear = /**
     * @return {?}
     */
    function () {
        this.text = '';
        this.conditions = [];
        this.updateModel();
    };
    /**
     * @private
     * @return {?}
     */
    FilterComponent.prototype.updateModel = /**
     * @private
     * @return {?}
     */
    function () {
        /** @type {?} */
        var v = this.conditions;
        if (this.returnType === 'string') {
            v = JSON.stringify(this.conditions);
        }
        this.onModelChange(v);
        this.onModelTouched(v);
    };
    FilterComponent.decorators = [
        { type: Component, args: [{
                    selector: 'filter,filter-textbox',
                    template: "<div class=\"input-group\">\r\n    <input #txtbox\r\n        class=\"form-control\" \r\n        [value]=\"text\"\r\n        [readonly]=\"!editable || readonly\"\r\n        [class.f-state-disabled] = \"disabled\"\r\n        [class.f-state-readonly] = \"readonly\"\r\n        [class.f-state-editable] = \"!editable\"\r\n        [disabled]=\"disabled\"/>\r\n    <div class=\"input-group-append\" *ngIf=\"!readonly && !disabled\">\r\n        <span *ngIf=\"showClearButton && enableClear\" class=\"f-select input-group-text lookup-clear\" (click)=\"clear()\">\r\n            <i class=\"f-icon modal_close\"></i>\r\n        </span>\r\n        <span class=\"f-select input-group-text\"  (click)=\"showDialog()\">\r\n            <i class=\"f-icon f-icon-lookup\"></i>\r\n        </span>\r\n    </div>\r\n</div>\r\n\r\n<ng-template #defaultButtonRef>\r\n    <button class=\"btn btn-outline-secondary\" (click)=\"cancel()\"> {{ 'filterEditor.cancelButton'|locale }} </button>&nbsp;\r\n    <button class=\"btn btn-primary\" (click)=\"save()\"> {{ 'filterEditor.okButton'| locale }} </button>\r\n</ng-template>",
                    providers: [
                        FILTER_LOOKUPGRID_VALUE_ACCESSOR,
                        FilterService
                    ],
                    styles: ["\n        .lookup-clear { cursor: pointer; background: #fff!important;}\n        .lookup-clear:hover { background: #e9ecef!important;}\n        "]
                }] }
    ];
    /** @nocollapse */
    FilterComponent.ctorParameters = function () { return [
        { type: Injector },
        { type: ComponentFactoryResolver },
        { type: BsModalService },
        { type: ElementRef },
        { type: FilterService }
    ]; };
    FilterComponent.propDecorators = {
        hostCls: [{ type: HostBinding, args: ['class',] }],
        columns: [{ type: Input }],
        showCode: [{ type: Input }],
        showSql: [{ type: Input }],
        enableExpress: [{ type: Input }],
        fieldEditor: [{ type: Input }],
        enableClear: [{ type: Input }],
        returnType: [{ type: Input }],
        openDialog: [{ type: Output }],
        showExpress: [{ type: Output }],
        btnRef: [{ type: ViewChild, args: ['defaultButtonRef',] }],
        textbox: [{ type: ViewChild, args: ['txtbox',] }],
        onmouseover: [{ type: HostListener, args: ['mouseover', ['$event'],] }],
        onmouseleave: [{ type: HostListener, args: ['mouseleave', ['$event'],] }]
    };
    return FilterComponent;
}(LookupComponent));
export { FilterComponent };
if (false) {
    /** @type {?} */
    FilterComponent.prototype.hostCls;
    /** @type {?} */
    FilterComponent.prototype.text;
    /** @type {?} */
    FilterComponent.prototype.conditions;
    /** @type {?} */
    FilterComponent.prototype.originalData;
    /**
     * 字段数据
     * @type {?}
     */
    FilterComponent.prototype.columns;
    /** @type {?} */
    FilterComponent.prototype.showCode;
    /** @type {?} */
    FilterComponent.prototype.showSql;
    /** @type {?} */
    FilterComponent.prototype.enableExpress;
    /** @type {?} */
    FilterComponent.prototype.fieldEditor;
    /** @type {?} */
    FilterComponent.prototype.enableClear;
    /** @type {?} */
    FilterComponent.prototype.returnType;
    /** @type {?} */
    FilterComponent.prototype.openDialog;
    /** @type {?} */
    FilterComponent.prototype.showExpress;
    /** @type {?} */
    FilterComponent.prototype.btnRef;
    /** @type {?} */
    FilterComponent.prototype.textbox;
    /** @type {?} */
    FilterComponent.prototype.showClearButton;
    /** @type {?} */
    FilterComponent.prototype.cd;
    /** @type {?} */
    FilterComponent.prototype.dlgRef;
    /** @type {?} */
    FilterComponent.prototype.filterEditorRef;
    /** @type {?} */
    FilterComponent.prototype.localeService;
    /** @type {?} */
    FilterComponent.prototype.commonUtils;
    /**
     * @type {?}
     * @private
     */
    FilterComponent.prototype.cfr;
    /**
     * @type {?}
     * @private
     */
    FilterComponent.prototype.modalService;
    /** @type {?} */
    FilterComponent.prototype.el;
    /**
     * @type {?}
     * @private
     */
    FilterComponent.prototype.filterService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsdGVyLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvdWktZmlsdGVyLWVkaXRvci8iLCJzb3VyY2VzIjpbImxpYi9maWx0ZXIuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLG1CQUFtQixDQUFDOzs7Ozs7Ozs7QUFTbEQsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsWUFBWSxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsVUFBVSxFQUM3RCx3QkFBd0IsRUFBRSxXQUFXLEVBQUUsU0FBUyxFQUNoRCxVQUFVLEVBQVUsWUFBWSxFQUFFLFdBQVcsRUFBRSxpQkFBaUIsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNoRyxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNuRCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ3RDLE9BQU8sRUFBYyxjQUFjLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUM5RCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDcEQsT0FBTyxFQUFtQixPQUFPLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUVuRSxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDMUQsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sc0NBQXNDLENBQUM7QUFDN0UsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLG1CQUFtQixDQUFDOztBQUVoRCxNQUFNLEtBQU8sZ0NBQWdDLEdBQVE7SUFDakQsT0FBTyxFQUFFLGlCQUFpQjtJQUMxQixXQUFXLEVBQUUsVUFBVTs7O0lBQUMsY0FBTSxPQUFBLGVBQWUsRUFBZixDQUFlLEVBQUM7SUFDOUMsS0FBSyxFQUFFLElBQUk7Q0FDZDs7OztBQUVELHlDQUdDOzs7SUFGRyxtQ0FBeUM7O0lBQ3pDLHNDQUFjOztBQUds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RTt3QkFDUCxnQ0FBZ0M7d0JBQ2hDLGFBQWE7cUJBQ2hCOzZCQUVHLGtKQUdDO2lCQUVSOzs7O2dCQXJDZ0QsUUFBUTtnQkFDakQsd0JBQXdCO2dCQUlYLGNBQWM7Z0JBTHdCLFVBQVU7Z0JBUzVELGFBQWE7OzswQkErQmpCLFdBQVcsU0FBQyxPQUFPOzBCQU1uQixLQUFLOzJCQUNMLEtBQUs7MEJBQ0wsS0FBSztnQ0FDTCxLQUFLOzhCQUNMLEtBQUs7OEJBQ0wsS0FBSzs2QkFDTCxLQUFLOzZCQUdMLE1BQU07OEJBQ04sTUFBTTt5QkFDTixTQUFTLFNBQUMsa0JBQWtCOzBCQUM1QixTQUFTLFNBQUMsUUFBUTs4QkE4QmxCLFlBQVksU0FBQyxXQUFXLEVBQUUsQ0FBQyxRQUFRLENBQUM7K0JBS3BDLFlBQVksU0FBQyxZQUFZLEVBQUUsQ0FBQyxRQUFRLENBQUM7O0lBc0kxQyxzQkFBQztDQUFBLEFBM01ELENBY3FDLGVBQWUsR0E2TG5EO1NBN0xZLGVBQWU7OztJQUV4QixrQ0FBbUQ7O0lBRW5ELCtCQUFVOztJQUNWLHFDQUFtQzs7SUFDbkMsdUNBQXFDOzs7OztJQUVyQyxrQ0FBd0Q7O0lBQ3hELG1DQUEwQjs7SUFDMUIsa0NBQXlCOztJQUN6Qix3Q0FBK0I7O0lBQy9CLHNDQUEyRTs7SUFDM0Usc0NBQTRCOztJQUM1QixxQ0FBb0Q7O0lBR3BELHFDQUEwQzs7SUFDMUMsc0NBQTJDOztJQUMzQyxpQ0FBd0Q7O0lBQ3hELGtDQUE4Qzs7SUFFOUMsMENBQXdCOztJQUN4Qiw2QkFBNkI7O0lBQzdCLGlDQUFtQjs7SUFDbkIsMENBQXFEOztJQUNyRCx3Q0FBNkI7O0lBRTdCLHNDQUFnQzs7Ozs7SUFFUiw4QkFBcUM7Ozs7O0lBQ3pELHVDQUFvQzs7SUFBRSw2QkFBcUI7Ozs7O0lBQzNELHdDQUFvQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IExvY2FsZVNlcnZpY2UgfSBmcm9tICdAZmFycmlzL3VpLWxvY2FsZSc7XHJcbi8qXHJcbiAqIEBBdXRob3I6IOeWr+eLguengOaJjShMdWNhcyBIdWFuZylcclxuICogQERhdGU6IDIwMTgtMTItMDQgMTA6NDM6NDJcclxuICogQExhc3RFZGl0b3JzOiDnlq/ni4Lnp4DmiY0oTHVjYXMgSHVhbmcpXHJcbiAqIEBMYXN0RWRpdFRpbWU6IDIwMTktMTAtMTcgMTc6MzQ6MzlcclxuICogQENvbXBhbnk6IEluc3B1clxyXG4gKiBAVmVyc2lvbjogdjAuMC4xXHJcbiAqL1xyXG5pbXBvcnQgeyBDb21wb25lbnQsIElucHV0LCBFdmVudEVtaXR0ZXIsIE91dHB1dCwgSW5qZWN0b3IsIEVsZW1lbnRSZWYsXHJcbiAgICAgICAgQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLCBUZW1wbGF0ZVJlZiwgVmlld0NoaWxkLCBDb21wb25lbnRSZWYsXHJcbiAgICAgICAgZm9yd2FyZFJlZiwgT25Jbml0LCBIb3N0TGlzdGVuZXIsIEhvc3RCaW5kaW5nLCBDaGFuZ2VEZXRlY3RvclJlZiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBOR19WQUxVRV9BQ0NFU1NPUiB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcclxuaW1wb3J0IHsgY2xvbmVEZWVwIH0gZnJvbSAnbG9kYXNoLWVzJztcclxuaW1wb3J0IHsgQnNNb2RhbFJlZiwgQnNNb2RhbFNlcnZpY2UgfSBmcm9tICdAZmFycmlzL3VpLW1vZGFsJztcclxuaW1wb3J0IHsgTG9va3VwQ29tcG9uZW50IH0gZnJvbSAnQGZhcnJpcy91aS1sb29rdXAnO1xyXG5pbXBvcnQgeyBGaWx0ZXJDb25kaXRpb24sIENvbXBhcmUgfSBmcm9tICdAZmFycmlzL3VpLWNvbW1vbi90eXBlcyc7XHJcblxyXG5pbXBvcnQgeyBGaWx0ZXJTZXJ2aWNlIH0gZnJvbSAnLi9zZXJ2aWNlcy9maWx0ZXIuc2VydmljZSc7XHJcbmltcG9ydCB7IEZpbHRlckVkaXRvckNvbXBvbmVudCB9IGZyb20gJy4vY29tcG9uZW50cy9maWx0ZXItZWRpdG9yLmNvbXBvbmVudCc7XHJcbmltcG9ydCB7IENvbW1vblV0aWxzIH0gZnJvbSAnQGZhcnJpcy91aS1jb21tb24nO1xyXG5cclxuZXhwb3J0IGNvbnN0IEZJTFRFUl9MT09LVVBHUklEX1ZBTFVFX0FDQ0VTU09SOiBhbnkgPSB7XHJcbiAgICBwcm92aWRlOiBOR19WQUxVRV9BQ0NFU1NPUixcclxuICAgIHVzZUV4aXN0aW5nOiBmb3J3YXJkUmVmKCgpID0+IEZpbHRlckNvbXBvbmVudCksXHJcbiAgICBtdWx0aTogdHJ1ZVxyXG59O1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBGSUxURVJfRklFTERfRURJVE9SIHtcclxuICAgIHR5cGU6ICdzZWxlY3QnIHwgJ2NvbWJvLXRyZWUnIHwgJ2xvb2t1cCc7XHJcbiAgICBvcHRpb25zPzogYW55O1xyXG59XHJcblxyXG5AQ29tcG9uZW50KHtcclxuICAgIHNlbGVjdG9yOiAnZmlsdGVyLGZpbHRlci10ZXh0Ym94JyxcclxuICAgIHRlbXBsYXRlVXJsOiAnZmlsdGVyLmNvbXBvbmVudC5odG1sJyxcclxuICAgIHByb3ZpZGVyczogW1xyXG4gICAgICAgIEZJTFRFUl9MT09LVVBHUklEX1ZBTFVFX0FDQ0VTU09SLFxyXG4gICAgICAgIEZpbHRlclNlcnZpY2VcclxuICAgIF0sXHJcbiAgICBzdHlsZXM6IFtcclxuICAgICAgICBgXHJcbiAgICAgICAgLmxvb2t1cC1jbGVhciB7IGN1cnNvcjogcG9pbnRlcjsgYmFja2dyb3VuZDogI2ZmZiFpbXBvcnRhbnQ7fVxyXG4gICAgICAgIC5sb29rdXAtY2xlYXI6aG92ZXIgeyBiYWNrZ3JvdW5kOiAjZTllY2VmIWltcG9ydGFudDt9XHJcbiAgICAgICAgYFxyXG4gICAgXVxyXG59KVxyXG5leHBvcnQgY2xhc3MgRmlsdGVyQ29tcG9uZW50IGV4dGVuZHMgTG9va3VwQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0IHtcclxuXHJcbiAgICBASG9zdEJpbmRpbmcoJ2NsYXNzJykgaG9zdENscyA9ICdmLWNtcC1pbnB1dGdyb3VwJztcclxuXHJcbiAgICB0ZXh0ID0gJyc7XHJcbiAgICBjb25kaXRpb25zOiBGaWx0ZXJDb25kaXRpb25bXSA9IFtdO1xyXG4gICAgb3JpZ2luYWxEYXRhOiBGaWx0ZXJDb25kaXRpb25bXSA9IFtdO1xyXG4gICAgLyoqIOWtl+auteaVsOaNriAqL1xyXG4gICAgQElucHV0KCkgY29sdW1uczoge2xhYmVsOiBzdHJpbmcsIHZhbHVlOiBzdHJpbmd9W10gPSBbXTtcclxuICAgIEBJbnB1dCgpIHNob3dDb2RlID0gZmFsc2U7XHJcbiAgICBASW5wdXQoKSBzaG93U3FsID0gZmFsc2U7XHJcbiAgICBASW5wdXQoKSBlbmFibGVFeHByZXNzID0gZmFsc2U7XHJcbiAgICBASW5wdXQoKSBmaWVsZEVkaXRvcjogRklMVEVSX0ZJRUxEX0VESVRPUiA9IHsgdHlwZTogJ3NlbGVjdCcsIG9wdGlvbnM6IHt9fTtcclxuICAgIEBJbnB1dCgpIGVuYWJsZUNsZWFyID0gdHJ1ZTtcclxuICAgIEBJbnB1dCgpIHJldHVyblR5cGU6ICdvYmplY3QnIHwgJ3N0cmluZycgPSAnb2JqZWN0JztcclxuXHJcblxyXG4gICAgQE91dHB1dCgpIG9wZW5EaWFsb2cgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XHJcbiAgICBAT3V0cHV0KCkgc2hvd0V4cHJlc3MgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XHJcbiAgICBAVmlld0NoaWxkKCdkZWZhdWx0QnV0dG9uUmVmJykgYnRuUmVmOiBUZW1wbGF0ZVJlZjxhbnk+O1xyXG4gICAgQFZpZXdDaGlsZCgndHh0Ym94JykgdGV4dGJveDogRWxlbWVudFJlZjxhbnk+O1xyXG5cclxuICAgIHNob3dDbGVhckJ1dHRvbiA9IGZhbHNlO1xyXG4gICAgY2Q6IENoYW5nZURldGVjdG9yUmVmID0gbnVsbDtcclxuICAgIGRsZ1JlZjogQnNNb2RhbFJlZjtcclxuICAgIGZpbHRlckVkaXRvclJlZjogQ29tcG9uZW50UmVmPEZpbHRlckVkaXRvckNvbXBvbmVudD47XHJcbiAgICBsb2NhbGVTZXJ2aWNlOiBMb2NhbGVTZXJ2aWNlO1xyXG5cclxuICAgIGNvbW1vblV0aWxzOiBDb21tb25VdGlscyA9IG51bGw7XHJcbiAgICBjb25zdHJ1Y3RvcihcclxuICAgICAgICBpbmplY3RvcjogSW5qZWN0b3IsIHByaXZhdGUgY2ZyOiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXHJcbiAgICAgICAgcHJpdmF0ZSBtb2RhbFNlcnZpY2U6IEJzTW9kYWxTZXJ2aWNlLCBwdWJsaWMgZWw6IEVsZW1lbnRSZWYsXHJcbiAgICAgICAgcHJpdmF0ZSBmaWx0ZXJTZXJ2aWNlOiBGaWx0ZXJTZXJ2aWNlKSB7XHJcbiAgICAgICAgc3VwZXIoaW5qZWN0b3IsIGVsKTtcclxuXHJcbiAgICAgICAgdGhpcy5maWx0ZXJTZXJ2aWNlLmNvbmRpdGlvbnNDaGFuZ2VkLnN1YnNjcmliZShjb25kaXRpb25MaXN0ID0+IHtcclxuICAgICAgICAgICAgdGhpcy5jb25kaXRpb25zID0gY29uZGl0aW9uTGlzdDtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgdGhpcy5sb2NhbGVTZXJ2aWNlID0gdGhpcy5pbmplY3Rvci5nZXQoTG9jYWxlU2VydmljZSk7XHJcblxyXG4gICAgICAgIHRoaXMuY2QgPSB0aGlzLmluamVjdG9yLmdldChDaGFuZ2VEZXRlY3RvclJlZik7XHJcblxyXG4gICAgICAgIHRoaXMuY29tbW9uVXRpbHMgPSB0aGlzLmluamVjdG9yLmdldChDb21tb25VdGlscywgbnVsbCkgfHwgbmV3IENvbW1vblV0aWxzKCk7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIG5nT25Jbml0KCkge1xyXG4gICAgfVxyXG5cclxuICAgIEBIb3N0TGlzdGVuZXIoJ21vdXNlb3ZlcicsIFsnJGV2ZW50J10pXHJcbiAgICBvbm1vdXNlb3ZlcihldmVudDogYW55KSB7XHJcbiAgICAgICAgdGhpcy5zaG93Q2xlYXJCdXR0b24gPSB0cnVlO1xyXG4gICAgfVxyXG5cclxuICAgIEBIb3N0TGlzdGVuZXIoJ21vdXNlbGVhdmUnLCBbJyRldmVudCddKVxyXG4gICAgb25tb3VzZWxlYXZlKGV2ZW50OiBhbnkpIHtcclxuICAgICAgICB0aGlzLnNob3dDbGVhckJ1dHRvbiA9IGZhbHNlO1xyXG4gICAgfVxyXG5cclxuICAgIHNob3dEaWFsb2coKSB7XHJcbiAgICAgICAgaWYgKCF0aGlzLmRpc2FibGVkKSB7XHJcblxyXG4gICAgICAgICAgICBpZiAodGhpcy5maWVsZEVkaXRvciAmJiB0aGlzLmZpZWxkRWRpdG9yLnR5cGUgPT09ICdjb21iby10cmVlJykge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5maWVsZEVkaXRvci5vcHRpb25zID0gdGhpcy5maWVsZEVkaXRvci5vcHRpb25zIHx8IHt9O1xyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuZmllbGRFZGl0b3Iub3B0aW9ucy5hdXRvV2lkdGggPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZmllbGRFZGl0b3Iub3B0aW9ucy5hdXRvV2lkdGggPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGlmICghdGhpcy5maWVsZEVkaXRvci5vcHRpb25zLmNvbHVtbnMpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmZpZWxkRWRpdG9yLm9wdGlvbnMuY29sdW1ucyA9IFsgeyBmaWVsZDogJ2xhYmVsJywgdGl0bGU6ICdsYWJlbCcsIHdpZHRoOiAxMDAgfSBdO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGlmICghdGhpcy5maWVsZEVkaXRvci5vcHRpb25zLnRleHRGaWVsZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZmllbGRFZGl0b3Iub3B0aW9ucy50ZXh0RmllbGQgPSAnbGFiZWwnO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGlmICghdGhpcy5maWVsZEVkaXRvci5vcHRpb25zLmlkRmllbGQpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmZpZWxkRWRpdG9yLm9wdGlvbnMuaWRGaWVsZCA9ICd2YWx1ZSc7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGNvbnN0IGZpbHRlckVkaXRvckZhY3RvcnkgPSB0aGlzLmNmci5yZXNvbHZlQ29tcG9uZW50RmFjdG9yeShGaWx0ZXJFZGl0b3JDb21wb25lbnQpO1xyXG4gICAgICAgICAgICB0aGlzLmZpbHRlckVkaXRvclJlZiA9IGZpbHRlckVkaXRvckZhY3RvcnkuY3JlYXRlKHRoaXMuaW5qZWN0b3IpO1xyXG4gICAgICAgICAgICB0aGlzLmZpbHRlckVkaXRvclJlZi5pbnN0YW5jZS5jb2x1bW5zID0gdGhpcy5jb2x1bW5zO1xyXG4gICAgICAgICAgICB0aGlzLmZpbHRlckVkaXRvclJlZi5pbnN0YW5jZS5jb25kaXRpb25zID0gdGhpcy5jb25kaXRpb25zO1xyXG4gICAgICAgICAgICB0aGlzLm9yaWdpbmFsRGF0YSA9IGNsb25lRGVlcCh0aGlzLmNvbmRpdGlvbnMpO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5kbGdSZWYgPSB0aGlzLm1vZGFsU2VydmljZS5zaG93KHRoaXMuZmlsdGVyRWRpdG9yUmVmLCB7XHJcbiAgICAgICAgICAgICAgICB3aWR0aDogODAwLCBoZWlnaHQ6IDUwMCxcclxuICAgICAgICAgICAgICAgIHRpdGxlOiB0aGlzLmxvY2FsZVNlcnZpY2UuZ2V0VmFsdWUoJ2ZpbHRlckVkaXRvci50aXRsZScpLFxyXG4gICAgICAgICAgICAgICAgZW5hYmxlU2Nyb2xsOiBmYWxzZSxcclxuICAgICAgICAgICAgICAgIG1pbkhlaWdodDogMzk4LCBtaW5XaWR0aDogNzk4LFxyXG4gICAgICAgICAgICAgICAgaWNvbkNsczogJ2staWNvbiBrLWktZmlsdGVyJyxcclxuICAgICAgICAgICAgICAgIGJ1dHRvbnM6IHRoaXMuYnRuUmVmLFxyXG4gICAgICAgICAgICAgICAgZGlhbG9nRm9vdGVyU3R5bGVzOiB7IGJhY2tncm91bmQ6ICcjRjRGNkY5JyB9LFxyXG4gICAgICAgICAgICAgICAgYnV0dG9uQWxpZ246ICdyaWdodCcsXHJcbiAgICAgICAgICAgICAgICBpbml0aWFsU3RhdGU6IHtcclxuICAgICAgICAgICAgICAgICAgICBzaG93Q29kZTogdGhpcy5zaG93Q29kZSxcclxuICAgICAgICAgICAgICAgICAgICBzaG93U3FsOiB0aGlzLnNob3dTcWwsXHJcbiAgICAgICAgICAgICAgICAgICAgZW5hYmxlRXhwcmVzczogdGhpcy5lbmFibGVFeHByZXNzLFxyXG4gICAgICAgICAgICAgICAgICAgIGZpZWxkRWRpdG9yOiB0aGlzLmZpZWxkRWRpdG9yXHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgY2xvc2VkOiAoaXNDbG9zZUJ1dHRvbkNsaWNrOiBib29sZWFuKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGlzQ2xvc2VCdXR0b25DbGljaykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbmNlbCgpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICB0aGlzLmZpbHRlckVkaXRvclJlZi5pbnN0YW5jZS5oZWlnaHQgPSB0aGlzLmRsZ1JlZi5kaWFsb2cuaW5zdGFuY2UuZ2V0Q29udGFpbmVyU2l6ZSgpLmhlaWdodDtcclxuXHJcblxyXG4gICAgICAgICAgICB0aGlzLmZpbHRlckVkaXRvclJlZi5pbnN0YW5jZS5zaG93RXhwcmVzcy5zdWJzY3JpYmUoKCRldmVudCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zaG93RXhwcmVzcy5lbWl0KCRldmVudCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5kbGdSZWYuZGlhbG9nLmluc3RhbmNlLnJlc2l6ZWQuc3Vic2NyaWJlKCBzaXplID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZmlsdGVyRWRpdG9yUmVmLmluc3RhbmNlLmhlaWdodCA9IHNpemUuY29udGFpbmVySGVpZ2h0O1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuZmlsdGVyRWRpdG9yUmVmLmNoYW5nZURldGVjdG9yUmVmLmRldGVjdENoYW5nZXMoKTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuZGxnUmVmLmRpYWxvZy5jaGFuZ2VEZXRlY3RvclJlZi5yZWF0dGFjaCgpO1xyXG4gICAgICAgICAgICB0aGlzLm9wZW5EaWFsb2cuZW1pdCgpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICB3cml0ZVZhbHVlKHZhbDogYW55KSB7XHJcbiAgICAgICAgaWYgKHZhbCkge1xyXG4gICAgICAgICAgICBpZiAodHlwZW9mIHZhbCA9PT0gJ3N0cmluZycpIHtcclxuICAgICAgICAgICAgICAgIHZhbCA9IEpTT04ucGFyc2UodmFsKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLmNvbmRpdGlvbnMgPSB2YWwgfHwgW107XHJcbiAgICAgICAgICAgIHRoaXMudGV4dCA9IHRoaXMuY29tbW9uVXRpbHMuYnVpbGRTcWxXaGVyZSh0aGlzLmNvbmRpdGlvbnMpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBzYXZlKCkge1xyXG4gICAgICAgIGlmICh0aGlzLmNvbmRpdGlvbnMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIHRoaXMuY29uZGl0aW9ucyA9IHRoaXMuY29uZGl0aW9ucy5maWx0ZXIoYyA9PiBjLmZpbHRlckZpZWxkKTtcclxuXHJcbiAgICAgICAgICAgIC8vIOi9rOaNomluIOaTjeS9nOespueahHZhbHVlIOWAvFxyXG4gICAgICAgICAgICB0aGlzLmNvbmRpdGlvbnMgPSB0aGlzLmNvbmRpdGlvbnMubWFwKGNvbiA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBjcCA9IHBhcnNlSW50KCcnICsgY29uLmNvbXBhcmUsIDEwKTtcclxuICAgICAgICAgICAgICAgIGlmIChjcCA9PT0gQ29tcGFyZS5JbiB8fCBjcCA9PT0gQ29tcGFyZS5Ob3RJbikge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbi52YWx1ZSA9IGNvbi52YWx1ZS5yZXBsYWNlKC8sL2csICdcXHJcXG4nKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJldHVybiBjb247XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgdGhpcy50ZXh0ID0gdGhpcy5jb21tb25VdGlscy5idWlsZFNxbFdoZXJlKHRoaXMuY29uZGl0aW9ucyk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy50ZXh0ID0gJyc7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodGhpcy5jZCkge1xyXG4gICAgICAgICAgICB0aGlzLmNkLmRldGVjdENoYW5nZXMoKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuY2xvc2VEaWFsb2coKTtcclxuICAgIH1cclxuXHJcbiAgICBjYW5jZWwoKSB7XHJcbiAgICAgICAgdGhpcy5jb25kaXRpb25zID0gdGhpcy5vcmlnaW5hbERhdGE7XHJcbiAgICAgICAgdGhpcy5jbG9zZURpYWxvZygpO1xyXG4gICAgfVxyXG5cclxuICAgIGNsb3NlRGlhbG9nKCkge1xyXG4gICAgICAgIHRoaXMudXBkYXRlTW9kZWwoKTtcclxuICAgICAgICB0aGlzLmZpbHRlckVkaXRvclJlZiA9IG51bGw7XHJcbiAgICAgICAgdGhpcy5kbGdSZWYuY2xvc2UoKTtcclxuICAgIH1cclxuXHJcbiAgICBjbGVhcigpIHtcclxuICAgICAgICB0aGlzLnRleHQgPSAnJztcclxuICAgICAgICB0aGlzLmNvbmRpdGlvbnMgPSBbXTtcclxuICAgICAgICB0aGlzLnVwZGF0ZU1vZGVsKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSB1cGRhdGVNb2RlbCgpIHtcclxuICAgICAgICBsZXQgdjogYW55ID0gdGhpcy5jb25kaXRpb25zO1xyXG4gICAgICAgIGlmICh0aGlzLnJldHVyblR5cGUgPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgICAgICAgIHYgPSBKU09OLnN0cmluZ2lmeSh0aGlzLmNvbmRpdGlvbnMpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5vbk1vZGVsQ2hhbmdlKHYpO1xyXG4gICAgICAgIHRoaXMub25Nb2RlbFRvdWNoZWQodik7XHJcbiAgICB9XHJcbn1cclxuIl19