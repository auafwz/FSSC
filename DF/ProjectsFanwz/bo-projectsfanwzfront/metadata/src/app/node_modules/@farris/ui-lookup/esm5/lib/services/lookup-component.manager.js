/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { debounceTime, switchMap } from 'rxjs/operators';
import { LookupLeftComponent } from '../lookup-left.component';
var LookupComponentManager = /** @class */ (function () {
    function LookupComponentManager(ins) {
        this.ins = ins;
    }
    /**
     * @param {?=} type
     * @return {?}
     */
    LookupComponentManager.prototype.getComponentInstance = /**
     * @param {?=} type
     * @return {?}
     */
    function (type) {
        if (type === void 0) { type = 'datatable'; }
        if (!this.ins.componentRef || !this.ins.componentRef.instance) {
            return null;
        }
        if (type === 'selected') {
            return this.ins.multiSelectDT;
        }
        /** @type {?} */
        var ins = this.ins.componentRef.instance;
        if (type === 'leftDataTable' || type === 'leftTree') {
            /** @type {?} */
            var leftRef = this.ins.leftComponentRef;
            if (!leftRef || !leftRef.instance || !leftRef.instance.cmpRef || !leftRef.instance.cmpRef.instance) {
                return null;
            }
            ins = this.ins.leftComponentRef.instance.cmpRef.instance;
        }
        if (type === 'fav') {
            ins = this.ins.favoritesComponentRef.instance;
        }
        switch (type) {
            case 'leftDataTable':
            case 'fav':
            case 'datatable':
                return (/** @type {?} */ (ins));
            case 'leftTree':
            case 'treetable':
                return (/** @type {?} */ (ins));
            default:
                if (this.ins.isTree()) {
                    return (/** @type {?} */ (ins));
                }
                return (/** @type {?} */ (ins));
        }
    };
    /**
     * @param {?} data
     * @return {?}
     */
    LookupComponentManager.prototype.createComponentWithServerData = /**
     * @param {?} data
     * @return {?}
     */
    function (data) {
        if (this.ins.componentRef) {
            return;
        }
        this.ins.idField = data.idField || this.ins.idField;
        this.ins.textField = data.textField || this.ins.textField;
        this.ins.valueField = data.valueField || this.ins.valueField;
        this.ins.displayType = (data && data.displayType) || this.ins.displayType || 'LIST';
        this.ins.componentRef = this.createContent(this.ins.gridOptions);
        this.createFavoriteComponent();
        this.resizeComponent();
    };
    /**
     * @return {?}
     */
    LookupComponentManager.prototype.createFavoriteComponent = /**
     * @return {?}
     */
    function () {
        if (this.ins.useFavorite && !this.ins.favoritesComponentRef) {
            this.ins.favoriteColumns = this.ins.favHelper.getFavoriteColumns();
            /** @type {?} */
            var favoritesOptions = Object.assign({}, this.ins.gridOptions, {
                showFilterBar: false,
                pagination: false,
                columns: this.ins.favoriteColumns || []
            });
            this.ins.favoritesComponentRef = this.createFavoritesContent(favoritesOptions);
            this.resizeComponent('fav');
        }
    };
    /**
     * @param {?} opts
     * @return {?}
     */
    LookupComponentManager.prototype.createContent = /**
     * @param {?} opts
     * @return {?}
     */
    function (opts) {
        if (this.ins.componentRef) {
            return;
        }
        /** @type {?} */
        var type = this.ins.getComponentType();
        /** @type {?} */
        var dtFac = this.ins.cfr.resolveComponentFactory(type);
        /** @type {?} */
        var cmpRef = null;
        if (this.ins.isDoublleList()) {
            cmpRef = this.ins.centerContainer.createComponent(dtFac);
        }
        else {
            cmpRef = this.ins.contentContainer.createComponent(dtFac);
        }
        if (this.ins.isTree()) {
            opts.fit = true;
            opts.pagination = false;
        }
        else {
            opts.fill = true;
        }
        Object.assign(cmpRef.instance, opts, { allColumnsTitle: this.ins.allColumnsTitle });
        this.ins.componentRef = cmpRef;
        this.resizeComponent();
        return cmpRef;
    };
    // 创建收藏CMP
    // 创建收藏CMP
    /**
     * @param {?} opts
     * @return {?}
     */
    LookupComponentManager.prototype.createFavoritesContent = 
    // 创建收藏CMP
    /**
     * @param {?} opts
     * @return {?}
     */
    function (opts) {
        /** @type {?} */
        var type = this.ins.getComponentType();
        /** @type {?} */
        var dtFac = this.ins.cfr.resolveComponentFactory(type);
        /** @type {?} */
        var cmpRef = null;
        cmpRef = this.ins.favoritesContainer.createComponent(dtFac);
        if (this.ins.isTree()) {
            opts.fit = true;
            opts.pagination = false;
        }
        else {
            opts.fill = true;
        }
        Object.assign(cmpRef.instance, opts, {
            width: this.ins.dialog.size.width - 20,
            height: this.ins.dialogMgr.getHeight()
        });
        // 订阅收藏夹列表中组件的相关事件
        this.ins.favHelper.initFavoriteComponentEvent(cmpRef);
        return cmpRef;
    };
    /**
     * @param {?=} type
     * @return {?}
     */
    LookupComponentManager.prototype.resizeComponent = /**
     * @param {?=} type
     * @return {?}
     */
    function (type) {
        if (type === void 0) { type = 'datatable'; }
        /** @type {?} */
        var size = {
            width: this.ins.dialog.size.width - 20,
            height: this.ins.dialogMgr.getHeight()
        };
        if (this.ins.isDoublleList() && (type === 'datatable' || type === 'treetable')) {
            size.width = this.ins.dialog.size.width - this.ins.leftPanelWidth - 27;
        }
        this.getComponentInstance(type).resize(size);
    };
    /** 创建左侧组件 */
    /**
     * 创建左侧组件
     * @param {?} ops
     * @return {?}
     */
    LookupComponentManager.prototype.createLeftComponent = /**
     * 创建左侧组件
     * @param {?} ops
     * @return {?}
     */
    function (ops) {
        var _this = this;
        /** @type {?} */
        var dtFac = null;
        if (this.ins.isDoublleList()) {
            dtFac = this.ins.cfr.resolveComponentFactory(LookupLeftComponent);
        }
        this.ins.leftComponentRef = this.ins.leftContainer.createComponent(dtFac);
        ops.height = this.ins.dialogMgr.getHeight();
        if (this.ins.dialogWidth < this.ins.navLookupDialogMinWidth) {
            this.ins.dialogWidth = this.ins.navLookupDialogMinWidth;
            this.ins.dialog.reSize({ width: this.ins.dialogWidth });
            this.ins.resizeCmp({ width: this.ins.dialog.size.width });
        }
        if (ops.width !== this.ins.leftPanel.width) {
            // 默认 1 : 2
            this.ins.leftPanel.resize({
                width: this.ins.leftPanel.width,
                height: ops.height
            });
            this.ins.resizeCmp({ width: this.ins.dialog.size.width });
        }
        // this.resizeComponent();
        this.ins.leftComponentRef.instance.lookupCmp = this.ins;
        this.ins.leftComponentRef.instance.navOptions = ops;
        this.ins.leftComponentRef.instance.selected
            .pipe(debounceTime(100), switchMap((/**
         * @param {?} d
         * @return {?}
         */
        function (d) {
            if (d && d.data) {
                _this.ins.navigationFilter = {
                    selected: d.data,
                    idValue: _this.getNavigationFilter(d.data),
                    searchField: '',
                    searchValue: ''
                };
            }
            else {
                _this.ins.navigationFilter = undefined;
            }
            // 加载右侧数据
            /** @type {?} */
            var p = {
                pageInfo: {
                    pageIndex: _this.ins.gridOptions.pageIndex,
                    pageSize: _this.ins.gridOptions.pageSize
                }
            };
            Object.assign(p, { search: _this.ins._searchState });
            return _this.ins.httpMgr.getData(p, 'list');
        })))
            .subscribe((/**
         * @param {?} res
         * @return {?}
         */
        function (res) {
            _this.ins.closeLoading();
            _this.ins.loadDataWhenOpen = true;
            if (_this.ins.useFavorite && !_this.ins.isTree()) {
                _this.ins.favHelper.updateFavoritesStatus(res.items);
            }
            _this.ins.loadDataTableData(res);
            setTimeout((/**
             * @return {?}
             */
            function () {
                // 选中数据
                _this.ins.selectionMgr.selectCurrentValue();
                _this.ins.changeDetector.detectChanges();
            }));
        }));
        return this.ins.leftComponentRef.instance.createComponent();
    };
    // 获取关联数据, 右侧数据中 关联各字段的值
    // 获取关联数据, 右侧数据中 关联各字段的值
    /**
     * @private
     * @param {?} navRow
     * @return {?}
     */
    LookupComponentManager.prototype.getNavigationFilter = 
    // 获取关联数据, 右侧数据中 关联各字段的值
    /**
     * @private
     * @param {?} navRow
     * @return {?}
     */
    function (navRow) {
        if (this.ins.navigationOptions.relations && this.ins.navigationOptions.relations.length) {
            /** @type {?} */
            var result_1 = [];
            this.ins.navigationOptions.relations.forEach((/**
             * @param {?} r
             * @return {?}
             */
            function (r) {
                /** @type {?} */
                var k = r.groupField;
                /** @type {?} */
                var dField = r.helpField;
                /** @type {?} */
                var rf = { fieldName: dField, fieldValue: '' };
                rf.fieldValue = k.split('.').reduce((/**
                 * @param {?} o
                 * @param {?} c
                 * @return {?}
                 */
                function (o, c) {
                    return o[c];
                }), navRow);
                result_1.push(rf);
            }));
            return result_1;
        }
        return '';
    };
    return LookupComponentManager;
}());
export { LookupComponentManager };
if (false) {
    /**
     * @type {?}
     * @private
     */
    LookupComponentManager.prototype.ins;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9va3VwLWNvbXBvbmVudC5tYW5hZ2VyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy91aS1sb29rdXAvIiwic291cmNlcyI6WyJsaWIvc2VydmljZXMvbG9va3VwLWNvbXBvbmVudC5tYW5hZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFHQSxPQUFPLEVBQUUsWUFBWSxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBR3pELE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBRy9EO0lBQ0ksZ0NBQW9CLEdBQXdCO1FBQXhCLFFBQUcsR0FBSCxHQUFHLENBQXFCO0lBQUcsQ0FBQzs7Ozs7SUFFaEQscURBQW9COzs7O0lBQXBCLFVBQXFCLElBQXlDO1FBQXpDLHFCQUFBLEVBQUEsa0JBQXlDO1FBQzFELElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFlBQVksSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLFFBQVEsRUFBRTtZQUMzRCxPQUFPLElBQUksQ0FBQztTQUNmO1FBRUQsSUFBSSxJQUFJLEtBQUssVUFBVSxFQUFFO1lBQ3JCLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUM7U0FDakM7O1lBRUcsR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLFFBQVE7UUFFeEMsSUFBSSxJQUFJLEtBQUssZUFBZSxJQUFJLElBQUksS0FBSyxVQUFVLEVBQUU7O2dCQUMzQyxPQUFPLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0I7WUFDekMsSUFBSSxDQUFDLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLE1BQU0sSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRTtnQkFDaEcsT0FBTyxJQUFJLENBQUM7YUFDZjtZQUNELEdBQUcs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bkMsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLGlCQUFpQixDQUFDLFNBQVMsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLGlCQUFpQixDQUFDLFNBQVMsQ0FBQyxNQUFNLEVBQUU7O2dCQUMvRSxRQUFNLEdBQUcsRUFBRTtZQUNqQixJQUFJLENBQUMsR0FBRyxDQUFDLGlCQUFpQixDQUFDLFNBQVMsQ0FBQyxPQUFPOzs7O1lBQUMsVUFBQSxDQUFDOztvQkFDcEMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxVQUFVOztvQkFDaEIsTUFBTSxHQUFHLENBQUMsQ0FBQyxTQUFTOztvQkFDcEIsRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsRUFBRSxFQUFFO2dCQUNoRCxFQUFFLENBQUMsVUFBVSxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTTs7Ozs7Z0JBQUMsVUFBQyxDQUFDLEVBQUUsQ0FBQztvQkFDckMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ2hCLENBQUMsR0FBRSxNQUFNLENBQUMsQ0FBQztnQkFFWCxRQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQ3BCLENBQUMsRUFBQyxDQUFDO1lBQ0gsT0FBTyxRQUFNLENBQUM7U0FDakI7UUFFRCxPQUFPLEVBQUUsQ0FBQztJQUNkLENBQUM7SUFDTCw2QkFBQztBQUFELENBQUMsQUE3T0QsSUE2T0M7Ozs7Ozs7SUE1T2UscUNBQWdDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50UmVmIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IERhdGFUYWJsZUNvbXBvbmVudCB9IGZyb20gJ0BmYXJyaXMvdWktZGF0YXRhYmxlJztcclxuaW1wb3J0IHsgVHJlZVRhYmxlQ29tcG9uZW50IH0gZnJvbSAnQGZhcnJpcy91aS10cmVldGFibGUnO1xyXG5pbXBvcnQgeyBkZWJvdW5jZVRpbWUsIHN3aXRjaE1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuaW1wb3J0IHsgQ29tcG9uZW50SW5zdGFuY2VUeXBlIH0gZnJvbSAnLi4vbG9va3VwLWRpc3BsYXl0eXBlJztcclxuaW1wb3J0IHsgTG9va3VwR3JpZENvbXBvbmVudCB9IGZyb20gJy4uL2xvb2t1cC1ncmlkLmNvbXBvbmVudCc7XHJcbmltcG9ydCB7IExvb2t1cExlZnRDb21wb25lbnQgfSBmcm9tICcuLi9sb29rdXAtbGVmdC5jb21wb25lbnQnO1xyXG5cclxuXHJcbmV4cG9ydCBjbGFzcyBMb29rdXBDb21wb25lbnRNYW5hZ2VyIHtcclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgaW5zOiBMb29rdXBHcmlkQ29tcG9uZW50KSB7fVxyXG5cclxuICAgIGdldENvbXBvbmVudEluc3RhbmNlKHR5cGU6IENvbXBvbmVudEluc3RhbmNlVHlwZSA9ICdkYXRhdGFibGUnKSB7XHJcbiAgICAgICAgaWYgKCF0aGlzLmlucy5jb21wb25lbnRSZWYgfHwgIXRoaXMuaW5zLmNvbXBvbmVudFJlZi5pbnN0YW5jZSkge1xyXG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0eXBlID09PSAnc2VsZWN0ZWQnKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmlucy5tdWx0aVNlbGVjdERUO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgbGV0IGlucyA9IHRoaXMuaW5zLmNvbXBvbmVudFJlZi5pbnN0YW5jZTtcclxuXHJcbiAgICAgICAgaWYgKHR5cGUgPT09ICdsZWZ0RGF0YVRhYmxlJyB8fCB0eXBlID09PSAnbGVmdFRyZWUnKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGxlZnRSZWYgPSB0aGlzLmlucy5sZWZ0Q29tcG9uZW50UmVmO1xyXG4gICAgICAgICAgICBpZiAoIWxlZnRSZWYgfHwgIWxlZnRSZWYuaW5zdGFuY2UgfHwgIWxlZnRSZWYuaW5zdGFuY2UuY21wUmVmIHx8ICFsZWZ0UmVmLmluc3RhbmNlLmNtcFJlZi5pbnN0YW5jZSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaW5zID0gdGhpcy5pbnMubGVmdENvbXBvbmVudFJlZi5pbnN0YW5jZS5jbXBSZWYuaW5zdGFuY2U7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodHlwZSA9PT0gJ2ZhdicpIHtcclxuICAgICAgICAgICAgaW5zID0gdGhpcy5pbnMuZmF2b3JpdGVzQ29tcG9uZW50UmVmLmluc3RhbmNlO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgc3dpdGNoICh0eXBlKSB7XHJcbiAgICAgICAgICAgIGNhc2UgJ2xlZnREYXRhVGFibGUnOlxyXG4gICAgICAgICAgICBjYXNlICdmYXYnOlxyXG4gICAgICAgICAgICBjYXNlICdkYXRhdGFibGUnOlxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGlucyBhcyBEYXRhVGFibGVDb21wb25lbnQ7XHJcbiAgICAgICAgICAgIGNhc2UgJ2xlZnRUcmVlJzpcclxuICAgICAgICAgICAgY2FzZSAndHJlZXRhYmxlJzpcclxuICAgICAgICAgICAgICAgIHJldHVybiBpbnMgYXMgVHJlZVRhYmxlQ29tcG9uZW50O1xyXG4gICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuaW5zLmlzVHJlZSgpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlucyBhcyBUcmVlVGFibGVDb21wb25lbnQ7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gaW5zIGFzIERhdGFUYWJsZUNvbXBvbmVudDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgY3JlYXRlQ29tcG9uZW50V2l0aFNlcnZlckRhdGEoZGF0YTogYW55KSB7XHJcbiAgICAgICAgaWYgKHRoaXMuaW5zLmNvbXBvbmVudFJlZikge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuaW5zLmlkRmllbGQgPSBkYXRhLmlkRmllbGQgfHwgdGhpcy5pbnMuaWRGaWVsZDtcclxuICAgICAgICB0aGlzLmlucy50ZXh0RmllbGQgPSBkYXRhLnRleHRGaWVsZCB8fCB0aGlzLmlucy50ZXh0RmllbGQ7XHJcbiAgICAgICAgdGhpcy5pbnMudmFsdWVGaWVsZCA9IGRhdGEudmFsdWVGaWVsZCB8fCB0aGlzLmlucy52YWx1ZUZpZWxkO1xyXG5cclxuICAgICAgICB0aGlzLmlucy5kaXNwbGF5VHlwZSA9IChkYXRhICYmIGRhdGEuZGlzcGxheVR5cGUpIHx8IHRoaXMuaW5zLmRpc3BsYXlUeXBlIHx8ICdMSVNUJztcclxuICAgICAgICB0aGlzLmlucy5jb21wb25lbnRSZWYgPSB0aGlzLmNyZWF0ZUNvbnRlbnQodGhpcy5pbnMuZ3JpZE9wdGlvbnMpO1xyXG4gICAgICAgIHRoaXMuY3JlYXRlRmF2b3JpdGVDb21wb25lbnQoKTtcclxuXHJcbiAgICAgICAgdGhpcy5yZXNpemVDb21wb25lbnQoKTtcclxuICAgIH1cclxuXHJcblxyXG4gICAgY3JlYXRlRmF2b3JpdGVDb21wb25lbnQoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuaW5zLnVzZUZhdm9yaXRlICYmICF0aGlzLmlucy5mYXZvcml0ZXNDb21wb25lbnRSZWYpIHtcclxuICAgICAgICAgICAgdGhpcy5pbnMuZmF2b3JpdGVDb2x1bW5zID0gdGhpcy5pbnMuZmF2SGVscGVyLmdldEZhdm9yaXRlQ29sdW1ucygpO1xyXG4gICAgICAgICAgICBjb25zdCBmYXZvcml0ZXNPcHRpb25zID0gT2JqZWN0LmFzc2lnbih7fSwgdGhpcy5pbnMuZ3JpZE9wdGlvbnMsIHtcclxuICAgICAgICAgICAgICAgIHNob3dGaWx0ZXJCYXI6IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgcGFnaW5hdGlvbjogZmFsc2UsXHJcbiAgICAgICAgICAgICAgICBjb2x1bW5zOiB0aGlzLmlucy5mYXZvcml0ZUNvbHVtbnMgfHwgW11cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHRoaXMuaW5zLmZhdm9yaXRlc0NvbXBvbmVudFJlZiA9IHRoaXMuY3JlYXRlRmF2b3JpdGVzQ29udGVudChmYXZvcml0ZXNPcHRpb25zKTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMucmVzaXplQ29tcG9uZW50KCdmYXYnKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG5cclxuICAgIGNyZWF0ZUNvbnRlbnQob3B0czogYW55KTogQ29tcG9uZW50UmVmPGFueT4ge1xyXG5cclxuICAgICAgICBpZiAodGhpcy5pbnMuY29tcG9uZW50UmVmKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IHR5cGUgPSB0aGlzLmlucy5nZXRDb21wb25lbnRUeXBlKCk7XHJcblxyXG4gICAgICAgIGNvbnN0IGR0RmFjID0gdGhpcy5pbnMuY2ZyLnJlc29sdmVDb21wb25lbnRGYWN0b3J5KHR5cGUpO1xyXG4gICAgICAgIGxldCBjbXBSZWYgPSBudWxsO1xyXG4gICAgICAgIGlmICh0aGlzLmlucy5pc0RvdWJsbGVMaXN0KCkpIHtcclxuICAgICAgICAgICAgY21wUmVmID0gdGhpcy5pbnMuY2VudGVyQ29udGFpbmVyLmNyZWF0ZUNvbXBvbmVudChkdEZhYyk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgY21wUmVmID0gdGhpcy5pbnMuY29udGVudENvbnRhaW5lci5jcmVhdGVDb21wb25lbnQoZHRGYWMpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHRoaXMuaW5zLmlzVHJlZSgpKSB7XHJcbiAgICAgICAgICAgIG9wdHMuZml0ID0gdHJ1ZTtcclxuICAgICAgICAgICAgb3B0cy5wYWdpbmF0aW9uID0gZmFsc2U7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgb3B0cy5maWxsID0gdHJ1ZTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIE9iamVjdC5hc3NpZ24oY21wUmVmLmluc3RhbmNlLCBvcHRzLCB7IGFsbENvbHVtbnNUaXRsZTogdGhpcy5pbnMuYWxsQ29sdW1uc1RpdGxlIH0pO1xyXG5cclxuICAgICAgICB0aGlzLmlucy5jb21wb25lbnRSZWYgPSBjbXBSZWY7XHJcbiAgICAgICAgdGhpcy5yZXNpemVDb21wb25lbnQoKTtcclxuICAgICAgICByZXR1cm4gY21wUmVmO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIOWIm+W7uuaUtuiXj0NNUFxyXG4gICAgY3JlYXRlRmF2b3JpdGVzQ29udGVudChvcHRzOiBhbnkpOiBDb21wb25lbnRSZWY8YW55PiB7XHJcblxyXG4gICAgICAgIGNvbnN0IHR5cGUgPSB0aGlzLmlucy5nZXRDb21wb25lbnRUeXBlKCk7XHJcblxyXG4gICAgICAgIGNvbnN0IGR0RmFjID0gdGhpcy5pbnMuY2ZyLnJlc29sdmVDb21wb25lbnRGYWN0b3J5KHR5cGUpO1xyXG4gICAgICAgIGxldCBjbXBSZWYgPSBudWxsO1xyXG4gICAgICAgIGNtcFJlZiA9IHRoaXMuaW5zLmZhdm9yaXRlc0NvbnRhaW5lci5jcmVhdGVDb21wb25lbnQoZHRGYWMpO1xyXG5cclxuICAgICAgICBpZiAodGhpcy5pbnMuaXNUcmVlKCkpIHtcclxuICAgICAgICAgICAgb3B0cy5maXQgPSB0cnVlO1xyXG4gICAgICAgICAgICBvcHRzLnBhZ2luYXRpb24gPSBmYWxzZTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBvcHRzLmZpbGwgPSB0cnVlO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgT2JqZWN0LmFzc2lnbihjbXBSZWYuaW5zdGFuY2UsIG9wdHMsIHtcclxuICAgICAgICAgICAgd2lkdGg6IHRoaXMuaW5zLmRpYWxvZy5zaXplLndpZHRoIC0gMjAsXHJcbiAgICAgICAgICAgIGhlaWdodDogdGhpcy5pbnMuZGlhbG9nTWdyLmdldEhlaWdodCgpXHJcbiAgICAgICAgfSk7XHJcblxyXG5cclxuICAgICAgICAvLyDorqLpmIXmlLbol4/lpLnliJfooajkuK3nu4Tku7bnmoTnm7jlhbPkuovku7ZcclxuICAgICAgICB0aGlzLmlucy5mYXZIZWxwZXIuaW5pdEZhdm9yaXRlQ29tcG9uZW50RXZlbnQoY21wUmVmKTtcclxuXHJcbiAgICAgICAgcmV0dXJuIGNtcFJlZjtcclxuICAgIH1cclxuXHJcbiAgICByZXNpemVDb21wb25lbnQodHlwZTogQ29tcG9uZW50SW5zdGFuY2VUeXBlID0gJ2RhdGF0YWJsZScpIHtcclxuICAgICAgICBjb25zdCBzaXplID0ge1xyXG4gICAgICAgICAgICB3aWR0aDogdGhpcy5pbnMuZGlhbG9nLnNpemUud2lkdGggLSAyMCxcclxuICAgICAgICAgICAgaGVpZ2h0OiB0aGlzLmlucy5kaWFsb2dNZ3IuZ2V0SGVpZ2h0KClcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICBpZiAodGhpcy5pbnMuaXNEb3VibGxlTGlzdCgpICYmICh0eXBlID09PSAnZGF0YXRhYmxlJyB8fCB0eXBlID09PSAndHJlZXRhYmxlJykpIHtcclxuICAgICAgICAgICAgc2l6ZS53aWR0aCA9IHRoaXMuaW5zLmRpYWxvZy5zaXplLndpZHRoIC0gdGhpcy5pbnMubGVmdFBhbmVsV2lkdGggLSAyNztcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuZ2V0Q29tcG9uZW50SW5zdGFuY2UodHlwZSkucmVzaXplKHNpemUpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKiDliJvlu7rlt6bkvqfnu4Tku7YgKi9cclxuICAgIGNyZWF0ZUxlZnRDb21wb25lbnQob3BzOiBhbnkpIHtcclxuICAgICAgICBsZXQgZHRGYWMgPSBudWxsO1xyXG4gICAgICAgIGlmICh0aGlzLmlucy5pc0RvdWJsbGVMaXN0KCkpIHtcclxuICAgICAgICAgICAgZHRGYWMgPSB0aGlzLmlucy5jZnIucmVzb2x2ZUNvbXBvbmVudEZhY3RvcnkoTG9va3VwTGVmdENvbXBvbmVudCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuaW5zLmxlZnRDb21wb25lbnRSZWYgPSB0aGlzLmlucy5sZWZ0Q29udGFpbmVyLmNyZWF0ZUNvbXBvbmVudChkdEZhYyk7XHJcbiAgICAgICAgb3BzLmhlaWdodCA9IHRoaXMuaW5zLmRpYWxvZ01nci5nZXRIZWlnaHQoKTtcclxuXHJcbiAgICAgICAgaWYgKHRoaXMuaW5zLmRpYWxvZ1dpZHRoIDwgdGhpcy5pbnMubmF2TG9va3VwRGlhbG9nTWluV2lkdGgpIHtcclxuICAgICAgICAgICAgdGhpcy5pbnMuZGlhbG9nV2lkdGggPSB0aGlzLmlucy5uYXZMb29rdXBEaWFsb2dNaW5XaWR0aDtcclxuICAgICAgICAgICAgdGhpcy5pbnMuZGlhbG9nLnJlU2l6ZSh7IHdpZHRoOiB0aGlzLmlucy5kaWFsb2dXaWR0aCB9KTtcclxuICAgICAgICAgICAgdGhpcy5pbnMucmVzaXplQ21wKHsgd2lkdGg6IHRoaXMuaW5zLmRpYWxvZy5zaXplLndpZHRoIH0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKG9wcy53aWR0aCAhPT0gdGhpcy5pbnMubGVmdFBhbmVsLndpZHRoKSB7XHJcbiAgICAgICAgICAgIC8vIOm7mOiupCAxIDogMlxyXG4gICAgICAgICAgICB0aGlzLmlucy5sZWZ0UGFuZWwucmVzaXplKHtcclxuICAgICAgICAgICAgICAgIHdpZHRoOiB0aGlzLmlucy5sZWZ0UGFuZWwud2lkdGgsXHJcbiAgICAgICAgICAgICAgICBoZWlnaHQ6IG9wcy5oZWlnaHRcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHRoaXMuaW5zLnJlc2l6ZUNtcCh7IHdpZHRoOiB0aGlzLmlucy5kaWFsb2cuc2l6ZS53aWR0aCB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIHRoaXMucmVzaXplQ29tcG9uZW50KCk7XHJcblxyXG4gICAgICAgIHRoaXMuaW5zLmxlZnRDb21wb25lbnRSZWYuaW5zdGFuY2UubG9va3VwQ21wID0gdGhpcy5pbnM7XHJcbiAgICAgICAgdGhpcy5pbnMubGVmdENvbXBvbmVudFJlZi5pbnN0YW5jZS5uYXZPcHRpb25zID0gb3BzO1xyXG5cclxuXHJcbiAgICAgICAgdGhpcy5pbnMubGVmdENvbXBvbmVudFJlZi5pbnN0YW5jZS5zZWxlY3RlZFxyXG4gICAgICAgICAgICAucGlwZShcclxuICAgICAgICAgICAgICAgIGRlYm91bmNlVGltZSgxMDApLFxyXG4gICAgICAgICAgICAgICAgc3dpdGNoTWFwKChkOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZCAmJiBkLmRhdGEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnMubmF2aWdhdGlvbkZpbHRlciA9IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkOiBkLmRhdGEsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZFZhbHVlOiB0aGlzLmdldE5hdmlnYXRpb25GaWx0ZXIoZC5kYXRhKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlYXJjaEZpZWxkOiAnJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlYXJjaFZhbHVlOiAnJ1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaW5zLm5hdmlnYXRpb25GaWx0ZXIgPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIC8vIOWKoOi9veWPs+S+p+aVsOaNrlxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhZ2VJbmZvOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYWdlSW5kZXg6IHRoaXMuaW5zLmdyaWRPcHRpb25zLnBhZ2VJbmRleCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhZ2VTaXplOiB0aGlzLmlucy5ncmlkT3B0aW9ucy5wYWdlU2l6ZVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgICAgICBPYmplY3QuYXNzaWduKHAsIHsgc2VhcmNoOiB0aGlzLmlucy5fc2VhcmNoU3RhdGUgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuaW5zLmh0dHBNZ3IuZ2V0RGF0YShwLCAnbGlzdCcpO1xyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgKVxyXG4gICAgICAgICAgICAuc3Vic2NyaWJlKHJlcyA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmlucy5jbG9zZUxvYWRpbmcoKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuaW5zLmxvYWREYXRhV2hlbk9wZW4gPSB0cnVlO1xyXG5cclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLmlucy51c2VGYXZvcml0ZSAmJiAhdGhpcy5pbnMuaXNUcmVlKCkpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmlucy5mYXZIZWxwZXIudXBkYXRlRmF2b3JpdGVzU3RhdHVzKHJlcy5pdGVtcyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgdGhpcy5pbnMubG9hZERhdGFUYWJsZURhdGEocmVzKTtcclxuICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIOmAieS4reaVsOaNrlxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaW5zLnNlbGVjdGlvbk1nci5zZWxlY3RDdXJyZW50VmFsdWUoKTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmlucy5jaGFuZ2VEZXRlY3Rvci5kZXRlY3RDaGFuZ2VzKCk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJldHVybiB0aGlzLmlucy5sZWZ0Q29tcG9uZW50UmVmLmluc3RhbmNlLmNyZWF0ZUNvbXBvbmVudCgpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIOiOt+WPluWFs+iBlOaVsOaNriwg5Y+z5L6n5pWw5o2u5LitIOWFs+iBlOWQhOWtl+auteeahOWAvFxyXG4gICAgcHJpdmF0ZSBnZXROYXZpZ2F0aW9uRmlsdGVyKG5hdlJvdzogYW55KSB7XHJcbiAgICAgICAgaWYgKHRoaXMuaW5zLm5hdmlnYXRpb25PcHRpb25zLnJlbGF0aW9ucyAmJiB0aGlzLmlucy5uYXZpZ2F0aW9uT3B0aW9ucy5yZWxhdGlvbnMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IFtdO1xyXG4gICAgICAgICAgICB0aGlzLmlucy5uYXZpZ2F0aW9uT3B0aW9ucy5yZWxhdGlvbnMuZm9yRWFjaChyID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGsgPSByLmdyb3VwRmllbGQ7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBkRmllbGQgPSByLmhlbHBGaWVsZDtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHJmID0geyBmaWVsZE5hbWU6IGRGaWVsZCwgZmllbGRWYWx1ZTogJycgfTtcclxuICAgICAgICAgICAgICAgIHJmLmZpZWxkVmFsdWUgPSBrLnNwbGl0KCcuJykucmVkdWNlKChvLCBjKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9bY107XHJcbiAgICAgICAgICAgICAgICB9LCBuYXZSb3cpO1xyXG5cclxuICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKHJmKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gJyc7XHJcbiAgICB9XHJcbn1cclxuIl19