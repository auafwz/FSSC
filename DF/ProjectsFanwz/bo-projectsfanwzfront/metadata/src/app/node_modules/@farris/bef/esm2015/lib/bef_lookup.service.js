/**
 * @fileoverview added by tsickle
 * Generated from: lib/bef_lookup.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable, Optional } from '@angular/core';
import { EMPTY } from 'rxjs';
import { switchMap, map, catchError } from 'rxjs/operators';
import { Repository, FrameContext } from '@farris/devkit';
/**
 * 帮助Rest取数服务
 */
export class BefLookupRestService {
    /**
     * 构造函数
     * @param {?} repository
     * @param {?} frameContext
     */
    constructor(repository, frameContext) {
        this.frameContext = frameContext;
        this.befRepository = (/** @type {?} */ (repository));
    }
    /**
     * @param {?} helpMetadataId
     * @param {?=} data
     * @return {?}
     */
    getData(helpMetadataId, data) {
        /** @type {?} */
        const tableName = helpMetadataId.split('.')[0];
        /** @type {?} */
        const labelId = helpMetadataId.split('.')[1];
        data = data || {};
        /** @type {?} */
        const enableExtendLoadMethod = this.ifEnableExtendLoadMethod(helpMetadataId);
        if (enableExtendLoadMethod === true) {
            return this.extendGetHelpData(labelId, tableName, data);
        }
        return this.getHelpData(labelId, tableName, data);
    }
    /**
     * @param {?} data
     * @return {?}
     */
    saveUserSettings(data) {
        /** @type {?} */
        const url = '/api/runtime/bcc/v1.0/datagrid/settings';
        return this.befRepository.restService.invoke(url, 'POST', null, { body: data }, false).pipe(catchError((/**
         * @param {?} error
         * @return {?}
         */
        error => {
            /** @type {?} */
            const formAppContext = this.befRepository.appContext.getFormAppContext();
            this.befRepository.restService.eventBus.post('Exception', '', 'onException', error, formAppContext);
            return EMPTY;
        })));
    }
    /**
     * @param {?} key
     * @return {?}
     */
    getUserSettings(key) {
        /** @type {?} */
        const url = '/api/runtime/bcc/v1.0/datagrid/settings/' + key;
        return this.befRepository.restService.invoke(url, 'GET', null, null, false).pipe(catchError((/**
         * @param {?} error
         * @return {?}
         */
        error => {
            /** @type {?} */
            const formAppContext = this.befRepository.appContext.getFormAppContext();
            this.befRepository.restService.eventBus.post('Exception', '', 'onException', error, formAppContext);
            return EMPTY;
        })));
    }
    /**
     * 是否启用扩展取数方法
     * @private
     * @param {?} helpMetadataId
     * @return {?}
     */
    ifEnableExtendLoadMethod(helpMetadataId) {
        // 优先使用context里的设置
        if (this.context && this.context.hasOwnProperty('enableExtendLoadMethod')) {
            return this.context.enableExtendLoadMethod;
        }
        // context没有设置时，继续使用通过指令设置的开关
        /** @type {?} */
        let enableExtendLoadMethod = false;
        if (this.frameContext) {
            /** @type {?} */
            const befApiUrl = this.frameContext.repository.apiUri;
            /** @type {?} */
            const enableKey = `${helpMetadataId}@${befApiUrl}`;
            enableExtendLoadMethod = this.frameContext.getParam(enableKey);
        }
        return enableExtendLoadMethod;
    }
    /**
     * 老的帮助取树
     * @private
     * @param {?} labelId
     * @param {?} tableName
     * @param {?} data
     * @return {?}
     */
    getHelpData(labelId, tableName, data) {
        /** @type {?} */
        const url = `${this.befRepository.restService.baseUri}/elementhelps/${labelId}`;
        /** @type {?} */
        const update$ = this.befRepository.updateDataAndVariableChanges();
        /** @type {?} */
        const result$ = update$.pipe(switchMap((/**
         * @return {?}
         */
        () => {
            // tslint:disable-next-line: max-line-length
            return this.befRepository.restService.invoke(url, 'GET', { nodeCode: tableName, queryParam: JSON.stringify(data) }, null, false).pipe(catchError((/**
             * @param {?} error
             * @return {?}
             */
            error => {
                /** @type {?} */
                const formAppContext = this.befRepository.appContext.getFormAppContext();
                this.befRepository.restService.eventBus.post('Exception', '', 'onException', error, formAppContext);
                return EMPTY;
            })));
        })));
        return result$;
    }
    /**
     * 扩展的帮助取数
     * @private
     * @param {?} labelId
     * @param {?} tableName
     * @param {?} data
     * @return {?}
     */
    extendGetHelpData(labelId, tableName, data) {
        /** @type {?} */
        const url = `${this.befRepository.restService.baseUri}/extension/elementhelps`;
        /** @type {?} */
        const body = {
            labelId: labelId,
            nodeCode: tableName,
            queryParam: data,
            requestInfo: this.befRepository.restService.buildRequestInfo()
        };
        /** @type {?} */
        const options = {
            body: body
        };
        /** @type {?} */
        const result$ = this.befRepository.restService.invoke(url, 'PUT', null, options, false, true, true);
        return result$.pipe(map((/**
         * @param {?} responseInfo
         * @return {?}
         */
        (responseInfo) => {
            return responseInfo && responseInfo.returnValue || null;
        })), catchError((/**
         * @param {?} error
         * @return {?}
         */
        error => {
            /** @type {?} */
            const formAppContext = this.befRepository.appContext.getFormAppContext();
            this.befRepository.restService.eventBus.post('Exception', '', 'onException', error, formAppContext);
            return EMPTY;
        })));
    }
    /**
     * @private
     * @param {?} data
     * @param {?=} layer
     * @param {?=} parentPathCode
     * @return {?}
     */
    convert2TreeDataWithPathCode(data, layer = 1, parentPathCode = '01') {
        /** @type {?} */
        let nodes = data.filter((/**
         * @param {?} d
         * @return {?}
         */
        d => d.layer === layer && d.pathcode === parentPathCode));
        if (layer > 1) {
            nodes = data.filter((/**
             * @param {?} d
             * @return {?}
             */
            d => d.layer === layer && d.pathcode.substr(0, (layer - 1) * 2) === parentPathCode));
        }
        if (nodes.length) {
            /** @type {?} */
            const treeNodes = nodes.map((/**
             * @param {?} n
             * @return {?}
             */
            n => {
                return {
                    data: n,
                    children: []
                };
            }));
            treeNodes.forEach((/**
             * @param {?} tn
             * @return {?}
             */
            tn => {
                /** @type {?} */
                const _tns = this.convert2TreeDataWithPathCode(data, tn.data.layer + 1, tn.data.pathcode);
                tn.children.push(..._tns);
            }));
            return treeNodes;
        }
    }
}
BefLookupRestService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
BefLookupRestService.ctorParameters = () => [
    { type: Repository },
    { type: FrameContext, decorators: [{ type: Optional }] }
];
if (false) {
    /**
     * @type {?}
     * @private
     */
    BefLookupRestService.prototype.befRepository;
    /**
     * 帮助取数上下文
     * @type {?}
     */
    BefLookupRestService.prototype.context;
    /**
     * @type {?}
     * @private
     */
    BefLookupRestService.prototype.frameContext;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmVmX2xvb2t1cC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9iZWYvIiwic291cmNlcyI6WyJsaWIvYmVmX2xvb2t1cC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDckQsT0FBTyxFQUFFLEtBQUssRUFBYyxNQUFNLE1BQU0sQ0FBQztBQUN6QyxPQUFPLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBTyxVQUFVLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUVqRSxPQUFPLEVBQUUsVUFBVSxFQUFFLFlBQVksRUFBRSxNQUFNLGdCQUFnQixDQUFDOzs7O0FBUTFELE1BQU0sT0FBTyxvQkFBb0I7Ozs7OztJQVkvQixZQUNFLFVBQTJCLEVBQ1AsWUFBMEI7UUFBMUIsaUJBQVksR0FBWixZQUFZLENBQWM7UUFFOUMsSUFBSSxDQUFDLGFBQWEsR0FBRyxtQkFBb0IsVUFBVSxFQUFBLENBQUM7SUFDdEQsQ0FBQzs7Ozs7O0lBRU0sT0FBTyxDQUFDLGNBQXNCLEVBQUUsSUFBbUI7O2NBQ2xELFNBQVMsR0FBRyxjQUFjLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQzs7Y0FDeEMsT0FBTyxHQUFHLGNBQWMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzVDLElBQUksR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDOztjQUVaLHNCQUFzQixHQUFHLElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxjQUFjLENBQUM7UUFDNUUsSUFBSSxzQkFBc0IsS0FBSyxJQUFJLEVBQUU7WUFDbkMsT0FBTyxJQUFJLENBQUMsaUJBQWlCLENBQUMsT0FBTyxFQUFFLFNBQVMsRUFBRSxJQUFJLENBQUMsQ0FBQztTQUN6RDtRQUNELE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLEVBQUUsU0FBUyxFQUFF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QkFDekYsRUFBRSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQztZQUM1QixDQUFDLEVBQUMsQ0FBQztZQUVILE9BQU8sU0FBUyxDQUFDO1NBQ2xCO0lBQ0gsQ0FBQzs7O1lBL0lGLFVBQVU7Ozs7WUFQRixVQUFVO1lBQUUsWUFBWSx1QkFzQjVCLFFBQVE7Ozs7Ozs7SUFaWCw2Q0FBMEM7Ozs7O0lBSzFDLHVDQUFvQjs7Ozs7SUFPbEIsNENBQThDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgT3B0aW9uYWwgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgRU1QVFksIE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgc3dpdGNoTWFwLCBtYXAsIHRhcCwgY2F0Y2hFcnJvciB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuaW1wb3J0IHsgSUxvb2t1cEh0dHBTZXJ2aWNlLCBSZW1vdGVQYXJhbXMsIExvb2t1cEdyaWRSZXN1bHQgfSBmcm9tICdAZmFycmlzL3VpLWxvb2t1cCc7XHJcbmltcG9ydCB7IFJlcG9zaXRvcnksIEZyYW1lQ29udGV4dCB9IGZyb20gJ0BmYXJyaXMvZGV2a2l0JztcclxuaW1wb3J0IHsgQmVmUmVwb3NpdG9yeSB9IGZyb20gJy4vYmVmX3JlcG9zaXRvcnknO1xyXG5pbXBvcnQgeyBSZXNwb25zZUluZm8gfSBmcm9tICcuL3R5cGVzJztcclxuXHJcbi8qKlxyXG4gKiDluK7liqlSZXN05Y+W5pWw5pyN5YqhXHJcbiAqL1xyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBCZWZMb29rdXBSZXN0U2VydmljZSBpbXBsZW1lbnRzIElMb29rdXBIdHRwU2VydmljZSB7XHJcblxyXG4gIHByaXZhdGUgYmVmUmVwb3NpdG9yeTogQmVmUmVwb3NpdG9yeTxhbnk+O1xyXG5cclxuICAvKipcclxuICAgKiDluK7liqnlj5bmlbDkuIrkuIvmlodcclxuICAgKi9cclxuICBwdWJsaWMgY29udGV4dDogYW55O1xyXG5cclxuICAvKipcclxuICAgKiDmnoTpgKDlh73mlbBcclxuICAgKi9cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHJlcG9zaXRvcnk6IFJlcG9zaXRvcnk8YW55PixcclxuICAgIEBPcHRpb25hbCgpIHByaXZhdGUgZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHRcclxuICApIHtcclxuICAgIHRoaXMuYmVmUmVwb3NpdG9yeSA9IDxCZWZSZXBvc2l0b3J5PGFueT4+cmVwb3NpdG9yeTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBnZXREYXRhKGhlbHBNZXRhZGF0YUlkOiBzdHJpbmcsIGRhdGE/OiBSZW1vdGVQYXJhbXMpOiBPYnNlcnZhYmxlPExvb2t1cEdyaWRSZXN1bHQ+IHtcclxuICAgIGNvbnN0IHRhYmxlTmFtZSA9IGhlbHBNZXRhZGF0YUlkLnNwbGl0KCcuJylbMF07XHJcbiAgICBjb25zdCBsYWJlbElkID0gaGVscE1ldGFkYXRhSWQuc3BsaXQoJy4nKVsxXTtcclxuICAgIGRhdGEgPSBkYXRhIHx8IHt9O1xyXG5cclxuICAgIGNvbnN0IGVuYWJsZUV4dGVuZExvYWRNZXRob2QgPSB0aGlzLmlmRW5hYmxlRXh0ZW5kTG9hZE1ldGhvZChoZWxwTWV0YWRhdGFJZCk7XHJcbiAgICBpZiAoZW5hYmxlRXh0ZW5kTG9hZE1ldGhvZCA9PT0gdHJ1ZSkge1xyXG4gICAgICByZXR1cm4gdGhpcy5leHRlbmRHZXRIZWxwRGF0YShsYWJlbElkLCB0YWJsZU5hbWUsIGRhdGEpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHRoaXMuZ2V0SGVscERhdGEobGFiZWxJZCwgdGFibGVOYW1lLCBkYXRhKTtcclxuICB9XHJcbiAgcHVibGljIHNhdmVVc2VyU2V0dGluZ3MoZGF0YSkge1xyXG4gICAgY29uc3QgdXJsID0gJy9hcGkvcnVudGltZS9iY2MvdjEuMC9kYXRhZ3JpZC9zZXR0aW5ncyc7XHJcbiAgICByZXR1cm4gdGhpcy5iZWZSZXBvc2l0b3J5LnJlc3RTZXJ2aWNlLmludm9rZSh1cmwsICdQT1NUJywgbnVsbCwgeyBib2R5OiBkYXRhIH0sIGZhbHNlKS5waXBlKFxyXG4gICAgICBjYXRjaEVycm9yKGVycm9yID0+IHtcclxuICAgICAgICBjb25zdCBmb3JtQXBwQ29udGV4dCA9IHRoaXMuYmVmUmVwb3NpdG9yeS5hcHBDb250ZXh0LmdldEZvcm1BcHBDb250ZXh0KCk7XHJcbiAgICAgICAgdGhpcy5iZWZSZXBvc2l0b3J5LnJlc3RTZXJ2aWNlLmV2ZW50QnVzLnBvc3QoJ0V4Y2VwdGlvbicsICcnLCAnb25FeGNlcHRpb24nLCBlcnJvciwgZm9ybUFwcENvbnRleHQpO1xyXG4gICAgICAgIHJldHVybiBFTVBUWTtcclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgZ2V0VXNlclNldHRpbmdzKGtleSkge1xyXG4gICAgY29uc3QgdXJsID0gJy9hcGkvcnVudGltZS9iY2MvdjEuMC9kYXRhZ3JpZC9zZXR0aW5ncy8nICsga2V5O1xyXG4gICAgcmV0dXJuIHRoaXMuYmVmUmVwb3NpdG9yeS5yZXN0U2VydmljZS5pbnZva2UodXJsLCAnR0VUJywgbnVsbCwgbnVsbCwgZmFsc2UpLnBpcGUoXHJcbiAgICAgIGNhdGNoRXJyb3IoZXJyb3IgPT4ge1xyXG4gICAgICAgIGNvbnN0IGZvcm1BcHBDb250ZXh0ID0gdGhpcy5iZWZSZXBvc2l0b3J5LmFwcENvbnRleHQuZ2V0Rm9ybUFwcENvbnRleHQoKTtcclxuICAgICAgICB0aGlzLmJlZlJlcG9zaXRvcnkucmVzdFNlcnZpY2UuZXZlbnRCdXMucG9zdCgnRXhjZXB0aW9uJywgJycsICdvbkV4Y2VwdGlvbicsIGVycm9yLCBmb3JtQXBwQ29udGV4dCk7XHJcbiAgICAgICAgcmV0dXJuIEVNUFRZO1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOaYr+WQpuWQr+eUqOaJqeWxleWPluaVsOaWueazlVxyXG4gICAqL1xyXG4gIHByaXZhdGUgaWZFbmFibGVFeHRlbmRMb2FkTWV0aG9kKGhlbHBNZXRhZGF0YUlkOiBzdHJpbmcpIHtcclxuXHJcbiAgICAvLyDkvJjlhYjkvb/nlKhjb250ZXh06YeM55qE6K6+572uXHJcbiAgICBpZiAodGhpcy5jb250ZXh0ICYmIHRoaXMuY29udGV4dC5oYXNPd25Qcm9wZXJ0eSgnZW5hYmxlRXh0ZW5kTG9hZE1ldGhvZCcpKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLmNvbnRleHQuZW5hYmxlRXh0ZW5kTG9hZE1ldGhvZDtcclxuICAgIH1cclxuXHJcbiAgICAvLyBjb250ZXh05rKh5pyJ6K6+572u5pe277yM57un57ut5L2/55So6YCa6L+H5oyH5Luk6K6+572u55qE5byA5YWzXHJcbiAgICBsZXQgZW5hYmxlRXh0ZW5kTG9hZE1ldGhvZCA9IGZhbHNlO1xyXG4gICAgaWYgKHRoaXMuZnJhbWVDb250ZXh0KSB7XHJcbiAgICAgIGNvbnN0IGJlZkFwaVVybCA9IHRoaXMuZnJhbWVDb250ZXh0LnJlcG9zaXRvcnkuYXBpVXJpO1xyXG4gICAgICBjb25zdCBlbmFibGVLZXkgPSBgJHtoZWxwTWV0YWRhdGFJZH1AJHtiZWZBcGlVcmx9YDtcclxuICAgICAgZW5hYmxlRXh0ZW5kTG9hZE1ldGhvZCA9IHRoaXMuZnJhbWVDb250ZXh0LmdldFBhcmFtKGVuYWJsZUtleSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gZW5hYmxlRXh0ZW5kTG9hZE1ldGhvZDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiAgeeahOW4ruWKqeWPluagkVxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0SGVscERhdGEobGFiZWxJZDogc3RyaW5nLCB0YWJsZU5hbWU6IHN0cmluZywgZGF0YTogYW55KTogT2JzZXJ2YWJsZTxMb29rdXBHcmlkUmVzdWx0PiB7XHJcbiAgICBjb25zdCB1cmwgPSBgJHt0aGlzLmJlZlJlcG9zaXRvcnkucmVzdFNlcnZpY2UuYmFzZVVyaX0vZWxlbWVudGhlbHBzLyR7bGFiZWxJZH1gO1xyXG4gICAgY29uc3QgdXBkYXRlJCA9IHRoaXMuYmVmUmVwb3NpdG9yeS51cGRhdGVEYXRhQW5kVmFyaWFibGVDaGFuZ2VzKCk7XHJcbiAgICBjb25zdCByZXN1bHQkID0gdXBkYXRlJC5waXBlKFxyXG4gICAgICBzd2l0Y2hNYXAoKCkgPT4ge1xyXG4gICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogbWF4LWxpbmUtbGVuZ3RoXHJcbiAgICAgICAgcmV0dXJuIHRoaXMuYmVmUmVwb3NpdG9yeS5yZXN0U2VydmljZS5pbnZva2UodXJsLCAnR0VUJywgeyBub2RlQ29kZTogdGFibGVOYW1lLCBxdWVyeVBhcmFtOiBKU09OLnN0cmluZ2lmeShkYXRhKSB9LCBudWxsLCBmYWxzZSkucGlwZShcclxuICAgICAgICAgIGNhdGNoRXJyb3IoZXJyb3IgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBmb3JtQXBwQ29udGV4dCA9IHRoaXMuYmVmUmVwb3NpdG9yeS5hcHBDb250ZXh0LmdldEZvcm1BcHBDb250ZXh0KCk7XHJcbiAgICAgICAgICAgIHRoaXMuYmVmUmVwb3NpdG9yeS5yZXN0U2VydmljZS5ldmVudEJ1cy5wb3N0KCdFeGNlcHRpb24nLCAnJywgJ29uRXhjZXB0aW9uJywgZXJyb3IsIGZvcm1BcHBDb250ZXh0KTtcclxuICAgICAgICAgICAgcmV0dXJuIEVNUFRZO1xyXG4gICAgICAgICAgfSlcclxuICAgICAgICApO1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICAgIHJldHVybiByZXN1bHQkO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5omp5bGV55qE5biu5Yqp5Y+W5pWwXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBleHRlbmRHZXRIZWxwRGF0YShsYWJlbElkOiBzdHJpbmcsIHRhYmxlTmFtZTogc3RyaW5nLCBkYXRhOiBhbnkpOiBPYnNlcnZhYmxlPExvb2t1cEdyaWRSZXN1bHQ+IHtcclxuICAgIGNvbnN0IHVybCA9IGAke3RoaXMuYmVmUmVwb3NpdG9yeS5yZXN0U2VydmljZS5iYXNlVXJpfS9leHRlbnNpb24vZWxlbWVudGhlbHBzYDtcclxuICAgIGNvbnN0IGJvZHkgPSB7XHJcbiAgICAgIGxhYmVsSWQ6IGxhYmVsSWQsXHJcbiAgICAgIG5vZGVDb2RlOiB0YWJsZU5hbWUsXHJcbiAgICAgIHF1ZXJ5UGFyYW06IGRhdGEsXHJcbiAgICAgIHJlcXVlc3RJbmZvOiB0aGlzLmJlZlJlcG9zaXRvcnkucmVzdFNlcnZpY2UuYnVpbGRSZXF1ZXN0SW5mbygpXHJcbiAgICB9O1xyXG4gICAgY29uc3Qgb3B0aW9ucyA9IHtcclxuICAgICAgYm9keTogYm9keVxyXG4gICAgfTtcclxuXHJcbiAgICBjb25zdCByZXN1bHQkID0gdGhpcy5iZWZSZXBvc2l0b3J5LnJlc3RTZXJ2aWNlLmludm9rZSh1cmwsICdQVVQnLCBudWxsLCBvcHRpb25zLCBmYWxzZSwgdHJ1ZSwgdHJ1ZSk7XHJcbiAgICByZXR1cm4gcmVzdWx0JC5waXBlKFxyXG4gICAgICBtYXAoKHJlc3BvbnNlSW5mbzogUmVzcG9uc2VJbmZvKSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIHJlc3BvbnNlSW5mbyAmJiByZXNwb25zZUluZm8ucmV0dXJuVmFsdWUgfHwgbnVsbDtcclxuICAgICAgfSksXHJcbiAgICAgIGNhdGNoRXJyb3IoZXJyb3IgPT4ge1xyXG4gICAgICAgIGNvbnN0IGZvcm1BcHBDb250ZXh0ID0gdGhpcy5iZWZSZXBvc2l0b3J5LmFwcENvbnRleHQuZ2V0Rm9ybUFwcENvbnRleHQoKTtcclxuICAgICAgICB0aGlzLmJlZlJlcG9zaXRvcnkucmVzdFNlcnZpY2UuZXZlbnRCdXMucG9zdCgnRXhjZXB0aW9uJywgJycsICdvbkV4Y2VwdGlvbicsIGVycm9yLCBmb3JtQXBwQ29udGV4dCk7XHJcbiAgICAgICAgcmV0dXJuIEVNUFRZO1xyXG4gICAgICB9XHJcbiAgICAgICksXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBjb252ZXJ0MlRyZWVEYXRhV2l0aFBhdGhDb2RlKGRhdGE6IGFueVtdLCBsYXllciA9IDEsIHBhcmVudFBhdGhDb2RlID0gJzAxJykge1xyXG4gICAgbGV0IG5vZGVzID0gZGF0YS5maWx0ZXIoZCA9PiBkLmxheWVyID09PSBsYXllciAmJiBkLnBhdGhjb2RlID09PSBwYXJlbnRQYXRoQ29kZSk7XHJcbiAgICBpZiAobGF5ZXIgPiAxKSB7XHJcbiAgICAgIG5vZGVzID0gZGF0YS5maWx0ZXIoZCA9PiBkLmxheWVyID09PSBsYXllciAmJiBkLnBhdGhjb2RlLnN1YnN0cigwLCAobGF5ZXIgLSAxKSAqIDIpID09PSBwYXJlbnRQYXRoQ29kZSk7XHJcbiAgICB9XHJcbiAgICBpZiAobm9kZXMubGVuZ3RoKSB7XHJcbiAgICAgIGNvbnN0IHRyZWVOb2RlcyA9IG5vZGVzLm1hcChuID0+IHtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgZGF0YTogbixcclxuICAgICAgICAgIGNoaWxkcmVuOiBbXVxyXG4gICAgICAgIH07XHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgdHJlZU5vZGVzLmZvckVhY2godG4gPT4ge1xyXG4gICAgICAgIGNvbnN0IF90bnMgPSB0aGlzLmNvbnZlcnQyVHJlZURhdGFXaXRoUGF0aENvZGUoZGF0YSwgdG4uZGF0YS5sYXllciArIDEsIHRuLmRhdGEucGF0aGNvZGUpO1xyXG4gICAgICAgIHRuLmNoaWxkcmVuLnB1c2goLi4uX3Rucyk7XHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgcmV0dXJuIHRyZWVOb2RlcztcclxuICAgIH1cclxuICB9XHJcbn0iXX0=