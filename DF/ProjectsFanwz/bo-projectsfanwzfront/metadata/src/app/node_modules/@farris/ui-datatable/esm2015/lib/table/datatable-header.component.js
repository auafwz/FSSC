/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/*
 * @Author: 疯狂秀才(Lucas Huang)
 * @Date: 2019-04-08 16:51:39
 * @LastEditors: 疯狂秀才(Lucas Huang)
 * @LastEditTime: 2019-09-23 16:51:21
 * @QQ: 1055818239
 * @Version: v0.0.1
 */
import { Component, Input, EventEmitter, Output, ElementRef, Renderer2, ViewChild } from '@angular/core';
import { deepCopy, convertColumns } from '../datatable-column';
import { DataTableService } from '../datatable.service';
import { CommonUtils } from '@farris/ui-common';
import { DataTableComponent } from '../datatable.component';
import { DTCheckboxComponent } from '../datatable-checkbox.component';
export class DataTableHeaderComponent {
    /**
     * @param {?} el
     * @param {?} dataService
     * @param {?} render
     * @param {?} utils
     * @param {?} dt
     */
    constructor(el, dataService, render, utils, dt) {
        this.el = el;
        this.dataService = dataService;
        this.render = render;
        this.utils = utils;
        this.dt = dt;
        this.columns = [];
        this.singleSelect = true;
        this.checkedAll = new EventEmitter();
        this.rowsChange = new EventEmitter();
        this.loadData = new EventEmitter();
        this.sortType = {};
        this.filterFields = {};
        this.clickedUp = false;
        this.clickedDown = false;
        this.isCheckAll = false;
        this.allClass = ' ';
        this.width = '100%';
        this.allClass += this.el.nativeElement.classList.value;
        this.dataService.updateCheckAllStatus.subscribe((/**
         * @param {?} n
         * @return {?}
         */
        (n) => {
            if (n !== 2) {
                this.isCheckAll = n ? true : false;
                // this.checkallEl.elementRef.nativeElement.checked = this.isCheckAll;
            }
            else {
                this.isCheckAll = false;
                // this.checkallEl.elementRef.nativeElement.checked = false;
            }
        }));
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        if (this.fixed === 'left') {
            this.columns = convertColumns(this.columns, 'left');
        }
        if (this.fixed === 'right') {
            this.columns = convertColumns(this.columns, 'right');
        }
    }
    /**
     * @return {?}
     */
    ngAfterViewInit() { }
    /**
     * @param {?} $event
     * @return {?}
     */
    onCheckedChange($event) {
        this.isCheckAll = $event.checked;
        this.checkedAll.emit($event.checked);
    }
    /**
     * @param {?} row
     * @param {?} index
     * @return {?}
     */
    createRowClassName(row, index) {
        return this.rowClassName ? this.rowClassName(row, index) : '';
    }
    /**
     * @private
     * @param {?} a
     * @param {?} b
     * @return {?}
     */
    compare(a, b) {
        if (typeof a === 'string') {
            return a.localeCompare(b);
        }
        else {
            return a === b ? 0 : (a > b ? 1 : -1);
        }
    }
    /**
     * @private
     * @param {?} r1
     * @param {?} r2
     * @return {?}
     */
    _sort(r1, r2) {
        /** @type {?} */
        let r = 0;
        /** @type {?} */
        const sortFields = this.dt.sortName.split(',');
        /** @type {?} */
        const orders = this.dt.sortOrder.split(',');
        if (!this.dt.sortName) {
            return r;
        }
        for (let i = 0; i < sortFields.length; i++) {
            /** @type {?} */
            const sn = sortFields[i];
            /** @type {?} */
            const so = orders[i];
            /** @type {?} */
            const col = this.columns.find((/**
             * @param {?} c
             * @return {?}
             */
            c => c.field === sn));
            /** @type {?} */
            const orderby = col['sorter'] || this.compare;
            /** @type {?} */
            let v1 = this.utils.getValue(sn, r1);
            if (v1 === null || v1 === undefined) {
                v1 = '';
            }
            /** @type {?} */
            let v2 = this.utils.getValue(sn, r2);
            if (v2 === null || v2 === undefined) {
                v2 = '';
            }
            r = orderby(v1, v2);
            if (r !== 0) {
                return r * (so === 'asc' ? 1 : -1);
            }
        }
        return r;
    }
    /**
     * @private
     * @return {?}
     */
    clientSort() {
        /** @type {?} */
        const sortedData = this.data.sort(this._sort.bind(this));
        this.loadData.emit(sortedData);
    }
    /**
     * @param {?} $event
     * @param {?} col
     * @return {?}
     */
    onSortColumnClick($event, col) {
        if (!col.sortable) {
            return;
        }
        /** @type {?} */
        const sortName = this.dt.sortName;
        /** @type {?} */
        const sortOrder = this.dt.sortOrder;
        /** @type {?} */
        let sortFields = [];
        /** @type {?} */
        let sortOrders = [];
        if (sortName) {
            sortFields = sortName.split(',');
            sortOrders = sortOrder.split(',');
        }
        /** @type {?} */
        const colOrder = col.order || 'asc';
        /** @type {?} */
        let newOrder = colOrder;
        /** @type {?} */
        const i = sortFields.findIndex((/**
         * @param {?} n
         * @return {?}
         */
        n => n === col.field));
        if (i >= 0) {
            /** @type {?} */
            const _order = sortOrders[i] === 'asc' ? 'desc' : 'asc';
            newOrder = _order;
            if (this.dt.multiSort && newOrder === 'asc') {
                newOrder = undefined;
                sortFields.splice(i, 1);
                sortOrders.splice(i, 1);
                if (sortFields.length === 0) {
                    sortFields.push(col.field);
                    sortOrders.push('asc');
                    newOrder = 'asc';
                }
            }
            else {
                sortOrders[i] = _order;
            }
        }
        else {
            if (this.dt.multiSort) {
                sortFields.push(col.field);
                sortOrders.push(colOrder);
            }
            else {
                sortFields = [col.field];
                sortOrders = [colOrder];
            }
        }
        col.order = newOrder;
        this.dt.sortName = sortFields.join(',');
        this.dt.sortOrder = sortOrders.join(',');
        // this.dfs.setSortInfo(this.dg.sortName, this.dg.sortOrder);
        if (!this.dt.multiSort) {
            /** @type {?} */
            const updateFieldOrder = (/**
             * @param {?} cols
             * @return {?}
             */
            (cols) => {
                if (!cols || !cols.length) {
                    return;
                }
                cols.forEach((/**
                 * @param {?} c
                 * @return {?}
                 */
                c => {
                    c.order = undefined;
                    /** @type {?} */
                    const k = sortFields.findIndex((/**
                     * @param {?} f
                     * @return {?}
                     */
                    f => f === c.field));
                    if (k >= 0) {
                        c.order = sortOrders[k];
                    }
                }));
            });
            updateFieldOrder(this.columns);
            // this.cdRef.detectChanges();
        }
        this.dt.beforeSortColumn(this.dt.sortName, this.dt.sortOrder).subscribe((/**
         * @return {?}
         */
        () => {
            if (this.dt.remoteSort) {
                // this.reload();
            }
            else {
                this.clientSort();
            }
            this.dt.columnSorted.emit({ sortName: this.dt.sortName, sortOrder: this.dt.sortOrder });
        }));
    }
    /**
     * @return {?}
     */
    deepCopyData() {
        /** @type {?} */
        const copyColumns = deepCopy(this.columns);
        /** @type {?} */
        const copyRows = deepCopy(this.rows);
        copyColumns.forEach((/**
         * @param {?} element
         * @return {?}
         */
        element => {
            element.sortType = 'normal';
        }));
        return {
            copyColumns,
            copyRows
        };
    }
    /* 若存在筛选条件 保存按钮可点击
         */
    /**
     * @param {?} col
     * @return {?}
     */
    hasChecked(col) {
        if (this.filterFields.hasOwnProperty(col.field)) {
            this.filterFields[col.field].some((/**
             * @param {?} ele
             * @return {?}
             */
            ele => {
                return ele.checked;
            }));
        }
        return false;
    }
}
DataTableHeaderComponent.decorators = [
    { type: Component, args: [{
                selector: 'datatable-header',
                template: `
        <table class="table" [class.table-sm]="size === 'small'">
            <colgroup>
                <col class="dt-checkbox-cell" *ngIf="!singleSelect" />
                <col *ngFor="let col of columns" [style.width]="col.width + 'px'" />
            </colgroup>
            <thead>
                <tr>
                    <th drag-column class="dt-checkbox-cell" *ngIf="!singleSelect">
                        <dt-checkbox #checkall [checked]="isCheckAll" (checkedChange)="onCheckedChange($event)"></dt-checkbox>
                    </th>
                    <th drag-column *ngFor="let col of columns; let i = index" [style.textAlign]="col.hAlign || 'left'">
                        <span>{{ col.title }}</span>
                        <ng-container *ngIf="col.sortable">
                            <span
                                class="f-datatable-sort"
                                [class.f-datatable-sort-asc]="col.order === 'asc'"
                                [class.f-datatable-sort-desc]="col.order === 'desc'"
                                (click)="onSortColumnClick($event, col)"
                                *ngIf="col.order"
                                >
                            </span>
                            <span class="f-datatable-sort" (click)="onSortColumnClick($event, col)" *ngIf="!col.order">
                            </span>
                        </ng-container>
                    </th>
                </tr>
            </thead>
        </table>
    `,
                styles: ["th>div{display:inline-block;float:right;width:20%;height:0;margin-right:5%}th>div>span.sort-container{position:relative;display:inline-block;width:100%;height:1rem}th span.farris-icon{position:absolute;left:0;opacity:.5;cursor:pointer}th span.k-i-arrow-60-up{top:0}th span.k-i-arrow-60-down{top:.5em}th span.k-i-filter{top:-.5rem}th span.clicked,th span.k-i-filter:hover{opacity:1}.farris-table-header{overflow:auto}"]
            }] }
];
/** @nocollapse */
DataTableHeaderComponent.ctorParameters = () => [
    { type: ElementRef },
    { type: DataTableService },
    { type: Renderer2 },
    { type: CommonUtils },
    { type: DataTableComponent }
];
DataTableHeaderComponent.propDecorators = {
    size: [{ type: Input }],
    hover: [{ type: Input }],
    columns: [{ type: Input }],
    singleSelect: [{ type: Input }],
    fixed: [{ type: Input }],
    rows: [{ type: Input }],
    data: [{ type: Input }],
    rowClassName: [{ type: Input }],
    checkedAll: [{ type: Output }],
    rowsChange: [{ type: Output }],
    loadData: [{ type: Output }],
    checkallEl: [{ type: ViewChild, args: ['checkall',] }]
};
if (false) {
    /** @type {?} */
    DataTableHeaderComponent.prototype.size;
    /** @type {?} */
    DataTableHeaderComponent.prototype.hover;
    /** @type {?} */
    DataTableHeaderComponent.prototype.columns;
    /** @type {?} */
    DataTableHeaderComponent.prototype.singleSelect;
    /** @type {?} */
    DataTableHeaderComponent.prototype.fixed;
    /** @type {?} */
    DataTableHeaderComponent.prototype.rows;
    /** @type {?} */
    DataTableHeaderComponent.prototype.data;
    /** @type {?} */
    DataTableHeaderComponent.prototype.rowClassName;
    /** @type {?} */
    DataTableHeaderComponent.prototype.checkedAll;
    /** @type {?} */
    DataTableHeaderComponent.prototype.rowsChange;
    /** @type {?} */
    DataTableHeaderComponent.prototype.loadData;
    /** @type {?} */
    DataTableHeaderComponent.prototype.checkallEl;
    /** @type {?} */
    DataTableHeaderComponent.prototype.sortType;
    /** @type {?} */
    DataTableHeaderComponent.prototype.filterFields;
    /** @type {?} */
    DataTableHeaderComponent.prototype.clickedUp;
    /** @type {?} */
    DataTableHeaderComponent.prototype.clickedDown;
    /** @type {?} */
    DataTableHeaderComponent.prototype.copyColumns;
    /** @type {?} */
    DataTableHeaderComponent.prototype.copyRows;
    /** @type {?} */
    DataTableHeaderComponent.prototype.originRows;
    /** @type {?} */
    DataTableHeaderComponent.prototype.isCheckAll;
    /** @type {?} */
    DataTableHeaderComponent.prototype.allClass;
    /** @type {?} */
    DataTableHeaderComponent.prototype.width;
    /** @type {?} */
    DataTableHeaderComponent.prototype.el;
    /**
     * @type {?}
     * @private
     */
    DataTableHeaderComponent.prototype.dataService;
    /**
     * @type {?}
     * @private
     */
    DataTableHeaderComponent.prototype.render;
    /** @type {?} */
    DataTableHeaderComponent.prototype.utils;
    /**
     * @type {?}
     * @private
     */
    DataTableHeaderComponent.prototype.dt;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YXRhYmxlLWhlYWRlci5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL3VpLWRhdGF0YWJsZS8iLCJzb3VyY2VzIjpbImxpYi90YWJsZS9kYXRhdGFibGUtaGVhZGVyLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7QUFRQSxPQUFPLEVBQUUsU0FBUyxFQUFVLEtBQUssRUFBRSxZQUFZLEVBQWlCLE1BQU0sRUFBRSxVQUFVLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNoSSxPQUFPLEVBQUUsUUFBUSxFQUFFLGNBQWMsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQy9ELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBRXhELE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNoRCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUM1RCxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQztBQW9DdEUsTUFBTSxPQUFPLHdCQUF3Qjs7Ozs7Ozs7SUE2QmpDLFlBQ1csRUFBYyxFQUNiLFdBQTZCLEVBQzdCLE1BQWlCLEVBQ2xCLEtBQWtCLEVBQ2pCLEVBQXNCO1FBSnZCLE9BQUUsR0FBRixFQUFFLENBQVk7UUFDYixnQkFBVyxHQUFYLFdBQVcsQ0FBa0I7UUFDN0IsV0FBTSxHQUFOLE1BQU0sQ0FBVztRQUNsQixVQUFLLEdBQUwsS0FBSyxDQUFhO1FBQ2pCLE9BQUUsR0FBRixFQUFFLENBQW9CO1FBL0J6QixZQUFPLEdBQWlCLEVBQUUsQ0FBQztRQUMzQixpQkFBWSxHQUFHLElBQUksQ0FBQztRQVFuQixlQUFVLEdBQUcsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUVoQyxlQUFVLEdBQUcsSUFBSSxZQUFZLEVBQU8sQ0FBQztRQUNyQyxhQUFRLEdBQUcsSUFBSSxZQUFZLEVBQXFF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cmNlc0NvbnRlbnQiOlsiLypcclxuICogQEF1dGhvcjog55av54uC56eA5omNKEx1Y2FzIEh1YW5nKVxyXG4gKiBARGF0ZTogMjAxOS0wNC0wOCAxNjo1MTozOVxyXG4gKiBATGFzdEVkaXRvcnM6IOeWr+eLguengOaJjShMdWNhcyBIdWFuZylcclxuICogQExhc3RFZGl0VGltZTogMjAxOS0wOS0yMyAxNjo1MToyMVxyXG4gKiBAUVE6IDEwNTU4MTgyMzlcclxuICogQFZlcnNpb246IHYwLjAuMVxyXG4gKi9cclxuaW1wb3J0IHsgQ29tcG9uZW50LCBPbkluaXQsIElucHV0LCBFdmVudEVtaXR0ZXIsIEFmdGVyVmlld0luaXQsIE91dHB1dCwgRWxlbWVudFJlZiwgUmVuZGVyZXIyLCBWaWV3Q2hpbGQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgZGVlcENvcHksIGNvbnZlcnRDb2x1bW5zIH0gZnJvbSAnLi4vZGF0YXRhYmxlLWNvbHVtbic7XHJcbmltcG9ydCB7IERhdGFUYWJsZVNlcnZpY2UgfSBmcm9tICcuLi9kYXRhdGFibGUuc2VydmljZSc7XHJcbmltcG9ydCB7IERhdGFDb2x1bW4gfSBmcm9tICdAZmFycmlzL3VpLWNvbW1vbi9jb2x1bW4nO1xyXG5pbXBvcnQgeyBDb21tb25VdGlscyB9IGZyb20gJ0BmYXJyaXMvdWktY29tbW9uJztcclxuaW1wb3J0IHsgRGF0YVRhYmxlQ29tcG9uZW50IH0gZnJvbSAnLi4vZGF0YXRhYmxlLmNvbXBvbmVudCc7XHJcbmltcG9ydCB7IERUQ2hlY2tib3hDb21wb25lbnQgfSBmcm9tICcuLi9kYXRhdGFibGUtY2hlY2tib3guY29tcG9uZW50JztcclxuXHJcbkBDb21wb25lbnQoe1xyXG4gICAgc2VsZWN0b3I6ICdkYXRhdGFibGUtaGVhZGVyJyxcclxuICAgIHRlbXBsYXRlOiBgXHJcbiAgICAgICAgPHRhYmxlIGNsYXNzPVwidGFibGVcIiBbY2xhc3MudGFibGUtc21dPVwic2l6ZSA9PT0gJ3NtYWxsJ1wiPlxyXG4gICAgICAgICAgICA8Y29sZ3JvdXA+XHJcbiAgICAgICAgICAgICAgICA8Y29sIGNsYXNzPVwiZHQtY2hlY2tib3gtY2VsbFwiICpuZ0lmPVwiIXNpbmdsZVNlbGVjdFwiIC8+XHJcbiAgICAgICAgICAgICAgICA8Y29sICpuZ0Zvcj1cImxldCBjb2wgb2YgY29sdW1uc1wiIFtzdHlsZS53aWR0aF09XCJjb2wud2lkdGggKyAncHgnXCIgLz5cclxuICAgICAgICAgICAgPC9jb2xncm91cD5cclxuICAgICAgICAgICAgPHRoZWFkPlxyXG4gICAgICAgICAgICAgICAgPHRyPlxyXG4gICAgICAgICAgICAgICAgICAgIDx0aCBkcmFnLWNvbHVtbiBjbGFzcz1cImR0LWNoZWNrYm94LWNlbGxcIiAqbmdJZj1cIiFzaW5nbGVTZWxlY3RcIj5cclxuICAgICAgICAgICAgICAgICAgICAgICAgPGR0LWNoZWNrYm94ICNjaGVja2FsbCBbY2hlY2tlZF09XCJpc0NoZWNrQWxsXCIgKGNoZWNrZWRDaGFuZ2UpPVwib25DaGVja2VkQ2hhbmdlKCRldmVudClcIj48L2R0LWNoZWNrYm94PlxyXG4gICAgICAgICAgICAgICAgICAgIDwvdGg+XHJcbiAgICAgICAgICAgICAgICAgICAgPHRoIGRyYWctY29sdW1uICpuZ0Zvcj1cImxldCBjb2wgb2YgY29sdW1uczsgbGV0IGkgPSBpbmRleFwiIFtzdHlsZS50ZXh0QWxpZ25dPVwiY29sLmhBbGlnbiB8fCAnbGVmdCdcIj5cclxuICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4+e3sgY29sLnRpdGxlIH19PC9zcGFuPlxyXG4gICAgICAgICAgICAgICAgICAgICAgICA8bmctY29udGFpbmVyICpuZ0lmPVwiY29sLnNvcnRhYmxlXCI+XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzPVwiZi1kYXRhdGFibGUtc29ydFwiXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgW2NsYXNzLmYtZGF0YXRhYmxlLXNvcnQtYXNjXT1cImNvbC5vcmRlciA9PT0gJ2FzYydcIlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFtjbGFzcy5mLWRhdGF0YWJsZS1zb3J0LWRlc2NdPVwiY29sLm9yZGVyID09PSAnZGVzYydcIlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChjbGljayk9XCJvblNvcnRDb2x1bW5DbGljaygkZXZlbnQsIGNvbClcIlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICpuZ0lmPVwiY29sLm9yZGVyXCJcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA+XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L3NwYW4+XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz1cImYtZGF0YXRhYmxlLXNvcnRcIiAoY2xpY2spPVwib25Tb3J0Q29sdW1uQ2xpY2soJGV2ZW50LCBjb2wpXCIgKm5nSWY9XCIhY29sLm9yZGVyXCI+XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L3NwYW4+XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIDwvbmctY29udGFpbmVyPlxyXG4gICAgICAgICAgICAgICAgICAgIDwvdGg+XHJcbiAgICAgICAgICAgICAgICA8L3RyPlxyXG4gICAgICAgICAgICA8L3RoZWFkPlxyXG4gICAgICAgIDwvdGFibGU+XHJcbiAgICBgLFxyXG4gICAgc3R5bGVVcmxzOiBbJy4vZGF0YXRhYmxlLWhlYWRlci5jb21wb25lbnQuc2NzcyddXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBEYXRhVGFibGVIZWFkZXJDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIEFmdGVyVmlld0luaXQge1xyXG4gICAgQElucHV0KCkgc2l6ZTogc3RyaW5nO1xyXG4gICAgQElucHV0KCkgaG92ZXI6IGJvb2xlYW47XHJcbiAgICBASW5wdXQoKSBjb2x1bW5zOiBEYXRhQ29sdW1uW10gPSBbXTtcclxuICAgIEBJbnB1dCgpIHNpbmdsZVNlbGVjdCA9IHRydWU7XHJcbiAgICBASW5wdXQoKSBmaXhlZDogc3RyaW5nO1xyXG4gICAgLy8g5pWw5o2u5o6S5bqP5L2/55SoXHJcbiAgICBASW5wdXQoKSByb3dzOiBhbnk7XHJcblxyXG4gICAgLy8g5oGi5aSN5rqQ5pWw5o2u5L2/55SoXHJcbiAgICBASW5wdXQoKSBkYXRhOiBhbnk7XHJcbiAgICBASW5wdXQoKSByb3dDbGFzc05hbWU6IChyb3c6IGFueSwgaW5kZXg6IG51bWJlcikgPT4gc3RyaW5nO1xyXG4gICAgQE91dHB1dCgpIGNoZWNrZWRBbGwgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XHJcblxyXG4gICAgQE91dHB1dCgpIHJvd3NDaGFuZ2UgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcclxuICAgIEBPdXRwdXQoKSBsb2FkRGF0YSA9IG5ldyBFdmVudEVtaXR0ZXI8eyBwYWdlU2l6ZTogbnVtYmVyOyB0b3RhbDogbnVtYmVyOyBkYXRhOiBhbnk7IHBhZ2VJbmRleDogbnVtYmVyIH0+KCk7XHJcblxyXG5cclxuICAgIEBWaWV3Q2hpbGQoJ2NoZWNrYWxsJykgY2hlY2thbGxFbDogRFRDaGVja2JveENvbXBvbmVudDtcclxuXHJcbiAgICBzb3J0VHlwZSA9IHt9O1xyXG4gICAgZmlsdGVyRmllbGRzID0ge307XHJcbiAgICBjbGlja2VkVXAgPSBmYWxzZTtcclxuICAgIGNsaWNrZWREb3duID0gZmFsc2U7XHJcbiAgICBjb3B5Q29sdW1uczogYW55O1xyXG4gICAgY29weVJvd3M6IGFueTtcclxuICAgIG9yaWdpblJvd3M6IGFueTtcclxuICAgIGlzQ2hlY2tBbGwgPSBmYWxzZTtcclxuICAgIGFsbENsYXNzID0gJyAnO1xyXG4gICAgY29uc3RydWN0b3IoXHJcbiAgICAgICAgcHVibGljIGVsOiBFbGVtZW50UmVmLFxyXG4gICAgICAgIHByaXZhdGUgZGF0YVNlcnZpY2U6IERhdGFUYWJsZVNlcnZpY2UsXHJcbiAgICAgICAgcHJpdmF0ZSByZW5kZXI6IFJlbmRlcmVyMixcclxuICAgICAgICBwdWJsaWMgdXRpbHM6IENvbW1vblV0aWxzLFxyXG4gICAgICAgIHByaXZhdGUgZHQ6IERhdGFUYWJsZUNvbXBvbmVudFxyXG4gICAgKSB7XHJcbiAgICAgICAgdGhpcy5hbGxDbGFzcyArPSB0aGlzLmVsLm5hdGl2ZUVsZW1lbnQuY2xhc3NMaXN0LnZhbHVlO1xyXG5cclxuXHJcbiAgICAgICAgdGhpcy5kYXRhU2VydmljZS51cGRhdGVDaGVja0FsbFN0YXR1cy5zdWJzY3JpYmUoIChuOiBudW1iZXIpID0+IHtcclxuICAgICAgICAgICAgaWYgKG4gIT09IDIpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuaXNDaGVja0FsbCA9IG4gPyB0cnVlIDogZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAvLyB0aGlzLmNoZWNrYWxsRWwuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LmNoZWNrZWQgPSB0aGlzLmlzQ2hlY2tBbGw7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmlzQ2hlY2tBbGwgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgIC8vIHRoaXMuY2hlY2thbGxFbC5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQuY2hlY2tlZCA9IGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICB3aWR0aCA9ICcxMDAlJztcclxuICAgIG5nT25Jbml0KCkge1xyXG4gICAgICAgIGlmICh0aGlzLmZpeGVkID09PSAnbGVmdCcpIHtcclxuICAgICAgICAgICAgdGhpcy5jb2x1bW5zID0gY29udmVydENvbHVtbnModGhpcy5jb2x1bW5zLCAnbGVmdCcpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodGhpcy5maXhlZCA9PT0gJ3JpZ2h0Jykge1xyXG4gICAgICAgICAgICB0aGlzLmNvbHVtbnMgPSBjb252ZXJ0Q29sdW1ucyh0aGlzLmNvbHVtbnMsICdyaWdodCcpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIG5nQWZ0ZXJWaWV3SW5pdCgpIHt9XHJcblxyXG4gICAgb25DaGVja2VkQ2hhbmdlKCRldmVudCkge1xyXG4gICAgICAgIHRoaXMuaXNDaGVja0FsbCA9ICRldmVudC5jaGVja2VkO1xyXG4gICAgICAgIHRoaXMuY2hlY2tlZEFsbC5lbWl0KCRldmVudC5jaGVja2VkKTtcclxuICAgIH1cclxuICAgIGNyZWF0ZVJvd0NsYXNzTmFtZShyb3csIGluZGV4KSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMucm93Q2xhc3NOYW1lID8gdGhpcy5yb3dDbGFzc05hbWUocm93LCBpbmRleCkgOiAnJztcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGNvbXBhcmUoYSwgYikge1xyXG4gICAgICAgIGlmICh0eXBlb2YgYSAgPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBhLmxvY2FsZUNvbXBhcmUoYik7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuIGEgPT09IGIgPyAwIDogKGEgPiBiID8gMSA6IC0xKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBwcml2YXRlIF9zb3J0KHIxLCByMikge1xyXG4gICAgICAgIGxldCByID0gMDtcclxuICAgICAgICBjb25zdCBzb3J0RmllbGRzID0gdGhpcy5kdC5zb3J0TmFtZS5zcGxpdCgnLCcpO1xyXG4gICAgICAgIGNvbnN0IG9yZGVycyA9IHRoaXMuZHQuc29ydE9yZGVyLnNwbGl0KCcsJyk7XHJcblxyXG4gICAgICAgIGlmICghdGhpcy5kdC5zb3J0TmFtZSkge1xyXG4gICAgICAgICAgICByZXR1cm4gcjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc29ydEZpZWxkcy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICBjb25zdCBzbiA9IHNvcnRGaWVsZHNbaV07XHJcbiAgICAgICAgICAgIGNvbnN0IHNvID0gb3JkZXJzW2ldO1xyXG5cclxuICAgICAgICAgICAgY29uc3QgY29sID0gdGhpcy5jb2x1bW5zLmZpbmQoYyA9PiBjLmZpZWxkID09PSBzbik7XHJcblxyXG4gICAgICAgICAgICBjb25zdCBvcmRlcmJ5ID0gY29sWydzb3J0ZXInXSB8fCB0aGlzLmNvbXBhcmU7XHJcbiAgICAgICAgICAgIGxldCB2MSA9IHRoaXMudXRpbHMuZ2V0VmFsdWUoc24sIHIxKTtcclxuICAgICAgICAgICAgaWYgKHYxID09PSBudWxsIHx8IHYxID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgIHYxID0gJyc7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgbGV0IHYyID0gdGhpcy51dGlscy5nZXRWYWx1ZShzbiwgcjIpO1xyXG4gICAgICAgICAgICBpZiAodjIgPT09IG51bGwgfHwgdjIgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgdjIgPSAnJztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByID0gb3JkZXJieSh2MSwgdjIpO1xyXG4gICAgICAgICAgICBpZiAociAhPT0gMCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHIgKiAoc28gPT09ICdhc2MnID8gMSA6IC0xKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gcjtcclxuICAgIH1cclxuICAgIHByaXZhdGUgY2xpZW50U29ydCgpIHtcclxuICAgICAgICBjb25zdCBzb3J0ZWREYXRhID0gdGhpcy5kYXRhLnNvcnQodGhpcy5fc29ydC5iaW5kKHRoaXMpKTtcclxuICAgICAgICB0aGlzLmxvYWREYXRhLmVtaXQoc29ydGVkRGF0YSk7XHJcbiAgICB9XHJcblxyXG4gICAgb25Tb3J0Q29sdW1uQ2xpY2soJGV2ZW50LCBjb2wpIHtcclxuICAgICAgICBpZiAoIWNvbC5zb3J0YWJsZSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IHNvcnROYW1lID0gdGhpcy5kdC5zb3J0TmFtZTtcclxuICAgICAgICBjb25zdCBzb3J0T3JkZXIgPSB0aGlzLmR0LnNvcnRPcmRlcjtcclxuICAgICAgICBsZXQgc29ydEZpZWxkcyA9IFtdO1xyXG4gICAgICAgIGxldCBzb3J0T3JkZXJzID0gW107XHJcbiAgICAgICAgaWYgKHNvcnROYW1lKSB7XHJcbiAgICAgICAgICAgIHNvcnRGaWVsZHMgPSBzb3J0TmFtZS5zcGxpdCgnLCcpO1xyXG4gICAgICAgICAgICBzb3J0T3JkZXJzID0gc29ydE9yZGVyLnNwbGl0KCcsJyk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBjb2xPcmRlciA9IGNvbC5vcmRlciB8fCAnYXNjJztcclxuICAgICAgICBsZXQgbmV3T3JkZXIgPSBjb2xPcmRlcjtcclxuICAgICAgICBjb25zdCBpID0gc29ydEZpZWxkcy5maW5kSW5kZXgobiA9PiBuID09PSBjb2wuZmllbGQpO1xyXG4gICAgICAgIGlmIChpID49IDApIHtcclxuICAgICAgICAgICAgY29uc3QgX29yZGVyID0gc29ydE9yZGVyc1tpXSA9PT0gJ2FzYycgPyAnZGVzYycgOiAnYXNjJztcclxuICAgICAgICAgICAgbmV3T3JkZXIgPSBfb3JkZXI7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmR0Lm11bHRpU29ydCAmJiBuZXdPcmRlciA9PT0gJ2FzYycpIHtcclxuICAgICAgICAgICAgICAgIG5ld09yZGVyID0gdW5kZWZpbmVkO1xyXG4gICAgICAgICAgICAgICAgc29ydEZpZWxkcy5zcGxpY2UoaSwgMSk7XHJcbiAgICAgICAgICAgICAgICBzb3J0T3JkZXJzLnNwbGljZShpLCAxKTtcclxuICAgICAgICAgICAgICAgIGlmIChzb3J0RmllbGRzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHNvcnRGaWVsZHMucHVzaChjb2wuZmllbGQpO1xyXG4gICAgICAgICAgICAgICAgICAgIHNvcnRPcmRlcnMucHVzaCgnYXNjJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgbmV3T3JkZXIgPSAnYXNjJztcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHNvcnRPcmRlcnNbaV0gPSBfb3JkZXI7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5kdC5tdWx0aVNvcnQpIHtcclxuICAgICAgICAgICAgICAgIHNvcnRGaWVsZHMucHVzaChjb2wuZmllbGQpO1xyXG4gICAgICAgICAgICAgICAgc29ydE9yZGVycy5wdXNoKGNvbE9yZGVyKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHNvcnRGaWVsZHMgPSBbY29sLmZpZWxkXTtcclxuICAgICAgICAgICAgICAgIHNvcnRPcmRlcnMgPSBbY29sT3JkZXJdO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb2wub3JkZXIgPSBuZXdPcmRlcjtcclxuXHJcbiAgICAgICAgdGhpcy5kdC5zb3J0TmFtZSA9IHNvcnRGaWVsZHMuam9pbignLCcpO1xyXG4gICAgICAgIHRoaXMuZHQuc29ydE9yZGVyID0gc29ydE9yZGVycy5qb2luKCcsJyk7XHJcbiAgICAgICAgLy8gdGhpcy5kZnMuc2V0U29ydEluZm8odGhpcy5kZy5zb3J0TmFtZSwgdGhpcy5kZy5zb3J0T3JkZXIpO1xyXG5cclxuICAgICAgICBpZiAoIXRoaXMuZHQubXVsdGlTb3J0KSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHVwZGF0ZUZpZWxkT3JkZXIgPSAoY29sczogRGF0YUNvbHVtbltdKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIWNvbHMgfHwgIWNvbHMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgY29scy5mb3JFYWNoKGMgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGMub3JkZXIgPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgayA9IHNvcnRGaWVsZHMuZmluZEluZGV4KGYgPT4gZiA9PT0gYy5maWVsZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGsgPj0gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjLm9yZGVyID0gc29ydE9yZGVyc1trXTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgIHVwZGF0ZUZpZWxkT3JkZXIodGhpcy5jb2x1bW5zKTtcclxuICAgICAgICAgICAgLy8gdGhpcy5jZFJlZi5kZXRlY3RDaGFuZ2VzKCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLmR0LmJlZm9yZVNvcnRDb2x1bW4odGhpcy5kdC5zb3J0TmFtZSwgdGhpcy5kdC5zb3J0T3JkZXIpLnN1YnNjcmliZSgoKSA9PiB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmR0LnJlbW90ZVNvcnQpIHtcclxuICAgICAgICAgICAgICAgIC8vIHRoaXMucmVsb2FkKCk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmNsaWVudFNvcnQoKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgdGhpcy5kdC5jb2x1bW5Tb3J0ZWQuZW1pdCh7IHNvcnROYW1lOiB0aGlzLmR0LnNvcnROYW1lLCBzb3J0T3JkZXI6IHRoaXMuZHQuc29ydE9yZGVyIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGRlZXBDb3B5RGF0YSgpIHtcclxuICAgICAgICBjb25zdCBjb3B5Q29sdW1ucyA9IGRlZXBDb3B5KHRoaXMuY29sdW1ucyk7XHJcbiAgICAgICAgY29uc3QgY29weVJvd3MgPSBkZWVwQ29weSh0aGlzLnJvd3MpO1xyXG4gICAgICAgIGNvcHlDb2x1bW5zLmZvckVhY2goZWxlbWVudCA9PiB7XHJcbiAgICAgICAgICAgIGVsZW1lbnQuc29ydFR5cGUgPSAnbm9ybWFsJztcclxuICAgICAgICB9KTtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBjb3B5Q29sdW1ucyxcclxuICAgICAgICAgICAgY29weVJvd3NcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG4gICAgLyog6Iul5a2Y5Zyo562b6YCJ5p2h5Lu2IOS/neWtmOaMiemSruWPr+eCueWHu1xyXG4gICAgICovXHJcbiAgICBoYXNDaGVja2VkKGNvbCkge1xyXG4gICAgICAgIGlmICh0aGlzLmZpbHRlckZpZWxkcy5oYXNPd25Qcm9wZXJ0eShjb2wuZmllbGQpKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZmlsdGVyRmllbGRzW2NvbC5maWVsZF0uc29tZShlbGUgPT4ge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGVsZS5jaGVja2VkO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==