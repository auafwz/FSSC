/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Directive, NgZone, Injector, Renderer2, ElementRef, Input } from '@angular/core';
import { dropHandlers, smoothDnD, constants } from '@farris/smooth-dnd';
import { DatagridComponent } from './../../datagrid.component';
import { DragDropColumnService } from './drag-drop-column.service';
smoothDnD.dropHandler = dropHandlers.reactDropHandler().handler;
smoothDnD.wrapChild = false;
var wrapperClass = constants.wrapperClass, animationClass = constants.animationClass;
var DropColumnDirective = /** @class */ (function () {
    function DropColumnDirective(ngzone, injector, render, el, dg, dndSer) {
        var _this = this;
        this.ngzone = ngzone;
        this.injector = injector;
        this.render = render;
        this.el = el;
        this.dg = dg;
        this.dndSer = dndSer;
        this.options = {
            orientation: 'horizontal',
            behaviour: 'move',
            dragHandleSelector: '.group-field',
            dropPlaceholder: {
                className: 'drop-group-field',
            },
            getGhostParent: (/**
             * @return {?}
             */
            function () {
                return document.body;
            }),
            shouldAcceptDrop: (/**
             * @param {?} sourceContainerOptions
             * @param {?} payload
             * @return {?}
             */
            function (sourceContainerOptions, payload) {
                // console.log(sourceContainerOptions, payload);
                if (typeof payload === 'number') {
                    return true;
                }
                if (_this.getGroupFields().length < 3) {
                    return payload.allowGrouping === undefined || payload.allowGrouping;
                }
                return false;
            }),
            getChildPayload: (/**
             * @param {?} index
             * @return {?}
             */
            function (index) {
                return index;
            }),
            // dragClass: 'drag-column-moving',
            onDropReady: (/**
             * @param {?} dropResult
             * @return {?}
             */
            function (dropResult) {
                _this.ngzone.run((/**
                 * @return {?}
                 */
                function () {
                    _this.onDropReady(dropResult);
                }));
            }),
            onDrop: (/**
             * @param {?} dropResult
             * @return {?}
             */
            function (dropResult) {
                _this.ngzone.run((/**
                 * @return {?}
                 */
                function () {
                    _this.onDrop(dropResult);
                }));
            }),
            onDragEnter: (/**
             * @return {?}
             */
            function () {
                _this.ngzone.run((/**
                 * @return {?}
                 */
                function () {
                    _this.onDragEnter();
                }));
            }),
            onDragStart: (/**
             * @param {?} info
             * @return {?}
             */
            function (info) {
                _this.ngzone.run((/**
                 * @return {?}
                 */
                function () {
                    _this.onDragStart(info);
                }));
            }),
            onDragEnd: (/**
             * @param {?} info
             * @return {?}
             */
            function (info) {
                _this.ngzone.run((/**
                 * @return {?}
                 */
                function () {
                    _this.onDragEnd(info);
                }));
            })
        };
    }
    /**
     * @return {?}
     */
    DropColumnDirective.prototype.ngAfterViewInit = /**
     * @return {?}
     */
    function () {
        this.initDnD();
    };
    /**
     * @return {?}
     */
    DropColumnDirective.prototype.ngOnDestroy = /**
     * @return {?}
     */
    function () {
        this.disposeDnd();
    };
    /**
     * @private
     * @return {?}
     */
    DropColumnDirective.prototype.disposeDnd = /**
     * @private
     * @return {?}
     */
    function () {
        if (this.container) {
            this.container.dispose();
            this.container = null;
        }
    };
    /**
     * @private
     * @return {?}
     */
    DropColumnDirective.prototype.initDnD = /**
     * @private
     * @return {?}
     */
    function () {
        this.disposeDnd();
        if (this.dg.showRowGroupPanel) {
            this.container = smoothDnD(this.el.nativeElement, this.options);
        }
    };
    /**
     * @private
     * @param {?} dropResult
     * @return {?}
     */
    DropColumnDirective.prototype.onDropReady = /**
     * @private
     * @param {?} dropResult
     * @return {?}
     */
    function (dropResult) {
        // console.log('DROP READY', dropResult);
    };
    /**
     * @private
     * @return {?}
     */
    DropColumnDirective.prototype.getGroupFields = /**
     * @private
     * @return {?}
     */
    function () {
        return this.dg.groupField ? this.dg.groupField.split(',') : [];
    };
    /**
     * @private
     * @param {?} dropResult
     * @return {?}
     */
    DropColumnDirective.prototype.onDrop = /**
     * @private
     * @param {?} dropResult
     * @return {?}
     */
    function (dropResult) {
        var _this = this;
        // console.log('DROP', dropResult);
        var addedIndex = dropResult.addedIndex, payload = dropResult.payload, removedIndex = dropResult.removedIndex;
        if (addedIndex === null) {
            return;
        }
        /** @type {?} */
        var newGroupFields = this.getGroupFields();
        if (removedIndex === null) {
            if (!newGroupFields.some((/**
             * @param {?} v
             * @return {?}
             */
            function (v) { return v === payload.field; }))) {
                // newGroupFields.splice(0, 0, payload.field);
                newGroupFields.push(payload.field);
            }
        }
        else {
            this.dndSer.moveItem(newGroupFields, addedIndex, removedIndex);
        }
        this.dg.groupField = newGroupFields.join(',');
        // this.dg.toggleVisibleColumn([this.dg.groupField], false);
        if (this.dg.useControlPanel && this.dg.settingService) {
            this.dg.settingService.saveUserConfig(this.dg.id).subscribe((/**
             * @return {?}
             */
            function () {
                _this.dg.columnsChanged();
            }));
        }
        else {
            this.dg.columnsChanged();
        }
        this.dg.groupFieldChange.emit({ newGroupField: this.dg.groupField, grid: this.dg });
    };
    /**
     * @private
     * @param {?} info
     * @return {?}
     */
    DropColumnDirective.prototype.onDragStart = /**
     * @private
     * @param {?} info
     * @return {?}
     */
    function (info) {
        // console.log('DRAG START', info);
    };
    /**
     * @private
     * @param {?} info
     * @return {?}
     */
    DropColumnDirective.prototype.onDragEnd = /**
     * @private
     * @param {?} info
     * @return {?}
     */
    function (info) {
        // console.log('DRAG END', info);
    };
    /**
     * @private
     * @return {?}
     */
    DropColumnDirective.prototype.onDragEnter = /**
     * @private
     * @return {?}
     */
    function () {
        // console.log('DRAG ENTER');
    };
    DropColumnDirective.decorators = [
        { type: Directive, args: [{
                    selector: '[drop-column]',
                    providers: [
                        DragDropColumnService
                    ]
                },] }
    ];
    /** @nocollapse */
    DropColumnDirective.ctorParameters = function () { return [
        { type: NgZone },
        { type: Injector },
        { type: Renderer2 },
        { type: ElementRef },
        { type: DatagridComponent },
        { type: DragDropColumnService }
    ]; };
    DropColumnDirective.propDecorators = {
        options: [{ type: Input }]
    };
    return DropColumnDirective;
}());
export { DropColumnDirective };
if (false) {
    /** @type {?} */
    DropColumnDirective.prototype.options;
    /**
     * @type {?}
     * @private
     */
    DropColumnDirective.prototype.container;
    /**
     * @type {?}
     * @private
     */
    DropColumnDirective.prototype.ngzone;
    /**
     * @type {?}
     * @private
     */
    DropColumnDirective.prototype.injector;
    /**
     * @type {?}
     * @private
     */
    DropColumnDirective.prototype.render;
    /**
     * @type {?}
     * @private
     */
    DropColumnDirective.prototype.el;
    /**
     * @type {?}
     * @private
     */
    DropColumnDirective.prototype.dg;
    /**
     * @type {?}
     * @private
     */
    DropColumnDirective.prototype.dndSer;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YWdyaWQtZHJvcC1jb2x1bW4uZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy91aS1kYXRhZ3JpZC8iLCJzb3VyY2VzIjpbImxpYi9jb21wb25lbnRzL2hlYWRlci9kYXRhZ3JpZC1kcm9wLWNvbHVtbi5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUNBLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFpQixLQUFLLEVBQWEsTUFBTSxlQUFlLENBQUM7QUFDcEgsT0FBTyxFQUFFLFlBQVksRUFBRSxTQUFTLEVBQWdDLFNBQVMsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3RHLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBRS9ELE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBR25FLFNBQVMsQ0FBQyxXQUFXLEdBQUcsWUFBWSxDQUFDLGdCQUFnQixFQUFFLENBQUMsT0FBTyxDQUFDO0FBQ2hFLFNBQVMsQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFDO0FBQ3BCLElBQUEscUNBQVksRUFBRSx5Q0FBYztBQUVwQztJQTZESSw2QkFBb0IsTUFBYyxFQUFVLFFBQWtCLEVBQVUsTUFBaUIsRUFBVSxFQUFjLEVBQzdGLEVBQXFCLEVBQVUsTUFBNkI7UUFEaEYsaUJBQ3FGO1FBRGpFLFdBQU0sR0FBTixNQUFNLENBQVE7UUFBVSxhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQVUsV0FBTSxHQUFOLE1BQU0sQ0FBVztRQUFVLE9BQUUsR0FBRixFQUFFLENBQVk7UUFDN0YsT0FBRSxHQUFGLEVBQUUsQ0FBbUI7UUFBVSxXQUFNLEdBQU4sTUFBTSxDQUF1QjtRQXZEdkUsWUFBTyxHQUFxQjtZQUNqQyxXQUFXLEVBQUUsWUFBWTtZQUN6QixTQUFTLEVBQUUsTUFBTTtZQUNqQixrQkFBa0IsRUFBRSxjQUFjO1lBQ2xD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YyxFQUFFLENBQUM7U0FDNUI7UUFFRCxJQUFJLENBQUMsRUFBRSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxFQUFFLGFBQWEsRUFBRSxJQUFJLENBQUMsRUFBRSxDQUFDLFVBQVUsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDeEYsQ0FBQzs7Ozs7O0lBRU8seUNBQVc7Ozs7O0lBQW5CLFVBQW9CLElBQUk7UUFDcEIsbUNBQW1DO0lBQ3ZDLENBQUM7Ozs7OztJQUVPLHVDQUFTOzs7OztJQUFqQixVQUFrQixJQUFJO1FBQ2xCLGlDQUFpQztJQUNyQyxDQUFDOzs7OztJQUdPLHlDQUFXOzs7O0lBQW5CO1FBQ0ksNkJBQTZCO0lBQ2pDLENBQUM7O2dCQTdJSixTQUFTLFNBQUM7b0JBQ1AsUUFBUSxFQUFFLGVBQWU7b0JBQ3pCLFNBQVMsRUFBRTt3QkFDUCxxQkFBcUI7cUJBQ3hCO2lCQUNKOzs7O2dCQWhCbUIsTUFBTTtnQkFBRSxRQUFRO2dCQUFFLFNBQVM7Z0JBQUUsVUFBVTtnQkFFbEQsaUJBQWlCO2dCQUVqQixxQkFBcUI7OzswQkFjekIsS0FBSzs7SUF1SVYsMEJBQUM7Q0FBQSxBQTlJRCxJQThJQztTQXhJWSxtQkFBbUI7OztJQUM1QixzQ0FtREU7Ozs7O0lBRUYsd0NBQXVCOzs7OztJQUNYLHFDQUFzQjs7Ozs7SUFBRSx1Q0FBMEI7Ozs7O0lBQUUscUNBQXlCOzs7OztJQUFFLGlDQUFzQjs7Ozs7SUFDckcsaUNBQTZCOzs7OztJQUFFLHFDQUFxQyIsInNvdXJjZXNDb250ZW50IjpbIlxyXG5pbXBvcnQgeyBEaXJlY3RpdmUsIE5nWm9uZSwgSW5qZWN0b3IsIFJlbmRlcmVyMiwgRWxlbWVudFJlZiwgQWZ0ZXJWaWV3SW5pdCwgSW5wdXQsIE9uRGVzdHJveSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBkcm9wSGFuZGxlcnMsIHNtb290aERuRCwgRHJvcFJlc3VsdCwgQ29udGFpbmVyT3B0aW9ucywgY29uc3RhbnRzIH0gZnJvbSAnQGZhcnJpcy9zbW9vdGgtZG5kJztcclxuaW1wb3J0IHsgRGF0YWdyaWRDb21wb25lbnQgfSBmcm9tICcuLy4uLy4uL2RhdGFncmlkLmNvbXBvbmVudCc7XHJcbmltcG9ydCB7IERyYWdTdGFydEVuZEluZm8gfSBmcm9tICcuL2RhdGFncmlkLWRyYWctY29sdW1uLmRpcmVjdGl2ZSc7XHJcbmltcG9ydCB7IERyYWdEcm9wQ29sdW1uU2VydmljZSB9IGZyb20gJy4vZHJhZy1kcm9wLWNvbHVtbi5zZXJ2aWNlJztcclxuXHJcblxyXG5zbW9vdGhEbkQuZHJvcEhhbmRsZXIgPSBkcm9wSGFuZGxlcnMucmVhY3REcm9wSGFuZGxlcigpLmhhbmRsZXI7XHJcbnNtb290aERuRC53cmFwQ2hpbGQgPSBmYWxzZTtcclxuY29uc3QgeyB3cmFwcGVyQ2xhc3MsIGFuaW1hdGlvbkNsYXNzIH0gPSBjb25zdGFudHM7XHJcblxyXG5ARGlyZWN0aXZlKHtcclxuICAgIHNlbGVjdG9yOiAnW2Ryb3AtY29sdW1uXScsXHJcbiAgICBwcm92aWRlcnM6IFtcclxuICAgICAgICBEcmFnRHJvcENvbHVtblNlcnZpY2VcclxuICAgIF1cclxufSlcclxuZXhwb3J0IGNsYXNzIERyb3BDb2x1bW5EaXJlY3RpdmUgaW1wbGVtZW50cyBBZnRlclZpZXdJbml0LCBPbkRlc3Ryb3kge1xyXG4gICAgQElucHV0KCkgb3B0aW9uczogQ29udGFpbmVyT3B0aW9ucyA9IHtcclxuICAgICAgICBvcmllbnRhdGlvbjogJ2hvcml6b250YWwnLFxyXG4gICAgICAgIGJlaGF2aW91cjogJ21vdmUnLFxyXG4gICAgICAgIGRyYWdIYW5kbGVTZWxlY3RvcjogJy5ncm91cC1maWVsZCcsXHJcbiAgICAgICAgZHJvcFBsYWNlaG9sZGVyOiB7XHJcbiAgICAgICAgICAgIGNsYXNzTmFtZTogJ2Ryb3AtZ3JvdXAtZmllbGQnLFxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZ2V0R2hvc3RQYXJlbnQ6ICgpID0+IHtcclxuICAgICAgICAgICAgcmV0dXJuIGRvY3VtZW50LmJvZHk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBzaG91bGRBY2NlcHREcm9wOiAoc291cmNlQ29udGFpbmVyT3B0aW9ucywgcGF5bG9hZCkgPT4ge1xyXG4gICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhzb3VyY2VDb250YWluZXJPcHRpb25zLCBwYXlsb2FkKTtcclxuXHJcbiAgICAgICAgICAgIGlmICh0eXBlb2YgcGF5bG9hZCA9PT0gJ251bWJlcicpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAodGhpcy5nZXRHcm91cEZpZWxkcygpLmxlbmd0aCA8IDMpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBwYXlsb2FkLmFsbG93R3JvdXBpbmcgPT09IHVuZGVmaW5lZCB8fCBwYXlsb2FkLmFsbG93R3JvdXBpbmc7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZ2V0Q2hpbGRQYXlsb2FkOiAoaW5kZXgpID0+IHtcclxuICAgICAgICAgICAgcmV0dXJuIGluZGV4O1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgLy8gZHJhZ0NsYXNzOiAnZHJhZy1jb2x1bW4tbW92aW5nJyxcclxuICAgICAgICBvbkRyb3BSZWFkeTogKGRyb3BSZXN1bHQ6IERyb3BSZXN1bHQpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5uZ3pvbmUucnVuKCgpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMub25Ecm9wUmVhZHkoZHJvcFJlc3VsdCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgb25Ecm9wOiAoZHJvcFJlc3VsdDogRHJvcFJlc3VsdCkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLm5nem9uZS5ydW4oKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5vbkRyb3AoZHJvcFJlc3VsdCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgb25EcmFnRW50ZXI6ICgpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5uZ3pvbmUucnVuKCgpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMub25EcmFnRW50ZXIoKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBvbkRyYWdTdGFydDogKGluZm86IERyYWdTdGFydEVuZEluZm8pID0+IHtcclxuICAgICAgICAgICAgdGhpcy5uZ3pvbmUucnVuKCgpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMub25EcmFnU3RhcnQoaW5mbyk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgb25EcmFnRW5kOiAoaW5mbzogRHJhZ1N0YXJ0RW5kSW5mbykgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLm5nem9uZS5ydW4oKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5vbkRyYWdFbmQoaW5mbyk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcblxyXG4gICAgcHJpdmF0ZSBjb250YWluZXI6IGFueTtcclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgbmd6b25lOiBOZ1pvbmUsIHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yLCBwcml2YXRlIHJlbmRlcjogUmVuZGVyZXIyLCBwcml2YXRlIGVsOiBFbGVtZW50UmVmLFxyXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBkZzogRGF0YWdyaWRDb21wb25lbnQsIHByaXZhdGUgZG5kU2VyOiBEcmFnRHJvcENvbHVtblNlcnZpY2UpIHsgfVxyXG5cclxuICAgIG5nQWZ0ZXJWaWV3SW5pdCgpIHtcclxuICAgICAgICB0aGlzLmluaXREbkQoKTtcclxuICAgIH1cclxuXHJcbiAgICBuZ09uRGVzdHJveSgpIHtcclxuICAgICAgICB0aGlzLmRpc3Bvc2VEbmQoKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGRpc3Bvc2VEbmQoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuY29udGFpbmVyKSB7XHJcbiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmRpc3Bvc2UoKTtcclxuICAgICAgICAgICAgdGhpcy5jb250YWluZXIgPSBudWxsO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGluaXREbkQoKSB7XHJcbiAgICAgICAgdGhpcy5kaXNwb3NlRG5kKCk7XHJcbiAgICAgICAgaWYgKHRoaXMuZGcuc2hvd1Jvd0dyb3VwUGFuZWwpIHtcclxuICAgICAgICAgICAgdGhpcy5jb250YWluZXIgPSBzbW9vdGhEbkQoXHJcbiAgICAgICAgICAgICAgICB0aGlzLmVsLm5hdGl2ZUVsZW1lbnQsXHJcbiAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnNcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBvbkRyb3BSZWFkeShkcm9wUmVzdWx0KSB7XHJcbiAgICAgICAgLy8gY29uc29sZS5sb2coJ0RST1AgUkVBRFknLCBkcm9wUmVzdWx0KTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdldEdyb3VwRmllbGRzKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmRnLmdyb3VwRmllbGQgPyB0aGlzLmRnLmdyb3VwRmllbGQuc3BsaXQoJywnKSA6IFtdO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICBwcml2YXRlIG9uRHJvcChkcm9wUmVzdWx0OiBEcm9wUmVzdWx0KSB7XHJcbiAgICAgICAgLy8gY29uc29sZS5sb2coJ0RST1AnLCBkcm9wUmVzdWx0KTtcclxuICAgICAgICBjb25zdCB7IGFkZGVkSW5kZXgsIHBheWxvYWQsIHJlbW92ZWRJbmRleCB9ID0gZHJvcFJlc3VsdDtcclxuXHJcbiAgICAgICAgaWYgKGFkZGVkSW5kZXggPT09IG51bGwpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgbmV3R3JvdXBGaWVsZHMgPSB0aGlzLmdldEdyb3VwRmllbGRzKCk7XHJcblxyXG4gICAgICAgIGlmIChyZW1vdmVkSW5kZXggPT09IG51bGwpIHtcclxuICAgICAgICAgICAgaWYgKCFuZXdHcm91cEZpZWxkcy5zb21lKCh2KSA9PiB2ID09PSBwYXlsb2FkLmZpZWxkKSkge1xyXG4gICAgICAgICAgICAgICAgLy8gbmV3R3JvdXBGaWVsZHMuc3BsaWNlKDAsIDAsIHBheWxvYWQuZmllbGQpO1xyXG4gICAgICAgICAgICAgICAgbmV3R3JvdXBGaWVsZHMucHVzaChwYXlsb2FkLmZpZWxkKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuZG5kU2VyLm1vdmVJdGVtKG5ld0dyb3VwRmllbGRzLCBhZGRlZEluZGV4LCByZW1vdmVkSW5kZXgpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmRnLmdyb3VwRmllbGQgPSBuZXdHcm91cEZpZWxkcy5qb2luKCcsJyk7XHJcbiAgICAgICAgLy8gdGhpcy5kZy50b2dnbGVWaXNpYmxlQ29sdW1uKFt0aGlzLmRnLmdyb3VwRmllbGRdLCBmYWxzZSk7XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmRnLnVzZUNvbnRyb2xQYW5lbCAmJiB0aGlzLmRnLnNldHRpbmdTZXJ2aWNlKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZGcuc2V0dGluZ1NlcnZpY2Uuc2F2ZVVzZXJDb25maWcodGhpcy5kZy5pZCkuc3Vic2NyaWJlKCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmRnLmNvbHVtbnNDaGFuZ2VkKCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuZGcuY29sdW1uc0NoYW5nZWQoKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuZGcuZ3JvdXBGaWVsZENoYW5nZS5lbWl0KHsgbmV3R3JvdXBGaWVsZDogdGhpcy5kZy5ncm91cEZpZWxkLCBncmlkOiB0aGlzLmRnIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgb25EcmFnU3RhcnQoaW5mbykge1xyXG4gICAgICAgIC8vIGNvbnNvbGUubG9nKCdEUkFHIFNUQVJUJywgaW5mbyk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBvbkRyYWdFbmQoaW5mbykge1xyXG4gICAgICAgIC8vIGNvbnNvbGUubG9nKCdEUkFHIEVORCcsIGluZm8pO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICBwcml2YXRlIG9uRHJhZ0VudGVyKCkge1xyXG4gICAgICAgIC8vIGNvbnNvbGUubG9nKCdEUkFHIEVOVEVSJyk7XHJcbiAgICB9XHJcbn1cclxuIl19