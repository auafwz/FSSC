/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Subject } from 'rxjs';
import { FarrisContextMenuComponent } from './context-menu.component';
import { Injectable, ComponentFactoryResolver, Injector } from '@angular/core';
export class FarrisContextMenuService {
    /**
     * @param {?} cfr
     * @param {?} injector
     */
    constructor(cfr, injector) {
        this.cfr = cfr;
        this.injector = injector;
        this.overlayEle = null;
        this.contextMenuDom = null;
        this.contextMenuRefs = {};
        this.activeDom = null;
        this.showContextMenu = new Subject();
    }
    /**
     * @private
     * @param {?=} cls
     * @param {?=} opts
     * @return {?}
     */
    createOverlay(cls, opts) {
        /** @type {?} */
        let overlayEle = document.querySelector('.f-context-menu-overlay');
        if (!overlayEle) {
            overlayEle = document.createElement('div');
            overlayEle.classList.add('f-context-menu-overlay', cls);
            document.body.appendChild(overlayEle);
            if (opts.highlight) {
                this.activeDom = document.createElement('div');
                this.activeDom.classList.add('f-context-target-focus');
                overlayEle.appendChild(this.activeDom);
            }
            overlayEle.addEventListener('click', (/**
             * @param {?} e
             * @return {?}
             */
            (e) => {
                if (((/** @type {?} */ (e.target))).className.indexOf('f-context-menu-overlay') > -1) {
                    this.hide();
                }
            }));
            overlayEle.addEventListener('contextmenu', (/**
             * @param {?} e
             * @return {?}
             */
            (e) => {
                e.preventDefault();
                e.stopPropagation();
                this.hide();
            }));
        }
        return overlayEle;
    }
    /**
     * @param {?} options
     * @return {?}
     */
    show(options) {
        const { menuItems, event, id, activeDom, context, menuClass, target, activeWidth } = options;
        /** @type {?} */
        let cmpRef = null;
        if (!this.contextMenuRefs) {
            this.contextMenuRefs = {};
        }
        if (!this.contextMenuRefs[id]) {
            /** @type {?} */
            const cmpFactory = this.cfr.resolveComponentFactory(FarrisContextMenuComponent);
            cmpRef = cmpFactory.create(this.injector);
            cmpRef.instance.menuItems = menuItems;
            cmpRef.instance.id = id;
            cmpRef.instance.left = event.pageX;
            cmpRef.instance.top = event.pageY;
            this.contextMenuDom = activeDom;
            this.contextMenuRefs[cmpRef.instance.id] = cmpRef;
        }
        else {
            cmpRef = this.contextMenuRefs[id];
        }
        cmpRef.instance.context = context;
        this.overlayEle = this.createOverlay(menuClass, options);
        this.overlayEle.appendChild(cmpRef.location.nativeElement);
        if (this.activeDom) {
            // const w = target.offsetWidth > this.contextMenuDom.offsetWidth ? this.contextMenuDom.offsetWidth : target.offsetWidth;
            /** @type {?} */
            const w = activeWidth || this.contextMenuDom.offsetWidth;
            this.activeDom.style.width = w + 'px';
            this.activeDom.style.height = this.contextMenuDom.offsetHeight + 'px';
            this.activeDom.style.left = target.getBoundingClientRect().left + 'px';
            this.activeDom.style.top = this.contextMenuDom.getBoundingClientRect().top + 'px';
            this.activeDom.style.display = 'block';
        }
        cmpRef.changeDetectorRef.detectChanges();
        /** @type {?} */
        const menuPanelDom = cmpRef.instance.menuPanel.nativeElement;
        /** @type {?} */
        const menuPanelHeight = menuPanelDom.offsetHeight;
        if (window.innerHeight - event.pageY < menuPanelHeight) {
            cmpRef.instance.top = event.pageY - menuPanelHeight;
        }
        if (window.innerWidth - event.pageX < menuPanelDom.offsetWidth) {
            cmpRef.instance.left = event.pageX - menuPanelDom.offsetWidth;
        }
        cmpRef.changeDetectorRef.detectChanges();
    }
    /**
     * @return {?}
     */
    hide() {
        if (this.overlayEle) {
            this.overlayEle.style.display = 'none';
            if (this.contextMenuRefs) {
                for (const key of Object.keys(this.contextMenuRefs)) {
                    this.contextMenuRefs[key].hostView.destroy();
                }
                this.contextMenuRefs = null;
            }
            // 移除DOM 样式
            if (this.contextMenuDom) {
                this.contextMenuDom.className = this.contextMenuDom.className.replace('f-context-menu-active', '');
            }
            this.overlayEle.remove();
            this.overlayEle = null;
        }
    }
}
FarrisContextMenuService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
FarrisContextMenuService.ctorParameters = () => [
    { type: ComponentFactoryResolver },
    { type: Injector }
];
if (false) {
    /**
     * @type {?}
     * @private
     */
    FarrisContextMenuService.prototype.overlayEle;
    /** @type {?} */
    FarrisContextMenuService.prototype.contextMenuDom;
    /**
     * @type {?}
     * @private
     */
    FarrisContextMenuService.prototype.contextMenuRefs;
    /**
     * @type {?}
     * @private
     */
    FarrisContextMenuService.prototype.activeDom;
    /** @type {?} */
    FarrisContextMenuService.prototype.showContextMenu;
    /**
     * @type {?}
     * @private
     */
    FarrisContextMenuService.prototype.cfr;
    /**
     * @type {?}
     * @private
     */
    FarrisContextMenuService.prototype.injector;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udGV4dC1tZW51LnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL3VpLWNvbnRleHQtbWVudS8iLCJzb3VyY2VzIjpbImxpYi9jb250ZXh0LW1lbnUuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMvQixPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUN0RSxPQUFPLEVBQUUsVUFBVSxFQUFFLHdCQUF3QixFQUFFLFFBQVEsRUFBZ0IsTUFBTSxlQUFlLENBQUM7QUFJN0YsTUFBTSxPQUFPLHdCQUF3Qjs7Ozs7SUFVakMsWUFBb0IsR0FBNkIsRUFDN0IsUUFBa0I7UUFEbEIsUUFBRyxHQUFILEdBQUcsQ0FBMEI7UUFDN0IsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQVQ5QixlQUFVLEdBQUcsSUFBSSxDQUFDO1FBQ25CLG1CQUFjLEdBQUcsSUFBSSxDQUFDO1FBQ3JCLG9CQUFlLEdBQWdFLEVBQUUsQ0FBQztRQUVsRixjQUFTLEdBQUcsSUFBSSxDQUFDO1FBRXpCLG9CQUFlLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQztJQUloQyxDQUFDOzs7Ozs7O0lBSU8sYUFBYSxDQUFDLEdBQVksRUFBRSxJQUF5Qjs7WUFDckQsVUFBVSxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMseUJBQXlCLENBQUM7UUFDbEUsSUFBSSxDQUFDLFVBQVUsRUFBRTtZQUNiLFVBQVUsR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQzNDLFVBQVUsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLHdCQUF3QixFQUFFLEdBQUcsQ0FBQyxDQUFDO1lBQ3hELFFBQVEsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBRXRDLElBQUksSUFBSSxDQUFDLFNBQVMsRUFBRTtnQkFDaEIsSUFBSSxDQUFDLFNBQVMsR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUMvQyxJQUFJLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsd0JBQXdCLENBQUMsQ0FBQztnQkFDdkQsVUFBVSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7YUFDMUM7WUFFRCxVQUFVLENBQUMsZ0JBQWdCLENBQUMsT0FBTzs7OztZQUFFLENBQUMsQ0FBQyxFQUFFLEVBQUU7Z0JBQ3ZDLElBQUksQ0FBQyxtQkFBQSxDQUFDLENBQUMsTUFBTSxFQUFPLENBQUMsQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLHdCQUF3QixDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUU7b0JBQ3BFLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztpQkFDZjtZQUNMLENBQUMsRUFBQyxDQUFDO1lBRUgsVUFBVSxDQUFDLGdCQUFnQixDQUFDLGFBQWE7Ozs7WUFBRSxDQUFDLENBQUMsRUFBRSxFQUFFO2dCQUM3QyxDQUFDLENBQUMsY0FBYyxFQUFFLENBQUM7Z0JBQ25CLENBQUMsQ0FBQyxlQUFlLEVBQUUsQ0FBQztnQkFDcEIsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1lBQ2hCLENBQUMsRUFBQyxDQUFDO1NBQ047UUFDRCxPQUFPLFVBQVUsQ0FBQztJQUN0QixDQUFDOzs7OztJQUVELElBQUksQ0FBQyxPQUEyQjtjQUV0QixFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsRUFBRSxFQUFFLFNBQVMsRUFBRSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sRUFBRSxXQUFXLEVBQUUsR0FBRyxPQUFPOztZQUN4RixNQUFNLEdBQUcsSUFBSTtRQUVqQixJQUFJLENBQUMsSUFBSSxDQUFDLGVBQWUsRUFBRTtZQUN2QixJQUFJLENBQUMsZUFBZSxHQUFHLEVBQUUsQ0FBQztTQUM3QjtRQUVELElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLEVBQUUsQ0FBQyxFQUFFOztrQkFDckIsVUFBVSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsdUJBQXVCLENBQUMsMEJBQTBCLENBQUM7WUFDL0UsTUFBTSxHQUFHLFVBQVUsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQzFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsU0FBUyxHQUFHLFNBQVMsQ0FBQztZQUN0QyxNQUFNLENBQUMsUUFBUSxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUM7WUFFeEIsTUFBTSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQztZQUNuQyxNQUFNLENBQUMsUUFBUSxDQUFDLEdBQUcsR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDO1lBRWxDLElBQUksQ0FBQyxjQUFjLEdBQUcsU0FBUyxDQUFDO1lBQ2hDLElBQUksQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsR0FBRyxNQUFNLENBQUM7U0FDckQ7YUFBTTtZQUNILE1BQU0sR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1NBQ3JDO1FBRUQsTUFBTSxDQUFDLFFBQVEsQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO1FBRWxDLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxTQUFTLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDekQsSUFBSSxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUUzRCxJQUFJLElBQUksQ0FBQyxTQUFTLEVBQUU7OztrQkFFVixDQUFDLEdBQUcsV0FBVyxJQUFJLElBQUksQ0FBQyxjQUFjLENBQUMsV0FBVztZQUN4RCxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxLQUFLLEdBQUksQ0FBQyxHQUFHLElBQUksQ0FBQztZQUN2QyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDO1lBQ3RFLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLElBQUksR0FBRyxNQUFNLENBQUMscUJBQXFCLEVBQUUsQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1lBQ3ZFLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLHFCQUFxQixFQUFFLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQztZQUNsRixJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO1NBQzFDO1FBQ0QsTUFBTSxDQUFDLGlCQUFpQixDQUFDLGFBQWEsRUFBRSxDQUFDOztjQUVuQyxZQUFZLEdBQUcsTUFBTSxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsYUFBYTs7Y0FDdEQsZUFBZSxHQUFJLFlBQVksQ0FBQyxZQUFZO1FBQ2xELElBQUksTUFBTSxDQUFDLFdBQVcsR0FBSSxLQUFLLENBQUMsS0FBSyxHQUFHLGVBQWUsRUFBRTtZQUNyRCxNQUFNLENBQUMsUUFBUSxDQUFDLEdBQUcsR0FBRyxLQUFLLENBQUMsS0FBSyxHQUFHLGVBQWUsQ0FBQztTQUN2RDtRQUVELElBQUksTUFBTSxDQUFDLFVBQVUsR0FBRyxLQUFLLENBQUMsS0FBSyxHQUFHLFlBQVksQ0FBQyxXQUFXLEVBQUU7WUFDNUQsTUFBTSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEdBQUcsS0FBSyxDQUFDLEtBQUssR0FBRyxZQUFZLENBQUMsV0FBVyxDQUFDO1NBQ2pFO1FBRUQsTUFBTSxDQUFDLGlCQUFpQixDQUFDLGFBQWEsRUFBRSxDQUFDO0lBQzdDLENBQUM7Ozs7SUFFRCxJQUFJO1FBQ0EsSUFBSSxJQUFJLENBQUMsVUFBVSxFQUFFO1lBQ2pCLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUM7WUFDdkMsSUFBSSxJQUFJLENBQUMsZUFBZSxFQUFFO2dCQUN0QixLQUFLLE1BQU0sR0FBRyxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxFQUFFO29CQUNqRCxJQUFJLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxPQUFPLEVBQUUsQ0FBQztpQkFDaEQ7Z0JBQ0QsSUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFJLENBQUM7YUFDL0I7WUFFRCxXQUFXO1lBQ1gsSUFBSSxJQUFJLENBQUMsY0FBYyxFQUFFO2dCQUNyQixJQUFJLENBQUMsY0FBYyxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsdUJBQXVCLEVBQUUsRUFBRSxDQUFDLENBQUM7YUFDdEc7WUFFRCxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sRUFBRSxDQUFDO1lBQ3pCLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDO1NBQzFCO0lBQ0wsQ0FBQzs7O1lBcEhKLFVBQVU7Ozs7WUFIVSx3QkFBd0I7WUFBRSxRQUFROzs7Ozs7O0lBTW5ELDhDQUEwQjs7SUFDMUIsa0RBQTZCOzs7OztJQUM3QixtREFBMEY7Ozs7O0lBRTFGLDZDQUF5Qjs7SUFFekIsbURBQWdDOzs7OztJQUVwQix1Q0FBcUM7Ozs7O0lBQ3JDLDRDQUEwQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFN1YmplY3QgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgRmFycmlzQ29udGV4dE1lbnVDb21wb25lbnQgfSBmcm9tICcuL2NvbnRleHQtbWVudS5jb21wb25lbnQnO1xyXG5pbXBvcnQgeyBJbmplY3RhYmxlLCBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsIEluamVjdG9yLCBDb21wb25lbnRSZWYgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgQ29udGV4dE1lbnVPcHRpb25zIH0gZnJvbSAnLi9tZW51LWl0ZW0uaW50ZXJmYWNlJztcclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIEZhcnJpc0NvbnRleHRNZW51U2VydmljZSB7XHJcblxyXG4gICAgcHJpdmF0ZSBvdmVybGF5RWxlID0gbnVsbDtcclxuICAgIHB1YmxpYyBjb250ZXh0TWVudURvbSA9IG51bGw7XHJcbiAgICBwcml2YXRlIGNvbnRleHRNZW51UmVmczogeyBba2V5OiBzdHJpbmddOiBDb21wb25lbnRSZWY8RmFycmlzQ29udGV4dE1lbnVDb21wb25lbnQ+IH0gPSB7fTtcclxuXHJcbiAgICBwcml2YXRlIGFjdGl2ZURvbSA9IG51bGw7XHJcblxyXG4gICAgc2hvd0NvbnRleHRNZW51ID0gbmV3IFN1YmplY3QoKTtcclxuXHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGNmcjogQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLFxyXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IpIHtcclxuICAgIH1cclxuXHJcblxyXG5cclxuICAgIHByaXZhdGUgY3JlYXRlT3ZlcmxheShjbHM/OiBzdHJpbmcsIG9wdHM/OiBDb250ZXh0TWVudU9wdGlvbnMpIHtcclxuICAgICAgICBsZXQgb3ZlcmxheUVsZSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5mLWNvbnRleHQtbWVudS1vdmVybGF5Jyk7XHJcbiAgICAgICAgaWYgKCFvdmVybGF5RWxlKSB7XHJcbiAgICAgICAgICAgIG92ZXJsYXlFbGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcclxuICAgICAgICAgICAgb3ZlcmxheUVsZS5jbGFzc0xpc3QuYWRkKCdmLWNvbnRleHQtbWVudS1vdmVybGF5JywgY2xzKTtcclxuICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChvdmVybGF5RWxlKTtcclxuXHJcbiAgICAgICAgICAgIGlmIChvcHRzLmhpZ2hsaWdodCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5hY3RpdmVEb20gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuYWN0aXZlRG9tLmNsYXNzTGlzdC5hZGQoJ2YtY29udGV4dC10YXJnZXQtZm9jdXMnKTtcclxuICAgICAgICAgICAgICAgIG92ZXJsYXlFbGUuYXBwZW5kQ2hpbGQodGhpcy5hY3RpdmVEb20pO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBvdmVybGF5RWxlLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmICgoZS50YXJnZXQgYXMgYW55KS5jbGFzc05hbWUuaW5kZXhPZignZi1jb250ZXh0LW1lbnUtb3ZlcmxheScpID4gLTEpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmhpZGUoKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBvdmVybGF5RWxlLmFkZEV2ZW50TGlzdGVuZXIoJ2NvbnRleHRtZW51JywgKGUpID0+IHtcclxuICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmhpZGUoKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBvdmVybGF5RWxlO1xyXG4gICAgfVxyXG5cclxuICAgIHNob3cob3B0aW9uczogQ29udGV4dE1lbnVPcHRpb25zKSB7XHJcblxyXG4gICAgICAgIGNvbnN0IHsgbWVudUl0ZW1zLCBldmVudCwgaWQsIGFjdGl2ZURvbSwgY29udGV4dCwgbWVudUNsYXNzLCB0YXJnZXQsIGFjdGl2ZVdpZHRoIH0gPSBvcHRpb25zO1xyXG4gICAgICAgIGxldCBjbXBSZWYgPSBudWxsO1xyXG5cclxuICAgICAgICBpZiAoIXRoaXMuY29udGV4dE1lbnVSZWZzKSB7XHJcbiAgICAgICAgICAgIHRoaXMuY29udGV4dE1lbnVSZWZzID0ge307XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoIXRoaXMuY29udGV4dE1lbnVSZWZzW2lkXSkge1xyXG4gICAgICAgICAgICBjb25zdCBjbXBGYWN0b3J5ID0gdGhpcy5jZnIucmVzb2x2ZUNvbXBvbmVudEZhY3RvcnkoRmFycmlzQ29udGV4dE1lbnVDb21wb25lbnQpO1xyXG4gICAgICAgICAgICBjbXBSZWYgPSBjbXBGYWN0b3J5LmNyZWF0ZSh0aGlzLmluamVjdG9yKTtcclxuICAgICAgICAgICAgY21wUmVmLmluc3RhbmNlLm1lbnVJdGVtcyA9IG1lbnVJdGVtcztcclxuICAgICAgICAgICAgY21wUmVmLmluc3RhbmNlLmlkID0gaWQ7XHJcblxyXG4gICAgICAgICAgICBjbXBSZWYuaW5zdGFuY2UubGVmdCA9IGV2ZW50LnBhZ2VYO1xyXG4gICAgICAgICAgICBjbXBSZWYuaW5zdGFuY2UudG9wID0gZXZlbnQucGFnZVk7XHJcblxyXG4gICAgICAgICAgICB0aGlzLmNvbnRleHRNZW51RG9tID0gYWN0aXZlRG9tO1xyXG4gICAgICAgICAgICB0aGlzLmNvbnRleHRNZW51UmVmc1tjbXBSZWYuaW5zdGFuY2UuaWRdID0gY21wUmVmO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGNtcFJlZiA9IHRoaXMuY29udGV4dE1lbnVSZWZzW2lkXTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNtcFJlZi5pbnN0YW5jZS5jb250ZXh0ID0gY29udGV4dDtcclxuXHJcbiAgICAgICAgdGhpcy5vdmVybGF5RWxlID0gdGhpcy5jcmVhdGVPdmVybGF5KG1lbnVDbGFzcywgb3B0aW9ucyk7XHJcbiAgICAgICAgdGhpcy5vdmVybGF5RWxlLmFwcGVuZENoaWxkKGNtcFJlZi5sb2NhdGlvbi5uYXRpdmVFbGVtZW50KTtcclxuXHJcbiAgICAgICAgaWYgKHRoaXMuYWN0aXZlRG9tKSB7XHJcbiAgICAgICAgICAgIC8vIGNvbnN0IHcgPSB0YXJnZXQub2Zmc2V0V2lkdGggPiB0aGlzLmNvbnRleHRNZW51RG9tLm9mZnNldFdpZHRoID8gdGhpcy5jb250ZXh0TWVudURvbS5vZmZzZXRXaWR0aCA6IHRhcmdldC5vZmZzZXRXaWR0aDtcclxuICAgICAgICAgICAgY29uc3QgdyA9IGFjdGl2ZVdpZHRoIHx8IHRoaXMuY29udGV4dE1lbnVEb20ub2Zmc2V0V2lkdGg7XHJcbiAgICAgICAgICAgIHRoaXMuYWN0aXZlRG9tLnN0eWxlLndpZHRoID0gIHcgKyAncHgnO1xyXG4gICAgICAgICAgICB0aGlzLmFjdGl2ZURvbS5zdHlsZS5oZWlnaHQgPSB0aGlzLmNvbnRleHRNZW51RG9tLm9mZnNldEhlaWdodCArICdweCc7XHJcbiAgICAgICAgICAgIHRoaXMuYWN0aXZlRG9tLnN0eWxlLmxlZnQgPSB0YXJnZXQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkubGVmdCArICdweCc7XHJcbiAgICAgICAgICAgIHRoaXMuYWN0aXZlRG9tLnN0eWxlLnRvcCA9IHRoaXMuY29udGV4dE1lbnVEb20uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkudG9wICsgJ3B4JztcclxuICAgICAgICAgICAgdGhpcy5hY3RpdmVEb20uc3R5bGUuZGlzcGxheSA9ICdibG9jayc7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNtcFJlZi5jaGFuZ2VEZXRlY3RvclJlZi5kZXRlY3RDaGFuZ2VzKCk7XHJcblxyXG4gICAgICAgIGNvbnN0IG1lbnVQYW5lbERvbSA9IGNtcFJlZi5pbnN0YW5jZS5tZW51UGFuZWwubmF0aXZlRWxlbWVudDtcclxuICAgICAgICBjb25zdCBtZW51UGFuZWxIZWlnaHQgPSAgbWVudVBhbmVsRG9tLm9mZnNldEhlaWdodDtcclxuICAgICAgICBpZiAod2luZG93LmlubmVySGVpZ2h0IC0gIGV2ZW50LnBhZ2VZIDwgbWVudVBhbmVsSGVpZ2h0KSB7XHJcbiAgICAgICAgICAgIGNtcFJlZi5pbnN0YW5jZS50b3AgPSBldmVudC5wYWdlWSAtIG1lbnVQYW5lbEhlaWdodDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh3aW5kb3cuaW5uZXJXaWR0aCAtIGV2ZW50LnBhZ2VYIDwgbWVudVBhbmVsRG9tLm9mZnNldFdpZHRoKSB7XHJcbiAgICAgICAgICAgIGNtcFJlZi5pbnN0YW5jZS5sZWZ0ID0gZXZlbnQucGFnZVggLSBtZW51UGFuZWxEb20ub2Zmc2V0V2lkdGg7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjbXBSZWYuY2hhbmdlRGV0ZWN0b3JSZWYuZGV0ZWN0Q2hhbmdlcygpO1xyXG4gICAgfVxyXG5cclxuICAgIGhpZGUoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMub3ZlcmxheUVsZSkge1xyXG4gICAgICAgICAgICB0aGlzLm92ZXJsYXlFbGUuc3R5bGUuZGlzcGxheSA9ICdub25lJztcclxuICAgICAgICAgICAgaWYgKHRoaXMuY29udGV4dE1lbnVSZWZzKSB7XHJcbiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGtleSBvZiBPYmplY3Qua2V5cyh0aGlzLmNvbnRleHRNZW51UmVmcykpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbnRleHRNZW51UmVmc1trZXldLmhvc3RWaWV3LmRlc3Ryb3koKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHRoaXMuY29udGV4dE1lbnVSZWZzID0gbnVsbDtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLy8g56e76ZmkRE9NIOagt+W8j1xyXG4gICAgICAgICAgICBpZiAodGhpcy5jb250ZXh0TWVudURvbSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0TWVudURvbS5jbGFzc05hbWUgPSB0aGlzLmNvbnRleHRNZW51RG9tLmNsYXNzTmFtZS5yZXBsYWNlKCdmLWNvbnRleHQtbWVudS1hY3RpdmUnLCAnJyk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHRoaXMub3ZlcmxheUVsZS5yZW1vdmUoKTtcclxuICAgICAgICAgICAgdGhpcy5vdmVybGF5RWxlID0gbnVsbDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuIl19