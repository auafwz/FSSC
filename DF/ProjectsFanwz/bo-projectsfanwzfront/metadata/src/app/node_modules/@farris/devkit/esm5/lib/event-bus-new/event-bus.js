import * as tslib_1 from "tslib";
import { Injectable, Type } from '@angular/core';
import { EventBusProxy } from './event-bus-proxy';
import { EventPipe } from './event-pipe';
var EventBus = /** @class */ (function () {
    function EventBus() {
        this.proxyMap = new Map();
        this.eventMap = new Map();
    }
    EventBus.prototype.getProxy = function (ownerType, eventTokenValueProvider) {
        var ownerName = ownerType.constructor.typeName || ownerType.constructor.name;
        if (!this.proxyMap.has(ownerName)) {
            this.proxyMap.set(ownerName, new EventBusProxy(this, ownerType, eventTokenValueProvider));
        }
        return this.proxyMap.get(ownerName);
    };
    /**
     * 发送事件，通知订阅者接收消息。
     */
    // tslint:disable-next-line: max-line-length
    EventBus.prototype.post = function (emitterType, tokenValue, eventName, eventArgs, sender, eventType, eventId) {
        var e_1, _a;
        var eventPipeList = this.eventMap.get(eventName);
        if (!eventPipeList) {
            return;
        }
        if (!emitterType) {
            console.error('post方法的参数emitterType不能为空。');
            return;
        }
        var emitter;
        if (emitterType instanceof Type) {
            emitter = emitterType.typeName || emitterType.name;
        }
        else {
            emitter = emitterType;
        }
        if (typeof eventId === 'undefined') {
            eventId = new Date().valueOf();
        }
        try {
            for (var eventPipeList_1 = tslib_1.__values(eventPipeList), eventPipeList_1_1 = eventPipeList_1.next(); !eventPipeList_1_1.done; eventPipeList_1_1 = eventPipeList_1.next()) {
                var eventPipe = eventPipeList_1_1.value;
                if (eventPipe.matchEmitterToken(emitter, tokenValue)) {
                    eventPipe.post(eventArgs, sender, eventType, eventId);
                    eventPipe.unSubscribeForOnce();
                }
            }
        }
        catch (e_1_1) { e_1 = { error: e_1_1 }; }
        finally {
            try {
                if (eventPipeList_1_1 && !eventPipeList_1_1.done && (_a = eventPipeList_1.return)) _a.call(eventPipeList_1);
            }
            finally { if (e_1) throw e_1.error; }
        }
    };
    /**
     * 订阅事件
     */
    EventBus.prototype.on = function (target, tokenValue, eventName, caller, handler) {
        return this.getEventPipe(eventName, target, tokenValue).subscribe(handler, caller);
    };
    /**
     * 订阅一次。接收到一次消息之后自动取消订阅
     */
    EventBus.prototype.once = function (target, tokenValue, eventName, caller, handler) {
        return this.getEventPipe(eventName, target, tokenValue).subscribeOnce(handler, caller);
    };
    /**
     * 发送一个请求事件，获取监听者的响应并处理
     */
    EventBus.prototype.requestFor = function (target, tokenValue, requestName, requestValue, success, fail) {
        var eventPipe = this.findExistEventPipe(requestName, 'RequestSubject', tokenValue);
        if (eventPipe) {
            this.once(target, tokenValue, requestName, this, function (response) {
                if (response.status === 'success') {
                    success(response.data);
                }
                else {
                    if (fail) {
                        fail('No target responser listening');
                    }
                }
            });
            eventPipe.post({ target: target, token: tokenValue, data: requestValue });
        }
        else {
            if (fail) {
                fail('No target responser listening.');
            }
        }
    };
    /**
     * 监听一个请求事件，给出响应
     */
    EventBus.prototype.responseOn = function (responseSubject, requestName, callback) {
        var _this = this;
        this.on('RequestSubject', null, requestName, this, function (requestObj) {
            var response = { status: 'fail', data: null };
            if (responseSubject === requestObj.target) {
                response.data = callback(requestObj.data);
                response.status = 'success';
            }
            _this.post(requestObj.target, requestObj.token, requestName, response);
        });
    };
    EventBus.prototype.getEventPipe = function (eventName, target, tokenValue) {
        var eventPipeList = this.eventMap.get(eventName);
        if (!eventPipeList) {
            eventPipeList = new Array();
            this.eventMap.set(eventName, eventPipeList);
        }
        // 1、一个事件不允许多个订阅
        // let eventPipe = eventPipeList.find(item => item.examByTargetToken(target, tokenValue));
        // if (!eventPipe) {
        //   eventPipe = new EventPipe(eventName, tokenValue, target, eventPipeList);
        // }
        // 2、一个事件允许多个订阅
        var eventPipe = new EventPipe(eventName, tokenValue, target, eventPipeList);
        return eventPipe;
    };
    EventBus.prototype.findExistEventPipe = function (eventName, target, tokenValue) {
        var e_2, _a;
        var eventPipeList = this.eventMap.get(eventName);
        if (!eventPipeList) {
            return null;
        }
        try {
            // return eventPipeList.find(item => item.examByTargetToken(target, tokenValue));
            for (var eventPipeList_2 = tslib_1.__values(eventPipeList), eventPipeList_2_1 = eventPipeList_2.next(); !eventPipeList_2_1.done; eventPipeList_2_1 = eventPipeList_2.next()) {
                var eventPipe = eventPipeList_2_1.value;
                if (eventPipe.matchEmitterToken(target, tokenValue)) {
                    return eventPipe;
                }
            }
        }
        catch (e_2_1) { e_2 = { error: e_2_1 }; }
        finally {
            try {
                if (eventPipeList_2_1 && !eventPipeList_2_1.done && (_a = eventPipeList_2.return)) _a.call(eventPipeList_2);
            }
            finally { if (e_2) throw e_2.error; }
        }
        return null;
    };
    EventBus.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    EventBus.ctorParameters = function () { return []; };
    return EventBus;
}());
export { EventBus };
var EventCache = /** @class */ (function () {
    function EventCache() {
    }
    EventCache.setToken = function (key, value) {
        EventCache.tokens.set(key, value);
    };
    EventCache.getToken = function (key) {
        return EventCache.tokens.get(key);
    };
    EventCache.tokens = new Map();
    return EventCache;
}());
export { EventCache };
var RequestSubject = /** @class */ (function () {
    function RequestSubject() {
    }
    return RequestSubject;
}());
var DataClass = /** @class */ (function () {
    function DataClass() {
    }
    return DataClass;
}());
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXZlbnQtYnVzLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9kZXZraXQvIiwic291cmNlcyI6WyJsaWIvZXZlbnQtYnVzLW5ldy9ldmVudC1idXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsSUFBSSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ2pELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUVsRCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBRXpDO0lBS0U7UUFDRSxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksR0FBRyxFQUF5QixDQUFDO1FBQ2pELElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxHQUFHLEVBQTRCLENBQUM7SUFDdEQsQ0FBQztJQUVELDJCQUFRLEdBQVIsVUFBUyxTQUFjLEVBQUUsdUJBQWtDO1FBQ3pELElBQU0sU0FBUyxHQUFHLFNBQVMsQ0FBQyxXQUFXLENBQUMsUUFBUSxJQUFJLFNBQVMsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDO1FBQy9FLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsRUFBRTtZQUNqQyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxTQUFTLEVBQUUsSUFBSSxhQUFhLENBQUMsSUFBSSxFQUFFLFNBQVMsRUFBRSx1QkFBdUIsQ0FBQyxDQUFDLENBQUM7U0FDM0Y7UUFDRCxPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQ3RDLENBQUM7SUFFRDs7T0FFRztJQUNILDRDQUE0QztJQUM1Qyx1QkFBSSxHQUFKLFVBQUssV0FBeUIsRUFBRSxVQUFrQixFQUFFLFNBQWlCLEVBQUUsU0FBYyxFQUFFLE1BQVksRUFBRSxTQUFlLEVBQUUsT0FBZ0I7O1FBQ3BJLElBQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMs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LFNBQVMsQ0FBQyxDQUFDO1FBQ25ELElBQUksQ0FBQyxhQUFhLEVBQUU7WUFDbEIsT0FBTyxJQUFJLENBQUM7U0FDYjs7WUFDRCxpRkFBaUY7WUFDakYsS0FBd0IsSUFBQSxrQkFBQSxpQkFBQSxhQUFhLENBQUEsNENBQUEsdUVBQUU7Z0JBQWxDLElBQU0sU0FBUywwQkFBQTtnQkFDbEIsSUFBSSxTQUFTLENBQUMsaUJBQWlCLENBQUMsTUFBTSxFQUFFLFVBQVUsQ0FBQyxFQUFFO29CQUNuRCxPQUFPLFNBQVMsQ0FBQztpQkFDbEI7YUFDRjs7Ozs7Ozs7O1FBQ0QsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDOztnQkFuSUYsVUFBVTs7OztJQW9JWCxlQUFDO0NBQUEsQUFwSUQsSUFvSUM7U0FuSVksUUFBUTtBQXFJckI7SUFBQTtJQVVBLENBQUM7SUFQZSxtQkFBUSxHQUF0QixVQUF1QixHQUFXLEVBQUUsS0FBVTtRQUM1QyxVQUFVLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDcEMsQ0FBQztJQUVhLG1CQUFRLEdBQXRCLFVBQXVCLEdBQVc7UUFDaEMsT0FBTyxVQUFVLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNwQyxDQUFDO0lBUmMsaUJBQU0sR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDO0lBU3BDLGlCQUFDO0NBQUEsQUFWRCxJQVVDO1NBVlksVUFBVTtBQVl2QjtJQUFBO0lBQXVCLENBQUM7SUFBRCxxQkFBQztBQUFELENBQUMsQUFBeEIsSUFBd0I7QUFDeEI7SUFBQTtJQUFrQixDQUFDO0lBQUQsZ0JBQUM7QUFBRCxDQUFDLEFBQW5CLElBQW1CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgVHlwZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBFdmVudEJ1c1Byb3h5IH0gZnJvbSAnLi9ldmVudC1idXMtcHJveHknO1xyXG5pbXBvcnQgeyBJRGlzcG9zYWJsZSwgSUVtaXRhYmxlIH0gZnJvbSAnLi90eXBlcyc7XHJcbmltcG9ydCB7IEV2ZW50UGlwZSB9IGZyb20gJy4vZXZlbnQtcGlwZSc7XHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBFdmVudEJ1cyBpbXBsZW1lbnRzIElFbWl0YWJsZSB7XHJcbiAgcHJpdmF0ZSBwcm94eU1hcDogTWFwPHN0cmluZywgRXZlbnRCdXNQcm94eT47XHJcbiAgcHJpdmF0ZSBldmVudE1hcDogTWFwPHN0cmluZywgQXJyYXk8RXZlbnRQaXBlPj47XHJcblxyXG4gIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgdGhpcy5wcm94eU1hcCA9IG5ldyBNYXA8c3RyaW5nLCBFdmVudEJ1c1Byb3h5PigpO1xyXG4gICAgdGhpcy5ldmVudE1hcCA9IG5ldyBNYXA8c3RyaW5nLCBBcnJheTxFdmVudFBpcGU+PigpO1xyXG4gIH1cclxuXHJcbiAgZ2V0UHJveHkob3duZXJUeXBlOiBhbnksIGV2ZW50VG9rZW5WYWx1ZVByb3ZpZGVyOiAoKSA9PiBhbnkpOiBFdmVudEJ1c1Byb3h5IHtcclxuICAgIGNvbnN0IG93bmVyTmFtZSA9IG93bmVyVHlwZS5jb25zdHJ1Y3Rvci50eXBlTmFtZSB8fCBvd25lclR5cGUuY29uc3RydWN0b3IubmFtZTtcclxuICAgIGlmICghdGhpcy5wcm94eU1hcC5oYXMob3duZXJOYW1lKSkge1xyXG4gICAgICB0aGlzLnByb3h5TWFwLnNldChvd25lck5hbWUsIG5ldyBFdmVudEJ1c1Byb3h5KHRoaXMsIG93bmVyVHlwZSwgZXZlbnRUb2tlblZhbHVlUHJvdmlkZXIpKTtcclxuICAgIH1cclxuICAgIHJldHVybiB0aGlzLnByb3h5TWFwLmdldChvd25lck5hbWUpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5Y+R6YCB5LqL5Lu277yM6YCa55+l6K6i6ZiF6ICF5o6l5pS25raI5oGv44CCXHJcbiAgICovXHJcbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBtYXgtbGluZS1sZW5ndGhcclxuICBwb3N0KGVtaXR0ZXJUeXBlOiBhbnkgfCBzdHJpbmcsIHRva2VuVmFsdWU6IHN0cmluZywgZXZlbnROYW1lOiBzdHJpbmcsIGV2ZW50QXJnczogYW55LCBzZW5kZXI/OiBhbnksIGV2ZW50VHlwZT86IGFueSwgZXZlbnRJZD86IG51bWJlcik6IHZvaWQge1xyXG4gICAgY29uc3QgZXZlbnRQaXBlTGlzdCA9IHRoaXMuZXZlbnRNYXAuZ2V0KGV2ZW50TmFtZSk7XHJcbiAgICBpZiAoIWV2ZW50UGlwZUxpc3QpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICghZW1pdHRlclR5cGUpIHtcclxuICAgICAgY29uc29sZS5lcnJvcigncG9zdOaWueazleeahOWPguaVsGVtaXR0ZXJUeXBl5LiN6IO95Li656m644CCJyk7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGxldCBlbWl0dGVyOiBzdHJpbmc7XHJcbiAgICBpZiAoZW1pdHRlclR5cGUgaW5zdGFuY2VvZiBUeXBlKSB7XHJcbiAgICAgIGVtaXR0ZXIgPSBlbWl0dGVyVHlwZS50eXBlTmFtZSB8fCBlbWl0dGVyVHlwZS5uYW1lO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgZW1pdHRlciA9IGVtaXR0ZXJUeXBlO1xyXG4gICAgfVxyXG4gICAgaWYgKHR5cGVvZiBldmVudElkID09PSAndW5kZWZpbmVkJykge1xyXG4gICAgICBldmVudElkID0gbmV3IERhdGUoKS52YWx1ZU9mKCk7XHJcbiAgICB9XHJcbiAgICBmb3IgKGNvbnN0IGV2ZW50UGlwZSBvZiBldmVudFBpcGVMaXN0KSB7XHJcbiAgICAgIGlmIChldmVudFBpcGUubWF0Y2hFbWl0dGVyVG9rZW4oZW1pdHRlciwgdG9rZW5WYWx1ZSkpIHtcclxuICAgICAgICBldmVudFBpcGUucG9zdChldmVudEFyZ3MsIHNlbmRlciwgZXZlbnRUeXBlLCBldmVudElkKTtcclxuICAgICAgICBldmVudFBpcGUudW5TdWJzY3JpYmVGb3JPbmNlKCk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiuoumYheS6i+S7tlxyXG4gICAqL1xyXG4gIG9uKHRhcmdldDogc3RyaW5nLCB0b2tlblZhbHVlOiBzdHJpbmcsIGV2ZW50TmFtZTogc3RyaW5nLCBjYWxsZXI6IE9iamVjdCwgaGFuZGxlcjogKHZhbHVlOiBhbnkpID0+IHZvaWQpOiBJRGlzcG9zYWJsZSB7XHJcbiAgICByZXR1cm4gdGhpcy5nZXRFdmVudFBpcGUoZXZlbnROYW1lLCB0YXJnZXQsIHRva2VuVmFsdWUpLnN1YnNjcmliZShoYW5kbGVyLCBjYWxsZXIpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6K6i6ZiF5LiA5qyh44CC5o6l5pS25Yiw5LiA5qyh5raI5oGv5LmL5ZCO6Ieq5Yqo5Y+W5raI6K6i6ZiFXHJcbiAgICovXHJcbiAgb25jZSh0YXJnZXQ6IHN0cmluZywgdG9rZW5WYWx1ZTogc3RyaW5nLCBldmVudE5hbWU6IHN0cmluZywgY2FsbGVyOiBPYmplY3QsIGhhbmRsZXI6ICh2YWx1ZTogYW55KSA9PiB2b2lkKTogSURpc3Bvc2FibGUge1xyXG4gICAgcmV0dXJuIHRoaXMuZ2V0RXZlbnRQaXBlKGV2ZW50TmFtZSwgdGFyZ2V0LCB0b2tlblZhbHVlKS5zdWJzY3JpYmVPbmNlKGhhbmRsZXIsIGNhbGxlcik7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDlj5HpgIHkuIDkuKror7fmsYLkuovku7bvvIzojrflj5bnm5HlkKzogIXnmoTlk43lupTlubblpITnkIZcclxuICAgKi9cclxuICByZXF1ZXN0Rm9yKHRhcmdldDogc3RyaW5nLCB0b2tlblZhbHVlOiBzdHJpbmcsIHJlcXVlc3ROYW1lOiBzdHJpbmcsIHJlcXVlc3RWYWx1ZTogYW55LCBzdWNjZXNzOiAoYW55KSA9PiBhbnksIGZhaWw/OiAoc3RyaW5nKSA9PiBhbnkpIHtcclxuICAgIGNvbnN0IGV2ZW50UGlwZSA9IHRoaXMuZmluZEV4aXN0RXZlbnRQaXBlKHJlcXVlc3ROYW1lLCAnUmVxdWVzdFN1YmplY3QnLCB0b2tlblZhbHVlKTtcclxuICAgIGlmIChldmVudFBpcGUpIHtcclxuICAgICAgdGhpcy5vbmNlKHRhcmdldCwgdG9rZW5WYWx1ZSwgcmVxdWVzdE5hbWUsIHRoaXMsIChyZXNwb25zZSkgPT4ge1xyXG4gICAgICAgIGlmIChyZXNwb25zZS5zdGF0dXMgPT09ICdzdWNjZXNzJykge1xyXG4gICAgICAgICAgc3VjY2VzcyhyZXNwb25zZS5kYXRhKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgaWYgKGZhaWwpIHtcclxuICAgICAgICAgICAgZmFpbCgnTm8gdGFyZ2V0IHJlc3BvbnNlciBsaXN0ZW5pbmcnKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgICBldmVudFBpcGUucG9zdCh7IHRhcmdldDogdGFyZ2V0LCB0b2tlbjogdG9rZW5WYWx1ZSwgZGF0YTogcmVxdWVzdFZhbHVlIH0pO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgaWYgKGZhaWwpIHtcclxuICAgICAgICBmYWlsKCdObyB0YXJnZXQgcmVzcG9uc2VyIGxpc3RlbmluZy4nKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog55uR5ZCs5LiA5Liq6K+35rGC5LqL5Lu277yM57uZ5Ye65ZON5bqUXHJcbiAgICovXHJcbiAgcmVzcG9uc2VPbihyZXNwb25zZVN1YmplY3Q6IHN0cmluZywgcmVxdWVzdE5hbWU6IHN0cmluZywgY2FsbGJhY2s6IChhbnkpID0+IGFueSkge1xyXG4gICAgdGhpcy5vbignUmVxdWVzdFN1YmplY3QnLCBudWxsLCByZXF1ZXN0TmFtZSwgdGhpcywgKHJlcXVlc3RPYmopID0+IHtcclxuICAgICAgY29uc3QgcmVzcG9uc2UgPSB7IHN0YXR1czogJ2ZhaWwnLCBkYXRhOiBudWxsIH07XHJcbiAgICAgIGlmIChyZXNwb25zZVN1YmplY3QgPT09IHJlcXVlc3RPYmoudGFyZ2V0KSB7XHJcbiAgICAgICAgcmVzcG9uc2UuZGF0YSA9IGNhbGxiYWNrKHJlcXVlc3RPYmouZGF0YSk7XHJcbiAgICAgICAgcmVzcG9uc2Uuc3RhdHVzID0gJ3N1Y2Nlc3MnO1xyXG4gICAgICB9XHJcbiAgICAgIHRoaXMucG9zdChyZXF1ZXN0T2JqLnRhcmdldCwgcmVxdWVzdE9iai50b2tlbiwgcmVxdWVzdE5hbWUsIHJlc3BvbnNlKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXRFdmVudFBpcGUoZXZlbnROYW1lOiBzdHJpbmcsIHRhcmdldDogc3RyaW5nLCB0b2tlblZhbHVlOiBzdHJpbmcpIHtcclxuICAgIGxldCBldmVudFBpcGVMaXN0ID0gdGhpcy5ldmVudE1hcC5nZXQoZXZlbnROYW1lKTtcclxuICAgIGlmICghZXZlbnRQaXBlTGlzdCkge1xyXG4gICAgICBldmVudFBpcGVMaXN0ID0gbmV3IEFycmF5PEV2ZW50UGlwZT4oKTtcclxuICAgICAgdGhpcy5ldmVudE1hcC5zZXQoZXZlbnROYW1lLCBldmVudFBpcGVMaXN0KTtcclxuICAgIH1cclxuXHJcbiAgICAvLyAx44CB5LiA5Liq5LqL5Lu25LiN5YWB6K645aSa5Liq6K6i6ZiFXHJcbiAgICAvLyBsZXQgZXZlbnRQaXBlID0gZXZlbnRQaXBlTGlzdC5maW5kKGl0ZW0gPT4gaXRlbS5leGFtQnlUYXJnZXRUb2tlbih0YXJnZXQsIHRva2VuVmFsdWUpKTtcclxuICAgIC8vIGlmICghZXZlbnRQaXBlKSB7XHJcbiAgICAvLyAgIGV2ZW50UGlwZSA9IG5ldyBFdmVudFBpcGUoZXZlbnROYW1lLCB0b2tlblZhbHVlLCB0YXJnZXQsIGV2ZW50UGlwZUxpc3QpO1xyXG4gICAgLy8gfVxyXG5cclxuICAgIC8vIDLjgIHkuIDkuKrkuovku7blhYHorrjlpJrkuKrorqLpmIVcclxuICAgIGNvbnN0IGV2ZW50UGlwZSA9IG5ldyBFdmVudFBpcGUoZXZlbnROYW1lLCB0b2tlblZhbHVlLCB0YXJnZXQsIGV2ZW50UGlwZUxpc3QpO1xyXG5cclxuICAgIHJldHVybiBldmVudFBpcGU7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGZpbmRFeGlzdEV2ZW50UGlwZShldmVudE5hbWU6IHN0cmluZywgdGFyZ2V0OiBzdHJpbmcsIHRva2VuVmFsdWU6IHN0cmluZyk6IEV2ZW50UGlwZSB7XHJcbiAgICBjb25zdCBldmVudFBpcGVMaXN0ID0gdGhpcy5ldmVudE1hcC5nZXQoZXZlbnROYW1lKTtcclxuICAgIGlmICghZXZlbnRQaXBlTGlzdCkge1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuICAgIC8vIHJldHVybiBldmVudFBpcGVMaXN0LmZpbmQoaXRlbSA9PiBpdGVtLmV4YW1CeVRhcmdldFRva2VuKHRhcmdldCwgdG9rZW5WYWx1ZSkpO1xyXG4gICAgZm9yIChjb25zdCBldmVudFBpcGUgb2YgZXZlbnRQaXBlTGlzdCkge1xyXG4gICAgICBpZiAoZXZlbnRQaXBlLm1hdGNoRW1pdHRlclRva2VuKHRhcmdldCwgdG9rZW5WYWx1ZSkpIHtcclxuICAgICAgICByZXR1cm4gZXZlbnRQaXBlO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbnVsbDtcclxuICB9XHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBFdmVudENhY2hlIHtcclxuICBwcml2YXRlIHN0YXRpYyB0b2tlbnMgPSBuZXcgTWFwKCk7XHJcblxyXG4gIHB1YmxpYyBzdGF0aWMgc2V0VG9rZW4oa2V5OiBzdHJpbmcsIHZhbHVlOiBhbnkpIHtcclxuICAgIEV2ZW50Q2FjaGUudG9rZW5zLnNldChrZXksIHZhbHVlKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBzdGF0aWMgZ2V0VG9rZW4oa2V5OiBzdHJpbmcpIHtcclxuICAgIHJldHVybiBFdmVudENhY2hlLnRva2Vucy5nZXQoa2V5KTtcclxuICB9XHJcbn1cclxuXHJcbmNsYXNzIFJlcXVlc3RTdWJqZWN0IHsgfVxyXG5jbGFzcyBEYXRhQ2xhc3MgeyB9XHJcbiJdfQ==