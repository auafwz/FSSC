/*
 * @Author: 疯狂秀才(lucas huang)
 * @Date: 2018-11-07 16:31:57
 * @LastEditors: 疯狂秀才(Lucas Huang)
 * @LastEditTime: 2019-09-27 14:57:22
 * @Company: Inspur
 * @Version: v0.0.1
 */
import * as tslib_1 from "tslib";
/**
 * 使用方法：
 * [data-mapping]="{ id: 'user.userId', name: 'user.userName' }"
 * key 为帮助上的字段， value 为 表单中的字段名
 * 帮助上的同一个字段可以映射到表单中的多个字段中，{ ... id: 'user.userid, user.addusid'}
 * 多字段以逗号隔开
 *
 */
import { Directive, Optional, Self, Input } from '@angular/core';
import { BindingObject, ViewModel } from '@farris/devkit';
import { LookupGridComponent } from '@farris/ui-lookup';
import { isNumber } from 'lodash-es';
var LookupDataMappingDirective = /** @class */ (function () {
    function LookupDataMappingDirective(vm, lookup) {
        this.vm = vm;
        this.lookup = lookup;
        this.target = null;
    }
    LookupDataMappingDirective.prototype.ngOnInit = function () {
        var _this = this;
        this.lookup.selectedData.subscribe(function (data) {
            var _mapfields = _this.mapfields || _this.lookup.mapFields;
            _this.mappingData(data, _mapfields);
        });
        this.lookup.clear.subscribe(function () {
            var _mapfields = _this.mapfields || _this.lookup.mapFields;
            _this.mappingData(null, _mapfields);
        });
    };
    /**
     *
     * @param helpData 清空时，值为null
     * @param mapFields 格式形如：{id: "assoField.assoField", code: "assoField.assoField_Code", name: "assoField.assoField_Name"}
     */
    LookupDataMappingDirective.prototype.mappingData = function (helpData, mapFields) {
        if (!mapFields) {
            return;
        }
        // 关闭变更检测
        var appContext = this.vm.frameContext.appContext;
        appContext.changeDetectionController.detach();
        var helpFields = Object.keys(mapFields);
        var basePaths;
        // 映射到目标主键的源字段数组
        var primaryKeys;
        // 目标主键字段数组
        var primaryFields;
        basePaths = this.getBindingPathArray();
        var primaryInfo = this.getMapFieldsPrimaryKey(mapFields, basePaths);
        primaryKeys = primaryInfo && primaryInfo.map(function (item) { return item.primaryKey; }) || [];
        primaryFields = primaryInfo && primaryInfo.map(function (item) { return item.primaryField; }) || [];
        // 对映射中的key进行排序，使映射到目标主键的key排到前面
        helpFields = this.sortMapFieldKeys(helpFields, primaryKeys);
        if (!helpData) {
            helpFields.reverse();
        }
        this.mapping(helpFields, mapFields, helpData, primaryFields, basePaths);
        // 重新打开变更检测
        appContext.changeDetectionController.reattach();
    };
    LookupDataMappingDirective.prototype.mapping = function (sortedKeyFields, mapFields, helpData, targetPrimaryFields, basePaths) {
        var _this = this;
        sortedKeyFields.forEach(function (field) {
            var val = _this.getHelpValue(field, helpData);
            var mappings = mapFields[field].split(',');
            var headMappings = mappings.filter(function (p) { return targetPrimaryFields.includes(p); });
            var leftMappings = mappings.filter(function (p) { return !targetPrimaryFields.includes(p); });
            if (!helpData) {
                mappings = [].concat(leftMappings).concat(headMappings);
            }
            else {
                mappings = [].concat(headMappings).concat(leftMappings);
            }
            _this.updateTarget(mappings, basePaths, helpData, val);
        });
    };
    LookupDataMappingDirective.prototype.updateTarget = function (mappings, basePaths, helpData, value) {
        var _this = this;
        mappings.forEach(function (targetFieldPath) {
            _this.updateTargetValue(basePaths, targetFieldPath, value, helpData);
        });
    };
    LookupDataMappingDirective.prototype.updateTargetValue = function (basePaths, targetFieldPath, value, helpData) {
        if (this.target) {
            var paths = targetFieldPath.split('.');
            this.setValue(this.target, paths, value);
        }
        else {
            var paths = basePaths.concat(targetFieldPath.split('.'));
            if (!helpData) {
                this.vm.bindingData.clearValue(paths, true, true, { frameContext: this.vm.frameContext });
            }
            else {
                this.vm.bindingData.setValue(paths, value, true, true, null, { frameContext: this.vm.frameContext });
            }
        }
    };
    /**
     * 获取帮助字段对应的值
     * @param field 帮助字段
     * @param helpData 帮助数据
     * @returns
     */
    LookupDataMappingDirective.prototype.getHelpValue = function (field, helpData) {
        var _this = this;
        var value = '';
        if (helpData) {
            if (helpData instanceof Array) {
                value = helpData.map(function (item) {
                    return _this.getValue(field, item);
                }).join(',');
            }
            else {
                value = this.getValue(field, helpData);
            }
        }
        return value;
    };
    LookupDataMappingDirective.prototype.getValue = function (f, data) {
        var val = '';
        if (f.indexOf('.') === -1) {
            val = data[f];
        }
        else {
            val = f.split('.').reduce(function (a, b) {
                return a[b];
            }, data);
        }
        return val;
    };
    LookupDataMappingDirective.prototype.setValue = function (target, paths, value) {
        if (target) {
            if (paths.length <= 1) {
                target[paths[0]] = value;
            }
            else {
                paths.slice(0, -1).reduce(function (prev, path) {
                    if (!(prev.hasOwnProperty(path) || prev['__proto__'].hasOwnProperty(path))) {
                        prev[path] = {};
                    }
                    return prev[path];
                }, target)[paths[paths.length - 1]] = value;
            }
        }
    };
    LookupDataMappingDirective.prototype.getBindingPathArray = function () {
        var path = this.vm.bindingPath;
        if (path) {
            return path.split('/').filter(function (n) { return n !== ''; });
        }
        return [];
    };
    LookupDataMappingDirective.prototype.isNumberValue = function (field, data) {
        var currentVal = this.getValue(field, data);
        return isNumber(currentVal);
    };
    /**
     *
     * @param mapFields  格式形如：{id: "assoField.assoField", code: "assoField.assoField_Code", name: "assoField.assoField_Name"} 或者 {id:'vid',code:'code',name:'name'}
     */
    LookupDataMappingDirective.prototype.getMapFieldsPrimaryKey = function (mapFields, bindingPaths) {
        if (!mapFields || Object.keys(mapFields).length < 1) {
            return null;
        }
        var results = [];
        // let primaryField = null;
        try {
            var entityTypeInfo_1 = this.vm.frameContext.repository.entityTypeInfo;
            Object.keys(mapFields).forEach(function (key) {
                var mapField = mapFields[key];
                if (mapField && typeof mapField === 'string') {
                    var mappings = mapField.split(',').filter(function (p) { return p; });
                    mappings.forEach(function (item) {
                        var paths = item.split('.');
                        if (bindingPaths && bindingPaths.length > 0) {
                            paths = bindingPaths.concat(paths);
                        }
                        var propInfo = entityTypeInfo_1.getPropInfoByPath(paths);
                        if (propInfo && propInfo.metadataInfo && propInfo.metadataInfo.primary === true) {
                            results.push({
                                primaryKey: key,
                                primaryField: item
                            });
                        }
                    });
                }
            });
        }
        catch (e) {
            console.error(e);
        }
        return results;
    };
    LookupDataMappingDirective.prototype.sortMapFieldKeys = function (keys, primaryKeys) {
        if (!primaryKeys || primaryKeys.length < 1 || !keys || keys.length < 1) {
            return keys;
        }
        primaryKeys = tslib_1.__spread(new Set(primaryKeys));
        // 过滤出非主键映射字段
        keys = keys.filter(function (p) { return !primaryKeys.includes(p); });
        return [].concat(primaryKeys).concat(keys);
    };
    LookupDataMappingDirective.decorators = [
        { type: Directive, args: [{ selector: '[data-mapping]' },] }
    ];
    /** @nocollapse */
    LookupDataMappingDirective.ctorParameters = function () { return [
        { type: ViewModel, decorators: [{ type: Optional }] },
        { type: LookupGridComponent, decorators: [{ type: Optional }, { type: Self }] }
    ]; };
    LookupDataMappingDirective.propDecorators = {
        mapfields: [{ type: Input, args: ['data-mapping',] }],
        target: [{ type: Input, args: ['target',] }]
    };
    return LookupDataMappingDirective;
}());
export { LookupDataMappingDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9va3VwLWRhdGEtbWFwcGluZy5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2tlbmRvLWJpbmRpbmcvIiwic291cmNlcyI6WyJsaWIvZGlyZWN0aXZlcy9sb29rdXAtZGF0YS1tYXBwaW5nLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7OztHQU9HOztBQUVIOzs7Ozs7O0dBT0c7QUFFSCxPQUFPLEVBQUUsU0FBUyxFQUFVLFFBQVEsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3pFLE9BQU8sRUFBRSxhQUFhLEVBQThCLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3RGLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ3hELE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFFckM7SUFNRSxvQ0FBZ0MsRUFBYSxFQUE4QixNQUEyQjtRQUF0RSxPQUFFLEdBQUYsRUFBRSxDQUFXO1FBQThCLFdBQU0sR0FBTixNQUFNLENBQXFCO1FBRnJGLFdBQU0sR0FBa0IsSUFBSSxDQUFDO0lBRTRELENBQUM7SUFFM0csNkNBQVEsR0FBUjtRQUFBLGlCQVVDO1FBVEMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDLFVBQUMsSUFBUztZQUMzQyxJQUFNLFVBQVUsR0FBRyxLQUFJLENBQUMsU0FBUyxJQUFJLEtBQUksQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDO1lBQzNELEtBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxFQUFFLFVBQVUsQ0FBQyxDQUFDO1FBQ3JDLENBQUMsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDO1lBQzFCLElBQU0sVUFBVSxHQUFHLEtBQUksQ0FBQyxTQUFTLElBQUksS0FBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUM7WUFDM0Qs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Q0FBQzt5QkFDSjtvQkFDSCxDQUFDLENBQUMsQ0FBQztpQkFDSjtZQUNILENBQUMsQ0FBQyxDQUFDO1NBQ0o7UUFBQyxPQUFPLENBQUMsRUFBRTtZQUNWLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDbEI7UUFDRCxPQUFPLE9BQU8sQ0FBQztJQUNqQixDQUFDO0lBQ08scURBQWdCLEdBQXhCLFVBQXlCLElBQWMsRUFBRSxXQUFxQjtRQUM1RCxJQUFJLENBQUMsV0FBVyxJQUFJLFdBQVcsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQ3RFLE9BQU8sSUFBSSxDQUFDO1NBQ2I7UUFDRCxXQUFXLG9CQUFPLElBQUksR0FBRyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUM7UUFDeEMsYUFBYTtRQUNiLElBQUksR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQUEsQ0FBQyxJQUFJLE9BQUEsQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxFQUF4QixDQUF3QixDQUFDLENBQUM7UUFDbEQsT0FBTyxFQUFFLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUM3QyxDQUFDOztnQkF4TEYsU0FBUyxTQUFDLEVBQUUsUUFBUSxFQUFFLGdCQUFnQixFQUFFOzs7O2dCQUpXLFNBQVMsdUJBVTlDLFFBQVE7Z0JBVGQsbUJBQW1CLHVCQVNzQixRQUFRLFlBQUksSUFBSTs7OzRCQUgvRCxLQUFLLFNBQUMsY0FBYzt5QkFDcEIsS0FBSyxTQUFDLFFBQVE7O0lBcUxqQixpQ0FBQztDQUFBLEFBekxELElBeUxDO1NBeExZLDBCQUEwQiIsInNvdXJjZXNDb250ZW50IjpbIi8qXHJcbiAqIEBBdXRob3I6IOeWr+eLguengOaJjShsdWNhcyBodWFuZylcclxuICogQERhdGU6IDIwMTgtMTEtMDcgMTY6MzE6NTdcclxuICogQExhc3RFZGl0b3JzOiDnlq/ni4Lnp4DmiY0oTHVjYXMgSHVhbmcpXHJcbiAqIEBMYXN0RWRpdFRpbWU6IDIwMTktMDktMjcgMTQ6NTc6MjJcclxuICogQENvbXBhbnk6IEluc3B1clxyXG4gKiBAVmVyc2lvbjogdjAuMC4xXHJcbiAqL1xyXG5cclxuLyoqXHJcbiAqIOS9v+eUqOaWueazle+8mlxyXG4gKiBbZGF0YS1tYXBwaW5nXT1cInsgaWQ6ICd1c2VyLnVzZXJJZCcsIG5hbWU6ICd1c2VyLnVzZXJOYW1lJyB9XCJcclxuICoga2V5IOS4uuW4ruWKqeS4iueahOWtl+aute+8jCB2YWx1ZSDkuLog6KGo5Y2V5Lit55qE5a2X5q615ZCNXHJcbiAqIOW4ruWKqeS4iueahOWQjOS4gOS4quWtl+auteWPr+S7peaYoOWwhOWIsOihqOWNleS4reeahOWkmuS4quWtl+auteS4re+8jHsgLi4uIGlkOiAndXNlci51c2VyaWQsIHVzZXIuYWRkdXNpZCd9XHJcbiAqIOWkmuWtl+auteS7pemAl+WPt+malOW8gFxyXG4gKlxyXG4gKi9cclxuXHJcbmltcG9ydCB7IERpcmVjdGl2ZSwgT25Jbml0LCBPcHRpb25hbCwgU2VsZiwgSW5wdXQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgQmluZGluZ09iamVjdCwgRGF0YVByb3BJbmZvLCBEYXRhVHlwZUluZm8sIFZpZXdNb2RlbCB9IGZyb20gJ0BmYXJyaXMvZGV2a2l0JztcclxuaW1wb3J0IHsgTG9va3VwR3JpZENvbXBvbmVudCB9IGZyb20gJ0BmYXJyaXMvdWktbG9va3VwJztcclxuaW1wb3J0IHsgaXNOdW1iZXIgfSBmcm9tICdsb2Rhc2gtZXMnO1xyXG5cclxuQERpcmVjdGl2ZSh7IHNlbGVjdG9yOiAnW2RhdGEtbWFwcGluZ10nIH0pXHJcbmV4cG9ydCBjbGFzcyBMb29rdXBEYXRhTWFwcGluZ0RpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uSW5pdCB7XHJcblxyXG4gIEBJbnB1dCgnZGF0YS1tYXBwaW5nJykgbWFwZmllbGRzOiBhbnk7XHJcbiAgQElucHV0KCd0YXJnZXQnKSB0YXJnZXQ6IEJpbmRpbmdPYmplY3QgPSBudWxsO1xyXG5cclxuICBjb25zdHJ1Y3RvcihAT3B0aW9uYWwoKSBwcml2YXRlIHZtOiBWaWV3TW9kZWwsIEBPcHRpb25hbCgpIEBTZWxmKCkgcHJpdmF0ZSBsb29rdXA6IExvb2t1cEdyaWRDb21wb25lbnQpIHsgfVxyXG5cclxuICBuZ09uSW5pdCgpIHtcclxuICAgIHRoaXMubG9va3VwLnNlbGVjdGVkRGF0YS5zdWJzY3JpYmUoKGRhdGE6IGFueSkgPT4ge1xyXG4gICAgICBjb25zdCBfbWFwZmllbGRzID0gdGhpcy5tYXBmaWVsZHMgfHwgdGhpcy5sb29rdXAubWFwRmllbGRzO1xyXG4gICAgICB0aGlzLm1hcHBpbmdEYXRhKGRhdGEsIF9tYXBmaWVsZHMpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgdGhpcy5sb29rdXAuY2xlYXIuc3Vic2NyaWJlKCgpID0+IHtcclxuICAgICAgY29uc3QgX21hcGZpZWxkcyA9IHRoaXMubWFwZmllbGRzIHx8IHRoaXMubG9va3VwLm1hcEZpZWxkcztcclxuICAgICAgdGhpcy5tYXBwaW5nRGF0YShudWxsLCBfbWFwZmllbGRzKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogXHJcbiAgICogQHBhcmFtIGhlbHBEYXRhIOa4heepuuaXtu+8jOWAvOS4um51bGxcclxuICAgKiBAcGFyYW0gbWFwRmllbGRzIOagvOW8j+W9ouWmgu+8mntpZDogXCJhc3NvRmllbGQuYXNzb0ZpZWxkXCIsIGNvZGU6IFwiYXNzb0ZpZWxkLmFzc29GaWVsZF9Db2RlXCIsIG5hbWU6IFwiYXNzb0ZpZWxkLmFzc29GaWVsZF9OYW1lXCJ9XHJcbiAgICovXHJcbiAgbWFwcGluZ0RhdGEoaGVscERhdGE6IGFueSwgbWFwRmllbGRzOiBhbnkpIHtcclxuICAgIGlmICghbWFwRmllbGRzKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIC8vIOWFs+mXreWPmOabtOajgOa1i1xyXG4gICAgY29uc3QgYXBwQ29udGV4dCA9IHRoaXMudm0uZnJhbWVDb250ZXh0LmFwcENvbnRleHQ7XHJcbiAgICBhcHBDb250ZXh0LmNoYW5nZURldGVjdGlvbkNvbnRyb2xsZXIuZGV0YWNoKCk7XHJcbiAgICBsZXQgaGVscEZpZWxkcyA9IE9iamVjdC5rZXlzKG1hcEZpZWxkcyk7XHJcbiAgICBsZXQgYmFzZVBhdGhzOiBhbnlbXTtcclxuICAgIC8vIOaYoOWwhOWIsOebruagh+S4u+mUrueahOa6kOWtl+auteaVsOe7hFxyXG4gICAgbGV0IHByaW1hcnlLZXlzOiBzdHJpbmdbXTtcclxuICAgIC8vIOebruagh+S4u+mUruWtl+auteaVsOe7hFxyXG4gICAgbGV0IHByaW1hcnlGaWVsZHM6IHN0cmluZ1tdO1xyXG4gICAgYmFzZVBhdGhzID0gdGhpcy5nZXRCaW5kaW5nUGF0aEFycmF5KCk7XHJcbiAgICBjb25zdCBwcmltYXJ5SW5mbyA9IHRoaXMuZ2V0TWFwRmllbGRzUHJpbWFyeUtleShtYXBGaWVsZHMsIGJhc2VQYXRocyk7XHJcbiAgICBwcmltYXJ5S2V5cyA9IHByaW1hcnlJbmZvICYmIHByaW1hcnlJbmZvLm1hcChpdGVtID0+IGl0ZW0ucHJpbWFyeUtleSkgfHwgW107XHJcbiAgICBwcmltYXJ5RmllbGRzID0gcHJpbWFyeUluZm8gJiYgcHJpbWFyeUluZm8ubWFwKGl0ZW0gPT4gaXRlbS5wcmltYXJ5RmllbGQpIHx8IFtdO1xyXG4gICAgLy8g5a+55pig5bCE5Lit55qEa2V56L+b6KGM5o6S5bqP77yM5L2/5pig5bCE5Yiw55uu5qCH5Li76ZSu55qEa2V55o6S5Yiw5YmN6Z2iXHJcbiAgICBoZWxwRmllbGRzID0gdGhpcy5zb3J0TWFwRmllbGRLZXlzKGhlbHBGaWVsZHMsIHByaW1hcnlLZXlzKTtcclxuICAgIGlmICghaGVscERhdGEpIHtcclxuICAgICAgaGVscEZpZWxkcy5yZXZlcnNlKCk7XHJcbiAgICB9XHJcbiAgICB0aGlzLm1hcHBpbmcoaGVscEZpZWxkcywgbWFwRmllbGRzLCBoZWxwRGF0YSwgcHJpbWFyeUZpZWxkcywgYmFzZVBhdGhzKTtcclxuICAgIC8vIOmHjeaWsOaJk+W8gOWPmOabtOajgOa1i1xyXG4gICAgYXBwQ29udGV4dC5jaGFuZ2VEZXRlY3Rpb25Db250cm9sbGVyLnJlYXR0YWNoKCk7XHJcbiAgfVxyXG4gIHByaXZhdGUgbWFwcGluZyhzb3J0ZWRLZXlGaWVsZHM6IHN0cmluZ1tdLCBtYXBGaWVsZHM6IGFueSwgaGVscERhdGE6IGFueSwgdGFyZ2V0UHJpbWFyeUZpZWxkczogc3RyaW5nW10sIGJhc2VQYXRoczogc3RyaW5nW10pIHtcclxuICAgIHNvcnRlZEtleUZpZWxkcy5mb3JFYWNoKChmaWVsZDogYW55KSA9PiB7XHJcbiAgICAgIGNvbnN0IHZhbCA9IHRoaXMuZ2V0SGVscFZhbHVlKGZpZWxkLCBoZWxwRGF0YSk7XHJcbiAgICAgIGxldCBtYXBwaW5nczogYW55W10gPSBtYXBGaWVsZHNbZmllbGRdLnNwbGl0KCcsJyk7XHJcbiAgICAgIGNvbnN0IGhlYWRNYXBwaW5ncyA9IG1hcHBpbmdzLmZpbHRlcihwID0+IHRhcmdldFByaW1hcnlGaWVsZHMuaW5jbHVkZXMocCkpO1xyXG4gICAgICBjb25zdCBsZWZ0TWFwcGluZ3MgPSBtYXBwaW5ncy5maWx0ZXIocCA9PiAhdGFyZ2V0UHJpbWFyeUZpZWxkcy5pbmNsdWRlcyhwKSk7XHJcbiAgICAgIGlmICghaGVscERhdGEpIHtcclxuICAgICAgICBtYXBwaW5ncyA9IFtdLmNvbmNhdChsZWZ0TWFwcGluZ3MpLmNvbmNhdChoZWFkTWFwcGluZ3MpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIG1hcHBpbmdzID0gW10uY29uY2F0KGhlYWRNYXBwaW5ncykuY29uY2F0KGxlZnRNYXBwaW5ncyk7XHJcbiAgICAgIH1cclxuICAgICAgdGhpcy51cGRhdGVUYXJnZXQobWFwcGluZ3MsIGJhc2VQYXRocywgaGVscERhdGEsIHZhbCk7XHJcbiAgICB9KTtcclxuICB9XHJcbiAgcHJpdmF0ZSB1cGRhdGVUYXJnZXQobWFwcGluZ3M6IHN0cmluZ1tdLCBiYXNlUGF0aHM6IHN0cmluZ1tdLCBoZWxwRGF0YTogYW55LCB2YWx1ZTogYW55KSB7XHJcbiAgICBtYXBwaW5ncy5mb3JFYWNoKCh0YXJnZXRGaWVsZFBhdGg6IGFueSkgPT4ge1xyXG4gICAgICB0aGlzLnVwZGF0ZVRhcmdldFZhbHVlKGJhc2VQYXRocywgdGFyZ2V0RmllbGRQYXRoLCB2YWx1ZSwgaGVscERhdGEpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG4gIHByaXZhdGUgdXBkYXRlVGFyZ2V0VmFsdWUoYmFzZVBhdGhzOiBzdHJpbmdbXSwgdGFyZ2V0RmllbGRQYXRoLCB2YWx1ZTogYW55LCBoZWxwRGF0YTogYW55KSB7XHJcbiAgICBpZiAodGhpcy50YXJnZXQpIHtcclxuICAgICAgY29uc3QgcGF0aHMgPSB0YXJnZXRGaWVsZFBhdGguc3BsaXQoJy4nKTtcclxuICAgICAgdGhpcy5zZXRWYWx1ZSh0aGlzLnRhcmdldCwgcGF0aHMsIHZhbHVlKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGNvbnN0IHBhdGhzID0gYmFzZVBhdGhzLmNvbmNhdCh0YXJnZXRGaWVsZFBhdGguc3BsaXQoJy4nKSk7XHJcbiAgICAgIGlmICghaGVscERhdGEpIHtcclxuICAgICAgICB0aGlzLnZtLmJpbmRpbmdEYXRhLmNsZWFyVmFsdWUocGF0aHMsIHRydWUsIHRydWUsIHsgZnJhbWVDb250ZXh0OiB0aGlzLnZtLmZyYW1lQ29udGV4dCB9KTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICB0aGlzLnZtLmJpbmRpbmdEYXRhLnNldFZhbHVlKHBhdGhzLCB2YWx1ZSwgdHJ1ZSwgdHJ1ZSwgbnVsbCwgeyBmcmFtZUNvbnRleHQ6IHRoaXMudm0uZnJhbWVDb250ZXh0IH0pO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluW4ruWKqeWtl+auteWvueW6lOeahOWAvFxyXG4gICAqIEBwYXJhbSBmaWVsZCDluK7liqnlrZfmrrVcclxuICAgKiBAcGFyYW0gaGVscERhdGEg5biu5Yqp5pWw5o2uXHJcbiAgICogQHJldHVybnMgXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXRIZWxwVmFsdWUoZmllbGQ6IHN0cmluZywgaGVscERhdGE6IGFueSkge1xyXG4gICAgbGV0IHZhbHVlOiBhbnkgPSAnJztcclxuICAgIGlmIChoZWxwRGF0YSkge1xyXG4gICAgICBpZiAoaGVscERhdGEgaW5zdGFuY2VvZiBBcnJheSkge1xyXG4gICAgICAgIHZhbHVlID0gaGVscERhdGEubWFwKChpdGVtOiBhbnkpID0+IHtcclxuICAgICAgICAgIHJldHVybiB0aGlzLmdldFZhbHVlKGZpZWxkLCBpdGVtKTtcclxuICAgICAgICB9KS5qb2luKCcsJyk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdmFsdWUgPSB0aGlzLmdldFZhbHVlKGZpZWxkLCBoZWxwRGF0YSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiB2YWx1ZTtcclxuICB9XHJcbiAgcHJpdmF0ZSBnZXRWYWx1ZShmOiBzdHJpbmcsIGRhdGE6IGFueSkge1xyXG4gICAgbGV0IHZhbCA9ICcnO1xyXG4gICAgaWYgKGYuaW5kZXhPZignLicpID09PSAtMSkge1xyXG4gICAgICB2YWwgPSBkYXRhW2ZdO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdmFsID0gZi5zcGxpdCgnLicpLnJlZHVjZSgoYSwgYikgPT4ge1xyXG4gICAgICAgIHJldHVybiBhW2JdO1xyXG4gICAgICB9LCBkYXRhKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gdmFsO1xyXG4gIH1cclxuICBwcml2YXRlIHNldFZhbHVlKHRhcmdldDogb2JqZWN0LCBwYXRoczogc3RyaW5nW10sIHZhbHVlOiBhbnkpIHtcclxuICAgIGlmICh0YXJnZXQpIHtcclxuICAgICAgaWYgKHBhdGhzLmxlbmd0aCA8PSAxKSB7XHJcbiAgICAgICAgdGFyZ2V0W3BhdGhzWzBdXSA9IHZhbHVlO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHBhdGhzLnNsaWNlKDAsIC0xKS5yZWR1Y2UoKHByZXYsIHBhdGgpID0+IHtcclxuICAgICAgICAgIGlmICghKHByZXYuaGFzT3duUHJvcGVydHkocGF0aCkgfHwgcHJldlsnX19wcm90b19fJ10uaGFzT3duUHJvcGVydHkocGF0aCkpKSB7XHJcbiAgICAgICAgICAgIHByZXZbcGF0aF0gPSB7fTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIHJldHVybiBwcmV2W3BhdGhdO1xyXG4gICAgICAgIH0sIHRhcmdldClbcGF0aHNbcGF0aHMubGVuZ3RoIC0gMV1dID0gdmFsdWU7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcbiAgcHJpdmF0ZSBnZXRCaW5kaW5nUGF0aEFycmF5KCk6IGFueVtdIHtcclxuICAgIGNvbnN0IHBhdGggPSB0aGlzLnZtLmJpbmRpbmdQYXRoO1xyXG4gICAgaWYgKHBhdGgpIHtcclxuICAgICAgcmV0dXJuIHBhdGguc3BsaXQoJy8nKS5maWx0ZXIobiA9PiBuICE9PSAnJyk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gW107XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGlzTnVtYmVyVmFsdWUoZmllbGQsIGRhdGEpIHtcclxuICAgIGNvbnN0IGN1cnJlbnRWYWwgPSB0aGlzLmdldFZhbHVlKGZpZWxkLCBkYXRhKTtcclxuICAgIHJldHVybiBpc051bWJlcihjdXJyZW50VmFsKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICogXHJcbiAgICogQHBhcmFtIG1hcEZpZWxkcyAg5qC85byP5b2i5aaC77yae2lkOiBcImFzc29GaWVsZC5hc3NvRmllbGRcIiwgY29kZTogXCJhc3NvRmllbGQuYXNzb0ZpZWxkX0NvZGVcIiwgbmFtZTogXCJhc3NvRmllbGQuYXNzb0ZpZWxkX05hbWVcIn0g5oiW6ICFIHtpZDondmlkJyxjb2RlOidjb2RlJyxuYW1lOiduYW1lJ31cclxuICAgKi9cclxuICBwcml2YXRlIGdldE1hcEZpZWxkc1ByaW1hcnlLZXkobWFwRmllbGRzOiBhbnksIGJpbmRpbmdQYXRoczogc3RyaW5nW10pOiBBcnJheTx7IHByaW1hcnlLZXk6IHN0cmluZywgcHJpbWFyeUZpZWxkOiBzdHJpbmcgfT4ge1xyXG4gICAgaWYgKCFtYXBGaWVsZHMgfHwgT2JqZWN0LmtleXMobWFwRmllbGRzKS5sZW5ndGggPCAxKSB7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gICAgY29uc3QgcmVzdWx0cyA9IFtdO1xyXG4gICAgLy8gbGV0IHByaW1hcnlGaWVsZCA9IG51bGw7XHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zdCBlbnRpdHlUeXBlSW5mbzogRGF0YVR5cGVJbmZvID0gdGhpcy52bS5mcmFtZUNvbnRleHQucmVwb3NpdG9yeS5lbnRpdHlUeXBlSW5mbztcclxuICAgICAgT2JqZWN0LmtleXMobWFwRmllbGRzKS5mb3JFYWNoKChrZXk6IHN0cmluZykgPT4ge1xyXG4gICAgICAgIGNvbnN0IG1hcEZpZWxkID0gbWFwRmllbGRzW2tleV07XHJcbiAgICAgICAgaWYgKG1hcEZpZWxkICYmIHR5cGVvZiBtYXBGaWVsZCA9PT0gJ3N0cmluZycpIHtcclxuICAgICAgICAgIGNvbnN0IG1hcHBpbmdzID0gbWFwRmllbGQuc3BsaXQoJywnKS5maWx0ZXIocCA9PiBwKTtcclxuICAgICAgICAgIG1hcHBpbmdzLmZvckVhY2goKGl0ZW06IHN0cmluZykgPT4ge1xyXG4gICAgICAgICAgICBsZXQgcGF0aHMgPSBpdGVtLnNwbGl0KCcuJyk7XHJcbiAgICAgICAgICAgIGlmIChiaW5kaW5nUGF0aHMgJiYgYmluZGluZ1BhdGhzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICBwYXRocyA9IGJpbmRpbmdQYXRocy5jb25jYXQocGF0aHMpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNvbnN0IHByb3BJbmZvOiBEYXRhUHJvcEluZm8gPSBlbnRpdHlUeXBlSW5mby5nZXRQcm9wSW5mb0J5UGF0aChwYXRocyk7XHJcbiAgICAgICAgICAgIGlmIChwcm9wSW5mbyAmJiBwcm9wSW5mby5tZXRhZGF0YUluZm8gJiYgcHJvcEluZm8ubWV0YWRhdGFJbmZvLnByaW1hcnkgPT09IHRydWUpIHtcclxuICAgICAgICAgICAgICByZXN1bHRzLnB1c2goe1xyXG4gICAgICAgICAgICAgICAgcHJpbWFyeUtleToga2V5LFxyXG4gICAgICAgICAgICAgICAgcHJpbWFyeUZpZWxkOiBpdGVtXHJcbiAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoZSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcmVzdWx0cztcclxuICB9XHJcbiAgcHJpdmF0ZSBzb3J0TWFwRmllbGRLZXlzKGtleXM6IHN0cmluZ1tdLCBwcmltYXJ5S2V5czogc3RyaW5nW10pOiBzdHJpbmdbXSB7XHJcbiAgICBpZiAoIXByaW1hcnlLZXlzIHx8IHByaW1hcnlLZXlzLmxlbmd0aCA8IDEgfHwgIWtleXMgfHwga2V5cy5sZW5ndGggPCAxKSB7XHJcbiAgICAgIHJldHVybiBrZXlzO1xyXG4gICAgfVxyXG4gICAgcHJpbWFyeUtleXMgPSBbLi4ubmV3IFNldChwcmltYXJ5S2V5cyldO1xyXG4gICAgLy8g6L+H5ruk5Ye66Z2e5Li76ZSu5pig5bCE5a2X5q61XHJcbiAgICBrZXlzID0ga2V5cy5maWx0ZXIocCA9PiAhcHJpbWFyeUtleXMuaW5jbHVkZXMocCkpO1xyXG4gICAgcmV0dXJuIFtdLmNvbmNhdChwcmltYXJ5S2V5cykuY29uY2F0KGtleXMpO1xyXG4gIH1cclxufVxyXG4iXX0=