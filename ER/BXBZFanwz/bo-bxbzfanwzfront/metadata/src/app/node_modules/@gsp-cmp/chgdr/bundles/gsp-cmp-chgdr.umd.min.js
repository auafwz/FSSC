!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/common"),require("@angular/forms"),require("@farris/ui-splitter"),require("@farris/ui-draggable"),require("@farris/ui-datagrid"),require("@farris/ui-treetable"),require("@farris/ui-section"),require("@farris/ui-dialog"),require("@farris/ui-datepicker"),require("@gsp-lcm/metadatart-selector"),require("date-fns"),require("@gsp-bef/gsp-cm-metadata"),require("@angular/common/locales/zh"),require("@ecp-caf/caf-common"),require("@farris/ui-modal"),require("@angular/core"),require("@farris/ui-messager"),require("@farris/ui-notify"),require("rxjs/operators"),require("rxjs")):"function"==typeof define&&define.amd?define("@gsp-cmp/chgdr",["exports","@angular/common","@angular/forms","@farris/ui-splitter","@farris/ui-draggable","@farris/ui-datagrid","@farris/ui-treetable","@farris/ui-section","@farris/ui-dialog","@farris/ui-datepicker","@gsp-lcm/metadatart-selector","date-fns","@gsp-bef/gsp-cm-metadata","@angular/common/locales/zh","@ecp-caf/caf-common","@farris/ui-modal","@angular/core","@farris/ui-messager","@farris/ui-notify","rxjs/operators","rxjs"],t):t((e["gsp-cmp"]=e["gsp-cmp"]||{},e["gsp-cmp"].chgdr={}),e.ng.common,e.ng.forms,e.uiSplitter,e.uiDraggable,e.uiDatagrid,e.uiTreetable,e.uiSection,e.uiDialog,e.uiDatepicker,e.i2,e.dateFns,e.gspCmMetadata,e.ng.common.locales.zh,e.i1,e.i1$1,e.ng.core,e.i2$1,e.uiNotify,e.rxjs.operators,e.rxjs)}(this,function(e,t,r,a,n,i,o,d,s,c,l,u,p,h,f,g,y,m,v,C,b){"use strict";h=h&&h.hasOwnProperty("default")?h["default"]:h;var w=function ve(){},I=function Ce(){},S=function be(){},D=function we(){this.children=[]},M=function Ie(){},T=(x.prototype.buildChgdrData=function(e,t){var o=this;this.handler=t;var a=new w;a.entityName=this.handler.getBeName(),a.operateType=e.operateType,a.userName=e.userName,a.dataId=e.dataId,a.dataCode=e.dataCode,a.dataCodes=this.buildDataCodes(e.dataCode,this.handler.getMainObjectCode()),a.reason=e.reason,a.changeTime=e.changeTime,a.entityNodes=[];var d=[];e.rows&&e.rows.forEach(function(n){if(n){var e=new S;e.id=n.id,e.parentDataId=n.parentDataId,e.dataId=n.dataId,e.dataCode=n.dataCode,e.dataCodes=o.buildDataCodes(n.dataCode,n.entityCode),e.entityCode=n.entityCode,e.entityName=o.handler.getEntityNameOrDefault(n.entityCode),e.operateType=n.operateType,e.entityNodes=[];var t=o.extractChangeColumnKeys(n),i=[];t.forEach(function(e){var t=new D;t.fieldLabel=e,t.fieldName=o.handler.getEntityFieldNameOrDefault(n.entityCode,e),t.oldValue=o.handler.formatFieldValue(n.oldContent.get(e),n.entityCode,e),t.newValue=o.handler.formatFieldValue(n.newContent.get(e),n.entityCode,e);var r=o.handler.getElement(n.entityCode,e);if(r){t.hasAssociation="Association"==r.ObjectType&&0==r.IsUdt,t.isAssociationRefField=r.IsRefElement;var a=o.handler.getParentElement(n.entityCode,e);a&&(t.belongFieldLabelId=a.LabelID)}i.push(t)}),o.handler.sort(i,n.entityCode,function(e){return e.fieldLabel});var r=new Map;i.forEach(function(e){r.set(e.fieldLabel,e)}),i=(i=i.filter(function(e){if(e.isAssociationRefField){var t=r.get(e.belongFieldLabelId);return!t||(t.children.push(e),!1)}return!0})).map(function(e){if(e.hasAssociation&&0<e.children.length){var t=Object.assign(new D,e);return t.originalColumnItem=e,t.oldValue=e.children.map(function(e){return e.oldValue}).join(";"),t.newValue=e.children.map(function(e){return e.newValue}).join(";"),t}return e}),e.changes=i,d.push(e)}});var n=new Map;return d.forEach(function(e){return n.set(e.dataId,e)}),d.forEach(function(t){if(!t.parentDataId)return(e=o.genChgdrDataEntityNode(t.entityCode,t.entityName)).rows.push(t),void a.entityNodes.push(e);var e,r=n.get(t.parentDataId);r?((e=r.entityNodes.find(function(e){return e.entityCode==t.entityCode}))||(e=o.genChgdrDataEntityNode(t.entityCode,t.entityName),r.entityNodes.push(e)),e.rows.push(t)):((e=o.genChgdrDataEntityNode(t.entityCode,t.entityName)).rows.push(t),a.entityNodes.push(e))}),a},x.prototype.buildDataCodes=function(e,a){var n=this,i=[];return e&&e.forEach(function(e,t){var r=new M;"_$dataCode"==t?(r.fieldLabelId="dataCode",r.fieldName="业务编号",r.fieldValue=e):(r.fieldLabelId=t,r.fieldName=n.handler.getEntityFieldNameOrDefault(a,t),r.fieldValue=n.handler.formatFieldValue(e,a,t)),i.push(r)}),this.handler.sort(i,a,function(e){return e.fieldLabelId}),i},x.prototype.extractChangeColumnKeys=function(e){var r=new Set;return e.oldContent&&e.oldContent.forEach(function(e,t){return r.add(t)}),e.newContent&&e.newContent.forEach(function(e,t){return r.add(t)}),Array.from(r.keys())},x.prototype.genChgdrDataEntityNode=function(e,t){var r=new I;return r.entityCode=e,r.entityName=t,r.rows=[],r},x);function x(){}var N=(E.newGuid=function(){var t=this;return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){return t.convert(e)})},E.convert=function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)},E);function E(){}var j=function Se(){},F=(O.prototype.build=function(e){if(0==(this.chgdrData=e).entityNodes.length)return console.warn("无变更日志"),[];var t=e.entityNodes[0].rows;if(0==t.length)return console.warn("无根变更日志行"),[];var r=t[0],a=this.rowToNode(r);return a.isRoot=!0,a.expanded=!0,[a]},O.prototype.rowToNode=function(e){var r=this,a=new j;return a.id=N.newGuid(),a.name=this.buildTreeNodeName(e),a.data={id:a.id,name:a.name},a.chgdrRow=e,a.chgdrData=this.chgdrData,a.children=[],e.entityNodes.forEach(function(e){e.rows.forEach(function(e){var t=r.rowToNode(e);(t.parent=a).children.push(t)})}),a},O.prototype.buildTreeNodeName=function(e){var t;return e.dataCodes&&0<e.dataCodes.length&&(t=e.dataCodes[0].fieldValue),t?e.entityName+"-"+t+"【"+e.operateType.getName()+"】":e.entityName+"【"+e.operateType.getName()+"】"},O);function O(){}var P=(V.prototype.getGSPBusinessEntity=function(r){var a=this;if(this.beMetadataCache.has(r)){var e=this.beMetadataCache.get(r);return b.of(e)}return this.metadataService.GetMetadataRT(r).pipe(C.map(function(e){var t=JSON.parse(e.content);return a.beMetadataCache.set(r,t),t}))},V.decorators=[{type:y.Injectable,args:[{providedIn:"root"}]}],V.ctorParameters=function(){return[{type:f.HttpService},{type:f.SessionService},{type:l.GSPMetadataRTService},{type:y.Injector}]},V.ngInjectableDef=y.defineInjectable({factory:function(){return new V(y.inject(f.HttpService),y.inject(f.SessionService),y.inject(l.GSPMetadataRTService),y.inject(y.INJECTOR))},token:V,providedIn:"root"}),V);function V(e,t,r,a){this.http=e,this.sessionService=t,this.metadataService=r,this.injector=a,this.beMetadataCache=new Map}var R=(H.prototype.getBeChgdrConfig=function(e){var t="/api/runtime/chgdr/v1.0/config?beId="+e;return this.http.get(t).pipe(C.tap(function(e){(e||[]).forEach(function(e){var t=e.fields||[];t.forEach(function(e,t){e.showIndex!==undefined&&null!==e.showIndex||(e.showIndex=t)}),e.fields=t.sort(function(e,t){return e.showIndex-t.showIndex}),t.forEach(function(e,t){e.showIndex=t})})}))},H.decorators=[{type:y.Injectable,args:[{providedIn:"root"}]}],H.ctorParameters=function(){return[{type:f.HttpService},{type:f.SessionService},{type:y.Injector}]},H.ngInjectableDef=y.defineInjectable({factory:function(){return new H(y.inject(f.HttpService),y.inject(f.SessionService),y.inject(y.INJECTOR))},token:H,providedIn:"root"}),H);function H(e,t,r){this.http=e,this.sessionService=t,this.injector=r}var k=(G.prototype.updateShowIndex=function(){var r=new Map;this.entityFieldMap.forEach(function(e,t){r.set(t,r.size)}),this.entityFieldConfigMap.forEach(function(e,t){e.showIndex!==undefined&&null!==e.showIndex&&r.set(t,e.showIndex)}),this.entityFieldShowOrderMap=r},G.prototype.updateEntityConfigs=function(){var n=new Map;this.entityConfigs.forEach(function(e){var a=e.tabCode;(e.fields||[]).forEach(function(e){var t=e.fieldLabelId,r=a+"#"+t;n.set(r,e)})}),this.entityFieldConfigMap=n},G.prototype.updateEntityMap=function(t,r,a){var n=this;if(t){r.set(t.Code,t),t.ContainElements.forEach(function(e){n.updateEntityFieldMap(t,e,null,a)});var e=t.ContainChildObjects;e&&e.length&&e.forEach(function(e){n.updateEntityMap(e,r,a)})}},G.prototype.updateEntityFieldMap=function(r,a,e,n){var i=this,t=r.Code+"#"+a.LabelID;n.set(t,a),e&&this.entityFieldParentMap.set(t,e);var o=a.ChildAssociations;o&&0<o.length&&o.forEach(function(e){var t=e.RefElementCollection;t&&0<t.length&&t.forEach(function(e){i.updateEntityFieldMap(r,e,a,n)})})},G.prototype.sort=function(e,n,i){var o=this;e.sort(function(e,t){var r=n+"#"+i(e),a=n+"#"+i(t);return o.entityFieldShowOrderMap.has(r)||o.entityFieldShowOrderMap.has(a)?o.entityFieldShowOrderMap.has(r)?o.entityFieldShowOrderMap.has(a)?o.entityFieldShowOrderMap.get(r)-o.entityFieldShowOrderMap.get(a):1:-1:r.localeCompare(a)})},G.prototype.formatMainObjectFieldValue=function(e,t){var r=this.getMainObjectCode();return this.formatFieldValue(e,r,t)},G.prototype.formatFieldValue=function(t,e,r){var a=this.getElement(e,r);if(!a)return console.error("未找到业务实体【"+this.be.ID+"-"+this.be.Name+"】节点【"+e+"】的字段【"+r+"】"),t;if(!a)return t;try{if((a.MDataType==p.GSPElementDataType.Decimal||a.MDataType==p.GSPElementDataType.Integer)&&t&&t.toLowerCase().includes("e")){var n=Number(t);return isNaN(n)?(console.log("业务实体【"+this.be.ID+"-"+this.be.Name+"】节点【"+e+"】的字段【"+r+"】的值不是有效的数字格式："+t),t):this.toNonExponential(n)}if(a.MDataType==p.GSPElementDataType.Boolean)return null===t||t===undefined||0==t.length?t:"false"==t.toLowerCase()?"否":"true"==t.toLowerCase()?"是":t;if(a.MDataType==p.GSPElementDataType.Date){if(null===t||t===undefined||0==t.length)return t;var i=new Date(t);return u.format(i,"yyyy-MM-dd")}if(a.MDataType==p.GSPElementDataType.DateTime)return null===t||t===undefined||0==t.length?t:(i=new Date(t),u.format(i,"yyyy-MM-dd HH:mm:ss"));if(a.ObjectType!=p.GSPElementObjectType.Enum)return t;var o=(a.ContainEnumValues||[]).find(function(e){return e.Value==t});return o?o.Name:(null===t||t===undefined||0==t.length||console.log("业务实体【"+this.be.ID+"-"+this.be.Name+"】节点【"+e+"】的字段【"+r+"】的值未找到匹配的枚举项："+t),t)}catch(d){return console.error("业务实体【"+this.be.ID+"-"+this.be.Name+"】节点【"+e+"】的字段【"+r+"】的值【"+t+"】格式化出错：",d),t}},G.prototype.toNonExponential=function(e){var t=e.toExponential().match(/\d(?:\.(\d*))?e([+-]\d+)/);return e.toFixed(Math.max(0,(t[1]||"").length-t[2]))},G.prototype.getBeName=function(){return this.be?this.be.Name:null},G.prototype.getMainObjectCode=function(){return this.be&&this.be.MainObject?this.be.MainObject.Code:null},G.prototype.getElement=function(e,t){var r=e+"#"+t;return this.entityFieldMap.get(r)},G.prototype.getParentElement=function(e,t){var r=e+"#"+t;return this.entityFieldParentMap.get(r)},G.prototype.getEntityNameOrDefault=function(e){var t=this.entityCodeMap.get(e);return t?t.Name:e},G.prototype.getEntityFieldNameOrDefault=function(e,t){var r=e+"#"+t,a=this.entityFieldConfigMap.get(r);if(a&&a.fieldName&&""!=a.fieldName)return a.fieldName;var n=this.entityFieldMap.get(r);return n?n.Name:t},G);function G(e,t){if(this.entityCodeMap=new Map,this.entityFieldMap=new Map,this.entityFieldShowOrderMap=new Map,this.entityFieldParentMap=new Map,this.entityFieldConfigMap=new Map,this.be=e){var r=e.MainObject;this.updateEntityMap(r,this.entityCodeMap,this.entityFieldMap)}this.entityConfigs=t||[],this.updateEntityConfigs(),this.updateShowIndex()}var z=(L.prototype.getChgdrConfigHandler=function(n){var i=this;if(this.beMetadataCache.has(n)){var e=this.beMetadataCache.get(n);return b.of(e)}var t=[];return t.push(this.chgdrMetadataService.getGSPBusinessEntity(n)),t.push(this.chgdrConfigService.getBeChgdrConfig(n)),b.forkJoin(t).pipe(C.map(function(e){var t=e[0],r=e[1]||[],a=new k(t,r);return i.beMetadataCache.set(n,a),a}))},L.decorators=[{type:y.Injectable,args:[{providedIn:"root"}]}],L.ctorParameters=function(){return[{type:f.HttpService},{type:f.SessionService},{type:l.GSPMetadataRTService},{type:P},{type:R},{type:y.Injector}]},L.ngInjectableDef=y.defineInjectable({factory:function(){return new L(y.inject(f.HttpService),y.inject(f.SessionService),y.inject(l.GSPMetadataRTService),y.inject(P),y.inject(R),y.inject(y.INJECTOR))},token:L,providedIn:"root"}),L);function L(e,t,r,a,n,i){this.http=e,this.sessionService=t,this.metadataService=r,this.chgdrMetadataService=a,this.chgdrConfigService=n,this.injector=i,this.beMetadataCache=new Map}var q=(B.prototype.ngOnInit=function(){},B.prototype.ngOnChanges=function(e){var t=this;if(this.data){var r=this.data.entityId;this.chgdrInnerService.getChgdrConfigHandler(r).subscribe(function(e){t.chgdrData=(new T).buildChgdrData(t.data,e),t.treeData=(new F).build(t.chgdrData),t.treeTableComponent&&t.treeTableComponent.clearSelections(),setTimeout(function(){t.treeTableComponent.selectNode(t.treeData[0].id)},0)})}},B.prototype.handleTreeSelection=function(e){var t=e.node;null!=this.currentNode&&this.currentNode.id==t.id||(this.currentNode=t)},B.decorators=[{type:y.Component,args:[{selector:"chgdr-data-viewer",template:'<farris-splitter *ngIf="!!chgdrData" class="row flex-fill farris-split-section" style="margin: 0px;">\r\n  <farris-splitter-pane [ngResizable]=true [rzMinWidth]="250" [rzHandles]="\'e\'" style="padding:0.3rem 0 0.3rem 0.3rem;"\r\n    class="d-flex flex-column farris-lsection f-col-w4">\r\n    <farris-treetable #treeTable class="f-utils-fill" style="overflow-y: auto;" [columns]="treeConfig.columns" [showBorder]="false" [showHeader]="false"\r\n      [data]="treeData" [idField]="treeConfig.idField" [singleSelect]="true" [showCheckbox]="false"\r\n      [showIcon]="true" [disabled]="treeConfig.disabled" [checkOnSelect]="true"\r\n      (nodeSelected)="handleTreeSelection($event)" [leafIcon]="treeConfig.leafIcon"\r\n      [expandIcon]="treeConfig.expandIcon" [collapseIcon]="treeConfig.collapseIcon"\r\n      [selectValues]="treeConfig.selectValues">\r\n    </farris-treetable>\r\n  </farris-splitter-pane>\r\n  <farris-splitter-pane class="farris-rsection farris-overflow-y-auto f-utils-fill-flex-column" style="padding:0 0 0 0.3rem">\r\n    <farris-section mainTitle="基本信息" [enableMaximize]="false" [enableAccordion]="\'default\'">\r\n      <lib-chgdr-row-baseinfo-form [chgdrTreeNode]="currentNode" [showDataId]="showDataId"></lib-chgdr-row-baseinfo-form>\r\n    </farris-section>\r\n    <farris-section mainTitle="变更详情" [enableMaximize]="false" [fill]="true" class="pt-0">\r\n      <lib-chgdr-row-grid *ngIf="!!currentNode && currentNode.chgdrRow.changes.length>0" [chgdrTreeNode]="currentNode" class="f-utils-fill"></lib-chgdr-row-grid>\r\n      <div class="f-datagrid-norecords" *ngIf="!currentNode || currentNode.chgdrRow.changes.length==0" style="height: 250px;">\r\n        <div class="f-datagrid-norecords-content" style="width: 100%;">\r\n            无数据\r\n        </div>\r\n      </div>\r\n    </farris-section>\r\n  </farris-splitter-pane>\r\n</farris-splitter>',styles:[":host{display:-webkit-box;display:flex;height:100%}"]}]}],B.ctorParameters=function(){return[{type:l.GSPMetadataRTService},{type:y.Injector},{type:P},{type:R},{type:z}]},B.propDecorators={data:[{type:y.Input}],showDataId:[{type:y.Input}],treeTableComponent:[{type:y.ViewChild,args:["treeTable"]}]},B);function B(e,t,r,a,n){this.metadataService=e,this.injector=t,this.chgdrMetadataService=r,this.chgdrConfigService=a,this.chgdrInnerService=n,this.showDataId=!1,this.treeConfig={idField:"id",columns:[{field:"name",title:"Name",width:200}],leafIcon:"f-icon f-icon-page-title-type text-info mr-2",expandIcon:"f-icon f-icon-file-folder-open text-info mr-2",collapseIcon:"f-icon f-icon-file-folder-close text-info mr-2",showLevel:-1,disabled:!1,init:!1,selectValues:[]}}var A=(Q.prototype.getOrdinal=function(){return this.ordinal},Q.prototype.getCode=function(){return this.code},Q.prototype.getName=function(){return this.name},Q.values=function(){return[Q.ADD,Q.MODIFY,Q.DELETE]},Q.prototype.toJson=function(){return this.code},Q.parse=function(t){return t===undefined||null===t?null:t instanceof Q?t:"string"==typeof t?Q.values().find(function(e){return e.code==t}):"number"==typeof t?Q.values().find(function(e){return e.ordinal==t}):t.code?Q.values().find(function(e){return e.code==t.code}):null},Q.ADD=new Q(0,"ADD","新增"),Q.MODIFY=new Q(1,"MODIFY","修改"),Q.DELETE=new Q(2,"DELETE","删除"),Q);function Q(e,t,r){this.ordinal=e,this.code=t,this.name=r}var J=($.convertMapToObject=function(e){if(!e)return null;var r=Object.create(null);return e.forEach(function(e,t){r[t]=e}),r},$.convertObjectToMap=function(e){var t,r;if(e===undefined||null===e)return null;var a=new Map;try{for(var n=function d(e){var t="function"==typeof Symbol&&e[Symbol.iterator],r=0;return t?t.call(e):{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}}}(Object.keys(e)),i=n.next();!i.done;i=n.next()){var o=i.value;a.set(o,e[o])}}catch(s){t={error:s}}finally{try{i&&!i.done&&(r=n["return"])&&r.call(n)}finally{if(t)throw t.error}}return a},$);function $(){}var _="/api/runtime/chgdr/v1.0",U=(Y.prototype.queryChangeDataHeader=function(e){var r=this,t=Object.assign({},e);e.dataCode&&(t.dataCode=J.convertMapToObject(e.dataCode));var a=JSON.stringify(t),n=encodeURIComponent(a),i=_+"?queryParam="+n;return this.http.get(i).pipe(C.map(function(e){if(!e)return e;var t=e;return t&&t.headers&&t.headers.forEach(function(e){"string"==typeof e.dataCode&&(e.dataCode=JSON.parse(e.dataCode)),e.dataCode=J.convertObjectToMap(e.dataCode),e.changeTime=r.toDate(e.changeTime),e.operateType=A.parse(e.operateType)}),t}))},Y.prototype.getRootEntityDataCodeFields=function(t){var r=this;if(!t)return b.of([]);if(this.rootDataCodeFieldsMap.has(t))return b.of(this.rootDataCodeFieldsMap.get(t));var e=_+"/rootDataCodeFields?beId="+t;return this.http.get(e).pipe(C.tap(function(e){return r.rootDataCodeFieldsMap.set(t,e)}))},Y.prototype.toDate=function(e){return"string"==typeof e?new Date(e):"number"==typeof e?new Date(e):e},Y.prototype.getChangeData=function(e,t){var r=this,a=JSON.stringify(t),n=encodeURIComponent(a),i=_+"/"+e+"?changeTime="+n;return this.http.get(i).pipe(C.map(function(e){if(!e)return e;var t=e;return"string"==typeof t.dataCode&&(t.dataCode=JSON.parse(t.dataCode)),t.dataCode=J.convertObjectToMap(t.dataCode),t.changeTime=r.toDate(t.changeTime),t.operateType=A.parse(t.operateType),t.rows=t.rows||[],t.rows.forEach(function(e){e&&(e.operateType=A.parse(e.operateType),"string"==typeof e.dataCode&&(e.dataCode=JSON.parse(e.dataCode)),e.dataCode=J.convertObjectToMap(e.dataCode),e.oldContent=J.convertObjectToMap(e.oldContent)||new Map,e.newContent=J.convertObjectToMap(e.newContent)||new Map)}),t}))},Y.decorators=[{type:y.Injectable,args:[{providedIn:"root"}]}],Y.ctorParameters=function(){return[{type:f.HttpService},{type:f.SessionService},{type:y.Injector}]},Y.ngInjectableDef=y.defineInjectable({factory:function(){return new Y(y.inject(f.HttpService),y.inject(f.SessionService),y.inject(y.INJECTOR))},token:Y,providedIn:"root"}),Y);function Y(e,t,r){this.http=e,this.sessionService=t,this.injector=r,this.rootDataCodeFieldsMap=new Map}var K=function De(){},W=function Me(){},X=(Z.getErrorMessage=function(e){return e&&e.error&&e.error.Message?e.error.Message:""},Z);function Z(){}var ee=(te.getStartTimeInDay=function(e){var t=new Date(e);return t.setHours(0),t.setMinutes(0),t.setSeconds(0),t.setMilliseconds(0),t},te.getEndTimeInDay=function(e){var t=new Date(e);return t.setHours(23),t.setMinutes(59),t.setSeconds(59),t.setMilliseconds(999),t},te);function te(){}var re=(ae.prototype.ngOnInit=function(){var e=new W;e.total=0,e.pageSize=20,e.pageIndex=1,e.headers=[],this.chgdrs=e},ae.prototype.ngOnChanges=function(e){if(this.changeTimeStart||this.changeTimeEnd?this.changeTimeEnd?this.changeTimeStart||(this.changeTimeStart=ee.getEndTimeInDay(this.changeTimeEnd)):this.changeTimeEnd=ee.getEndTimeInDay(this.changeTimeStart):(this.changeTimeEnd=ee.getEndTimeInDay(new Date),this.changeTimeStart=ee.getStartTimeInDay(new Date((new Date).getTime()-6048e5))),this.entityId){var t=this.buildQueryParam();this.doQuery(t)}},ae.prototype.query=function(){var e=this.buildQueryParam();this.doQuery(e)},ae.prototype.buildQueryParam=function(){var e=new K;return e.pageIndex=1,e.pageSize=20,e.entityId=this.entityId,e.dataId=this.dataId,e.changeTimeStart=this.changeTimeStart,e.changeTimeEnd=this.changeTimeEnd,e},ae.prototype.doQuery=function(t){var r=this;this.chgdrService.queryChangeDataHeader(t).subscribe(function(e){r.currentQueryParam=t,r.chgdrs=e},function(e){console.error("查询业务变更日志出错",e),r.messageService.error("查询业务变更日志出错："+X.getErrorMessage(e))})},ae.prototype.onPageChanged=function(e){e&&(e.pageIndex&&(this.currentQueryParam.pageIndex=e.pageIndex),e.pageSize&&(this.currentQueryParam.pageSize=e.pageSize),this.doQuery(this.currentQueryParam))},ae.prototype.onPageSizeChanged=function(e){this.currentQueryParam.pageSize=e,this.doQuery(this.currentQueryParam)},ae.decorators=[{type:y.Component,args:[{selector:"chgdr-list",template:'<div class="farris-form farris-form-controls-inline" style="background: #fff;">\n  <form class="f-section-formgroup" style="padding-top: 10px;">\n    <div class="f-section-formgroup-inputs">\n      <div class="col-12 row">\n        <div class="farris-group-wrap col-5">\n          <div class="form-group farris-form-group">\n            <label class="col-form-label">\n              <span class="farris-label-info text-danger">*</span><span class="farris-label-text">开始时间</span>\n            </label>\n            <div class="farris-input-wrap">\n              <farris-datepicker [(ngModel)]="changeTimeStart" name="changeTimeStart"></farris-datepicker>\n            </div>\n          </div>\n        </div>\n        <div class="farris-group-wrap col-5">\n          <div class="form-group farris-form-group">\n            <label class="col-form-label">\n              <span class="farris-label-info text-danger">*</span><span class="farris-label-text">结束时间</span>\n            </label>\n            <div class="farris-input-wrap">\n              <farris-datepicker [(ngModel)]="changeTimeEnd" name="changeTimeEnd"></farris-datepicker>\n            </div>\n          </div>\n        </div>\n        <div class="farris-group-wrap col-2">\n          <div class="form-group farris-form-group">\n            <label class="col-form-label">\n              <button class="btn btn-primary mr-2" (click)="query()">查询</button>\n            </label>\n            <div class="farris-input-wrap">\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  </form>\n</div>\n\n<lib-chgdr-header-datagrid\n  [chgdrs]="chgdrs" \n  (pageChanged)="onPageChanged($event)" \n  (pageSizeChanged)="onPageSizeChanged($event)"\n  [showDataId]="false"\n></lib-chgdr-header-datagrid>\n\n\x3c!-- <div class="f-utils-fill">\n  <farris-datagrid #chgdrGrid idField="id" [columns]="columns" [data]="chgdrs.headers"\n  showLineNumber="true" [fit]="true" [fitColumns]="true" \n  [pagination]="true" [pageSize]="20" [showPageList]="false" [pageIndex]="chgdrs.pageIndex" [total]="chgdrs.total"\n  (pageChanged)="onPageChanged($event)" (pageSizeChanged)="onPageSizeChanged($event)"\n  >\n  </farris-datagrid>\n  <ng-template #opCell let-ctx>\n    <a href="javascript: void(0);" (click)="showChangeDetail(ctx)">变更详情</a>\n  </ng-template>\n</div> --\x3e\n\n\x3c!-- 查看变更日志的弹窗 --\x3e\n\x3c!-- <farris-dialog #chgdrInfoDialog\n  title="变更日志详情"\n  [width]="1100"\n  [height]="600"\n  [showMaxButton]="true"\n  [resizable]="true"\n  [showButtons]="false"\n>\n  <chgdr-data-viewer [data]="currentChgdrData"></chgdr-data-viewer>\n</farris-dialog> --\x3e',styles:[""]}]}],ae.ctorParameters=function(){return[{type:U},{type:m.MessagerService},{type:v.NotifyService},{type:y.Injector}]},ae.propDecorators={baseCls:[{type:y.HostBinding,args:["class.f-utils-fill-flex-column"]}],entityId:[{type:y.Input}],dataId:[{type:y.Input}],changeTimeStart:[{type:y.Input}],changeTimeEnd:[{type:y.Input}]},ae);function ae(e,t,r,a){this.chgdrService=e,this.messageService=t,this.notifyService=r,this.injector=a,this.baseCls=!0}var ne=(ie.prototype.ngOnInit=function(){},ie.decorators=[{type:y.Component,args:[{selector:"lib-chgdr-row-baseinfo-form",template:'<div *ngIf="!!chgdrTreeNode" class="farris-form farris-form-controls-inline">\r\n  <form class="f-section-formgroup">\r\n    <div class="f-section-formgroup-inputs">\r\n      <div class="col-12 row">\r\n\r\n        <div class="farris-group-wrap col-6" *ngIf="showDataId">\r\n          <div class="form-group farris-form-group">\r\n            <label class="col-form-label">\r\n              <span class="farris-label-text">技术主键</span>\r\n            </label>\r\n            <div class="farris-input-wrap">\r\n              <input type="text" class="form-control" [ngModel]="chgdrTreeNode.chgdrRow.dataId" name="dataId"\r\n                [readonly]="true">\r\n              <div class="farris-feedback valid-feedback"></div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <div class="farris-group-wrap col-6" *ngFor="let field of chgdrTreeNode.chgdrRow.dataCodes">\r\n          <div class="form-group farris-form-group">\r\n            <label class="col-form-label">\r\n              <span class="farris-label-text">{{field.fieldName}}</span>\r\n            </label>\r\n            <div class="farris-input-wrap">\r\n              <input type="text" class="form-control" [ngModel]="field.fieldValue" name="dataCode-{{field.fieldName}}"\r\n                [readonly]="true">\r\n              <div class="farris-feedback valid-feedback"></div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <div *ngIf="chgdrTreeNode.isRoot" class="farris-group-wrap col-6">\r\n          <div class="form-group farris-form-group">\r\n            <label class="col-form-label">\r\n              <span class="farris-label-text">变更人</span>\r\n            </label>\r\n            <div class="farris-input-wrap">\r\n              <input type="text" class="form-control" [ngModel]="chgdrTreeNode.chgdrData.userName" name="userName"\r\n                [readonly]="true">\r\n              <div class="farris-feedback valid-feedback"></div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <div *ngIf="chgdrTreeNode.isRoot" class="farris-group-wrap col-6">\r\n          <div class="form-group farris-form-group">\r\n            <label class="col-form-label">\r\n              <span class="farris-label-text">变更时间</span>\r\n            </label>\r\n            <div class="farris-input-wrap">\r\n              <input type="text" class="form-control" value="{{chgdrTreeNode.chgdrData.changeTime | date:\'yyyy-MM-dd HH:mm:ss\'}}" name="changeTime"\r\n                [readonly]="true">\r\n              <div class="farris-feedback valid-feedback"></div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <div class="farris-group-wrap col-6">\r\n          <div class="form-group farris-form-group">\r\n            <label class="col-form-label">\r\n              <span class="farris-label-text">变更方式</span>\r\n            </label>\r\n            <div class="farris-input-wrap">\r\n              <input type="text" class="form-control" [ngModel]="chgdrTreeNode.chgdrRow.operateType.name" name="operateType"\r\n              [readonly]="true">\r\n              <div class="farris-feedback valid-feedback"></div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n        \r\n      </div>\r\n    </div>\r\n  </form>\r\n</div>',styles:[""]}]}],ie.ctorParameters=function(){return[{type:y.Injector}]},ie.propDecorators={chgdrTreeNode:[{type:y.Input}],showDataId:[{type:y.Input}]},ie);function ie(e){this.injector=e,this.showDataId=!1}var oe=(de.prototype.ngOnInit=function(){this.columns=[{field:"fieldName",width:130,title:"字段名"},{field:"oldValue",width:130,title:"原值",showTips:!0},{field:"newValue",width:130,title:"变更值",showTips:!0}];var e=this.columns[1],t=this.columns[2];if(this.chgdrTreeNode){var r=this.chgdrTreeNode.chgdrRow.operateType;r==A.ADD?(e.visible=!1,t.title="值"):r==A.DELETE&&(t.visible=!1,e.title="值")}},de.prototype.ngOnChanges=function(e){var t;(e.chgdrTreeNode&&e.chgdrTreeNode.previousValue?e.chgdrTreeNode.previousValue.chgdrRow.operateType:null)!=(t=e.chgdrTreeNode&&e.chgdrTreeNode.currentValue?e.chgdrTreeNode.currentValue.chgdrRow.operateType:null)&&this.dataGrid&&this.dataGrid.columns&&(t==A.ADD?(this.dataGrid.showColumn("newValue"),this.dataGrid.hideColumn("oldValue"),this.dataGrid.setColumnTitle("newValue","值")):t==A.DELETE?(this.dataGrid.showColumn("oldValue"),this.dataGrid.hideColumn("newValue"),this.dataGrid.setColumnTitle("oldValue","值")):(this.dataGrid.showColumn("oldValue"),this.dataGrid.showColumn("newValue"),this.dataGrid.setColumnTitle("oldValue","原值"),this.dataGrid.setColumnTitle("newValue","变更值"))),e.chgdrTreeNode&&e.chgdrTreeNode.currentValue&&(this.data=e.chgdrTreeNode.currentValue.chgdrRow.changes)},de.decorators=[{type:y.Component,args:[{selector:"lib-chgdr-row-grid",template:'<farris-datagrid \r\n   #chgdrRowGrid \r\n   idField="fieldLabel" \r\n   [columns]="columns" \r\n   [data]="data" \r\n   [fit]="true"\r\n   [fitColumns]="true"\r\n   [pagination]="false" \r\n>',styles:[""]}]}],de.ctorParameters=function(){return[{type:y.Injector}]},de.propDecorators={chgdrTreeNode:[{type:y.Input}],dataGrid:[{type:y.ViewChild,args:["chgdrRowGrid"]}]},de);function de(e){this.injector=e}var se=(ce.prototype.ngOnInit=function(){},ce.decorators=[{type:y.Component,args:[{selector:"lib-chgdr-list-dialog-content",template:'<chgdr-list [entityId]="entityId" [dataId]="dataId" style="padding: 0.75rem 0.875rem;height:100%"></chgdr-list>',styles:[""]}]}],ce.ctorParameters=function(){return[{type:y.Injector}]},ce.propDecorators={entityId:[{type:y.Input}],dataId:[{type:y.Input}]},ce);function ce(e){this.injector=e}var le=(ue.prototype.showDialog=function(e,t){return this.create(e,t)},ue.prototype.create=function(e,t){if(e){var r=this.resolver.resolveComponentFactory(se).create(this.injector);r.instance.entityId=e,r.instance.dataId=t,this.modalService.show(r,{title:"变更日志列表",width:1e3,height:550,resizable:!0,showButtons:!1,showMaxButton:!0})}else console.error("创建业务变更日志列表组件失败，业务实体不能为空，请检查",e,t)},ue.decorators=[{type:y.Injectable,args:[{providedIn:"root"}]}],ue.ctorParameters=function(){return[{type:y.ComponentFactoryResolver},{type:y.Injector},{type:g.BsModalService},{type:m.MessagerService}]},ue.ngInjectableDef=y.defineInjectable({factory:function(){return new ue(y.inject(y.ComponentFactoryResolver),y.inject(y.INJECTOR),y.inject(g.BsModalService),y.inject(m.MessagerService))},token:ue,providedIn:"root"}),ue);function ue(e,t,r,a){this.resolver=e,this.injector=t,this.modalService=r,this.messagerService=a}var pe=(he.prototype.ngOnInit=function(){this.resetColumnAndData(null,[])},he.prototype.ngOnChanges=function(r){var a=this;if(r.chgdrs){var n=this.getEntityId(r.chgdrs.previousValue),i=this.getEntityId(r.chgdrs.currentValue),e=[this.updateChgdrConfigHandler(i),this.updateDataCodeFields(n,i)];b.forkJoin(e).subscribe(function(e){var t=r.chgdrs.currentValue;t&&a.formatHeaders(t.headers),null!=i&&i!=n?a.resetColumnAndData(i,t.headers):a.headers=t.headers},function(e){console.error("获取BE【"+i+"】的配置的业务变更日志的业务编号失败：",e),a.messageService.error("获取业务编号配置失败："+X.getErrorMessage(e))})}},he.prototype.updateChgdrConfigHandler=function(e){var t=this;return e?this.chgdrInnerService.getChgdrConfigHandler(e).pipe(C.tap(function(e){return t.chgdrConfigHandler=e})):b.of(this.chgdrConfigHandler)},he.prototype.updateDataCodeFields=function(e,t){var r=this;return null!=t&&t!=e?this.chgdrService.getRootEntityDataCodeFields(t).pipe(C.tap(function(e){return r.dataCodeFields=e||[]})):b.of(this.dataCodeFields)},he.prototype.formatHeaders=function(e){var r=this;e&&e.forEach(function(e){var t;r.formatDataCodeMap(e.dataCode),e.dataCode&&1==e.dataCode.size&&e.dataCode.has("_$dataCode")?(t={},r.dataCodeFields&&0<r.dataCodeFields.length&&(t[r.dataCodeFields[0].fieldLabelId]=e.dataCode.get("_$dataCode"))):t=J.convertMapToObject(e.dataCode),e.dataCodeObj=t})},he.prototype.formatDataCodeMap=function(a){var n=this;a&&this.chgdrConfigHandler&&Array.from(a.keys()).forEach(function(e){var t=a.get(e),r=n.chgdrConfigHandler.formatMainObjectFieldValue(t,e);a.set(e,r)})},he.prototype.getEntityId=function(e){return e&&e.headers&&0!=e.headers.length?e.headers[0].entityId:null},he.prototype.resetColumnAndData=function(e,t){var r=[{field:"userName",width:130,title:"用户"},{field:"changeTime",width:130,title:"时间",formatter:{type:"datetime",options:{format:"yyyy年MM月dd日 HH:mm:ss"}}},{field:"operateType.name",width:60,title:"操作类型"},{field:"dataId",width:130,title:"技术主键",visible:this.showDataId}];this.dataCodeFields.forEach(function(e){var t={field:"dataCodeObj."+e.fieldLabelId,title:e.fieldName,width:130};r.push(t)});var a={title:"操作",width:130,template:this.opCell,halign:"center",align:"center"};r.push(a),this.headers=[],this.ref.detectChanges(),this.columns=r,this.ref.detectChanges(),this.headers=t},he.prototype.onPageChanged=function(e){this.pageChanged.emit(e)},he.prototype.onPageSizeChanged=function(e){this.pageSizeChanged.emit(e)},he.prototype.showChangeDetail=function(e){var t=this,r=e.rowData;r&&this.chgdrService.getChangeData(r.id,r.changeTime).subscribe(function(e){e?(t.currentChgdrData=e,t.chgdrInfoDialog.show()):t.notifyService.error("未找到编号为【"+r.id+"】的变更日志")},function(e){console.error("查询业务变更日志出错",e),t.messageService.error("查询业务变更日志出错："+X.getErrorMessage(e))})},he.decorators=[{type:y.Component,args:[{selector:"lib-chgdr-header-datagrid",template:'<farris-datagrid #chgdrGrid idField="id" [columns]="columns" [data]="headers"\n  showLineNumber="true" [fit]="true" [fitColumns]="true" \n  [pagination]="true" [pageSize]="20" [showPageList]="false" [pageIndex]="chgdrs.pageIndex" [total]="chgdrs.total"\n  (pageChanged)="onPageChanged($event)" (pageSizeChanged)="onPageSizeChanged($event)"\n>\n</farris-datagrid>\n<ng-template #opCell let-ctx>\n  <a href="javascript: void(0);" (click)="showChangeDetail(ctx)">变更详情</a>\n</ng-template>\n\n\x3c!-- 查看变更日志的弹窗 --\x3e\n<farris-dialog #chgdrInfoDialog\n  title="变更日志详情"\n  [width]="1100"\n  [height]="600"\n  [showMaxButton]="true"\n  [resizable]="true"\n  [showButtons]="false"\n>\n  <chgdr-data-viewer [data]="currentChgdrData"></chgdr-data-viewer>\n</farris-dialog>',styles:[""]}]}],he.ctorParameters=function(){return[{type:U},{type:m.MessagerService},{type:v.NotifyService},{type:y.ChangeDetectorRef},{type:z},{type:y.Injector}]},he.propDecorators={baseCls:[{type:y.HostBinding,args:["class.f-utils-fill"]}],chgdrs:[{type:y.Input}],showDataId:[{type:y.Input}],pageChanged:[{type:y.Output}],pageSizeChanged:[{type:y.Output}],opCell:[{type:y.ViewChild,args:["opCell"]}],chgdrInfoDialog:[{type:y.ViewChild,args:["chgdrInfoDialog"]}]},he);function he(e,t,r,a,n,i){this.chgdrService=e,this.messageService=t,this.notifyService=r,this.ref=a,this.chgdrInnerService=n,this.injector=i,this.baseCls=!0,this.showDataId=!0,this.headers=[],this.dataCodeFields=[],this.pageChanged=new y.EventEmitter,this.pageSizeChanged=new y.EventEmitter}t.registerLocaleData(h);var fe=(ge.decorators=[{type:y.NgModule,args:[{declarations:[q,re,ne,oe,se,pe],imports:[t.CommonModule,r.FormsModule,a.SplitterModule,n.AngularDraggableModule,i.DatagridModule,o.TreeTableModule,d.FarrisSectionModule,m.MessagerModule.forRoot(),v.NotifyModule,s.FarrisDialogModule,c.FarrisDatePickerModule,l.MetadataRTSelectModule,l.GSPMetadataRTServiceModule.forRoot("")],providers:[m.MessagerService,v.NotifyService,f.HttpService,f.SessionService,f.CacheService,le,P,R,z,U],entryComponents:[q,re,se],exports:[q,re,pe]}]}],ge);function ge(){}var ye=function Te(){},me=function xe(){};e.ChgdrModule=fe,e.ChgdrService=U,e.ChgdrDataViewerComponent=q,e.ChgdrHeaderDatagridComponent=pe,e.ChgdrListComponent=re,e.ChangeDataHeader=ye,e.ChangeDataRow=me,e.OperateType=A,e.ChangeDataQueryParam=K,e.ChangeDataQueryResult=W,e.ChgdrListUiService=le,e.ɵf=se,e.ɵd=ne,e.ɵe=oe,e.ɵb=R,e.ɵc=z,e.ɵa=P,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=gsp-cmp-chgdr.umd.min.js.map