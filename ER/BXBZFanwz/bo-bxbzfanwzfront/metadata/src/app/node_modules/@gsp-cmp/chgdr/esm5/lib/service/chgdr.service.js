/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable, Injector } from '@angular/core';
import { HttpService, SessionService } from '@ecp-caf/caf-common';
import { of } from 'rxjs';
import { map, tap } from 'rxjs/operators';
import { OperateType } from '../model/operate-type';
import { MapUtil } from '../util/map.util';
import * as i0 from "@angular/core";
import * as i1 from "@ecp-caf/caf-common";
/** @type {?} */
var ServerIP = '/';
/** @type {?} */
var chgdrUrl = ServerIP + "api/runtime/chgdr/v1.0";
var ChgdrService = /** @class */ (function () {
    function ChgdrService(http, sessionService, injector) {
        this.http = http;
        this.sessionService = sessionService;
        this.injector = injector;
        this.rootDataCodeFieldsMap = new Map();
    }
    /**
     * @param {?} currentQueryParam
     * @return {?}
     */
    ChgdrService.prototype.queryChangeDataHeader = /**
     * @param {?} currentQueryParam
     * @return {?}
     */
    function (currentQueryParam) {
        var _this = this;
        /** @type {?} */
        var obj = Object.assign({}, currentQueryParam);
        if (currentQueryParam.dataCode) {
            obj.dataCode = MapUtil.convertMapToObject(currentQueryParam.dataCode);
        }
        /** @type {?} */
        var json = JSON.stringify(obj);
        /** @type {?} */
        var queryParam = encodeURIComponent(json);
        /** @type {?} */
        var url = chgdrUrl + "?queryParam=" + queryParam;
        return this.http.get(url).pipe(map((/**
         * @param {?} data
         * @return {?}
         */
        function (data) {
            if (!data) {
                return data;
            }
            /** @type {?} */
            var queryResult = (/** @type {?} */ ((/** @type {?} */ (data))));
            queryResult && queryResult.headers && queryResult.headers.forEach((/**
             * @param {?} header
             * @return {?}
             */
            function (header) {
                //TODO 待删，兼容老数据格式
                if (typeof header.dataCode == "string") {
                    header.dataCode = JSON.parse(header.dataCode);
                }
                header.dataCode = MapUtil.convertObjectToMap(header.dataCode);
                header.changeTime = _this.toDate(header.changeTime);
                header.operateType = OperateType.parse(header.operateType);
            }));
            return queryResult;
        })));
    };
    /**
     * @param {?} beId
     * @return {?}
     */
    ChgdrService.prototype.getRootEntityDataCodeFields = /**
     * @param {?} beId
     * @return {?}
     */
    function (beId) {
        var _this = this;
        if (!beId) {
            return of([]);
        }
        if (this.rootDataCodeFieldsMap.has(beId)) {
            //直接从缓存中获取
            return of(this.rootDataCodeFieldsMap.get(beId));
        }
        else {
            //获取结果并存入缓存
            /** @type {?} */
            var url = chgdrUrl + "/rootDataCodeFields?beId=" + beId;
            return ((/** @type {?} */ ((/** @type {?} */ ((this.http.get(url)))))))
                .pipe(tap((/**
             * @param {?} data
             * @return {?}
             */
            function (data) { return _this.rootDataCodeFieldsMap.set(beId, data); })));
        }
    };
    /** 将字符串或数字转为Date */
    /**
     * 将字符串或数字转为Date
     * @private
     * @param {?} date
     * @return {?}
     */
    ChgdrService.prototype.toDate = /**
     * 将字符串或数字转为Date
     * @private
     * @param {?} date
     * @return {?}
     */
    function (date) {
        if (typeof date == "string") {
            return new Date(date);
        }
        else if (typeof date == "number") {
            return new Date(date);
        }
        else {
            return date;
        }
    };
    /**
     * @param {?} id
     * @param {?} changeTime
     * @return {?}
     */
    ChgdrService.prototype.getChangeData = /**
     * @param {?} id
     * @param {?} changeTime
     * @return {?}
     */
    function (id, changeTime) {
        var _this = this;
        /** @type {?} */
        var json = JSON.stringify(changeTime);
        /** @type {?} */
        var queryParam = encodeURIComponent(json);
        /** @type {?} */
        var url = chgdrUrl + "/" + id + "?changeTime=" + queryParam;
        return this.http.get(url).pipe(map((/**
         * @param {?} data
         * @return {?}
         */
        function (data) {
            if (!data) {
                return data;
            }
            /** @type {?} */
            var sh = (/** @type {?} */ ((/** @type {?} */ (data))));
            //TODO 待删，兼容老数据格式
            if (typeof sh.dataCode == "string") {
                sh.dataCode = JSON.parse(sh.dataCode);
            }
            sh.dataCode = MapUtil.convertObjectToMap(sh.dataCode);
            sh.changeTime = _this.toDate(sh.changeTime);
            sh.operateType = OperateType.parse(sh.operateType);
            sh.rows = sh.rows || [];
            sh.rows.forEach((/**
             * @param {?} row
             * @return {?}
             */
            function (row) {
                if (!row) {
                    return;
                }
                row.operateType = OperateType.parse(row.operateType);
                //TODO 待删，兼容老数据格式
                if (typeof row.dataCode == "string") {
                    row.dataCode = JSON.parse(row.dataCode);
                }
                row.dataCode = MapUtil.convertObjectToMap(row.dataCode);
                row.oldContent = (/** @type {?} */ (MapUtil.convertObjectToMap(row.oldContent))) || new Map();
                row.newContent = (/** @type {?} */ (MapUtil.convertObjectToMap(row.newContent))) || new Map();
            }));
            return sh;
        })));
    };
    ChgdrService.decorators = [
        { type: Injectable, args: [{
                    providedIn: 'root'
                },] }
    ];
    /** @nocollapse */
    ChgdrService.ctorParameters = function () { return [
        { type: HttpService },
        { type: SessionService },
        { type: Injector }
    ]; };
    /** @nocollapse */ ChgdrService.ngInjectableDef = i0.defineInjectable({ factory: function ChgdrService_Factory() { return new ChgdrService(i0.inject(i1.HttpService), i0.inject(i1.SessionService), i0.inject(i0.INJECTOR)); }, token: ChgdrService, providedIn: "root" });
    return ChgdrService;
}());
export { ChgdrService };
if (false) {
    /**
     * @type {?}
     * @private
     */
    ChgdrService.prototype.rootDataCodeFieldsMap;
    /**
     * @type {?}
     * @private
     */
    ChgdrService.prototype.http;
    /**
     * @type {?}
     * @private
     */
    ChgdrService.prototype.sessionService;
    /**
     * @type {?}
     * @private
     */
    ChgdrService.prototype.injector;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hnZHIuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0Bnc3AtY21wL2NoZ2RyLyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2UvY2hnZHIuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDckQsT0FBTyxFQUFFLFdBQVcsRUFBRSxjQUFjLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUNsRSxPQUFPLEVBQWMsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3RDLE9BQU8sRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFLMUMsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQ3BELE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQzs7OztJQUVyQyxRQUFRLEdBQUcsR0FBRzs7SUFDZCxRQUFRLEdBQU0sUUFBUSwyQkFBd0I7QUFFcEQ7SUFNRSxzQkFBb0IsSUFBaUIsRUFDM0IsY0FBOEIsRUFDOUIsUUFBa0I7UUFGUixTQUFJLEdBQUosSUFBSSxDQUFhO1FBQzNCLG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtRQUM5QixhQUFRLEdBQVIsUUFBUSxDQUFVO1FBSnBCLDBCQUFxQixHQUFxQyxJQUFJLEdBQUcsRUFBRSxDQUFDO0lBSTVDLENBQUM7Ozs7O0lBRTFCLDRDQUFxQjs7OztJQUE1QixVQUE2QixpQkFBdUM7UUFBcEUsaUJBMEJDOztZQXpCSyxHQUFHLEdBQVEsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsaUJBQWlCLENBQUM7UUFDbkQsSUFBSSxpQkFBaUIsQ0FBQyxRQUFRLEVBQUU7WUFDOUIsR0FBRyxDQUFDLFFBQVEsR0FBRyxPQUFPLENBQUMsa0JBQWtCLENBQUMsaUJBQWlCLENBQUMsUUFBUSxDQUFDLENBQUM7U0FDdkU7O1lBRUcsSUFBSSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDOztZQUMxQixVQUFVLEdBQUcsa0JBQWtCLENBQUMsSUFBSSxDQUFDOztZQUNyQyxHQUFHLEdBQU0sUUFBUSxvQkFBZSxVQUFZO1FBQ2hELE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUc7Ozs7UUFBQyxVQUFBLElBQUk7WUFDckMsSUFBSSxDQUFDLElBQUksRUFBRTtnQkFDVCxPQUFPLElBQUksQ0FBQzthQUNiOztnQkFDRyxXQUFXLEdBQTBCLG1CQUF1QixtQkFBUyxJQUFJLEVBQUEsRUFBQTtZQUM3RSxXQUFXLElBQUksV0FBVyxDQUFDLE9BQU8sSUFBSSxXQUFXLENBQUMsT0FBTyxDQUFDLE9BQU87Ozs7WUFBQyxVQUFBLE1BQU07Z0JBQ3RFLGlCQUFpQjtnQkFDakIsSUFBSSxPQUFPLE1BQU0sQ0FBQyxRQUFRLElBQUksUUFBUSxFQUFFO29CQUN0QyxNQUFNLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDO2lCQUMvQztnQkFFRCxNQUFNLENBQUMsUUFBUSxHQUFHLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUM7Z0JBQzlELE1BQU0sQ0FBQyxVQUFVLEdBQUcsS0FBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUM7Z0JBQ25ELE1BQU0sQ0FBQyxXQUFXLEdBQUcsV0FBVyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUM7WUFDN0QsQ0FBQyxFQUFDLENBQUE7WUFDRixPQUFPLFdBQVcsQ0FBQztRQUNyQixDQUFDLEVBQUMsQ0FBQyxDQUFDO0lBQ04sQ0FBQzs7Ozs7SUFFTSxrREFBMkI7Ozs7SUFBbEMsVUFBbUMsSUFBWTtRQUEvQyxpQkFhQztRQVpDLElBQUksQ0FBQyxJQUFJLEVBQUU7WUFDVCxPQUFPLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztTQUNmO1FBQ0QsSUFBSSxJQUFJLENBQUMscUJBQXFCLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQ3hDLFVBQVU7WUFDVixPQUFPLEVBQUUsQ0FBQyxJQUFJLENBQUMscUJBQXFCLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7U0FDakQ7YUFBTTs7O2dCQUVELEdBQUcsR0FBTSxRQUFRLGlDQUE0QixJQUFNO1lBQ3ZELE9BQU8sQ0FBQyxtQkFBaUMsbUJBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFBLEVBQUEsQ0FBQztpQkFDcEUsSUFBSSxDQUFDLEdBQUc7Ozs7WUFBQyxVQUFBLElBQUksSUFBSSxPQUFBLEtBQUksQ0FBQyxxQkFBcUIsQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUExQyxDQUEwQyxFQUFDLENBQUMsQ0FBQztTQUNsRTtJQUNILENBQUM7SUFFRCxvQkFBb0I7Ozs7Ozs7SUFDWiw2QkFBTTs7Ozs7O0lBQWQsVUFBZSxJQUFTO1FBQ3RCLElBQUksT0FBTyxJQUFJLElBQUksUUFBUSxFQUFFO1lBQzNCLE9BQU8sSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDdkI7YUFBTSxJQUFJLE9BQU8sSUFBSSxJQUFJLFFBQVEsRUFBRTtZQUNsQyxPQUFPLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ3ZCO2FBQU07WUFDTCxPQUFPLElBQUksQ0FBQztTQUNiO0lBQ0gsQ0FBQzs7Ozs7O0lBRU0sb0NBQWE7Ozs7O0lBQXBCLFVBQXFCLEVBQVUsRUFBRSxVQUFnQjtRQUFqRCxpQkFrQ0M7O1lBakNLLElBQUksR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQzs7WUFDakMsVUFBVSxHQUFHLGtCQUFrQixDQUFDLElBQUksQ0FBQzs7WUFDckMsR0FBRyxHQUFNLFFBQVEsU0FBSSxFQUFFLG9CQUFlLFVBQVk7UUFDdEQsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRzs7OztRQUFDLFVBQUEsSUFBSTtZQUNyQyxJQUFJLENBQUMsSUFBSSxFQUFFO2dCQUNULE9BQU8sSUFBSSxDQUFDO2FBQ2I7O2dCQUNHLEVBQUUsR0FBcUIsbUJBQWtCLG1CQUFTLElBQUksRUFBQSxFQUFBO1lBQzFELGlCQUFpQjtZQUNqQixJQUFJLE9BQU8sRUFBRSxDQUFDLFFBQVEsSUFBSSxRQUFRLEVBQUU7Z0JBQ2xDLEVBQUUsQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsUUFBUSxDQUFDLENBQUM7YUFDdkM7WUFDRCxFQUFFLENBQUMsUUFBUSxHQUFHLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQyxFQUFFLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDdEQsRUFBRSxDQUFDLFVBQVUsR0FBRyxLQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxVQUFVLENBQUMsQ0FBQztZQUMzQyxFQUFFLENBQUMsV0FBVyxHQUFHLFdBQVcsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBRW5ELEVBQUUsQ0FBQyxJQUFJLEdBQUcsRUFBRSxDQUFDLElBQUksSUFBSSxFQUFFLENBQUM7WUFFeEIsRUFBRSxDQUFDLElBQUksQ0FBQyxPQUFPOzs7O1lBQUMsVUFBQSxHQUFHO2dCQUNqQixJQUFJLENBQUMsR0FBRyxFQUFFO29CQUNSLE9BQU87aUJBQ1I7Z0JBQ0QsR0FBRyxDQUFDLFdBQVcsR0FBRyxXQUFXLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsQ0FBQztnQkFDckQsaUJBQWlCO2dCQUNqQixJQUFJLE9BQU8sR0FBRyxDQUFDLFFBQVEsSUFBSSxRQUFRLEVBQUU7b0JBQ25DLEdBQUcsQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUM7aUJBQ3pDO2dCQUNELEdBQUcsQ0FBQyxRQUFRLEdBQUcsT0FBTyxDQUFDLGtCQUFrQixDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQztnQkFDeEQsR0FBRyxDQUFDLFVBQVUsR0FBRyxtQkFBcUIsT0FBTyxDQUFDLGtCQUFrQixDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsRUFBQSxJQUFJLElBQUksR0FBRyxFQUFFLENBQUM7Z0JBQzlGLEdBQUcsQ0FBQyxVQUFVLEdBQUcsbUJBQXFCLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLEVBQUEsSUFBSSxJQUFJLEdBQUcsRUFBRSxDQUFDO1lBQ2hHLENBQUMsRUFBQyxDQUFDO1lBQ0gsT0FBTyxFQUFFLENBQUM7UUFDWixDQUFDLEVBQUMsQ0FBQyxDQUFDO0lBQ04sQ0FBQzs7Z0JBbEdGLFVBQVUsU0FBQztvQkFDVixVQUFVLEVBQUUsTUFBTTtpQkFDbkI7Ozs7Z0JBZlEsV0FBVztnQkFBRSxjQUFjO2dCQURmLFFBQVE7Ozt1QkFBN0I7Q0FpSEMsQUFuR0QsSUFtR0M7U0FoR1ksWUFBWTs7Ozs7O0lBQ3ZCLDZDQUE0RTs7Ozs7SUFFaEUsNEJBQXlCOzs7OztJQUNuQyxzQ0FBc0M7Ozs7O0lBQ3RDLGdDQUEwQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEluamVjdG9yIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBIdHRwU2VydmljZSwgU2Vzc2lvblNlcnZpY2UgfSBmcm9tICdAZWNwLWNhZi9jYWYtY29tbW9uJztcbmltcG9ydCB7IE9ic2VydmFibGUsIG9mIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBtYXAsIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IENoYW5nZURhdGFIZWFkZXIgfSBmcm9tICcuLi9tb2RlbC9jaGFuZ2UtZGF0YS1oZWFkZXInO1xuaW1wb3J0IHsgQ2hhbmdlRGF0YVF1ZXJ5UGFyYW0gfSBmcm9tICcuLi9tb2RlbC9jaGFuZ2UtZGF0YS1xdWVyeS1wYXJhbSc7XG5pbXBvcnQgeyBDaGFuZ2VEYXRhUXVlcnlSZXN1bHQgfSBmcm9tICcuLi9tb2RlbC9jaGFuZ2UtZGF0YS1xdWVyeS1yZXN1bHQnO1xuaW1wb3J0IHsgQ2hnTG9nQ29uZmlnRmllbGQgfSBmcm9tICcuLi9tb2RlbC9jaGdkci1jb25maWctZmllbGQnO1xuaW1wb3J0IHsgT3BlcmF0ZVR5cGUgfSBmcm9tICcuLi9tb2RlbC9vcGVyYXRlLXR5cGUnO1xuaW1wb3J0IHsgTWFwVXRpbCB9IGZyb20gJy4uL3V0aWwvbWFwLnV0aWwnO1xuXG5jb25zdCBTZXJ2ZXJJUCA9ICcvJztcbmNvbnN0IGNoZ2RyVXJsID0gYCR7U2VydmVySVB9YXBpL3J1bnRpbWUvY2hnZHIvdjEuMGA7XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIENoZ2RyU2VydmljZSB7XG4gIHByaXZhdGUgcm9vdERhdGFDb2RlRmllbGRzTWFwOiBNYXA8c3RyaW5nLCBDaGdMb2dDb25maWdGaWVsZFtdPiA9IG5ldyBNYXAoKTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGh0dHA6IEh0dHBTZXJ2aWNlLFxuICAgIHByaXZhdGUgc2Vzc2lvblNlcnZpY2U6IFNlc3Npb25TZXJ2aWNlLFxuICAgIHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yKSB7IH1cblxuICBwdWJsaWMgcXVlcnlDaGFuZ2VEYXRhSGVhZGVyKGN1cnJlbnRRdWVyeVBhcmFtOiBDaGFuZ2VEYXRhUXVlcnlQYXJhbSk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgbGV0IG9iajogYW55ID0gT2JqZWN0LmFzc2lnbih7fSwgY3VycmVudFF1ZXJ5UGFyYW0pO1xuICAgIGlmIChjdXJyZW50UXVlcnlQYXJhbS5kYXRhQ29kZSkge1xuICAgICAgb2JqLmRhdGFDb2RlID0gTWFwVXRpbC5jb252ZXJ0TWFwVG9PYmplY3QoY3VycmVudFF1ZXJ5UGFyYW0uZGF0YUNvZGUpO1xuICAgIH1cblxuICAgIGxldCBqc29uID0gSlNPTi5zdHJpbmdpZnkob2JqKTtcbiAgICBsZXQgcXVlcnlQYXJhbSA9IGVuY29kZVVSSUNvbXBvbmVudChqc29uKTtcbiAgICBsZXQgdXJsID0gYCR7Y2hnZHJVcmx9P3F1ZXJ5UGFyYW09JHtxdWVyeVBhcmFtfWA7XG4gICAgcmV0dXJuIHRoaXMuaHR0cC5nZXQodXJsKS5waXBlKG1hcChkYXRhID0+IHtcbiAgICAgIGlmICghZGF0YSkge1xuICAgICAgICByZXR1cm4gZGF0YTtcbiAgICAgIH1cbiAgICAgIGxldCBxdWVyeVJlc3VsdDogQ2hhbmdlRGF0YVF1ZXJ5UmVzdWx0ID0gPENoYW5nZURhdGFRdWVyeVJlc3VsdD48dW5rbm93bj5kYXRhO1xuICAgICAgcXVlcnlSZXN1bHQgJiYgcXVlcnlSZXN1bHQuaGVhZGVycyAmJiBxdWVyeVJlc3VsdC5oZWFkZXJzLmZvckVhY2goaGVhZGVyID0+IHtcbiAgICAgICAgLy9UT0RPIOW+heWIoO+8jOWFvOWuueiAgeaVsOaNruagvOW8j1xuICAgICAgICBpZiAodHlwZW9mIGhlYWRlci5kYXRhQ29kZSA9PSBcInN0cmluZ1wiKSB7XG4gICAgICAgICAgaGVhZGVyLmRhdGFDb2RlID0gSlNPTi5wYXJzZShoZWFkZXIuZGF0YUNvZGUpO1xuICAgICAgICB9XG5cbiAgICAgICAgaGVhZGVyLmRhdGFDb2RlID0gTWFwVXRpbC5jb252ZXJ0T2JqZWN0VG9NYXAoaGVhZGVyLmRhdGFDb2RlKTtcbiAgICAgICAgaGVhZGVyLmNoYW5nZVRpbWUgPSB0aGlzLnRvRGF0ZShoZWFkZXIuY2hhbmdlVGltZSk7XG4gICAgICAgIGhlYWRlci5vcGVyYXRlVHlwZSA9IE9wZXJhdGVUeXBlLnBhcnNlKGhlYWRlci5vcGVyYXRlVHlwZSk7XG4gICAgICB9KVxuICAgICAgcmV0dXJuIHF1ZXJ5UmVzdWx0O1xuICAgIH0pKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRSb290RW50aXR5RGF0YUNvZGVGaWVsZHMoYmVJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxDaGdMb2dDb25maWdGaWVsZFtdPiB7XG4gICAgaWYgKCFiZUlkKSB7XG4gICAgICByZXR1cm4gb2YoW10pO1xuICAgIH1cbiAgICBpZiAodGhpcy5yb290RGF0YUNvZGVGaWVsZHNNYXAuaGFzKGJlSWQpKSB7XG4gICAgICAvL+ebtOaOpeS7jue8k+WtmOS4reiOt+WPllxuICAgICAgcmV0dXJuIG9mKHRoaXMucm9vdERhdGFDb2RlRmllbGRzTWFwLmdldChiZUlkKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8v6I635Y+W57uT5p6c5bm25a2Y5YWl57yT5a2YXG4gICAgICBsZXQgdXJsID0gYCR7Y2hnZHJVcmx9L3Jvb3REYXRhQ29kZUZpZWxkcz9iZUlkPSR7YmVJZH1gO1xuICAgICAgcmV0dXJuICg8T2JzZXJ2YWJsZTxDaGdMb2dDb25maWdGaWVsZFtdPj48dW5rbm93bj4odGhpcy5odHRwLmdldCh1cmwpKSlcbiAgICAgICAgLnBpcGUodGFwKGRhdGEgPT4gdGhpcy5yb290RGF0YUNvZGVGaWVsZHNNYXAuc2V0KGJlSWQsIGRhdGEpKSk7XG4gICAgfVxuICB9XG5cbiAgLyoqIOWwhuWtl+espuS4suaIluaVsOWtl+i9rOS4ukRhdGUgKi9cbiAgcHJpdmF0ZSB0b0RhdGUoZGF0ZTogYW55KTogRGF0ZSB7XG4gICAgaWYgKHR5cGVvZiBkYXRlID09IFwic3RyaW5nXCIpIHtcbiAgICAgIHJldHVybiBuZXcgRGF0ZShkYXRlKTtcbiAgICB9IGVsc2UgaWYgKHR5cGVvZiBkYXRlID09IFwibnVtYmVyXCIpIHtcbiAgICAgIHJldHVybiBuZXcgRGF0ZShkYXRlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIGRhdGU7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGdldENoYW5nZURhdGEoaWQ6IHN0cmluZywgY2hhbmdlVGltZTogRGF0ZSk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgbGV0IGpzb24gPSBKU09OLnN0cmluZ2lmeShjaGFuZ2VUaW1lKTtcbiAgICBsZXQgcXVlcnlQYXJhbSA9IGVuY29kZVVSSUNvbXBvbmVudChqc29uKTtcbiAgICBsZXQgdXJsID0gYCR7Y2hnZHJVcmx9LyR7aWR9P2NoYW5nZVRpbWU9JHtxdWVyeVBhcmFtfWA7XG4gICAgcmV0dXJuIHRoaXMuaHR0cC5nZXQodXJsKS5waXBlKG1hcChkYXRhID0+IHtcbiAgICAgIGlmICghZGF0YSkge1xuICAgICAgICByZXR1cm4gZGF0YTtcbiAgICAgIH1cbiAgICAgIGxldCBzaDogQ2hhbmdlRGF0YUhlYWRlciA9IDxDaGFuZ2VEYXRhSGVhZGVyPjx1bmtub3duPmRhdGE7XG4gICAgICAvL1RPRE8g5b6F5Yig77yM5YW85a656ICB5pWw5o2u5qC85byPXG4gICAgICBpZiAodHlwZW9mIHNoLmRhdGFDb2RlID09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgc2guZGF0YUNvZGUgPSBKU09OLnBhcnNlKHNoLmRhdGFDb2RlKTtcbiAgICAgIH1cbiAgICAgIHNoLmRhdGFDb2RlID0gTWFwVXRpbC5jb252ZXJ0T2JqZWN0VG9NYXAoc2guZGF0YUNvZGUpO1xuICAgICAgc2guY2hhbmdlVGltZSA9IHRoaXMudG9EYXRlKHNoLmNoYW5nZVRpbWUpO1xuICAgICAgc2gub3BlcmF0ZVR5cGUgPSBPcGVyYXRlVHlwZS5wYXJzZShzaC5vcGVyYXRlVHlwZSk7XG5cbiAgICAgIHNoLnJvd3MgPSBzaC5yb3dzIHx8IFtdO1xuXG4gICAgICBzaC5yb3dzLmZvckVhY2gocm93ID0+IHtcbiAgICAgICAgaWYgKCFyb3cpIHtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgcm93Lm9wZXJhdGVUeXBlID0gT3BlcmF0ZVR5cGUucGFyc2Uocm93Lm9wZXJhdGVUeXBlKTtcbiAgICAgICAgLy9UT0RPIOW+heWIoO+8jOWFvOWuueiAgeaVsOaNruagvOW8j1xuICAgICAgICBpZiAodHlwZW9mIHJvdy5kYXRhQ29kZSA9PSBcInN0cmluZ1wiKSB7XG4gICAgICAgICAgcm93LmRhdGFDb2RlID0gSlNPTi5wYXJzZShyb3cuZGF0YUNvZGUpO1xuICAgICAgICB9XG4gICAgICAgIHJvdy5kYXRhQ29kZSA9IE1hcFV0aWwuY29udmVydE9iamVjdFRvTWFwKHJvdy5kYXRhQ29kZSk7XG4gICAgICAgIHJvdy5vbGRDb250ZW50ID0gPE1hcDxzdHJpbmcsIHN0cmluZz4+TWFwVXRpbC5jb252ZXJ0T2JqZWN0VG9NYXAocm93Lm9sZENvbnRlbnQpIHx8IG5ldyBNYXAoKTtcbiAgICAgICAgcm93Lm5ld0NvbnRlbnQgPSA8TWFwPHN0cmluZywgc3RyaW5nPj5NYXBVdGlsLmNvbnZlcnRPYmplY3RUb01hcChyb3cubmV3Q29udGVudCkgfHwgbmV3IE1hcCgpO1xuICAgICAgfSk7XG4gICAgICByZXR1cm4gc2g7XG4gICAgfSkpO1xuICB9XG59XG4iXX0=