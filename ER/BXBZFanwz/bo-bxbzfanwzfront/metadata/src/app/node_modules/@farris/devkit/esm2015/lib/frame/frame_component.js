/*
 * @Author: Witt
 * @Date: 2019-03-12 14:59:22
 * @Last Modified by: aalizzwell
 * @Last Modified time: 2019-06-15 17:26:07
 */
import { Injector, Injectable, ChangeDetectorRef } from '@angular/core';
import { FrameContext } from './frame_context';
import { Subscription, Declaration } from '../event-mechanism/index';
import { FRAME_COMPONENT_INIT_HANDLER_TOKEN } from './tokens';
class FrameComponent {
    /**
     * 框架构造函数
     * @param injector 注入器
     */
    constructor(injector) {
        this.injector = injector;
        this.initialized = false;
        this.context = this.injector.get(FrameContext, null);
        if (this.context) {
            this.initialize();
        }
        // this.context.init(this);
        // this.viewModel = this.context.viewModel;
        // this.cd = this.getChangeDetectorRef();
        // // 必须先执行context的初始化，然后再初始化Subscription
        // this.initPublicEvent();
        // this.initSubscription();
        // this.restComponent();
    }
    ngOnInit() {
        this.initialize();
    }
    initialize() {
        if (!this.initialized) {
            this.context.init(this);
            this.viewModel = this.context.viewModel;
            this.cd = this.getChangeDetectorRef();
            // 必须先执行context的初始化，然后再初始化Subscription
            this.initPublicEvent();
            this.initSubscription();
            this.restComponent();
            this.onFrameComponentInit();
            this.initialized = true;
        }
    }
    /**
     * 执行组件初始化
     */
    onFrameComponentInit() {
        const frameComponentInitHandlers = this.injector.get(FRAME_COMPONENT_INIT_HANDLER_TOKEN, null);
        if (frameComponentInitHandlers && Array.isArray(frameComponentInitHandlers) && frameComponentInitHandlers.length > 0) {
            frameComponentInitHandlers.forEach((handler) => {
                handler.onComponentInit(this.context);
            });
        }
    }
    /**
     * 获取变更检测器实例
     * @todo：应该通过注入获取，但注入会引起表单编译。
     */
    getChangeDetectorRef() {
        // const cd = this.get<ChangeDetectorRef>(ChangeDetectorRef, null, InjectFlags.Optional);
        const cd = this.injector.get(ChangeDetectorRef, null);
        return cd;
    }
    /**
     * 将当前组件脱离变更检测树
     */
    detach() {
        if (this.isCdValid() === false) {
            return;
        }
        this.cd.detach();
    }
    /**
     * 将当前组件重新加入变更检测树
     */
    reattach() {
        if (this.isCdValid() === false) {
            return;
        }
        this.cd.reattach();
    }
    /**
     * 对当前组件进行一次变更检查
     */
    detectChanges() {
        if (this.isCdValid() === false) {
            return;
        }
        this.cd.detectChanges();
    }
    /**
     * 检测ChangeDetection是否有效
     * @todo: Can't be depend on the destroyed property, destroyed.
     */
    isCdValid() {
        return this.cd && this.cd['destroyed'] === false || false;
    }
    /**
     * 重置组件状态
     * @todo：AppContext是全局的，
     */
    restComponent() {
        if (this.context !== this.context.root) {
            return;
        }
        // 1、如果AppContext不是root并且父AppContext也不是root不清理;
        // 2、表单Module里注入了FARRIS_DEVKIT_APP_PROVIDERS里面有一个冗余的AppContext注入
        //    导致所有AppContext的根是该冗余的AppContext，所以要检测parent.parent。
        // 只清理根组件的session
        if (this.context.appContext.parent !== null && this.context.appContext.parent.parent !== null) {
            return;
        }
        // Repository被注册到全局了，模块依赖注入中的对象，没有重置时机，临时在根组件中进行注销。
        // @todo：应该清理全部repository，目前缺少全局管理所有Repository的地方。
        this.context.repository.reset();
        // 重置组件绑定数据
        this.context.bindingData.reset();
    }
    ngOnDestroy() {
        if (this.context.isRootFrameContext() === true) {
            this.context.appContext.unregisterFromManager(this.context);
        }
        this.eventPipes.forEach((eventPipe) => {
            eventPipe.disposeByCaller(this);
        });
        this.context.destroy();
    }
    /**
     * 初始化事件订阅
     */
    initSubscription() {
        this.subscription = this.getSubscription();
        if (!this.subscription) {
            return;
        }
        this.eventPipes = this.subscription.init(this);
    }
    /**
     * 获取component对应的订阅
     * @returns
     */
    getSubscription() {
        return this.injector.get(Subscription, null);
    }
    initPublicEvent() {
        this.declaration = this.getDeclaration();
        if (!this.declaration) {
            return;
        }
        this.declaration.init(this);
    }
    /**
     * 获取当前component对应的declaration
     * @returns
     */
    getDeclaration() {
        return this.injector.get(Declaration, null);
    }
    /**
     * 事件触发器，触发事件发布
     * @param eventName 待发布事件
     */
    trigger(eventName) {
        const subscription = this.context.commandBus.executingCommandCount$.subscribe((executingCommandCount) => {
            if (executingCommandCount !== 0) {
                return;
            }
            this.innerTrigger(eventName);
            // @todo
            // subscription存在未undefine的情况，待进一步排查。
            if (subscription) {
                subscription.unsubscribe();
            }
            else {
                setTimeout(() => {
                    if (subscription) {
                        subscription.unsubscribe();
                    }
                }, 0);
            }
        });
    }
    /**
     * 内部触发变更检测
     */
    innerTrigger(eventName) {
        // 根据事件名，查找对应的事件处理器
        const eventHandler = this.declaration && this.declaration[eventName];
        if (!eventHandler) {
            return;
        }
        // 执行事件
        eventHandler();
    }
}
FrameComponent.decorators = [
    { type: Injectable }
];
/** @nocollapse */
FrameComponent.ctorParameters = () => [
    { type: Injector }
];
export { FrameComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZnJhbWVfY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9kZXZraXQvIiwic291cmNlcyI6WyJsaWIvZnJhbWUvZnJhbWVfY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7OztHQUtHO0FBRUgsT0FBTyxFQUFFLFFBQVEsRUFBRSxVQUFVLEVBQXlCLGlCQUFpQixFQUFzRixNQUFNLGVBQWUsQ0FBQztBQUVuTCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFFL0MsT0FBTyxFQUFFLFlBQVksRUFBRSxXQUFXLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUVyRSxPQUFPLEVBQUUsa0NBQWtDLEVBQXdCLE1BQU0sVUFBVSxDQUFDO0FBR3BGLE1BQ2UsY0FBYztJQXNDM0I7OztPQUdHO0lBQ0gsWUFBc0IsUUFBa0I7UUFBbEIsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUxoQyxnQkFBVyxHQUFHLEtBQUssQ0FBQztRQU0xQixJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFlLFlBQVksRUFBRSxJQUFJLENBQUMsQ0FBQztRQUNuRSxJQUFJLElBQUksQ0FBQyxPQUFPLEVBQUU7WUFDaEIsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO1NBQ25CO1FBQ0QsMkJBQTJCO1FBQzNCLDJDQUEyQztRQUMzQyx5Q0FBeUM7UUFFekMseUNBQXlDO1FBQ3pDLDBCQUEwQjtRQUUxQiwyQkFBMkI7UUFFM0Isd0JBQXdCO0lBQzFCLENBQUM7SUFFRCxRQUFRO1FBQ04sSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO0lBQ3BCLENBQUM7SUFFTyxVQUFVO1FBQ2hCLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFO1lBQ3JCLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3hCLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLE9BQU8s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cUJBQTZCLEVBQUUsRUFBRTtZQUM5RyxJQUFJLHFCQUFxQixLQUFLLENBQUMsRUFBRTtnQkFDL0IsT0FBTzthQUNSO1lBQ0QsSUFBSSxDQUFDLFlBQVksQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUU3QixRQUFRO1lBQ1IscUNBQXFDO1lBQ3JDLElBQUksWUFBWSxFQUFFO2dCQUNoQixZQUFZLENBQUMsV0FBVyxFQUFFLENBQUM7YUFDNUI7aUJBQU07Z0JBQ0wsVUFBVSxDQUFDLEdBQUcsRUFBRTtvQkFDZCxJQUFJLFlBQVksRUFBRTt3QkFDaEIsWUFBWSxDQUFDLFdBQVcsRUFBRSxDQUFDO3FCQUM1QjtnQkFDSCxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7YUFDUDtRQUVILENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVEOztPQUVHO0lBQ0ssWUFBWSxDQUFDLFNBQWlCO1FBRXBDLG1CQUFtQjtRQUNuQixNQUFNLFlBQVksR0FBUSxJQUFJLENBQUMsV0FBVyxJQUFJLElBQUksQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDMUUsSUFBSSxDQUFDLFlBQVksRUFBRTtZQUNqQixPQUFPO1NBQ1I7UUFDRCxPQUFPO1FBQ1AsWUFBWSxFQUFFLENBQUM7SUFDakIsQ0FBQzs7O1lBelBGLFVBQVU7Ozs7WUFURixRQUFROztBQXNRakIsT0FBTyxFQUFFLGNBQWMsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLypcclxuICogQEF1dGhvcjogV2l0dFxyXG4gKiBARGF0ZTogMjAxOS0wMy0xMiAxNDo1OToyMlxyXG4gKiBATGFzdCBNb2RpZmllZCBieTogYWFsaXp6d2VsbFxyXG4gKiBATGFzdCBNb2RpZmllZCB0aW1lOiAyMDE5LTA2LTE1IDE3OjI2OjA3XHJcbiAqL1xyXG5cclxuaW1wb3J0IHsgSW5qZWN0b3IsIEluamVjdGFibGUsIEluamVjdEZsYWdzLCBPcHRpb25hbCwgQ2hhbmdlRGV0ZWN0b3JSZWYsIE9uRGVzdHJveSwgRWxlbWVudFJlZiwgUmVuZGVyZXIsIFJlbmRlcmVyMiwgUmVuZGVyZXJGYWN0b3J5MiwgQ29tcG9uZW50UmVmLCBPbkluaXQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgZmlsdGVyLCB0YWtlIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBGcmFtZUNvbnRleHQgfSBmcm9tICcuL2ZyYW1lX2NvbnRleHQnO1xyXG5pbXBvcnQgeyBWaWV3TW9kZWwgfSBmcm9tICcuLi92aWV3LW1vZGVsL2luZGV4JztcclxuaW1wb3J0IHsgU3Vic2NyaXB0aW9uLCBEZWNsYXJhdGlvbiB9IGZyb20gJy4uL2V2ZW50LW1lY2hhbmlzbS9pbmRleCc7XHJcbmltcG9ydCB7IElEaXNwb3NhYmxlLCBFdmVudFBpcGUgfSBmcm9tICcuLi9ldmVudC1idXMtbmV3L2luZGV4JztcclxuaW1wb3J0IHsgRlJBTUVfQ09NUE9ORU5UX0lOSVRfSEFORExFUl9UT0tFTiwgb25GcmFtZUNvbXBvbmVudEluaXQgfSBmcm9tICcuL3Rva2Vucyc7XHJcblxyXG5cclxuQEluamVjdGFibGUoKVxyXG5hYnN0cmFjdCBjbGFzcyBGcmFtZUNvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95IHtcclxuXHJcbiAgLyoqXHJcbiAgICog5Y+Y5pu05qOA5rWL5ZmoXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBjZDogQ2hhbmdlRGV0ZWN0b3JSZWY7XHJcblxyXG4gIC8qKlxyXG4gICAqIOahhuaetklEXHJcbiAgICovXHJcbiAgcHVibGljIGlkOiBzdHJpbmc7XHJcblxyXG4gIC8qKlxyXG4gICAqIOahhuaetuS4iuS4i+aWh1xyXG4gICAqL1xyXG4gIHB1YmxpYyBjb250ZXh0OiBGcmFtZUNvbnRleHQ7XHJcblxyXG4gIC8qKlxyXG4gICAqIOinhuWbvuaooeWei1xyXG4gICAqL1xyXG4gIHB1YmxpYyB2aWV3TW9kZWw6IFZpZXdNb2RlbDtcclxuXHJcbiAgLyoqXHJcbiAgICog6K6i6ZiF5LqL5Lu2XHJcbiAgICovXHJcbiAgcHVibGljIHN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uO1xyXG5cclxuICAvKipcclxuICAgKiDlhazlvIDkuovku7ZcclxuICAgKi9cclxuICBwdWJsaWMgZGVjbGFyYXRpb246IERlY2xhcmF0aW9uO1xyXG5cclxuICAvKipcclxuICAgKiDor6Xnu4Tku7borqLpmIXnmoRFdmVudFBpcGVzXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBldmVudFBpcGVzOiBJRGlzcG9zYWJsZVtdO1xyXG5cclxuICBwcml2YXRlIGluaXRpYWxpemVkID0gZmFsc2U7XHJcbiAgLyoqXHJcbiAgICog5qGG5p625p6E6YCg5Ye95pWwXHJcbiAgICogQHBhcmFtIGluamVjdG9yIOazqOWFpeWZqFxyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKHByb3RlY3RlZCBpbmplY3RvcjogSW5qZWN0b3IpIHtcclxuICAgIHRoaXMuY29udGV4dCA9IHRoaXMuaW5qZWN0b3IuZ2V0PEZyYW1lQ29udGV4dD4oRnJhbWVDb250ZXh0LCBudWxsKTtcclxuICAgIGlmICh0aGlzLmNvbnRleHQpIHtcclxuICAgICAgdGhpcy5pbml0aWFsaXplKCk7XHJcbiAgICB9XHJcbiAgICAvLyB0aGlzLmNvbnRleHQuaW5pdCh0aGlzKTtcclxuICAgIC8vIHRoaXMudmlld01vZGVsID0gdGhpcy5jb250ZXh0LnZpZXdNb2RlbDtcclxuICAgIC8vIHRoaXMuY2QgPSB0aGlzLmdldENoYW5nZURldGVjdG9yUmVmKCk7XHJcblxyXG4gICAgLy8gLy8g5b+F6aG75YWI5omn6KGMY29udGV4dOeahOWIneWni+WMlu+8jOeEtuWQjuWGjeWIneWni+WMllN1YnNjcmlwdGlvblxyXG4gICAgLy8gdGhpcy5pbml0UHVibGljRXZlbnQoKTtcclxuXHJcbiAgICAvLyB0aGlzLmluaXRTdWJzY3JpcHRpb24oKTtcclxuXHJcbiAgICAvLyB0aGlzLnJlc3RDb21wb25lbnQoKTtcclxuICB9XHJcblxyXG4gIG5nT25Jbml0KCk6IHZvaWQge1xyXG4gICAgdGhpcy5pbml0aWFsaXplKCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGluaXRpYWxpemUoKSB7XHJcbiAgICBpZiAoIXRoaXMuaW5pdGlhbGl6ZWQpIHtcclxuICAgICAgdGhpcy5jb250ZXh0LmluaXQodGhpcyk7XHJcbiAgICAgIHRoaXMudmlld01vZGVsID0gdGhpcy5jb250ZXh0LnZpZXdNb2RlbDtcclxuICAgICAgdGhpcy5jZCA9IHRoaXMuZ2V0Q2hhbmdlRGV0ZWN0b3JSZWYoKTtcclxuICAgICAgLy8g5b+F6aG75YWI5omn6KGMY29udGV4dOeahOWIneWni+WMlu+8jOeEtuWQjuWGjeWIneWni+WMllN1YnNjcmlwdGlvblxyXG4gICAgICB0aGlzLmluaXRQdWJsaWNFdmVudCgpO1xyXG4gICAgICB0aGlzLmluaXRTdWJzY3JpcHRpb24oKTtcclxuICAgICAgdGhpcy5yZXN0Q29tcG9uZW50KCk7XHJcbiAgICAgIHRoaXMub25GcmFtZUNvbXBvbmVudEluaXQoKTtcclxuICAgICAgdGhpcy5pbml0aWFsaXplZCA9IHRydWU7XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOaJp+ihjOe7hOS7tuWIneWni+WMllxyXG4gICAqL1xyXG4gIHByaXZhdGUgb25GcmFtZUNvbXBvbmVudEluaXQoKSB7XHJcbiAgICBjb25zdCBmcmFtZUNvbXBvbmVudEluaXRIYW5kbGVycyA9IHRoaXMuaW5qZWN0b3IuZ2V0PG9uRnJhbWVDb21wb25lbnRJbml0W10+KEZSQU1FX0NPTVBPTkVOVF9JTklUX0hBTkRMRVJfVE9LRU4sIG51bGwpO1xyXG4gICAgaWYgKGZyYW1lQ29tcG9uZW50SW5pdEhhbmRsZXJzICYmIEFycmF5LmlzQXJyYXkoZnJhbWVDb21wb25lbnRJbml0SGFuZGxlcnMpICYmIGZyYW1lQ29tcG9uZW50SW5pdEhhbmRsZXJzLmxlbmd0aCA+IDApIHtcclxuICAgICAgZnJhbWVDb21wb25lbnRJbml0SGFuZGxlcnMuZm9yRWFjaCgoaGFuZGxlcjogb25GcmFtZUNvbXBvbmVudEluaXQpID0+IHtcclxuICAgICAgICBoYW5kbGVyLm9uQ29tcG9uZW50SW5pdCh0aGlzLmNvbnRleHQpO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICB9XHJcbiAgLyoqXHJcbiAgICog6I635Y+W5Y+Y5pu05qOA5rWL5Zmo5a6e5L6LXHJcbiAgICogQHRvZG/vvJrlupTor6XpgJrov4fms6jlhaXojrflj5bvvIzkvYbms6jlhaXkvJrlvJXotbfooajljZXnvJbor5HjgIJcclxuICAgKi9cclxuICBwcml2YXRlIGdldENoYW5nZURldGVjdG9yUmVmKCkge1xyXG5cclxuICAgIC8vIGNvbnN0IGNkID0gdGhpcy5nZXQ8Q2hhbmdlRGV0ZWN0b3JSZWY+KENoYW5nZURldGVjdG9yUmVmLCBudWxsLCBJbmplY3RGbGFncy5PcHRpb25hbCk7XHJcbiAgICBjb25zdCBjZCA9IHRoaXMuaW5qZWN0b3IuZ2V0KENoYW5nZURldGVjdG9yUmVmLCBudWxsKTtcclxuICAgIHJldHVybiBjZDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWwhuW9k+WJjee7hOS7tuiEseemu+WPmOabtOajgOa1i+agkVxyXG4gICAqL1xyXG4gIHB1YmxpYyBkZXRhY2goKSB7XHJcbiAgICBpZiAodGhpcy5pc0NkVmFsaWQoKSA9PT0gZmFsc2UpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgdGhpcy5jZC5kZXRhY2goKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWwhuW9k+WJjee7hOS7tumHjeaWsOWKoOWFpeWPmOabtOajgOa1i+agkVxyXG4gICAqL1xyXG4gIHB1YmxpYyByZWF0dGFjaCgpIHtcclxuICAgIGlmICh0aGlzLmlzQ2RWYWxpZCgpID09PSBmYWxzZSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICB0aGlzLmNkLnJlYXR0YWNoKCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDlr7nlvZPliY3nu4Tku7bov5vooYzkuIDmrKHlj5jmm7Tmo4Dmn6VcclxuICAgKi9cclxuICBwdWJsaWMgZGV0ZWN0Q2hhbmdlcygpIHtcclxuICAgIGlmICh0aGlzLmlzQ2RWYWxpZCgpID09PSBmYWxzZSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICB0aGlzLmNkLmRldGVjdENoYW5nZXMoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOajgOa1i0NoYW5nZURldGVjdGlvbuaYr+WQpuacieaViFxyXG4gICAqIEB0b2RvOiBDYW4ndCBiZSBkZXBlbmQgb24gdGhlIGRlc3Ryb3llZCBwcm9wZXJ0eSwgZGVzdHJveWVkLlxyXG4gICAqL1xyXG4gIHByaXZhdGUgaXNDZFZhbGlkKCkge1xyXG4gICAgcmV0dXJuIHRoaXMuY2QgJiYgdGhpcy5jZFsnZGVzdHJveWVkJ10gPT09IGZhbHNlIHx8IGZhbHNlO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6YeN572u57uE5Lu254q25oCBXHJcbiAgICogQHRvZG/vvJpBcHBDb250ZXh05piv5YWo5bGA55qE77yMXHJcbiAgICovXHJcbiAgcHVibGljIHJlc3RDb21wb25lbnQoKSB7XHJcbiAgICBpZiAodGhpcy5jb250ZXh0ICE9PSB0aGlzLmNvbnRleHQucm9vdCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICAvLyAx44CB5aaC5p6cQXBwQ29udGV4dOS4jeaYr3Jvb3TlubbkuJTniLZBcHBDb250ZXh05Lmf5LiN5pivcm9vdOS4jea4heeQhjtcclxuICAgIC8vIDLjgIHooajljZVNb2R1bGXph4zms6jlhaXkuoZGQVJSSVNfREVWS0lUX0FQUF9QUk9WSURFUlPph4zpnaLmnInkuIDkuKrlhpfkvZnnmoRBcHBDb250ZXh05rOo5YWlXHJcbiAgICAvLyAgICDlr7zoh7TmiYDmnIlBcHBDb250ZXh055qE5qC55piv6K+l5YaX5L2Z55qEQXBwQ29udGV4dO+8jOaJgOS7peimgeajgOa1i3BhcmVudC5wYXJlbnTjgIJcclxuICAgIC8vIOWPqua4heeQhuaguee7hOS7tueahHNlc3Npb25cclxuICAgIGlmICh0aGlzLmNvbnRleHQuYXBwQ29udGV4dC5wYXJlbnQgIT09IG51bGwgJiYgdGhpcy5jb250ZXh0LmFwcENvbnRleHQucGFyZW50LnBhcmVudCAhPT0gbnVsbCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgLy8gUmVwb3NpdG9yeeiiq+azqOWGjOWIsOWFqOWxgOS6hu+8jOaooeWdl+S+nei1luazqOWFpeS4reeahOWvueixoe+8jOayoeaciemHjee9ruaXtuacuu+8jOS4tOaXtuWcqOaguee7hOS7tuS4rei/m+ihjOazqOmUgOOAglxyXG4gICAgLy8gQHRvZG/vvJrlupTor6XmuIXnkIblhajpg6hyZXBvc2l0b3J577yM55uu5YmN57y65bCR5YWo5bGA566h55CG5omA5pyJUmVwb3NpdG9yeeeahOWcsOaWueOAglxyXG4gICAgdGhpcy5jb250ZXh0LnJlcG9zaXRvcnkucmVzZXQoKTtcclxuICAgIC8vIOmHjee9rue7hOS7tue7keWumuaVsOaNrlxyXG4gICAgdGhpcy5jb250ZXh0LmJpbmRpbmdEYXRhLnJlc2V0KCk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgbmdPbkRlc3Ryb3koKSB7XHJcbiAgICBpZiAodGhpcy5jb250ZXh0LmlzUm9vdEZyYW1lQ29udGV4dCgpID09PSB0cnVlKSB7XHJcbiAgICAgIHRoaXMuY29udGV4dC5hcHBDb250ZXh0LnVucmVnaXN0ZXJGcm9tTWFuYWdlcih0aGlzLmNvbnRleHQpO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuZXZlbnRQaXBlcy5mb3JFYWNoKChldmVudFBpcGU6IElEaXNwb3NhYmxlKSA9PiB7XHJcbiAgICAgIChldmVudFBpcGUgYXMgRXZlbnRQaXBlKS5kaXNwb3NlQnlDYWxsZXIodGhpcyk7XHJcbiAgICB9KTtcclxuXHJcbiAgICB0aGlzLmNvbnRleHQuZGVzdHJveSgpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5Yid5aeL5YyW5LqL5Lu26K6i6ZiFXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBpbml0U3Vic2NyaXB0aW9uKCkge1xyXG4gICAgdGhpcy5zdWJzY3JpcHRpb24gPSB0aGlzLmdldFN1YnNjcmlwdGlvbigpO1xyXG4gICAgaWYgKCF0aGlzLnN1YnNjcmlwdGlvbikge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5ldmVudFBpcGVzID0gdGhpcy5zdWJzY3JpcHRpb24uaW5pdCh0aGlzKTtcclxuICB9XHJcblxyXG5cclxuICAvKipcclxuICAgKiDojrflj5Zjb21wb25lbnTlr7nlupTnmoTorqLpmIVcclxuICAgKiBAcmV0dXJucyBcclxuICAgKi9cclxuICBwdWJsaWMgZ2V0U3Vic2NyaXB0aW9uKCkge1xyXG4gICAgcmV0dXJuIHRoaXMuaW5qZWN0b3IuZ2V0PFN1YnNjcmlwdGlvbj4oU3Vic2NyaXB0aW9uLCBudWxsKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgaW5pdFB1YmxpY0V2ZW50KCkge1xyXG5cclxuICAgIHRoaXMuZGVjbGFyYXRpb24gPSB0aGlzLmdldERlY2xhcmF0aW9uKCk7XHJcbiAgICBpZiAoIXRoaXMuZGVjbGFyYXRpb24pIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuZGVjbGFyYXRpb24uaW5pdCh0aGlzKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluW9k+WJjWNvbXBvbmVudOWvueW6lOeahGRlY2xhcmF0aW9uXHJcbiAgICogQHJldHVybnMgXHJcbiAgICovXHJcbiAgcHVibGljIGdldERlY2xhcmF0aW9uKCkge1xyXG4gICAgcmV0dXJuIHRoaXMuaW5qZWN0b3IuZ2V0PERlY2xhcmF0aW9uPihEZWNsYXJhdGlvbiwgbnVsbCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDkuovku7bop6blj5HlmajvvIzop6blj5Hkuovku7blj5HluINcclxuICAgKiBAcGFyYW0gZXZlbnROYW1lIOW+heWPkeW4g+S6i+S7tlxyXG4gICAqL1xyXG4gIHB1YmxpYyB0cmlnZ2VyKGV2ZW50TmFtZTogc3RyaW5nKSB7XHJcbiAgICBjb25zdCBzdWJzY3JpcHRpb24gPSB0aGlzLmNvbnRleHQuY29tbWFuZEJ1cy5leGVjdXRpbmdDb21tYW5kQ291bnQkLnN1YnNjcmliZSgoZXhlY3V0aW5nQ29tbWFuZENvdW50OiBudW1iZXIpID0+IHtcclxuICAgICAgaWYgKGV4ZWN1dGluZ0NvbW1hbmRDb3VudCAhPT0gMCkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG4gICAgICB0aGlzLmlubmVyVHJpZ2dlcihldmVudE5hbWUpO1xyXG5cclxuICAgICAgLy8gQHRvZG9cclxuICAgICAgLy8gc3Vic2NyaXB0aW9u5a2Y5Zyo5pyqdW5kZWZpbmXnmoTmg4XlhrXvvIzlvoXov5vkuIDmraXmjpLmn6XjgIJcclxuICAgICAgaWYgKHN1YnNjcmlwdGlvbikge1xyXG4gICAgICAgIHN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgaWYgKHN1YnNjcmlwdGlvbikge1xyXG4gICAgICAgICAgICBzdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9LCAwKTtcclxuICAgICAgfVxyXG5cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5YaF6YOo6Kem5Y+R5Y+Y5pu05qOA5rWLXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBpbm5lclRyaWdnZXIoZXZlbnROYW1lOiBzdHJpbmcpIHtcclxuXHJcbiAgICAvLyDmoLnmja7kuovku7blkI3vvIzmn6Xmib7lr7nlupTnmoTkuovku7blpITnkIblmahcclxuICAgIGNvbnN0IGV2ZW50SGFuZGxlcjogYW55ID0gdGhpcy5kZWNsYXJhdGlvbiAmJiB0aGlzLmRlY2xhcmF0aW9uW2V2ZW50TmFtZV07XHJcbiAgICBpZiAoIWV2ZW50SGFuZGxlcikge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICAvLyDmiafooYzkuovku7ZcclxuICAgIGV2ZW50SGFuZGxlcigpO1xyXG4gIH1cclxuXHJcbn1cclxuXHJcbmV4cG9ydCB7IEZyYW1lQ29tcG9uZW50IH07XHJcbiJdfQ==