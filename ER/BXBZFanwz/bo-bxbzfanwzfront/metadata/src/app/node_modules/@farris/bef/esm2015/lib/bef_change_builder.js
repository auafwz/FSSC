/**
 * @fileoverview added by tsickle
 * Generated from: lib/bef_change_builder.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/*
 * @Author: Witt
 * @Date: 2018-10-19 15:35:39
 * @Last Modified by: Witt
 * @Last Modified time: 2018-11-18 16:15:47
 */
import { ModifyType } from '@farris/devkit';
import { ChangeDetailType } from './types';
import { EntityUtil } from './entity_util';
/**
 * BEF变更集构造器
 */
class BefChangeBuilder {
    /**
     * 构造函数
     * @param {?} entityType 实体类型
     * @param {?} entityCollection
     */
    constructor(entityType, entityCollection) {
        this.entityType = entityType;
        this.entityCollection = entityCollection;
    }
    /**
     * 构造Bef变更集
     * @param {?} modifications
     * @return {?}
     */
    build(modifications) {
        // 重置changeDetail
        this.changeDetail = {
            ChangeType: ChangeDetailType.Modify,
            ChangeInfo: {
                DataId: ''
            }
        };
        modifications.forEach((/**
         * @param {?} modification
         * @return {?}
         */
        modification => {
            this.buildChangeDetail(modification);
        }));
        // console.log(this.changeDetail);
        return this.changeDetail;
    }
    /**
     * 构造Bef变更详情
     * @param {?} modification
     * @return {?}
     */
    buildChangeDetail(modification) {
        /** @type {?} */
        const paths = modification.path.concat();
        // 设置根节点DataId
        if (!this.changeDetail.ChangeInfo.DataId) {
            this.changeDetail.ChangeInfo.DataId = paths[0].split(':')[1];
        }
        /** @type {?} */
        let parentChangeDetail = this.changeDetail;
        /** @type {?} */
        let parentEntityType = this.entityType;
        for (let i = 1; i < paths.length && parentChangeDetail; i = i + 2) {
            /** @type {?} */
            const parentChangeInfo = this.getChangeInfo(parentChangeDetail);
            /** @type {?} */
            const propName = paths[i];
            const { propType, propEntityType, propMetadata } = EntityUtil.getPropInfo(parentEntityType, propName);
            /** @type {?} */
            const dataField = propMetadata.dataField || propName;
            if (propType === 'NgField') {
                // 不支持主键变更，忽略
                /** @type {?} */
                const primaryKey = EntityUtil.getPrimaryKey(parentEntityType);
                if (propName === primaryKey) {
                    continue;
                }
                if (modification.type !== ModifyType.ValueChange) {
                    throw Error('简单类型的属性上不支持ValueChange类型之外的变更');
                }
                // NgField类型：说明是最后一级
                parentChangeInfo[dataField] = modification.value;
                parentChangeDetail = null;
            }
            else if (propType === 'NgObject') {
                // NgObject属性本身无法触发变更，只有它的子节点才能触发，所以它上边的变更永远是Modify类型的。
                /** @type {?} */
                const childId = paths[i + 1].split(':')[1];
                /** @type {?} */
                const childIdName = paths[i + 1].split(':')[0];
                if (childIdName) {
                    // 有主键（关联对象）：是一个普通的对象
                    /** @type {?} */
                    let changeObject = parentChangeInfo[dataField];
                    // 获取数据
                    /** @type {?} */
                    const entityPath = paths.slice(0, i + 1);
                    /** @type {?} */
                    const changedEntity = this.entityCollection.getEntityByPath(entityPath);
                    changeObject = changedEntity ? changedEntity.toJSON(true) : {};
                    parentChangeInfo[dataField] = changeObject;
                    parentChangeDetail = null;
                    parentEntityType = null;
                }
                else {
                    // 没有主键（值对象）：是一个完整的ChangeDetail
                    /** @type {?} */
                    let changeDetail = (/** @type {?} */ (parentChangeInfo[dataField]));
                    if (!changeDetail) {
                        changeDetail = {
                            ChangeType: ChangeDetailType.Modify,
                            ChangeInfo: {}
                        };
                    }
                    parentChangeInfo[dataField] = changeDetail;
                    parentChangeDetail = changeDetail;
                    parentEntityType = propEntityType;
                }
            }
            else if (propType === 'NgList') {
                // 如果不存在则创建一个空数组
                if (!parentChangeDetail.ChangeInfo[dataField]) {
                    parentChangeDetail.ChangeInfo[dataField] = [];
                }
                /** @type {?} */
                const changeDetails = (/** @type {?} */ (parentChangeDetail.ChangeInfo[dataField]));
                // 如果这个属性，不是叶子节点，需要查找当前属性是否已经存在对应ChangeDetail：
                // 1、不存在：创建一个Modify类型的ChangeDetail；
                // 2、存在：返回查找到的ChangeDetai，这个ChangeDetail可能是一个Add类型也可能是一个Modify类型；
                // 3、现状：目前BEF不支持Add类型的变更，肯定是一个Modify类型的变更。
                if (i !== paths.length - 1) {
                    // 遍历检查变更是否已经存在
                    /** @type {?} */
                    const dataId = paths[i + 1].split(':')[1];
                    /** @type {?} */
                    let changeDetail = changeDetails.find((/**
                     * @param {?} changeDetailItem
                     * @return {?}
                     */
                    changeDetailItem => {
                        return changeDetailItem.ChangeInfo.DataId === dataId;
                    }));
                    // 如果不存在，则创建并添加
                    if (!changeDetail) {
                        changeDetail = this.createEmptyChangeDetail(ChangeDetailType.Modify, dataId);
                        changeDetails.push(changeDetail);
                    }
                    parentChangeDetail = changeDetail;
                    parentEntityType = propEntityType;
                    continue;
                }
                // 如果是叶子节点，则肯定是新增或者删除变更。
                if (modification.type === ModifyType.Add || modification.type === ModifyType.Insert) {
                    // // 遍历添加
                    // modification.value.forEach((entity: any) => {
                    //   this.addAddChangeDetail(changeDetails, entity.toJSON(), propEntityType);
                    // });
                }
                else if (modification.type === ModifyType.Remove) {
                    // @todo：删除变更直接向服务器端提交了，不需要再次提交
                    // 遍历变更集，添加移除变更
                    // modification.value.forEach((entityData) => {
                    //   this.addRemoveChangeDetail(changeDetails, entityData, propEntityType);
                    // });
                }
                // 重置
                parentChangeDetail = null;
                parentEntityType = null;
            }
            else if (propType === 'NgDynamic') {
                // 获取数据
                /** @type {?} */
                const entityPath = paths.slice(0, i + 1);
                /** @type {?} */
                const changedEntity = this.entityCollection.getEntityByPath(entityPath);
                parentChangeInfo[dataField] = {
                    ChangeType: ChangeDetailType.Modify,
                    ChangeInfo: changedEntity ? changedEntity.toJSON(true) : {}
                };
                parentChangeDetail = null;
                parentEntityType = null;
            }
        }
    }
    /**
     * 获取变更信息
     * 在整个ChangeDetail树上，存在两种类型的节点
     * ChangeDetail：实体变更、值对象变更（没有DataID）
     * PlainObject: 关联对象的变更
     * 从这两种节点上拿具体变更信息的时候，需要统一处理，屏蔽这个差异。
     * \@todo：为这两种节点封装ChangeNode基类来解决这个差异。
     * @private
     * @param {?} changeDetail
     * @return {?}
     */
    getChangeInfo(changeDetail) {
        // @todo：可能存在同名属性
        if (changeDetail.hasOwnProperty('ChangeInfo')) {
            return changeDetail.ChangeInfo;
        }
        else {
            return changeDetail;
        }
    }
    /**
     * 创建ChangeDetail
     * @private
     * @param {?} type BEF变更类型
     * @param {?} dataId 数据内码
     * @return {?}
     */
    createEmptyChangeDetail(type, dataId) {
        /** @type {?} */
        const changeDetail = {
            ChangeType: type,
            ChangeInfo: {
                DataId: dataId
            }
        };
        return changeDetail;
    }
}
if (false) {
    /**
     * Bef变更集
     * @type {?}
     */
    BefChangeBuilder.prototype.changeDetail;
    /**
     * @type {?}
     * @private
     */
    BefChangeBuilder.prototype.entityType;
    /**
     * @type {?}
     * @private
     */
    BefChangeBuilder.prototype.entityCollection;
}
export { BefChangeBuilder };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmVmX2NoYW5nZV9idWlsZGVyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9iZWYvIiwic291cmNlcyI6WyJsaWIvYmVmX2NoYW5nZV9idWlsZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBUUEsT0FBTyxFQUFnQixVQUFVLEVBQStDLE1BQU0sZ0JBQWdCLENBQUM7QUFDdkcsT0FBTyxFQUFFLGdCQUFnQixFQUFnQixNQUFNLFNBQVMsQ0FBQztBQUN6RCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDOzs7O0FBTTNDLE1BQU0sZ0JBQWdCOzs7Ozs7SUFXcEIsWUFDVSxVQUF3QixFQUN4QixnQkFBMEM7UUFEMUMsZUFBVSxHQUFWLFVBQVUsQ0FBYztRQUN4QixxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQTBCO0lBRXBELENBQUM7Ozs7OztJQU1NLEtBQUssQ0FBQyxhQUE2QjtRQUV4QyxpQkFBaUI7UUFDakIsSUFBSSxDQUFDLFlBQVksR0FBRztZQUNsQixVQUFVLEVBQUUsZ0JBQWdCLENBQUMsTUFBTTtZQUNuQyxVQUFVLEVBQUU7Z0JBQ1YsTUFBTSxFQUFFLEVBQUU7YUFDWDtTQUNGLENBQUM7UUFFRixhQUFhLENBQUMsT0FBTzs7OztRQUFDLFlBQVksQ0FBQyxFQUFFO1lBQ25DLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUN2QyxDQUFDLEVBQUMsQ0FBQztRQUVILGtDQUFrQztRQUNsQyxPQUFPLElBQUksQ0FBQyxZQUFZLENBQUM7SUFDM0IsQ0FBQzs7Ozs7O0lBS00saUJBQWlCLENBQUMsWUFBMEI7O2NBRTNDLEtBQUssR0FBRyxZQUFZLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRTtRQUV4QyxjQUFjO1FBQ2QsSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDLE1BQU0sRUFBRTtZQUN4QyxJQUFJLENBQUMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxNQUFNLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUM5RDs7WUFFRyxrQkFBa0IsR0FBRyxJQUFJLENBQUMsWUFBWTs7WUFDdEMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLFVBQVU7UUFFdEMsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEtBQUssQ0FBQyxNQUFNLElBQUksa0JBQWtCLEVBQUUsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEVBQUU7O2tCQUUzRCxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLGtCQUFrQixDQUFDOztrQkFDekQsUUFBUSxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUM7a0JBQ25CLEVBQUUsUUFBUSxFQUFFLGNBQWMsRUFBRSxZQUFZLEVBQUUsR0FBRyxVQUFVLENBQUMsV0FBVyxDQUFDLGdCQUFnQixFQUFFLFFBQVEsQ0FBQzs7a0JBQy9GLFNBQVMsR0FBRyxZQUFZLENBQUMsU0FBUyxJQUFJLFFBQVE7WUFFcEQsSUFBSSxRQUFRLEtBQUssU0FBUyxFQUFFOzs7c0JBR3BCLFVBQVUsR0FBRyxVQUFVLENBQUMsYUFBYSxDQUFDLGdCQUFnQixDQUFDO2dCQUM3RCxJQUFJLFFBQVEsS0FBSyxVQUFVLEVBQUU7b0JBQzNCLFNBQVM7aUJBQ1Y7Z0JBRUQsSUFBSSxZQUFZLENBQUMsSUFBSSxLQUFLLFVBQVUsQ0FBQyxXQUFXLEVBQUU7b0JBQ2hELE1BQU0sS0FBSyxDQUFDLCtCQUErQixDQUFDLENBQUM7aUJBQzlDO2dCQUVELG9CQUFvQjtnQkFDcEIsZ0JBQWdCLENBQUMsU0FBUyxDQUFDLEdBQUcsWUFBWSxDQUFDLEtBQUssQ0FBQztnQkFDakQsa0JBQWtCLEdBQUcsSUFBSSxDQUFDO2FBRTNCO2lCQUFNLElBQUksUUFBUSxLQUFLLFVBQVUsRUFBRTs7O3NCQUc1QixPQUFPLEdBQUcsS0FBSyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDOztzQkFDcEMsV0FBVyxHQUFHLEtBQUssQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFFOUMsSUFBSSxXQUFXLEVBQUU7Ozt3QkFHWCxZQUFZLEdBQUcsZ0JBQWdCLENBQUMsU0FBUyxDQUFDOzs7MEJBR3hDLFVBQVUsR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDOzswQkFDbEMsYUFBYSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxlQUFlLENBQUMsVUFBVSxDQUFDO29CQUN2RSxZQUFZLEdBQUcsYUFBYSxDQUFDLENBQUMsQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7b0JBQy9ELGdCQUFnQixDQUFDLFNBQVMsQ0FBQyxHQUFHLFlBQVksQ0FBQztvQkFDM0Msa0JBQWtCLEdBQUcsSUFBSSxDQUFDO29CQUMxQixnQkFBZ0IsR0FBRyxJQUFJLENBQUM7aUJBRXpCO3FCQUFNOzs7d0JBR0QsWUFBWSxHQUFHLG1CQUFBLGdCQUFnQixDQUFDLFNBQVMsQ0FBQyxFQUFnQjtvQkFDOUQsSUFBSSxDQUFDLFlBQVksRUFBRTt3QkFDakIsWUFBWSxHQUFHOzRCQUNiLFVBQVUsRUFBRSxnQkFBZ0IsQ0FBQyxNQUFNOzRCQUNuQyxVQUFVLEVBQUUsRUFBRTt5QkFDZixDQUFDO3FCQUNIO29CQUNELGdCQUFnQixDQUFDLFNBQVMsQ0FBQyxHQUFHLFlBQVksQ0FBQztvQkFDM0Msa0JBQWtCLEdBQUcsWUFBWSxDQUFDO29CQUNsQyxnQkFBZ0IsR0FBRyxjQUFjLENBQUM7aUJBQ25DO2FBRUY7aUJBQU0sSUFBSSxRQUFRLEtBQUssUUFBUSxFQUFFO2dCQUVoQyxnQkFBZ0I7Z0JBQ2hCLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxVQUFVLENBQUMsU0FBUyxDQUFDLEVBQUU7b0JBQzdDLGtCQUFrQixDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsR0FBRyxFQUFFLENBQUM7aUJBQy9DOztzQkFDSyxhQUFhLEdBQUcsbUJBQUEsa0JBQWtCLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxFQUFrQjtnQkFFaEYsOENBQThDO2dCQUM5QyxtQ0FBbUM7Z0JBQ25DLGlFQUFpRTtnQkFDakUsMENBQTBDO2dCQUMxQyxJQUFJLENBQUMsS0FBSyxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTs7OzBCQUdwQixNQUFNLEdBQUcsS0FBSyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDOzt3QkFFckMsWUFBWSxHQUFHLGFBQWEsQ0FBQyxJQUFJOzs7O29CQUFDLGdCQUFnQixDQUFDLEVBQUU7d0JBQ3ZELE9BQU8sZ0JBQWdCLENBQUMsVUFBVSxDQUFDLE1BQU0sS0FBSyxNQUFNLENBQUM7b0JBQ3ZELENBQUMsRUFBQztvQkFFRixlQUFlO29CQUNmLElBQUksQ0FBQyxZQUFZLEVBQUU7d0JBQ2pCLFlBQVksR0FBRyxJQUFJLENBQUMsdUJBQXVCLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQyxDQUFDO3dCQUM3RSxhQUFhLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO3FCQUNsQztvQkFDRCxrQkFBa0IsR0FBRyxZQUFZLENBQUM7b0JBQ2xDLGdCQUFnQixHQUFHLGNBQWMsQ0FBQztvQkFDbEMsU0FBUztpQkFDVjtnQkFFRCx3QkFBd0I7Z0JBQ3hCLElBQUksWUFBWSxDQUFDLElBQUksS0FBSyxVQUFVLENBQUMsR0FBRyxJQUFJLFlBQVksQ0FBQyxJQUFJLEtBQUssVUFBVSxDQUFDLE1BQU0sRUFBRTtvQkFFbkYsVUFBVTtvQkFDVixnREFBZ0Q7b0JBQ2hELDZFQUE2RTtvQkFDN0UsTUFBTTtpQkFDUDtxQkFBTSxJQUFJLFlBQVksQ0FBQyxJQUFJLEtBQUssVUFBVSxDQUFDLE1BQU0sRUFBRTtvQkFFbEQsK0JBQStCO29CQUMvQixlQUFlO29CQUNmLCtDQUErQztvQkFDL0MsMkVBQTJFO29CQUMzRSxNQUFNO2lCQUNQO2dCQUVELEtBQUs7Z0JBQ0wsa0JBQWtCLEdBQUcsSUFBSSxDQUFDO2dCQUMxQixnQkFBZ0IsR0FBRyxJQUFJLENBQUM7YUFFekI7aUJBQU0sSUFBSSxRQUFRLEtBQUssV0FBVyxFQUFFOzs7c0JBRTdCLFVBQVUsR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDOztzQkFDbEMsYUFBYSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxlQUFlLENBQUMsVUFBVSxDQUFDO2dCQUN2RSxnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsR0FBRztvQkFDNUIsVUFBVSxFQUFFLGdCQUFnQixDQUFDLE1BQU07b0JBQ25DLFVBQVUsRUFBRSxhQUFhLENBQUMsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUU7aUJBQzVELENBQUM7Z0JBQ0Ysa0JBQWtCLEdBQUcsSUFBSSxDQUFDO2dCQUMxQixnQkFBZ0IsR0FBRyxJQUFJLENBQUM7YUFDekI7U0FDRjtJQUNILENBQUM7Ozs7Ozs7Ozs7OztJQVdPLGFBQWEsQ0FBQyxZQUFpQjtRQUVyQyxpQkFBaUI7UUFDakIsSUFBSSxZQUFZLENBQUMsY0FBYyxDQUFDLFlBQVksQ0FBQyxFQUFFO1lBQzdDLE9BQU8sWUFBWSxDQUFDLFVBQVUsQ0FBQztTQUNoQzthQUFNO1lBQ0wsT0FBTyxZQUFZLENBQUM7U0FDckI7SUFDSCxDQUFDOzs7Ozs7OztJQVFPLHVCQUF1QixDQUFDLElBQXNCLEVBQUUsTUFBYzs7Y0FDOUQsWUFBWSxHQUFpQjtZQUNqQyxVQUFVLEVBQUUsSUFBSTtZQUNoQixVQUFVLEVBQUU7Z0JBQ1YsTUFBTSxFQUFFLE1BQU07YUFDZjtTQUNGO1FBQ0QsT0FBTyxZQUFZLENBQUM7SUFDdEIsQ0FBQztDQUVGOzs7Ozs7SUE5TUMsd0NBQWtDOzs7OztJQU9oQyxzQ0FBZ0M7Ozs7O0lBQ2hDLDRDQUFrRDs7QUF3TXRELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLypcclxuICogQEF1dGhvcjogV2l0dFxyXG4gKiBARGF0ZTogMjAxOC0xMC0xOSAxNTozNTozOVxyXG4gKiBATGFzdCBNb2RpZmllZCBieTogV2l0dFxyXG4gKiBATGFzdCBNb2RpZmllZCB0aW1lOiAyMDE4LTExLTE4IDE2OjE1OjQ3XHJcbiAqL1xyXG5cclxuaW1wb3J0IHsgVHlwZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBNb2RpZmljYXRpb24sIE1vZGlmeVR5cGUsIEVudGl0eSwgRW50aXR5Q29sbGVjdGlvbiwgRmllbGRNZXRhZGF0YVV0aWwgfSBmcm9tICdAZmFycmlzL2RldmtpdCc7XHJcbmltcG9ydCB7IENoYW5nZURldGFpbFR5cGUsIENoYW5nZURldGFpbCB9IGZyb20gJy4vdHlwZXMnO1xyXG5pbXBvcnQgeyBFbnRpdHlVdGlsIH0gZnJvbSAnLi9lbnRpdHlfdXRpbCc7XHJcblxyXG5cclxuLyoqXHJcbiAqIEJFRuWPmOabtOmbhuaehOmAoOWZqFxyXG4gKi9cclxuY2xhc3MgQmVmQ2hhbmdlQnVpbGRlciB7XHJcblxyXG4gIC8qKlxyXG4gICAqIEJlZuWPmOabtOmbhlxyXG4gICAqL1xyXG4gIHB1YmxpYyBjaGFuZ2VEZXRhaWw6IENoYW5nZURldGFpbDtcclxuXHJcbiAgLyoqXHJcbiAgICog5p6E6YCg5Ye95pWwXHJcbiAgICogQHBhcmFtIGVudGl0eVR5cGUg5a6e5L2T57G75Z6LXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIGVudGl0eVR5cGU6IFR5cGU8RW50aXR5PixcclxuICAgIHByaXZhdGUgZW50aXR5Q29sbGVjdGlvbjogRW50aXR5Q29sbGVjdGlvbjxFbnRpdHk+XHJcbiAgKSB7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmnoTpgKBCZWblj5jmm7Tpm4ZcclxuICAgKiBAcGFyYW0gbW9kaWZpY2F0aW9uc1xyXG4gICAqL1xyXG4gIHB1YmxpYyBidWlsZChtb2RpZmljYXRpb25zOiBNb2RpZmljYXRpb25bXSk6IENoYW5nZURldGFpbCB7XHJcblxyXG4gICAgLy8g6YeN572uY2hhbmdlRGV0YWlsXHJcbiAgICB0aGlzLmNoYW5nZURldGFpbCA9IHtcclxuICAgICAgQ2hhbmdlVHlwZTogQ2hhbmdlRGV0YWlsVHlwZS5Nb2RpZnksXHJcbiAgICAgIENoYW5nZUluZm86IHtcclxuICAgICAgICBEYXRhSWQ6ICcnXHJcbiAgICAgIH1cclxuICAgIH07XHJcblxyXG4gICAgbW9kaWZpY2F0aW9ucy5mb3JFYWNoKG1vZGlmaWNhdGlvbiA9PiB7XHJcbiAgICAgIHRoaXMuYnVpbGRDaGFuZ2VEZXRhaWwobW9kaWZpY2F0aW9uKTtcclxuICAgIH0pO1xyXG5cclxuICAgIC8vIGNvbnNvbGUubG9nKHRoaXMuY2hhbmdlRGV0YWlsKTtcclxuICAgIHJldHVybiB0aGlzLmNoYW5nZURldGFpbDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOaehOmAoEJlZuWPmOabtOivpuaDhVxyXG4gICAqL1xyXG4gIHB1YmxpYyBidWlsZENoYW5nZURldGFpbChtb2RpZmljYXRpb246IE1vZGlmaWNhdGlvbikge1xyXG5cclxuICAgIGNvbnN0IHBhdGhzID0gbW9kaWZpY2F0aW9uLnBhdGguY29uY2F0KCk7XHJcblxyXG4gICAgLy8g6K6+572u5qC56IqC54K5RGF0YUlkXHJcbiAgICBpZiAoIXRoaXMuY2hhbmdlRGV0YWlsLkNoYW5nZUluZm8uRGF0YUlkKSB7XHJcbiAgICAgIHRoaXMuY2hhbmdlRGV0YWlsLkNoYW5nZUluZm8uRGF0YUlkID0gcGF0aHNbMF0uc3BsaXQoJzonKVsxXTtcclxuICAgIH1cclxuXHJcbiAgICBsZXQgcGFyZW50Q2hhbmdlRGV0YWlsID0gdGhpcy5jaGFuZ2VEZXRhaWw7XHJcbiAgICBsZXQgcGFyZW50RW50aXR5VHlwZSA9IHRoaXMuZW50aXR5VHlwZTtcclxuXHJcbiAgICBmb3IgKGxldCBpID0gMTsgaSA8IHBhdGhzLmxlbmd0aCAmJiBwYXJlbnRDaGFuZ2VEZXRhaWw7IGkgPSBpICsgMikge1xyXG5cclxuICAgICAgY29uc3QgcGFyZW50Q2hhbmdlSW5mbyA9IHRoaXMuZ2V0Q2hhbmdlSW5mbyhwYXJlbnRDaGFuZ2VEZXRhaWwpO1xyXG4gICAgICBjb25zdCBwcm9wTmFtZSA9IHBhdGhzW2ldO1xyXG4gICAgICBjb25zdCB7IHByb3BUeXBlLCBwcm9wRW50aXR5VHlwZSwgcHJvcE1ldGFkYXRhIH0gPSBFbnRpdHlVdGlsLmdldFByb3BJbmZvKHBhcmVudEVudGl0eVR5cGUsIHByb3BOYW1lKTtcclxuICAgICAgY29uc3QgZGF0YUZpZWxkID0gcHJvcE1ldGFkYXRhLmRhdGFGaWVsZCB8fCBwcm9wTmFtZTtcclxuXHJcbiAgICAgIGlmIChwcm9wVHlwZSA9PT0gJ05nRmllbGQnKSB7XHJcblxyXG4gICAgICAgIC8vIOS4jeaUr+aMgeS4u+mUruWPmOabtO+8jOW/veeVpVxyXG4gICAgICAgIGNvbnN0IHByaW1hcnlLZXkgPSBFbnRpdHlVdGlsLmdldFByaW1hcnlLZXkocGFyZW50RW50aXR5VHlwZSk7XHJcbiAgICAgICAgaWYgKHByb3BOYW1lID09PSBwcmltYXJ5S2V5KSB7XHJcbiAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChtb2RpZmljYXRpb24udHlwZSAhPT0gTW9kaWZ5VHlwZS5WYWx1ZUNoYW5nZSkge1xyXG4gICAgICAgICAgdGhyb3cgRXJyb3IoJ+eugOWNleexu+Wei+eahOWxnuaAp+S4iuS4jeaUr+aMgVZhbHVlQ2hhbmdl57G75Z6L5LmL5aSW55qE5Y+Y5pu0Jyk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBOZ0ZpZWxk57G75Z6L77ya6K+05piO5piv5pyA5ZCO5LiA57qnXHJcbiAgICAgICAgcGFyZW50Q2hhbmdlSW5mb1tkYXRhRmllbGRdID0gbW9kaWZpY2F0aW9uLnZhbHVlO1xyXG4gICAgICAgIHBhcmVudENoYW5nZURldGFpbCA9IG51bGw7XHJcblxyXG4gICAgICB9IGVsc2UgaWYgKHByb3BUeXBlID09PSAnTmdPYmplY3QnKSB7XHJcblxyXG4gICAgICAgIC8vIE5nT2JqZWN05bGe5oCn5pys6Lqr5peg5rOV6Kem5Y+R5Y+Y5pu077yM5Y+q5pyJ5a6D55qE5a2Q6IqC54K55omN6IO96Kem5Y+R77yM5omA5Lul5a6D5LiK6L6555qE5Y+Y5pu05rC46L+c5pivTW9kaWZ557G75Z6L55qE44CCXHJcbiAgICAgICAgY29uc3QgY2hpbGRJZCA9IHBhdGhzW2kgKyAxXS5zcGxpdCgnOicpWzFdO1xyXG4gICAgICAgIGNvbnN0IGNoaWxkSWROYW1lID0gcGF0aHNbaSArIDFdLnNwbGl0KCc6JylbMF07XHJcblxyXG4gICAgICAgIGlmIChjaGlsZElkTmFtZSkge1xyXG5cclxuICAgICAgICAgIC8vIOacieS4u+mUru+8iOWFs+iBlOWvueixoe+8ie+8muaYr+S4gOS4quaZrumAmueahOWvueixoVxyXG4gICAgICAgICAgbGV0IGNoYW5nZU9iamVjdCA9IHBhcmVudENoYW5nZUluZm9bZGF0YUZpZWxkXTtcclxuXHJcbiAgICAgICAgICAvLyDojrflj5bmlbDmja5cclxuICAgICAgICAgIGNvbnN0IGVudGl0eVBhdGggPSBwYXRocy5zbGljZSgwLCBpICsgMSk7XHJcbiAgICAgICAgICBjb25zdCBjaGFuZ2VkRW50aXR5ID0gdGhpcy5lbnRpdHlDb2xsZWN0aW9uLmdldEVudGl0eUJ5UGF0aChlbnRpdHlQYXRoKTtcclxuICAgICAgICAgIGNoYW5nZU9iamVjdCA9IGNoYW5nZWRFbnRpdHkgPyBjaGFuZ2VkRW50aXR5LnRvSlNPTih0cnVlKSA6IHt9O1xyXG4gICAgICAgICAgcGFyZW50Q2hhbmdlSW5mb1tkYXRhRmllbGRdID0gY2hhbmdlT2JqZWN0O1xyXG4gICAgICAgICAgcGFyZW50Q2hhbmdlRGV0YWlsID0gbnVsbDtcclxuICAgICAgICAgIHBhcmVudEVudGl0eVR5cGUgPSBudWxsO1xyXG5cclxuICAgICAgICB9IGVsc2Uge1xyXG5cclxuICAgICAgICAgIC8vIOayoeacieS4u+mUru+8iOWAvOWvueixoe+8ie+8muaYr+S4gOS4quWujOaVtOeahENoYW5nZURldGFpbFxyXG4gICAgICAgICAgbGV0IGNoYW5nZURldGFpbCA9IHBhcmVudENoYW5nZUluZm9bZGF0YUZpZWxkXSBhcyBDaGFuZ2VEZXRhaWw7XHJcbiAgICAgICAgICBpZiAoIWNoYW5nZURldGFpbCkge1xyXG4gICAgICAgICAgICBjaGFuZ2VEZXRhaWwgPSB7XHJcbiAgICAgICAgICAgICAgQ2hhbmdlVHlwZTogQ2hhbmdlRGV0YWlsVHlwZS5Nb2RpZnksXHJcbiAgICAgICAgICAgICAgQ2hhbmdlSW5mbzoge31cclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIHBhcmVudENoYW5nZUluZm9bZGF0YUZpZWxkXSA9IGNoYW5nZURldGFpbDtcclxuICAgICAgICAgIHBhcmVudENoYW5nZURldGFpbCA9IGNoYW5nZURldGFpbDtcclxuICAgICAgICAgIHBhcmVudEVudGl0eVR5cGUgPSBwcm9wRW50aXR5VHlwZTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICB9IGVsc2UgaWYgKHByb3BUeXBlID09PSAnTmdMaXN0Jykge1xyXG5cclxuICAgICAgICAvLyDlpoLmnpzkuI3lrZjlnKjliJnliJvlu7rkuIDkuKrnqbrmlbDnu4RcclxuICAgICAgICBpZiAoIXBhcmVudENoYW5nZURldGFpbC5DaGFuZ2VJbmZvW2RhdGFGaWVsZF0pIHtcclxuICAgICAgICAgIHBhcmVudENoYW5nZURldGFpbC5DaGFuZ2VJbmZvW2RhdGFGaWVsZF0gPSBbXTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgY2hhbmdlRGV0YWlscyA9IHBhcmVudENoYW5nZURldGFpbC5DaGFuZ2VJbmZvW2RhdGFGaWVsZF0gYXMgQ2hhbmdlRGV0YWlsW107XHJcblxyXG4gICAgICAgIC8vIOWmguaenOi/meS4quWxnuaAp++8jOS4jeaYr+WPtuWtkOiKgueCue+8jOmcgOimgeafpeaJvuW9k+WJjeWxnuaAp+aYr+WQpuW3sue7j+WtmOWcqOWvueW6lENoYW5nZURldGFpbO+8mlxyXG4gICAgICAgIC8vIDHjgIHkuI3lrZjlnKjvvJrliJvlu7rkuIDkuKpNb2RpZnnnsbvlnovnmoRDaGFuZ2VEZXRhaWzvvJtcclxuICAgICAgICAvLyAy44CB5a2Y5Zyo77ya6L+U5Zue5p+l5om+5Yiw55qEQ2hhbmdlRGV0YWnvvIzov5nkuKpDaGFuZ2VEZXRhaWzlj6/og73mmK/kuIDkuKpBZGTnsbvlnovkuZ/lj6/og73mmK/kuIDkuKpNb2RpZnnnsbvlnovvvJtcclxuICAgICAgICAvLyAz44CB546w54q277ya55uu5YmNQkVG5LiN5pSv5oyBQWRk57G75Z6L55qE5Y+Y5pu077yM6IKv5a6a5piv5LiA5LiqTW9kaWZ557G75Z6L55qE5Y+Y5pu044CCXHJcbiAgICAgICAgaWYgKGkgIT09IHBhdGhzLmxlbmd0aCAtIDEpIHtcclxuXHJcbiAgICAgICAgICAvLyDpgY3ljobmo4Dmn6Xlj5jmm7TmmK/lkKblt7Lnu4/lrZjlnKhcclxuICAgICAgICAgIGNvbnN0IGRhdGFJZCA9IHBhdGhzW2kgKyAxXS5zcGxpdCgnOicpWzFdO1xyXG5cclxuICAgICAgICAgIGxldCBjaGFuZ2VEZXRhaWwgPSBjaGFuZ2VEZXRhaWxzLmZpbmQoY2hhbmdlRGV0YWlsSXRlbSA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiBjaGFuZ2VEZXRhaWxJdGVtLkNoYW5nZUluZm8uRGF0YUlkID09PSBkYXRhSWQ7XHJcbiAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAvLyDlpoLmnpzkuI3lrZjlnKjvvIzliJnliJvlu7rlubbmt7vliqBcclxuICAgICAgICAgIGlmICghY2hhbmdlRGV0YWlsKSB7XHJcbiAgICAgICAgICAgIGNoYW5nZURldGFpbCA9IHRoaXMuY3JlYXRlRW1wdHlDaGFuZ2VEZXRhaWwoQ2hhbmdlRGV0YWlsVHlwZS5Nb2RpZnksIGRhdGFJZCk7XHJcbiAgICAgICAgICAgIGNoYW5nZURldGFpbHMucHVzaChjaGFuZ2VEZXRhaWwpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgcGFyZW50Q2hhbmdlRGV0YWlsID0gY2hhbmdlRGV0YWlsO1xyXG4gICAgICAgICAgcGFyZW50RW50aXR5VHlwZSA9IHByb3BFbnRpdHlUeXBlO1xyXG4gICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyDlpoLmnpzmmK/lj7blrZDoioLngrnvvIzliJnogq/lrprmmK/mlrDlop7miJbogIXliKDpmaTlj5jmm7TjgIJcclxuICAgICAgICBpZiAobW9kaWZpY2F0aW9uLnR5cGUgPT09IE1vZGlmeVR5cGUuQWRkIHx8IG1vZGlmaWNhdGlvbi50eXBlID09PSBNb2RpZnlUeXBlLkluc2VydCkge1xyXG5cclxuICAgICAgICAgIC8vIC8vIOmBjeWOhua3u+WKoFxyXG4gICAgICAgICAgLy8gbW9kaWZpY2F0aW9uLnZhbHVlLmZvckVhY2goKGVudGl0eTogYW55KSA9PiB7XHJcbiAgICAgICAgICAvLyAgIHRoaXMuYWRkQWRkQ2hhbmdlRGV0YWlsKGNoYW5nZURldGFpbHMsIGVudGl0eS50b0pTT04oKSwgcHJvcEVudGl0eVR5cGUpO1xyXG4gICAgICAgICAgLy8gfSk7XHJcbiAgICAgICAgfSBlbHNlIGlmIChtb2RpZmljYXRpb24udHlwZSA9PT0gTW9kaWZ5VHlwZS5SZW1vdmUpIHtcclxuXHJcbiAgICAgICAgICAvLyBAdG9kb++8muWIoOmZpOWPmOabtOebtOaOpeWQkeacjeWKoeWZqOerr+aPkOS6pOS6hu+8jOS4jemcgOimgeWGjeasoeaPkOS6pFxyXG4gICAgICAgICAgLy8g6YGN5Y6G5Y+Y5pu06ZuG77yM5re75Yqg56e76Zmk5Y+Y5pu0XHJcbiAgICAgICAgICAvLyBtb2RpZmljYXRpb24udmFsdWUuZm9yRWFjaCgoZW50aXR5RGF0YSkgPT4ge1xyXG4gICAgICAgICAgLy8gICB0aGlzLmFkZFJlbW92ZUNoYW5nZURldGFpbChjaGFuZ2VEZXRhaWxzLCBlbnRpdHlEYXRhLCBwcm9wRW50aXR5VHlwZSk7XHJcbiAgICAgICAgICAvLyB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIOmHjee9rlxyXG4gICAgICAgIHBhcmVudENoYW5nZURldGFpbCA9IG51bGw7XHJcbiAgICAgICAgcGFyZW50RW50aXR5VHlwZSA9IG51bGw7XHJcblxyXG4gICAgICB9IGVsc2UgaWYgKHByb3BUeXBlID09PSAnTmdEeW5hbWljJykge1xyXG4gICAgICAgIC8vIOiOt+WPluaVsOaNrlxyXG4gICAgICAgIGNvbnN0IGVudGl0eVBhdGggPSBwYXRocy5zbGljZSgwLCBpICsgMSk7XHJcbiAgICAgICAgY29uc3QgY2hhbmdlZEVudGl0eSA9IHRoaXMuZW50aXR5Q29sbGVjdGlvbi5nZXRFbnRpdHlCeVBhdGgoZW50aXR5UGF0aCk7XHJcbiAgICAgICAgcGFyZW50Q2hhbmdlSW5mb1tkYXRhRmllbGRdID0ge1xyXG4gICAgICAgICAgQ2hhbmdlVHlwZTogQ2hhbmdlRGV0YWlsVHlwZS5Nb2RpZnksXHJcbiAgICAgICAgICBDaGFuZ2VJbmZvOiBjaGFuZ2VkRW50aXR5ID8gY2hhbmdlZEVudGl0eS50b0pTT04odHJ1ZSkgOiB7fVxyXG4gICAgICAgIH07XHJcbiAgICAgICAgcGFyZW50Q2hhbmdlRGV0YWlsID0gbnVsbDtcclxuICAgICAgICBwYXJlbnRFbnRpdHlUeXBlID0gbnVsbDtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluWPmOabtOS/oeaBr1xyXG4gICAqIOWcqOaVtOS4qkNoYW5nZURldGFpbOagkeS4iu+8jOWtmOWcqOS4pOenjeexu+Wei+eahOiKgueCuVxyXG4gICAqIENoYW5nZURldGFpbO+8muWunuS9k+WPmOabtOOAgeWAvOWvueixoeWPmOabtO+8iOayoeaciURhdGFJRO+8iVxyXG4gICAqIFBsYWluT2JqZWN0OiDlhbPogZTlr7nosaHnmoTlj5jmm7RcclxuICAgKiDku47ov5nkuKTnp43oioLngrnkuIrmi7/lhbfkvZPlj5jmm7Tkv6Hmga/nmoTml7blgJnvvIzpnIDopoHnu5/kuIDlpITnkIbvvIzlsY/olL3ov5nkuKrlt67lvILjgIJcclxuICAgKiBAdG9kb++8muS4uui/meS4pOenjeiKgueCueWwgeijhUNoYW5nZU5vZGXln7rnsbvmnaXop6PlhrPov5nkuKrlt67lvILjgIJcclxuICAgKi9cclxuICBwcml2YXRlIGdldENoYW5nZUluZm8oY2hhbmdlRGV0YWlsOiBhbnkpOiBhbnkge1xyXG5cclxuICAgIC8vIEB0b2Rv77ya5Y+v6IO95a2Y5Zyo5ZCM5ZCN5bGe5oCnXHJcbiAgICBpZiAoY2hhbmdlRGV0YWlsLmhhc093blByb3BlcnR5KCdDaGFuZ2VJbmZvJykpIHtcclxuICAgICAgcmV0dXJuIGNoYW5nZURldGFpbC5DaGFuZ2VJbmZvO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuIGNoYW5nZURldGFpbDtcclxuICAgIH1cclxuICB9XHJcblxyXG5cclxuICAvKipcclxuICAgKiDliJvlu7pDaGFuZ2VEZXRhaWxcclxuICAgKiBAcGFyYW0gdHlwZSBCRUblj5jmm7TnsbvlnotcclxuICAgKiBAcGFyYW0gZGF0YUlkIOaVsOaNruWGheeggVxyXG4gICAqL1xyXG4gIHByaXZhdGUgY3JlYXRlRW1wdHlDaGFuZ2VEZXRhaWwodHlwZTogQ2hhbmdlRGV0YWlsVHlwZSwgZGF0YUlkOiBzdHJpbmcpOiBDaGFuZ2VEZXRhaWwge1xyXG4gICAgY29uc3QgY2hhbmdlRGV0YWlsOiBDaGFuZ2VEZXRhaWwgPSB7XHJcbiAgICAgIENoYW5nZVR5cGU6IHR5cGUsXHJcbiAgICAgIENoYW5nZUluZm86IHtcclxuICAgICAgICBEYXRhSWQ6IGRhdGFJZFxyXG4gICAgICB9XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGNoYW5nZURldGFpbDtcclxuICB9XHJcblxyXG59XHJcblxyXG5leHBvcnQgeyBCZWZDaGFuZ2VCdWlsZGVyIH07XHJcbiJdfQ==