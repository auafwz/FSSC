/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Directive, HostListener, Input, Injector, ElementRef, Renderer2, Optional } from '@angular/core';
import { of } from 'rxjs';
import { FarrisContextMenuService } from './context-menu.service';
export class FarrisContextMenuDirective {
    /**
     * @param {?} ctxMenuSer
     * @param {?} injector
     * @param {?} elRef
     * @param {?} render
     */
    constructor(ctxMenuSer, injector, elRef, render) {
        this.ctxMenuSer = ctxMenuSer;
        this.injector = injector;
        this.elRef = elRef;
        this.render = render;
        this.disabled = false;
        this.highlight = true;
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        this.id = this.contextMenuId();
        if (!this.beforeShowContextMenu) {
            this.beforeShowContextMenu = (/**
             * @return {?}
             */
            () => of(true));
        }
    }
    /**
     * @param {?} event
     * @return {?}
     */
    onContextMenu(event) {
        if (!this.disabled) {
            /** @type {?} */
            let contextMenuDom = null;
            if (this.activeDomName) {
                contextMenuDom = ((/** @type {?} */ (event.target))).closest(this.activeDomName);
                if (contextMenuDom) {
                    this.render.addClass(contextMenuDom, 'f-context-menu-active');
                }
                else {
                    return;
                }
            }
            /** @type {?} */
            const beforeShow$ = this.beforeShowContextMenu({ event, contextMenuDom });
            if (beforeShow$ && beforeShow$.subscribe) {
                beforeShow$.subscribe((/**
                 * @param {?} e
                 * @return {?}
                 */
                (e) => {
                    /** @type {?} */
                    const ctxData = this.getContextData(e);
                    this.removeSurplusMenus();
                    if (ctxData.show) {
                        document.body.click();
                        this.ctxMenuSer.show({
                            menuItems: this.getViewMenuItems(ctxData.data),
                            event,
                            id: this.id,
                            activeDom: contextMenuDom,
                            context: ctxData.data,
                            menuClass: this.menuClass,
                            target: this.elRef.nativeElement,
                            activeWidth: e['focusTargetWidth'],
                            highlight: this.highlight
                        });
                        event.preventDefault();
                        event.stopPropagation();
                    }
                }));
            }
        }
    }
    // 删除第3层及以后的菜单，仅支持两层菜单展示
    /**
     * @private
     * @return {?}
     */
    removeSurplusMenus() {
        if (this.menuItems && this.menuItems.length) {
            this.menuItems.forEach((/**
             * @param {?} m
             * @return {?}
             */
            (m) => {
                if (m !== '-' && m.children && m.children.length) {
                    m.children.forEach((/**
                     * @param {?} cm
                     * @return {?}
                     */
                    cm => {
                        if (cm !== '-') {
                            cm.children = [];
                        }
                    }));
                }
            }));
        }
    }
    /**
     * @private
     * @return {?}
     */
    contextMenuId() {
        /** @type {?} */
        const id = this.elRef.nativeElement.id;
        if (id) {
            return `${id}-context-menu`;
        }
        else {
            return 'context-menu_' + new Date().getTime();
        }
    }
    /**
     * @private
     * @param {?} e
     * @return {?}
     */
    getContextData(e) {
        if (typeof e === 'boolean') {
            return { show: e, data: null };
        }
        return e;
    }
    /**
     * @private
     * @param {?} context
     * @return {?}
     */
    getViewMenuItems(context) {
        if (this.menuItems && this.menuItems.length) {
            return this.checkMenuItems(this.menuItems, context);
        }
        return [];
    }
    /**
     * @private
     * @param {?} menuItems
     * @param {?} context
     * @return {?}
     */
    checkMenuItems(menuItems, context) {
        /** @type {?} */
        const menus = menuItems.map((/**
         * @param {?} m
         * @return {?}
         */
        (m) => {
            if (typeof m === 'string') {
                return m;
            }
            else {
                /** @type {?} */
                const n = this.checkVisibleAndDisable(m, context);
                if (n.children) {
                    n.children = this.checkMenuItems(n.children, context);
                }
                return n;
            }
        })).filter((/**
         * @param {?} n
         * @return {?}
         */
        n => {
            return n === '-' || n.visible;
        }));
        if (menus && menus.length) {
            if (menus[0] === '-') {
                menus.shift(0);
            }
            if (menus[menus.length - 1] === '-') {
                menus.pop(0);
            }
        }
        return menus;
    }
    /**
     * @private
     * @param {?} m
     * @param {?} context
     * @return {?}
     */
    checkVisibleAndDisable(m, context) {
        /** @type {?} */
        const n = Object.assign({}, m);
        if (!n.hasOwnProperty('visible')) {
            n.visible = true;
        }
        else {
            if (typeof n.visible === 'function') {
                n.visible = n.visible(context);
            }
        }
        if (!n.hasOwnProperty('disable')) {
            n.disable = false;
        }
        else {
            if (typeof n.disable === 'function') {
                n.disable = n.disable(context);
            }
        }
        return n;
    }
}
FarrisContextMenuDirective.decorators = [
    { type: Directive, args: [{
                selector: '[farris-context-menus]',
            },] }
];
/** @nocollapse */
FarrisContextMenuDirective.ctorParameters = () => [
    { type: FarrisContextMenuService, decorators: [{ type: Optional }] },
    { type: Injector },
    { type: ElementRef },
    { type: Renderer2 }
];
FarrisContextMenuDirective.propDecorators = {
    menuItems: [{ type: Input, args: ['farris-context-menus',] }],
    menuClass: [{ type: Input }],
    disabled: [{ type: Input }],
    context: [{ type: Input }],
    beforeShowContextMenu: [{ type: Input }],
    activeDomName: [{ type: Input }],
    highlight: [{ type: Input }],
    onContextMenu: [{ type: HostListener, args: ['contextmenu', ['$event'],] }]
};
if (false) {
    /** @type {?} */
    FarrisContextMenuDirective.prototype.menuItems;
    /** @type {?} */
    FarrisContextMenuDirective.prototype.menuClass;
    /** @type {?} */
    FarrisContextMenuDirective.prototype.disabled;
    /** @type {?} */
    FarrisContextMenuDirective.prototype.context;
    /** @type {?} */
    FarrisContextMenuDirective.prototype.beforeShowContextMenu;
    /**
     * 触发右键菜单实际DOM标签名称
     * @type {?}
     */
    FarrisContextMenuDirective.prototype.activeDomName;
    /** @type {?} */
    FarrisContextMenuDirective.prototype.highlight;
    /** @type {?} */
    FarrisContextMenuDirective.prototype.id;
    /**
     * @type {?}
     * @private
     */
    FarrisContextMenuDirective.prototype.ctxMenuSer;
    /**
     * @type {?}
     * @private
     */
    FarrisContextMenuDirective.prototype.injector;
    /**
     * @type {?}
     * @private
     */
    FarrisContextMenuDirective.prototype.elRef;
    /**
     * @type {?}
     * @private
     */
    FarrisContextMenuDirective.prototype.render;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udGV4dC1tZW51LmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvdWktY29udGV4dC1tZW51LyIsInNvdXJjZXMiOlsibGliL2NvbnRleHQtbWVudS5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsWUFBWSxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsVUFBVSxFQUFVLFNBQVMsRUFBd0IsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRXhJLE9BQU8sRUFBRSxFQUFFLEVBQWMsTUFBTSxNQUFNLENBQUM7QUFDdEMsT0FBTyxFQUFFLHdCQUF3QixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFNbEUsTUFBTSxPQUFPLDBCQUEwQjs7Ozs7OztJQVduQyxZQUFnQyxVQUFvQyxFQUNoRCxRQUFrQixFQUFVLEtBQWlCLEVBQVUsTUFBaUI7UUFENUQsZUFBVSxHQUFWLFVBQVUsQ0FBMEI7UUFDaEQsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUFVLFVBQUssR0FBTCxLQUFLLENBQVk7UUFBVSxXQUFNLEdBQU4sTUFBTSxDQUFXO1FBVG5GLGFBQVEsR0FBRyxLQUFLLENBQUM7UUFLakIsY0FBUyxHQUFHLElBQUksQ0FBQztJQUlxRSxDQUFDOzs7O0lBRWhHLFFBQVE7UUFDSixJQUFJLENBQUMsRUFBRSxHQUFHLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUUvQixJQUFJLENBQUMsSUFBSSxDQUFDLHFCQUFxQixFQUFFO1lBQzdCLElBQUksQ0FBQyxxQkFBcUI7OztZQUFHLEdBQUcsRUFBRSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQSxDQUFDO1NBQy9DO0lBQ0wsQ0FBQzs7Ozs7SUFHTSxhQUFhLENBQUMsS0FBaUI7UUFDbEMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUU7O2dCQUNaLGNBQWMsR0FBRyxJQUFJO1lBQ3pCLElBQUksSUFBSSxDQUFDLGFBQWEs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SUFDMUIsd0NBQVc7Ozs7O0lBRUMsZ0RBQXdEOzs7OztJQUN4RCw4Q0FBMEI7Ozs7O0lBQUUsMkNBQXlCOzs7OztJQUFFLDRDQUF5QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERpcmVjdGl2ZSwgSG9zdExpc3RlbmVyLCBJbnB1dCwgSW5qZWN0b3IsIEVsZW1lbnRSZWYsIE9uSW5pdCwgUmVuZGVyZXIyLCBFdmVudEVtaXR0ZXIsIE91dHB1dCwgT3B0aW9uYWwgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgY2xvbmVEZWVwIH0gZnJvbSAnbG9kYXNoLWVzJztcclxuaW1wb3J0IHsgb2YsIE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgRmFycmlzQ29udGV4dE1lbnVTZXJ2aWNlIH0gZnJvbSAnLi9jb250ZXh0LW1lbnUuc2VydmljZSc7XHJcbmltcG9ydCB7IEJlZm9yZVNob3dNZW51LCBDb250ZXh0TWVudUl0ZW0gfSBmcm9tICcuL21lbnUtaXRlbS5pbnRlcmZhY2UnO1xyXG5cclxuQERpcmVjdGl2ZSh7XHJcbiAgICBzZWxlY3RvcjogJ1tmYXJyaXMtY29udGV4dC1tZW51c10nLFxyXG59KVxyXG5leHBvcnQgY2xhc3MgRmFycmlzQ29udGV4dE1lbnVEaXJlY3RpdmUgaW1wbGVtZW50cyBPbkluaXQge1xyXG4gICAgQElucHV0KCdmYXJyaXMtY29udGV4dC1tZW51cycpIG1lbnVJdGVtczogQ29udGV4dE1lbnVJdGVtW107XHJcbiAgICBASW5wdXQoKSBtZW51Q2xhc3M6IHN0cmluZztcclxuICAgIEBJbnB1dCgpIGRpc2FibGVkID0gZmFsc2U7XHJcbiAgICBASW5wdXQoKSBjb250ZXh0OiBhbnk7XHJcbiAgICBASW5wdXQoKSBiZWZvcmVTaG93Q29udGV4dE1lbnU6IChlPzogYW55KSA9PiBPYnNlcnZhYmxlPEJlZm9yZVNob3dNZW51PjtcclxuICAgIC8qKiDop6blj5Hlj7PplK7oj5zljZXlrp7pmYVET03moIfnrb7lkI3np7AgKi9cclxuICAgIEBJbnB1dCgpIGFjdGl2ZURvbU5hbWU6IHN0cmluZztcclxuICAgIEBJbnB1dCgpIGhpZ2hsaWdodCA9IHRydWU7XHJcbiAgICBpZDogc3RyaW5nO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKEBPcHRpb25hbCgpIHByaXZhdGUgY3R4TWVudVNlcjogRmFycmlzQ29udGV4dE1lbnVTZXJ2aWNlLFxyXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IsIHByaXZhdGUgZWxSZWY6IEVsZW1lbnRSZWYsIHByaXZhdGUgcmVuZGVyOiBSZW5kZXJlcjIpIHt9XHJcblxyXG4gICAgbmdPbkluaXQoKSB7XHJcbiAgICAgICAgdGhpcy5pZCA9IHRoaXMuY29udGV4dE1lbnVJZCgpO1xyXG5cclxuICAgICAgICBpZiAoIXRoaXMuYmVmb3JlU2hvd0NvbnRleHRNZW51KSB7XHJcbiAgICAgICAgICAgIHRoaXMuYmVmb3JlU2hvd0NvbnRleHRNZW51ID0gKCkgPT4gb2YodHJ1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIEBIb3N0TGlzdGVuZXIoJ2NvbnRleHRtZW51JywgWyckZXZlbnQnXSlcclxuICAgIHB1YmxpYyBvbkNvbnRleHRNZW51KGV2ZW50OiBNb3VzZUV2ZW50KTogdm9pZCB7XHJcbiAgICAgICAgaWYgKCF0aGlzLmRpc2FibGVkKSB7XHJcbiAgICAgICAgICAgIGxldCBjb250ZXh0TWVudURvbSA9IG51bGw7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmFjdGl2ZURvbU5hbWUpIHtcclxuICAgICAgICAgICAgICAgIGNvbnRleHRNZW51RG9tID0gKGV2ZW50LnRhcmdldCBhcyBhbnkpLmNsb3Nlc3QodGhpcy5hY3RpdmVEb21OYW1lKTtcclxuICAgICAgICAgICAgICAgIGlmIChjb250ZXh0TWVudURvbSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyLmFkZENsYXNzKGNvbnRleHRNZW51RG9tLCAnZi1jb250ZXh0LW1lbnUtYWN0aXZlJyk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgY29uc3QgYmVmb3JlU2hvdyQgPSB0aGlzLmJlZm9yZVNob3dDb250ZXh0TWVudSh7IGV2ZW50LCBjb250ZXh0TWVudURvbSB9KTtcclxuICAgICAgICAgICAgaWYgKGJlZm9yZVNob3ckICYmIGJlZm9yZVNob3ckLnN1YnNjcmliZSkge1xyXG4gICAgICAgICAgICAgICAgYmVmb3JlU2hvdyQuc3Vic2NyaWJlKCAoZTogQmVmb3JlU2hvd01lbnUpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBjdHhEYXRhID0gdGhpcy5nZXRDb250ZXh0RGF0YShlKTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZVN1cnBsdXNNZW51cygpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChjdHhEYXRhLnNob3cpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5jbGljaygpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmN0eE1lbnVTZXIuc2hvdyh7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZW51SXRlbXM6IHRoaXMuZ2V0Vmlld01lbnVJdGVtcyhjdHhEYXRhLmRhdGEpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZDogdGhpcy5pZCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjdGl2ZURvbTogY29udGV4dE1lbnVEb20sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250ZXh0OiBjdHhEYXRhLmRhdGEsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZW51Q2xhc3M6IHRoaXMubWVudUNsYXNzLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0OiB0aGlzLmVsUmVmLm5hdGl2ZUVsZW1lbnQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY3RpdmVXaWR0aDogZVsnZm9jdXNUYXJnZXRXaWR0aCddLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaGlnaGxpZ2h0OiB0aGlzLmhpZ2hsaWdodFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vIOWIoOmZpOesrDPlsYLlj4rku6XlkI7nmoToj5zljZXvvIzku4XmlK/mjIHkuKTlsYLoj5zljZXlsZXnpLpcclxuICAgIHByaXZhdGUgcmVtb3ZlU3VycGx1c01lbnVzKCkge1xyXG4gICAgICAgIGlmICh0aGlzLm1lbnVJdGVtcyAmJiB0aGlzLm1lbnVJdGVtcy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgdGhpcy5tZW51SXRlbXMuZm9yRWFjaCgobTogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAobSAhPT0gJy0nICYmIG0uY2hpbGRyZW4gJiYgbS5jaGlsZHJlbi5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgICAgICBtLmNoaWxkcmVuLmZvckVhY2goY20gPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoY20gIT09ICctJykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY20uY2hpbGRyZW4gPSBbXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBjb250ZXh0TWVudUlkKCkge1xyXG4gICAgICAgIGNvbnN0IGlkID0gdGhpcy5lbFJlZi5uYXRpdmVFbGVtZW50LmlkO1xyXG4gICAgICAgIGlmIChpZCkge1xyXG4gICAgICAgICAgICByZXR1cm4gYCR7aWR9LWNvbnRleHQtbWVudWA7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuICdjb250ZXh0LW1lbnVfJyArIG5ldyBEYXRlKCkuZ2V0VGltZSgpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdldENvbnRleHREYXRhKGU6IEJlZm9yZVNob3dNZW51KSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBlID09PSAnYm9vbGVhbicpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHsgc2hvdzogZSwgZGF0YTogbnVsbCB9O1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gZTtcclxuICAgIH1cclxuXHJcblxyXG4gICAgcHJpdmF0ZSBnZXRWaWV3TWVudUl0ZW1zKGNvbnRleHQpIHtcclxuICAgICAgICBpZiAodGhpcy5tZW51SXRlbXMgJiYgdGhpcy5tZW51SXRlbXMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmNoZWNrTWVudUl0ZW1zKHRoaXMubWVudUl0ZW1zLCBjb250ZXh0KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuICBbXTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGNoZWNrTWVudUl0ZW1zKG1lbnVJdGVtcywgY29udGV4dCkge1xyXG4gICAgICAgIGNvbnN0IG1lbnVzID0gbWVudUl0ZW1zLm1hcCgobTogYW55KSA9PiB7XHJcbiAgICAgICAgICAgIGlmICh0eXBlb2YgbSA9PT0gJ3N0cmluZycpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBtO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICBjb25zdCBuID0gdGhpcy5jaGVja1Zpc2libGVBbmREaXNhYmxlKG0sIGNvbnRleHQpO1xyXG4gICAgICAgICAgICAgICBpZiAobi5jaGlsZHJlbikge1xyXG4gICAgICAgICAgICAgICAgICAgbi5jaGlsZHJlbiA9IHRoaXMuY2hlY2tNZW51SXRlbXMobi5jaGlsZHJlbiwgY29udGV4dCk7XHJcbiAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgcmV0dXJuIG47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KS5maWx0ZXIobiA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiBuID09PSAnLScgfHwgbi52aXNpYmxlO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBpZiAobWVudXMgJiYgbWVudXMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIGlmIChtZW51c1swXSA9PT0gJy0nKSB7XHJcbiAgICAgICAgICAgICAgICBtZW51cy5zaGlmdCgwKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKG1lbnVzW21lbnVzLmxlbmd0aCAtIDFdID09PSAnLScpIHtcclxuICAgICAgICAgICAgICAgIG1lbnVzLnBvcCgwKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIG1lbnVzO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgY2hlY2tWaXNpYmxlQW5kRGlzYWJsZShtOiBhbnksIGNvbnRleHQpIHtcclxuICAgICAgICBjb25zdCBuID0gey4uLm19O1xyXG4gICAgICAgIGlmICghbi5oYXNPd25Qcm9wZXJ0eSgndmlzaWJsZScpKSB7XHJcbiAgICAgICAgICAgIG4udmlzaWJsZSA9IHRydWU7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgaWYgKHR5cGVvZiBuLnZpc2libGUgPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgICAgICAgICAgIG4udmlzaWJsZSA9IG4udmlzaWJsZSggY29udGV4dCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICghbi5oYXNPd25Qcm9wZXJ0eSgnZGlzYWJsZScpKSB7XHJcbiAgICAgICAgICAgIG4uZGlzYWJsZSA9IGZhbHNlO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlmICh0eXBlb2Ygbi5kaXNhYmxlID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgICAgICAgICAgICBuLmRpc2FibGUgPSBuLmRpc2FibGUoIGNvbnRleHQgKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIG47XHJcbiAgICB9XHJcbn1cclxuIl19