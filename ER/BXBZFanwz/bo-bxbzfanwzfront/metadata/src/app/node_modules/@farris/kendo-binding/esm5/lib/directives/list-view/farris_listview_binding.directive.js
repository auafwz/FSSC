import * as tslib_1 from "tslib";
import { Directive, HostListener, Output, EventEmitter, Input } from '@angular/core';
import { BindingData, ViewModel } from '@farris/devkit';
import { ListViewComponent } from '@farris/ui-list-view';
var FarrisListViewBindingDirective = /** @class */ (function () {
    function FarrisListViewBindingDirective(bindingData, viewModel, listview) {
        this.bindingData = bindingData;
        this.viewModel = viewModel;
        this.listview = listview;
        this.supportPaged = true;
        /**
         * 选中行切换事件
         */
        this.selectedRowChange = new EventEmitter();
    }
    Object.defineProperty(FarrisListViewBindingDirective.prototype, "primaryKey", {
        /**
         * 主键
         */
        get: function () {
            return this.bindingList.primaryKey;
        },
        enumerable: true,
        configurable: true
    });
    FarrisListViewBindingDirective.prototype.ngOnInit = function () {
        // 绑定数据
        this.bindData();
        this.registerBindingDataChangeEvent();
    };
    FarrisListViewBindingDirective.prototype.ngOnChanges = function () {
        this.bindData();
    };
    FarrisListViewBindingDirective.prototype.ngOnDestroy = function () {
        this.unRegisterBindingDataChangeEvent();
    };
    /**
     * 获取分页信息
     */
    FarrisListViewBindingDirective.prototype.getPagingInfo = function () {
        var bindingPath = this.viewModel.bindingPath;
        var bindingData = this.viewModel.bindingData;
        var pagingInfo = bindingData.pagingInfo;
        if (bindingPath === '/') {
            return pagingInfo;
        }
        else {
            var bindingPaths = bindingPath.substr(1).split('/').filter(function (item) { return !!item && item.length > 0; }).map(function (item) {
                return item.substring(0, item.length - 1);
            });
            bindingPaths.forEach(function (path) {
                pagingInfo = pagingInfo && pagingInfo[path];
            });
            return pagingInfo;
        }
    };
    /**
     * 设置listview属性
     */
    FarrisListViewBindingDirective.prototype.setListViewPageProps = function () {
        var data = this.bindingList.toJSON();
        var skip = 0;
        var _a = this.getPagingInfo() || {}, _b = _a.pageIndex, pageIndex = _b === void 0 ? 1 : _b, _c = _a.pageSize, pageSize = _c === void 0 ? 0 : _c;
        var _d = (this.getPagingInfo() || {}).total, total = _d === void 0 ? 0 : _d;
        if (pageIndex > 0) {
            skip = (pageIndex - 1) * pageSize;
        }
        if (pageSize === 0 && total === 0) {
            total = data.length;
        }
        this.listview.supportPaging = this.supportPaged;
        this.listview.pageIndex = pageIndex;
        this.listview.pageSize = pageSize;
        this.listview.total = total;
        var currentPage = pageIndex;
        var itemsPerPage = pageSize;
        var totalItems = total;
        if (pageSize === 0) {
            // this.listview.supportPaging = false;
            this.listview.pageIndex = pageIndex;
            this.listview.total = total;
            currentPage = 1;
            totalItems = total;
        }
        if (this.listview.paginationOptions) {
            this.listview.paginationOptions.itemsPerPage = itemsPerPage;
            this.listview.paginationOptions.currentPage = currentPage;
            this.listview.paginationOptions.pageList = this.listview.pageList;
            this.listview.paginationOptions.totalItems = totalItems;
        }
        var listViewChangeDetectRef = this.listview['cdr'];
        if (listViewChangeDetectRef) {
            listViewChangeDetectRef.detectChanges();
        }
        var paginationDirective = this.listview.pager && this.listview.pager['paginationDirective'];
        if (paginationDirective && paginationDirective.service) {
            try {
                paginationDirective.service.instances[this.listview.pager.id] = tslib_1.__assign({}, this.listview.paginationOptions);
                paginationDirective.service.setTotalItems(totalItems);
                paginationDirective.changeDetectorRef.detectChanges();
            }
            catch (_e) { }
        }
    };
    Object.defineProperty(FarrisListViewBindingDirective.prototype, "bindingList", {
        /*
         * 获取绑定数据
         */
        get: function () {
            // 根实体
            if (this.viewModel.bindingPath === '/' || !this.viewModel.bindingPath) {
                return this.bindingData.list;
            }
            // 子实体
            var bindingPath = this.viewModel.bindingPath.substr(1);
            bindingPath = bindingPath[0].toLowerCase() + bindingPath.substring(1, bindingPath.length);
            var paths = bindingPath.split('/');
            var filteredPaths = paths.filter(function (part) {
                return part !== '';
            });
            return this.bindingData.getValue(filteredPaths);
        },
        enumerable: true,
        configurable: true
    });
    /* 绑定数据 */
    FarrisListViewBindingDirective.prototype.bindData = function () {
        this.setListViewPageProps();
        var data = this.bindingList.toArray();
        this.listview.setData(data);
    };
    /*
         * 发射选中行切换事件
         * @description 统一单选模式和多选模式下的行切换事件
         */
    FarrisListViewBindingDirective.prototype.fireSelectedRowChange = function (selectedRowContext) {
        this.selectedRowChange.emit(selectedRowContext);
    };
    /**
     * 设置BindingList的当前行
     * @param id 当前行内码
     */
    FarrisListViewBindingDirective.prototype.setSelectionIdToBindingData = function (id) {
        this.bindingList.setCurrentId(id, true);
    };
    /**
     * 数据源发生变更
     * @param change 变更
     */
    FarrisListViewBindingDirective.prototype.onBindingDataChange = function (change) {
        this.bindData();
        this.updateSelectedRow(change);
    };
    /**
     * 设置当前行
     * @param change 变更
     */
    FarrisListViewBindingDirective.prototype.updateSelectedRow = function (change) {
        if (!this.bindingList || !this.bindingList.currentId) {
            return;
        }
        if (this.viewModel && this.viewModel.frameContext.bindingData.rowSelectedEventSuspend === true) {
            return;
        }
        var _a = (this.listview.clickItem || {}).id, id = _a === void 0 ? null : _a;
        var currentId = this.bindingList.currentId;
        // grid当前行与bingingList当前行一致，无须切换
        if (id === currentId) {
            return;
        }
        this.selectRow(this.bindingList.currentId);
    };
    FarrisListViewBindingDirective.prototype.selectRow = function (id) {
        if (this.listview && typeof this.listview.selectRow === 'function') {
            this.listview.selectRow(id);
        }
    };
    /**
     * 注册bindingdata变化事件
     */
    FarrisListViewBindingDirective.prototype.registerBindingDataChangeEvent = function () {
        var _this = this;
        this.bindingDataChangeEvent = this.bindingData.changes.subscribe(function (change) {
            _this.onBindingDataChange(change);
        });
    };
    /**
     * 取消bindingdata变化订阅
     */
    FarrisListViewBindingDirective.prototype.unRegisterBindingDataChangeEvent = function () {
        this.bindingDataChangeEvent.unsubscribe();
    };
    FarrisListViewBindingDirective.prototype.setChecks = function (ids) {
        this.viewModel.uiState.setPropertyValue('ids', ids);
    };
    /* 切换行事件 */
    FarrisListViewBindingDirective.prototype.changeRow = function (event) {
        var index = event.index, data = event.data, checkChangeEvent = event.checkChangeEvent;
        if (checkChangeEvent === false || !event.hasOwnProperty('checkChangeEvent')) {
            if (data && Array.isArray(data) && data.length > 0) {
                var id = data[0] && data[0][this.primaryKey] || null;
                if (id) {
                    this.setSelectionIdToBindingData(id);
                }
            }
            this.listview.activeIndex = index;
            this.fireSelectedRowChange(event);
        }
    };
    /**
     * 切换页码触发事件
     * @param event 切换页码参数
     */
    FarrisListViewBindingDirective.prototype.pageChangedHandler = function (event) {
        var pageIndex = event.pageInfo.pageIndex;
        var pageSize = event.pageInfo.pageSize;
        if (pageIndex < 1) {
            pageIndex = 1;
        }
        var skip = (pageIndex - 1) * pageSize;
        this.bindingData.setPagingInfo(skip, pageSize, this.bindingData.bindingPath);
    };
    /**
     * 设置每页数据条数触发事件
     * @param event 切换页码参数
     */
    FarrisListViewBindingDirective.prototype.pageSizeChangedHandler = function (event) {
        var _a = event.pageInfo, pageIndex = _a.pageIndex, pageSize = _a.pageSize;
        var skip = (pageIndex - 1) * (+pageSize);
        this.bindingData.setPagingInfo(skip, pageSize, this.bindingData.bindingPath);
    };
    FarrisListViewBindingDirective.prototype.checkValuesChange = function (event) {
        var ids = event;
        this.setChecks(ids);
    };
    FarrisListViewBindingDirective.decorators = [
        { type: Directive, args: [{
                    selector: '[farrisListviewBinding]'
                },] }
    ];
    /** @nocollapse */
    FarrisListViewBindingDirective.ctorParameters = function () { return [
        { type: BindingData },
        { type: ViewModel },
        { type: ListViewComponent }
    ]; };
    FarrisListViewBindingDirective.propDecorators = {
        supportPaged: [{ type: Input }],
        selectedRowChange: [{ type: Output }],
        changeRow: [{ type: HostListener, args: ['listClick', ['$event'],] }],
        pageChangedHandler: [{ type: HostListener, args: ['pageChanged', ['$event'],] }],
        pageSizeChangedHandler: [{ type: HostListener, args: ['pageSizeChanged', ['$event'],] }],
        checkValuesChange: [{ type: HostListener, args: ['checkValuesChange', ['$event'],] }]
    };
    return FarrisListViewBindingDirective;
}());
export { FarrisListViewBindingDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmFycmlzX2xpc3R2aWV3X2JpbmRpbmcuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9rZW5kby1iaW5kaW5nLyIsInNvdXJjZXMiOlsibGliL2RpcmVjdGl2ZXMvbGlzdC12aWV3L2ZhcnJpc19saXN0dmlld19iaW5kaW5nLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQ0EsT0FBTyxFQUFFLFNBQVMsRUFBVSxZQUFZLEVBQUUsTUFBTSxFQUFFLFlBQVksRUFBd0IsS0FBSyxFQUFxQixNQUFNLGVBQWUsQ0FBQztBQUN0SSxPQUFPLEVBQUUsV0FBVyxFQUFlLFNBQVMsRUFBc0IsTUFBTSxnQkFBZ0IsQ0FBQztBQUN6RixPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUV6RDtJQW9CRSx3Q0FDVSxXQUF3QixFQUN4QixTQUFvQixFQUNwQixRQUEyQjtRQUYzQixnQkFBVyxHQUFYLFdBQVcsQ0FBYTtRQUN4QixjQUFTLEdBQVQsU0FBUyxDQUFXO1FBQ3BCLGFBQVEsR0FBUixRQUFRLENBQW1CO1FBVDVCLGlCQUFZLEdBQVksSUFBSSxDQUFDO1FBQ3RDOztXQUVHO1FBQ08sc0JBQWlCLEdBQXNCLElBQUksWUFBWSxFQUFPLENBQUM7SUFPekUsQ0FBQztJQWZELHNCQUFjLHNEQUFVO1FBSHhCOztXQUVHO2FBQ0g7WUFDRSxPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsVUFBVSxDQUFDO1FBQ3JDLENBQUM7OztPQUFBO0lBZUQsaURBQVEsR0FBUjtRQUNFLE9BQU87UUFDUCxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDaEIsSUFBSSxDQUFDLDhCQUE4QixFQUFFLENBQUM7SUFFeEMsQ0FBQztJQUVELG9EQUFXLEdBQVg7UUFDRSxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDbEIsQ0FBQztJQUVELG9EQUFXLEdBQVg7UUFDRSxJQUFJLENBQUMsZ0NBQWdDLEVBQUUsQ0FBQztJQUMx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QyxXQUFXLENBQUMsQ0FBQztJQUMvRSxDQUFDO0lBRUQ7OztPQUdHO0lBRUksK0RBQXNCLEdBRDdCLFVBQzhCLEtBQVU7UUFDaEMsSUFBQSxtQkFBd0MsRUFBdEMsd0JBQVMsRUFBRSxzQkFBMkIsQ0FBQztRQUMvQyxJQUFNLElBQUksR0FBRyxDQUFDLFNBQVMsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDM0MsSUFBSSxDQUFDLFdBQVcsQ0FBQyxhQUFhLENBQUMsSUFBSSxFQUFFLFFBQVEsRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBQy9FLENBQUM7SUFFTSwwREFBaUIsR0FEeEIsVUFDeUIsS0FBVTtRQUNqQyxJQUFNLEdBQUcsR0FBRyxLQUFLLENBQUM7UUFDbEIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUN0QixDQUFDOztnQkF0UEYsU0FBUyxTQUFDO29CQUNULFFBQVEsRUFBRSx5QkFBeUI7aUJBQ3BDOzs7O2dCQUxRLFdBQVc7Z0JBQWUsU0FBUztnQkFDbkMsaUJBQWlCOzs7K0JBZ0J2QixLQUFLO29DQUlMLE1BQU07NEJBd0xOLFlBQVksU0FBQyxXQUFXLEVBQUUsQ0FBQyxRQUFRLENBQUM7cUNBbUJwQyxZQUFZLFNBQUMsYUFBYSxFQUFFLENBQUMsUUFBUSxDQUFDO3lDQWV0QyxZQUFZLFNBQUMsaUJBQWlCLEVBQUUsQ0FBQyxRQUFRLENBQUM7b0NBTTFDLFlBQVksU0FBQyxtQkFBbUIsRUFBRSxDQUFDLFFBQVEsQ0FBQzs7SUFLL0MscUNBQUM7Q0FBQSxBQXZQRCxJQXVQQztTQW5QWSw4QkFBOEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgRGlyZWN0aXZlLCBPbkluaXQsIEhvc3RMaXN0ZW5lciwgT3V0cHV0LCBFdmVudEVtaXR0ZXIsIE9uRGVzdHJveSwgT25DaGFuZ2VzLCBJbnB1dCwgQ2hhbmdlRGV0ZWN0b3JSZWYgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgQmluZGluZ0RhdGEsIEJpbmRpbmdMaXN0LCBWaWV3TW9kZWwsIENoYW5nZVR5cGUsIENoYW5nZSB9IGZyb20gJ0BmYXJyaXMvZGV2a2l0JztcclxuaW1wb3J0IHsgTGlzdFZpZXdDb21wb25lbnQgfSBmcm9tICdAZmFycmlzL3VpLWxpc3Qtdmlldyc7XHJcbmltcG9ydCB7IFBhZ2luYXRpb25Db250cm9sc0RpcmVjdGl2ZSB9IGZyb20gJ0BmYXJyaXMvdWktZGF0YWdyaWQnO1xyXG5ARGlyZWN0aXZlKHtcclxuICBzZWxlY3RvcjogJ1tmYXJyaXNMaXN0dmlld0JpbmRpbmddJ1xyXG59KVxyXG5cclxuZXhwb3J0IGNsYXNzIEZhcnJpc0xpc3RWaWV3QmluZGluZ0RpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95LCBPbkNoYW5nZXMge1xyXG4gIGJpbmRpbmdEYXRhQ2hhbmdlRXZlbnQ6IFN1YnNjcmlwdGlvbjtcclxuXHJcbiAgLyoqXHJcbiAgICog5Li76ZSuXHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIGdldCBwcmltYXJ5S2V5KCkge1xyXG4gICAgcmV0dXJuIHRoaXMuYmluZGluZ0xpc3QucHJpbWFyeUtleTtcclxuICB9XHJcblxyXG4gIEBJbnB1dCgpIHN1cHBvcnRQYWdlZDogYm9vbGVhbiA9IHRydWU7XHJcbiAgLyoqXHJcbiAgICog6YCJ5Lit6KGM5YiH5o2i5LqL5Lu2XHJcbiAgICovXHJcbiAgQE91dHB1dCgpIHNlbGVjdGVkUm93Q2hhbmdlOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xyXG5cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHByaXZhdGUgYmluZGluZ0RhdGE6IEJpbmRpbmdEYXRhLFxyXG4gICAgcHJpdmF0ZSB2aWV3TW9kZWw6IFZpZXdNb2RlbCxcclxuICAgIHByaXZhdGUgbGlzdHZpZXc6IExpc3RWaWV3Q29tcG9uZW50KSB7XHJcblxyXG4gIH1cclxuXHJcbiAgbmdPbkluaXQoKSB7XHJcbiAgICAvLyDnu5HlrprmlbDmja5cclxuICAgIHRoaXMuYmluZERhdGEoKTtcclxuICAgIHRoaXMucmVnaXN0ZXJCaW5kaW5nRGF0YUNoYW5nZUV2ZW50KCk7XHJcblxyXG4gIH1cclxuXHJcbiAgbmdPbkNoYW5nZXMoKSB7XHJcbiAgICB0aGlzLmJpbmREYXRhKCk7XHJcbiAgfVxyXG5cclxuICBuZ09uRGVzdHJveSgpIHtcclxuICAgIHRoaXMudW5SZWdpc3RlckJpbmRpbmdEYXRhQ2hhbmdlRXZlbnQoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluWIhumhteS/oeaBr1xyXG4gICAqL1xyXG4gIHByb3RlY3RlZCBnZXRQYWdpbmdJbmZvKCkge1xyXG4gICAgY29uc3QgYmluZGluZ1BhdGggPSB0aGlzLnZpZXdNb2RlbC5iaW5kaW5nUGF0aDtcclxuICAgIGNvbnN0IGJpbmRpbmdEYXRhID0gdGhpcy52aWV3TW9kZWwuYmluZGluZ0RhdGE7XHJcbiAgICBsZXQgcGFnaW5nSW5mbyA9IGJpbmRpbmdEYXRhLnBhZ2luZ0luZm87XHJcbiAgICBpZiAoYmluZGluZ1BhdGggPT09ICcvJykge1xyXG4gICAgICByZXR1cm4gcGFnaW5nSW5mbztcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGNvbnN0IGJpbmRpbmdQYXRocyA9IGJpbmRpbmdQYXRoLnN1YnN0cigxKS5zcGxpdCgnLycpLmZpbHRlcihpdGVtID0+ICEhaXRlbSAmJiBpdGVtLmxlbmd0aCA+IDApLm1hcChpdGVtID0+IHtcclxuICAgICAgICByZXR1cm4gaXRlbS5zdWJzdHJpbmcoMCwgaXRlbS5sZW5ndGggLSAxKTtcclxuICAgICAgfSk7XHJcbiAgICAgIGJpbmRpbmdQYXRocy5mb3JFYWNoKHBhdGggPT4ge1xyXG4gICAgICAgIHBhZ2luZ0luZm8gPSBwYWdpbmdJbmZvICYmIHBhZ2luZ0luZm9bcGF0aF07XHJcbiAgICAgIH0pO1xyXG4gICAgICByZXR1cm4gcGFnaW5nSW5mbztcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiuvue9rmxpc3R2aWV35bGe5oCnXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBzZXRMaXN0Vmlld1BhZ2VQcm9wcygpIHtcclxuICAgIGNvbnN0IGRhdGEgPSB0aGlzLmJpbmRpbmdMaXN0LnRvSlNPTigpO1xyXG4gICAgbGV0IHNraXAgPSAwO1xyXG4gICAgY29uc3QgeyBwYWdlSW5kZXggPSAxLCBwYWdlU2l6ZSA9IDAgfSA9IHRoaXMuZ2V0UGFnaW5nSW5mbygpIHx8IHt9O1xyXG4gICAgbGV0IHsgdG90YWwgPSAwIH0gPSB0aGlzLmdldFBhZ2luZ0luZm8oKSB8fCB7fTtcclxuICAgIGlmIChwYWdlSW5kZXggPiAwKSB7XHJcbiAgICAgIHNraXAgPSAocGFnZUluZGV4IC0gMSkgKiBwYWdlU2l6ZTtcclxuICAgIH1cclxuICAgIGlmIChwYWdlU2l6ZSA9PT0gMCAmJiB0b3RhbCA9PT0gMCkge1xyXG4gICAgICB0b3RhbCA9IGRhdGEubGVuZ3RoO1xyXG4gICAgfVxyXG4gICAgdGhpcy5saXN0dmlldy5zdXBwb3J0UGFnaW5nID0gdGhpcy5zdXBwb3J0UGFnZWQ7XHJcbiAgICB0aGlzLmxpc3R2aWV3LnBhZ2VJbmRleCA9IHBhZ2VJbmRleDtcclxuICAgIHRoaXMubGlzdHZpZXcucGFnZVNpemUgPSBwYWdlU2l6ZTtcclxuICAgIHRoaXMubGlzdHZpZXcudG90YWwgPSB0b3RhbDtcclxuICAgIGxldCBjdXJyZW50UGFnZSA9IHBhZ2VJbmRleDtcclxuICAgIGNvbnN0IGl0ZW1zUGVyUGFnZSA9IHBhZ2VTaXplO1xyXG4gICAgbGV0IHRvdGFsSXRlbXMgPSB0b3RhbDtcclxuICAgIGlmIChwYWdlU2l6ZSA9PT0gMCkge1xyXG4gICAgICAvLyB0aGlzLmxpc3R2aWV3LnN1cHBvcnRQYWdpbmcgPSBmYWxzZTtcclxuICAgICAgdGhpcy5saXN0dmlldy5wYWdlSW5kZXggPSBwYWdlSW5kZXg7XHJcbiAgICAgIHRoaXMubGlzdHZpZXcudG90YWwgPSB0b3RhbDtcclxuICAgICAgY3VycmVudFBhZ2UgPSAxO1xyXG4gICAgICB0b3RhbEl0ZW1zID0gdG90YWw7XHJcbiAgICB9XHJcbiAgICBpZiAodGhpcy5saXN0dmlldy5wYWdpbmF0aW9uT3B0aW9ucykge1xyXG4gICAgICB0aGlzLmxpc3R2aWV3LnBhZ2luYXRpb25PcHRpb25zLml0ZW1zUGVyUGFnZSA9IGl0ZW1zUGVyUGFnZTtcclxuICAgICAgdGhpcy5saXN0dmlldy5wYWdpbmF0aW9uT3B0aW9ucy5jdXJyZW50UGFnZSA9IGN1cnJlbnRQYWdlO1xyXG4gICAgICB0aGlzLmxpc3R2aWV3LnBhZ2luYXRpb25PcHRpb25zLnBhZ2VMaXN0ID0gdGhpcy5saXN0dmlldy5wYWdlTGlzdDtcclxuICAgICAgdGhpcy5saXN0dmlldy5wYWdpbmF0aW9uT3B0aW9ucy50b3RhbEl0ZW1zID0gdG90YWxJdGVtcztcclxuICAgIH1cclxuICAgIGNvbnN0IGxpc3RWaWV3Q2hhbmdlRGV0ZWN0UmVmOiBDaGFuZ2VEZXRlY3RvclJlZiA9IHRoaXMubGlzdHZpZXdbJ2NkciddIGFzIENoYW5nZURldGVjdG9yUmVmO1xyXG4gICAgaWYgKGxpc3RWaWV3Q2hhbmdlRGV0ZWN0UmVmKSB7XHJcbiAgICAgIGxpc3RWaWV3Q2hhbmdlRGV0ZWN0UmVmLmRldGVjdENoYW5nZXMoKTtcclxuICAgIH1cclxuICAgIGNvbnN0IHBhZ2luYXRpb25EaXJlY3RpdmUgPSB0aGlzLmxpc3R2aWV3LnBhZ2VyICYmIHRoaXMubGlzdHZpZXcucGFnZXJbJ3BhZ2luYXRpb25EaXJlY3RpdmUnXTtcclxuICAgIGlmIChwYWdpbmF0aW9uRGlyZWN0aXZlICYmIHBhZ2luYXRpb25EaXJlY3RpdmUuc2VydmljZSkge1xyXG4gICAgICB0cnkge1xyXG4gICAgICAgIHBhZ2luYXRpb25EaXJlY3RpdmUuc2VydmljZS5pbnN0YW5jZXNbdGhpcy5saXN0dmlldy5wYWdlci5pZF0gPSB7IC4uLnRoaXMubGlzdHZpZXcucGFnaW5hdGlvbk9wdGlvbnMgfTtcclxuICAgICAgICBwYWdpbmF0aW9uRGlyZWN0aXZlLnNlcnZpY2Uuc2V0VG90YWxJdGVtcyh0b3RhbEl0ZW1zKTtcclxuICAgICAgICBwYWdpbmF0aW9uRGlyZWN0aXZlLmNoYW5nZURldGVjdG9yUmVmLmRldGVjdENoYW5nZXMoKTtcclxuICAgICAgfSBjYXRjaCB7IH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qXHJcbiAgICog6I635Y+W57uR5a6a5pWw5o2uXHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIGdldCBiaW5kaW5nTGlzdCgpOiBCaW5kaW5nTGlzdCB7XHJcbiAgICAvLyDmoLnlrp7kvZNcclxuICAgIGlmICh0aGlzLnZpZXdNb2RlbC5iaW5kaW5nUGF0aCA9PT0gJy8nIHx8ICF0aGlzLnZpZXdNb2RlbC5iaW5kaW5nUGF0aCkge1xyXG4gICAgICByZXR1cm4gdGhpcy5iaW5kaW5nRGF0YS5saXN0O1xyXG4gICAgfVxyXG4gICAgLy8g5a2Q5a6e5L2TXHJcbiAgICBsZXQgYmluZGluZ1BhdGggPSB0aGlzLnZpZXdNb2RlbC5iaW5kaW5nUGF0aC5zdWJzdHIoMSk7XHJcbiAgICBiaW5kaW5nUGF0aCA9IGJpbmRpbmdQYXRoWzBdLnRvTG93ZXJDYXNlKCkgKyBiaW5kaW5nUGF0aC5zdWJzdHJpbmcoMSwgYmluZGluZ1BhdGgubGVuZ3RoKTtcclxuICAgIGNvbnN0IHBhdGhzID0gYmluZGluZ1BhdGguc3BsaXQoJy8nKTtcclxuXHJcbiAgICBjb25zdCBmaWx0ZXJlZFBhdGhzID0gcGF0aHMuZmlsdGVyKChwYXJ0OiBzdHJpbmcpID0+IHtcclxuICAgICAgcmV0dXJuIHBhcnQgIT09ICcnO1xyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gdGhpcy5iaW5kaW5nRGF0YS5nZXRWYWx1ZShmaWx0ZXJlZFBhdGhzKTtcclxuICB9XHJcblxyXG4gIC8qIOe7keWumuaVsOaNriAqL1xyXG4gIHByaXZhdGUgYmluZERhdGEoKSB7XHJcbiAgICB0aGlzLnNldExpc3RWaWV3UGFnZVByb3BzKCk7XHJcbiAgICBjb25zdCBkYXRhID0gdGhpcy5iaW5kaW5nTGlzdC50b0FycmF5KCk7XHJcbiAgICB0aGlzLmxpc3R2aWV3LnNldERhdGEoZGF0YSk7XHJcbiAgfVxyXG5cclxuICAvKlxyXG4gICAgICAgKiDlj5HlsITpgInkuK3ooYzliIfmjaLkuovku7ZcclxuICAgICAgICogQGRlc2NyaXB0aW9uIOe7n+S4gOWNlemAieaooeW8j+WSjOWkmumAieaooeW8j+S4i+eahOihjOWIh+aNouS6i+S7tlxyXG4gICAgICAgKi9cclxuICBwcm90ZWN0ZWQgZmlyZVNlbGVjdGVkUm93Q2hhbmdlKHNlbGVjdGVkUm93Q29udGV4dDogYW55KSB7XHJcbiAgICB0aGlzLnNlbGVjdGVkUm93Q2hhbmdlLmVtaXQoc2VsZWN0ZWRSb3dDb250ZXh0KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiuvue9rkJpbmRpbmdMaXN055qE5b2T5YmN6KGMXHJcbiAgICogQHBhcmFtIGlkIOW9k+WJjeihjOWGheeggVxyXG4gICAqL1xyXG4gIHByb3RlY3RlZCBzZXRTZWxlY3Rpb25JZFRvQmluZGluZ0RhdGEoaWQ6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgdGhpcy5iaW5kaW5nTGlzdC5zZXRDdXJyZW50SWQoaWQsIHRydWUpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5pWw5o2u5rqQ5Y+R55Sf5Y+Y5pu0XHJcbiAgICogQHBhcmFtIGNoYW5nZSDlj5jmm7RcclxuICAgKi9cclxuICBwcm90ZWN0ZWQgb25CaW5kaW5nRGF0YUNoYW5nZShjaGFuZ2U6IENoYW5nZSkge1xyXG4gICAgdGhpcy5iaW5kRGF0YSgpO1xyXG4gICAgdGhpcy51cGRhdGVTZWxlY3RlZFJvdyhjaGFuZ2UpO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDorr7nva7lvZPliY3ooYxcclxuICAgKiBAcGFyYW0gY2hhbmdlIOWPmOabtFxyXG4gICAqL1xyXG4gIHByaXZhdGUgdXBkYXRlU2VsZWN0ZWRSb3coY2hhbmdlPzogQ2hhbmdlKSB7XHJcbiAgICBpZiAoIXRoaXMuYmluZGluZ0xpc3QgfHwgIXRoaXMuYmluZGluZ0xpc3QuY3VycmVudElkKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGlmICh0aGlzLnZpZXdNb2RlbCAmJiB0aGlzLnZpZXdNb2RlbC5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEucm93U2VsZWN0ZWRFdmVudFN1c3BlbmQgPT09IHRydWUpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgY29uc3QgeyBpZCA9IG51bGwgfSA9IHRoaXMubGlzdHZpZXcuY2xpY2tJdGVtIHx8IHt9O1xyXG4gICAgY29uc3QgY3VycmVudElkID0gdGhpcy5iaW5kaW5nTGlzdC5jdXJyZW50SWQ7XHJcbiAgICAvLyBncmlk5b2T5YmN6KGM5LiOYmluZ2luZ0xpc3TlvZPliY3ooYzkuIDoh7TvvIzml6DpobvliIfmjaJcclxuICAgIGlmIChpZCA9PT0gY3VycmVudElkKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIHRoaXMuc2VsZWN0Um93KHRoaXMuYmluZGluZ0xpc3QuY3VycmVudElkKTtcclxuICB9XHJcbiAgcHJvdGVjdGVkIHNlbGVjdFJvdyhpZDogYW55KSB7XHJcbiAgICBpZiAodGhpcy5saXN0dmlldyAmJiB0eXBlb2YgdGhpcy5saXN0dmlldy5zZWxlY3RSb3cgPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgdGhpcy5saXN0dmlldy5zZWxlY3RSb3coaWQpO1xyXG4gICAgfVxyXG4gIH1cclxuICAvKipcclxuICAgKiDms6jlhoxiaW5kaW5nZGF0YeWPmOWMluS6i+S7tlxyXG4gICAqL1xyXG4gIHByaXZhdGUgcmVnaXN0ZXJCaW5kaW5nRGF0YUNoYW5nZUV2ZW50KCkge1xyXG4gICAgdGhpcy5iaW5kaW5nRGF0YUNoYW5nZUV2ZW50ID0gdGhpcy5iaW5kaW5nRGF0YS5jaGFuZ2VzLnN1YnNjcmliZSgoY2hhbmdlOiBDaGFuZ2UpID0+IHtcclxuICAgICAgdGhpcy5vbkJpbmRpbmdEYXRhQ2hhbmdlKGNoYW5nZSk7XHJcbiAgICB9KTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5Y+W5raIYmluZGluZ2RhdGHlj5jljJborqLpmIVcclxuICAgKi9cclxuICBwcml2YXRlIHVuUmVnaXN0ZXJCaW5kaW5nRGF0YUNoYW5nZUV2ZW50KCkge1xyXG4gICAgdGhpcy5iaW5kaW5nRGF0YUNoYW5nZUV2ZW50LnVuc3Vic2NyaWJlKCk7XHJcbiAgfVxyXG4gIHByaXZhdGUgc2V0Q2hlY2tzKGlkczogc3RyaW5nW10pIHtcclxuICAgIHRoaXMudmlld01vZGVsLnVpU3RhdGUuc2V0UHJvcGVydHlWYWx1ZSgnaWRzJywgaWRzKTtcclxuICB9XHJcbiAgLyog5YiH5o2i6KGM5LqL5Lu2ICovXHJcbiAgQEhvc3RMaXN0ZW5lcignbGlzdENsaWNrJywgWyckZXZlbnQnXSlcclxuICBjaGFuZ2VSb3coZXZlbnQ6IGFueSkge1xyXG4gICAgY29uc3QgeyBpbmRleCwgZGF0YSwgY2hlY2tDaGFuZ2VFdmVudCB9ID0gZXZlbnQ7XHJcbiAgICBpZiAoY2hlY2tDaGFuZ2VFdmVudCA9PT0gZmFsc2UgfHwgIWV2ZW50Lmhhc093blByb3BlcnR5KCdjaGVja0NoYW5nZUV2ZW50JykpIHtcclxuICAgICAgaWYgKGRhdGEgJiYgQXJyYXkuaXNBcnJheShkYXRhKSAmJiBkYXRhLmxlbmd0aCA+IDApIHtcclxuICAgICAgICBjb25zdCBpZCA9IGRhdGFbMF0gJiYgZGF0YVswXVt0aGlzLnByaW1hcnlLZXldIHx8IG51bGw7XHJcbiAgICAgICAgaWYgKGlkKSB7XHJcbiAgICAgICAgICB0aGlzLnNldFNlbGVjdGlvbklkVG9CaW5kaW5nRGF0YShpZCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIHRoaXMubGlzdHZpZXcuYWN0aXZlSW5kZXggPSBpbmRleDtcclxuICAgICAgdGhpcy5maXJlU2VsZWN0ZWRSb3dDaGFuZ2UoZXZlbnQpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5YiH5o2i6aG156CB6Kem5Y+R5LqL5Lu2XHJcbiAgICogQHBhcmFtIGV2ZW50IOWIh+aNoumhteeggeWPguaVsFxyXG4gICAqL1xyXG4gIEBIb3N0TGlzdGVuZXIoJ3BhZ2VDaGFuZ2VkJywgWyckZXZlbnQnXSlcclxuICBwdWJsaWMgcGFnZUNoYW5nZWRIYW5kbGVyKGV2ZW50OiBhbnkpIHtcclxuICAgIGxldCBwYWdlSW5kZXggPSBldmVudC5wYWdlSW5mby5wYWdlSW5kZXg7XHJcbiAgICBjb25zdCBwYWdlU2l6ZSA9IGV2ZW50LnBhZ2VJbmZvLnBhZ2VTaXplO1xyXG4gICAgaWYgKHBhZ2VJbmRleCA8IDEpIHtcclxuICAgICAgcGFnZUluZGV4ID0gMTtcclxuICAgIH1cclxuICAgIGNvbnN0IHNraXAgPSAocGFnZUluZGV4IC0gMSkgKiBwYWdlU2l6ZTtcclxuICAgIHRoaXMuYmluZGluZ0RhdGEuc2V0UGFnaW5nSW5mbyhza2lwLCBwYWdlU2l6ZSwgdGhpcy5iaW5kaW5nRGF0YS5iaW5kaW5nUGF0aCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDorr7nva7mr4/pobXmlbDmja7mnaHmlbDop6blj5Hkuovku7ZcclxuICAgKiBAcGFyYW0gZXZlbnQg5YiH5o2i6aG156CB5Y+C5pWwXHJcbiAgICovXHJcbiAgQEhvc3RMaXN0ZW5lcigncGFnZVNpemVDaGFuZ2VkJywgWyckZXZlbnQnXSlcclxuICBwdWJsaWMgcGFnZVNpemVDaGFuZ2VkSGFuZGxlcihldmVudDogYW55KSB7XHJcbiAgICBjb25zdCB7IHBhZ2VJbmRleCwgcGFnZVNpemUgfSA9IGV2ZW50LnBhZ2VJbmZvO1xyXG4gICAgY29uc3Qgc2tpcCA9IChwYWdlSW5kZXggLSAxKSAqICgrcGFnZVNpemUpO1xyXG4gICAgdGhpcy5iaW5kaW5nRGF0YS5zZXRQYWdpbmdJbmZvKHNraXAsIHBhZ2VTaXplLCB0aGlzLmJpbmRpbmdEYXRhLmJpbmRpbmdQYXRoKTtcclxuICB9XHJcbiAgQEhvc3RMaXN0ZW5lcignY2hlY2tWYWx1ZXNDaGFuZ2UnLCBbJyRldmVudCddKVxyXG4gIHB1YmxpYyBjaGVja1ZhbHVlc0NoYW5nZShldmVudDogYW55KSB7XHJcbiAgICBjb25zdCBpZHMgPSBldmVudDtcclxuICAgIHRoaXMuc2V0Q2hlY2tzKGlkcyk7XHJcbiAgfVxyXG59XHJcbiJdfQ==