import { Injectable } from '@angular/core';
import { Repository, FrameContext } from '@farris/devkit';
import { switchMap } from 'rxjs/operators';
import { Observable, Subject } from 'rxjs';
import { of } from 'rxjs/observable/of';
import { FormNotifyService } from './form-notify.service';
import { LanguageService } from './languag.service';
const POSTER = 'iframePoster';
const RECEIVER = 'iframeReceiver';
const REPOSITORY = 'repository';
// window.hash中funcId的属性名
const FUNC_ID = 'funcId=';
const TAB_ID = 'tabId=';
/**
 * ChangeItemService
 * @scope FrameComponent
 */
class ChangeItemService {
    /**
     * 构造函数
     */
    constructor(repository, frameContext, notifyService, languageService) {
        this.repository = repository;
        this.frameContext = frameContext;
        this.notifyService = notifyService;
        this.languageService = languageService;
        this.top = top;
        this.itemChangePoster = new Subject();
        this.itemChangeReceiver = new Subject();
    }
    init() {
        this.top['topMap'] = this.top['topMap'] || {};
        this.changeItem = this.changeItem.bind(this);
    }
    setBykey(key, value) {
        this.top['topMap'] = this.top['topMap'] || {};
        this.top['topMap'][this.tabId] = this.top['topMap'][this.tabId] || {};
        const topObject = this.top['topMap'][this.tabId];
        topObject[key] = value;
    }
    getByKey(key) {
        const topObject = this.top['topMap'][this.tabId] || {};
        return topObject[key];
    }
    // 建立iframe通信
    setIframePoster() {
        if (this.getByKey[POSTER]) {
            return;
        }
        else {
            this.setBykey(POSTER, this.itemChangePoster);
        }
    }
    getIframePoster() {
        this.itemChangePoster = this.getByKey(RECEIVER);
        this.setBykey(RECEIVER, this.itemChangeReceiver);
    }
    changeItem(type, id, parentId) {
        // 根据是否是弹出式卡片取不同的tabId
        const virtualRootFrameContext = this.frameContext.getVirtualRootFrameContext();
        const virtualRootComponent = virtualRootFrameContext.frameComponent;
        const isDialogComponent = virtualRootComponent['isDialogRootComponent'] || false;
        if (isDialogComponent) {
            this.tabId = window.location.hash.split(TAB_ID)[1].slice(0, window.location.hash.split(TAB_ID)[1].indexOf('&'));
        }
        else {
            this.tabId = parentId;
        }
        this.itemChangeReceiver = this.getByKey(RECEIVER);
        return Observable.create((subscriber) => {
            this.getNextItemByCurrentId(id, type).subscribe((result) => {
                subscriber.next(result);
            });
        });
    }
    // 在list初始化时调用，缓存list的repository
    setRepository() {
        if (window.location.hash.includes(TAB_ID)) {
            this.tabId = window.location.hash.split(TAB_ID)[1].slice(0, window.location.hash.split(TAB_ID)[1].indexOf('&'));
            this.setBykey(REPOSITORY, this.frameContext.repository);
            this.setIframePoster();
            this.getIframePoster();
        }
    }
    // 根据类型和id获取相邻的数据
    getNextItemByCurrentId(currentId, type) {
        const repository = this.getByKey(REPOSITORY);
        const { pageSize, pageIndex, total } = repository.entityCollection.paginationInfo;
        let currentIdx = null;
        const list = repository.entityCollection.getAllEntities();
        list.find((x, idx) => {
            if (x.id === currentId) {
                currentIdx = idx;
            }
        });
        // 没有在列表中找到数据，返回空
        if (currentIdx === null) {
            // 新增取消当前无数据时点上一条下一条
            if (list.length) {
                switch (type) {
                    case 'prev':
                        return of(list[list.length - 1].id);
                        break;
                    case 'next':
                        this.notifyService.info(this.languageService.changeToLast, { hideTitle: true });
                        return of(null);
                        break;
                }
            }
            return of(null);
        }
        let nextIdx = currentIdx;
        switch (type) {
            case 'prev':
                // 当前页第一条,且非第一页,取上一页最后一条
                if (currentIdx === 0 && pageIndex !== 1) {
                    return repository.getEntities([], [], pageSize, pageIndex - 1).pipe(switchMap(result => {
                        nextIdx = pageSize - 1;
                        return of(result[nextIdx].id);
                    }));
                }
                // 第一页第一条，仍返回原有数据
                else if (currentIdx === 0 && pageIndex === 1) {
                    this.notifyService.info(this.languageService.changeToFirst, { hideTitle: true });
                    return of(list[nextIdx].id);
                }
                // 不是第一条，返回上一条
                else {
                    nextIdx = currentIdx - 1;
                    return of(list[nextIdx].id);
                }
                break;
            case 'next':
                // 超过当前页
                if (currentIdx + 1 + 1 > list.length) {
                    // 且非最后一条数据,取下一页第一条数据
                    if (((pageIndex - 1) * pageSize + currentIdx + 1) < total) {
                        return repository.getEntities([], [], pageSize, pageIndex + 1).pipe(switchMap(result => {
                            return of(result[0].id);
                        }));
                    }
                    // 最后一条数据，仍返回原数据
                    else {
                        this.notifyService.info(this.languageService.changeToLast, { hideTitle: true });
                        return of(list[nextIdx].id);
                    }
                }
                else {
                    nextIdx = currentIdx + 1;
                    return of(list[nextIdx].id);
                }
                break;
        }
    }
}
ChangeItemService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
ChangeItemService.ctorParameters = () => [
    { type: Repository },
    { type: FrameContext },
    { type: FormNotifyService },
    { type: LanguageService }
];
export { ChangeItemService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hhbmdlLWl0ZW0uc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy8iLCJzb3VyY2VzIjpbImxpYi9jaGFuZ2UtaXRlbS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLFVBQVUsRUFBVSxZQUFZLEVBQThDLE1BQU0sZ0JBQWdCLENBQUM7QUFDOUcsT0FBTyxFQUFPLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ2hELE9BQU8sRUFBRSxVQUFVLEVBQUUsT0FBTyxFQUFjLE1BQU0sTUFBTSxDQUFDO0FBR3ZELE9BQU8sRUFBRSxFQUFFLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUN4QyxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUMxRCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFHcEQsTUFBTSxNQUFNLEdBQUcsY0FBYyxDQUFDO0FBQzlCLE1BQU0sUUFBUSxHQUFHLGdCQUFnQixDQUFDO0FBQ2xDLE1BQU0sVUFBVSxHQUFHLFlBQVksQ0FBQztBQUNoQyx5QkFBeUI7QUFDekIsTUFBTSxPQUFPLEdBQUcsU0FBUyxDQUFDO0FBQzFCLE1BQU0sTUFBTSxHQUFHLFFBQVEsQ0FBQztBQUN4Qjs7O0dBR0c7QUFDSCxNQUNNLGlCQUFpQjtJQU9yQjs7T0FFRztJQUNILFlBQ1UsVUFBMkIsRUFDM0IsWUFBMEIsRUFDMUIsYUFBZ0MsRUFDaEMsZUFBZ0M7UUFIaEMsZUFBVSxHQUFWLFVBQVUsQ0FBaUI7UUFDM0IsaUJBQVksR0FBWixZQUFZLENBQWM7UUFDMUIsa0JBQWEsR0FBYixhQUFhLENBQW1CO1FBQ2hDLG9CQUFlLEdBQWYsZUFBZSxDQUFpQjtRQVpuQyxRQUFHLEdBQUcsR0FBRyxDQUFDO1FBR1YscUJBQWdCLEdBQUcsSUFBSSxPQUFP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RUFBRSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQztxQkFDN0I7aUJBQ0Y7cUJBQU07b0JBQ0wsT0FBTyxHQUFHLFVBQVUsR0FBRyxDQUFDLENBQUM7b0JBQ3pCLE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQztpQkFDN0I7Z0JBQ0QsTUFBTTtTQUNUO0lBQ0gsQ0FBQzs7O1lBcEpGLFVBQVU7Ozs7WUFwQkYsVUFBVTtZQUFVLFlBQVk7WUFNaEMsaUJBQWlCO1lBQ2pCLGVBQWU7O0FBc0t4QixPQUFPLEVBQUUsaUJBQWlCLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgUmVwb3NpdG9yeSwgRW50aXR5LCBGcmFtZUNvbnRleHQsIFBBUkVOVF9DTEFTUywgQ2hhbmdlVHlwZSwgVmFsaWRhdGlvblJlc3VsdCB9IGZyb20gJ0BmYXJyaXMvZGV2a2l0JztcclxuaW1wb3J0IHsgdGFwLCBzd2l0Y2hNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IE9ic2VydmFibGUsIFN1YmplY3QsIFN1YnNjcmliZXIgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgemlwIH0gZnJvbSAncnhqcy9vYnNlcnZhYmxlL3ppcCc7XHJcbmltcG9ydCB7IGVtcHR5IH0gZnJvbSAncnhqcy9vYnNlcnZhYmxlL2VtcHR5JztcclxuaW1wb3J0IHsgb2YgfSBmcm9tICdyeGpzL29ic2VydmFibGUvb2YnO1xyXG5pbXBvcnQgeyBGb3JtTm90aWZ5U2VydmljZSB9IGZyb20gJy4vZm9ybS1ub3RpZnkuc2VydmljZSc7XHJcbmltcG9ydCB7IExhbmd1YWdlU2VydmljZSB9IGZyb20gJy4vbGFuZ3VhZy5zZXJ2aWNlJztcclxuXHJcblxyXG5jb25zdCBQT1NURVIgPSAnaWZyYW1lUG9zdGVyJztcclxuY29uc3QgUkVDRUlWRVIgPSAnaWZyYW1lUmVjZWl2ZXInO1xyXG5jb25zdCBSRVBPU0lUT1JZID0gJ3JlcG9zaXRvcnknO1xyXG4vLyB3aW5kb3cuaGFzaOS4rWZ1bmNJZOeahOWxnuaAp+WQjVxyXG5jb25zdCBGVU5DX0lEID0gJ2Z1bmNJZD0nO1xyXG5jb25zdCBUQUJfSUQgPSAndGFiSWQ9JztcclxuLyoqXHJcbiAqIENoYW5nZUl0ZW1TZXJ2aWNlXHJcbiAqIEBzY29wZSBGcmFtZUNvbXBvbmVudFxyXG4gKi9cclxuQEluamVjdGFibGUoKVxyXG5jbGFzcyBDaGFuZ2VJdGVtU2VydmljZSB7XHJcblxyXG4gIHB1YmxpYyB0b3AgPSB0b3A7XHJcbiAgcHJpdmF0ZSBmdW5jSWQ6IHN0cmluZztcclxuICBwcml2YXRlIHRhYklkOiBzdHJpbmc7XHJcbiAgcHVibGljIGl0ZW1DaGFuZ2VQb3N0ZXIgPSBuZXcgU3ViamVjdDxhbnk+KCk7XHJcbiAgcHVibGljIGl0ZW1DaGFuZ2VSZWNlaXZlciA9IG5ldyBTdWJqZWN0PGFueT4oKTtcclxuICAvKipcclxuICAgKiDmnoTpgKDlh73mlbBcclxuICAgKi9cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHByaXZhdGUgcmVwb3NpdG9yeTogUmVwb3NpdG9yeTxhbnk+LFxyXG4gICAgcHJpdmF0ZSBmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCxcclxuICAgIHByaXZhdGUgbm90aWZ5U2VydmljZTogRm9ybU5vdGlmeVNlcnZpY2UsXHJcbiAgICBwcml2YXRlIGxhbmd1YWdlU2VydmljZTogTGFuZ3VhZ2VTZXJ2aWNlXHJcbiAgKSB7XHJcbiAgfVxyXG5cclxuICBpbml0KCkge1xyXG4gICAgdGhpcy50b3BbJ3RvcE1hcCddID0gdGhpcy50b3BbJ3RvcE1hcCddIHx8IHt9O1xyXG4gICAgdGhpcy5jaGFuZ2VJdGVtID0gdGhpcy5jaGFuZ2VJdGVtLmJpbmQodGhpcyk7XHJcbiAgfVxyXG5cclxuICBzZXRCeWtleShrZXk6IHN0cmluZywgdmFsdWU6IGFueSkge1xyXG4gICAgdGhpcy50b3BbJ3RvcE1hcCddID0gdGhpcy50b3BbJ3RvcE1hcCddIHx8IHt9O1xyXG4gICAgdGhpcy50b3BbJ3RvcE1hcCddW3RoaXMudGFiSWRdID0gdGhpcy50b3BbJ3RvcE1hcCddW3RoaXMudGFiSWRdIHx8IHt9O1xyXG4gICAgY29uc3QgdG9wT2JqZWN0ID0gdGhpcy50b3BbJ3RvcE1hcCddW3RoaXMudGFiSWRdO1xyXG4gICAgdG9wT2JqZWN0W2tleV0gPSB2YWx1ZTtcclxuICB9XHJcblxyXG4gIGdldEJ5S2V5KGtleTogc3RyaW5nKSB7XHJcbiAgICBjb25zdCB0b3BPYmplY3QgPSB0aGlzLnRvcFsndG9wTWFwJ11bdGhpcy50YWJJZF0gfHwge307XHJcbiAgICByZXR1cm4gdG9wT2JqZWN0W2tleV07XHJcbiAgfVxyXG5cclxuICAvLyDlu7rnq4tpZnJhbWXpgJrkv6FcclxuICBzZXRJZnJhbWVQb3N0ZXIoKSB7XHJcbiAgICBpZiAodGhpcy5nZXRCeUtleVtQT1NURVJdKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMuc2V0QnlrZXkoUE9TVEVSLCB0aGlzLml0ZW1DaGFuZ2VQb3N0ZXIpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgZ2V0SWZyYW1lUG9zdGVyKCkge1xyXG4gICAgdGhpcy5pdGVtQ2hhbmdlUG9zdGVyID0gdGhpcy5nZXRCeUtleShSRUNFSVZFUik7XHJcbiAgICB0aGlzLnNldEJ5a2V5KFJFQ0VJVkVSLCB0aGlzLml0ZW1DaGFuZ2VSZWNlaXZlcik7XHJcbiAgfVxyXG5cclxuICBjaGFuZ2VJdGVtKHR5cGU6IHN0cmluZywgaWQ6IHN0cmluZywgcGFyZW50SWQ6IHN0cmluZykge1xyXG4gICAgLy8g5qC55o2u5piv5ZCm5piv5by55Ye65byP5Y2h54mH5Y+W5LiN5ZCM55qEdGFiSWRcclxuICAgIGNvbnN0IHZpcnR1YWxSb290RnJhbWVDb250ZXh0ID0gdGhpcy5mcmFtZUNvbnRleHQuZ2V0VmlydHVhbFJvb3RGcmFtZUNvbnRleHQoKTtcclxuICAgIGNvbnN0IHZpcnR1YWxSb290Q29tcG9uZW50ID0gdmlydHVhbFJvb3RGcmFtZUNvbnRleHQuZnJhbWVDb21wb25lbnQ7XHJcbiAgICBjb25zdCBpc0RpYWxvZ0NvbXBvbmVudCA9IHZpcnR1YWxSb290Q29tcG9uZW50Wydpc0RpYWxvZ1Jvb3RDb21wb25lbnQnXSB8fCBmYWxzZTtcclxuICAgIGlmIChpc0RpYWxvZ0NvbXBvbmVudCkge1xyXG4gICAgICB0aGlzLnRhYklkID0gd2luZG93LmxvY2F0aW9uLmhhc2guc3BsaXQoVEFCX0lEKVsxXS5zbGljZSgwLCB3aW5kb3cubG9jYXRpb24uaGFzaC5zcGxpdChUQUJfSUQpWzFdLmluZGV4T2YoJyYnKSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLnRhYklkID0gcGFyZW50SWQ7XHJcbiAgICB9XHJcbiAgICB0aGlzLml0ZW1DaGFuZ2VSZWNlaXZlciA9IHRoaXMuZ2V0QnlLZXkoUkVDRUlWRVIpO1xyXG4gICAgcmV0dXJuIE9ic2VydmFibGUuY3JlYXRlKChzdWJzY3JpYmVyOiBTdWJzY3JpYmVyPGFueT4pID0+IHtcclxuICAgICAgdGhpcy5nZXROZXh0SXRlbUJ5Q3VycmVudElkKGlkLCB0eXBlKS5zdWJzY3JpYmUoKHJlc3VsdDogYW55KSA9PiB7XHJcbiAgICAgICAgc3Vic2NyaWJlci5uZXh0KHJlc3VsdCk7XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvLyDlnKhsaXN05Yid5aeL5YyW5pe26LCD55So77yM57yT5a2YbGlzdOeahHJlcG9zaXRvcnlcclxuICBzZXRSZXBvc2l0b3J5KCkge1xyXG4gICAgaWYgKHdpbmRvdy5sb2NhdGlvbi5oYXNoLmluY2x1ZGVzKFRBQl9JRCkpIHtcclxuICAgICAgdGhpcy50YWJJZCA9IHdpbmRvdy5sb2NhdGlvbi5oYXNoLnNwbGl0KFRBQl9JRClbMV0uc2xpY2UoMCwgd2luZG93LmxvY2F0aW9uLmhhc2guc3BsaXQoVEFCX0lEKVsxXS5pbmRleE9mKCcmJykpO1xyXG4gICAgICB0aGlzLnNldEJ5a2V5KFJFUE9TSVRPUlksIHRoaXMuZnJhbWVDb250ZXh0LnJlcG9zaXRvcnkpO1xyXG4gICAgICB0aGlzLnNldElmcmFtZVBvc3RlcigpO1xyXG4gICAgICB0aGlzLmdldElmcmFtZVBvc3RlcigpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy8g5qC55o2u57G75Z6L5ZKMaWTojrflj5bnm7jpgrvnmoTmlbDmja5cclxuICBnZXROZXh0SXRlbUJ5Q3VycmVudElkKGN1cnJlbnRJZDogc3RyaW5nLCB0eXBlOiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IHJlcG9zaXRvcnkgPSB0aGlzLmdldEJ5S2V5KFJFUE9TSVRPUlkpO1xyXG4gICAgY29uc3QgeyBwYWdlU2l6ZSwgcGFnZUluZGV4LCB0b3RhbCB9ID0gcmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLnBhZ2luYXRpb25JbmZvO1xyXG4gICAgbGV0IGN1cnJlbnRJZHggPSBudWxsO1xyXG4gICAgY29uc3QgbGlzdCA9IHJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi5nZXRBbGxFbnRpdGllcygpO1xyXG4gICAgbGlzdC5maW5kKCh4OiBhbnksIGlkeDogc3RyaW5nKSA9PiB7XHJcbiAgICAgIGlmICh4LmlkID09PSBjdXJyZW50SWQpIHtcclxuICAgICAgICBjdXJyZW50SWR4ID0gaWR4O1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICAgIC8vIOayoeacieWcqOWIl+ihqOS4reaJvuWIsOaVsOaNru+8jOi/lOWbnuepulxyXG4gICAgaWYgKGN1cnJlbnRJZHggPT09IG51bGwpIHtcclxuICAgICAgLy8g5paw5aKe5Y+W5raI5b2T5YmN5peg5pWw5o2u5pe254K55LiK5LiA5p2h5LiL5LiA5p2hXHJcbiAgICAgIGlmIChsaXN0Lmxlbmd0aCkge1xyXG4gICAgICAgIHN3aXRjaCAodHlwZSkge1xyXG4gICAgICAgICAgY2FzZSAncHJldic6XHJcbiAgICAgICAgICAgIHJldHVybiBvZihsaXN0W2xpc3QubGVuZ3RoIC0gMV0uaWQpO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgIGNhc2UgJ25leHQnOlxyXG4gICAgICAgICAgICB0aGlzLm5vdGlmeVNlcnZpY2UuaW5mbyh0aGlzLmxhbmd1YWdlU2VydmljZS5jaGFuZ2VUb0xhc3QsIHsgaGlkZVRpdGxlOiB0cnVlIH0pO1xyXG4gICAgICAgICAgICByZXR1cm4gb2YobnVsbCk7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgICByZXR1cm4gb2YobnVsbCk7XHJcbiAgICB9XHJcbiAgICBsZXQgbmV4dElkeCA9IGN1cnJlbnRJZHg7XHJcbiAgICBzd2l0Y2ggKHR5cGUpIHtcclxuICAgICAgY2FzZSAncHJldic6XHJcbiAgICAgICAgLy8g5b2T5YmN6aG156ys5LiA5p2hLOS4lOmdnuesrOS4gOmhtSzlj5bkuIrkuIDpobXmnIDlkI7kuIDmnaFcclxuICAgICAgICBpZiAoY3VycmVudElkeCA9PT0gMCAmJiBwYWdlSW5kZXggIT09IDEpIHtcclxuICAgICAgICAgIHJldHVybiByZXBvc2l0b3J5LmdldEVudGl0aWVzKFtdLCBbXSwgcGFnZVNpemUsIHBhZ2VJbmRleCAtIDEpLnBpcGUoXHJcbiAgICAgICAgICAgIHN3aXRjaE1hcChyZXN1bHQgPT4ge1xyXG4gICAgICAgICAgICAgIG5leHRJZHggPSBwYWdlU2l6ZSAtIDE7XHJcbiAgICAgICAgICAgICAgcmV0dXJuIG9mKHJlc3VsdFtuZXh0SWR4XS5pZCk7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICApO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyDnrKzkuIDpobXnrKzkuIDmnaHvvIzku43ov5Tlm57ljp/mnInmlbDmja5cclxuICAgICAgICBlbHNlIGlmIChjdXJyZW50SWR4ID09PSAwICYmIHBhZ2VJbmRleCA9PT0gMSkge1xyXG4gICAgICAgICAgdGhpcy5ub3RpZnlTZXJ2aWNlLmluZm8odGhpcy5sYW5ndWFnZVNlcnZpY2UuY2hhbmdlVG9GaXJzdCwgeyBoaWRlVGl0bGU6IHRydWUgfSk7XHJcbiAgICAgICAgICByZXR1cm4gb2YobGlzdFtuZXh0SWR4XS5pZCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIOS4jeaYr+esrOS4gOadoe+8jOi/lOWbnuS4iuS4gOadoVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgbmV4dElkeCA9IGN1cnJlbnRJZHggLSAxO1xyXG4gICAgICAgICAgcmV0dXJuIG9mKGxpc3RbbmV4dElkeF0uaWQpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBicmVhaztcclxuICAgICAgY2FzZSAnbmV4dCc6XHJcbiAgICAgICAgLy8g6LaF6L+H5b2T5YmN6aG1XHJcbiAgICAgICAgaWYgKGN1cnJlbnRJZHggKyAxICsgMSA+IGxpc3QubGVuZ3RoKSB7XHJcbiAgICAgICAgICAvLyDkuJTpnZ7mnIDlkI7kuIDmnaHmlbDmja4s5Y+W5LiL5LiA6aG156ys5LiA5p2h5pWw5o2uXHJcbiAgICAgICAgICBpZiAoKChwYWdlSW5kZXggLSAxKSAqIHBhZ2VTaXplICsgY3VycmVudElkeCArIDEpIDwgdG90YWwpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHJlcG9zaXRvcnkuZ2V0RW50aXRpZXMoW10sIFtdLCBwYWdlU2l6ZSwgcGFnZUluZGV4ICsgMSkucGlwZShzd2l0Y2hNYXAocmVzdWx0ID0+IHtcclxuICAgICAgICAgICAgICByZXR1cm4gb2YocmVzdWx0WzBdLmlkKTtcclxuICAgICAgICAgICAgfSkpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgLy8g5pyA5ZCO5LiA5p2h5pWw5o2u77yM5LuN6L+U5Zue5Y6f5pWw5o2uXHJcbiAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5ub3RpZnlTZXJ2aWNlLmluZm8odGhpcy5sYW5ndWFnZVNlcnZpY2UuY2hhbmdlVG9MYXN0LCB7IGhpZGVUaXRsZTogdHJ1ZSB9KTtcclxuICAgICAgICAgICAgcmV0dXJuIG9mKGxpc3RbbmV4dElkeF0uaWQpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBuZXh0SWR4ID0gY3VycmVudElkeCArIDE7XHJcbiAgICAgICAgICByZXR1cm4gb2YobGlzdFtuZXh0SWR4XS5pZCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGJyZWFrO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcblxyXG59XHJcblxyXG5leHBvcnQgeyBDaGFuZ2VJdGVtU2VydmljZSB9O1xyXG4iXX0=