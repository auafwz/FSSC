/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Directive, HostListener, Input, Injector, ElementRef, Renderer2, Optional } from '@angular/core';
import { of } from 'rxjs';
import { FarrisContextMenuService } from './context-menu.service';
var FarrisContextMenuDirective = /** @class */ (function () {
    function FarrisContextMenuDirective(ctxMenuSer, injector, elRef, render) {
        this.ctxMenuSer = ctxMenuSer;
        this.injector = injector;
        this.elRef = elRef;
        this.render = render;
        this.disabled = false;
        this.highlight = true;
    }
    /**
     * @return {?}
     */
    FarrisContextMenuDirective.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        this.id = this.contextMenuId();
        if (!this.beforeShowContextMenu) {
            this.beforeShowContextMenu = (/**
             * @return {?}
             */
            function () { return of(true); });
        }
    };
    /**
     * @param {?} event
     * @return {?}
     */
    FarrisContextMenuDirective.prototype.onContextMenu = /**
     * @param {?} event
     * @return {?}
     */
    function (event) {
        var _this = this;
        if (!this.disabled) {
            /** @type {?} */
            var contextMenuDom_1 = null;
            if (this.activeDomName) {
                contextMenuDom_1 = ((/** @type {?} */ (event.target))).closest(this.activeDomName);
                if (contextMenuDom_1) {
                    this.render.addClass(contextMenuDom_1, 'f-context-menu-active');
                }
                else {
                    return;
                }
            }
            /** @type {?} */
            var beforeShow$ = this.beforeShowContextMenu({ event: event, contextMenuDom: contextMenuDom_1 });
            if (beforeShow$ && beforeShow$.subscribe) {
                beforeShow$.subscribe((/**
                 * @param {?} e
                 * @return {?}
                 */
                function (e) {
                    /** @type {?} */
                    var ctxData = _this.getContextData(e);
                    _this.removeSurplusMenus();
                    if (ctxData.show) {
                        document.body.click();
                        _this.ctxMenuSer.show({
                            menuItems: _this.getViewMenuItems(ctxData.data),
                            event: event,
                            id: _this.id,
                            activeDom: contextMenuDom_1,
                            context: ctxData.data,
                            menuClass: _this.menuClass,
                            target: _this.elRef.nativeElement,
                            activeWidth: e['focusTargetWidth'],
                            highlight: _this.highlight
                        });
                        event.preventDefault();
                        event.stopPropagation();
                    }
                }));
            }
        }
    };
    // 删除第3层及以后的菜单，仅支持两层菜单展示
    // 删除第3层及以后的菜单，仅支持两层菜单展示
    /**
     * @private
     * @return {?}
     */
    FarrisContextMenuDirective.prototype.removeSurplusMenus = 
    // 删除第3层及以后的菜单，仅支持两层菜单展示
    /**
     * @private
     * @return {?}
     */
    function () {
        if (this.menuItems && this.menuItems.length) {
            this.menuItems.forEach((/**
             * @param {?} m
             * @return {?}
             */
            function (m) {
                if (m !== '-' && m.children && m.children.length) {
                    m.children.forEach((/**
                     * @param {?} cm
                     * @return {?}
                     */
                    function (cm) {
                        if (cm !== '-') {
                            cm.children = [];
                        }
                    }));
                }
            }));
        }
    };
    /**
     * @private
     * @return {?}
     */
    FarrisContextMenuDirective.prototype.contextMenuId = /**
     * @private
     * @return {?}
     */
    function () {
        /** @type {?} */
        var id = this.elRef.nativeElement.id;
        if (id) {
            return id + "-context-menu";
        }
        else {
            return 'context-menu_' + new Date().getTime();
        }
    };
    /**
     * @private
     * @param {?} e
     * @return {?}
     */
    FarrisContextMenuDirective.prototype.getContextData = /**
     * @private
     * @param {?} e
     * @return {?}
     */
    function (e) {
        if (typeof e === 'boolean') {
            return { show: e, data: null };
        }
        return e;
    };
    /**
     * @private
     * @param {?} context
     * @return {?}
     */
    FarrisContextMenuDirective.prototype.getViewMenuItems = /**
     * @private
     * @param {?} context
     * @return {?}
     */
    function (context) {
        if (this.menuItems && this.menuItems.length) {
            return this.checkMenuItems(this.menuItems, context);
        }
        return [];
    };
    /**
     * @private
     * @param {?} menuItems
     * @param {?} context
     * @return {?}
     */
    FarrisContextMenuDirective.prototype.checkMenuItems = /**
     * @private
     * @param {?} menuItems
     * @param {?} context
     * @return {?}
     */
    function (menuItems, context) {
        var _this = this;
        /** @type {?} */
        var menus = menuItems.map((/**
         * @param {?} m
         * @return {?}
         */
        function (m) {
            if (typeof m === 'string') {
                return m;
            }
            else {
                /** @type {?} */
                var n = _this.checkVisibleAndDisable(m, context);
                if (n.children) {
                    n.children = _this.checkMenuItems(n.children, context);
                }
                return n;
            }
        })).filter((/**
         * @param {?} n
         * @return {?}
         */
        function (n) {
            return n === '-' || n.visible;
        }));
        if (menus && menus.length) {
            if (menus[0] === '-') {
                menus.shift(0);
            }
            if (menus[menus.length - 1] === '-') {
                menus.pop(0);
            }
        }
        return menus;
    };
    /**
     * @private
     * @param {?} m
     * @param {?} context
     * @return {?}
     */
    FarrisContextMenuDirective.prototype.checkVisibleAndDisable = /**
     * @private
     * @param {?} m
     * @param {?} context
     * @return {?}
     */
    function (m, context) {
        /** @type {?} */
        var n = tslib_1.__assign({}, m);
        if (!n.hasOwnProperty('visible')) {
            n.visible = true;
        }
        else {
            if (typeof n.visible === 'function') {
                n.visible = n.visible(context);
            }
        }
        if (!n.hasOwnProperty('disable')) {
            n.disable = false;
        }
        else {
            if (typeof n.disable === 'function') {
                n.disable = n.disable(context);
            }
        }
        return n;
    };
    FarrisContextMenuDirective.decorators = [
        { type: Directive, args: [{
                    selector: '[farris-context-menus]',
                },] }
    ];
    /** @nocollapse */
    FarrisContextMenuDirective.ctorParameters = function () { return [
        { type: FarrisContextMenuService, decorators: [{ type: Optional }] },
        { type: Injector },
        { type: ElementRef },
        { type: Renderer2 }
    ]; };
    FarrisContextMenuDirective.propDecorators = {
        menuItems: [{ type: Input, args: ['farris-context-menus',] }],
        menuClass: [{ type: Input }],
        disabled: [{ type: Input }],
        context: [{ type: Input }],
        beforeShowContextMenu: [{ type: Input }],
        activeDomName: [{ type: Input }],
        highlight: [{ type: Input }],
        onContextMenu: [{ type: HostListener, args: ['contextmenu', ['$event'],] }]
    };
    return FarrisContextMenuDirective;
}());
export { FarrisContextMenuDirective };
if (false) {
    /** @type {?} */
    FarrisContextMenuDirective.prototype.menuItems;
    /** @type {?} */
    FarrisContextMenuDirective.prototype.menuClass;
    /** @type {?} */
    FarrisContextMenuDirective.prototype.disabled;
    /** @type {?} */
    FarrisContextMenuDirective.prototype.context;
    /** @type {?} */
    FarrisContextMenuDirective.prototype.beforeShowContextMenu;
    /**
     * 触发右键菜单实际DOM标签名称
     * @type {?}
     */
    FarrisContextMenuDirective.prototype.activeDomName;
    /** @type {?} */
    FarrisContextMenuDirective.prototype.highlight;
    /** @type {?} */
    FarrisContextMenuDirective.prototype.id;
    /**
     * @type {?}
     * @private
     */
    FarrisContextMenuDirective.prototype.ctxMenuSer;
    /**
     * @type {?}
     * @private
     */
    FarrisContextMenuDirective.prototype.injector;
    /**
     * @type {?}
     * @private
     */
    FarrisContextMenuDirective.prototype.elRef;
    /**
     * @type {?}
     * @private
     */
    FarrisContextMenuDirective.prototype.render;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udGV4dC1tZW51LmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvdWktY29udGV4dC1tZW51LyIsInNvdXJjZXMiOlsibGliL2NvbnRleHQtbWVudS5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLFlBQVksRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLFVBQVUsRUFBVSxTQUFTLEVBQXdCLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUV4SSxPQUFPLEVBQUUsRUFBRSxFQUFjLE1BQU0sTUFBTSxDQUFDO0FBQ3RDLE9BQU8sRUFBRSx3QkFBd0IsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBR2xFO0lBY0ksb0NBQWdDLFVBQW9DLEVBQ2hELFFBQWtCLEVBQVUsS0FBaUIsRUFBVSxNQUFpQjtRQUQ1RCxlQUFVLEdBQVYsVUFBVSxDQUEwQjtRQUNoRCxhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQVUsVUFBSyxHQUFMLEtBQUssQ0FBWTtRQUFVLFdBQU0sR0FBTixNQUFNLENBQVc7UUFUbkYsYUFBUSxHQUFHLEtBQUssQ0FBQztRQUtqQixjQUFTLEdBQUcsSUFBSSxDQUFDO0lBSXFFLENBQUM7Ozs7SUFFaEcsNkNBQVE7OztJQUFSO1FBQ0ksSUFBSSxDQUFDLEVBQUUsR0FBRyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7UUFFL0IsSUFBSSxDQUFDLElBQUksQ0FBQyxxQkFBcUIsRUFBRTtZQUM3QixJQUFJLENBQUMscUJBQXFCOzs7WUFBRyxjQUFNLE9BQUEsRUFBRSxDQUFDLElBQUksQ0FBQyxFQUFSLENBQVEsQ0FBQSxDQUFDO1NBQy9DO0lBQ0wsQ0FBQzs7Ozs7SUFHTSxrREFBYTs7OztJQURwQixVQUNxQixLQUFpQjtRQUR0QyxpQkFzQ0M7UUFwQ0csSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUU7O2dCQUNaLGdCQUFjLEdBQUcsSUFBSTtZQUN6QixJQUFJ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Q0FBQSxBQXhKRCxJQXdKQztTQXJKWSwwQkFBMEI7OztJQUNuQywrQ0FBNEQ7O0lBQzVELCtDQUEyQjs7SUFDM0IsOENBQTBCOztJQUMxQiw2Q0FBc0I7O0lBQ3RCLDJEQUF3RTs7Ozs7SUFFeEUsbURBQStCOztJQUMvQiwrQ0FBMEI7O0lBQzFCLHdDQUFXOzs7OztJQUVDLGdEQUF3RDs7Ozs7SUFDeEQsOENBQTBCOzs7OztJQUFFLDJDQUF5Qjs7Ozs7SUFBRSw0Q0FBeUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBEaXJlY3RpdmUsIEhvc3RMaXN0ZW5lciwgSW5wdXQsIEluamVjdG9yLCBFbGVtZW50UmVmLCBPbkluaXQsIFJlbmRlcmVyMiwgRXZlbnRFbWl0dGVyLCBPdXRwdXQsIE9wdGlvbmFsIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IGNsb25lRGVlcCB9IGZyb20gJ2xvZGFzaC1lcyc7XHJcbmltcG9ydCB7IG9mLCBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IEZhcnJpc0NvbnRleHRNZW51U2VydmljZSB9IGZyb20gJy4vY29udGV4dC1tZW51LnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBCZWZvcmVTaG93TWVudSwgQ29udGV4dE1lbnVJdGVtIH0gZnJvbSAnLi9tZW51LWl0ZW0uaW50ZXJmYWNlJztcclxuXHJcbkBEaXJlY3RpdmUoe1xyXG4gICAgc2VsZWN0b3I6ICdbZmFycmlzLWNvbnRleHQtbWVudXNdJyxcclxufSlcclxuZXhwb3J0IGNsYXNzIEZhcnJpc0NvbnRleHRNZW51RGlyZWN0aXZlIGltcGxlbWVudHMgT25Jbml0IHtcclxuICAgIEBJbnB1dCgnZmFycmlzLWNvbnRleHQtbWVudXMnKSBtZW51SXRlbXM6IENvbnRleHRNZW51SXRlbVtdO1xyXG4gICAgQElucHV0KCkgbWVudUNsYXNzOiBzdHJpbmc7XHJcbiAgICBASW5wdXQoKSBkaXNhYmxlZCA9IGZhbHNlO1xyXG4gICAgQElucHV0KCkgY29udGV4dDogYW55O1xyXG4gICAgQElucHV0KCkgYmVmb3JlU2hvd0NvbnRleHRNZW51OiAoZT86IGFueSkgPT4gT2JzZXJ2YWJsZTxCZWZvcmVTaG93TWVudT47XHJcbiAgICAvKiog6Kem5Y+R5Y+z6ZSu6I+c5Y2V5a6e6ZmFRE9N5qCH562+5ZCN56ewICovXHJcbiAgICBASW5wdXQoKSBhY3RpdmVEb21OYW1lOiBzdHJpbmc7XHJcbiAgICBASW5wdXQoKSBoaWdobGlnaHQgPSB0cnVlO1xyXG4gICAgaWQ6IHN0cmluZztcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihAT3B0aW9uYWwoKSBwcml2YXRlIGN0eE1lbnVTZXI6IEZhcnJpc0NvbnRleHRNZW51U2VydmljZSxcclxuICAgICAgICAgICAgICAgIHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yLCBwcml2YXRlIGVsUmVmOiBFbGVtZW50UmVmLCBwcml2YXRlIHJlbmRlcjogUmVuZGVyZXIyKSB7fVxyXG5cclxuICAgIG5nT25Jbml0KCkge1xyXG4gICAgICAgIHRoaXMuaWQgPSB0aGlzLmNvbnRleHRNZW51SWQoKTtcclxuXHJcbiAgICAgICAgaWYgKCF0aGlzLmJlZm9yZVNob3dDb250ZXh0TWVudSkge1xyXG4gICAgICAgICAgICB0aGlzLmJlZm9yZVNob3dDb250ZXh0TWVudSA9ICgpID0+IG9mKHRydWUpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBASG9zdExpc3RlbmVyKCdjb250ZXh0bWVudScsIFsnJGV2ZW50J10pXHJcbiAgICBwdWJsaWMgb25Db250ZXh0TWVudShldmVudDogTW91c2VFdmVudCk6IHZvaWQge1xyXG4gICAgICAgIGlmICghdGhpcy5kaXNhYmxlZCkge1xyXG4gICAgICAgICAgICBsZXQgY29udGV4dE1lbnVEb20gPSBudWxsO1xyXG4gICAgICAgICAgICBpZiAodGhpcy5hY3RpdmVEb21OYW1lKSB7XHJcbiAgICAgICAgICAgICAgICBjb250ZXh0TWVudURvbSA9IChldmVudC50YXJnZXQgYXMgYW55KS5jbG9zZXN0KHRoaXMuYWN0aXZlRG9tTmFtZSk7XHJcbiAgICAgICAgICAgICAgICBpZiAoY29udGV4dE1lbnVEb20pIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbmRlci5hZGRDbGFzcyhjb250ZXh0TWVudURvbSwgJ2YtY29udGV4dC1tZW51LWFjdGl2ZScpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGNvbnN0IGJlZm9yZVNob3ckID0gdGhpcy5iZWZvcmVTaG93Q29udGV4dE1lbnUoeyBldmVudCwgY29udGV4dE1lbnVEb20gfSk7XHJcbiAgICAgICAgICAgIGlmIChiZWZvcmVTaG93JCAmJiBiZWZvcmVTaG93JC5zdWJzY3JpYmUpIHtcclxuICAgICAgICAgICAgICAgIGJlZm9yZVNob3ckLnN1YnNjcmliZSggKGU6IEJlZm9yZVNob3dNZW51KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY3R4RGF0YSA9IHRoaXMuZ2V0Q29udGV4dERhdGEoZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW1vdmVTdXJwbHVzTWVudXMoKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoY3R4RGF0YS5zaG93KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuY2xpY2soKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jdHhNZW51U2VyLnNob3coe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVudUl0ZW1zOiB0aGlzLmdldFZpZXdNZW51SXRlbXMoY3R4RGF0YS5kYXRhKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IHRoaXMuaWQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY3RpdmVEb206IGNvbnRleHRNZW51RG9tLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGV4dDogY3R4RGF0YS5kYXRhLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVudUNsYXNzOiB0aGlzLm1lbnVDbGFzcyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldDogdGhpcy5lbFJlZi5uYXRpdmVFbGVtZW50LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aXZlV2lkdGg6IGVbJ2ZvY3VzVGFyZ2V0V2lkdGgnXSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhpZ2hsaWdodDogdGhpcy5oaWdobGlnaHRcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyDliKDpmaTnrKwz5bGC5Y+K5Lul5ZCO55qE6I+c5Y2V77yM5LuF5pSv5oyB5Lik5bGC6I+c5Y2V5bGV56S6XHJcbiAgICBwcml2YXRlIHJlbW92ZVN1cnBsdXNNZW51cygpIHtcclxuICAgICAgICBpZiAodGhpcy5tZW51SXRlbXMgJiYgdGhpcy5tZW51SXRlbXMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIHRoaXMubWVudUl0ZW1zLmZvckVhY2goKG06IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKG0gIT09ICctJyAmJiBtLmNoaWxkcmVuICYmIG0uY2hpbGRyZW4ubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbS5jaGlsZHJlbi5mb3JFYWNoKGNtID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNtICE9PSAnLScpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNtLmNoaWxkcmVuID0gW107XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgY29udGV4dE1lbnVJZCgpIHtcclxuICAgICAgICBjb25zdCBpZCA9IHRoaXMuZWxSZWYubmF0aXZlRWxlbWVudC5pZDtcclxuICAgICAgICBpZiAoaWQpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGAke2lkfS1jb250ZXh0LW1lbnVgO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiAnY29udGV4dC1tZW51XycgKyBuZXcgRGF0ZSgpLmdldFRpbWUoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXRDb250ZXh0RGF0YShlOiBCZWZvcmVTaG93TWVudSkge1xyXG4gICAgICAgIGlmICh0eXBlb2YgZSA9PT0gJ2Jvb2xlYW4nKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB7IHNob3c6IGUsIGRhdGE6IG51bGwgfTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGU7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIHByaXZhdGUgZ2V0Vmlld01lbnVJdGVtcyhjb250ZXh0KSB7XHJcbiAgICAgICAgaWYgKHRoaXMubWVudUl0ZW1zICYmIHRoaXMubWVudUl0ZW1zLmxlbmd0aCkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5jaGVja01lbnVJdGVtcyh0aGlzLm1lbnVJdGVtcywgY29udGV4dCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiAgW107XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBjaGVja01lbnVJdGVtcyhtZW51SXRlbXMsIGNvbnRleHQpIHtcclxuICAgICAgICBjb25zdCBtZW51cyA9IG1lbnVJdGVtcy5tYXAoKG06IGFueSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAodHlwZW9mIG0gPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgY29uc3QgbiA9IHRoaXMuY2hlY2tWaXNpYmxlQW5kRGlzYWJsZShtLCBjb250ZXh0KTtcclxuICAgICAgICAgICAgICAgaWYgKG4uY2hpbGRyZW4pIHtcclxuICAgICAgICAgICAgICAgICAgIG4uY2hpbGRyZW4gPSB0aGlzLmNoZWNrTWVudUl0ZW1zKG4uY2hpbGRyZW4sIGNvbnRleHQpO1xyXG4gICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgIHJldHVybiBuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSkuZmlsdGVyKG4gPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gbiA9PT0gJy0nIHx8IG4udmlzaWJsZTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgaWYgKG1lbnVzICYmIG1lbnVzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICBpZiAobWVudXNbMF0gPT09ICctJykge1xyXG4gICAgICAgICAgICAgICAgbWVudXMuc2hpZnQoMCk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChtZW51c1ttZW51cy5sZW5ndGggLSAxXSA9PT0gJy0nKSB7XHJcbiAgICAgICAgICAgICAgICBtZW51cy5wb3AoMCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBtZW51cztcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGNoZWNrVmlzaWJsZUFuZERpc2FibGUobTogYW55LCBjb250ZXh0KSB7XHJcbiAgICAgICAgY29uc3QgbiA9IHsuLi5tfTtcclxuICAgICAgICBpZiAoIW4uaGFzT3duUHJvcGVydHkoJ3Zpc2libGUnKSkge1xyXG4gICAgICAgICAgICBuLnZpc2libGUgPSB0cnVlO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlmICh0eXBlb2Ygbi52aXNpYmxlID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgICAgICAgICAgICBuLnZpc2libGUgPSBuLnZpc2libGUoIGNvbnRleHQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoIW4uaGFzT3duUHJvcGVydHkoJ2Rpc2FibGUnKSkge1xyXG4gICAgICAgICAgICBuLmRpc2FibGUgPSBmYWxzZTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBpZiAodHlwZW9mIG4uZGlzYWJsZSA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICAgICAgICAgICAgbi5kaXNhYmxlID0gbi5kaXNhYmxlKCBjb250ZXh0ICk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBuO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==