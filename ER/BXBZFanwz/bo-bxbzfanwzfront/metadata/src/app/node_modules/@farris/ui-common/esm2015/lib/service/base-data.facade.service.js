/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { BehaviorSubject } from 'rxjs';
import { map } from 'rxjs/operators';
/**
 * @template T
 */
export class BaseDataFacadeService {
    /**
     * @param {?} _initState
     */
    constructor(_initState) {
        this._initState = _initState;
        this._state = this._initState;
        this.store = new BehaviorSubject(this._state);
        this.state$ = this.store.asObservable();
        this.data$ = this.state$.pipe(map((/**
         * @param {?} state
         * @return {?}
         */
        (state) => state.data)));
    }
    /**
     * @private
     * @param {?} data
     * @return {?}
     */
    initData(data) {
        return data.map((/**
         * @param {?} d
         * @return {?}
         */
        d => {
            /** @type {?} */
            const _id = d[this._state.idField];
            /** @type {?} */
            const disable = (/**
             * @return {?}
             */
            () => {
                return this.disableExpress ? this.disableExpress(d) : false;
            });
            return {
                id: _id,
                data: d,
                disabled: disable(),
            };
        }));
    }
    /**
     * @protected
     * @param {?} state
     * @return {?}
     */
    updateState(state) {
        /** @type {?} */
        const newState = Object.assign({}, this._state, state);
        this.store.next(this._state = newState);
    }
    /**
     * @param {?} state
     * @return {?}
     */
    initState(state) {
        this.updateState(state);
    }
    /**
     * @param {?} id
     * @return {?}
     */
    isSelect(id) {
        if (this._state.selections && this._state.selections.length) {
            return this._state.selections.find((/**
             * @param {?} item
             * @return {?}
             */
            item => !!item ? item[this._state.idField] == id : false)) !== undefined;
        }
        return false;
    }
    /**
     * @param {?} data
     * @param {?=} selectValues
     * @param {?=} separator
     * @return {?}
     */
    loadData(data, selectValues = '', separator = ',') {
        if (data) {
            if (selectValues) {
                /** @type {?} */
                const selectedItems = selectValues.split(separator).map((/**
                 * @param {?} val
                 * @return {?}
                 */
                val => {
                    return data.find((/**
                     * @param {?} d
                     * @return {?}
                     */
                    d => d[this._state.valueField] + '' == val));
                }));
                this._state.selections = selectedItems.filter((/**
                 * @param {?} e
                 * @return {?}
                 */
                e => !!e));
            }
            else {
                this._state.selections = [];
            }
            /** @type {?} */
            const _data = this.initData(data);
            this.updateState(Object.assign({}, this._state, { data: _data }));
        }
        else {
            this.updateState({ data: [], selections: [] });
        }
    }
    /**
     * @return {?}
     */
    getSelections() {
        return this._state.selections;
    }
    /**
     * @param {?} selectValues
     * @param {?=} separator
     * @return {?}
     */
    setSelections(selectValues, separator = ',') {
        if (selectValues) {
            /** @type {?} */
            let selectedItems = [];
            if (this._state.multiSelect) {
                selectedItems = selectValues.split(separator).map((/**
                 * @param {?} val
                 * @return {?}
                 */
                val => {
                    return this._state.data.find((/**
                     * @param {?} d
                     * @return {?}
                     */
                    d => d.data[this._state.valueField] + '' == val));
                })).map((/**
                 * @param {?} n
                 * @return {?}
                 */
                n => {
                    return n ? n.data : '';
                })).filter((/**
                 * @param {?} n
                 * @return {?}
                 */
                n => n));
            }
            else {
                selectedItems = [this._state.data.find((/**
                     * @param {?} d
                     * @return {?}
                     */
                    d => d.data[this._state.valueField] + '' == selectValues))];
            }
            this.updateState({ selections: selectedItems });
        }
    }
    /**
     * @return {?}
     */
    selectAll() {
        this.updateState({ selections: this._state.data.map((/**
             * @param {?} n
             * @return {?}
             */
            n => n.data)) });
    }
    /**
     * @return {?}
     */
    unSelectAll() {
        this.clearSelections();
    }
    /**
     * @param {?} data
     * @param {?=} index
     * @return {?}
     */
    selectItem(data, index) {
        /** @type {?} */
        const idfield = this._state.idField;
        /** @type {?} */
        let selections = this.getSelections();
        /** @type {?} */
        const id = data[idfield];
        if (!this._state.multiSelect) {
            if (!this.isSelect(id)) {
                selections = [data];
            }
        }
        else {
            if (!this.isSelect(id)) {
                selections.push(data);
            }
        }
        /** @type {?} */
        const items = this.cloneArray(selections);
        this.updateState({ selections: items });
    }
    /**
     * @param {?} data
     * @return {?}
     */
    unSelectItem(data) {
        /** @type {?} */
        const idfield = this._state.idField;
        /** @type {?} */
        let selections = this.getSelections();
        /** @type {?} */
        const id = data[idfield];
        if (!this._state.multiSelect) {
            selections = [];
        }
        else {
            selections = selections.filter((/**
             * @param {?} n
             * @return {?}
             */
            n => n[idfield] != id));
        }
        /** @type {?} */
        const items = this.cloneArray(selections);
        this.updateState({ selections: items });
    }
    /**
     * @return {?}
     */
    clearSelections() {
        this.updateState({ selections: [] });
    }
    /**
     * @private
     * @param {?} arr
     * @return {?}
     */
    cloneArray(arr) {
        if (arr && arr.length) {
            return arr.map((/**
             * @param {?} n
             * @return {?}
             */
            n => n));
        }
        return arr;
    }
}
if (false) {
    /**
     * @type {?}
     * @protected
     */
    BaseDataFacadeService.prototype._state;
    /** @type {?} */
    BaseDataFacadeService.prototype.disableExpress;
    /** @type {?} */
    BaseDataFacadeService.prototype.store;
    /** @type {?} */
    BaseDataFacadeService.prototype.state$;
    /** @type {?} */
    BaseDataFacadeService.prototype.data$;
    /**
     * @type {?}
     * @private
     */
    BaseDataFacadeService.prototype._initState;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzZS1kYXRhLmZhY2FkZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy91aS1jb21tb24vIiwic291cmNlcyI6WyJsaWIvc2VydmljZS9iYXNlLWRhdGEuZmFjYWRlLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUNBLE9BQU8sRUFBRSxlQUFlLEVBQWMsTUFBTSxNQUFNLENBQUM7QUFDbkQsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDOzs7O0FBRXJDLE1BQU0sT0FBTyxxQkFBcUI7Ozs7SUFTOUIsWUFBb0IsVUFBYTtRQUFiLGVBQVUsR0FBVixVQUFVLENBQUc7UUFSdkIsV0FBTSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUM7UUFHMUIsVUFBSyxHQUFJLElBQUksZUFBZSxDQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUM3QyxXQUFNLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUU1QyxVQUFLLEdBQW9CLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUc7Ozs7UUFBQyxDQUFDLEtBQVEsRUFBRSxFQUFFLENBQUMsS0FBSyxDQUFDLElBQUksRUFBQyxDQUFDLENBQUM7SUFHekUsQ0FBQzs7Ozs7O0lBRU8sUUFBUSxDQUFDLElBQVM7UUFDdEIsT0FBTyxJQUFJLENBQUMsR0FBRzs7OztRQUFDLENBQUMsQ0FBQyxFQUFFOztrQkFDVixHQUFHLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDOztrQkFDNUIsT0FBTzs7O1lBQUcsR0FBRyxFQUFFO2dCQUNqQixPQUFPLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQztZQUNoRSxDQUFDLENBQUE7WUFDRCxPQUFPO2dCQUNILEVBQUUsRUFBRSxHQUFHO2dCQUNQLElBQUksRUFBRSxDQUFDO2dCQUNQLFFBQVEsRUFBRSxPQUFPLEVBQUU7YUFDdEIsQ0FBQztRQUNOLENBQUMsRUFBQyxDQUFDO0lBQ1AsQ0FBQzs7Ozs7O0lBRVMsV0FBVyxDQUFDLEtBQVU7O2NBQ3RCLFFBQVEscUJBQU8sSUFBSSxDQUFDLE1BQU0sRUFBSyxLQUFLLENBQUM7UUFDM0MsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sR0FBRyxRQUFRLENBQUMsQ0FBQztJQUM1QyxDQUFDOzs7OztJQUVELFNBQVMsQ0FBQyxLQUFVO1FBQ2hCLElBQUksQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDNUIsQ0FBQzs7Ozs7SUFFRCxRQUFRLENBQUMsRUFBTztRQUNaLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsTUFBTSxFQUFFO1lBQ3pELE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsSUFBSTs7OztZQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLEVBQUMsS0FBSyxTQUFTLENBQUM7U0FDOUc7UUFDRCxPQUFPLEtBQUssQ0FBQztJQUNqQixDQUFDOzs7Ozs7O0lBR0QsUUFBUSxDQUFDLElBQVMsRUFBRSxlQUF1QixFQUFFLEVBQUUsU0FBUyxHQUFHLEdBQUc7UUFDMUQsSUFBSSxJQUFJLEVBQUU7WUFDTixJQUFJLFlBQVksRUFBRTs7c0JBQ1IsYUFBYSxHQUFHLFlBQVksQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUMsR0FBRzs7OztnQkFBRSxHQUFHLENBQUMsRUFBRTtvQkFDM0QsT0FBTyxJQUFJLENBQUMsSUFBSTs7OztvQkFBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxHQUFHLEVBQUUsSUFBSSxHQUFHLEVBQUMsQ0FBQztnQkFDakUsQ0FBQyxFQUFDO2dCQUNGLElBQUksQ0FBQyxNQUFNLENBQUMsVUFBVSxHQUFHLGFBQWEsQ0FBQyxNQUFNOzs7O2dCQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBQyxDQUFDO2FBQzNEO2lCQUFNO2dCQUNILElBQUksQ0FBQyxNQUFNLENBQUMsVUFBVSxHQUFHLEVBQUUsQ0FBQzthQUMvQjs7a0JBQ0ssS0FBSyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDO1lBQ2pDLElBQUksQ0FBQyxXQUFXLG1CQUFLLElBQUksQ0FBQyxNQUFNLElBQUUsSUFBSSxFQUFFLEtBQUssSUFBRSxDQUFDO1NBQ25EO2FBQU07WUFDSCxJQUFJLENBQUMsV0FBVyxDQUFDLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRSxVQUFVLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQztTQUNsRDtJQUNMLENBQUM7Ozs7SUFFRCxhQUFhO1FBQ1QsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQztJQUNsQyxDQUFDOzs7Ozs7SUFFRCxhQUFhLENBQUMsWUFBb0IsRUFBRSxTQUFTLEdBQUcsR0FBRztRQUMvQyxJQUFJLFlBQVksRUFBRTs7Z0JBQ1YsYUFBYSxHQUFHLEVBQUU7WUFDdEIsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLFdBQVcsRUFBRTtnQkFDekIsYUFBYSxHQUFHLFlBQVksQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUMsR0FBRzs7OztnQkFBRSxHQUFHLENBQUMsRUFBRTtvQkFDckQsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJOzs7O29CQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxHQUFHLEVBQUUsSUFBSSxHQUFHLEVBQUMsQ0FBQztnQkFDbEYsQ0FBQyxFQUFDLENBQUMsR0FBRzs7OztnQkFBRSxDQUFDLENBQUMsRUFBRTtvQkFDUixPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO2dCQUMzQixDQUFDLEVBQUMsQ0FBQyxNQUFNOzs7O2dCQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFDLENBQUM7YUFDckI7aUJBQU07Z0JBQ0gsYUFBYSxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSTs7OztvQkFBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsR0FBRyxFQUFFLElBQUksWUFBWSxFQUFDLENBQUMsQ0FBQzthQUNyRztZQUNELElBQUksQ0FBQyxXQUFXLENBQUMsRUFBQyxVQUFVLEVBQUUsYUFBYSxFQUFFLENBQUMsQ0FBQztTQUNsRDtJQUNMLENBQUM7Ozs7SUFFRCxTQUFTO1FBQ0wsSUFBSSxDQUFDLFdBQVcsQ0FBQyxFQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHOzs7O1lBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQ3ZFLENBQUM7Ozs7SUFFRCxXQUFXO1FBQ1AsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO0lBQzNCLENBQUM7Ozs7OztJQUVELFVBQVUsQ0FBQyxJQUFTLEVBQUUsS0FBYzs7Y0FDMUIsT0FBTyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTzs7WUFDL0IsVUFBVSxHQUFHLElBQUksQ0FBQyxhQUFhLEVBQUU7O2NBRS9CLEVBQUUsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDO1FBQ3hCLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLFdBQVcsRUFBRTtZQUMxQixJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsRUFBRTtnQkFDcEIsVUFBVSxHQUFHLENBQUUsSUFBSSxDQUFFLENBQUM7YUFDekI7U0FDSjthQUFNO1lBQ0gsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLEVBQUU7Z0JBQ3BCLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDekI7U0FDSjs7Y0FFSyxLQUFLLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUM7UUFFekMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxFQUFDLFVBQVUsRUFBRSxLQUFLLEVBQUMsQ0FBQyxDQUFDO0lBQzFDLENBQUM7Ozs7O0lBRUQsWUFBWSxDQUFDLElBQVM7O2NBQ1osT0FBTyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTzs7WUFDL0IsVUFBVSxHQUFHLElBQUksQ0FBQyxhQUFhLEVBQUU7O2NBQy9CLEVBQUUsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDO1FBQ3hCLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLFdBQVcsRUFBRTtZQUMxQixVQUFVLEdBQUcsRUFBRSxDQUFDO1NBQ25CO2FBQU07WUFDSCxVQUFVLEdBQUcsVUFBVSxDQUFDLE1BQU07Ozs7WUFBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLEVBQUMsQ0FBRTtTQUMxRDs7Y0FFSyxLQUFLLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUM7UUFDekMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxFQUFDLFVBQVUsRUFBRSxLQUFLLEVBQUMsQ0FBQyxDQUFDO0lBQzFDLENBQUM7Ozs7SUFFRCxlQUFlO1FBQ1gsSUFBSSxDQUFDLFdBQVcsQ0FBQyxFQUFDLFVBQVUsRUFBRSxFQUFFLEVBQUMsQ0FBQyxDQUFDO0lBQ3ZDLENBQUM7Ozs7OztJQUVPLFVBQVUsQ0FBQyxHQUFVO1FBQ3pCLElBQUksR0FBRyxJQUFJLEdBQUcsQ0FBQyxNQUFNLEVBQUU7WUFDbkIsT0FBTyxHQUFHLENBQUMsR0FBRzs7OztZQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFDLENBQUM7U0FDM0I7UUFFRCxPQUFPLEdBQUcsQ0FBQztJQUNmLENBQUM7Q0FDSjs7Ozs7O0lBcElHLHVDQUFtQzs7SUFDbkMsK0NBQWtDOztJQUVsQyxzQ0FBc0Q7O0lBQ3RELHVDQUE0Qzs7SUFFNUMsc0NBQXlFOzs7OztJQUU3RCwyQ0FBcUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBGYXJyaXNEYXRhU3RhdGUgfSBmcm9tICcuL2ZhcnJpcy1kYXRhaXRlbSc7XHJcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCwgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBtYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcblxyXG5leHBvcnQgY2xhc3MgQmFzZURhdGFGYWNhZGVTZXJ2aWNlPFQgZXh0ZW5kcyBGYXJyaXNEYXRhU3RhdGU+IHtcclxuICAgIHByb3RlY3RlZCBfc3RhdGUgPSB0aGlzLl9pbml0U3RhdGU7XHJcbiAgICBkaXNhYmxlRXhwcmVzczogKGl0ZW0pID0+IGJvb2xlYW47XHJcblxyXG4gICAgcmVhZG9ubHkgc3RvcmUgID0gbmV3IEJlaGF2aW9yU3ViamVjdDxUPih0aGlzLl9zdGF0ZSk7XHJcbiAgICByZWFkb25seSBzdGF0ZSQgPSB0aGlzLnN0b3JlLmFzT2JzZXJ2YWJsZSgpO1xyXG5cclxuICAgIGRhdGEkOiBPYnNlcnZhYmxlPGFueT4gPSB0aGlzLnN0YXRlJC5waXBlKG1hcCgoc3RhdGU6IFQpID0+IHN0YXRlLmRhdGEpKTtcclxuXHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIF9pbml0U3RhdGU6IFQpIHtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGluaXREYXRhKGRhdGE6IGFueSkge1xyXG4gICAgICAgIHJldHVybiBkYXRhLm1hcChkID0+IHtcclxuICAgICAgICAgICAgY29uc3QgX2lkID0gZFt0aGlzLl9zdGF0ZS5pZEZpZWxkXTtcclxuICAgICAgICAgICAgY29uc3QgZGlzYWJsZSA9ICgpID0+IHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmRpc2FibGVFeHByZXNzID8gdGhpcy5kaXNhYmxlRXhwcmVzcyhkKSA6IGZhbHNlO1xyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgaWQ6IF9pZCxcclxuICAgICAgICAgICAgICAgIGRhdGE6IGQsXHJcbiAgICAgICAgICAgICAgICBkaXNhYmxlZDogZGlzYWJsZSgpLFxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHByb3RlY3RlZCB1cGRhdGVTdGF0ZShzdGF0ZTogYW55KSB7XHJcbiAgICAgICAgY29uc3QgbmV3U3RhdGUgPSB7Li4udGhpcy5fc3RhdGUsIC4uLnN0YXRlfTtcclxuICAgICAgICB0aGlzLnN0b3JlLm5leHQodGhpcy5fc3RhdGUgPSBuZXdTdGF0ZSk7XHJcbiAgICB9XHJcblxyXG4gICAgaW5pdFN0YXRlKHN0YXRlOiBhbnkpIHtcclxuICAgICAgICB0aGlzLnVwZGF0ZVN0YXRlKHN0YXRlKTtcclxuICAgIH1cclxuXHJcbiAgICBpc1NlbGVjdChpZDogYW55KSB7XHJcbiAgICAgICAgaWYgKHRoaXMuX3N0YXRlLnNlbGVjdGlvbnMgJiYgdGhpcy5fc3RhdGUuc2VsZWN0aW9ucy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3N0YXRlLnNlbGVjdGlvbnMuZmluZChpdGVtID0+ICEhaXRlbSA/IGl0ZW1bdGhpcy5fc3RhdGUuaWRGaWVsZF0gPT0gaWQgOiBmYWxzZSkgIT09IHVuZGVmaW5lZDtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICBsb2FkRGF0YShkYXRhOiBhbnksIHNlbGVjdFZhbHVlczogc3RyaW5nID0gJycsIHNlcGFyYXRvciA9ICcsJykge1xyXG4gICAgICAgIGlmIChkYXRhKSB7XHJcbiAgICAgICAgICAgIGlmIChzZWxlY3RWYWx1ZXMpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHNlbGVjdGVkSXRlbXMgPSBzZWxlY3RWYWx1ZXMuc3BsaXQoc2VwYXJhdG9yKS5tYXAoIHZhbCA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRhdGEuZmluZChkID0+IGRbdGhpcy5fc3RhdGUudmFsdWVGaWVsZF0gKyAnJyA9PSB2YWwpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLl9zdGF0ZS5zZWxlY3Rpb25zID0gc2VsZWN0ZWRJdGVtcy5maWx0ZXIoZSA9PiAhIWUpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5fc3RhdGUuc2VsZWN0aW9ucyA9IFtdO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNvbnN0IF9kYXRhID0gdGhpcy5pbml0RGF0YShkYXRhKTtcclxuICAgICAgICAgICAgdGhpcy51cGRhdGVTdGF0ZSh7Li4udGhpcy5fc3RhdGUsIGRhdGE6IF9kYXRhfSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy51cGRhdGVTdGF0ZSh7IGRhdGE6IFtdLCBzZWxlY3Rpb25zOiBbXSB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0U2VsZWN0aW9ucygpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fc3RhdGUuc2VsZWN0aW9ucztcclxuICAgIH1cclxuXHJcbiAgICBzZXRTZWxlY3Rpb25zKHNlbGVjdFZhbHVlczogc3RyaW5nLCBzZXBhcmF0b3IgPSAnLCcpIHtcclxuICAgICAgICBpZiAoc2VsZWN0VmFsdWVzKSB7XHJcbiAgICAgICAgICAgIGxldCBzZWxlY3RlZEl0ZW1zID0gW107XHJcbiAgICAgICAgICAgIGlmICh0aGlzLl9zdGF0ZS5tdWx0aVNlbGVjdCkge1xyXG4gICAgICAgICAgICAgICAgc2VsZWN0ZWRJdGVtcyA9IHNlbGVjdFZhbHVlcy5zcGxpdChzZXBhcmF0b3IpLm1hcCggdmFsID0+IHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fc3RhdGUuZGF0YS5maW5kKGQgPT4gZC5kYXRhW3RoaXMuX3N0YXRlLnZhbHVlRmllbGRdICsgJycgPT0gdmFsKTtcclxuICAgICAgICAgICAgICAgIH0pLm1hcCggbiA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG4gPyBuLmRhdGEgOiAnJztcclxuICAgICAgICAgICAgICAgIH0pLmZpbHRlcihuID0+IG4pO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgc2VsZWN0ZWRJdGVtcyA9IFt0aGlzLl9zdGF0ZS5kYXRhLmZpbmQoZCA9PiBkLmRhdGFbdGhpcy5fc3RhdGUudmFsdWVGaWVsZF0gKyAnJyA9PSBzZWxlY3RWYWx1ZXMpXTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLnVwZGF0ZVN0YXRlKHtzZWxlY3Rpb25zOiBzZWxlY3RlZEl0ZW1zIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBzZWxlY3RBbGwoKSB7XHJcbiAgICAgICAgdGhpcy51cGRhdGVTdGF0ZSh7c2VsZWN0aW9uczogdGhpcy5fc3RhdGUuZGF0YS5tYXAobiA9PiBuLmRhdGEpIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHVuU2VsZWN0QWxsKCkge1xyXG4gICAgICAgIHRoaXMuY2xlYXJTZWxlY3Rpb25zKCk7XHJcbiAgICB9XHJcblxyXG4gICAgc2VsZWN0SXRlbShkYXRhOiBhbnksIGluZGV4PzogbnVtYmVyKSB7XHJcbiAgICAgICAgY29uc3QgaWRmaWVsZCA9IHRoaXMuX3N0YXRlLmlkRmllbGQ7XHJcbiAgICAgICAgbGV0IHNlbGVjdGlvbnMgPSB0aGlzLmdldFNlbGVjdGlvbnMoKTtcclxuXHJcbiAgICAgICAgY29uc3QgaWQgPSBkYXRhW2lkZmllbGRdO1xyXG4gICAgICAgIGlmICghdGhpcy5fc3RhdGUubXVsdGlTZWxlY3QpIHtcclxuICAgICAgICAgICAgaWYgKCF0aGlzLmlzU2VsZWN0KGlkKSkge1xyXG4gICAgICAgICAgICAgICAgc2VsZWN0aW9ucyA9IFsgZGF0YSBdO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgaWYgKCF0aGlzLmlzU2VsZWN0KGlkKSkge1xyXG4gICAgICAgICAgICAgICAgc2VsZWN0aW9ucy5wdXNoKGRhdGEpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBpdGVtcyA9IHRoaXMuY2xvbmVBcnJheShzZWxlY3Rpb25zKTtcclxuXHJcbiAgICAgICAgdGhpcy51cGRhdGVTdGF0ZSh7c2VsZWN0aW9uczogaXRlbXN9KTtcclxuICAgIH1cclxuXHJcbiAgICB1blNlbGVjdEl0ZW0oZGF0YTogYW55KSB7XHJcbiAgICAgICAgY29uc3QgaWRmaWVsZCA9IHRoaXMuX3N0YXRlLmlkRmllbGQ7XHJcbiAgICAgICAgbGV0IHNlbGVjdGlvbnMgPSB0aGlzLmdldFNlbGVjdGlvbnMoKTtcclxuICAgICAgICBjb25zdCBpZCA9IGRhdGFbaWRmaWVsZF07XHJcbiAgICAgICAgaWYgKCF0aGlzLl9zdGF0ZS5tdWx0aVNlbGVjdCkge1xyXG4gICAgICAgICAgICBzZWxlY3Rpb25zID0gW107XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgc2VsZWN0aW9ucyA9IHNlbGVjdGlvbnMuZmlsdGVyKG4gPT4gbltpZGZpZWxkXSAhPSBpZCkgO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgaXRlbXMgPSB0aGlzLmNsb25lQXJyYXkoc2VsZWN0aW9ucyk7XHJcbiAgICAgICAgdGhpcy51cGRhdGVTdGF0ZSh7c2VsZWN0aW9uczogaXRlbXN9KTtcclxuICAgIH1cclxuXHJcbiAgICBjbGVhclNlbGVjdGlvbnMoKSB7XHJcbiAgICAgICAgdGhpcy51cGRhdGVTdGF0ZSh7c2VsZWN0aW9uczogW119KTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGNsb25lQXJyYXkoYXJyOiBhbnlbXSkge1xyXG4gICAgICAgIGlmIChhcnIgJiYgYXJyLmxlbmd0aCkge1xyXG4gICAgICAgICAgICByZXR1cm4gYXJyLm1hcCggbiA9PiBuKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBhcnI7XHJcbiAgICB9XHJcbn1cclxuIl19