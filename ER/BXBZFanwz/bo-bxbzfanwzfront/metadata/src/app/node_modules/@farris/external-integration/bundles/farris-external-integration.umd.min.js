!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@farris/ui-datagrid-editors"),require("@angular/core"),require("@farris/devkit"),require("rxjs"),require("@angular/common"),require("@farris/ui-dialog"),require("@farris/ui-modal"),require("@angular/common/http"),require("@angular/forms"),require("@farris/ui-locale"),require("@farris/ui-perfect-scrollbar"),require("@farris/ui-tree"),require("@farris/ui-tabs"),require("@farris/ui-common"),require("@farris/ui-forms"),require("@farris/ui-text"),require("@farris/ui-messager"),require("@farris/ui-notify"),require("@farris/ui-layout"),require("@farris/ui-datagrid"),require("@farris/ui-input-group"),require("@farris/ui-forms/validation-message"),require("@farris/ui-list-nav"),require("@farris/ui-list-view"),require("@angular/router")):"function"==typeof define&&define.amd?define("@farris/external-integration",["exports","@farris/ui-datagrid-editors","@angular/core","@farris/devkit","rxjs","@angular/common","@farris/ui-dialog","@farris/ui-modal","@angular/common/http","@angular/forms","@farris/ui-locale","@farris/ui-perfect-scrollbar","@farris/ui-tree","@farris/ui-tabs","@farris/ui-common","@farris/ui-forms","@farris/ui-text","@farris/ui-messager","@farris/ui-notify","@farris/ui-layout","@farris/ui-datagrid","@farris/ui-input-group","@farris/ui-forms/validation-message","@farris/ui-list-nav","@farris/ui-list-view","@angular/router"],e):e((t.farris=t.farris||{},t.farris["external-integration"]={}),t.uiDatagridEditors,t.ng.core,t.devkit,t.rxjs,t.ng.common,t.uiDialog,t.uiModal,t.ng.common.http,t.ng.forms,t.uiLocale,t.uiPerfectScrollbar,t.uiTree,t.uiTabs,t.uiCommon,t.uiForms,t.uiText,t.uiMessager,t.uiNotify,t.uiLayout,t.uiDatagrid,t.uiInputGroup,t.validationMessage,t.uiListNav,t.uiListView,t.ng.router)}(this,function(t,e,s,i,l,a,r,n,o,p,u,c,d,f,g,h,m,y,v,b,x,D,w,S,C,M){"use strict";var I=function(t,e){return(I=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)};var k,E,O={readonly:!1,placeholder:"请选择",viewType:"tag"},T=(k=e.DatagridBaseEditorDirective,I(E=V,j=k),E.prototype=null===j?Object.create(j):(F.prototype=j.prototype,new F),V.prototype.ngOnInit=function(){var e=this;k.prototype.ngOnInit.call(this),this.inputElement=this.instance.input.nativeElement,this.options=Object.assign({},O,this.options),this.column.editor.options.onBlur=function(t){t.editorRef.startPending(),t.editorRef.formControl.setValue(e.instance.fieldText),e.instance.callSapService(),e.instance.afterOnblur.subscribe(function(){t.editorRef.endPending()})}},V.prototype.ngAfterViewInit=function(){k.prototype.ngAfterViewInit.call(this)},V.decorators=[{type:s.Component,args:[{selector:"grid-external-integration",template:'\n    <div [formGroup]="group" class="f-datagrid-cell-formgroup farris-group-auto">\n      <web-external-integration\n        #extIntgrtn\n        style="width: 100%"\n        extIntegration-dataMapping\n        [placeholder]="options.placeholder"\n        [readonly]="options.readonly"\n        [mapFields]="options.mapFields"\n        [serviceCode] = "options.serviceCode"\n        [externalParams] = "options.externalParams"\n        [extTableSchemas] = "options.extTableSchemas"\n        [formControlName]="column.field"\n        [mappingType] = "\'grid\'"\n        \n      ></web-external-integration>\n    </div>\n  '}]}],V.ctorParameters=function(){return[{type:s.Renderer2},{type:s.ElementRef},{type:g.RuntimeStateService},{type:s.Injector}]},V.propDecorators={instance:[{type:s.ViewChild,args:["extIntgrtn"]}]},V);function F(){this.constructor=E}function V(t,e,i,a){a=k.call(this,t,e,a)||this;return a.rts=i,a.stopPropagation=!1,a}var e={provide:x.GRID_EDITORS,useValue:{name:"external-integration",value:T},multi:!0},q=(P.prototype.queryExtIntegrationService=function(t,e){var i=this,e=this.assembleSapRequest(t,e);this.http.post(this.sapUrl,e).subscribe(function(t){var t=Object.create(t);t&&t.success&&(t=Object.create(t).data,i.sapData.emit(t))},function(t){console.log(t),i.sapData.emit({})})},P.prototype.assembleSapRequest=function(t,e){t=JSON.parse(JSON.stringify(t));return{code:e,params:this.variableParseService.parse(t,this.vm.frameContext)}},P.decorators=[{type:s.Injectable}],P.ctorParameters=function(){return[{type:o.HttpClient},{type:i.VariableParseService},{type:i.ViewModel}]},P.propDecorators={sapData:[{type:s.Output}]},P);function P(t,e,i){this.http=t,this.variableParseService=e,this.vm=i,this.sapData=new s.EventEmitter,this.sapUrl="http://"+location.host+"/api/runtime/icc/v1.0/externalServiceOpenApi/invokeService"}var R=(L.prototype.ngOnChanges=function(t){},L.prototype.fieldTextChange=function(){var t=this.getBindingPathArray();this.vm.bindingData.setValue(t.concat(this.ngControl.name),this.fieldText,!0,!0)},L.prototype.ngAfterViewInit=function(){},L.prototype.ngOnDestroy=function(){},L.prototype.writeValue=function(t){this.fieldText=t},L.prototype.registerOnChange=function(t){},L.prototype.registerOnTouched=function(t){},L.prototype.setDisabledState=function(t){},L.prototype.ngOnInit=function(){var e=this;this.ngControl=this.inj.get(p.NgControl),"grid"!=this.mappingType&&(this.input.nativeElement.onblur=function(){e.callSapService()}),this.extIntgrtnSrvc.sapData.subscribe(function(t){e.sapDataHandle(t)})},L.prototype.showDialog=function(){return this.farrisListView.listClick.emit({data:[this.tableData[0]],index:0,checkChangeEvent:!1}),this.farrisListView.clickItem=this.tableData[0],this.dialog.show(),!1},L.prototype.callSapService=function(){this.fieldTextChange(),this.extIntgrtnSrvc.queryExtIntegrationService(this.externalParams,this.serviceCode)},L.prototype.sapDataHandle=function(e){var i,a,t,r,n=this;e&&(r=Object.keys(e),i=this.getTableListFromMapFields(),1<(r=r.filter(function(t){return-1!=i.indexOf(t)})).length?"open"==(t=this.checkMultiTableData(e,r))?(this.assembleTableData(e),this.showDialog()):"backfill"==t?(a={},r.forEach(function(t){Object.assign(a,n.assembleSapData(t,e[t][0]))}),this.sendSapData(a)):this.sendSapData():1==r.length?(t=r[0],0<(r=(e[t]||[]).length)&&(1==r?(t=this.assembleSapData(t,e[t][0]),this.sendSapData(t)):1<r&&(this.assembleTableData(e),this.showDialog()))):this.sendSapData())},L.prototype.checkMultiTableData=function(t,e){for(var i="",a=0;a<e.length;a++){var r=e[a];if(1<t[r].length){i="open";break}0!=t[r].length||"backfill"==i?i="backfill":i="none"}return i},L.prototype.assembleTableData=function(e){var i=this,a=Object.keys(e),t=this.getTableListFromMapFields();0<(t=t.filter(function(t){return-1!=a.indexOf(t)})).length&&t.forEach(function(t){t=i.assembleTableInfo(t,e);t&&0<Object.keys(t).length&&0<(t.data||[]).length&&i.tableData.push(t)})},L.prototype.getTableListFromMapFields=function(){var t=Object.keys(this.myField),e=[];return(t||[]).forEach(function(t){e.push(t.split(".")[0])}),e=Array.from(new Set(e))},L.prototype.assembleTableInfo=function(e,i){var a={},r=[];return(this.extTableSchemas||[]).forEach(function(t){t.code==e&&(a.name=t.name,r.push({field:"id",title:"序号"}),t.columns.forEach(function(t){var e={};e.field=t.code,e.title=t.name,r.push(e)}),a.columns=r,a.code=e,(i[e]||[]).forEach(function(t,e){t.id=e+1}),a.data=i[e])}),a},L.prototype.listClick=function(t){var e=t.data;if(t.data.disable)return!1;if("undefined"!=typeof this.currentLink.data){if(e[0].code===this.currentLink.data[0].code)return!1;this.currentLink=t}else this.currentLink=t},L.prototype.confirm=function(t){if("ensure"==t){for(var e={},i=0;i<this.tableData.length;i++){var a=this.tableData[i];Object.assign(e,this.assembleSapData(a.code,a.selectedData.data))}this.sendSapData(e)}this.tableData=[],this.dialog.close()},L.prototype.selectRowChange=function(e,i){this.tableData.forEach(function(t){t.code==i&&(t.selectedData=e)}),this.setEnsureButtonFlag()},L.prototype.unSelect=function(t,e){this.tableData.forEach(function(t){t.code==e&&(t.selectedData=null,t.selectedValue="")}),this.setEnsureButtonFlag()},L.prototype.setEnsureButtonFlag=function(){for(var t=!1,e=0;e<this.tableData.length;e++)if(!this.tableData[e].selectedData){t=!0;break}this.ensureFlag=t},L.prototype.assembleSapData=function(t,e){if(t&&e){for(var i={},a=Object.keys(e),r=0;r<a.length;r++){var n=a[r];i[t+"."+n]=e[n]}return i}},L.prototype.sendSapData=function(t){t&&this.selectSapData.emit(t),"grid"==this.mappingType&&this.afterOnblur.emit()},L.prototype.getBindingPathArray=function(){var t=this.vm.bindingPath;return t?t.split("/").filter(function(t){return""!==t}):[]},L.decorators=[{type:s.Component,args:[{selector:"web-external-integration",template:'<input [(ngModel)]="fieldText" #input  class="form-control" input-end-edit [readonly]="false"\n  tabindex="0" maxlength="36" />\n\n<farris-dialog #dialog [title]="\'选择数据\'" [beforeClose]="beforeClose"  [width]="1000" [height]="834" [showButtons]="true" [showMaxButton]="true"\n  [showCloseButton]="true" [enableScroll]="false" [dialogHeaderHeight]="50" [buttons]="defaultButtonRef">\n  <div [ngStyle]="containerStyle" style="height: 100%;">\n    <div class="listnav-example-wrapper">\n      <div class="example-side-nav">\n        <farris-list-nav  [listNavWidth]="240" (listClick)="listClick($event)">\n          <ng-template listNavContent>\n            <farris-list-view #farrisListView [showEmpty]="true" [data]="tableData" [activeIndex]="3" listidName="code" (listClick)="listClick($event)">\n              <ng-template #navView listTemplate let-item="item" let-selected="selectedItem">\n                <div class="f-template-listnav-row">\n                  \x3c!-- routerLinkActive="active" --\x3e\n                  <a class="list-nav-link" [ngStyle]="{\'pointer-events\': item.disable ?\'none\' : \'\',\'width\':240 +\'px\'}"\n                     [title]="item.name">\n                    <span class="nav-item-name">\n                      {{ item.name }}\n                    </span>\n                  </a>\n                </div>\n              </ng-template>\n            </farris-list-view>\n          </ng-template>\n\n          \x3c!-- <ng-template listNavFooter>\n                底部部分\n            </ng-template> --\x3e\n\n        </farris-list-nav>\n      </div>\n      <div class="example-content" >\n        <ng-container #girdView *ngFor="let item of tableData;let i = index">\n          <div style="height:100%" [hidden]="! (currentLink && item.code == ((currentLink[\'data\'] || [])[0] || {})[\'code\'])" >\n            <farris-datagrid \n              [autoFitColumns]="true" \n              [columns]="item.columns" \n              [data]="item.data" \n              [fitColumns]="true"\n              [fit]="true" \n              [showBorder]="true" \n              [(selectValue)]="item.selectedValue"\n              [keepSelect]="false"\n              [pagination]="false"\n              (selectChanged)="selectRowChange($event, item.code)"\n              (unSelect)="unSelect(null, item.code)">\n            </farris-datagrid>\n          </div>\n        </ng-container>\n      </div>\n    </div>\n  </div>\n</farris-dialog>\n\n<ng-template #defaultButtonRef>\n  <button #okbtn type="button" [disabled]="ensureFlag" (click)="confirm(\'ensure\')"  class="btn btn-primary btn-lg">\n    {{ \'lookup.okText\' | locale: \'确定\' }}\n  </button>\n  <button type="button" class="btn btn-secondary btn-lg" (click)="confirm(\'cancel\')" [disabled]="false">\n    {{ \'lookup.cancelText\' | locale: \'取消\' }}\n  </button>\n</ng-template>',providers:[q,{provide:p.NG_VALUE_ACCESSOR,useExisting:s.forwardRef(function(){return L}),multi:!0}],styles:[".listnav-example-wrapper{background-color:#e7ebef;display:flex;height:100%}.listnav-example-wrapper .example-side-nav{flex:0 0 auto}.listnav-example-wrapper .example-content{flex:1 1 0;width:726px;overflow-y:auto;padding:10px 10px 10px 4px}.listnav-example-wrapper .example-content .listnav-content{height:100%;width:100%;background-color:#fff}.listnav-example-wrapper .example-content.example-content-right{padding:10px 4px 10px 10px}"]}]}],L.ctorParameters=function(){return[{type:i.ViewModel,decorators:[{type:s.Optional}]},{type:s.ElementRef},{type:q},{type:i.VariableParseService},{type:s.ComponentFactoryResolver},{type:s.Injector}]},L.propDecorators={width:[{type:s.Input}],height:[{type:s.Input}],serviceCode:[{type:s.Input,args:["serviceCode"]}],externalParams:[{type:s.Input,args:["externalParams"]}],mappingType:[{type:s.Input,args:["mappingType"]}],myField:[{type:s.Input,args:["mapFields"]}],fieldText:[{type:s.Input}],extTableSchemas:[{type:s.Input,args:["extTableSchemas"]}],placeholder:[{type:s.Input}],readonly:[{type:s.Input}],beforeSapSrvc:[{type:s.Input}],customData:[{type:s.Input}],selectSapData:[{type:s.Output}],afterOnblur:[{type:s.Output}],dialog:[{type:s.ViewChild,args:["dialog"]}],input:[{type:s.ViewChild,args:["input"]}],girdView:[{type:s.ViewChild,args:["girdView",{read:s.ViewContainerRef}]}],farrisListView:[{type:s.ViewChild,args:["farrisListView"]}]},L);function L(t,e,i,a,r,n){var o=this;this.vm=t,this.el=e,this.extIntgrtnSrvc=i,this.variableParseService=a,this.resolver=r,this.inj=n,this.width=960,this.height=577,this.fieldText="",this.placeholder="请选择",this.readonly=!1,this.containerMargin={top:0,bottom:5,left:10,right:10},this.selectSapData=new s.EventEmitter,this.afterOnblur=new s.EventEmitter,this.tableData=[],this.currentLink={},this.ensureFlag=!0,this.containerStyle={marginLeft:this.containerMargin.left+"px",marginRight:this.containerMargin.right+"px",marginTop:this.containerMargin.top+"px",marginBottom:this.containerMargin.bottom+"px"},this.beforeClose=function(){return o.tableData=[],o.ensureFlag=!0,o.sendSapData(),l.of(!0)}}var j=(B.prototype.ngOnInit=function(){var e=this;this.extIntegrationComponent.selectSapData.subscribe(function(t){e.mappingData(t,e.myField)})},B.prototype.mappingData=function(a,r){var n=this;Object.keys(r).forEach(function(t){var e,i=n.getBindingPathArray();a&&(e=a[t]),n.vm.bindingData.setValue(i.concat(r[t]),e,!0,!0)})},B.prototype.getBindingPathArray=function(){var t=this.vm.bindingPath;return t?t.split("/").filter(function(t){return""!==t}):[]},B.decorators=[{type:s.Directive,args:[{selector:"[extIntegration-dataMapping]"}]}],B.ctorParameters=function(){return[{type:i.ViewModel,decorators:[{type:s.Optional}]},{type:R}]},B.propDecorators={myField:[{type:s.Input,args:["mapFields"]}],showModal:[{type:s.Output}]},B);function B(t,e){this.vm=t,this.extIntegrationComponent=e,this.showModal=new s.EventEmitter}N.decorators=[{type:s.NgModule,args:[{declarations:[j,R,T],imports:[a.CommonModule,p.ReactiveFormsModule,C.ListViewModule,M.RouterModule,S.ListNavModule,D.InputGroupModule,m.TextModule,o.HttpClientModule,w.FormMessageModule,c.PerfectScrollbarModule,d.TreeModule,f.FarrisTabsModule,h.FarrisFormsModule,p.FormsModule,g.FarrisCommonModule.forRoot(),r.FarrisDialogModule.forRoot(),y.MessagerModule.forRoot(),v.NotifyModule.forRoot(),b.LayoutModule,u.LocaleModule.forRoot(),n.ModalModule.forRoot(),x.DatagridModule],providers:[n.BsModalService,r.DialogService],entryComponents:[T,x.DatagridComponent],exports:[j,R,T]}]}],x=N;function N(){}t.DatagridExtIntgrtnComponent=T,t.ExtIntgrtnDataGridEditorProvider=e,t.ExternalIntegrationModule=x,t.ExtIntegrationDataMappingDirective=j,t.ExternalIntegrationService=q,t.ExternalIntegrationComponent=R,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=farris-external-integration.umd.min.js.map