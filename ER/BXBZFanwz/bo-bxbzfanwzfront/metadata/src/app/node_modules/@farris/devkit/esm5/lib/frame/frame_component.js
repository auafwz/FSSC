/*
 * @Author: Witt
 * @Date: 2019-03-12 14:59:22
 * @Last Modified by: aalizzwell
 * @Last Modified time: 2019-06-15 17:26:07
 */
import { Injector, Injectable, ChangeDetectorRef } from '@angular/core';
import { FrameContext } from './frame_context';
import { Subscription, Declaration } from '../event-mechanism/index';
import { FRAME_COMPONENT_INIT_HANDLER_TOKEN } from './tokens';
var FrameComponent = /** @class */ (function () {
    /**
     * 框架构造函数
     * @param injector 注入器
     */
    function FrameComponent(injector) {
        this.injector = injector;
        this.initialized = false;
        this.context = this.injector.get(FrameContext, null);
        if (this.context) {
            this.initialize();
        }
        // this.context.init(this);
        // this.viewModel = this.context.viewModel;
        // this.cd = this.getChangeDetectorRef();
        // // 必须先执行context的初始化，然后再初始化Subscription
        // this.initPublicEvent();
        // this.initSubscription();
        // this.restComponent();
    }
    FrameComponent.prototype.ngOnInit = function () {
        this.initialize();
    };
    FrameComponent.prototype.initialize = function () {
        if (!this.initialized) {
            this.context.init(this);
            this.viewModel = this.context.viewModel;
            this.cd = this.getChangeDetectorRef();
            // 必须先执行context的初始化，然后再初始化Subscription
            this.initPublicEvent();
            this.initSubscription();
            this.restComponent();
            this.onFrameComponentInit();
            this.initialized = true;
        }
    };
    /**
     * 执行组件初始化
     */
    FrameComponent.prototype.onFrameComponentInit = function () {
        var _this = this;
        var frameComponentInitHandlers = this.injector.get(FRAME_COMPONENT_INIT_HANDLER_TOKEN, null);
        if (frameComponentInitHandlers && Array.isArray(frameComponentInitHandlers) && frameComponentInitHandlers.length > 0) {
            frameComponentInitHandlers.forEach(function (handler) {
                handler.onComponentInit(_this.context);
            });
        }
    };
    /**
     * 获取变更检测器实例
     * @todo：应该通过注入获取，但注入会引起表单编译。
     */
    FrameComponent.prototype.getChangeDetectorRef = function () {
        // const cd = this.get<ChangeDetectorRef>(ChangeDetectorRef, null, InjectFlags.Optional);
        var cd = this.injector.get(ChangeDetectorRef, null);
        return cd;
    };
    /**
     * 将当前组件脱离变更检测树
     */
    FrameComponent.prototype.detach = function () {
        if (this.isCdValid() === false) {
            return;
        }
        this.cd.detach();
    };
    /**
     * 将当前组件重新加入变更检测树
     */
    FrameComponent.prototype.reattach = function () {
        if (this.isCdValid() === false) {
            return;
        }
        this.cd.reattach();
    };
    /**
     * 对当前组件进行一次变更检查
     */
    FrameComponent.prototype.detectChanges = function () {
        if (this.isCdValid() === false) {
            return;
        }
        this.cd.detectChanges();
    };
    /**
     * 检测ChangeDetection是否有效
     * @todo: Can't be depend on the destroyed property, destroyed.
     */
    FrameComponent.prototype.isCdValid = function () {
        return this.cd && this.cd['destroyed'] === false || false;
    };
    /**
     * 重置组件状态
     * @todo：AppContext是全局的，
     */
    FrameComponent.prototype.restComponent = function () {
        if (this.context !== this.context.root) {
            return;
        }
        // 1、如果AppContext不是root并且父AppContext也不是root不清理;
        // 2、表单Module里注入了FARRIS_DEVKIT_APP_PROVIDERS里面有一个冗余的AppContext注入
        //    导致所有AppContext的根是该冗余的AppContext，所以要检测parent.parent。
        // 只清理根组件的session
        if (this.context.appContext.parent !== null && this.context.appContext.parent.parent !== null) {
            return;
        }
        // Repository被注册到全局了，模块依赖注入中的对象，没有重置时机，临时在根组件中进行注销。
        // @todo：应该清理全部repository，目前缺少全局管理所有Repository的地方。
        this.context.repository.reset();
        // 重置组件绑定数据
        this.context.bindingData.reset();
    };
    FrameComponent.prototype.ngOnDestroy = function () {
        var _this = this;
        if (this.context.isRootFrameContext() === true) {
            this.context.appContext.unregisterFromManager(this.context);
        }
        this.eventPipes.forEach(function (eventPipe) {
            eventPipe.disposeByCaller(_this);
        });
        this.context.destroy();
    };
    /**
     * 初始化事件订阅
     */
    FrameComponent.prototype.initSubscription = function () {
        this.subscription = this.getSubscription();
        if (!this.subscription) {
            return;
        }
        this.eventPipes = this.subscription.init(this);
    };
    /**
     * 获取component对应的订阅
     * @returns
     */
    FrameComponent.prototype.getSubscription = function () {
        return this.injector.get(Subscription, null);
    };
    FrameComponent.prototype.initPublicEvent = function () {
        this.declaration = this.getDeclaration();
        if (!this.declaration) {
            return;
        }
        this.declaration.init(this);
    };
    /**
     * 获取当前component对应的declaration
     * @returns
     */
    FrameComponent.prototype.getDeclaration = function () {
        return this.injector.get(Declaration, null);
    };
    /**
     * 事件触发器，触发事件发布
     * @param eventName 待发布事件
     */
    FrameComponent.prototype.trigger = function (eventName) {
        var _this = this;
        var subscription = this.context.commandBus.executingCommandCount$.subscribe(function (executingCommandCount) {
            if (executingCommandCount !== 0) {
                return;
            }
            _this.innerTrigger(eventName);
            // @todo
            // subscription存在未undefine的情况，待进一步排查。
            if (subscription) {
                subscription.unsubscribe();
            }
            else {
                setTimeout(function () {
                    if (subscription) {
                        subscription.unsubscribe();
                    }
                }, 0);
            }
        });
    };
    /**
     * 内部触发变更检测
     */
    FrameComponent.prototype.innerTrigger = function (eventName) {
        // 根据事件名，查找对应的事件处理器
        var eventHandler = this.declaration && this.declaration[eventName];
        if (!eventHandler) {
            return;
        }
        // 执行事件
        eventHandler();
    };
    FrameComponent.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    FrameComponent.ctorParameters = function () { return [
        { type: Injector }
    ]; };
    return FrameComponent;
}());
export { FrameComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZnJhbWVfY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9kZXZraXQvIiwic291cmNlcyI6WyJsaWIvZnJhbWUvZnJhbWVfY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7OztHQUtHO0FBRUgsT0FBTyxFQUFFLFFBQVEsRUFBRSxVQUFVLEVBQXlCLGlCQUFpQixFQUFzRixNQUFNLGVBQWUsQ0FBQztBQUVuTCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFFL0MsT0FBTyxFQUFFLFlBQVksRUFBRSxXQUFXLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUVyRSxPQUFPLEVBQUUsa0NBQWtDLEVBQXdCLE1BQU0sVUFBVSxDQUFDO0FBR3BGO0lBdUNFOzs7T0FHRztJQUNILHdCQUFzQixRQUFrQjtRQUFsQixhQUFRLEdBQVIsUUFBUSxDQUFVO1FBTGhDLGdCQUFXLEdBQUcsS0FBSyxDQUFDO1FBTTFCLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQWUsWUFBWSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ25FLElBQUksSUFBSSxDQUFDLE9BQU8sRUFBRTtZQUNoQixJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7U0FDbkI7UUFDRCwyQkFBMkI7UUFDM0IsMkNBQTJDO1FBQzNDLHlDQUF5QztRQUV6Qyx5Q0FBeUM7UUFDekMsMEJBQTBCO1FBRTFCLDJCQUEyQjtRQUUzQix3QkFBd0I7SUFDMUIsQ0FBQztJQUVELGlDQUFRLEdBQVI7UUFDRSxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7SUFDcEIsQ0FBQztJQUVPLG1DQUFVLEdBQWxCO1FBQ0UsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUU7WUFDckIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDeEIsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsT0FB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QjtRQUFoQyxpQkFvQkM7UUFuQkMsSUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsc0JBQXNCLENBQUMsU0FBUyxDQUFDLFVBQUMscUJBQTZCO1lBQzFHLElBQUkscUJBQXFCLEtBQUssQ0FBQyxFQUFFO2dCQUMvQixPQUFPO2FBQ1I7WUFDRCxLQUFJLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBRTdCLFFBQVE7WUFDUixxQ0FBcUM7WUFDckMsSUFBSSxZQUFZLEVBQUU7Z0JBQ2hCLFlBQVksQ0FBQyxXQUFXLEVBQUUsQ0FBQzthQUM1QjtpQkFBTTtnQkFDTCxVQUFVLENBQUM7b0JBQ1QsSUFBSSxZQUFZLEVBQUU7d0JBQ2hCLFlBQVksQ0FBQyxXQUFXLEVBQUUsQ0FBQztxQkFDNUI7Z0JBQ0gsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO2FBQ1A7UUFFSCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRDs7T0FFRztJQUNLLHFDQUFZLEdBQXBCLFVBQXFCLFNBQWlCO1FBRXBDLG1CQUFtQjtRQUNuQixJQUFNLFlBQVksR0FBUSxJQUFJLENBQUMsV0FBVyxJQUFJLElBQUksQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDMUUsSUFBSSxDQUFDLFlBQVksRUFBRTtZQUNqQixPQUFPO1NBQ1I7UUFDRCxPQUFPO1FBQ1AsWUFBWSxFQUFFLENBQUM7SUFDakIsQ0FBQzs7Z0JBelBGLFVBQVU7Ozs7Z0JBVEYsUUFBUTs7SUFvUWpCLHFCQUFDO0NBQUEsQUEzUEQsSUEyUEM7QUFFRCxPQUFPLEVBQUUsY0FBYyxFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxyXG4gKiBAQXV0aG9yOiBXaXR0XHJcbiAqIEBEYXRlOiAyMDE5LTAzLTEyIDE0OjU5OjIyXHJcbiAqIEBMYXN0IE1vZGlmaWVkIGJ5OiBhYWxpenp3ZWxsXHJcbiAqIEBMYXN0IE1vZGlmaWVkIHRpbWU6IDIwMTktMDYtMTUgMTc6MjY6MDdcclxuICovXHJcblxyXG5pbXBvcnQgeyBJbmplY3RvciwgSW5qZWN0YWJsZSwgSW5qZWN0RmxhZ3MsIE9wdGlvbmFsLCBDaGFuZ2VEZXRlY3RvclJlZiwgT25EZXN0cm95LCBFbGVtZW50UmVmLCBSZW5kZXJlciwgUmVuZGVyZXIyLCBSZW5kZXJlckZhY3RvcnkyLCBDb21wb25lbnRSZWYsIE9uSW5pdCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBmaWx0ZXIsIHRha2UgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IEZyYW1lQ29udGV4dCB9IGZyb20gJy4vZnJhbWVfY29udGV4dCc7XHJcbmltcG9ydCB7IFZpZXdNb2RlbCB9IGZyb20gJy4uL3ZpZXctbW9kZWwvaW5kZXgnO1xyXG5pbXBvcnQgeyBTdWJzY3JpcHRpb24sIERlY2xhcmF0aW9uIH0gZnJvbSAnLi4vZXZlbnQtbWVjaGFuaXNtL2luZGV4JztcclxuaW1wb3J0IHsgSURpc3Bvc2FibGUsIEV2ZW50UGlwZSB9IGZyb20gJy4uL2V2ZW50LWJ1cy1uZXcvaW5kZXgnO1xyXG5pbXBvcnQgeyBGUkFNRV9DT01QT05FTlRfSU5JVF9IQU5ETEVSX1RPS0VOLCBvbkZyYW1lQ29tcG9uZW50SW5pdCB9IGZyb20gJy4vdG9rZW5zJztcclxuXHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmFic3RyYWN0IGNsYXNzIEZyYW1lQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3kge1xyXG5cclxuICAvKipcclxuICAgKiDlj5jmm7Tmo4DmtYvlmahcclxuICAgKi9cclxuICBwcml2YXRlIGNkOiBDaGFuZ2VEZXRlY3RvclJlZjtcclxuXHJcbiAgLyoqXHJcbiAgICog5qGG5p62SURcclxuICAgKi9cclxuICBwdWJsaWMgaWQ6IHN0cmluZztcclxuXHJcbiAgLyoqXHJcbiAgICog5qGG5p625LiK5LiL5paHXHJcbiAgICovXHJcbiAgcHVibGljIGNvbnRleHQ6IEZyYW1lQ29udGV4dDtcclxuXHJcbiAgLyoqXHJcbiAgICog6KeG5Zu+5qih5Z6LXHJcbiAgICovXHJcbiAgcHVibGljIHZpZXdNb2RlbDogVmlld01vZGVsO1xyXG5cclxuICAvKipcclxuICAgKiDorqLpmIXkuovku7ZcclxuICAgKi9cclxuICBwdWJsaWMgc3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XHJcblxyXG4gIC8qKlxyXG4gICAqIOWFrOW8gOS6i+S7tlxyXG4gICAqL1xyXG4gIHB1YmxpYyBkZWNsYXJhdGlvbjogRGVjbGFyYXRpb247XHJcblxyXG4gIC8qKlxyXG4gICAqIOivpee7hOS7tuiuoumYheeahEV2ZW50UGlwZXNcclxuICAgKi9cclxuICBwcml2YXRlIGV2ZW50UGlwZXM6IElEaXNwb3NhYmxlW107XHJcblxyXG4gIHByaXZhdGUgaW5pdGlhbGl6ZWQgPSBmYWxzZTtcclxuICAvKipcclxuICAgKiDmoYbmnrbmnoTpgKDlh73mlbBcclxuICAgKiBAcGFyYW0gaW5qZWN0b3Ig5rOo5YWl5ZmoXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IocHJvdGVjdGVkIGluamVjdG9yOiBJbmplY3Rvcikge1xyXG4gICAgdGhpcy5jb250ZXh0ID0gdGhpcy5pbmplY3Rvci5nZXQ8RnJhbWVDb250ZXh0PihGcmFtZUNvbnRleHQsIG51bGwpO1xyXG4gICAgaWYgKHRoaXMuY29udGV4dCkge1xyXG4gICAgICB0aGlzLmluaXRpYWxpemUoKTtcclxuICAgIH1cclxuICAgIC8vIHRoaXMuY29udGV4dC5pbml0KHRoaXMpO1xyXG4gICAgLy8gdGhpcy52aWV3TW9kZWwgPSB0aGlzLmNvbnRleHQudmlld01vZGVsO1xyXG4gICAgLy8gdGhpcy5jZCA9IHRoaXMuZ2V0Q2hhbmdlRGV0ZWN0b3JSZWYoKTtcclxuXHJcbiAgICAvLyAvLyDlv4XpobvlhYjmiafooYxjb250ZXh055qE5Yid5aeL5YyW77yM54S25ZCO5YaN5Yid5aeL5YyWU3Vic2NyaXB0aW9uXHJcbiAgICAvLyB0aGlzLmluaXRQdWJsaWNFdmVudCgpO1xyXG5cclxuICAgIC8vIHRoaXMuaW5pdFN1YnNjcmlwdGlvbigpO1xyXG5cclxuICAgIC8vIHRoaXMucmVzdENvbXBvbmVudCgpO1xyXG4gIH1cclxuXHJcbiAgbmdPbkluaXQoKTogdm9pZCB7XHJcbiAgICB0aGlzLmluaXRpYWxpemUoKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgaW5pdGlhbGl6ZSgpIHtcclxuICAgIGlmICghdGhpcy5pbml0aWFsaXplZCkge1xyXG4gICAgICB0aGlzLmNvbnRleHQuaW5pdCh0aGlzKTtcclxuICAgICAgdGhpcy52aWV3TW9kZWwgPSB0aGlzLmNvbnRleHQudmlld01vZGVsO1xyXG4gICAgICB0aGlzLmNkID0gdGhpcy5nZXRDaGFuZ2VEZXRlY3RvclJlZigpO1xyXG4gICAgICAvLyDlv4XpobvlhYjmiafooYxjb250ZXh055qE5Yid5aeL5YyW77yM54S25ZCO5YaN5Yid5aeL5YyWU3Vic2NyaXB0aW9uXHJcbiAgICAgIHRoaXMuaW5pdFB1YmxpY0V2ZW50KCk7XHJcbiAgICAgIHRoaXMuaW5pdFN1YnNjcmlwdGlvbigpO1xyXG4gICAgICB0aGlzLnJlc3RDb21wb25lbnQoKTtcclxuICAgICAgdGhpcy5vbkZyYW1lQ29tcG9uZW50SW5pdCgpO1xyXG4gICAgICB0aGlzLmluaXRpYWxpemVkID0gdHJ1ZTtcclxuICAgIH1cclxuICB9XHJcbiAgLyoqXHJcbiAgICog5omn6KGM57uE5Lu25Yid5aeL5YyWXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBvbkZyYW1lQ29tcG9uZW50SW5pdCgpIHtcclxuICAgIGNvbnN0IGZyYW1lQ29tcG9uZW50SW5pdEhhbmRsZXJzID0gdGhpcy5pbmplY3Rvci5nZXQ8b25GcmFtZUNvbXBvbmVudEluaXRbXT4oRlJBTUVfQ09NUE9ORU5UX0lOSVRfSEFORExFUl9UT0tFTiwgbnVsbCk7XHJcbiAgICBpZiAoZnJhbWVDb21wb25lbnRJbml0SGFuZGxlcnMgJiYgQXJyYXkuaXNBcnJheShmcmFtZUNvbXBvbmVudEluaXRIYW5kbGVycykgJiYgZnJhbWVDb21wb25lbnRJbml0SGFuZGxlcnMubGVuZ3RoID4gMCkge1xyXG4gICAgICBmcmFtZUNvbXBvbmVudEluaXRIYW5kbGVycy5mb3JFYWNoKChoYW5kbGVyOiBvbkZyYW1lQ29tcG9uZW50SW5pdCkgPT4ge1xyXG4gICAgICAgIGhhbmRsZXIub25Db21wb25lbnRJbml0KHRoaXMuY29udGV4dCk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH1cclxuICAvKipcclxuICAgKiDojrflj5blj5jmm7Tmo4DmtYvlmajlrp7kvotcclxuICAgKiBAdG9kb++8muW6lOivpemAmui/h+azqOWFpeiOt+WPlu+8jOS9huazqOWFpeS8muW8lei1t+ihqOWNlee8luivkeOAglxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0Q2hhbmdlRGV0ZWN0b3JSZWYoKSB7XHJcblxyXG4gICAgLy8gY29uc3QgY2QgPSB0aGlzLmdldDxDaGFuZ2VEZXRlY3RvclJlZj4oQ2hhbmdlRGV0ZWN0b3JSZWYsIG51bGwsIEluamVjdEZsYWdzLk9wdGlvbmFsKTtcclxuICAgIGNvbnN0IGNkID0gdGhpcy5pbmplY3Rvci5nZXQoQ2hhbmdlRGV0ZWN0b3JSZWYsIG51bGwpO1xyXG4gICAgcmV0dXJuIGNkO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5bCG5b2T5YmN57uE5Lu26ISx56a75Y+Y5pu05qOA5rWL5qCRXHJcbiAgICovXHJcbiAgcHVibGljIGRldGFjaCgpIHtcclxuICAgIGlmICh0aGlzLmlzQ2RWYWxpZCgpID09PSBmYWxzZSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICB0aGlzLmNkLmRldGFjaCgpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5bCG5b2T5YmN57uE5Lu26YeN5paw5Yqg5YWl5Y+Y5pu05qOA5rWL5qCRXHJcbiAgICovXHJcbiAgcHVibGljIHJlYXR0YWNoKCkge1xyXG4gICAgaWYgKHRoaXMuaXNDZFZhbGlkKCkgPT09IGZhbHNlKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIHRoaXMuY2QucmVhdHRhY2goKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWvueW9k+WJjee7hOS7tui/m+ihjOS4gOasoeWPmOabtOajgOafpVxyXG4gICAqL1xyXG4gIHB1YmxpYyBkZXRlY3RDaGFuZ2VzKCkge1xyXG4gICAgaWYgKHRoaXMuaXNDZFZhbGlkKCkgPT09IGZhbHNlKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIHRoaXMuY2QuZGV0ZWN0Q2hhbmdlcygpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5qOA5rWLQ2hhbmdlRGV0ZWN0aW9u5piv5ZCm5pyJ5pWIXHJcbiAgICogQHRvZG86IENhbid0IGJlIGRlcGVuZCBvbiB0aGUgZGVzdHJveWVkIHByb3BlcnR5LCBkZXN0cm95ZWQuXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBpc0NkVmFsaWQoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5jZCAmJiB0aGlzLmNkWydkZXN0cm95ZWQnXSA9PT0gZmFsc2UgfHwgZmFsc2U7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDph43nva7nu4Tku7bnirbmgIFcclxuICAgKiBAdG9kb++8mkFwcENvbnRleHTmmK/lhajlsYDnmoTvvIxcclxuICAgKi9cclxuICBwdWJsaWMgcmVzdENvbXBvbmVudCgpIHtcclxuICAgIGlmICh0aGlzLmNvbnRleHQgIT09IHRoaXMuY29udGV4dC5yb290KSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIC8vIDHjgIHlpoLmnpxBcHBDb250ZXh05LiN5pivcm9vdOW5tuS4lOeItkFwcENvbnRleHTkuZ/kuI3mmK9yb2905LiN5riF55CGO1xyXG4gICAgLy8gMuOAgeihqOWNlU1vZHVsZemHjOazqOWFpeS6hkZBUlJJU19ERVZLSVRfQVBQX1BST1ZJREVSU+mHjOmdouacieS4gOS4quWGl+S9meeahEFwcENvbnRleHTms6jlhaVcclxuICAgIC8vICAgIOWvvOiHtOaJgOaciUFwcENvbnRleHTnmoTmoLnmmK/or6XlhpfkvZnnmoRBcHBDb250ZXh077yM5omA5Lul6KaB5qOA5rWLcGFyZW50LnBhcmVudOOAglxyXG4gICAgLy8g5Y+q5riF55CG5qC557uE5Lu255qEc2Vzc2lvblxyXG4gICAgaWYgKHRoaXMuY29udGV4dC5hcHBDb250ZXh0LnBhcmVudCAhPT0gbnVsbCAmJiB0aGlzLmNvbnRleHQuYXBwQ29udGV4dC5wYXJlbnQucGFyZW50ICE9PSBudWxsKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICAvLyBSZXBvc2l0b3J56KKr5rOo5YaM5Yiw5YWo5bGA5LqG77yM5qih5Z2X5L6d6LWW5rOo5YWl5Lit55qE5a+56LGh77yM5rKh5pyJ6YeN572u5pe25py677yM5Li05pe25Zyo5qC557uE5Lu25Lit6L+b6KGM5rOo6ZSA44CCXHJcbiAgICAvLyBAdG9kb++8muW6lOivpea4heeQhuWFqOmDqHJlcG9zaXRvcnnvvIznm67liY3nvLrlsJHlhajlsYDnrqHnkIbmiYDmnIlSZXBvc2l0b3J555qE5Zyw5pa544CCXHJcbiAgICB0aGlzLmNvbnRleHQucmVwb3NpdG9yeS5yZXNldCgpO1xyXG4gICAgLy8g6YeN572u57uE5Lu257uR5a6a5pWw5o2uXHJcbiAgICB0aGlzLmNvbnRleHQuYmluZGluZ0RhdGEucmVzZXQoKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBuZ09uRGVzdHJveSgpIHtcclxuICAgIGlmICh0aGlzLmNvbnRleHQuaXNSb290RnJhbWVDb250ZXh0KCkgPT09IHRydWUpIHtcclxuICAgICAgdGhpcy5jb250ZXh0LmFwcENvbnRleHQudW5yZWdpc3RlckZyb21NYW5hZ2VyKHRoaXMuY29udGV4dCk7XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5ldmVudFBpcGVzLmZvckVhY2goKGV2ZW50UGlwZTogSURpc3Bvc2FibGUpID0+IHtcclxuICAgICAgKGV2ZW50UGlwZSBhcyBFdmVudFBpcGUpLmRpc3Bvc2VCeUNhbGxlcih0aGlzKTtcclxuICAgIH0pO1xyXG5cclxuICAgIHRoaXMuY29udGV4dC5kZXN0cm95KCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDliJ3lp4vljJbkuovku7borqLpmIVcclxuICAgKi9cclxuICBwcml2YXRlIGluaXRTdWJzY3JpcHRpb24oKSB7XHJcbiAgICB0aGlzLnN1YnNjcmlwdGlvbiA9IHRoaXMuZ2V0U3Vic2NyaXB0aW9uKCk7XHJcbiAgICBpZiAoIXRoaXMuc3Vic2NyaXB0aW9uKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICB0aGlzLmV2ZW50UGlwZXMgPSB0aGlzLnN1YnNjcmlwdGlvbi5pbml0KHRoaXMpO1xyXG4gIH1cclxuXHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPlmNvbXBvbmVudOWvueW6lOeahOiuoumYhVxyXG4gICAqIEByZXR1cm5zIFxyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXRTdWJzY3JpcHRpb24oKSB7XHJcbiAgICByZXR1cm4gdGhpcy5pbmplY3Rvci5nZXQ8U3Vic2NyaXB0aW9uPihTdWJzY3JpcHRpb24sIG51bGwpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBpbml0UHVibGljRXZlbnQoKSB7XHJcblxyXG4gICAgdGhpcy5kZWNsYXJhdGlvbiA9IHRoaXMuZ2V0RGVjbGFyYXRpb24oKTtcclxuICAgIGlmICghdGhpcy5kZWNsYXJhdGlvbikge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5kZWNsYXJhdGlvbi5pbml0KHRoaXMpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6I635Y+W5b2T5YmNY29tcG9uZW505a+55bqU55qEZGVjbGFyYXRpb25cclxuICAgKiBAcmV0dXJucyBcclxuICAgKi9cclxuICBwdWJsaWMgZ2V0RGVjbGFyYXRpb24oKSB7XHJcbiAgICByZXR1cm4gdGhpcy5pbmplY3Rvci5nZXQ8RGVjbGFyYXRpb24+KERlY2xhcmF0aW9uLCBudWxsKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOS6i+S7tuinpuWPkeWZqO+8jOinpuWPkeS6i+S7tuWPkeW4g1xyXG4gICAqIEBwYXJhbSBldmVudE5hbWUg5b6F5Y+R5biD5LqL5Lu2XHJcbiAgICovXHJcbiAgcHVibGljIHRyaWdnZXIoZXZlbnROYW1lOiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IHN1YnNjcmlwdGlvbiA9IHRoaXMuY29udGV4dC5jb21tYW5kQnVzLmV4ZWN1dGluZ0NvbW1hbmRDb3VudCQuc3Vic2NyaWJlKChleGVjdXRpbmdDb21tYW5kQ291bnQ6IG51bWJlcikgPT4ge1xyXG4gICAgICBpZiAoZXhlY3V0aW5nQ29tbWFuZENvdW50ICE9PSAwKSB7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcbiAgICAgIHRoaXMuaW5uZXJUcmlnZ2VyKGV2ZW50TmFtZSk7XHJcblxyXG4gICAgICAvLyBAdG9kb1xyXG4gICAgICAvLyBzdWJzY3JpcHRpb27lrZjlnKjmnKp1bmRlZmluZeeahOaDheWGte+8jOW+hei/m+S4gOatpeaOkuafpeOAglxyXG4gICAgICBpZiAoc3Vic2NyaXB0aW9uKSB7XHJcbiAgICAgICAgc3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgICBpZiAoc3Vic2NyaXB0aW9uKSB7XHJcbiAgICAgICAgICAgIHN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0sIDApO1xyXG4gICAgICB9XHJcblxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDlhoXpg6jop6blj5Hlj5jmm7Tmo4DmtYtcclxuICAgKi9cclxuICBwcml2YXRlIGlubmVyVHJpZ2dlcihldmVudE5hbWU6IHN0cmluZykge1xyXG5cclxuICAgIC8vIOagueaNruS6i+S7tuWQje+8jOafpeaJvuWvueW6lOeahOS6i+S7tuWkhOeQhuWZqFxyXG4gICAgY29uc3QgZXZlbnRIYW5kbGVyOiBhbnkgPSB0aGlzLmRlY2xhcmF0aW9uICYmIHRoaXMuZGVjbGFyYXRpb25bZXZlbnROYW1lXTtcclxuICAgIGlmICghZXZlbnRIYW5kbGVyKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIC8vIOaJp+ihjOS6i+S7tlxyXG4gICAgZXZlbnRIYW5kbGVyKCk7XHJcbiAgfVxyXG5cclxufVxyXG5cclxuZXhwb3J0IHsgRnJhbWVDb21wb25lbnQgfTtcclxuIl19