import { ModifyType } from '../changeset/types';
import { PARENT_PATH, PARENT_CLASS } from './types';
import { Entity } from './entity';
/**
 * 支持动态字段集合的动态实体
 */
export class DynamicEntity extends Entity {
    /**
     * 是否是嵌套的动态实体
     */
    get IsNested() {
        return this[PARENT_CLASS] instanceof DynamicEntity;
    }
    /**
     * @param data JSON数据
     */
    constructor(data) {
        super(data);
        this.loadDynamicData(data);
    }
    loadDynamicData(dynamicData) {
        this.initializeDynamicField(dynamicData);
        // super.loadFields(dynamicData);
    }
    /**
     * 初始化动态数据
     * @param dynamicData 动态数据
     */
    initializeDynamicField(dynamicData) {
        // 遍历动态数据的key，创建动态实体属性。
        Object.keys(dynamicData).forEach(propertyName => {
            const dataField = propertyName;
            if (delete this[propertyName]) {
                if (dynamicData[propertyName] instanceof Object) {
                    const path = this.createPath(propertyName);
                    let dynamicEntity = this.createDynamicEntityFromJsonData(dynamicData[propertyName], path);
                    // this.constructor['__prop__metadata__'] = this.constructor['__prop__metadata__'] || {};
                    // NgObject({
                    //     /** 字段名称 */
                    //     dataField: propertyName,
                    //     /** 原始字段名称 */
                    //     originalDataField: propertyName,
                    //     /** 是否为外键 */
                    //     type: DynamicEntity
                    // })(this, propertyName);
                    Object.defineProperty(this, propertyName, {
                        get: function () {
                            return dynamicEntity;
                        },
                        set: function (value) {
                            const modifyInfo = {
                                path: dynamicEntity[PARENT_PATH],
                                value: value.data,
                                preValue: this[propertyName].data,
                                type: ModifyType.ValueChange
                            };
                            dynamicEntity = this.createDynamicEntityFromJsonData(value, path);
                            this.setChanges(modifyInfo);
                        }
                    });
                }
                else {
                    // this.constructor['__prop__metadata__'] = this.constructor['__prop__metadata__'] || {};
                    // NgField({
                    //     /** 字段名称 */
                    //     dataField: propertyName,
                    //     /** 原始字段名称 */
                    //     originalDataField: propertyName,
                    //     /** 是否为主键 */
                    //     primary: false,
                    //     /** 是否为外键 */
                    //     foreign: false
                    // })(this, propertyName);
                    Object.defineProperty(this, propertyName, {
                        // 定义返回数据方法。
                        get: function () {
                            // 从初始数据返回字段值。
                            return this.data[dataField];
                        },
                        set: function (value) {
                            // 值相同时不触发变更。
                            const oldValue = this.data[dataField];
                            if (oldValue === value) {
                                return;
                            }
                            // 更新元数据数据。
                            this.data[dataField] = value;
                            // 变更集
                            const changes = {
                                type: ModifyType.ValueChange,
                                path: this.createPath(propertyName),
                                value: value,
                                preValue: oldValue
                            };
                            if (this[PARENT_PATH]) {
                                changes.path = this[PARENT_PATH].concat(changes.path);
                            }
                            this.setChanges(changes);
                        }
                    });
                }
            }
        });
    }
    createDynamicEntityFromJsonData(value, parentPath) {
        let instance;
        if (value instanceof DynamicEntity) {
            instance = value;
        }
        else {
            instance = new DynamicEntity(value);
            instance.constructor = DynamicEntity;
        }
        instance[PARENT_CLASS] = this;
        instance[PARENT_PATH] = parentPath;
        instance.onValueChanged.subscribe(changes => {
            if (changes) {
                changes.path = (this[PARENT_PATH] || []).concat(changes.path);
                this.setChanges(changes);
            }
        });
        return instance;
    }
    /**
     * 将变更记录保存至变更集中
     * @param value 变更记录
     * @todo
     * 1、preValue的处理有问题，下级传递上来的变更这样可以，根DyanmicaEntity上的，data已经发生变化，prevalue和value是一样了；
     * 2、当value是下级冒泡上来的，需要根据value去更新当前层级的data，该逻辑不应该放在setChagnes，待修改。
     */
    setChanges(value) {
        const propertyName = value.path[value.path.length - 1];
        const preValue = Object.assign({}, this.data);
        this.newData = Object.assign(this.newData, { [propertyName]: value.value });
        let parentPath = value.path;
        if (value.path.length > 2) {
            parentPath = value.path.slice(0, value.path.length - 2);
        }
        // 统一不使用构造函数（保持和其他位置对Modification的构造一致）
        // const parentModification = new Modification(this.data, value.type, parentPath, preValue);
        const parentModification = {
            path: parentPath,
            value: this.data,
            preValue: preValue,
            type: value.type,
            dynamic: true
        };
        this.valueChanged.next(parentModification);
        this.changeSet.append(value);
    }
    /**
     * toJSON
     */
    toJSON() {
        return this.data;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHluYW1pY19lbnRpdHkuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2RldmtpdC8iLCJzb3VyY2VzIjpbImxpYi9lbnRpdHkvZHluYW1pY19lbnRpdHkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBZ0IsTUFBTSxvQkFBb0IsQ0FBQztBQUM5RCxPQUFPLEVBQUUsV0FBVyxFQUFXLFlBQVksRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUM3RCxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBRWxDOztHQUVHO0FBQ0gsTUFBTSxPQUFPLGFBQWMsU0FBUSxNQUFNO0lBRXZDOztPQUVHO0lBQ0gsSUFBVyxRQUFRO1FBQ2pCLE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxZQUFZLGFBQWEsQ0FBQztJQUNyRCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxZQUFZLElBQVM7UUFDbkIsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ1osSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUM3QixDQUFDO0lBRU0sZUFBZSxDQUFDLFdBQWdCO1FBQ3JDLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUN6QyxpQ0FBaUM7SUFDbkMsQ0FBQztJQUVEOzs7T0FHRztJQUNLLHNCQUFzQixDQUFDLFdBQWdCO1FBQzdDLHVCQUF1QjtRQUN2QixNQUFNLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsRUFBRTtZQUM5QyxNQUFNLFNBQVMsR0FBRyxZQUFZLENBQUM7WUFDL0IsSUFBSSxPQUFPLElBQUksQ0FBQyxZQUFZLENBQUMsRUFBRTtnQkFDN0IsSUFBSSxXQUFXLENBQUMsWUFBWSxDQUFDLFlBQVksTUFBTSxFQUFFO29CQUMvQyxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLFlBQVksQ0FBQyxDQUFDO29CQUMzQyxJQUFJ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QUUsVUFBVTtZQUNoQixLQUFLLEVBQUUsSUFBSSxDQUFDLElBQUk7WUFDaEIsUUFBUSxFQUFFLFFBQVE7WUFDbEIsSUFBSSxFQUFFLEtBQUssQ0FBQyxJQUFJO1lBQ2hCLE9BQU8sRUFBRSxJQUFJO1NBQ2QsQ0FBQztRQUVGLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLENBQUM7UUFDM0MsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDL0IsQ0FBQztJQUVEOztPQUVHO0lBQ0ksTUFBTTtRQUNYLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQztJQUNuQixDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBNb2RpZnlUeXBlLCBNb2RpZmljYXRpb24gfSBmcm9tICcuLi9jaGFuZ2VzZXQvdHlwZXMnO1xyXG5pbXBvcnQgeyBQQVJFTlRfUEFUSCwgRHluYW1pYywgUEFSRU5UX0NMQVNTIH0gZnJvbSAnLi90eXBlcyc7XHJcbmltcG9ydCB7IEVudGl0eSB9IGZyb20gJy4vZW50aXR5JztcclxuXHJcbi8qKlxyXG4gKiDmlK/mjIHliqjmgIHlrZfmrrXpm4blkIjnmoTliqjmgIHlrp7kvZNcclxuICovXHJcbmV4cG9ydCBjbGFzcyBEeW5hbWljRW50aXR5IGV4dGVuZHMgRW50aXR5IGltcGxlbWVudHMgRHluYW1pYyB7XHJcblxyXG4gIC8qKlxyXG4gICAqIOaYr+WQpuaYr+W1jOWll+eahOWKqOaAgeWunuS9k1xyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXQgSXNOZXN0ZWQoKTogYm9vbGVhbiB7XHJcbiAgICByZXR1cm4gdGhpc1tQQVJFTlRfQ0xBU1NdIGluc3RhbmNlb2YgRHluYW1pY0VudGl0eTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEBwYXJhbSBkYXRhIEpTT07mlbDmja5cclxuICAgKi9cclxuICBjb25zdHJ1Y3RvcihkYXRhOiBhbnkpIHtcclxuICAgIHN1cGVyKGRhdGEpO1xyXG4gICAgdGhpcy5sb2FkRHluYW1pY0RhdGEoZGF0YSk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgbG9hZER5bmFtaWNEYXRhKGR5bmFtaWNEYXRhOiBhbnkpIHtcclxuICAgIHRoaXMuaW5pdGlhbGl6ZUR5bmFtaWNGaWVsZChkeW5hbWljRGF0YSk7XHJcbiAgICAvLyBzdXBlci5sb2FkRmllbGRzKGR5bmFtaWNEYXRhKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWIneWni+WMluWKqOaAgeaVsOaNrlxyXG4gICAqIEBwYXJhbSBkeW5hbWljRGF0YSDliqjmgIHmlbDmja5cclxuICAgKi9cclxuICBwcml2YXRlIGluaXRpYWxpemVEeW5hbWljRmllbGQoZHluYW1pY0RhdGE6IGFueSk6IHZvaWQge1xyXG4gICAgLy8g6YGN5Y6G5Yqo5oCB5pWw5o2u55qEa2V577yM5Yib5bu65Yqo5oCB5a6e5L2T5bGe5oCn44CCXHJcbiAgICBPYmplY3Qua2V5cyhkeW5hbWljRGF0YSkuZm9yRWFjaChwcm9wZXJ0eU5hbWUgPT4ge1xyXG4gICAgICBjb25zdCBkYXRhRmllbGQgPSBwcm9wZXJ0eU5hbWU7XHJcbiAgICAgIGlmIChkZWxldGUgdGhpc1twcm9wZXJ0eU5hbWVdKSB7XHJcbiAgICAgICAgaWYgKGR5bmFtaWNEYXRhW3Byb3BlcnR5TmFtZV0gaW5zdGFuY2VvZiBPYmplY3QpIHtcclxuICAgICAgICAgIGNvbnN0IHBhdGggPSB0aGlzLmNyZWF0ZVBhdGgocHJvcGVydHlOYW1lKTtcclxuICAgICAgICAgIGxldCBkeW5hbWljRW50aXR5ID0gdGhpcy5jcmVhdGVEeW5hbWljRW50aXR5RnJvbUpzb25EYXRhKGR5bmFtaWNEYXRhW3Byb3BlcnR5TmFtZV0sIHBhdGgpO1xyXG4gICAgICAgICAgLy8gdGhpcy5jb25zdHJ1Y3RvclsnX19wcm9wX19tZXRhZGF0YV9fJ10gPSB0aGlzLmNvbnN0cnVjdG9yWydfX3Byb3BfX21ldGFkYXRhX18nXSB8fCB7fTtcclxuICAgICAgICAgIC8vIE5nT2JqZWN0KHtcclxuICAgICAgICAgIC8vICAgICAvKiog5a2X5q615ZCN56ewICovXHJcbiAgICAgICAgICAvLyAgICAgZGF0YUZpZWxkOiBwcm9wZXJ0eU5hbWUsXHJcbiAgICAgICAgICAvLyAgICAgLyoqIOWOn+Wni+Wtl+auteWQjeensCAqL1xyXG4gICAgICAgICAgLy8gICAgIG9yaWdpbmFsRGF0YUZpZWxkOiBwcm9wZXJ0eU5hbWUsXHJcbiAgICAgICAgICAvLyAgICAgLyoqIOaYr+WQpuS4uuWklumUriAqL1xyXG4gICAgICAgICAgLy8gICAgIHR5cGU6IER5bmFtaWNFbnRpdHlcclxuICAgICAgICAgIC8vIH0pKHRoaXMsIHByb3BlcnR5TmFtZSk7XHJcbiAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgcHJvcGVydHlOYW1lLCB7XHJcbiAgICAgICAgICAgIGdldDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgIHJldHVybiBkeW5hbWljRW50aXR5O1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkge1xyXG4gICAgICAgICAgICAgIGNvbnN0IG1vZGlmeUluZm8gPSB7XHJcbiAgICAgICAgICAgICAgICBwYXRoOiBkeW5hbWljRW50aXR5W1BBUkVOVF9QQVRIXSxcclxuICAgICAgICAgICAgICAgIHZhbHVlOiB2YWx1ZS5kYXRhLFxyXG4gICAgICAgICAgICAgICAgcHJlVmFsdWU6IHRoaXNbcHJvcGVydHlOYW1lXS5kYXRhLFxyXG4gICAgICAgICAgICAgICAgdHlwZTogTW9kaWZ5VHlwZS5WYWx1ZUNoYW5nZVxyXG4gICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgZHluYW1pY0VudGl0eSA9IHRoaXMuY3JlYXRlRHluYW1pY0VudGl0eUZyb21Kc29uRGF0YSh2YWx1ZSwgcGF0aCk7XHJcbiAgICAgICAgICAgICAgdGhpcy5zZXRDaGFuZ2VzKG1vZGlmeUluZm8pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgLy8gdGhpcy5jb25zdHJ1Y3RvclsnX19wcm9wX19tZXRhZGF0YV9fJ10gPSB0aGlzLmNvbnN0cnVjdG9yWydfX3Byb3BfX21ldGFkYXRhX18nXSB8fCB7fTtcclxuICAgICAgICAgIC8vIE5nRmllbGQoe1xyXG4gICAgICAgICAgLy8gICAgIC8qKiDlrZfmrrXlkI3np7AgKi9cclxuICAgICAgICAgIC8vICAgICBkYXRhRmllbGQ6IHByb3BlcnR5TmFtZSxcclxuICAgICAgICAgIC8vICAgICAvKiog5Y6f5aeL5a2X5q615ZCN56ewICovXHJcbiAgICAgICAgICAvLyAgICAgb3JpZ2luYWxEYXRhRmllbGQ6IHByb3BlcnR5TmFtZSxcclxuICAgICAgICAgIC8vICAgICAvKiog5piv5ZCm5Li65Li76ZSuICovXHJcbiAgICAgICAgICAvLyAgICAgcHJpbWFyeTogZmFsc2UsXHJcbiAgICAgICAgICAvLyAgICAgLyoqIOaYr+WQpuS4uuWklumUriAqL1xyXG4gICAgICAgICAgLy8gICAgIGZvcmVpZ246IGZhbHNlXHJcbiAgICAgICAgICAvLyB9KSh0aGlzLCBwcm9wZXJ0eU5hbWUpO1xyXG4gICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsIHByb3BlcnR5TmFtZSwge1xyXG4gICAgICAgICAgICAvLyDlrprkuYnov5Tlm57mlbDmja7mlrnms5XjgIJcclxuICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgLy8g5LuO5Yid5aeL5pWw5o2u6L+U5Zue5a2X5q615YC844CCXHJcbiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZGF0YVtkYXRhRmllbGRdO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkge1xyXG4gICAgICAgICAgICAgIC8vIOWAvOebuOWQjOaXtuS4jeinpuWPkeWPmOabtOOAglxyXG4gICAgICAgICAgICAgIGNvbnN0IG9sZFZhbHVlID0gdGhpcy5kYXRhW2RhdGFGaWVsZF07XHJcbiAgICAgICAgICAgICAgaWYgKG9sZFZhbHVlID09PSB2YWx1ZSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAvLyDmm7TmlrDlhYPmlbDmja7mlbDmja7jgIJcclxuICAgICAgICAgICAgICB0aGlzLmRhdGFbZGF0YUZpZWxkXSA9IHZhbHVlO1xyXG4gICAgICAgICAgICAgIC8vIOWPmOabtOmbhlxyXG4gICAgICAgICAgICAgIGNvbnN0IGNoYW5nZXMgPSB7XHJcbiAgICAgICAgICAgICAgICB0eXBlOiBNb2RpZnlUeXBlLlZhbHVlQ2hhbmdlLFxyXG4gICAgICAgICAgICAgICAgcGF0aDogdGhpcy5jcmVhdGVQYXRoKHByb3BlcnR5TmFtZSksXHJcbiAgICAgICAgICAgICAgICB2YWx1ZTogdmFsdWUsXHJcbiAgICAgICAgICAgICAgICBwcmVWYWx1ZTogb2xkVmFsdWVcclxuICAgICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgICBpZiAodGhpc1tQQVJFTlRfUEFUSF0pIHtcclxuICAgICAgICAgICAgICAgIGNoYW5nZXMucGF0aCA9IHRoaXNbUEFSRU5UX1BBVEhdLmNvbmNhdChjaGFuZ2VzLnBhdGgpO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICB0aGlzLnNldENoYW5nZXMoY2hhbmdlcyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGNyZWF0ZUR5bmFtaWNFbnRpdHlGcm9tSnNvbkRhdGEodmFsdWU6IGFueSwgcGFyZW50UGF0aDogc3RyaW5nW10pIHtcclxuICAgIGxldCBpbnN0YW5jZTogRHluYW1pY0VudGl0eTtcclxuICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIER5bmFtaWNFbnRpdHkpIHtcclxuICAgICAgaW5zdGFuY2UgPSB2YWx1ZTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGluc3RhbmNlID0gbmV3IER5bmFtaWNFbnRpdHkodmFsdWUpO1xyXG4gICAgICBpbnN0YW5jZS5jb25zdHJ1Y3RvciA9IER5bmFtaWNFbnRpdHk7XHJcbiAgICB9XHJcbiAgICBpbnN0YW5jZVtQQVJFTlRfQ0xBU1NdID0gdGhpcztcclxuICAgIGluc3RhbmNlW1BBUkVOVF9QQVRIXSA9IHBhcmVudFBhdGg7XHJcbiAgICBpbnN0YW5jZS5vblZhbHVlQ2hhbmdlZC5zdWJzY3JpYmUoY2hhbmdlcyA9PiB7XHJcbiAgICAgIGlmIChjaGFuZ2VzKSB7XHJcbiAgICAgICAgY2hhbmdlcy5wYXRoID0gKHRoaXNbUEFSRU5UX1BBVEhdIHx8IFtdKS5jb25jYXQoY2hhbmdlcy5wYXRoKTtcclxuICAgICAgICB0aGlzLnNldENoYW5nZXMoY2hhbmdlcyk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG5cclxuICAgIHJldHVybiBpbnN0YW5jZTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWwhuWPmOabtOiusOW9leS/neWtmOiHs+WPmOabtOmbhuS4rVxyXG4gICAqIEBwYXJhbSB2YWx1ZSDlj5jmm7TorrDlvZVcclxuICAgKiBAdG9kb1xyXG4gICAqIDHjgIFwcmVWYWx1ZeeahOWkhOeQhuaciemXrumimO+8jOS4i+e6p+S8oOmAkuS4iuadpeeahOWPmOabtOi/meagt+WPr+S7pe+8jOaguUR5YW5taWNhRW50aXR55LiK55qE77yMZGF0YeW3sue7j+WPkeeUn+WPmOWMlu+8jHByZXZhbHVl5ZKMdmFsdWXmmK/kuIDmoLfkuobvvJtcclxuICAgKiAy44CB5b2TdmFsdWXmmK/kuIvnuqflhpLms6HkuIrmnaXnmoTvvIzpnIDopoHmoLnmja52YWx1ZeWOu+abtOaWsOW9k+WJjeWxgue6p+eahGRhdGHvvIzor6XpgLvovpHkuI3lupTor6XmlL7lnKhzZXRDaGFnbmVz77yM5b6F5L+u5pS544CCXHJcbiAgICovXHJcbiAgc2V0Q2hhbmdlcyh2YWx1ZTogTW9kaWZpY2F0aW9uKTogdm9pZCB7XHJcbiAgICBjb25zdCBwcm9wZXJ0eU5hbWUgPSB2YWx1ZS5wYXRoW3ZhbHVlLnBhdGgubGVuZ3RoIC0gMV07XHJcbiAgICBjb25zdCBwcmVWYWx1ZSA9IE9iamVjdC5hc3NpZ24oe30sIHRoaXMuZGF0YSk7XHJcbiAgICB0aGlzLm5ld0RhdGEgPSBPYmplY3QuYXNzaWduKHRoaXMubmV3RGF0YSwgeyBbcHJvcGVydHlOYW1lXTogdmFsdWUudmFsdWUgfSk7XHJcbiAgICBsZXQgcGFyZW50UGF0aCA9IHZhbHVlLnBhdGg7XHJcbiAgICBpZiAodmFsdWUucGF0aC5sZW5ndGggPiAyKSB7XHJcbiAgICAgIHBhcmVudFBhdGggPSB2YWx1ZS5wYXRoLnNsaWNlKDAsIHZhbHVlLnBhdGgubGVuZ3RoIC0gMik7XHJcbiAgICB9XHJcblxyXG4gICAgLy8g57uf5LiA5LiN5L2/55So5p6E6YCg5Ye95pWw77yI5L+d5oyB5ZKM5YW25LuW5L2N572u5a+5TW9kaWZpY2F0aW9u55qE5p6E6YCg5LiA6Ie077yJXHJcbiAgICAvLyBjb25zdCBwYXJlbnRNb2RpZmljYXRpb24gPSBuZXcgTW9kaWZpY2F0aW9uKHRoaXMuZGF0YSwgdmFsdWUudHlwZSwgcGFyZW50UGF0aCwgcHJlVmFsdWUpO1xyXG4gICAgY29uc3QgcGFyZW50TW9kaWZpY2F0aW9uOiBNb2RpZmljYXRpb24gPSB7XHJcbiAgICAgIHBhdGg6IHBhcmVudFBhdGgsXHJcbiAgICAgIHZhbHVlOiB0aGlzLmRhdGEsXHJcbiAgICAgIHByZVZhbHVlOiBwcmVWYWx1ZSxcclxuICAgICAgdHlwZTogdmFsdWUudHlwZSxcclxuICAgICAgZHluYW1pYzogdHJ1ZVxyXG4gICAgfTtcclxuXHJcbiAgICB0aGlzLnZhbHVlQ2hhbmdlZC5uZXh0KHBhcmVudE1vZGlmaWNhdGlvbik7XHJcbiAgICB0aGlzLmNoYW5nZVNldC5hcHBlbmQodmFsdWUpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogdG9KU09OXHJcbiAgICovXHJcbiAgcHVibGljIHRvSlNPTigpIHtcclxuICAgIHJldHVybiB0aGlzLmRhdGE7XHJcbiAgfVxyXG59XHJcbiJdfQ==