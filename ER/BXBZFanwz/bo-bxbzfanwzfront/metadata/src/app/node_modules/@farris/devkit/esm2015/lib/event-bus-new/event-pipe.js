import { Subject } from 'rxjs';
import { EventTypeEnum } from '../event-mechanism';
import { EventPipeType } from './event-pipe-type';
export class EventPipe {
    constructor(name, tokenValue, emitter, parentEventPipeList) {
        this.name = name;
        this.tokenValue = tokenValue;
        this.emitter = emitter;
        this.parentEventPipeList = parentEventPipeList;
        this.lastEventId = -1;
        /**
         * EventPipe类型，编译类型表单检查是否在同一上下文中，解析类型表单不判断
         */
        this.eventPipeType = EventPipeType.Compile;
        this.eventSubject = new Subject();
        this.subscriptionMap = new Map();
        this.onceSubscriptionMap = new Map();
        if (this.parentEventPipeList) {
            this.parentEventPipeList.push(this);
        }
    }
    /**
     * 发送事件
     */
    post(args, sender, eventType, eventId) {
        const eventData = {
            args: args,
            sender: sender,
            eventType,
            eventId
        };
        this.eventSubject.next(eventData);
    }
    /**
     * 订阅事件
     */
    subscribe(eventHandler, receiver) {
        // 对于弹窗，caller是弹窗中的组件，每次caller不同，但还是会重复注册。
        // 重复订阅检测
        const subscriptionInMap = this.subscriptionMap.get(receiver);
        if (subscriptionInMap != null) {
            subscriptionInMap.unsubscribe();
            this.subscriptionMap.delete(receiver);
        }
        const subscription = this.eventSubject.subscribe((eventData) => {
            const args = eventData.args;
            const sender = eventData.sender;
            const eventType = eventData.eventType || null;
            const eventId = eventData.eventId || 0;
            if (this.lastEventId >= eventId) {
                return;
            }
            this.lastEventId = eventId;
            // 判断sender和receiver的关系，如果在同一个AppContext或者在在一棵树上，则处理
            // 该判断主要解决SPA模式下，一个页面被打开多次的场景。
            if (!(eventType === EventTypeEnum.ROUTE)) {
                if (this.isInSampeScope(sender, receiver) === false) {
                    return;
                }
            }
            eventHandler.call(receiver, args);
        });
        this.subscriptionMap.set(receiver, subscription);
        return this;
    }
    subscribeOnce(eventHandler, caller) {
        const subscription = this.eventSubject.subscribe((value) => eventHandler.call(caller, value));
        this.onceSubscriptionMap.set(caller, subscription);
        return this;
    }
    unSubscribe(subscriber) {
        let subscription = this.subscriptionMap.get(subscriber);
        if (subscription) {
            subscription.unsubscribe();
            subscription = null;
            this.subscriptionMap.delete(subscriber);
        }
        else {
            subscription = this.onceSubscriptionMap.get(subscriber);
            if (subscription) {
                subscription.unsubscribe();
                subscription = null;
                this.onceSubscriptionMap.delete(subscriber);
            }
        }
    }
    // 注销使用once方法注册的订阅。
    unSubscribeForOnce() {
        for (const subscriber of Array.from(this.onceSubscriptionMap.keys())) {
            this.unSubscribe(subscriber);
        }
    }
    matchEmitterToken(emitter, tokenValue) {
        if (this.emitter && emitter && this.emitter !== emitter) {
            return false;
        }
        if (this.tokenValue && tokenValue && this.tokenValue !== tokenValue) {
            return false;
        }
        return true;
    }
    examByTargetToken(target, tokenValue) {
        if (this.emitter !== target) {
            return false;
        }
        if (this.tokenValue !== tokenValue) {
            return false;
        }
        return true;
    }
    dispose(subscriber) {
        this.unSubscribe(subscriber);
        if (this.subscriptionMap.size === 0 && this.parentEventPipeList) {
            const location = this.parentEventPipeList.findIndex(item => item === this);
            if (location !== -1) {
                this.parentEventPipeList.splice(location, 1);
            }
        }
    }
    /**
     * 根据caller进行注销
     */
    disposeByCaller(caller) {
        const subscriptionInMap = this.subscriptionMap.get(caller);
        if (subscriptionInMap != null) {
            subscriptionInMap.unsubscribe();
            this.subscriptionMap.delete(caller);
        }
    }
    /**
     * 检查是否在同一个上下文中
     * @todo
     * 1、强识别了sender和receiver的结构来判断，不合理；
     * 2、应该声明一个接口来约束结构。
     */
    isInSampeScope(sender, receiver) {
        // 用来区分编译类型的表单，还是解析类型的表单
        if (this.eventPipeType === EventPipeType.Parsing) {
            return true;
        }
        // 兼容老代码，sender不存在时，不进行检测
        if (!sender) {
            return true;
        }
        // 异常处理场景
        if (sender === receiver) {
            return true;
        }
        // 判断是否是FrameContext
        if (!sender.context || !sender.context.appContext ||
            !receiver.context || !receiver.context.appContext) {
            return false;
        }
        const senderAppContext = sender.context.appContext;
        const receiverAppContext = receiver.context.appContext;
        // 情况1：现状
        // 对于老表单，在模块上注入了一个AppContext；
        // 组合表单中主表单的root-component（被组合的表单的root-componetn上没有注入）上注入了AppContext
        // SPA模式下，如法通过Root AppContext区分，是不是同一个菜单内的事件；
        // 只能判断根组件上的AppContext来判断
        // 判断根AppContext是否一致
        if (senderAppContext === receiverAppContext) {
            return true;
        }
        // 情况2：注入改造后
        // 如果以后注入关系改造了，模块上的AppContext移除掉
        // 组合表单中每个root-component都拥有一个AppContext;
        // 组合表单中主表单的root-component的AppContext为Root AppContext
        // if (senderAppContext.root === receiverAppContext.root) {
        //   return true;
        // }
        // 情况3：注入改造后老表单兼容
        // 如果以后注入关系改造了，但产品部没有重新编译;
        // 和情况2类似，不同的是模块上还遗留了一个AppContext；
        // 此时Root Appcontext还是模块上的，如何来判断？
        // 1、考虑通过sender的injector一直网上找，找到模块之前的那个组件injector，从其中拿AppContext来判断；
        // 2、找一个全部重新编译的时机再改造。
        if ((senderAppContext.useIsoluteEventBus && senderAppContext.isoluteEventBus) ||
            (receiverAppContext.useIsoluteEventBus && receiverAppContext.isoluteEventBus)) {
            // 如果存在独立加载js  那么
            return true;
        }
        return false;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXZlbnQtcGlwZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL2V2ZW50LWJ1cy1uZXcvZXZlbnQtcGlwZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsT0FBTyxFQUFnQixNQUFNLE1BQU0sQ0FBQztBQUU3QyxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDbkQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBRWxELE1BQU0sT0FBTyxTQUFTO0lBd0JwQixZQUNVLElBQVksRUFDWixVQUFrQixFQUNsQixPQUFlLEVBQ2YsbUJBQXFDO1FBSHJDLFNBQUksR0FBSixJQUFJLENBQVE7UUFDWixlQUFVLEdBQVYsVUFBVSxDQUFRO1FBQ2xCLFlBQU8sR0FBUCxPQUFPLENBQVE7UUFDZix3QkFBbUIsR0FBbkIsbUJBQW1CLENBQWtCO1FBM0J2QyxnQkFBVyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBa0J6Qjs7V0FFRztRQUNJLGtCQUFhLEdBQUcsYUFBYSxDQUFDLE9BQU8sQ0FBQztRQVEzQyxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksT0FBTyxFQUFPLENBQUM7UUFDdkMsSUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFJLEdBQUcsRUFBd0IsQ0FBQztRQUN2RCxJQUFJLENBQUMsbUJBQW1CLEdBQUcsSUFBSSxHQUFHLEVBQXdCLENBQUM7UUFDM0QsSUFBSSxJQUFJLENBQUMsbUJBQW1CLEVBQUU7WUFDNUIsSUFBSSxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUNyQztJQUNILENBQUM7SUFFRDs7T0FFRztJQUNILElBQUksQ0FBQyxJQUFTLEVBQUUsTUFBWSxFQUFFLFNBQWUsRUFBRSxPQUFnQjtRQUM3RCxNQUFNLFNBQVMsR0FBRztZQUNoQixJQUFJLEVBQUUsSUFBSTtZQUNWLE1BQU0sRUFBRSxNQUFNO1lB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QUNiO1FBRUQsWUFBWTtRQUNaLGdDQUFnQztRQUNoQyx3Q0FBd0M7UUFDeEMscURBQXFEO1FBQ3JELDJEQUEyRDtRQUMzRCxpQkFBaUI7UUFDakIsSUFBSTtRQUVKLGlCQUFpQjtRQUNqQiwwQkFBMEI7UUFDMUIsa0NBQWtDO1FBQ2xDLGlDQUFpQztRQUNqQyxvRUFBb0U7UUFDcEUscUJBQXFCO1FBRXJCLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxrQkFBa0IsSUFBSSxnQkFBZ0IsQ0FBQyxlQUFlLENBQUM7WUFDM0UsQ0FBQyxrQkFBa0IsQ0FBQyxrQkFBa0IsSUFBSSxrQkFBa0IsQ0FBQyxlQUFlLENBQUMsRUFBRTtZQUMvRSxpQkFBaUI7WUFDakIsT0FBTyxJQUFJLENBQUM7U0FDYjtRQUNELE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU3ViamVjdCwgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IElEaXNwb3NhYmxlIH0gZnJvbSAnLi90eXBlcyc7XHJcbmltcG9ydCB7IEV2ZW50VHlwZUVudW0gfSBmcm9tICcuLi9ldmVudC1tZWNoYW5pc20nO1xyXG5pbXBvcnQgeyBFdmVudFBpcGVUeXBlIH0gZnJvbSAnLi9ldmVudC1waXBlLXR5cGUnO1xyXG5cclxuZXhwb3J0IGNsYXNzIEV2ZW50UGlwZSBpbXBsZW1lbnRzIElEaXNwb3NhYmxlIHtcclxuICBwcml2YXRlIGxhc3RFdmVudElkID0gLTE7XHJcbiAgLyoqXHJcbiAgICog5LqL5Lu25a+56LGhXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBldmVudFN1YmplY3Q6IFN1YmplY3Q8YW55PjtcclxuXHJcbiAgLyoqXHJcbiAgICog6K6i6ZiF5a+56LGhTWFwXHJcbiAgICoga2V5PeiuoumYheaJgOWcqOeahEZyYW1lQ29tcG9uZW50XHJcbiAgICogdmFsdWXvvJrorqLpmIVldmV0blN1YmplY3TkuqfnlJ/nmoRTdWJzY3JpcHRpb27lr7nosaHvvIhyeGpz55qE77yJXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBzdWJzY3JpcHRpb25NYXA6IE1hcDxvYmplY3QsIFN1YnNjcmlwdGlvbj47XHJcblxyXG4gIC8qKlxyXG4gICAqIFxyXG4gICAqL1xyXG4gIHByaXZhdGUgb25jZVN1YnNjcmlwdGlvbk1hcDogTWFwPG9iamVjdCwgU3Vic2NyaXB0aW9uPjtcclxuXHJcbiAgLyoqXHJcbiAgICogRXZlbnRQaXBl57G75Z6L77yM57yW6K+R57G75Z6L6KGo5Y2V5qOA5p+l5piv5ZCm5Zyo5ZCM5LiA5LiK5LiL5paH5Lit77yM6Kej5p6Q57G75Z6L6KGo5Y2V5LiN5Yik5patXHJcbiAgICovXHJcbiAgcHVibGljIGV2ZW50UGlwZVR5cGUgPSBFdmVudFBpcGVUeXBlLkNvbXBpbGU7IFxyXG5cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHByaXZhdGUgbmFtZTogc3RyaW5nLFxyXG4gICAgcHJpdmF0ZSB0b2tlblZhbHVlOiBzdHJpbmcsXHJcbiAgICBwcml2YXRlIGVtaXR0ZXI6IHN0cmluZyxcclxuICAgIHByaXZhdGUgcGFyZW50RXZlbnRQaXBlTGlzdDogQXJyYXk8RXZlbnRQaXBlPlxyXG4gICkge1xyXG4gICAgdGhpcy5ldmVudFN1YmplY3QgPSBuZXcgU3ViamVjdDxhbnk+KCk7XHJcbiAgICB0aGlzLnN1YnNjcmlwdGlvbk1hcCA9IG5ldyBNYXA8b2JqZWN0LCBTdWJzY3JpcHRpb24+KCk7XHJcbiAgICB0aGlzLm9uY2VTdWJzY3JpcHRpb25NYXAgPSBuZXcgTWFwPG9iamVjdCwgU3Vic2NyaXB0aW9uPigpO1xyXG4gICAgaWYgKHRoaXMucGFyZW50RXZlbnRQaXBlTGlzdCkge1xyXG4gICAgICB0aGlzLnBhcmVudEV2ZW50UGlwZUxpc3QucHVzaCh0aGlzKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWPkemAgeS6i+S7tlxyXG4gICAqL1xyXG4gIHBvc3QoYXJnczogYW55LCBzZW5kZXI/OiBhbnksIGV2ZW50VHlwZT86IGFueSwgZXZlbnRJZD86IG51bWJlcikge1xyXG4gICAgY29uc3QgZXZlbnREYXRhID0ge1xyXG4gICAgICBhcmdzOiBhcmdzLFxyXG4gICAgICBzZW5kZXI6IHNlbmRlcixcclxuICAgICAgZXZlbnRUeXBlLFxyXG4gICAgICBldmVudElkXHJcbiAgICB9O1xyXG4gICAgdGhpcy5ldmVudFN1YmplY3QubmV4dChldmVudERhdGEpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6K6i6ZiF5LqL5Lu2XHJcbiAgICovXHJcbiAgc3Vic2NyaWJlKGV2ZW50SGFuZGxlcjogKHZhbHVlOiBhbnkpID0+IHZvaWQsIHJlY2VpdmVyOiBvYmplY3QpOiBJRGlzcG9zYWJsZSB7XHJcblxyXG4gICAgLy8g5a+55LqO5by556qX77yMY2FsbGVy5piv5by556qX5Lit55qE57uE5Lu277yM5q+P5qyhY2FsbGVy5LiN5ZCM77yM5L2G6L+Y5piv5Lya6YeN5aSN5rOo5YaM44CCXHJcbiAgICAvLyDph43lpI3orqLpmIXmo4DmtYtcclxuICAgIGNvbnN0IHN1YnNjcmlwdGlvbkluTWFwID0gdGhpcy5zdWJzY3JpcHRpb25NYXAuZ2V0KHJlY2VpdmVyKTtcclxuICAgIGlmIChzdWJzY3JpcHRpb25Jbk1hcCAhPSBudWxsKSB7XHJcbiAgICAgIHN1YnNjcmlwdGlvbkluTWFwLnVuc3Vic2NyaWJlKCk7XHJcbiAgICAgIHRoaXMuc3Vic2NyaXB0aW9uTWFwLmRlbGV0ZShyZWNlaXZlcik7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3Qgc3Vic2NyaXB0aW9uID0gdGhpcy5ldmVudFN1YmplY3Quc3Vic2NyaWJlKChldmVudERhdGE6IGFueSkgPT4ge1xyXG4gICAgICBjb25zdCBhcmdzID0gZXZlbnREYXRhLmFyZ3M7XHJcbiAgICAgIGNvbnN0IHNlbmRlciA9IGV2ZW50RGF0YS5zZW5kZXI7XHJcbiAgICAgIGNvbnN0IGV2ZW50VHlwZSA9IGV2ZW50RGF0YS5ldmVudFR5cGUgfHwgbnVsbDtcclxuICAgICAgY29uc3QgZXZlbnRJZCA9IGV2ZW50RGF0YS5ldmVudElkIHx8IDA7XHJcbiAgICAgIGlmICh0aGlzLmxhc3RFdmVudElkID49IGV2ZW50SWQpIHtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuICAgICAgdGhpcy5sYXN0RXZlbnRJZCA9IGV2ZW50SWQ7XHJcbiAgICAgIC8vIOWIpOaWrXNlbmRlcuWSjHJlY2VpdmVy55qE5YWz57O777yM5aaC5p6c5Zyo5ZCM5LiA5LiqQXBwQ29udGV4dOaIluiAheWcqOWcqOS4gOajteagkeS4iu+8jOWImeWkhOeQhlxyXG4gICAgICAvLyDor6XliKTmlq3kuLvopoHop6PlhrNTUEHmqKHlvI/kuIvvvIzkuIDkuKrpobXpnaLooqvmiZPlvIDlpJrmrKHnmoTlnLrmma/jgIJcclxuICAgICAgaWYgKCEoZXZlbnRUeXBlID09PSBFdmVudFR5cGVFbnVtLlJPVVRFKSkge1xyXG4gICAgICAgIGlmICh0aGlzLmlzSW5TYW1wZVNjb3BlKHNlbmRlciwgcmVjZWl2ZXIpID09PSBmYWxzZSkge1xyXG4gICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgICBldmVudEhhbmRsZXIuY2FsbChyZWNlaXZlciwgYXJncyk7XHJcbiAgICB9KTtcclxuXHJcbiAgICB0aGlzLnN1YnNjcmlwdGlvbk1hcC5zZXQoXHJcbiAgICAgIHJlY2VpdmVyLFxyXG4gICAgICBzdWJzY3JpcHRpb25cclxuICAgICk7XHJcbiAgICByZXR1cm4gdGhpcztcclxuICB9XHJcblxyXG4gIHN1YnNjcmliZU9uY2UoZXZlbnRIYW5kbGVyOiAodmFsdWU6IGFueSkgPT4gdm9pZCwgY2FsbGVyOiBvYmplY3QpOiBJRGlzcG9zYWJsZSB7XHJcbiAgICBjb25zdCBzdWJzY3JpcHRpb24gPSB0aGlzLmV2ZW50U3ViamVjdC5zdWJzY3JpYmUoKHZhbHVlKSA9PiBldmVudEhhbmRsZXIuY2FsbChjYWxsZXIsIHZhbHVlKSk7XHJcbiAgICB0aGlzLm9uY2VTdWJzY3JpcHRpb25NYXAuc2V0KFxyXG4gICAgICBjYWxsZXIsXHJcbiAgICAgIHN1YnNjcmlwdGlvblxyXG4gICAgKTtcclxuICAgIHJldHVybiB0aGlzO1xyXG4gIH1cclxuXHJcbiAgdW5TdWJzY3JpYmUoc3Vic2NyaWJlcjogb2JqZWN0KSB7XHJcbiAgICBsZXQgc3Vic2NyaXB0aW9uID0gdGhpcy5zdWJzY3JpcHRpb25NYXAuZ2V0KHN1YnNjcmliZXIpO1xyXG4gICAgaWYgKHN1YnNjcmlwdGlvbikge1xyXG4gICAgICBzdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcclxuICAgICAgc3Vic2NyaXB0aW9uID0gbnVsbDtcclxuICAgICAgdGhpcy5zdWJzY3JpcHRpb25NYXAuZGVsZXRlKHN1YnNjcmliZXIpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgc3Vic2NyaXB0aW9uID0gdGhpcy5vbmNlU3Vic2NyaXB0aW9uTWFwLmdldChzdWJzY3JpYmVyKTtcclxuICAgICAgaWYgKHN1YnNjcmlwdGlvbikge1xyXG4gICAgICAgIHN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xyXG4gICAgICAgIHN1YnNjcmlwdGlvbiA9IG51bGw7XHJcbiAgICAgICAgdGhpcy5vbmNlU3Vic2NyaXB0aW9uTWFwLmRlbGV0ZShzdWJzY3JpYmVyKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy8g5rOo6ZSA5L2/55Sob25jZeaWueazleazqOWGjOeahOiuoumYheOAglxyXG4gIHVuU3Vic2NyaWJlRm9yT25jZSgpIHtcclxuICAgIGZvciAoY29uc3Qgc3Vic2NyaWJlciBvZiBBcnJheS5mcm9tKHRoaXMub25jZVN1YnNjcmlwdGlvbk1hcC5rZXlzKCkpKSB7XHJcbiAgICAgIHRoaXMudW5TdWJzY3JpYmUoc3Vic2NyaWJlcik7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBtYXRjaEVtaXR0ZXJUb2tlbihlbWl0dGVyOiBzdHJpbmcsIHRva2VuVmFsdWU6IHN0cmluZyk6IGJvb2xlYW4ge1xyXG4gICAgaWYgKHRoaXMuZW1pdHRlciAmJiBlbWl0dGVyICYmIHRoaXMuZW1pdHRlciAhPT0gZW1pdHRlcikge1xyXG4gICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcbiAgICBpZiAodGhpcy50b2tlblZhbHVlICYmIHRva2VuVmFsdWUgJiYgdGhpcy50b2tlblZhbHVlICE9PSB0b2tlblZhbHVlKSB7XHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuICAgIHJldHVybiB0cnVlO1xyXG4gIH1cclxuXHJcbiAgZXhhbUJ5VGFyZ2V0VG9rZW4odGFyZ2V0OiBzdHJpbmcsIHRva2VuVmFsdWU6IHN0cmluZyk6IGJvb2xlYW4ge1xyXG4gICAgaWYgKHRoaXMuZW1pdHRlciAhPT0gdGFyZ2V0KSB7XHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuICAgIGlmICh0aGlzLnRva2VuVmFsdWUgIT09IHRva2VuVmFsdWUpIHtcclxuICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHRydWU7XHJcbiAgfVxyXG5cclxuICBkaXNwb3NlKHN1YnNjcmliZXI6IG9iamVjdCk6IHZvaWQge1xyXG4gICAgdGhpcy51blN1YnNjcmliZShzdWJzY3JpYmVyKTtcclxuICAgIGlmICh0aGlzLnN1YnNjcmlwdGlvbk1hcC5zaXplID09PSAwICYmIHRoaXMucGFyZW50RXZlbnRQaXBlTGlzdCkge1xyXG4gICAgICBjb25zdCBsb2NhdGlvbiA9IHRoaXMucGFyZW50RXZlbnRQaXBlTGlzdC5maW5kSW5kZXgoaXRlbSA9PiBpdGVtID09PSB0aGlzKTtcclxuICAgICAgaWYgKGxvY2F0aW9uICE9PSAtMSkge1xyXG4gICAgICAgIHRoaXMucGFyZW50RXZlbnRQaXBlTGlzdC5zcGxpY2UobG9jYXRpb24sIDEpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmoLnmja5jYWxsZXLov5vooYzms6jplIBcclxuICAgKi9cclxuICBkaXNwb3NlQnlDYWxsZXIoY2FsbGVyOiBhbnkpIHtcclxuICAgIGNvbnN0IHN1YnNjcmlwdGlvbkluTWFwID0gdGhpcy5zdWJzY3JpcHRpb25NYXAuZ2V0KGNhbGxlcik7XHJcbiAgICBpZiAoc3Vic2NyaXB0aW9uSW5NYXAgIT0gbnVsbCkge1xyXG4gICAgICBzdWJzY3JpcHRpb25Jbk1hcC51bnN1YnNjcmliZSgpO1xyXG4gICAgICB0aGlzLnN1YnNjcmlwdGlvbk1hcC5kZWxldGUoY2FsbGVyKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOajgOafpeaYr+WQpuWcqOWQjOS4gOS4quS4iuS4i+aWh+S4rVxyXG4gICAqIEB0b2RvXHJcbiAgICogMeOAgeW8uuivhuWIq+S6hnNlbmRlcuWSjHJlY2VpdmVy55qE57uT5p6E5p2l5Yik5pat77yM5LiN5ZCI55CG77ybXHJcbiAgICogMuOAgeW6lOivpeWjsOaYjuS4gOS4quaOpeWPo+adpee6puadn+e7k+aehOOAglxyXG4gICAqL1xyXG4gIHByaXZhdGUgaXNJblNhbXBlU2NvcGUoc2VuZGVyOiBhbnksIHJlY2VpdmVyOiBhbnkpOiBib29sZWFuIHtcclxuICAgIC8vIOeUqOadpeWMuuWIhue8luivkeexu+Wei+eahOihqOWNle+8jOi/mOaYr+ino+aekOexu+Wei+eahOihqOWNlVxyXG4gICAgaWYgKHRoaXMuZXZlbnRQaXBlVHlwZSA9PT0gRXZlbnRQaXBlVHlwZS5QYXJzaW5nKSB7XHJcbiAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIOWFvOWuueiAgeS7o+egge+8jHNlbmRlcuS4jeWtmOWcqOaXtu+8jOS4jei/m+ihjOajgOa1i1xyXG4gICAgaWYgKCFzZW5kZXIpIHtcclxuICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9XHJcblxyXG4gICAgLy8g5byC5bi45aSE55CG5Zy65pmvXHJcbiAgICBpZiAoc2VuZGVyID09PSByZWNlaXZlcikge1xyXG4gICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH1cclxuXHJcbiAgICAvLyDliKTmlq3mmK/lkKbmmK9GcmFtZUNvbnRleHRcclxuICAgIGlmICghc2VuZGVyLmNvbnRleHQgfHwgIXNlbmRlci5jb250ZXh0LmFwcENvbnRleHQgfHxcclxuICAgICAgIXJlY2VpdmVyLmNvbnRleHQgfHwgIXJlY2VpdmVyLmNvbnRleHQuYXBwQ29udGV4dCkge1xyXG4gICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3Qgc2VuZGVyQXBwQ29udGV4dCA9IHNlbmRlci5jb250ZXh0LmFwcENvbnRleHQ7XHJcbiAgICBjb25zdCByZWNlaXZlckFwcENvbnRleHQgPSByZWNlaXZlci5jb250ZXh0LmFwcENvbnRleHQ7XHJcblxyXG4gICAgLy8g5oOF5Ya1Me+8mueOsOeKtlxyXG4gICAgLy8g5a+55LqO6ICB6KGo5Y2V77yM5Zyo5qih5Z2X5LiK5rOo5YWl5LqG5LiA5LiqQXBwQ29udGV4dO+8m1xyXG4gICAgLy8g57uE5ZCI6KGo5Y2V5Lit5Li76KGo5Y2V55qEcm9vdC1jb21wb25lbnTvvIjooqvnu4TlkIjnmoTooajljZXnmoRyb290LWNvbXBvbmV0buS4iuayoeacieazqOWFpe+8ieS4iuazqOWFpeS6hkFwcENvbnRleHRcclxuICAgIC8vIFNQQeaooeW8j+S4i++8jOWmguazlemAmui/h1Jvb3QgQXBwQ29udGV4dOWMuuWIhu+8jOaYr+S4jeaYr+WQjOS4gOS4quiPnOWNleWGheeahOS6i+S7tu+8m1xyXG4gICAgLy8g5Y+q6IO95Yik5pat5qC557uE5Lu25LiK55qEQXBwQ29udGV4dOadpeWIpOaWrVxyXG4gICAgLy8g5Yik5pat5qC5QXBwQ29udGV4dOaYr+WQpuS4gOiHtFxyXG4gICAgaWYgKHNlbmRlckFwcENvbnRleHQgPT09IHJlY2VpdmVyQXBwQ29udGV4dCkge1xyXG4gICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH1cclxuXHJcbiAgICAvLyDmg4XlhrUy77ya5rOo5YWl5pS56YCg5ZCOXHJcbiAgICAvLyDlpoLmnpzku6XlkI7ms6jlhaXlhbPns7vmlLnpgKDkuobvvIzmqKHlnZfkuIrnmoRBcHBDb250ZXh056e76Zmk5o6JXHJcbiAgICAvLyDnu4TlkIjooajljZXkuK3mr4/kuKpyb290LWNvbXBvbmVudOmDveaLpeacieS4gOS4qkFwcENvbnRleHQ7XHJcbiAgICAvLyDnu4TlkIjooajljZXkuK3kuLvooajljZXnmoRyb290LWNvbXBvbmVudOeahEFwcENvbnRleHTkuLpSb290IEFwcENvbnRleHRcclxuICAgIC8vIGlmIChzZW5kZXJBcHBDb250ZXh0LnJvb3QgPT09IHJlY2VpdmVyQXBwQ29udGV4dC5yb290KSB7XHJcbiAgICAvLyAgIHJldHVybiB0cnVlO1xyXG4gICAgLy8gfVxyXG5cclxuICAgIC8vIOaDheWGtTPvvJrms6jlhaXmlLnpgKDlkI7ogIHooajljZXlhbzlrrlcclxuICAgIC8vIOWmguaenOS7peWQjuazqOWFpeWFs+ezu+aUuemAoOS6hu+8jOS9huS6p+WTgemDqOayoeaciemHjeaWsOe8luivkTtcclxuICAgIC8vIOWSjOaDheWGtTLnsbvkvLzvvIzkuI3lkIznmoTmmK/mqKHlnZfkuIrov5jpgZfnlZnkuobkuIDkuKpBcHBDb250ZXh077ybXHJcbiAgICAvLyDmraTml7ZSb290IEFwcGNvbnRleHTov5jmmK/mqKHlnZfkuIrnmoTvvIzlpoLkvZXmnaXliKTmlq3vvJ9cclxuICAgIC8vIDHjgIHogIPomZHpgJrov4dzZW5kZXLnmoRpbmplY3RvcuS4gOebtOe9keS4iuaJvu+8jOaJvuWIsOaooeWdl+S5i+WJjeeahOmCo+S4que7hOS7tmluamVjdG9y77yM5LuO5YW25Lit5ou/QXBwQ29udGV4dOadpeWIpOaWre+8m1xyXG4gICAgLy8gMuOAgeaJvuS4gOS4quWFqOmDqOmHjeaWsOe8luivkeeahOaXtuacuuWGjeaUuemAoOOAglxyXG5cclxuICAgIGlmICgoc2VuZGVyQXBwQ29udGV4dC51c2VJc29sdXRlRXZlbnRCdXMgJiYgc2VuZGVyQXBwQ29udGV4dC5pc29sdXRlRXZlbnRCdXMpIHx8XHJcbiAgICAgIChyZWNlaXZlckFwcENvbnRleHQudXNlSXNvbHV0ZUV2ZW50QnVzICYmIHJlY2VpdmVyQXBwQ29udGV4dC5pc29sdXRlRXZlbnRCdXMpKSB7XHJcbiAgICAgIC8vIOWmguaenOWtmOWcqOeLrOeri+WKoOi9vWpzICDpgqPkuYhcclxuICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gZmFsc2U7XHJcbiAgfVxyXG59XHJcbiJdfQ==