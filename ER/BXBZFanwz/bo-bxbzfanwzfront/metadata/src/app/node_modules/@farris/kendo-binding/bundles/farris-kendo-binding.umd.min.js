!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@farris/ui-common/number"),require("@farris/ui-treetable"),require("@progress/kendo-angular-dropdowns"),require("@farris/ui-combo-list"),require("@farris/ui-multi-select"),require("@farris/ui-list-view"),require("lodash-es"),require("@farris/ui-html-editor"),require("@farris/ui-datagrid"),require("@farris/extend-file-upload"),require("rxjs"),require("@farris/discussion-group"),require("rxjs/operators"),require("primeng/treetable"),require("@farris/ui-common/date"),require("@farris/ui-editor"),require("@gsp-cmp/querysolution"),require("@farris/ui-datepicker"),require("@farris/ui-number-spinner"),require("@farris/ui-time-picker"),require("@farris/ui-text"),require("@farris/ui-combo-lookup"),require("@farris/ui-lookup"),require("@gsp-svc/formdoc-upload"),require("@farris/ui-locale"),require("@farris/ui-common/column"),require("@farris/devkit"),require("bignumber.js"),require("moment"),require("@farris/ui-dialog"),require("@angular/core"),require("@angular/common"),require("@progress/kendo-angular-grid"),require("@farris/ui-common")):"function"==typeof define&&define.amd?define("@farris/kendo-binding",["exports","@farris/ui-common/number","@farris/ui-treetable","@progress/kendo-angular-dropdowns","@farris/ui-combo-list","@farris/ui-multi-select","@farris/ui-list-view","lodash-es","@farris/ui-html-editor","@farris/ui-datagrid","@farris/extend-file-upload","rxjs","@farris/discussion-group","rxjs/operators","primeng/treetable","@farris/ui-common/date","@farris/ui-editor","@gsp-cmp/querysolution","@farris/ui-datepicker","@farris/ui-number-spinner","@farris/ui-time-picker","@farris/ui-text","@farris/ui-combo-lookup","@farris/ui-lookup","@gsp-svc/formdoc-upload","@farris/ui-locale","@farris/ui-common/column","@farris/devkit","bignumber.js","moment","@farris/ui-dialog","@angular/core","@angular/common","@progress/kendo-angular-grid","@farris/ui-common"],t):t((e.farris=e.farris||{},e.farris["kendo-binding"]={}),e.number,e.uiTreetable,e.kendoAngularDropdowns,e.uiComboList,e.uiMultiSelect,e.uiListView,e.lodashEs,e.uiHtmlEditor,e.uiDatagrid,e.extendFileUpload,e.rxjs,e.discussionGroup,e.rxjs.operators,e.treetable,e.date,e.uiEditor,e.querysolution,e.uiDatepicker,e.uiNumberSpinner,e.uiTimePicker,e.uiText,e.uiComboLookup,e.uiLookup,e.formdocUpload,e.uiLocale,e.column,e.devkit,e.bignumber_js,e.moment,e.uiDialog,e.ng.core,e.ng.common,e.kendoAngularGrid,e.uiCommon)}(this,function(e,t,i,n,r,o,a,s,d,l,p,u,c,y,h,g,f,m,v,b,C,S,I,D,x,w,E,P,L,O,T,M,F,N,k){"use strict";O=O&&O.hasOwnProperty("default")?O["default"]:O;var R=(j.prototype.convertFrom=function(e){return e.split(this.separator)},j.prototype.convertTo=function(e){return e.join(this.separator)},j);function j(e){void 0===e&&(e=","),this.separator=e}var V=(H.prototype.convertFrom=function(e){return!0===P.DateUtil.isEmptyDateString(e)?null:P.DateUtil.parse(e)},H.prototype.convertTo=function(e){if(!e)return null;if("[object Date]"!==Object.prototype.toString.call(e))return e;var t=e.getFullYear().toString();t=t.length<4?"0".repeat(4-t.length)+t:t;var i=(e.getMonth()+1).toString();i=1===i.length?"0"+i:i;var n=e.getDate().toString();n=1===n.length?"0"+n:n;var r=e.getHours().toString();r=1===r.length?"0"+r:r;var o=e.getMinutes().toString();o=1===o.length?"0"+o:o;var a=e.getSeconds().toString();return t+"-"+i+"-"+n+" "+r+":"+o+":"+(a=1===a.length?"0"+a:a)},H);function H(e){this.format=e}var B=(A.prototype.convertFrom=function(e){return Object.assign({},e)},A.prototype.convertTo=function(e){return e},A);function A(){}var K=(_.prototype.convertFrom=function(e){return e?JSON.parse(e):[]},_.prototype.convertTo=function(e){return JSON.stringify(e)},_);function _(){}var z=function(e,t){return(z=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)};function G(e,t){function i(){this.constructor=e}z(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}var q=function(){return(q=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)};function U(e){var t="function"==typeof Symbol&&e[Symbol.iterator],i=0;return t?t.call(e):{next:function(){return e&&i>=e.length&&(e=void 0),{value:e&&e[i++],done:!e}}}}function $(e,t){var i="function"==typeof Symbol&&e[Symbol.iterator];if(!i)return e;var n,r,o=i.call(e),a=[];try{for(;(void 0===t||0<t--)&&!(n=o.next()).done;)a.push(n.value)}catch(s){r={error:s}}finally{try{n&&!n.done&&(i=o["return"])&&i.call(o)}finally{if(r)throw r.error}}return a}function J(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat($(arguments[t]));return e}var W=(Y.prototype.getColumnFormat=function(e,t){var i=this.getValue(e,t.dataField),n=t.dataType;return"enum"===n?this.getEnumText(i,t):"boolean"===n?i?"是":"否":"date"===n?this.getFormatDate(i,t):"number"===n?this.getFormatNumber(i,t):this.getMultiText(i,t)},Y.prototype.getValue=function(e,t){return t.indexOf(".")<0?e[t]:t.split(".").reduce(function(e,t){return e[t]},e)},Y.prototype.getEnumText=function(t,e){var i,n=e.enumData;if(n)return n.forEach(function(e){e.value===t&&(i=e.name)}),i},Y.prototype.getFormatDate=function(e,t){if(!0===P.DateUtil.isEmptyDateString(e))return"";var i=t.format;return i?this.dateService.formatTo(e,i):e},Y.prototype.getFormatNumber=function(e,t){var i;if(t&&t.format?i=parseInt(t.format.substr(1),10):t&&t.editor&&(i=t.editor.precision),isNaN(i)&&(i=2),!e&&0!==e)return"";var n={prefix:t.prefix?t.prefix:"",suffix:t.suffix?t.suffix:"",precision:i,thousand:",",stripZeros:!1};return this.numberService.formatMoney(e,n)},Y.prototype.getMultiText=function(e,t){var i=e;if(""===i||i||(i=""),"string"!=typeof i)throw new Error(typeof i+"类型值不合法，无法进行格式化");return i=i.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/\'/g,"&#39;").replace(/\//g,"&#x2F;"),t.editor&&"MultiTextBox"===t.editor.type&&-1<i.indexOf("\n")?i.replace(/\n/g,"<br>"):i},Y.decorators=[{type:M.Injectable}],Y.ctorParameters=function(){return[{type:g.DateTimeHelperService},{type:t.NumberHelperService}]},Y);function Y(e,t){this.dateService=e,this.numberService=t}var Q=(X.prototype.setFormat=function(e){e.columns.forEach(function(e){var t=e.dataType;e.formatter||("date"===t?e.formatter={type:"datetime",options:{format:e.format}}:"number"===t?e.formatter={type:"number",options:{prefix:e.prefix?e.prefix:"",suffix:e.suffix?e.suffix:"",precision:e.precision,thousand:",",stripZeros:!1}}:"enum"===t?e.formatter={type:"enum",options:{data:e.enumData,valueField:"value",textField:"name"}}:"boolean"===t&&(e.formatter={type:"enum",options:{data:[{name:"是",value:!0},{name:"否",value:!1}],valueField:"value",textField:"name"}}))})},X.decorators=[{type:M.Injectable}],X.ctorParameters=function(){return[]},X);function X(){}var Z=(ee.prototype.transform=function(e,t){if(!0===P.DateUtil.isEmptyDateString(e))return null;if(e.includes("年")){var i=e.replace("年","-").replace("月","-").replace("日","");return new Date(i)}return new Date(e)},ee.decorators=[{type:M.Pipe,args:[{name:"parseStrToDate"}]}],ee);function ee(){}var te,ie=(G(ne,te=N.BaseFilterCellComponent),Object.defineProperty(ne.prototype,"selectedValue",{get:function(){var e=this.filterByField(this.column.dataField);return e?e.value:null},enumerable:!0,configurable:!0}),Object.defineProperty(ne.prototype,"defaultItem",{get:function(){return{value:null,name:"全部"}},enumerable:!0,configurable:!0}),ne.prototype.ngOnInit=function(){this.dropdownList.valueField="value",this.dropdownList.textField="name",this.dropdownList.valuePrimitive=!0,this.dropdownList.defaultItem=this.defaultItem,this.dropdownList.value=this.selectedValue,"enum"===this.column.dataType?this.dropdownList.data=this.column.enumData:"boolean"===this.column.dataType&&(this.dropdownList.data=[{value:!0,name:"是"},{value:!1,name:"否"}])},ne.prototype.onChange=function(e){this.applyFilter(null===e?this.removeFilter(this.column.dataField):this.updateFilter({field:this.column.dataField,operator:"eq",value:e}))},ne.prototype.getValue=function(e,t){return t.indexOf(".")<0?e[t]:t.split(".").reduce(function(e,t){return e[t]},e)},ne.decorators=[{type:M.Directive,args:[{selector:"[kendogridFilter]"}]}],ne.ctorParameters=function(){return[{type:n.DropDownListComponent},{type:N.FilterService}]},ne.propDecorators={filter:[{type:M.Input}],column:[{type:M.Input}],onChange:[{type:M.HostListener,args:["valueChange",["$event"]]}]},ne);function ne(e,t){var i=te.call(this,t)||this;return i.dropdownList=e,i.filterService=t,i}var re=(oe.prototype.transform=function(e,t){if(!this.viewModel.form||!this.viewModel.form.get(t))return{year:"年",month:"月",day:"日"};var i=this.viewModel.form.get(t).value,n=i;return n=n&&i.toISOString(),!0===P.DateUtil.isEmptyDateString(n)&&"yyyy年MM月dd日"===e?{year:" ",month:" ",day:" "}:{year:"年",month:"月",day:"日"}},oe.decorators=[{type:M.Pipe,args:[{name:"dateFormatPlaceholder"}]}],oe.ctorParameters=function(){return[{type:P.ViewModel}]},oe);function oe(e){this.viewModel=e}var ae=(se.prototype.transform=function(e,t){if(!e&&0!==e)return"";if("number"!==t.dataType)return e;var i=t.format;return e.toFixed(Number(i.substring(1)))},se.decorators=[{type:M.Pipe,args:[{name:"formatTotal"}]}],se);function se(){}var de=(Object.defineProperty(le.prototype,"field",{get:function(){return this.column.field},enumerable:!0,configurable:!0}),Object.defineProperty(le.prototype,"aggrType",{get:function(){var e="none";return"boolean"==typeof this.aggregate?this.aggregate&&(e="sum"):"string"==typeof this.aggregate&&(e=this.aggregate),e},enumerable:!0,configurable:!0}),le.prototype.recalculateSummary=function(e){var t=this,i=null;if("sum"===this.aggrType){var n=e.toJSON().map(function(e){return t.field.split(".").reduce(function(e,t){return e[t]},e)});n&&n.length&&(i=n.reduce(function(e,t){return e+t}))}else"count"===this.aggrType&&(i=e.length);this.updateFooter(i)},le.prototype.updateFooter=function(e){this.aggregate&&(this.column.summary=e)},le.decorators=[{type:M.Directive,args:[{selector:"[aggregate]"}]}],le.ctorParameters=function(){return[{type:N.ColumnComponent},{type:M.NgZone}]},le.propDecorators={aggregate:[{type:M.Input}]},le);function le(e,t){this.column=e,this.ngZone=t}var pe=(ue.decorators=[{type:M.Directive,args:[{selector:"[farrisSummary]"}]}],ue.ctorParameters=function(){return[{type:P.BindingData}]},ue.propDecorators={summary:[{type:M.Input,args:["farrisSummary"]}]},ue);function ue(e){this.bindingData=e}var ce=(he.renderClickChangedRow=function(e,t){if(e){var i=t.currentRowIndex;this.addRowSelectedStyle(e,i);var n=t.lastRowIndex;this.checIfIsSameRelativeIndex(e,i,n)||this.removeRowSelectedStyle(e,n)}},he.checIfIsSameRelativeIndex=function(e,t,i){var n=!1;return t===i?n=!0:Math.abs(t-i)%e.pageSize==0?n=!0:n},he.checkIfEnablePaging=function(e){var t=!1;return e&&("boolean"==typeof e.pageable?t=e.pageable:"object"==typeof e.pageable&&(t=!0)),t},he.renderSelectedChangeCheckbox=function(e,t){var i=t.index,n=this.getTrCollection(e);if(!(null==n||n.length<=0||n.length<i)){var r=n[i];r&&(t.selected?this.appendAtrributeValue(r,"class",this.CHECKBOXED_ROW_STYLE_NAME):this.removeAttributeSpecificValue(r,"class",this.CHECKBOXED_ROW_STYLE_NAME))}},he.addRowSelectedStyle=function(e,t){if(e&&!(t<0)){var i=this.getRelativeRowInCurrentPage(e,t);i&&this.appendAtrributeValue(i,"class",this.CURRENT_ROW_STYLE_NAME)}},he.removeRowSelectedStyle=function(e,t){if(e&&!(t<0)){var i=this.getRelativeRowInCurrentPage(e,t);i&&this.removeAttributeSpecificValue(i,"class",this.CURRENT_ROW_STYLE_NAME)}},he.getRelativeRowInCurrentPage=function(e,t){var i=null;if(!e||t<0)return i;var n=e.wrapper;this.checkIfEnablePaging(e)&&(t%=e.pageSize);var r=this.getTrCollection(n);return null==r||r.length<=0?i:i=r[t]},he.getTrCollection=function(e){if(!e||!e.nativeElement)return null;var t=e.nativeElement.getElementsByTagName("tbody");return!t||t.length<=0?null:t[0].getElementsByTagName("tr")},he.appendAtrributeValue=function(e,t,i){var n=e.getAttribute(t);null===n||""===n||n.length<=0?n=i:n.indexOf(i)<0&&(n+=" "+i),e.setAttribute(t,n)},he.removeAttributeSpecificValue=function(e,t,i){var n=e.getAttribute(t);if(n){var r=n.lastIndexOf(i);r<0||(n=n.substring(0,r-1)+" "+n.substring(r+i.length),e.setAttribute(t,n))}},he.CURRENT_ROW_STYLE_NAME="f-state-selected",he.CHECKBOXED_ROW_STYLE_NAME="f-state-checked",he);function he(){}var ge,fe=function Zt(){},ye=(G(me,ge=N.DataBindingDirective),Object.defineProperty(me.prototype,"gridOption",{get:function(){return this.grid.gridOption},enumerable:!0,configurable:!0}),Object.defineProperty(me.prototype,"len",{get:function(){return this.grid.columns.length},enumerable:!0,configurable:!0}),Object.defineProperty(me.prototype,"IsMultipleSelectionMode",{get:function(){return this.grid&&(this.grid.selectable?"multiple"===this.grid.selectable.mode?this.isMultipleSelectionMode=!0:this.isMultipleSelectionMode=!1:this.grid.selectableSettings&&"multiple"===this.grid.selectableSettings.mode&&(this.isMultipleSelectionMode=!0)),this.isMultipleSelectionMode},enumerable:!0,configurable:!0}),Object.defineProperty(me.prototype,"bindingList",{get:function(){if("/"===this.viewModel.bindingPath||!this.viewModel.bindingPath)return this.bindingData.list;var e=this.viewModel.bindingPath.substr(1),t=(e=e[0].toLowerCase()+e.substring(1,e.length)).split("/").filter(function(e){return""!==e});return this.bindingData.getValue(t)},enumerable:!0,configurable:!0}),me.prototype.getPagingInfo=function(){var e=this.viewModel.bindingPath,t=this.viewModel.bindingData.pagingInfo;return"/"===e||e.substr(1).split("/").filter(function(e){return!!e&&0<e.length}).map(function(e){return e.substring(0,e.length-1)}).forEach(function(e){t=t&&t[e]||{}}),t},me.prototype.ngOnInit=function(){var i=this;if(ge.prototype.ngOnInit.call(this),this.initDataState(),this.refreshView(),this.bindingChangeSubscription=this.bindingData.changes.subscribe(function(e){i.refreshView(e),e.type!==P.ChangeType.Load||i.isMultipleSelectionMode&&i.checkIfChangeMatchBindingPath(e)&&(i.selectionDir.selectedKeys=[],i.viewModel.uiState.setPropertyValue("ids",i.selectionDir.selectedKeys),i.ngZone.runOutsideAngular(function(){setTimeout(function(){var e=new fe,t=ce.checkIfEnablePaging(i.grid);i.rowIndex=t?i.grid.skip:0,e.currentRowIndex=i.rowIndex,e.lastRowIndex=i.lastRowIndex,i.handleSelectedRowChange(e)},300)})),e.type===P.ChangeType.Remove&&i.syncDeletedKeys(e.value);var t=i.checkIfChangeMatchBindingPath(e);t&&i.handleSelectedKeyChange(i.bindingList.currentId),t&&i.checkCurrentRowIdExists()&&e.type===P.ChangeType.SelectionChanged&&!i.dataId&&i.renderCurrentRow(i.bindingList.currentId),e.type!==P.ChangeType.Load&&e.type!==P.ChangeType.SelectionChanged&&e.type!==P.ChangeType.Append&&e.type!==P.ChangeType.Remove||i.grid&&i.grid.changeDetectorRef&&i.grid.changeDetectorRef.detectChanges&&i.grid.changeDetectorRef.detectChanges()}),!0===this.editable&&null===this.form)throw Error("启用编辑时，必须指定form");if(this.grid&&this.farrisBindingGridOption&&this.farrisBindingGridOption.fields){var e=this.farrisBindingGridOption.fields;if(this.farrisBindingGridOption.lockable=function(e){return e.some(function(e){return e.frozen})},this.rowClass.emit(this.grid),e.forEach(function(e){e.linkedLabelEnabled&&!e.linkEvent&&(e.linkEvent=function(){}),e.getColumnFormat||(e.getColumnFormat=function(e,t){return i.kendogridFormatSer.getColumnFormat(e,t)}),e.getClassName||(e.getClassName=function(e,t){return""}),e.editor&&"LookupEdit"===e.editor.type&&(e.dictPicking||(e.dictPicking=function(e){return u.of(!0)}),e.dictPicked||(e.dictPicked=function(e){return i.cellClickHandler(i.cellClickParam),u.of(!0)}))}),this.bindingGridOption(),this.IsMultipleSelectionMode){var t=this;this.ngZone.runOutsideAngular(function(){setTimeout(function(){var e=new fe;e.currentRowIndex=t.rowIndex,e.lastRowIndex=t.lastRowIndex,t.handleSelectedRowChange(e)},300)})}}},me.prototype.ngAfterViewInit=function(){},me.prototype.checkIfChangeMatchBindingPath=function(e){var t=!1;if(!e||!e.path)return t;var i=e.path;if(!i)return t;if(!this.bindingData&&!this.bindingData.bindingPath)return t;var n=this.bindingData.bindingPath.split("/");return n.length<=0||(0===i.length?"/"===this.bindingData.bindingPath&&(t=!0):1===e.path.length?2===n.length&&n[1]===e.path[0]&&(t=!0):2===e.path.length&&3===n.length&&n[1]===e.path[0]&&n[2]===e.path[1]&&(t=!0)),t},me.prototype.handleSelectedKeyChange=function(e){var t=this.selectionDir.selectedKeys;if(e){if((this.IsMultipleSelectionMode?this.currentRowId:0===this.selectionDir.selectedKeys.length?null:this.selectionDir.selectedKeys[0])!==e){var i={};i.currentRowId=e,this.currentRowId=e,this.emitSelectedRowChange(i)}}else 0<t.length&&-1===t.splice(0,t.length).indexOf(null)&&this.emitSelectedRowChange({currentRowId:null})},me.prototype.emitSelectedRowChange=function(e){if(!this.IsMultipleSelectionMode){var t=e.currentRowId;this.selectionDir.selectedKeys=[t],this.selectionDir.selectedKeysChange.emit(this.selectionDir.selectedKeys)}this.selectedRowChange.emit(e)},me.prototype.checkCurrentRowIdExists=function(){var e=!1;return this.bindingList&&this.bindingList.currentId&&0<this.bindingList.currentId.length&&(e=!0),e},me.prototype.syncDeletedKeys=function(e){var i=this;e&&e.forEach(function(e){var t=i.selectionDir.selectedKeys.indexOf(e);-1<t&&(i.selectionDir.selectedKeys.splice(t,1),0===i.selectionDir.selectedKeys.length&&i.emitSelectedRowChange({currentRowId:null}))})},me.prototype.renderCurrentRow=function(e){e&&""!==e&&(this.IsMultipleSelectionMode||this.renderSelectionRow(this.bindingList.currentId,this.selectionDir.selectedKeys))},me.prototype.ngOnChanges=function(e){ge.prototype.ngOnChanges.call(this,e),this.refreshView()},me.prototype.ngOnDestroy=function(){this.bindingChangeSubscription&&this.bindingChangeSubscription.unsubscribe()},me.prototype.refreshView=function(e){this.refreshData(e),this.refreshSummary()},me.prototype.bindData=function(){},me.prototype.refreshData=function(e){var t=0,i=this.getPagingInfo()||{},n=i.pageIndex,r=void 0===n?1:n,o=i.pageSize,a=void 0===o?0:o;0<r&&(t=(r-1)*a),this.updatePager(a,t),this.endCellEdit(e),this.data=this.bindingList.toJSON({ignoreMultiLangInput:!0})},me.prototype.endCellEdit=function(e){var t=this.grid.isEditing;e&&e.type===P.ChangeType.Load&&t&&this.grid.cancelCell()},me.prototype.refreshSummary=function(){var t=this;this.aggrColumns&&this.aggrColumns.forEach(function(e){e.aggregate&&e.recalculateSummary(t.bindingList)})},me.prototype.onPageChange=function(e){var t=e||{},i=t.skip,n=void 0===i?0:i,r=t.take,o=void 0===r?0:r;this.bindingData.setPagingInfo(n,o,this.viewModel.bindingPath),ce.removeRowSelectedStyle(this.grid,this.rowIndex)},me.prototype.resetPageInfo=function(){var e=(this.getPagingInfo()||{}).pageSize,t=void 0===e?0:e;this.bindingData.setPagingInfo(0,t,this.viewModel.bindingPath)},me.prototype.initDataState=function(){var e,t,i=[];if(this.groupAggrFields)try{for(var n=U(this.groupAggrFields),r=n.next();!r.done;r=n.next()){var o=r.value;i.push({field:o,aggregate:"sum"})}}catch(s){e={error:s}}finally{try{r&&!r.done&&(t=n["return"])&&t.call(n)}finally{if(e)throw e.error}}var a=[];this.groupField&&a.push({field:this.groupField,aggregates:i}),this.group=a},me.prototype.onStateChange=function(e){e.skip!==this.currentSkip&&(e.skip=this.currentSkip),this.applyState(e),this.rebind()},me.prototype.process=function(e){e.skip=0;var t=this.getPagingInfo()||{},i=t.pageSize,n=void 0===i?0:i,r=t.total,o=void 0===r?0:r;0===e.take?e.take=this.bindingList.length:e.take=n;var a=e.take<this.bindingList.length;a&&(e.take=this.bindingList.length);var s=ge.prototype.process.call(this,e);return s.total=Math.max(o,this.bindingList.length),a&&(s.total=o||1),s},me.prototype.selectedKeysChangeHandler=function(e){this.IsMultipleSelectionMode||this.setSelectionIdToBindingData(e[e.length-1]),this.viewModel.uiState.setPropertyValue("ids",this.selectionDir.selectedKeys)},me.prototype.selectionChangeHandler=function(e){this.IsMultipleSelectionMode&&this.handleSelectedCheckboxChange(this.grid.wrapper,e)},me.prototype.handleSelectedCheckboxChange=function(e,t){ce.renderSelectedChangeCheckbox(e,t),this.selectedCheckboxChange.emit(t)},me.prototype.cellClickHandler=function(t){if(this.cellClickParam=t,this.cellClickEvent=t,this.rowIndex=t.rowIndex,this.columnIndex=t.columnIndex,this.sender=t.sender,this.IsMultipleSelectionMode&&!this.gridOption.groupable){var e=t.rowIndex;if(e!==this.lastRowIndex){var i=new fe;i.currentRowIndex=e,i.lastRowIndex=this.lastRowIndex,this.handleSelectedRowChange(i)}}if(this.dataId=this.getSelectedIdFromGrid(t.dataItem),this.setSelectionIdToBindingData(this.dataId),this.isEditable()&&t.column.editTemplate&&"click"===t.type&&!t.isEdited){var n=this.getColumns(this.gridOption.fields),r=this.getColumns(n),o=r.findIndex(function(e){return e.dataField===t.column.field}),a=r.slice(0,o+1).filter(function(e){return!e.visible}).length;this.rowIndex=t.rowIndex,this.columnIndex=t.columnIndex+a,this.hiddenColLen=a,this.sender=t.sender,this.setEditable(this.rowIndex,this.columnIndex)}},me.prototype.handleSelectedRowChange=function(e){ce.renderClickChangedRow(this.grid,e),this.rowIndex=e.currentRowIndex,this.lastRowIndex=e.currentRowIndex;var t=this.getPrimary(this.rowIndex);this.setSelectionIdToBindingData(t)},me.prototype.getPrimary=function(e){var t=this.grid.data;t&&!Array.isArray(t)&&t.hasOwnProperty("data")&&(t=t.data);var i=this.getPagingInfo()||{},n=i.pageIndex,r=void 0===n?1:n,o=i.pageSize,a=void 0===o?0:o,s=this.bindingList.skip,d=0===a||1===r?e:e-s;return t.length>d?t[d][this.bindingList.primaryKey]:null},me.prototype.cellCloseHandler=function(e){if(this.dialogSer.hasDialogOpened())e.preventDefault();else{if(this.rts){if(this.rts.getFormState("lookup.pending"))return void e.preventDefault();if(e.originalEvent&&this.rts.eventPath(e.originalEvent).find(function(e){return"FARRIS-DIALOG"===e.tagName}))return void e.preventDefault()}var t=e.formGroup,i=e.column,n=e.dataItem,r=(e.rowIndex,this.getColumns(this.gridOption.fields).find(function(e){return e.dataField===i.field})),o=t[r.editor.binding.path].value;r.getDynamicData&&(r=r.getDynamicData(n,r)),this.setValue(o,r)}},me.prototype.enterCell=function(e){var t=this;if(!e.shiftKey&&13===e.keyCode){if(e.preventDefault(),!this.sender)return;e.target.blur(),this.ngZone.runOutsideAngular(function(){setTimeout(function(){t.rts&&t.rts.getFormState("lookup.pending")?e.preventDefault():t.enterNextCell()},201)})}},me.prototype.bindingGridOption=function(){this.farrisBindingGridOption&&Object.defineProperty(this.grid,"gridOption",{value:this.farrisBindingGridOption})},me.prototype.updatePager=function(e,t){0===e?(this.currentSkip=0,this.pageSize=0,this.skip=0,this.grid.pageable=!1):(this.currentSkip=t,this.skip=t,this.pageSize=e,this.grid.pageable={buttonCount:10,info:!0,type:"numeric",pageSizes:!1,previousNext:!0})},me.prototype.setEditable=function(e,t){var i=this.grid.data.data,n=this.getPagingInfo()||{},r=n.pageIndex,o=void 0===r?1:r,a=n.pageSize,s=void 0===a?0:a,d=this.bindingList.skip,l=0===s||1===o?e:e-d,p=i[l];this.gridOption.groupable&&(p=this.getGroupItem(i,l));var u=this.getColumns(this.gridOption.fields),c=this.getColumns(u),h=t;this.grid.gridOption.showLineNumber&&(h-=1),this.grid.selectable&&"multiple"===this.grid.selectable.mode&&(h-=1);var g=c[h],f={dataItem:p,column:g,rowIndex:e,columnIndex:h};g&&!g.editable&&(g.editable=function(e){return!0}),g&&this.notReadOnly(g,f)&&(this.dataId=this.getSelectedIdFromGrid(p),this.setSelectionIdToBindingData(this.dataId),this.sender.editCell(e,t-this.hiddenColLen,this.viewModel.form))},me.prototype.updateIndex=function(e,t){var i=(t+1)%this.len;return i?{rowIndex:e,columnIndex:i}:{rowIndex:(e+1)%this.bindingList.toJSON().length,columnIndex:i}},me.prototype.notReadOnly=function(e,t){return!!e&&e.editable(t)&&!e.editor.readonly},me.prototype.setValue=function(e,t){var i=t.dataType,n=this.viewModel.bindingData,r=this.getFieldPaths(n.bindingPath,t.dataField);if("date"===i){var o=this.dateService.formatTo(e,"yyyy-MM-dd HH:mm:ss");o=o||"",this.viewModel.bindingData.setValue(r,o,!0,!0)}else this.viewModel.bindingData.setValue(r,e,!0,!0)},me.prototype.getGroupItem=function(e,t){var i=t;for(var n in e){if(i<e[n].items.length)return e[n].items[i];i-=e[n].items.length}},me.prototype.getValue=function(e,t){return t.indexOf(".")<0?e[t]:t.split(".").reduce(function(e,t){return e[t]},e)},me.prototype.getFieldPaths=function(e,t){return(1<e.length?e.substr(1).replace(/\//g,".")+"."+t:t).split(".")},me.prototype.enterNextCell=function(){var e=this,t=this.updateIndex(this.rowIndex,this.columnIndex);if(!t.columnIndex&&!t.rowIndex){var i=this.bindingList.toJSON().length;if(this.appendRow.emit(),this.appendRow.observers&&this.appendRow.observers.length)return void(this.interVal=setInterval(function(){e.bindingList.toJSON().length-1===i&&(e.setEditable(e.bindingList.toJSON().length-1,0),e.rowIndex=e.bindingList.toJSON().length-1,e.columnIndex=0,clearInterval(e.interVal))},0))}this.setEditable(t.rowIndex,t.columnIndex),this.rowIndex=t.rowIndex,this.columnIndex=t.columnIndex},me.prototype.getColumns=function(e){return e.some(function(e){return e.frozen})?J(e.filter(function(e){return e.frozen}),e.filter(function(e){return!e.frozen})):e},me.prototype.renderSelectionRow=function(e,t){if(e&&""!==e){if(this.IsMultipleSelectionMode){if(0<=t.indexOf(e))return;t.push(e)}else{if(1===t.length&&t[0]===e)return;t.splice(0,t.length),t.push(e)}this.selectionDir.selectedKeysChange.emit(t)}},me.prototype.getSelectedIdFromGrid=function(e){return e[this.bindingList.primaryKey]},me.prototype.setSelectionIdToBindingData=function(e){this.bindingList.setCurrentId(e,!0)},me.prototype.isEditable=function(){return this.editable===undefined?!!this.viewModel.stateMachine&&this.viewModel.stateMachine.editable:this.editable},me.prototype.isDataChanged=function(){var e,t,i=!1,n=this.viewModel.frameContext.repository.entityCollection.toArray();try{for(var r=U(n),o=r.next();!o.done;o=r.next())if(0<o.value.changes.length){i=!0;break}}catch(a){e={error:a}}finally{try{o&&!o.done&&(t=r["return"])&&t.call(r)}finally{if(e)throw e.error}}return i},me.decorators=[{type:M.Directive,args:[{selector:"[farrisBindingPath]"}]}],me.ctorParameters=function(){return[{type:P.BindingData},{type:P.UIState,decorators:[{type:M.Optional}]},{type:P.FrameEventBus,decorators:[{type:M.Optional}]},{type:P.ViewModel,decorators:[{type:M.Optional}]},{type:N.GridComponent},{type:N.SelectionDirective},{type:T.DialogService},{type:g.DateTimeHelperService},{type:W},{type:k.RuntimeStateService},{type:M.NgZone}]},me.propDecorators={editable:[{type:M.Input,args:["farrisEditable"]}],form:[{type:M.Input,args:["farrisForm"]}],groupField:[{type:M.Input,args:["groupField"]}],groupAggrFields:[{type:M.Input,args:["groupAggrFields"]}],farrisBindingGridOption:[{type:M.Input}],rowClassName:[{type:M.Input}],appendRow:[{type:M.Output,args:["append-row"]}],sortChangeEvent:[{type:M.Output}],rowClass:[{type:M.Output}],selectedRowChange:[{type:M.Output}],selectedCheckboxChange:[{type:M.Output}],aggrColumns:[{type:M.ContentChildren,args:[de]}],onPageChange:[{type:M.HostListener,args:["pageChange",["$event"]]}],selectedKeysChangeHandler:[{type:M.HostListener,args:["selectedKeysChange",["$event"]]}],selectionChangeHandler:[{type:M.HostListener,args:["selectionChange",["$event"]]}],cellClickHandler:[{type:M.HostListener,args:["cellClick",["$event"]]}],cellCloseHandler:[{type:M.HostListener,args:["cellClose",["$event"]]}],enterCell:[{type:M.HostListener,args:["keydown",["$event"]]}]},me);function me(e,t,i,n,r,o,a,s,d,l,p){var u=ge.call(this,r)||this;u.bindingData=e,u.uiState=t,u.eventBus=i,u.viewModel=n,u.grid=r,u.selectionDir=o,u.dialogSer=a,u.dateService=s,u.kendogridFormatSer=d,u.rts=l,u.ngZone=p,u.appendRow=new M.EventEmitter,u.sortChangeEvent=new M.EventEmitter,u.rowClass=new M.EventEmitter,u.hiddenColLen=0,u.rowIndex=0,u.columnIndex=0,u.currentSkip=0,u.isMultipleSelectionMode=!1,u.lastRowIndex=-1,u.selectedRowChange=new M.EventEmitter,u.selectedCheckboxChange=new M.EventEmitter,u.selectionDir.selectedKeys=[],u.viewModel.uiState.setPropertyValue("ids",u.selectionDir.selectedKeys);var c=u.viewModel.frameContext.getFormAppContext();return c&&c.hasOwnProperty("messagePipe")&&c.messagePipe.subscribe(function(e){u.grid.closeCell()}),u}var ve=(Object.defineProperty(be.prototype,"expandLevel",{get:function(){return this.context&&this.context.hasOwnProperty("expandLevel")?this.context.expandLevel:-1},enumerable:!0,configurable:!0}),Object.defineProperty(be.prototype,"component",{get:function(){return this.context&&this.context.component},enumerable:!0,configurable:!0}),Object.defineProperty(be.prototype,"addTreeLoadCompleteListener",{get:function(){return this.context&&this.context.addTreeLoadCompleteListener||function(e){}},enumerable:!0,configurable:!0}),be.prototype.updateTreeNode=function(e,t){this.allNodesData=e,this.initLevelGroup(),this.buildNodesDataMap(t)},be.prototype.build=function(){var r=this,o=[],a={};return this.allNodesData.forEach(function(e){var t=e.id,i=r.getParentId(e);!0===r.isNewNode(e)&&r.expandParentNode(e);var n=r.buildNode(e);a[t]=a[t]||[],n.children=a[t],r.allNodesMap.set(e[r.primaryKey],n),i?(a[i]=a[i]||[],a[i].push(n)):o.push(n)}),o},be.prototype.build1=function(){var n,r=this;this.allNodesData.forEach(function(e){var t=r.getHierarchyInfo(e);if(t){var i=t.layer;isNaN(i)||(n===undefined?n=i:i<n&&(n=i))}});var e=n-1;return this.buildNodes("",e,this.allNodesData,this.allNodes),this.allNodes},be.prototype.buildNodes=function(e,t,o,a){var s=this;this.getChildNodesData(e,t).forEach(function(e){!0===s.isNewNode(e)&&s.expandParentNode(e);var t=s.buildNode(e);a.push(t),s.allNodesMap.set(e[s.primaryKey],t);var i=s.getHierarchyInfo(e),n=i.layer,r=i.path;s.buildNodes(r,n,o,t.children)})},be.prototype.buildNode=function(e){var t=this.isLeaf(e),i=this.shouldExpand(e);!this.isExpanded(e)&&i&&this.expandNode(e);var n=this.buildPaginationInfo(e),r={data:Object.assign({},e),children:[],expanded:i,leaf:t};return n&&(r.pagination=n),r},be.prototype.buildPaginationInfo=function(e){var t=null;if(this.frameContext){var i="_NODE_"+this.getPrimary(e)+"_PAGINATION_INFO_",n=this.frameContext.params.get(i)||null;n&&1<n.pageCount&&(t={pageIndex:n.pageIndex,pageSize:n.pageSize,total:n.totalCount})}return t},be.prototype.shouldExpand=function(e){var t=$([this.getNodeLayer(e),this.isLeaf(e)],2),i=t[0];if(t[1])return!1;var n=this.isExpanded(e);if(!n){var r=this.getPrimary(e);if(-1<this.nodesWaitExpand.findIndex(function(e){return e&&e.id===r}))return!1;if(-1<this.nodesShouldExpand.findIndex(function(e){return e===r}))return!0;if(-1===this.expandLevel)n=!1;else if(0===this.expandLevel)n=!0;else{n=i<=this.expandLevel;var o=this.getOldNode(e);o&&!o.expanded&&(n=!1)}}return n},be.prototype.expandNode=function(e){var t=$([this.getNodePath(e),this.getNodeLayer(e)],2),i=t[0],n=t[1],r=this.getChildNodesData(i,n);if(!r||r.length<1){var o=this.getPrimary(e);this.nodesWaitExpand.findIndex(function(e){return e&&e.id===o})<0&&this.nodesWaitExpand.push({id:o,expanded:!1})}},be.prototype.onTreeLoadComplete=function(){var e=this.nodesWaitExpand.findIndex(function(e){return!e.expanded}),t=this.nodesWaitExpand[e]||{},i=t.id;i&&this.component.findRowNode(i)&&(t.expanded=!0,this.component.expandNode(i))},be.prototype.getPrimary=function(e){return e[this.primaryKey]},be.prototype.getChildNodesData=function(r,o){var a=this,s=[];return this.allNodesData.forEach(function(e){var t=a.getHierarchyInfo(e);if(t){var i=t.layer,n=t.path;i===o+1&&n&&n.startsWith(r)&&s.push(e)}}),s},be.prototype.getHierarchyInfo=function(e){return this.getValue(e,this.hierarchyInfoKey)},be.prototype.initLevelGroup=function(){var i=this;this.levelGroup={},this.allNodesData.forEach(function(e){var t="level"+i.getHierarchyInfo(e).layer;i.levelGroup[t]?i.levelGroup[t].push(e):i.levelGroup[t]=[e]})},be.prototype.getParentId=function(e){var i=this,n=this.getHierarchyInfo(e),t=(this.levelGroup[this.getLevelGroupKey(n.layer-1)]||[]).find(function(e){var t=i.getHierarchyInfo(e);return!0!==t.isDetail&&n.path.startsWith(t.path)});return t?t.id:null},be.prototype.getLevelGroupKey=function(e){return"level"+e},be.prototype.getValue=function(e,t){if(-1===t.indexOf("/"))return e[t];var i=t.split("/").filter(function(e){return e});return i.length<1?e:i.reduce(function(e,t){return e&&e[t]},e)},be.prototype.getNodeLayer=function(e){return this.getHierarchyInfo(e).layer},be.prototype.getNodePath=function(e){return this.getHierarchyInfo(e).path},be.prototype.isExpanded=function(e){var t=this.getOldNode(e);return t?t.expanded:undefined},be.prototype.isLeaf=function(e){return this.getHierarchyInfo(e).isDetail},be.prototype.isNewNode=function(e){return 0!==this.allOldNodesMap.size&&!this.getOldNode(e)},be.prototype.expandParentNode=function(e){var t=this.getParentNode(e);t&&(t.leaf=!1,t.expanded=!0)},be.prototype.getParentNode=function(e){var n=this,t=this.getHierarchyInfo(e),r=t.layer,o=t.path;return Array.from(this.allNodesMap.values()).find(function(e){var t=n.getValue(e.data,n.hierarchyInfoKey).layer,i=n.getValue(e.data,n.hierarchyInfoKey).path;return r===t+1&&!0===o.startsWith(i)})},be.prototype.getOldNode=function(e){var t=e[this.primaryKey];return this.allOldNodesMap.get(t)},be.prototype.buildNodesDataMap=function(e){var t=this;e.forEach(function(e){t.allOldNodesMap.set(e.data[t.primaryKey],e),e.children&&t.buildNodesDataMap(e.children)})},be);function be(e,t,i,n,r){this.levelGroup={},this.nodesWaitExpand=[],this.primaryKey=i,this.hierarchyInfoKey=n,this.allNodes=[],this.allNodesData=e,this.context=r||{},this.nodesWaitExpand=[],this.nodesShouldExpand=r&&r.nodesShouldExpand||[],this.frameContext=r&&r.frameContext||null,this.addTreeLoadCompleteListener(this.onTreeLoadComplete.bind(this)),this.initLevelGroup(),this.allNodesMap=new Map,this.allOldNodesMap=new Map,this.buildNodesDataMap(t)}var Ce=(Object.defineProperty(Se.prototype,"expandLevel",{get:function(){return this.context&&this.context.hasOwnProperty("expandLevel")?this.context.expandLevel:-1},enumerable:!0,configurable:!0}),Object.defineProperty(Se.prototype,"component",{get:function(){return this.context&&this.context.component},enumerable:!0,configurable:!0}),Object.defineProperty(Se.prototype,"addTreeLoadCompleteListener",{get:function(){return this.context&&this.context.addTreeLoadCompleteListener||function(e){}},enumerable:!0,configurable:!0}),Se.prototype.updateTreeNode=function(e,t){this.allNodesData=e,this.buildNodesDataMap(t)},Se.prototype.build=function(){var r=this,o=[],a={},s={};return this.allNodesData.forEach(function(e){var t=e.id,i=r.getHierarchyInfo(e).parentElement;!0===r.isNewNode(e)&&r.expandParentNode(e);var n=r.buildNode(e);a[t]=a[t]||[],n.children=a[t],s[i]=s[i]||[],s[i].push(n),r.allNodesMap.set(e[r.primaryKey],n),i?(a[i]=a[i]||[],a[i].push(n)):o.push(n)}),(!o||o.length<1)&&this.allNodesData&&0<this.allNodesData.length&&Object.keys(s).forEach(function(t){r.allNodesData.find(function(e){return e.id===t})||(o=o.concat(s[t]))}),o},Se.prototype.build1=function(){var n,r=this;this.allNodesData.forEach(function(e){var t=r.getHierarchyInfo(e);if(t){var i=t.layer;isNaN(i)||(n===undefined?n=i:i<n&&(n=i))}});var e=n-1;return this.buildNodes("",e,this.allNodesData,this.allNodes),this.allNodes},Se.prototype.buildNodes=function(e,t,r,o){var a=this;this.getChildNodesData(e,t).forEach(function(e){!0===a.isNewNode(e)&&a.expandParentNode(e);var t=a.buildNode(e);o.push(t),a.allNodesMap.set(e[a.primaryKey],t);var i=a.getHierarchyInfo(e).layer,n=e[a.primaryKey];a.buildNodes(n,i,r,t.children)})},Se.prototype.buildNode=function(e){var t=this.isLeaf(e),i=this.shouldExpand(e);!this.isExpanded(e)&&i&&this.expandNode(e);var n=this.buildPaginationInfo(e),r={data:Object.assign({},e),children:[],expanded:i,leaf:t};return n&&(r.pagination=n),r},Se.prototype.buildPaginationInfo=function(e){var t=null;if(this.frameContext){var i="_NODE_"+this.getPrimary(e)+"_PAGINATION_INFO_",n=this.frameContext.params.get(i)||null;n&&1<n.pageCount&&(t={pageIndex:n.pageIndex,pageSize:n.pageSize,total:n.totalCount})}return t},Se.prototype.shouldExpand=function(e){var t=$([this.isLeaf(e),this.getNodeLayer(e)],2),i=t[0],n=t[1];if(i)return!1;var r=this.isExpanded(e);if(!r){var o=this.getPrimary(e);if(-1<this.nodesWaitExpand.findIndex(function(e){return e&&e.id===o}))return!1;if(-1<this.nodesShouldExpand.findIndex(function(e){return e===o}))return!0;if(-1===this.expandLevel)r=!1;else if(0===this.expandLevel)r=!0;else{r=n<=this.expandLevel;var a=this.getOldNode(e);a&&!a.expanded&&(r=!1)}}return r},Se.prototype.expandNode=function(e){var t=$([e[this.primaryKey],this.getNodeLayer(e)],2),i=t[0],n=t[1],r=this.getChildNodesData(i,n);if(!r||r.length<1){var o=this.getPrimary(e);this.nodesWaitExpand.findIndex(function(e){return e&&e.id===o})<0&&this.nodesWaitExpand.push({id:o,expanded:!1})}},Se.prototype.onTreeLoadComplete=function(){var e=this.nodesWaitExpand.findIndex(function(e){return!e.expanded}),t=this.nodesWaitExpand[e]||{},i=t.id;i&&this.component.findRowNode(i)&&(t.expanded=!0,this.component.expandNode(i))},Se.prototype.getPrimary=function(e){return e[this.primaryKey]},Se.prototype.getChildNodesData=function(r,o){var a=this,s=[];return this.allNodesData.forEach(function(e){var t=a.getHierarchyInfo(e);if(t){var i=t.layer,n=t.parentElement;i!==o+1||n!==r&&(n||""!==r)||s.push(e)}}),s},Se.prototype.getHierarchyInfo=function(e){return this.getValue(e,this.hierarchyInfoKey)},Se.prototype.getValue=function(e,t){var i=t.split("/").filter(function(e){return e});return i.length<1?e:i.reduce(function(e,t){return e&&e[t]},e)},Se.prototype.getNodeLayer=function(e){return this.getHierarchyInfo(e).layer},Se.prototype.getNodeParentElement=function(e){return this.getHierarchyInfo(e).parentElement},Se.prototype.isExpanded=function(e){var t=this.getOldNode(e);return t?t.expanded:undefined},Se.prototype.isLeaf=function(e){return this.getHierarchyInfo(e).isDetail},Se.prototype.isNewNode=function(e){return 0!==this.allOldNodesMap.size&&!this.getOldNode(e)},Se.prototype.expandParentNode=function(e){var t=this.getParentNode(e);t&&(t.leaf=!1,t.expanded=!0)},Se.prototype.getParentNode=function(e){var i=this,t=this.getHierarchyInfo(e),n=t.layer,r=t.parentElement;return Array.from(this.allNodesMap.values()).find(function(e){var t=i.getValue(e.data,i.hierarchyInfoKey).layer;return e.data[i.primaryKey]===r&&n===t+1})},Se.prototype.getOldNode=function(e){var t=e[this.primaryKey];return this.allOldNodesMap.get(t)},Se.prototype.buildNodesDataMap=function(e){var t=this;e.forEach(function(e){t.allOldNodesMap.set(e.data[t.primaryKey],e),e.children&&t.buildNodesDataMap(e.children)})},Se);function Se(e,t,i,n,r){this.nodesWaitExpand=[],this.primaryKey=i,this.hierarchyInfoKey=n,this.allNodes=[],this.allNodesData=e,this.context=r||{},this.nodesWaitExpand=[],this.nodesShouldExpand=r&&r.nodesShouldExpand||[],this.frameContext=r&&r.frameContext||null,this.addTreeLoadCompleteListener(this.onTreeLoadComplete.bind(this)),this.allNodesMap=new Map,this.allOldNodesMap=new Map,this.buildNodesDataMap(t)}var Ie=(De.getBuilder=function(e){var t=ve;return e.hasOwnProperty("path")?t=ve:e.hasOwnProperty("parentElement")&&(t=Ce),t},De);function De(){}var xe=(Object.defineProperty(we.prototype,"bindingData",{get:function(){return this.frameContext.bindingData},enumerable:!0,configurable:!0}),Object.defineProperty(we.prototype,"bindingList",{get:function(){return this.bindingData.list},enumerable:!0,configurable:!0}),Object.defineProperty(we.prototype,"prop",{get:function(){return this._PROP},set:function(e){this._PROP=e},enumerable:!0,configurable:!0}),Object.defineProperty(we.prototype,"viewModel",{get:function(){return this.frameContext.viewModel},enumerable:!0,configurable:!0}),we.prototype.ngOnInit=function(){var i=this;this.frameContext.getVirtualRootFrameContext().setParam("hierarchyInfoKey",this.hierarchyInfoKey),this.bindData(),this.bindingData.changes.subscribe(function(e){!e||e.type!==P.ChangeType.ValueChanged&&e.type!==P.ChangeType.PaginationInfoChange?i.bindData():i.renderSubject.next(e);var t=i.bindingList.currentId;!i.frameContext.bindingData.rowSelectedEventSuspend&&t&&i.setSelectedIdToTree(i.bindingList.currentId),i.updateCheckedRows(e)}),this.treetableFormatSer.setFormat(this.treeTable),this.rowClass.emit(this.treeTable),this.cellClass.emit(this.treeTable),this.setComponentRef(),this.setNodePaginationInfo(),this.registerEvent()},we.prototype.ngOnChanges=function(e){},we.prototype.registerEvent=function(){var o=this;this.treeTable.columnSorted.subscribe(function(e){var t=e.sortName,i=void 0===t?null:t,n=e.sortOrder,r=void 0===n?null:n;!1===o.treeTable.remoteSort&&i&&r&&o.bindingList.sortBy(i,r),o.bindData()})},we.prototype.setComponentRef=function(){var e=this.viewModel&&this.viewModel.frameContext&&this.viewModel.frameContext.getFormAppContext(),t=this.viewModel&&this.viewModel.frameContext&&this.viewModel.frameContext.frameId,i=this.treeTable&&this.treeTable.el.nativeElement.id||null;if(t&&i){var n=e&&e.componentRefs&&e.componentRefs.get(t)||new Map;e&&e.componentRefs&&e.componentRefs.set(t,n.set(i,this.treeTable))}},we.prototype.setNodePaginationInfo=function(){if(this.frameContext){var e=this.treeTable.paginationForChildren||!1;this.frameContext.params.set("enableNodePagination",e);var t=this.nodePageSize||0;this.frameContext.params.set("nodePageSize",t)}},we.prototype.bindData=function(){var e=this.treeTable.data,t=this.bindingList.toJSON({ignoreMultiLangInput:!0}),i=[];if((this.prop=t)&&0<t.length){var n=t[0][this.hierarchyInfoKey],r=this.builder;if(r||(this.builder=Ie.getBuilder(n),r=this.builder),null==r)throw new Error("TreeTable builder is null!");var o=-1,a=this.treeTable.expandLevel;void 0!==a&&(o=a);var s=(this.frameContext.getVirtualRootFrameContext().params.get("_DEVKIT_expandRowIds")||"").split(",")||[],d={expandLevel:o,addTreeLoadCompleteListener:this.addTreeLoadCompleteListener.bind(this),component:this.treeTable,storage:this.storage,nodesShouldExpand:s,frameContext:this.frameContext};this.treeNodesBuilder=new r(t,e,this.bindingList.primaryKey,this.hierarchyInfoKey,d),i=this.treeNodesBuilder.build()}this.treeTable.data=i,this.updatePageInfo(this.treeTable),this.onTreeLoadComplete()},we.prototype.onTreeLoadComplete=function(){this.listeners&&0<this.listeners.length&&this.listeners.forEach(function(e){e()})},we.prototype.addTreeLoadCompleteListener=function(e){this.listeners.push(e)},we.prototype.shouldComponentUpdate=function(e){return JSON.stringify(this.prop)!==JSON.stringify(e)},we.prototype.getSelectedIdFromTree=function(){var e=this.treeTable.selectedRow;return e?e.data.id:null},we.prototype.setSelectedIdToTree=function(e){if(e){var t=this.getSelectedIdFromTree(),i=this.frameContext.params.get("_NODE_PAGE_CHANGED_")||!1;t||!i?t!==e&&(this.treeTable.clearSelections(),this.treeTable.selectNode(e)):this.frameContext.params["delete"]("_NODE_PAGE_CHANGED_")}},we.prototype.setCurrentIdToBindingList=function(e){var t=this.bindingData.list.currentId;this.treeTable.multiSelect||(this.setChecks(e),this.setCheckedRows([e])),t!==e&&this.bindingData.list.setCurrentId(e,!0)},we.prototype.updateCheckedRows=function(e){if(e.type===P.ChangeType.Load)this.setCheckedRows();else if(e.type===P.ChangeType.ValueChanged||e.type===P.ChangeType.Remove){var t=this.getChecks();e.id&&t.includes(e.id)&&this.setCheckedRows()}},we.prototype.setCheckedRows=function(e){var n=this;if(void 0===e&&(e=this.viewModel.uiState.ids||[]),Array.isArray(e)){var r=this.bindingList.toJSON(),o=this.viewModel.uiState.rows||new Map,a=new Map;e.forEach(function(t){var e=r.find(function(e){return e[n.bindingList.primaryKey]===t}),i=o.get(t);e?a.set(t,e):i&&a.set(t,i)}),this.viewModel.uiState.setPropertyValue("rows",a)}},we.prototype.setChecks=function(e){"string"==typeof e&&(e=e.split(",").filter(function(e){return e})),this.viewModel.uiState.setPropertyValue("ids",e)},we.prototype.getChecks=function(){return this.viewModel.uiState.ids||[]},we.prototype.getPagingInfo=function(){var e=this.viewModel.bindingPath,t=this.viewModel.bindingData.pagingInfo;return"/"===e||e.substr(1).split("/").filter(function(e){return!!e&&0<e.length}).map(function(e){return e.substring(0,e.length-1)}).forEach(function(e){t=t&&t[e]}),t},we.prototype.updatePageInfo=function(e){var t=this.getPagingInfo(),i=t.pageIndex,n=t.pageSize,r=t.total;0!==n?(e.pagination=!0,e.updatePageInfo({pageIndex:i,pageSize:n,total:r})):e.pagination=!1},we.prototype.selectionChangeHandler=function(e){if(e&&e.node&&e.node.hasOwnProperty("data")){var t=this.treeTable.idField,i=e.node.data[t];this.setCurrentIdToBindingList(i)}},we.prototype.checkValuesChange=function(e){this.setChecks(this.treeTable.checkValues),this.setCheckedRows()},we.prototype.expandHandler=function(e){var t=e.data.id,i=this.frameContext.getVirtualRootFrameContext(),n=i.getParam("TREE_LATEST_EXPANDED_ID")||[];n.push(t),i.setParam("TREE_LATEST_EXPANDED_ID",n)},we.prototype.onPageChanged=function(e){var t=e||{},i=t.pageSize,n=void 0===i?20:i,r=t.pageIndex,o=void 0===r?1:r;o<1&&(o=1);var a=(o-1)*n;this.bindingData.setPagingInfo(a,n,this.bindingData.bindingPath)},we.prototype.onPageSizeChanged=function(e){var t=e||20;this.bindingData.setPagingInfo(0,t,this.bindingData.bindingPath)},we.prototype.onNodePageChanged=function(e){var t=e.pageIndex,i=void 0===t?1:t,n=e.pageSize,r=(void 0===n&&this.nodePageSize,e.node),o=void 0===r?{}:r,a=o&&o.id||null;if(a){var s=this.frameContext.getVirtualRootFrameContext(),d=s.getParam("TREE_LATEST_EXPANDED_ID")||[];d.push(a),s.setParam("TREE_LATEST_EXPANDED_ID",d),this.frameContext.params.set("_NODE_"+a+"_PAGE_INDEX_",i),this.frameContext.params.set("_RELOAD_CHILDREN_",!0),this.frameContext.params.set("_NODE_PAGE_CHANGED_",!0)}},we.decorators=[{type:M.Directive,args:[{selector:"[farrisTreeTableBinding]"}]}],we.ctorParameters=function(){return[{type:i.TreeTableComponent},{type:Q},{type:P.FrameContext}]},we.propDecorators={hierarchyInfoKey:[{type:M.Input,args:["farrisHierarchyInfoKey"]}],rowClassName:[{type:M.Input}],cellClassName:[{type:M.Input}],nodePageSize:[{type:M.Input,args:["nodePageSize"]}],rowClass:[{type:M.Output}],cellClass:[{type:M.Output}],selectionChangeHandler:[{type:M.HostListener,args:["nodeSelected",["$event"]]}],checkValuesChange:[{type:M.HostListener,args:["checkValuesChange",["$event"]]}],expandHandler:[{type:M.HostListener,args:["expand",["$event"]]}],onPageChanged:[{type:M.HostListener,args:["pageChanged",["$event"]]}],onPageSizeChanged:[{type:M.HostListener,args:["pageSizeChanged",["$event"]]}],onNodePageChanged:[{type:M.HostListener,args:["childsPageChanged",["$event"]]}]},we);function we(e,t,i){var n=this;this.treeTable=e,this.treetableFormatSer=t,this.frameContext=i,this.renderSubject=new u.Subject,this.nodePageSize=100,this.rowClass=new M.EventEmitter,this.cellClass=new M.EventEmitter,this._PROP=null,this.listeners=[],this.storage=[],this.viewModel.uiState.setPropertyValue("ids",this.treeTable.checkValues),this.renderSubject.pipe(y.debounceTime(500)).subscribe(function(){n.bindData()})}var Ee=(Pe.prototype.ngOnInit=function(){var i=this;this.lookup.selectedData.subscribe(function(e){var t=i.mapfields||i.lookup.mapFields;i.mappingData(e,t)}),this.lookup.clear.subscribe(function(){var e=i.mapfields||i.lookup.mapFields;i.mappingData(null,e)})},Pe.prototype.mappingData=function(e,t){if(t){var i=this.vm.frameContext.appContext;i.changeDetectionController.detach();var n,r,o,a=Object.keys(t);n=this.getBindingPathArray();var s=this.getMapFieldsPrimaryKey(t,n);r=s&&s.map(function(e){return e.primaryKey})||[],o=s&&s.map(function(e){return e.primaryField})||[],a=this.sortMapFieldKeys(a,r),e||a.reverse(),this.mapping(a,t,e,o,n),i.changeDetectionController.reattach()}},Pe.prototype.mapping=function(e,o,a,s,d){var l=this;e.forEach(function(e){var t=l.getHelpValue(e,a),i=o[e].split(","),n=i.filter(function(e){return s.includes(e)}),r=i.filter(function(e){return!s.includes(e)});i=a?[].concat(n).concat(r):[].concat(r).concat(n),l.updateTarget(i,d,a,t)})},Pe.prototype.updateTarget=function(e,t,i,n){var r=this;e.forEach(function(e){r.updateTargetValue(t,e,n,i)})},Pe.prototype.updateTargetValue=function(e,t,i,n){if(this.target){var r=t.split(".");this.setValue(this.target,r,i)}else r=e.concat(t.split(".")),n?this.vm.bindingData.setValue(r,i,!0,!0,null,{frameContext:this.vm.frameContext}):this.vm.bindingData.clearValue(r,!0,!0,{frameContext:this.vm.frameContext})},Pe.prototype.getHelpValue=function(t,e){var i=this,n="";return e&&(n=e instanceof Array?e.map(function(e){return i.getValue(t,e)}).join(","):this.getValue(t,e)),n},Pe.prototype.getValue=function(e,t){return-1===e.indexOf(".")?t[e]:e.split(".").reduce(function(e,t){return e[t]},t)},Pe.prototype.setValue=function(e,t,i){e&&(t.length<=1?e[t[0]]=i:t.slice(0,-1).reduce(function(e,t){return e.hasOwnProperty(t)||e.__proto__.hasOwnProperty(t)||(e[t]={}),e[t]},e)[t[t.length-1]]=i)},Pe.prototype.getBindingPathArray=function(){var e=this.vm.bindingPath;return e?e.split("/").filter(function(e){return""!==e}):[]},Pe.prototype.isNumberValue=function(e,t){var i=this.getValue(e,t);return s.isNumber(i)},Pe.prototype.getMapFieldsPrimaryKey=function(t,r){if(!t||Object.keys(t).length<1)return null;var o=[];try{var a=this.vm.frameContext.repository.entityTypeInfo;Object.keys(t).forEach(function(n){var e=t[n];e&&"string"==typeof e&&e.split(",").filter(function(e){return e}).forEach(function(e){var t=e.split(".");r&&0<r.length&&(t=r.concat(t));var i=a.getPropInfoByPath(t);i&&i.metadataInfo&&!0===i.metadataInfo.primary&&o.push({primaryKey:n,primaryField:e})})})}catch(e){console.error(e)}return o},Pe.prototype.sortMapFieldKeys=function(e,t){return!t||t.length<1||!e||e.length<1?e:(t=J(new Set(t)),e=e.filter(function(e){return!t.includes(e)}),[].concat(t).concat(e))},Pe.decorators=[{type:M.Directive,args:[{selector:"[data-mapping]"}]}],Pe.ctorParameters=function(){return[{type:P.ViewModel,decorators:[{type:M.Optional}]},{type:D.LookupGridComponent,decorators:[{type:M.Optional},{type:M.Self}]}]},Pe.propDecorators={mapfields:[{type:M.Input,args:["data-mapping"]}],target:[{type:M.Input,args:["target"]}]},Pe);function Pe(e,t){this.vm=e,this.lookup=t,this.target=null}var Le=(Oe.prototype.ngOnInit=function(){if(this.frameContext&&this.lookup&&!0===this.enableExtendLoadMethod){var e=this.frameContext.repository.apiUri,t=this.lookup.uri+"@"+e;this.frameContext.setParam(t,!0)}},Oe.decorators=[{type:M.Directive,args:[{selector:"[enableExtendLoadMethod]"}]}],Oe.ctorParameters=function(){return[{type:P.FrameContext,decorators:[{type:M.Optional}]},{type:D.LookupGridComponent,decorators:[{type:M.Optional},{type:M.Self}]}]},Oe.propDecorators={enableExtendLoadMethod:[{type:M.Input}]},Oe);function Oe(e,t){this.frameContext=e,this.lookup=t}var Te=(Object.defineProperty(Me.prototype,"bindingObject",{get:function(){return this._bindingObject},set:function(e){this._bindingObject=e,!this.differ&&e&&this.differs&&"object"==typeof e&&(this.differ=this.differs.find(e).create())},enumerable:!0,configurable:!0}),Me.prototype.onValueChange=function(e){this.hostComboComponent&&this.bindingObject&&(e?(this.bindingObject.key=e.value,this.bindingObject.value=e.name):(this.bindingObject.key=null,this.bindingObject.value=null))},Me.prototype.ngOnInit=function(){this.hostComboComponent?this.hostComboComponent.valuePrimitive=!1:this.hostHelpComponent?this.bindObjectToHostLookup():this.hostComboListComponent?this.bindObjectToHostComboList():this.hostComboLookupComponent&&this.bindObjectToHostComboLookup()},Me.prototype.ngDoCheck=function(){this.differ&&"object"==typeof this.bindingObject?this.differ&&this.differ.diff(this.bindingObject)&&this.bindingChanges():this.bindingChanges()},Me.prototype.bindingChanges=function(){var e=this.bindingObject?this.bindingObject.value:null,t=this.bindingObject?this.bindingObject.key:null;if(this.hostComboComponent){this.hostComboComponent.text=e;var i=this.hostComboComponent.valueField,n=this.hostComboComponent.data.find(function(e){return e[i]===t});this.hostComboComponent.writeValue(n)}else this.hostHelpComponent?(this.hostHelpComponent.writeValue(e),this.hostHelpComponent.displayValue=t):this.hostComboListComponent?this.hostComboListComponent.writeValue(t):this.hostComboLookupComponent&&(this.hostComboLookupComponent.selectedValues=t,this.hostComboLookupComponent.writeValue(e))},Me.prototype.ngOnChanges=function(e){e.bindingObject&&!this.differ&&this.bindingChanges()},Me.prototype.bindObjectToHostLookup=function(){var r=this;this.hostHelpComponent&&(this.hostHelpComponent.selectedData.subscribe(function(e){return r.updateHelpBindingObject(e)}),this.hostHelpComponent.clear.subscribe(function(){r.updateHelpBindingObject(null)}),this.hostHelpComponent.nosearch&&this.hostHelpComponent.valueChanged.subscribe(function(e){var t,i=r.hostHelpComponent.idField,n=r.hostHelpComponent.textField;r.updateHelpBindingObject(((t={})[i]=e,t[n]=e,t))}))},Me.prototype.bindObjectToHostComboList=function(){var t=this;this.hostComboListComponent&&(this.hostComboListComponent.valueChange.subscribe(function(e){return t.updateHelpBindingObject(e.selections)}),this.hostComboListComponent.clear.subscribe(function(){t.updateHelpBindingObject(null)}))},Me.prototype.bindObjectToHostComboLookup=function(){var i=this;this.hostComboLookupComponent&&(this.hostComboLookupComponent.multiSelect?this.hostComboLookupComponent.valueChange.subscribe(function(e){return i.updateHelpBindingObject(e.selections)}):this.hostComboLookupComponent.selectChange.subscribe(function(e){var t=e;e.data&&(t=e.data),i.updateHelpBindingObject(t)}),this.hostComboLookupComponent.clear.subscribe(function(){i.updateHelpBindingObject(null)}))},Me.prototype.updateHelpBindingObject=function(e){var t,i;this.hostHelpComponent&&(t=this.hostHelpComponent.idField,i=this.hostHelpComponent.textField),this.hostComboListComponent&&(t=this.hostComboListComponent.idField,i=this.hostComboListComponent.textField),this.hostComboLookupComponent&&(t=this.hostComboLookupComponent.idField,i=this.hostComboLookupComponent.textField),this.emitUiStateBinding(e,t,i)},Me.prototype.emitUiStateBinding=function(e,t,i){var n={key:null,value:null};e&&(Array.isArray(e)?(n.key=e.map(function(e){return e[t]}).join(","),n.value=e.map(function(e){return-1<i.indexOf(".")?i.split(".").reduce(function(e,t){return e[t]},e):e[i]}).join(",")):(t&&(n.key=e[t]),i&&(-1<i.indexOf(".")?n.value=i.split(".").reduce(function(e,t){return e[t]},e):n.value=e[i]))),this.UIStateBindingChange.emit(n)},Me.decorators=[{type:M.Directive,args:[{selector:"[UIStateBinding]"}]}],Me.ctorParameters=function(){return[{type:n.ComboBoxComponent,decorators:[{type:M.Host},{type:M.Self},{type:M.Optional}]},{type:D.LookupGridComponent,decorators:[{type:M.Host},{type:M.Self},{type:M.Optional}]},{type:M.KeyValueDiffers,decorators:[{type:M.Optional}]},{type:r.ComboListComponent,decorators:[{type:M.Host},{type:M.Self},{type:M.Optional}]},{type:I.ComboLookupComponent,decorators:[{type:M.Host},{type:M.Self},{type:M.Optional}]}]},Me.propDecorators={bindingObject:[{type:M.Input,args:["UIStateBinding"]}],UIStateBindingChange:[{type:M.Output}],onValueChange:[{type:M.HostListener,args:["valueChange",["$event"]]}]},Me);function Me(e,t,i,n,r){this.hostComboComponent=e,this.hostHelpComponent=t,this.differs=i,this.hostComboListComponent=n,this.hostComboLookupComponent=r,this.differ=null,this.UIStateBindingChange=new M.EventEmitter}var Fe=(Ne.prototype.ngOnInit=function(){},Ne.prototype.ngOnChanges=function(e){this.maskElement||this.createMaskElement(),e.kendoGridDisabled&&this.maskElement&&(this.kendoGridDisabled?this.renderer.removeStyle(this.maskElement,"display"):this.renderer.setStyle(this.maskElement,"display","none"))},Ne.prototype.createMaskElement=function(){this.maskElement=this.renderer.createElement("div"),this.renderer.setStyle(this.maskElement,"width","100%"),this.renderer.setStyle(this.maskElement,"height","100%"),this.renderer.setStyle(this.maskElement,"position","absolute"),this.renderer.setStyle(this.maskElement,"background-color","rgba(255,255,255,0.5)"),this.renderer.setStyle(this.maskElement,"z-index","3"),this.renderer.setStyle(this.maskElement,"display","none"),this.renderer.appendChild(this.el.nativeElement,this.maskElement)},Ne.decorators=[{type:M.Directive,args:[{selector:"[farrisDisabled]"}]}],Ne.ctorParameters=function(){return[{type:N.GridComponent},{type:M.ElementRef},{type:M.Renderer2}]},Ne.propDecorators={kendoGridDisabled:[{type:M.Input,args:["farrisDisabled"]}]},Ne);function Ne(e,t,i){this.grid=e,this.el=t,this.renderer=i}var ke=(Re.decorators=[{type:M.Directive,args:[{selector:"[farrisSort]"}]}],Re);function Re(){}var je=(Ve.decorators=[{type:M.Directive,args:[{selector:"[farris-textarea-edit]"}]}],Ve);function Ve(){}var He=(Be.decorators=[{type:M.Directive,args:[{selector:"[farrisDynamicColumnFormat]"}]}],Be);function Be(){}var Ae=(Ke.decorators=[{type:M.Directive,args:[{selector:"[farris-enter-edit]"}]}],Ke.propDecorators={farrisForm:[{type:M.Input,args:["form-group"]}]},Ke);function Ke(){}var _e=(ze.decorators=[{type:M.Directive,args:[{selector:"[farrisTreeTableFormat]"}]}],ze);function ze(){}var Ge=(Object.defineProperty(qe.prototype,"props",{get:function(){return this._PROPS},set:function(e){this._PROPS=e},enumerable:!0,configurable:!0}),qe.prototype.ngOnInit=function(){var t=this,e=(this.getPagingInfo()||{}).pageSize,i=void 0===e?0:e;0!==i&&(!this.grid.pageList||this.grid.pageList.length<1)&&"function"==typeof this.grid.setPageList&&this.grid.setPageList([i,2*i,3*i,4*i]),this.setComponentRef(),this.bindData(),window.setTimeout(function(){t.updateSelectedRow()},0),this.registerBindingDataChangeEvent(),this.renderGridSubject.pipe(y.debounceTime(500)).subscribe(function(e){t.bindData(e)})},qe.prototype.ngOnChanges=function(e){this.bindData()},Object.defineProperty(qe.prototype,"primaryKey",{get:function(){return this.bindingList.primaryKey},enumerable:!0,configurable:!0}),Object.defineProperty(qe.prototype,"bindingList",{get:function(){if("/"===this.viewModel.bindingPath||!this.viewModel.bindingPath)return this.bindingData.list;var e=this.viewModel.bindingPath.substr(1),t=(e=e[0].toLowerCase()+e.substring(1,e.length)).split("/").filter(function(e){return""!==e});return this.bindingData.getValue(t)},enumerable:!0,configurable:!0}),qe.prototype.setComponentRef=function(){var e=this.viewModel&&this.viewModel.frameContext&&this.viewModel.frameContext.getFormAppContext(),t=this.viewModel&&this.viewModel.frameContext&&this.viewModel.frameContext.frameId,i=this.grid&&this.grid.id;if(t&&i){var n=e&&e.componentRefs&&e.componentRefs.get(t)||new Map;e&&e.componentRefs&&e.componentRefs.set(t,n.set(i,this.grid))}},qe.prototype.getPagingInfo=function(){var e=this.viewModel.bindingPath,t=this.viewModel.bindingData,i=t.pagingInfo;if("/"===e)return i;var n=e.substr(1).split("/").filter(function(e){return!!e&&0<e.length}),r=n[n.length-1];r=r.substr(0,r.length-1);var o=n.slice(0,n.length-1),a=t.getValue(o);if(a&&a[a.primaryKey]){var s=i[r+"_"+a[a.primaryKey]]||{};return s.hasOwnProperty("totalCount")&&(s.total=s.totalCount),s}return{}},qe.prototype.shouldComponentUpdate=function(e,t){var i=this.buildProps(t);if(this.viewModel.frameContext.appContext.runMode===P.RunMode.highSpeed&&e&&(e.type===P.ChangeType.Load||e.type===P.ChangeType.Remove||e.type===P.ChangeType.PaginationInfoChange))return{result:!0,props:i};var n=this.buildGridProps();return JSON.stringify(i)===JSON.stringify(n)?{result:!1}:{result:!0,props:i}},qe.prototype.registerEvent=function(){var l=this;this.grid&&this.grid.columnSorted&&this.grid.columnSorted.subscribe(function(e){if(l.grid.remoteSort){var t=l.grid&&l.grid.groupField||null,i=l.grid.sortName&&l.grid.sortName.split(",")||[],n=l.grid.sortOrder&&l.grid.sortOrder.split(",")||[];t&&(i.includes(t)||(i.splice(0,0,t),n.splice(0,0,"asc")));var r=l.viewModel&&l.viewModel.frameContext.repository.entityType||null;if(0<i.length&&r){var o=new P.DataTypeInfo(r);i=i.map(function(e){var t=e.split("."),i=o.getPropInfoByPath(t);return i&&i.metadataInfo.path||null})}var a=i.join(","),s=n.join(",")||"asc",d=l.viewModel&&l.viewModel.frameContext||null;d&&d.repository.sortConditionManager.setConditions(l.viewModel.bindingPath,a,s)}else l.sortFields=l.grid.sortName,l.sortDirections=l.grid.sortOrder,l.sortBindingList()}),this.grid&&this.grid.filterChanged&&this.grid.filterChanged.subscribe(function(e){if(l.filters=e,!l.grid.remoteFilter){if(0<l.bindingList.length&&!l.bindingList.currentId){var t=l.bindingList.getIdByIndex(0);l.bindingList.setCurrentId(t)}l.bindData()}})},qe.prototype.sortBindingList=function(){var e=this.grid&&this.grid.groupField||null;if(e){var t=this.sortFields&&this.sortFields.split(",")||[];if(!t.includes(e)){t.splice(0,0,e);var i=this.sortDirections&&this.sortDirections.split(",")||[];i.splice(0,0,"asc"),this.sortFields=t.join(","),this.sortDirections=i.join(",")||"asc"}}this.sortFields&&this.sortDirections&&this.bindingList.sortBy(this.sortFields,this.sortDirections),this.bindData()},qe.prototype.bindData=function(e){var t=this,i=this.grid&&this.grid.remoteFilter||!1;if(!this.sortFields||this.grid.editable||!e||"Load"!==e.type&&"SelectionChanged"!==e.type){(!0===this.grid.editable||e&&e.type===P.ChangeType.Append)&&this.filters&&0<Object.keys(this.filters).length&&!i&&(this.filters={},this.grid.clearCondition());var n=this.bindingList.toJSON();if(this.filters&&0<Object.keys(this.filters).length&&!i&&(n=this.grid.clientFilterService.executeFilter(n,this.filters)),this.filters&&0<Object.keys(this.filters).length&&!i&&(!e||e&&e.type!==P.ChangeType.SelectionChanged&&e.type!==P.ChangeType.GlobalSelectionChanged))if(n&&0<n.length){if(!n.find(function(e){return e[t.bindingList.primaryKey]===t.bindingList.currentId})){var r=n[0][this.bindingList.primaryKey];this.bindingList.setCurrentId(r,!0,!0)}}else this.bindingList.setCurrentId(null,!0,!0,!0),this.grid.multiSelect||this.setChecks([]);var o=this.shouldComponentUpdate(e,n);o.result&&(this.renderGrid(o.props),this.props=JSON.parse(JSON.stringify(o.props)))}else this.sortBindingList()},qe.prototype.renderGrid=function(e){var t=e.pageIndex,i=e.pageSize,n=e.total,r=e.pagination,o=e.data,a=this.grid.virtualizedAsyncLoad||!1;this.grid.total=n,this.grid.pageSize=i,this.grid.pageIndex=t,this.grid.pagination=r,this.grid.controlPaginationState=!1,0===i&&(this.grid.pagination=!1,this.grid.pageIndex=1),a?this.grid.loadVirtualData({items:o,pageIndex:t,pageSize:i,total:n}):this.grid.loadData(o)},qe.prototype.buildProps=function(e){var t;t=void 0!==e?e:this.bindingList.toJSON();var i=this.getPagingInfo()||{},n=i.pageIndex,r=void 0===n?1:n,o=i.pageSize,a=void 0===o?0:o,s=(this.getPagingInfo()||{}).total,d=void 0===s?0:s;return 0===a&&0===d&&(d=t.length),{data:t,pageIndex:r,pageSize:a,total:d,pagination:0!==a}},qe.prototype.buildGridProps=function(){var e=this.grid.data||[],t={pageIndex:this.grid.pageIndex,pageSize:this.grid.pageSize},i=t.pageIndex,n=void 0===i?1:i,r=t.pageSize,o=void 0===r?0:r,a=this.grid.total||0;return 0===o&&0===a&&(a=e.length),{data:e,pageIndex:n,pageSize:o,total:a,pagination:this.grid.pagination}},qe.prototype.onBindingDataChange=function(e){e&&e.type===P.ChangeType.ValueChanged?this.renderGridSubject.next(e):!e||e.type!==P.ChangeType.SelectionChanged&&e.type!==P.ChangeType.GlobalSelectionChanged?this.bindData(e):this.bindingList.currentId===(this.grid.selectedRow&&this.grid.selectedRow.id)&&0<this.grid.total||this.bindData(e),this.updateSelectedRow(e),this.updateData(e),this.endCellEdit(e),this.updateCheckedRows(e)},qe.prototype.endCellEdit=function(e){var t=this.grid.isEditing();e.type===P.ChangeType.Load&&t&&this.grid.endCellEdit()},qe.prototype.updateSelectedRow=function(e){if(this.bindingList&&this.bindingList.currentId&&(!this.viewModel||!0!==this.viewModel.frameContext.bindingData.rowSelectedEventSuspend)){var t=(this.grid.selectedRow||{}).id,i=void 0===t?null:t,n=this.bindingList.currentId;if(i!==n)this.selectGridRow(this.bindingList.currentId);else{var r=e&&e.path.toString()===this.viewModel.bindingPath.split("/").filter(function(e){return e}).toString();e&&e.type===P.ChangeType.Load&&r&&(this.grid.clearSelections(),this.grid.selectRow(n,!0,!0))}}},qe.prototype.registerBindingDataChangeEvent=function(){var t=this;this.bindingDataChangeEvent=this.bindingData.changes.subscribe(function(e){t.onBindingDataChange(e)}),this.viewModel.frameContext.appContext.messagePipe.subscribe(function(e){"bindData"===e&&t.bindData()})},qe.prototype.unRegisterBindingDataChangeEvent=function(){this.bindingDataChangeEvent&&"function"==typeof this.bindingDataChangeEvent.unsubscribe&&this.bindingDataChangeEvent.unsubscribe()},qe.prototype.updateData=function(e){var t=this;if(e&&(e.type===P.ChangeType.SelectionChanged||e.type===P.ChangeType.Load)){var i=this.viewModel.bindingPath,n="/"+e.path.join("/"),r=this.viewModel.frameContext.appContext.params.get("retrieveing")||!1;if(!(e.path.length<1||"/"===i||i===n)&&i.startsWith(n)&&!r){var o=P.EntityPathConverter.toEntityPathArray(this.viewModel.bindingPath,this.bindingData),a=o.slice(0,o.length-1),s=this.bindingList.parent;if(s&&s[s.primaryKey]){var d=this.viewModel.bindingPath.split("/").filter(function(e){return e}),l=d[d.length-1],p="/"+(l=l.substr(0,l.length-1)),u=(this.viewModel.frameContext.repository.entityCollection.getPaginationConfigByPath(p)||{}).pageIndex,c=void 0===u?1:u,h=(this.viewModel.frameContext.repository.entityCollection.getPaginationConfigByPath(p)||this.viewModel.frameContext.repository.entityCollection.getPaginationConfigByPath(l)||{}).pageSize,g=void 0===h?0:h,f=this.viewModel.frameContext.appContext.params.get("queryChild")||!1;f&&(c=1),e.type===P.ChangeType.SelectionChanged&&f&&this.viewModel.frameContext.appContext.params.set("forceQueryChild",!0),this.viewModel.frameContext.repository.queryChild(a,c,g).pipe(y.finalize(function(){return t.viewModel.frameContext.appContext.params["delete"]("forceQueryChild")})).subscribe()}}}},qe.prototype.ngOnDestroy=function(){this.unRegisterBindingDataChangeEvent()},qe.prototype.fireSelectedRowChange=function(e){this.selectedRowChange.emit(e)},qe.prototype.clearCheckedRows=function(e){e.type===P.ChangeType.Load&&this.grid.multiSelect&&this.checkIfChangeMatchBindingPath(e)&&(this.setChecks([]),"function"==typeof this.grid.clearCheckeds&&this.grid.clearCheckeds())},qe.prototype.setSelectionIdToBindingData=function(e){if(!e)return this.bindingList.currentId=e,void(this.grid.multiSelect||this.setChecks([]));this.bindingList.currentId!==e&&this.bindingList.setCurrentId(e,!0),this.grid.multiSelect||this.setChecks([e])},qe.prototype.updateCheckedRows=function(e){if(e.type===P.ChangeType.Load)this.setCheckedRows();else if(e.type===P.ChangeType.ValueChanged){var t=this.getChecks();e.id&&t.includes(e.id)&&this.setCheckedRows()}},qe.prototype.setChecks=function(e){this.viewModel.uiState.setPropertyValue("ids",e),this.setCheckedRows(e)},qe.prototype.getChecks=function(){return this.viewModel.uiState.ids||[]},qe.prototype.setCheckedRows=function(e){var n=this;if(void 0===e&&(e=this.viewModel.uiState.ids||[]),Array.isArray(e)&&!(e.length<1)){var r=[];r=this.viewModel.frameContext.appContext.runMode===P.RunMode.highSpeed?this.grid.data||[]:this.bindingList.toJSON();var o=this.viewModel.uiState.rows||new Map,a=new Map;e.forEach(function(t){var e=r.find(function(e){return e[n.primaryKey]===t}),i=o.get(t);e?a.set(t,e):i&&a.set(t,i)}),this.viewModel.uiState.setPropertyValue("rows",a)}},qe.prototype.selectGridRow=function(e){this.grid.selectRow(e),this.grid.scrollToCurrentRow()},qe.prototype.pageChangedHandler=function(e){var t=e.pageIndex,i=e.pageSize;t<1&&(t=1);var n=(t-1)*i;this.bindingData.setPagingInfo(n,i,this.bindingData.bindingPath)},qe.prototype.selectedRowChanged=function(e){e.index;var t=e.data[this.primaryKey];this.setSelectionIdToBindingData(t),this.fireSelectedRowChange(e)},qe.prototype.unSelected=function(e){if(e){var t=e.data;(void 0===t?{}:t)[this.primaryKey]===this.bindingList.currentId&&this.setSelectionIdToBindingData(null)}},qe.prototype.checkedChanged=function(e){var t=(e=e||[]).map(function(e){return e.id});this.setChecks(t)},qe.prototype.pageSizeChanged=function(e){e.pageIndex;var t=e.pageSize;this.bindingData.setPagingInfo(0,t,this.bindingData.bindingPath)},qe.prototype.scrollY=function(e){var t=e.pager,i=e.pageSize,n=(t-1)*i;this.bindingData.setPagingInfo(n,i,this.bindingData.bindingPath)},qe.prototype.filterChanged=function(e){this.filters=e},qe.prototype.checkIfChangeMatchBindingPath=function(e){var t=!1;if(!e||!e.path)return t;var i=e.path;if(!i)return t;if(!this.bindingData&&!this.bindingData.bindingPath)return t;var n=this.bindingData.bindingPath.split("/");return n.length<=0||(0===i.length?"/"===this.bindingData.bindingPath&&(t=!0):1===e.path.length?2===n.length&&n[1]===e.path[0]&&(t=!0):2===e.path.length&&3===n.length&&n[1]===e.path[0]&&n[2]===e.path[1]&&(t=!0)),t},qe.decorators=[{type:M.Directive,args:[{selector:"[farris-use-binding-data]"}]}],qe.ctorParameters=function(){return[{type:P.BindingData},{type:P.ViewModel},{type:l.DatagridComponent}]},qe.propDecorators={selectedRowChange:[{type:M.Output}],pageChangedHandler:[{type:M.HostListener,args:["pageChanged",["$event"]]}],selectedRowChanged:[{type:M.HostListener,args:["selectChanged",["$event"]]}],unSelected:[{type:M.HostListener,args:["unSelect",["$event"]]}],checkedChanged:[{type:M.HostListener,args:["checkedChange",["$event"]]}],pageSizeChanged:[{type:M.HostListener,args:["pageSizeChanged",["$event"]]}],scrollY:[{type:M.HostListener,args:["scrollYLoad",["$event"]]}],filterChanged:[{type:M.HostListener,args:["filterChanged",["$event"]]}]},qe);function qe(e,t,i){this.bindingData=e,this.viewModel=t,this.grid=i,this.sortFields=null,this.sortDirections=null,this.parentId=null,this.filters=null,this.renderGridSubject=new u.Subject,this.selectedRowChange=new M.EventEmitter,this.setChecks([]),this.registerEvent()}var Ue=($e.prototype.ngOnInit=function(){var t=this;this.multiSelectComponent.dataSource=[],Array.isArray(this.dataSource)?(this.multiSelectComponent.dataSource=this.dataSource,this.originalDataSource=this.dataSource):this.dataSource&&this.dataSource.changes&&this.dataSource.changes.subscribe(function(e){"Load"===e.type&&(t.originalDataSource=e.value,t.multiSelectComponent.isTree()?(t.fjmField?t.multiSelectComponent.dataSource=t.plainToTree(e.value,t.fjmField,1):t.fjdField&&(t.multiSelectComponent.dataSource=t.buildTreeNodesByFjd(e.value,t.fjdField)),t.multiSelectComponent.selections=t.getTreeSelectionsById(t.selectedId,t.originalDataSource)):(t.multiSelectComponent.dataSource=e.value,t.multiSelectComponent.selections=t.getListSelectionsById(t.selectedId,t.multiSelectComponent.dataSource)))}),this.selectIdBindingToUIStateField()},$e.prototype.selectIdBindingToUIStateField=function(){var t=this;this.multiSelectComponent&&this.multiSelectComponent.selectedIdChange&&this.multiSelectComponent.selectedIdChange.subscribe(function(e){t.selectedIdChanged.emit(e)})},$e.prototype.formatDataSource=function(e,n){var r=this;return e&&e.length?e.map(function(e){var t,i=e.toJSON?e.toJSON():e;return{data:Object.assign(q({},i),(t={},t[""+r.idField]=e[r.idField],t[""+r.textField]=e[r.textField],t[""+r.valueField]=e[r.valueField],t[""+n]=e[n],t)),children:[]}}):[]},$e.prototype.plainToTree=function(e,t,i){var n=this.formatDataSource(e,t);if(!n.length)return console.log("数据为空，不能转换成树形结构"),[];if(!n[0].data[t])return console.log("需要转换成树形结构的关键字段不存在"),[];var r=n.filter(function(e){return e.data[t].layer===i});return this.recursive(r,n,t,1),r},$e.prototype.recursive=function(e,s,d,l){var p=this;e.forEach(function(r){var o=r.data[d].path,a=r.data[d].layer;!1===r.data[d].isDetail&&s.forEach(function(e){if(e&&e.data&&e.data[d]&&e.data[d].path){var t=e.data[d].path,i=e.data[d].layer,n=void 0;t&&t.length>o.length&&(n=t.substr(0,4*Number(l))),o===n&&a===i-1&&r.children.push(e),!1===e.data[d].isDetail&&o===n&&p.recursive([e],s,d,Number(l)+1)}})})},$e.prototype.getListSelectionsById=function(t,i){var n=[],r=this;if("string"==typeof t&&t||"number"==typeof t){var e=i.find(function(e){return e&&e[r.idField]===t});e&&n.push(e)}else Array.isArray(t)&&i?t.forEach(function(t){var e=i.find(function(e){return e&&e[r.idField]===t});e&&n.push(e)}):n=[];return n},$e.prototype.getTreeSelectionsById=function(t,i){var n=[],r=this;if("string"==typeof t&&t||"number"==typeof t){var e=i.find(function(e){return e&&e[r.idField]===t});e&&n.push(e)}else Array.isArray(t)&&i?t.forEach(function(t){var e=i.find(function(e){return e&&e[r.idField]===t});e&&n.push(e)}):n=[];return n},$e.prototype.buildTreeNodesByFjd=function(e,i){var n=this,r=this.formatDataSource(e,i);return r.forEach(function(t){var e=r.find(function(e){return t.data[i].parentElement===e.data[n.idField]});e&&e.children.push(t)}),r.filter(function(e){return!e.data[i].parentElement})},$e.decorators=[{type:M.Directive,args:[{selector:"[multiSelectDataMapping]"}]}],$e.ctorParameters=function(){return[{type:P.ViewModel,decorators:[{type:M.Optional}]},{type:o.MultiSelectComponent,decorators:[{type:M.Host},{type:M.Self},{type:M.Optional}]}]},$e.propDecorators={dataSource:[{type:M.Input}],idField:[{type:M.Input}],textField:[{type:M.Input}],valueField:[{type:M.Input}],fjmField:[{type:M.Input}],fjdField:[{type:M.Input}],uiStateField:[{type:M.Input}],selectedId:[{type:M.Input}],selectedIdChanged:[{type:M.Output}]},$e);function $e(e,t){var i=this;this.vm=e,this.multiSelectComponent=t,this.selectedIdChanged=new M.EventEmitter,this.vm.uiState.changes.subscribe(function(e){i.selectedId=e.value})}var Je=(Object.defineProperty(We.prototype,"primaryKey",{get:function(){return this.bindingList.primaryKey},enumerable:!0,configurable:!0}),We.prototype.ngOnInit=function(){this.bindData(),this.registerBindingDataChangeEvent()},We.prototype.ngOnChanges=function(){this.bindData()},We.prototype.ngOnDestroy=function(){this.unRegisterBindingDataChangeEvent()},We.prototype.getPagingInfo=function(){var e=this.viewModel.bindingPath,t=this.viewModel.bindingData.pagingInfo;return"/"===e||e.substr(1).split("/").filter(function(e){return!!e&&0<e.length}).map(function(e){return e.substring(0,e.length-1)}).forEach(function(e){t=t&&t[e]}),t},We.prototype.setListViewPageProps=function(){var e=this.bindingList.toJSON(),t=this.getPagingInfo()||{},i=t.pageIndex,n=void 0===i?1:i,r=t.pageSize,o=void 0===r?0:r,a=(this.getPagingInfo()||{}).total,s=void 0===a?0:a;0===o&&0===s&&(s=e.length),this.listview.supportPaging=this.supportPaged;var d=this.listview.pageIndex=n,l=this.listview.pageSize=o,p=this.listview.total=s;0===o&&(this.listview.pageIndex=n,d=1,p=this.listview.total=s),this.listview.paginationOptions&&(this.listview.paginationOptions.itemsPerPage=l,this.listview.paginationOptions.currentPage=d,this.listview.paginationOptions.pageList=this.listview.pageList,this.listview.paginationOptions.totalItems=p);var u=this.listview.cdr;u&&u.detectChanges();var c=this.listview.pager&&this.listview.pager.paginationDirective;if(c&&c.service)try{c.service.instances[this.listview.pager.id]=q({},this.listview.paginationOptions),c.service.setTotalItems(p),c.changeDetectorRef.detectChanges()}catch(h){}},Object.defineProperty(We.prototype,"bindingList",{get:function(){if("/"===this.viewModel.bindingPath||!this.viewModel.bindingPath)return this.bindingData.list;var e=this.viewModel.bindingPath.substr(1),t=(e=e[0].toLowerCase()+e.substring(1,e.length)).split("/").filter(function(e){return""!==e});return this.bindingData.getValue(t)},enumerable:!0,configurable:!0}),We.prototype.bindData=function(){this.setListViewPageProps();var e=this.bindingList.toArray();this.listview.setData(e)},We.prototype.fireSelectedRowChange=function(e){this.selectedRowChange.emit(e)},We.prototype.setSelectionIdToBindingData=function(e){this.bindingList.setCurrentId(e,!0)},We.prototype.onBindingDataChange=function(e){this.bindData(),this.updateSelectedRow(e)},We.prototype.updateSelectedRow=function(e){if(this.bindingList&&this.bindingList.currentId&&(!this.viewModel||!0!==this.viewModel.frameContext.bindingData.rowSelectedEventSuspend)){var t=(this.listview.clickItem||{}).id;(void 0===t?null:t)!==this.bindingList.currentId&&this.selectRow(this.bindingList.currentId)}},We.prototype.selectRow=function(e){this.listview&&"function"==typeof this.listview.selectRow&&this.listview.selectRow(e)},We.prototype.registerBindingDataChangeEvent=function(){var t=this;this.bindingDataChangeEvent=this.bindingData.changes.subscribe(function(e){t.onBindingDataChange(e)})},We.prototype.unRegisterBindingDataChangeEvent=function(){this.bindingDataChangeEvent.unsubscribe()},We.prototype.setChecks=function(e){this.viewModel.uiState.setPropertyValue("ids",e)},We.prototype.changeRow=function(e){var t=e.index,i=e.data;if(!1===e.checkChangeEvent||!e.hasOwnProperty("checkChangeEvent")){if(i&&Array.isArray(i)&&0<i.length){var n=i[0]&&i[0][this.primaryKey]||null;n&&this.setSelectionIdToBindingData(n)}this.listview.activeIndex=t,this.fireSelectedRowChange(e)}},We.prototype.pageChangedHandler=function(e){var t=e.pageInfo.pageIndex,i=e.pageInfo.pageSize;t<1&&(t=1);var n=(t-1)*i;this.bindingData.setPagingInfo(n,i,this.bindingData.bindingPath)},We.prototype.pageSizeChangedHandler=function(e){var t=e.pageInfo,i=t.pageIndex,n=t.pageSize,r=(i-1)*+n;this.bindingData.setPagingInfo(r,n,this.bindingData.bindingPath)},We.prototype.checkValuesChange=function(e){var t=e;this.setChecks(t)},We.decorators=[{type:M.Directive,args:[{selector:"[farrisListviewBinding]"}]}],We.ctorParameters=function(){return[{type:P.BindingData},{type:P.ViewModel},{type:a.ListViewComponent}]},We.propDecorators={supportPaged:[{type:M.Input}],selectedRowChange:[{type:M.Output}],changeRow:[{type:M.HostListener,args:["listClick",["$event"]]}],pageChangedHandler:[{type:M.HostListener,args:["pageChanged",["$event"]]}],pageSizeChangedHandler:[{type:M.HostListener,args:["pageSizeChanged",["$event"]]}],checkValuesChange:[{type:M.HostListener,args:["checkValuesChange",["$event"]]}]},We);function We(e,t,i){this.bindingData=e,this.viewModel=t,this.listview=i,this.supportPaged=!0,this.selectedRowChange=new M.EventEmitter}var Ye=(Object.defineProperty(Qe.prototype,"bindingList",{get:function(){if("/"===this.viewModel.bindingPath||!this.viewModel.bindingPath)return this.bindingData.list;var e=this.viewModel.bindingPath.substr(1),t=(e=e[0].toLowerCase()+e.substring(1,e.length)).split("/").filter(function(e){return""!==e});return this.bindingData.getValue(t)},enumerable:!0,configurable:!0}),Qe.prototype.ngOnInit=function(){this.apply()},Qe.prototype.ngOnChanges=function(e){this.apply()},Qe.prototype.ngOnDestroy=function(){this.detach()},Qe.prototype.apply=function(){this.grid&&(this.handleGroupStatus(),this.gridEditable?(this.grid.editable=!0,this.grid.disableHeader(!0),this.handleBeginEditEvent(),this.handleAfterEditEvent(),this.handleEndEditEvent()):(this.grid.editable=!1,this.grid.disableHeader(!1),this.grid&&"function"==typeof this.grid.sort&&this.grid.sortName&&this.grid.sort(),this.detach()))},Qe.prototype.handleGroupStatus=function(){if(!1!==this.disableGroupOnEditing){var e=this.grid&&this.grid.groupField||null;if(e)this.gridEditable&&(this.groupFields=[e],this.grid.setGroupFields(""));else if(this.groupFields&&0<this.groupFields.length){var t=this.groupFields.pop();0<this.groupFields.length&&(this.groupFields=[]),this.grid.setGroupFields(t)}}},Qe.prototype.handleBeginEditEvent=function(){var r=this;this.beginEditSubscription=this.grid.beginEdit.subscribe(function(e){if(e){var t=e.column;if(t&&t.editor){var i=e.editor.componentRef.instance;if(!i||!i.instance)return;var n=i.instance.mapFields;"lookup"!==t.editor.type&&"PersonnelSelector"!==t.editor.type&&"external-integration"!==t.editor.type||i.instance.selectedData.subscribe(function(e){n=i.instance.mapFields,r.lookupMapping(e,n)}),"combo-lookup"===t.editor.type&&i.instance.valueChange.subscribe(function(e){n=i.instance.mapFields,r.lookupMapping(e.selections||[],n)}),i.instance.clear&&i.instance.clear.subscribe(function(){r.lookupMapping(null,n)}),"combolist"===t.editor.type&&n&&i.instance.valueChange.subscribe(function(e){var t=r.getBindingPathArray();r.viewModel.bindingData.setValue(t.concat(n.split(".")),i.instance.selectedValues,!0,!0)})}}})},Qe.prototype.handleAfterEditEvent=function(){var r=this;this.grid.afterEdit=function(e,t,i,n){return r.dialogSer.hasDialogOpened()?u.of(!1):r.rts&&r.rts.getFormState("lookup.pending")?u.of(!1):n&&n.formControl?u.of(!0):u.of(!1)}},Qe.prototype.handleEndEditEvent=function(){var l=this;this.endEditSubscription=this.grid&&this.grid.endEdit&&this.grid.endEdit.subscribe(function(e){var t=e||{},i=t.value,n=void 0===i?undefined:i,r=t.column,o=void 0===r?undefined:r,a=t.rowData,s=void 0===a?{}:a,d=s&&s[l.grid.idField]||null;l.updateBindingData(n,o,d)})},Qe.prototype.updateBindingData=function(e,t,i){if(t){var n=t.dataType,r=t.field.split("."),o=t&&t.editor&&t.editor.options&&t.editor.options.bigNumber;if("date"===n){var a=this.dateService.formatTo(e,"yyyy-MM-dd");this.updateBindingList(i,r.join("."),a)}else"datetime"===n?this.updateBindingList(i,r.join("."),e):"number"!==n||o?this.updateBindingList(i,r.join("."),e):null===e||e===undefined?this.updateBindingList(i,r.join("."),null):this.updateBindingList(i,r.join("."),Number(e))}},Qe.prototype.updateBindingList=function(e,t,i){if(this.viewModel&&t){var n=t.split(".").filter(function(e){return e}),r=this.getBindingPathArray(),o=this.bindingData.getValue(r);if(o&&e===o.currentItem.primaryKeyValue){var a=r.concat(n);this.bindingData.setValue(a,i,!0,!0)}else{var s=this.bindingList.findById(e);if(s)if(n.length<2)s.setValue(t,i,!0,!0);else{var d=null,l=n.slice(0,n.length-1),p=n[n.length-1];l.forEach(function(e){d=d&&d[e]||s[e]}),d.setValue(p,i,!0,!0)}}}},Qe.prototype.detach=function(){this.beginEditSubscription&&"function"==typeof this.beginEditSubscription.unsubscribe&&this.beginEditSubscription.unsubscribe(),this.endEditSubscription&&"function"==typeof this.endEditSubscription.unsubscribe&&this.endEditSubscription.unsubscribe()},Qe.prototype.lookupMapping=function(o,a){var s=this;if(a){var e=this.viewModel.frameContext.appContext;e.changeDetectionController.detach();var d=this.getBindingPathArray(),t=Object.keys(a),i=this.getMapFieldsPrimaryKey(a,d),n=i&&i.map(function(e){return e.primaryKey})||[],l=i&&i.map(function(e){return e.primaryField})||[];n&&0<n.length&&(n=J(new Set(n)),t=this.sortMapFieldKeys(t,n)),o||t.reverse(),t.forEach(function(t){var i="";o&&(i=o instanceof Array?o.map(function(e){return s.getValue(t,e)}).join(","):s.getValue(t,o));var e=a[t].split(","),n=e.filter(function(e){return l.includes(e)}),r=e.filter(function(e){return!l.includes(e)});(e=o?[].concat(n).concat(r):[].concat(r).concat(n)).forEach(function(e){o?s.viewModel.bindingData.setValue(d.concat(e.split(".")),i,!0,!0):s.viewModel.bindingData.clearValue(d.concat(e.split(".")),!0,!0)})}),e.changeDetectionController.reattach()}},Qe.prototype.getValue=function(e,t){return-1===e.indexOf(".")?t[e]:e.split(".").reduce(function(e,t){return e[t]},t)},Qe.prototype.getBindingPathArray=function(){var e=this.viewModel.bindingPath;return e?e.split("/").filter(function(e){return""!==e}):[]},Qe.prototype.isNumberValue=function(e,t){var i=this.getValue(e,t);return s.isNumber(i)},Qe.prototype.getMapFieldsPrimaryKey=function(t,r){if(!t||Object.keys(t).length<1)return null;var o=[];try{var a=this.viewModel.frameContext.repository.entityTypeInfo;Object.keys(t).forEach(function(n){var e=t[n];e&&"string"==typeof e&&e.split(",").filter(function(e){return e}).forEach(function(e){var t=e.split(".");r&&0<r.length&&(t=r.concat(t));var i=a.getPropInfoByPath(t);i&&i.metadataInfo&&!0===i.metadataInfo.primary&&o.push({primaryKey:n,primaryField:e})})})}catch(e){console.error(e)}return o},Qe.prototype.sortMapFieldKeys=function(e,t){return!t||t.length<1||!e||e.length<1?e:(e=e.filter(function(e){return!t.includes(e)}),[].concat(t).concat(e))},Qe.decorators=[{type:M.Directive,args:[{selector:"[farris-datagrid-editable]"}]}],Qe.ctorParameters=function(){return[{type:P.BindingData},{type:P.ViewModel},{type:l.DatagridComponent},{type:g.DateTimeHelperService},{type:M.Injector},{type:k.RuntimeStateService},{type:T.DialogService},{type:M.NgZone}]},Qe.propDecorators={gridEditable:[{type:M.Input,args:["farris-datagrid-editable"]}],disableGroupOnEditing:[{type:M.Input,args:["disableGroupOnEditing"]}]},Qe);function Qe(e,t,i,n,r,o,a,s){this.bindingData=e,this.viewModel=t,this.grid=i,this.dateService=n,this.injector=r,this.rts=o,this.dialogSer=a,this.ngZone=s,this.disableGroupOnEditing=!0,this.groupFields=[]}var Xe=(Ze.prototype.ngOnDestroy=function(){},Ze);function Ze(e){var t=this;this.appContext=e,this.messagePipe=this.appContext&&this.appContext.messagePipe,this.messagePipe&&this.messagePipe.subscribe(function(e){e&&"endEdit"===e.type&&t.endEdit(e)})}var et,tt=(G(it,et=Xe),it.prototype.ngOnInit=function(){this.elementRef&&(this.nativeElement=this.elementRef.nativeElement)},it.prototype.endEdit=function(e){if(this.nativeElement){var t=this.nativeElement.parentNode||this.nativeElement.parentElement,i=t&&Array.from(t.getElementsByTagName("input"))||[];i&&0<i.length&&i.forEach(function(e){e&&"function"==typeof e.blur&&e.blur()})}},it.decorators=[{type:M.Directive,args:[{selector:"[input-end-edit]"}]}],it.ctorParameters=function(){return[{type:P.AppContext},{type:M.ElementRef}]},it);function it(e,t){var i=et.call(this,e)||this;return i.appContext=e,i.elementRef=t,i}var nt,rt=(G(ot,nt=Xe),ot.prototype.endEdit=function(e){this.datagrid&&"function"==typeof this.datagrid.endCellEdit&&this.datagrid.endCellEdit()},ot.decorators=[{type:M.Directive,args:[{selector:"[farris-grid-end-edit]"}]}],ot.ctorParameters=function(){return[{type:P.AppContext},{type:l.DatagridComponent}]},ot);function ot(e,t){var i=nt.call(this,e)||this;return i.appContext=e,i.datagrid=t,i}var at,st=(G(dt,at=Xe),dt.prototype.endEdit=function(e){this.editor&&"function"==typeof this.editor.endEdit&&this.editor.endEdit()},dt.decorators=[{type:M.Directive,args:[{selector:"[html-editor-end-edit]"}]}],dt.ctorParameters=function(){return[{type:P.AppContext},{type:d.HtmlEditorComponent}]},dt);function dt(e,t){var i=at.call(this,e)||this;return i.appContext=e,i.editor=t,i}var lt,pt=(G(ut,lt=Xe),ut.prototype.endEdit=function(e){this.grid&&"function"==typeof this.grid.closeCell&&this.grid.closeCell()},ut.decorators=[{type:M.Directive,args:[{selector:"[kendo-grid-end-edit]"}]}],ut.ctorParameters=function(){return[{type:P.AppContext},{type:N.GridComponent}]},ut);function ut(e,t){var i=lt.call(this,e)||this;return i.appContext=e,i.grid=t,i}var ct=(ht.prototype.execute=function(e,t){if(e&&""!==e&&"undefined"!==e){var i=this.viewModel;return t&&(i=i.frameContext.appContext.frameContextManager.getFrameContextById(t).viewModel),i[e]()}},ht.decorators=[{type:M.Directive,args:[{selector:"[farris-remote-summary-command]"}]}],ht.ctorParameters=function(){return[{type:P.ViewModel},{type:l.DatagridComponent}]},ht.propDecorators={remoteSummaryCommand:[{type:M.Input,args:["farris-remote-summary-command"]}]},ht);function ht(e,t){var n=this;this.viewModel=e,this.grid=t;var i=this.viewModel.frameContext.getFormAppContext();i&&i.hasOwnProperty("messagePipe")&&i.messagePipe.subscribe(function(e){if("query"===(e&&e.type||null)&&n.remoteSummaryCommand&&"server"===n.grid.footerDataFrom){var t=n.remoteSummaryCommand.split("."),i=null;t.forEach(function(e){i=i&&i[e]||n[e]}),"function"==typeof i&&i().subscribe(function(e){n.grid.footerData=e})}})}var gt=(Object.defineProperty(ft.prototype,"focusState",{set:function(e){this._state.next(e)},enumerable:!0,configurable:!0}),ft.prototype.ngOnInit=function(){var t=this;this.selfEl=this.el.nativeElement,this._state.subscribe(function(e){!1===e&&t.selfEl&&("farris-html-editor"===t.selfEl.nodeName.toLowerCase()?t.setHtmlEditorFocus():t.setFocus())})},ft.prototype.setFocus=function(){var e=this.selfEl.querySelectorAll("input");e.length?e[0].focus():this.selfEl.focus()},ft.prototype.setHtmlEditorFocus=function(){var e=this.selfEl.querySelector('div[contenteditable="true"]'),t=window.getSelection();t.selectAllChildren(e),t.collapseToEnd()},ft.decorators=[{type:M.Directive,args:[{selector:"[farris-set-focus]"}]}],ft.ctorParameters=function(){return[{type:M.Renderer2},{type:M.Injector},{type:M.ElementRef}]},ft.propDecorators={focusState:[{type:M.Input}]},ft);function ft(e,t,i){this.rd=e,this.injector=t,this.el=i,this._state=new u.BehaviorSubject({})}var yt=(Object.defineProperty(mt.prototype,"bindingData",{get:function(){return this.frameContext.bindingData},enumerable:!0,configurable:!0}),Object.defineProperty(mt.prototype,"bindingList",{get:function(){return this.bindingData.getList()},enumerable:!0,configurable:!0}),mt.prototype.ngOnInit=function(){var t=this;this.bindData(),this.bindingData.changes.subscribe(function(e){e.type!==P.ChangeType.Load&&e.type!==P.ChangeType.Append&&e.type!==P.ChangeType.Remove||t.bindData()})},mt.prototype.ngOnChanges=function(e){},mt.prototype.bindData=function(){var e=this.getFileInfos();this.componentRef&&(this.componentRef.fileInfos=e)},mt.prototype.getFileInfos=function(){var n=this,e=this.bindingList.toJSON(),r=this.bindingList.primaryKey,o=[];return e.forEach(function(e){n.getValueByPath(e,r);var t=n.getValueByPath(e,n.fileIdKey),i={id:t,name:n.getValueByPath(e,n.fileNameKey),size:n.getValueByPath(e,n.fileSizeKey),createTime:n.getValueByPath(e,n.fileCreateTimeKey),originalData:e,extend:{metadataId:t}};o.push(i)}),o},mt.prototype.getValueByPath=function(e,t){var i=t.split("."),n=e;return i.forEach(function(e){n=n[e]}),n},mt.prototype.getUdtPaths=function(){var e=this.fileIdKey.split(".");return e.pop(),e},Object.defineProperty(mt.prototype,"fileSizeKey",{get:function(){return this.getUdtPaths().concat(["fileSize"]).join(".")},enumerable:!0,configurable:!0}),Object.defineProperty(mt.prototype,"fileCreateTimeKey",{get:function(){return this.getUdtPaths().concat(["fileCreateTime"]).join(".")},enumerable:!0,configurable:!0}),Object.defineProperty(mt.prototype,"componentRef",{get:function(){return this.previewComponent||this.uploadAndPreviewComponent||null},enumerable:!0,configurable:!0}),mt.decorators=[{type:M.Directive,args:[{selector:"[farrisFilePreviewBinding]"}]}],mt.ctorParameters=function(){return[{type:p.FFilePreviewComponent,decorators:[{type:M.Optional}]},{type:P.FrameContext},{type:p.UploadAndPreviewComponent,decorators:[{type:M.Optional}]},{type:M.Injector,decorators:[{type:M.Optional}]}]},mt.propDecorators={fileIdKey:[{type:M.Input,args:["farrisFileIdKey"]}],fileNameKey:[{type:M.Input,args:["farrisFileNameKey"]}]},mt);function mt(e,t,i,n){this.previewComponent=e,this.frameContext=t,this.uploadAndPreviewComponent=i,this.injector=n}var vt="DISCUSSION_REPLY_MESSAGE_INFO",bt=(Ct.prototype.ngOnInit=function(){var t=this;this.discussionEditorComponent.replyUser=this.viewModel.frameContext.root.viewModel.uiState[vt]||{},this.viewModel.frameContext.root.viewModel.uiState.changes.subscribe(function(e){e.field===vt&&(t.discussionEditorComponent.replyUser=t.viewModel.frameContext.root.viewModel.uiState[vt]||{})}),this.queryFrequentAtUsersCommand?this.queryFrequentAtUsers():this.queryAtUsers(),this.queryAllOrgs()},Ct.prototype.queryAllOrgs=function(){var t=this;this.execute(this.queryAllOrgsCommand).subscribe(function(e){e&&(t.discussionEditorComponent.sectionData=e)})},Ct.prototype.queryAtUsers=function(){var n=this;this.execute(this.userQueryCommand).subscribe(function(e){if(e){var t=e.users,i=void 0===t?[]:t;n.discussionEditorComponent.personnels=i}})},Ct.prototype.queryFrequentAtUsers=function(){var t=this;this.execute(this.queryFrequentAtUsersCommand).subscribe(function(e){e&&(t.discussionEditorComponent.personnels=e&&e.users||[])})},Ct.prototype.pageChangedHandler=function(e){var t=this,i=e||{},n=i.msgInfo,r=void 0===n?0:n,o=i.text,a=void 0===o?"":o,s=i.visibility,d=void 0===s?"ALL":s,l=i.parentId,p=void 0===l?null:l;1===r?this.execute(this.addCommentCommand,{text:a,parentId:p,visibility:d}).pipe(y.tap(function(){t.viewModel.frameContext.appContext.messagePipe.next("onCommentAdd")}),y.catchError(function(e){return u.EMPTY})).subscribe():(this.viewModel.frameContext.root.viewModel.uiState[vt]={},this.discussionEditorComponent.replyUser={})},Ct.prototype.execute=function(e,t){var i=this;if(!e||""===e||"undefined"===e)return u.of(null);void 0===t&&(t={});var n=e.split("."),r=null;return n.forEach(function(e){r=r&&r[e]||i[e]}),"function"==typeof r?r(t):u.of(null)},Ct.decorators=[{type:M.Directive,args:[{selector:"[farris-discussion-editor-binding]"}]}],Ct.ctorParameters=function(){return[{type:M.Injector},{type:c.DiscussionEditorComponent},{type:P.ViewModel}]},Ct.propDecorators={userQueryCommand:[{type:M.Input,args:["userQueryCommand"]}],addCommentCommand:[{type:M.Input,args:["addCommentCommand"]}],queryAllOrgsCommand:[{type:M.Input,args:["queryAllOrgsCommand"]}],queryFrequentAtUsersCommand:[{type:M.Input,args:["queryFrequentAtUsersCommand"]}],pageChangedHandler:[{type:M.HostListener,args:["valueChange",["$event"]]}]},Ct);function Ct(e,t,i){this.injector=e,this.discussionEditorComponent=t,this.viewModel=i}var St=(It.prototype.ngOnInit=function(){var t=this;this.viewModel.frameContext.appContext.messagePipe.subscribe(function(e){"onCommentAdd"===e&&t.queryComments()}),this.viewModel.bindingData.changes.subscribe(function(e){e.type!==P.ChangeType.Load&&e.type!==P.ChangeType.SelectionChanged||t.queryComments()})},It.prototype.queryComments=function(e,t){var s=this;void 0===e&&(e=this.discussionListComponent.pageIndex-1||0),void 0===t&&(t=this.discussionListComponent.supportPaging?this.discussionListComponent.pageSize:1e4),this.execute(this.commentsQueryCommand,{pageIndex:e,pageSize:t}).pipe(y.catchError(function(e){return u.EMPTY})).subscribe(function(e){if(e){e.comments;var t=e.pageIndex,i=void 0===t?0:t,n=e.pageSize,r=void 0===n?10:n,o=e.totalCount,a=void 0===o?0:o;s.discussionListComponent.pageIndex=parseInt(i)+1,s.discussionListComponent.supportPaging&&(s.discussionListComponent.pageSize=r),s.discussionListComponent.total=a,s.discussionListDirective.discussionListData=e}})},It.prototype.replyMessagedHandler=function(e){this.viewModel.frameContext.root.viewModel.uiState.setPropertyValue("DISCUSSION_REPLY_MESSAGE_INFO",e)},It.prototype.pageChangedHandler=function(e){var t=e.pageInfo||{},i=t.pageIndex,n=void 0===i?1:i,r=t.pageSize,o=void 0===r?10:r;this.queryComments(n-1,o)},It.prototype.execute=function(e,t){var i=this;if(!e||""===e||"undefined"===e)return u.of(null);var n=e.split("."),r=null;return n.forEach(function(e){r=r&&r[e]||i[e]}),"function"==typeof r?r(t):u.of(null)},It.decorators=[{type:M.Directive,args:[{selector:"[farris-discussion-list-binding]"}]}],It.ctorParameters=function(){return[{type:M.Injector},{type:c.DiscussionListComponent},{type:P.ViewModel},{type:c.DiscussionListDirective}]},It.propDecorators={commentsQueryCommand:[{type:M.Input,args:["commentsQueryCommand"]}],replyMessagedHandler:[{type:M.HostListener,args:["replyMessage",["$event"]]}],pageChangedHandler:[{type:M.HostListener,args:["pageChanged",["$event"]]}]},It);function It(e,t,i,n){this.injector=e,this.discussionListComponent=t,this.viewModel=i,this.discussionListDirective=n}var Dt=(Object.defineProperty(xt.prototype,"bindingData",{get:function(){return this.frameContext.bindingData},enumerable:!0,configurable:!0}),Object.defineProperty(xt.prototype,"bindingList",{get:function(){return this.bindingData.getList()},enumerable:!0,configurable:!0}),xt.prototype.getHierarchyInfoField=function(){var e=this.hierarchyInfoKey.split("/");return e[e.length-1]},xt.prototype.ngOnChanges=function(e){},xt.prototype.ngOnInit=function(){var t=this;this.hierarchyInfoField=this.getHierarchyInfoField(),this.frameContext.getVirtualRootFrameContext().setParam("hierarchyInfoKey",this.hierarchyInfoKey),this.bindingData.changes.subscribe(function(e){t.bindData(e),t.updateSelectedRow(e)}),this.frameContext.viewModel.uiState.setPropertyValue("ids",[])},xt.prototype.getEntityArr=function(){var e=this.frameContext.repository.entityCollection,t=this.frameContext.bindingData.bindingPath;if(!t||"/"===t)return e.toArray();var i=this.frameContext.bindingData.list,n=t.split("/").filter(function(e){return e}),r=[];return n.forEach(function(e){r.push(i.primaryKey+":"+i.currentId),r.push(e),i=i.currentItem[e]}),e.getEntitiesByPath(r).toArray()},xt.prototype.setActualIndex=function(t,e){var i=this;if(!(t.length<1)){var n={index:0},r=t[0].primaryKey;e.forEach(function(e){i.traverseTree(e,n,t,r)})}},xt.prototype.traverseTree=function(t,i,n,r){var o=this,e=n.find(function(e){return e[r]===t.data[r]});e&&(Object.defineProperty(e,"__ACTUAL_INDEX__",{value:i.index}),i.index++),t.children.forEach(function(e){o.traverseTree(e,i,n,r)})},xt.prototype.handleChange=function(e){if(!e)return!1;switch(e.type){case P.ChangeType.SelectionChanged:case P.ChangeType.GlobalSelectionChanged:return this.handleSelectionChanged(e);case P.ChangeType.ValueChanged:return this.handleValueChanged(e);default:return!1}},xt.prototype.handleSelectionChanged=function(e){if(e.type===P.ChangeType.SelectionChanged||e.type===P.ChangeType.GlobalSelectionChanged){var t=e.path,i=this.bindingData.bindingPath.split("/").filter(function(e){return e});if(t.length===i.length){for(var n=!0,r=0;r<t.length;r++)t[r]!==i[r]&&(n=!1);if(n)return!0}}return!1},xt.prototype.handleValueChanged=function(e){var t,i,n,r;if(e.type!==P.ChangeType.ValueChanged)return!1;var o=e.path,a=this.bindingData.bindingPath.split("/").filter(function(e){return e});try{for(var s=U(a),d=s.next();!d.done;d=s.next()){var l=d.value;if(0<o.length){if(l!==o[0])return!1;o.shift()}}}catch(b){t={error:b}}finally{try{d&&!d.done&&(i=s["return"])&&i.call(s)}finally{if(t)throw t.error}}var p=e.id;if(p){var u=this.bindingList.primaryKey,c=this.treeTable.value,h=null;try{for(var g=U(c),f=g.next();!f.done;f=g.next()){var y=f.value,m=this.findTreeNodeById(y,u,p);if(m){h=m;break}}}catch(C){n={error:C}}finally{try{f&&!f.done&&(r=g["return"])&&r.call(g)}finally{if(n)throw n.error}}if(h&&1===o.length){var v=o.shift();if(h.data.hasOwnProperty(v)&&e.hasOwnProperty("value"))return h.data[v]=e.value,!0}}return!1},xt.prototype.findTreeNodeById=function(e,t,i){var n,r;if(!e)return null;if(e.data.hasOwnProperty(t)&&e.data[t]===i)return e;if(e.children)try{for(var o=U(e.children),a=o.next();!a.done;a=o.next()){var s=a.value,d=this.findTreeNodeById(s,t,i);if(d)return d}}catch(l){n={error:l}}finally{try{a&&!a.done&&(r=o["return"])&&r.call(o)}finally{if(n)throw n.error}}return null},xt.prototype.bindData=function(e){if(!this.handleChange(e)){var t=this.treeTable.value,i=this.bindingList.toJSON({ignoreMultiLangInput:!0}),n=[];if(i&&0<i.length){var r=i[0][this.hierarchyInfoField],o=Ie.getBuilder(r);if(null==o)throw new Error("TreeTable builder is null!");var a=-1,s=this.treeTable.expandLevel;void 0!==s&&(a=s);var d={expandLevel:a,component:this.treeTable};n=new o(i,t,this.bindingList.primaryKey,this.hierarchyInfoField,d).build();var l=this.getEntityArr();this.setActualIndex(l,n)}this.treeTable.lazy||(this.treeTable.totalRecords=this.treeTable._value?this.treeTable._value.length:0,"single"==this.treeTable.sortMode&&this.treeTable.sortField?this.treeTable.sortSingle():"multiple"==this.treeTable.sortMode&&this.treeTable.multiSortMeta?this.treeTable.sortMultiple():this.treeTable.hasFilter()&&this.treeTable._filter()),this.treeTable.tableService.onUIUpdate(n),this.treeTable.value=n,this.treeTable.updateSerializedValue()}},xt.prototype.updateSelectedRow=function(e){var t=this.bindingList.currentId;if(this.treeTableSelectedEvent)return this.treeTableSelectedEvent=!1,void(this.selectedRowId=t);var i=this.treeTable.serializedValue,n=i&&i.find(function(e){return e&&e.node&&e.node.data&&e.node.data.id===t})||null;if(n){if(this.treeTable.isSelected(n.node)||t===this.selectedRowId)return;this.selectedRowId=t,this.treeTable.handleRowClick({rowNode:n,originalEvent:{target:{nodeName:""}}})}},xt.prototype.onEditInitHandler=function(e){this.nodeSelectChange.emit(e.data);var t=e.data[this.idField];this.setCurrentIdToBindingList(t)},xt.prototype.onEditCompleteHandler=function(e){var t=e.field,i=this.columns.find(function(e){return e.field===t});if(!(t&&i&&i.editor&&i.editor.options&&"EditorTypes.LOOKUP"===i.editor.options.type)&&e&&e.hasOwnProperty("data")){var n=e.data[this.frameContext.repository.primaryKey],r=this.getValue(t,e.data),o=(this.frameContext.viewModel.bindingPath||"/").split("/").filter(function(e){return e}),a=this.bindingData.getValue(o),s=this.getValue(t,a),d=this.treeTable.columns.find(function(e){return e.field===t}),l=d&&d.dataType||null;if("date"===l||"datetime"===l){if(this.dateService){var p=d&&d.formatter&&d.formatter.options&&d.formatter.options.format||"yyyy-MM-dd";r=(r=this.dateService.formatTo(r,p))||null}}else"number"===l&&(r=Number(r));r!==s&&this.updateBindingList(n,t,r)}},xt.prototype.onNodeExpandHandler=function(e){var t=e&&e.node&&e.node.id||null;if(t){var i=this.frameContext.getVirtualRootFrameContext(),n=i.getParam("TREE_LATEST_EXPANDED_ID")||[];n.push(t),i.setParam("TREE_LATEST_EXPANDED_ID",n)}},xt.prototype.onNodeCollapseHandler=function(e){},xt.prototype.onNodeSelectHandler=function(e){var t=e&&e.node&&e.node.data&&e.node.data[this.frameContext.repository.primaryKey]||null;t!==this.bindingList.currentId&&(this.treeTableSelectedEvent=!0,this.setCurrentIdToBindingList(t))},xt.prototype.onNodeUnselectHandler=function(e){this.setCurrentIdToBindingList(null)},xt.prototype.setNodeExpandedValue=function(e){if(e&&this.oldTreeNodeMap&&!(Object.keys(this.oldTreeNodeMap).length<=0))try{var t=e.node.data.id;this.oldTreeNodeMap[t].expanded=e.expanded}catch(i){console.warn("setNodeExpandedValue error:"+i.message)}},xt.prototype.setCurrentIdToBindingList=function(e){this.bindingList.currentId!==e&&this.bindingList.setCurrentId(e,!0)},xt.prototype.getPaths=function(){var e=[];if(this.frameContext.viewModel&&this.frameContext.viewModel.bindingPath&&"/"!==this.frameContext.viewModel.bindingPath){var t=this.frameContext.viewModel.bindingPath;return e=t.substring(1,t.length).split("/")}return e},xt.prototype.updateBindingList=function(e,t,i){if(t){var n=t.split(".").filter(function(e){return e}),r=this.getBindingPathArray(),o=this.bindingData.getValue(r),a=r.concat(n);if(o&&e===o.currentItem.primaryKeyValue)this.bindingData.setValue(a,i,!0,!0);else{var s=this.bindingList.findById(e);if(s)if(n.length<2)s.setValue(t,i,!0,!0,this.bindingData.getValudChangeInvokerFactory()(a));else{var d=null,l=n.slice(0,n.length-1),p=n[n.length-1];l.forEach(function(e){d=d&&d[e]||s[e]}),d.setValue(p,i,!0,!0,this.bindingData.getValudChangeInvokerFactory()(a))}}}},xt.prototype.getBindingPathArray=function(){var e=this.frameContext.viewModel.bindingPath;return e?e.split("/").filter(function(e){return""!==e}):[]},xt.prototype.getValue=function(e,t){return-1===e.indexOf(".")?t[e]:e.split(".").reduce(function(e,t){return e[t]},t)},xt.prototype.setChecks=function(e){this.frameContext.viewModel.uiState.setPropertyValue("ids",e)},xt.decorators=[{type:M.Directive,args:[{selector:"[farrisPrimengTreeTableBinding]"}]}],xt.ctorParameters=function(){return[{type:h.TreeTable},{type:P.FrameContext},{type:g.DateTimeHelperService}]},xt.propDecorators={hierarchyInfoKey:[{type:M.Input,args:["farrisHierarchyInfoKey"]}],columns:[{type:M.Input,args:["columns"]}],idField:[{type:M.Input,args:["farrisPrimengTreeTableIdField"]}],nodeSelectChange:[{type:M.Output}],onEditInitHandler:[{type:M.HostListener,args:["onEditInit",["$event"]]}],onEditCompleteHandler:[{type:M.HostListener,args:["onEditComplete",["$event"]]}],onNodeExpandHandler:[{type:M.HostListener,args:["onNodeExpand",["$event"]]}],onNodeCollapseHandler:[{type:M.HostListener,args:["onNodeCollapse",["$event"]]}],onNodeSelectHandler:[{type:M.HostListener,args:["onNodeSelect",["$event"]]}],onNodeUnselectHandler:[{type:M.HostListener,args:["onNodeUnselect",["$event"]]}]},xt);function xt(e,t,i){this.treeTable=e,this.frameContext=t,this.dateService=i,this.selectedRowId=null,this.treeTableSelectedEvent=null,this.nodeSelectChange=new M.EventEmitter,this.oldTreeNodeMap={}}var wt=(Et.prototype.ngOnDestroy=function(){this.updateValidateRule(!1)},Et.prototype.ngOnChanges=function(e){this.updateValidateRule(this.requiredOn)},Et.prototype.updateValidateRule=function(e){this.field&&this.frameContext.form.updateFieldValidateRule(this.field,e)},Et.decorators=[{type:M.Directive,args:[{selector:"[farris-dynamic-required]"}]}],Et.ctorParameters=function(){return[{type:P.FrameContext},{type:M.Injector}]},Et.propDecorators={field:[{type:M.Input,args:["farris-dynamic-required"]}],requiredOn:[{type:M.Input,args:["requiredOn"]}]},Et);function Et(e,t){this.frameContext=e,this.injector=t,this.requiredOn=!1}var Pt=(Lt.prototype.ngOnInit=function(){this.setComponentRef()},Lt.prototype.setComponentRef=function(){var e=this.viewModel&&this.viewModel.frameContext&&this.viewModel.frameContext.getFormAppContext(),t=this.viewModel&&this.viewModel.frameContext&&this.viewModel.frameContext.frameId,i=this.editor,n=i&&i.injector&&i.injector.get(M.ElementRef,null),r=n&&n.nativeElement&&n.nativeElement.id||null;if(t&&r){var o=e&&e.componentRefs&&e.componentRefs.get(t)||new Map;e&&e.componentRefs&&e.componentRefs.set(t,o.set(r,this.editor))}},Lt.decorators=[{type:M.Directive,args:[{selector:"[farris-editor],[farris-editor-bind]"}]}],Lt.ctorParameters=function(){return[{type:P.ViewModel},{type:f.EditorComponent}]},Lt);function Lt(e,t){this.viewModel=e,this.editor=t}var Ot=(Tt.prototype.onQuery=function(e){this.frameContext&&(this.frameContext.repository.entityCollection.pageIndex=1)},Tt.decorators=[{type:M.Directive,args:[{selector:"[farris-querysolution-event-bind]"}]}],Tt.ctorParameters=function(){return[{type:M.Injector},{type:m.QuerySolutionComponent},{type:P.FrameContext}]},Tt.propDecorators={onQuery:[{type:M.HostListener,args:["queryEmitter"]}]},Tt);function Tt(e,t,i){this.injector=e,this.component=t,this.frameContext=i}var Mt=(Ft.prototype.ngOnInit=function(){this.localize()},Ft.prototype.localize=function(){if(this.userSettings&&this.componentRef){var e=this.userSettings,t=e.dateFormat,i=void 0===t?null:t,n=e.timeFormat,r=void 0===n?null:n;if(null===i&&null===r)return;r&&r&&!0===this.componentRef.showTime?(this.componentRef.dateFormat=i+" "+r,this.componentRef.dateOpts.dateFormat=i+" "+r,this.componentRef.updateValue(this.componentRef.value)):i&&(this.componentRef.dateFormat=""+i,this.componentRef.dateOpts.dateFormat=""+i,this.componentRef.updateValue(this.componentRef.value))}},Ft.decorators=[{type:M.Directive,args:[{selector:"[farris-date-localization]"}]}],Ft.ctorParameters=function(){return[{type:M.Injector},{type:undefined,decorators:[{type:M.Inject,args:[P.UserSettingsToken]}]},{type:v.FarrisDatepickerComponent}]},Ft);function Ft(e,t,i){this.injector=e,this.userSettings=t,this.componentRef=i}var Nt=(kt.prototype.ngOnInit=function(){this.localize()},kt.prototype.localize=function(){},kt.decorators=[{type:M.Directive,args:[{selector:"[farris-number-localization]"}]}],kt.ctorParameters=function(){return[{type:M.Injector},{type:undefined,decorators:[{type:M.Inject,args:[P.UserSettingsToken]}]},{type:b.NumberSpinnerComponent}]},kt);function kt(e,t,i){this.injector=e,this.userSettings=t,this.componentRef=i}var Rt=(jt.prototype.ngOnInit=function(){this.localize()},jt.prototype.localize=function(){if(this.userSettings&&this.componentRef){var e=this.userSettings.timeFormat,t=void 0===e?null:e;t&&(this.componentRef.format=t)}},jt.decorators=[{type:M.Directive,args:[{selector:"[farris-time-localization]"}]}],jt.ctorParameters=function(){return[{type:M.Injector},{type:undefined,decorators:[{type:M.Inject,args:[P.UserSettingsToken]}]},{type:C.TimePickerComponent}]},jt);function jt(e,t,i){this.injector=e,this.userSettings=t,this.componentRef=i}var Vt=(Ht.prototype.ngOnInit=function(){},Ht.prototype.transform=function(){var r=this;this.componentRef&&(this.componentRef.beforeWriteValue=function(e,t){var i=t.localizationType,n=void 0===i?null:i;return t.showTime,e?n&&e?(n=n.toLowerCase(),e=r.transformValue(e,n)):undefined:""})},Ht.prototype.transformValue=function(e,t){return"date"===t?this.transformDate(e):"datetime"===t?this.transformDateTime(e):e},Ht.prototype.transformDate=function(e){var t=this.userSettings&&this.userSettings.dateFormat||"YYYY-MM-DD";if(!t||!e)return e;var i=O(e);return i.isValid()?(t=this.parseDateFormat(t),i.format(t)):e},Ht.prototype.transformDateTime=function(e){var t=this.userSettings&&this.userSettings.dateFormat||"YYYY-MM-DD",i=this.userSettings&&this.userSettings.timeFormat||"HH:mm:ss";if(!t||!i)return e;var n=O(e);if(!n.isValid())return e;var r=(t=t&&this.parseDateFormat(t))+" "+(i=i&&this.parseTimeFormat(i));return n.format(r)},Ht.prototype.transformNumber=function(e){if(null===e||e===undefined||""===e)return"";var t=new L.BigNumber(e);if(!L.BigNumber.isBigNumber(t))return e;var i=t.isNegative(),n=this.buildNumberFormat(),r=this.numberFormat||{},o=r.negativeSign,a=void 0===o?null:o,s=r.numberDecimalDigits,d=void 0===s?null:s;return i&&null!==a?(n.prefix=a,t.absoluteValue().toFormat(d,null,n)):t.toFormat(d,null,n)},Ht.prototype.parseDateFormat=function(e){return e.replace(/y/g,"Y").replace(/d/g,"D")},Ht.prototype.parseTimeFormat=function(e){return e.replace(/M/g,"m")},Ht.prototype.buildNumberFormat=function(){if(this.numberFormat){var e=this.numberFormat,t=e.numberDecimalSeparator,i=void 0===t?null:t,n=e.numberGroupSeparator,r=void 0===n?null:n,o={groupSize:3};return null!==i&&(o.decimalSeparator=i),null!==r&&(o.groupSeparator=r),o}},Object.defineProperty(Ht.prototype,"numberFormat",{get:function(){return this.userSettings&&this.userSettings.numberFormat||null},enumerable:!0,configurable:!0}),Ht.decorators=[{type:M.Directive,args:[{selector:"[farris-text-localization]"}]}],Ht.ctorParameters=function(){return[{type:M.Injector},{type:undefined,decorators:[{type:M.Inject,args:[P.UserSettingsToken]}]},{type:S.TextComponent}]},Ht.propDecorators={localization:[{type:M.Input,args:["localization"]}]},Ht);function Ht(e,t,i){this.injector=e,this.userSettings=t,this.componentRef=i,this.transform()}var Bt=(At.prototype.ngOnInit=function(){if("number"==typeof this.index&&this.elementRef){var e=this.elementRef.nativeElement;if(e){var t=e.getAttribute("id");if(t){var i=t+"_"+this.index;this.elementRef.nativeElement.setAttribute("id",i),this.elementRef.nativeElement.setAttribute("name",i),this.elementRef.nativeElement.setAttribute("original_id",t)}}}},At.decorators=[{type:M.Directive,args:[{selector:"[farris-checkbox-modification]"}]}],At.ctorParameters=function(){return[{type:M.Injector},{type:M.ElementRef}]},At.propDecorators={index:[{type:M.Input}]},At);function At(e,t){this.injector=e,this.elementRef=t}var Kt=(_t.prototype.ngOnInit=function(){if("number"==typeof this.index&&this.elementRef){var e=this.elementRef.nativeElement;if(e){var t=e.getAttribute("for");t&&this.elementRef.nativeElement.setAttribute("for",t+"_"+this.index)}}},_t.decorators=[{type:M.Directive,args:[{selector:"[farris-label-modification]"}]}],_t.ctorParameters=function(){return[{type:M.Injector},{type:M.ElementRef}]},_t.propDecorators={index:[{type:M.Input}]},_t);function _t(e,t){this.injector=e,this.elementRef=t}var zt=(Object.defineProperty(Gt.prototype,"lookupValue",{set:function(e){"lookup"===this.lookupType&&this.lookup?this.lookup.writeValue(e):"comboLookup"===this.lookupType&&this.comboLookup&&this.comboLookup.writeValue(e)},enumerable:!0,configurable:!0}),Gt.decorators=[{type:M.Directive,args:[{selector:"[farris-lookup-binding]"}]}],Gt.ctorParameters=function(){return[{type:D.LookupGridComponent,decorators:[{type:M.Optional}]},{type:I.ComboLookupComponent,decorators:[{type:M.Optional}]}]},Gt.propDecorators={lookupType:[{type:M.Input}],lookupValue:[{type:M.Input,args:["farris-lookup-binding"]}]},Gt);function Gt(e,t){this.lookup=e,this.comboLookup=t}var qt=(Ut.prototype.transform=function(e,t){return void 0===t&&(t="default-root"),e?this.downloadService?this.downloadService.getDownloadUrl(e,t):(console.warn("因安全问题，附件下载提供安全校验机制，附件下载功能需重新编译。"),"/api/runtime/dfs/v1.0/formdoc/download/"+e):this.defaultPic},Ut.decorators=[{type:M.Pipe,args:[{name:"imageIdToUrl"}]}],Ut.ctorParameters=function(){return[{type:M.Injector,decorators:[{type:M.Optional}]}]},Ut);function Ut(e){this.injector=e,this.defaultPic="/platform/common/web/assets/imgs/no-pic.png",this.downloadService=this.injector&&this.injector.get(x.DownloadService,null)||null}var $t=(Jt.prototype.transform=function(e,t){var i="";if(t&&e&&e.field){i=this.getValue(e.field,t);var n=e.formatter;return n?this.cfs.format(i,t,n):e.isMultilingualField?this.getMultiLanguageValue(i):i}return""},Jt.prototype.getMultiLanguageValue=function(e){if(e&&"object"==typeof e&&0<Object.keys(e).length){var t=e[this.localeService&&this.localeService.localeId||"zh-CHS"];return t===undefined?"":t}return""},Jt.prototype.getValue=function(e,t){return t?-1===e.indexOf(".")?t[e]:e.split(".").reduce(function(e,t){return e&&e[t]||null},t):""},Jt.prototype.isHelpColumn=function(e){return e&&e.editor&&e.editor.options&&"EditorTypes.LOOKUP"===e.editor.options.type||!1},Jt.prototype.getHelpColumnValue=function(e,t){var i=this.getHelpControlTextField(e),n=this.getHelpControlMapFields(e);if(i&&n&&0<Object.keys(n).length){var r=n[i];return this.getValue(r,t)}return""},Jt.prototype.getHelpControlTextField=function(e){return e&&e.editor&&e.editor.options&&e.editor.options.textField||""},Jt.prototype.getHelpControlMapFields=function(e){return e&&e.editor&&e.editor.options&&e.editor.options.mapFields||{}},Jt.decorators=[{type:M.Pipe,args:[{name:"formatPrimeNgTreeTableCellData",pure:!1}]}],Jt.ctorParameters=function(){return[{type:E.ColumnFormatService},{type:M.Injector,decorators:[{type:M.Optional}]}]},Jt);function Jt(e,t){this.cfs=e,this.injector=t,this.injector&&(this.localeService=this.injector.get(w.LocaleService))}var Wt=(Yt.prototype.transform=function(e,t){if(t)return"date"===(t=t.toLowerCase())?this.transformDate(e):"datetime"===t?this.transformDateTime(e):"number"===t?this.transformNumber(e):e},Yt.prototype.transformDate=function(e){var t=this.userSettings&&this.userSettings.dateFormat||null;if(!t||!e)return e;var i=O(e);return i.isValid()?(t=this.parseDateFormat(t),i.format(t)):e},Yt.prototype.transformDateTime=function(e){var t=this.userSettings&&this.userSettings.dateFormat||"",i=this.userSettings&&this.userSettings.timeFormat||"",n=O(e);if(!n.isValid())return e;var r=(t=t&&this.parseDateFormat(t))+" "+(i=i&&this.parseTimeFormat(i));return n.format(r)},Yt.prototype.transformNumber=function(e){if(null===e||e===undefined||""===e)return"";var t=new L.BigNumber(e);if(!L.BigNumber.isBigNumber(t))return e;var i=t.isNegative(),n=this.buildNumberFormat(),r=this.numberFormat,o=r.negativeSign,a=void 0===o?null:o,s=r.numberDecimalDigits,d=void 0===s?null:s;return i&&null!==a?(n.prefix=a,t.absoluteValue().toFormat(d,null,n)):t.toFormat(d,null,n)},Yt.prototype.parseDateFormat=function(e){return e.replace(/y/g,"Y").replace(/d/g,"D")},Yt.prototype.parseTimeFormat=function(e){return e.replace(/M/g,"m")},Yt.prototype.buildNumberFormat=function(){if(this.numberFormat){var e=this.numberFormat,t=e.numberDecimalSeparator,i=void 0===t?null:t,n=e.numberGroupSeparator,r=void 0===n?null:n,o={groupSize:3};return null!==i&&(o.decimalSeparator=i),null!==r&&(o.groupSeparator=r),o}},Object.defineProperty(Yt.prototype,"numberFormat",{get:function(){return this.userSettings&&this.userSettings.numberFormat||null},enumerable:!0,configurable:!0}),Yt.decorators=[{type:M.Pipe,args:[{name:"localization"}]}],Yt.ctorParameters=function(){return[{type:M.Injector,decorators:[{type:M.Optional}]},{type:undefined,decorators:[{type:M.Inject,args:[P.UserSettingsToken]}]}]},Yt);function Yt(e,t){this.injector=e,this.userSettings=t}var Qt=(Xt.decorators=[{type:M.NgModule,args:[{imports:[F.CommonModule,k.FarrisCommonModule.forRoot()],declarations:[ye,xe,Ee,Le,Te,Fe,ke,He,Ae,je,_e,Z,de,pe,re,qt,$t,Ge,Ue,Je,Ye,ie,ae,tt,rt,st,pt,ct,yt,gt,bt,St,Dt,wt,Pt,Ot,Mt,Nt,Rt,Vt,Wt,Bt,Kt,zt],providers:[T.DialogService,N.GridComponent,W,Q],exports:[ye,xe,Ee,Le,Te,Fe,ke,He,Ae,je,_e,Z,de,re,qt,$t,Ge,Ue,Je,Ye,ie,ae,tt,rt,st,pt,ct,yt,gt,bt,St,Dt,wt,Pt,Ot,Mt,Nt,Rt,Vt,Wt,Bt,Kt,zt]}]}],Xt);function Xt(){}e.ɵa=Xe,e.ArrayConverter=R,e.DateConverter=V,e.MultiLangConverter=B,e.FilterConditionsConverter=K,e.KendoGridBindingDirective=ye,e.FarrisTreeTableBindingDirective=xe,e.LookupDataMappingDirective=Ee,e.LookupEnableExtendLoadMethodDirective=Le,e.UIStateBindingDirective=Te,e.FarrisDisabledDirective=Fe,e.FarrisSortDirective=ke,e.FarrisTextareaEditDirective=je,e.FarrisDynamicColumnFormatDirective=He,e.FarrisEditEnterDirective=Ae,e.FarrisTreeTableFormatDirective=_e,e.GridColumnAggregateDirective=de,e.GridSummaryDirective=pe,e.FarrisDatagridUseBindingDataDirective=Ge,e.MultiSelectDataMappingDirective=Ue,e.FarrisListViewBindingDirective=Je,e.EditableDirective=Ye,e.InputEndEditDirective=tt,e.FarrisDataGridEndEditDirective=rt,e.HtmlEditorEndEditDirective=st,e.KendoGridEndEditDirective=pt,e.FarrisDataGridRemoteSummaryDirective=ct,e.FarrisSetFocusDirective=gt,e.FarrisFilePreviewBindingDirective=yt,e.FarrisDiscussionEditorBindingDirective=bt,e.FarrisDiscussionListBindingDirective=St,e.FarrisPrimengTreeTableBindingDirective=Dt,e.FarrisDynamicRequiredDirective=wt,e.FarrisEditorDirective=Pt,e.FarrisQuerySolutionEventBindDirective=Ot,e.FarrisDateLocalizationDirective=Mt,e.FarrisNumberLocalizationDirective=Nt,e.FarrisTimeLocalizationDirective=Rt,e.FarrisTextLocalizationDirective=Vt,e.FarrisCheckboxModificationDirective=Bt,e.FarrisLabelModificationDirective=Kt,e.FarrisLookupBindingDirective=zt,e.ImageIdToUrlPipe=qt,e.FormatPrimeNgTreeTableCellData=$t,e.Localization=Wt,e.FarrisKendoGridFormatService=W,e.FarrisTreetableFormatService=Q,e.StringToDatePipe=Z,e.KendoGridFilterDirective=ie,e.DateFormatPlaceholderPipe=re,e.FormatTotalPipe=ae,e.KendoBindingModule=Qt,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=farris-kendo-binding.umd.min.js.map