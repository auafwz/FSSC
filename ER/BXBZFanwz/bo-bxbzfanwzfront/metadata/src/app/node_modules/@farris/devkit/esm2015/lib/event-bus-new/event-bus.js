import { Injectable, Type } from '@angular/core';
import { EventBusProxy } from './event-bus-proxy';
import { EventPipe } from './event-pipe';
export class EventBus {
    constructor() {
        this.proxyMap = new Map();
        this.eventMap = new Map();
    }
    getProxy(ownerType, eventTokenValueProvider) {
        const ownerName = ownerType.constructor.typeName || ownerType.constructor.name;
        if (!this.proxyMap.has(ownerName)) {
            this.proxyMap.set(ownerName, new EventBusProxy(this, ownerType, eventTokenValueProvider));
        }
        return this.proxyMap.get(ownerName);
    }
    /**
     * 发送事件，通知订阅者接收消息。
     */
    // tslint:disable-next-line: max-line-length
    post(emitterType, tokenValue, eventName, eventArgs, sender, eventType, eventId) {
        const eventPipeList = this.eventMap.get(eventName);
        if (!eventPipeList) {
            return;
        }
        if (!emitterType) {
            console.error('post方法的参数emitterType不能为空。');
            return;
        }
        let emitter;
        if (emitterType instanceof Type) {
            emitter = emitterType.typeName || emitterType.name;
        }
        else {
            emitter = emitterType;
        }
        if (typeof eventId === 'undefined') {
            eventId = new Date().valueOf();
        }
        for (const eventPipe of eventPipeList) {
            if (eventPipe.matchEmitterToken(emitter, tokenValue)) {
                eventPipe.post(eventArgs, sender, eventType, eventId);
                eventPipe.unSubscribeForOnce();
            }
        }
    }
    /**
     * 订阅事件
     */
    on(target, tokenValue, eventName, caller, handler) {
        return this.getEventPipe(eventName, target, tokenValue).subscribe(handler, caller);
    }
    /**
     * 订阅一次。接收到一次消息之后自动取消订阅
     */
    once(target, tokenValue, eventName, caller, handler) {
        return this.getEventPipe(eventName, target, tokenValue).subscribeOnce(handler, caller);
    }
    /**
     * 发送一个请求事件，获取监听者的响应并处理
     */
    requestFor(target, tokenValue, requestName, requestValue, success, fail) {
        const eventPipe = this.findExistEventPipe(requestName, 'RequestSubject', tokenValue);
        if (eventPipe) {
            this.once(target, tokenValue, requestName, this, (response) => {
                if (response.status === 'success') {
                    success(response.data);
                }
                else {
                    if (fail) {
                        fail('No target responser listening');
                    }
                }
            });
            eventPipe.post({ target: target, token: tokenValue, data: requestValue });
        }
        else {
            if (fail) {
                fail('No target responser listening.');
            }
        }
    }
    /**
     * 监听一个请求事件，给出响应
     */
    responseOn(responseSubject, requestName, callback) {
        this.on('RequestSubject', null, requestName, this, (requestObj) => {
            const response = { status: 'fail', data: null };
            if (responseSubject === requestObj.target) {
                response.data = callback(requestObj.data);
                response.status = 'success';
            }
            this.post(requestObj.target, requestObj.token, requestName, response);
        });
    }
    getEventPipe(eventName, target, tokenValue) {
        let eventPipeList = this.eventMap.get(eventName);
        if (!eventPipeList) {
            eventPipeList = new Array();
            this.eventMap.set(eventName, eventPipeList);
        }
        // 1、一个事件不允许多个订阅
        // let eventPipe = eventPipeList.find(item => item.examByTargetToken(target, tokenValue));
        // if (!eventPipe) {
        //   eventPipe = new EventPipe(eventName, tokenValue, target, eventPipeList);
        // }
        // 2、一个事件允许多个订阅
        const eventPipe = new EventPipe(eventName, tokenValue, target, eventPipeList);
        return eventPipe;
    }
    findExistEventPipe(eventName, target, tokenValue) {
        const eventPipeList = this.eventMap.get(eventName);
        if (!eventPipeList) {
            return null;
        }
        // return eventPipeList.find(item => item.examByTargetToken(target, tokenValue));
        for (const eventPipe of eventPipeList) {
            if (eventPipe.matchEmitterToken(target, tokenValue)) {
                return eventPipe;
            }
        }
        return null;
    }
}
EventBus.decorators = [
    { type: Injectable }
];
/** @nocollapse */
EventBus.ctorParameters = () => [];
export class EventCache {
    static setToken(key, value) {
        EventCache.tokens.set(key, value);
    }
    static getToken(key) {
        return EventCache.tokens.get(key);
    }
}
EventCache.tokens = new Map();
class RequestSubject {
}
class DataClass {
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXZlbnQtYnVzLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9kZXZraXQvIiwic291cmNlcyI6WyJsaWIvZXZlbnQtYnVzLW5ldy9ldmVudC1idXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxJQUFJLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDakQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBRWxELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFHekMsTUFBTSxPQUFPLFFBQVE7SUFJbkI7UUFDRSxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksR0FBRyxFQUF5QixDQUFDO1FBQ2pELElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxHQUFHLEVBQTRCLENBQUM7SUFDdEQsQ0FBQztJQUVELFFBQVEsQ0FBQyxTQUFjLEVBQUUsdUJBQWtDO1FBQ3pELE1BQU0sU0FBUyxHQUFHLFNBQVMsQ0FBQyxXQUFXLENBQUMsUUFBUSxJQUFJLFNBQVMsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDO1FBQy9FLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsRUFBRTtZQUNqQyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxTQUFTLEVBQUUsSUFBSSxhQUFhLENBQUMsSUFBSSxFQUFFLFNBQVMsRUFBRSx1QkFBdUIsQ0FBQyxDQUFDLENBQUM7U0FDM0Y7UUFDRCxPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQ3RDLENBQUM7SUFFRDs7T0FFRztJQUNILDRDQUE0QztJQUM1QyxJQUFJLENBQUMsV0FBeUIsRUFBRSxVQUFrQixFQUFFLFNBQWlCLEVBQUUsU0FBYyxFQUFFLE1BQVksRUFBRSxTQUFlLEVBQUUsT0FBZ0I7UUFDcEksTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FB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RjtRQUNqRixLQUFLLE1BQU0sU0FBUyxJQUFJLGFBQWEsRUFBRTtZQUNyQyxJQUFJLFNBQVMsQ0FBQyxpQkFBaUIsQ0FBQyxNQUFNLEVBQUUsVUFBVSxDQUFDLEVBQUU7Z0JBQ25ELE9BQU8sU0FBUyxDQUFDO2FBQ2xCO1NBQ0Y7UUFDRCxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7OztZQW5JRixVQUFVOzs7O0FBc0lYLE1BQU0sT0FBTyxVQUFVO0lBR2QsTUFBTSxDQUFDLFFBQVEsQ0FBQyxHQUFXLEVBQUUsS0FBVTtRQUM1QyxVQUFVLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDcEMsQ0FBQztJQUVNLE1BQU0sQ0FBQyxRQUFRLENBQUMsR0FBVztRQUNoQyxPQUFPLFVBQVUsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3BDLENBQUM7O0FBUmMsaUJBQU0sR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDO0FBV3BDLE1BQU0sY0FBYztDQUFJO0FBQ3hCLE1BQU0sU0FBUztDQUFJIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgVHlwZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBFdmVudEJ1c1Byb3h5IH0gZnJvbSAnLi9ldmVudC1idXMtcHJveHknO1xyXG5pbXBvcnQgeyBJRGlzcG9zYWJsZSwgSUVtaXRhYmxlIH0gZnJvbSAnLi90eXBlcyc7XHJcbmltcG9ydCB7IEV2ZW50UGlwZSB9IGZyb20gJy4vZXZlbnQtcGlwZSc7XHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBFdmVudEJ1cyBpbXBsZW1lbnRzIElFbWl0YWJsZSB7XHJcbiAgcHJpdmF0ZSBwcm94eU1hcDogTWFwPHN0cmluZywgRXZlbnRCdXNQcm94eT47XHJcbiAgcHJpdmF0ZSBldmVudE1hcDogTWFwPHN0cmluZywgQXJyYXk8RXZlbnRQaXBlPj47XHJcblxyXG4gIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgdGhpcy5wcm94eU1hcCA9IG5ldyBNYXA8c3RyaW5nLCBFdmVudEJ1c1Byb3h5PigpO1xyXG4gICAgdGhpcy5ldmVudE1hcCA9IG5ldyBNYXA8c3RyaW5nLCBBcnJheTxFdmVudFBpcGU+PigpO1xyXG4gIH1cclxuXHJcbiAgZ2V0UHJveHkob3duZXJUeXBlOiBhbnksIGV2ZW50VG9rZW5WYWx1ZVByb3ZpZGVyOiAoKSA9PiBhbnkpOiBFdmVudEJ1c1Byb3h5IHtcclxuICAgIGNvbnN0IG93bmVyTmFtZSA9IG93bmVyVHlwZS5jb25zdHJ1Y3Rvci50eXBlTmFtZSB8fCBvd25lclR5cGUuY29uc3RydWN0b3IubmFtZTtcclxuICAgIGlmICghdGhpcy5wcm94eU1hcC5oYXMob3duZXJOYW1lKSkge1xyXG4gICAgICB0aGlzLnByb3h5TWFwLnNldChvd25lck5hbWUsIG5ldyBFdmVudEJ1c1Byb3h5KHRoaXMsIG93bmVyVHlwZSwgZXZlbnRUb2tlblZhbHVlUHJvdmlkZXIpKTtcclxuICAgIH1cclxuICAgIHJldHVybiB0aGlzLnByb3h5TWFwLmdldChvd25lck5hbWUpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5Y+R6YCB5LqL5Lu277yM6YCa55+l6K6i6ZiF6ICF5o6l5pS25raI5oGv44CCXHJcbiAgICovXHJcbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBtYXgtbGluZS1sZW5ndGhcclxuICBwb3N0KGVtaXR0ZXJUeXBlOiBhbnkgfCBzdHJpbmcsIHRva2VuVmFsdWU6IHN0cmluZywgZXZlbnROYW1lOiBzdHJpbmcsIGV2ZW50QXJnczogYW55LCBzZW5kZXI/OiBhbnksIGV2ZW50VHlwZT86IGFueSwgZXZlbnRJZD86IG51bWJlcik6IHZvaWQge1xyXG4gICAgY29uc3QgZXZlbnRQaXBlTGlzdCA9IHRoaXMuZXZlbnRNYXAuZ2V0KGV2ZW50TmFtZSk7XHJcbiAgICBpZiAoIWV2ZW50UGlwZUxpc3QpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICghZW1pdHRlclR5cGUpIHtcclxuICAgICAgY29uc29sZS5lcnJvcigncG9zdOaWueazleeahOWPguaVsGVtaXR0ZXJUeXBl5LiN6IO95Li656m644CCJyk7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGxldCBlbWl0dGVyOiBzdHJpbmc7XHJcbiAgICBpZiAoZW1pdHRlclR5cGUgaW5zdGFuY2VvZiBUeXBlKSB7XHJcbiAgICAgIGVtaXR0ZXIgPSBlbWl0dGVyVHlwZS50eXBlTmFtZSB8fCBlbWl0dGVyVHlwZS5uYW1lO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgZW1pdHRlciA9IGVtaXR0ZXJUeXBlO1xyXG4gICAgfVxyXG4gICAgaWYgKHR5cGVvZiBldmVudElkID09PSAndW5kZWZpbmVkJykge1xyXG4gICAgICBldmVudElkID0gbmV3IERhdGUoKS52YWx1ZU9mKCk7XHJcbiAgICB9XHJcbiAgICBmb3IgKGNvbnN0IGV2ZW50UGlwZSBvZiBldmVudFBpcGVMaXN0KSB7XHJcbiAgICAgIGlmIChldmVudFBpcGUubWF0Y2hFbWl0dGVyVG9rZW4oZW1pdHRlciwgdG9rZW5WYWx1ZSkpIHtcclxuICAgICAgICBldmVudFBpcGUucG9zdChldmVudEFyZ3MsIHNlbmRlciwgZXZlbnRUeXBlLCBldmVudElkKTtcclxuICAgICAgICBldmVudFBpcGUudW5TdWJzY3JpYmVGb3JPbmNlKCk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiuoumYheS6i+S7tlxyXG4gICAqL1xyXG4gIG9uKHRhcmdldDogc3RyaW5nLCB0b2tlblZhbHVlOiBzdHJpbmcsIGV2ZW50TmFtZTogc3RyaW5nLCBjYWxsZXI6IE9iamVjdCwgaGFuZGxlcjogKHZhbHVlOiBhbnkpID0+IHZvaWQpOiBJRGlzcG9zYWJsZSB7XHJcbiAgICByZXR1cm4gdGhpcy5nZXRFdmVudFBpcGUoZXZlbnROYW1lLCB0YXJnZXQsIHRva2VuVmFsdWUpLnN1YnNjcmliZShoYW5kbGVyLCBjYWxsZXIpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6K6i6ZiF5LiA5qyh44CC5o6l5pS25Yiw5LiA5qyh5raI5oGv5LmL5ZCO6Ieq5Yqo5Y+W5raI6K6i6ZiFXHJcbiAgICovXHJcbiAgb25jZSh0YXJnZXQ6IHN0cmluZywgdG9rZW5WYWx1ZTogc3RyaW5nLCBldmVudE5hbWU6IHN0cmluZywgY2FsbGVyOiBPYmplY3QsIGhhbmRsZXI6ICh2YWx1ZTogYW55KSA9PiB2b2lkKTogSURpc3Bvc2FibGUge1xyXG4gICAgcmV0dXJuIHRoaXMuZ2V0RXZlbnRQaXBlKGV2ZW50TmFtZSwgdGFyZ2V0LCB0b2tlblZhbHVlKS5zdWJzY3JpYmVPbmNlKGhhbmRsZXIsIGNhbGxlcik7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDlj5HpgIHkuIDkuKror7fmsYLkuovku7bvvIzojrflj5bnm5HlkKzogIXnmoTlk43lupTlubblpITnkIZcclxuICAgKi9cclxuICByZXF1ZXN0Rm9yKHRhcmdldDogc3RyaW5nLCB0b2tlblZhbHVlOiBzdHJpbmcsIHJlcXVlc3ROYW1lOiBzdHJpbmcsIHJlcXVlc3RWYWx1ZTogYW55LCBzdWNjZXNzOiAoYW55KSA9PiBhbnksIGZhaWw/OiAoc3RyaW5nKSA9PiBhbnkpIHtcclxuICAgIGNvbnN0IGV2ZW50UGlwZSA9IHRoaXMuZmluZEV4aXN0RXZlbnRQaXBlKHJlcXVlc3ROYW1lLCAnUmVxdWVzdFN1YmplY3QnLCB0b2tlblZhbHVlKTtcclxuICAgIGlmIChldmVudFBpcGUpIHtcclxuICAgICAgdGhpcy5vbmNlKHRhcmdldCwgdG9rZW5WYWx1ZSwgcmVxdWVzdE5hbWUsIHRoaXMsIChyZXNwb25zZSkgPT4ge1xyXG4gICAgICAgIGlmIChyZXNwb25zZS5zdGF0dXMgPT09ICdzdWNjZXNzJykge1xyXG4gICAgICAgICAgc3VjY2VzcyhyZXNwb25zZS5kYXRhKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgaWYgKGZhaWwpIHtcclxuICAgICAgICAgICAgZmFpbCgnTm8gdGFyZ2V0IHJlc3BvbnNlciBsaXN0ZW5pbmcnKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgICBldmVudFBpcGUucG9zdCh7IHRhcmdldDogdGFyZ2V0LCB0b2tlbjogdG9rZW5WYWx1ZSwgZGF0YTogcmVxdWVzdFZhbHVlIH0pO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgaWYgKGZhaWwpIHtcclxuICAgICAgICBmYWlsKCdObyB0YXJnZXQgcmVzcG9uc2VyIGxpc3RlbmluZy4nKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog55uR5ZCs5LiA5Liq6K+35rGC5LqL5Lu277yM57uZ5Ye65ZON5bqUXHJcbiAgICovXHJcbiAgcmVzcG9uc2VPbihyZXNwb25zZVN1YmplY3Q6IHN0cmluZywgcmVxdWVzdE5hbWU6IHN0cmluZywgY2FsbGJhY2s6IChhbnkpID0+IGFueSkge1xyXG4gICAgdGhpcy5vbignUmVxdWVzdFN1YmplY3QnLCBudWxsLCByZXF1ZXN0TmFtZSwgdGhpcywgKHJlcXVlc3RPYmopID0+IHtcclxuICAgICAgY29uc3QgcmVzcG9uc2UgPSB7IHN0YXR1czogJ2ZhaWwnLCBkYXRhOiBudWxsIH07XHJcbiAgICAgIGlmIChyZXNwb25zZVN1YmplY3QgPT09IHJlcXVlc3RPYmoudGFyZ2V0KSB7XHJcbiAgICAgICAgcmVzcG9uc2UuZGF0YSA9IGNhbGxiYWNrKHJlcXVlc3RPYmouZGF0YSk7XHJcbiAgICAgICAgcmVzcG9uc2Uuc3RhdHVzID0gJ3N1Y2Nlc3MnO1xyXG4gICAgICB9XHJcbiAgICAgIHRoaXMucG9zdChyZXF1ZXN0T2JqLnRhcmdldCwgcmVxdWVzdE9iai50b2tlbiwgcmVxdWVzdE5hbWUsIHJlc3BvbnNlKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXRFdmVudFBpcGUoZXZlbnROYW1lOiBzdHJpbmcsIHRhcmdldDogc3RyaW5nLCB0b2tlblZhbHVlOiBzdHJpbmcpIHtcclxuICAgIGxldCBldmVudFBpcGVMaXN0ID0gdGhpcy5ldmVudE1hcC5nZXQoZXZlbnROYW1lKTtcclxuICAgIGlmICghZXZlbnRQaXBlTGlzdCkge1xyXG4gICAgICBldmVudFBpcGVMaXN0ID0gbmV3IEFycmF5PEV2ZW50UGlwZT4oKTtcclxuICAgICAgdGhpcy5ldmVudE1hcC5zZXQoZXZlbnROYW1lLCBldmVudFBpcGVMaXN0KTtcclxuICAgIH1cclxuXHJcbiAgICAvLyAx44CB5LiA5Liq5LqL5Lu25LiN5YWB6K645aSa5Liq6K6i6ZiFXHJcbiAgICAvLyBsZXQgZXZlbnRQaXBlID0gZXZlbnRQaXBlTGlzdC5maW5kKGl0ZW0gPT4gaXRlbS5leGFtQnlUYXJnZXRUb2tlbih0YXJnZXQsIHRva2VuVmFsdWUpKTtcclxuICAgIC8vIGlmICghZXZlbnRQaXBlKSB7XHJcbiAgICAvLyAgIGV2ZW50UGlwZSA9IG5ldyBFdmVudFBpcGUoZXZlbnROYW1lLCB0b2tlblZhbHVlLCB0YXJnZXQsIGV2ZW50UGlwZUxpc3QpO1xyXG4gICAgLy8gfVxyXG5cclxuICAgIC8vIDLjgIHkuIDkuKrkuovku7blhYHorrjlpJrkuKrorqLpmIVcclxuICAgIGNvbnN0IGV2ZW50UGlwZSA9IG5ldyBFdmVudFBpcGUoZXZlbnROYW1lLCB0b2tlblZhbHVlLCB0YXJnZXQsIGV2ZW50UGlwZUxpc3QpO1xyXG5cclxuICAgIHJldHVybiBldmVudFBpcGU7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGZpbmRFeGlzdEV2ZW50UGlwZShldmVudE5hbWU6IHN0cmluZywgdGFyZ2V0OiBzdHJpbmcsIHRva2VuVmFsdWU6IHN0cmluZyk6IEV2ZW50UGlwZSB7XHJcbiAgICBjb25zdCBldmVudFBpcGVMaXN0ID0gdGhpcy5ldmVudE1hcC5nZXQoZXZlbnROYW1lKTtcclxuICAgIGlmICghZXZlbnRQaXBlTGlzdCkge1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuICAgIC8vIHJldHVybiBldmVudFBpcGVMaXN0LmZpbmQoaXRlbSA9PiBpdGVtLmV4YW1CeVRhcmdldFRva2VuKHRhcmdldCwgdG9rZW5WYWx1ZSkpO1xyXG4gICAgZm9yIChjb25zdCBldmVudFBpcGUgb2YgZXZlbnRQaXBlTGlzdCkge1xyXG4gICAgICBpZiAoZXZlbnRQaXBlLm1hdGNoRW1pdHRlclRva2VuKHRhcmdldCwgdG9rZW5WYWx1ZSkpIHtcclxuICAgICAgICByZXR1cm4gZXZlbnRQaXBlO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbnVsbDtcclxuICB9XHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBFdmVudENhY2hlIHtcclxuICBwcml2YXRlIHN0YXRpYyB0b2tlbnMgPSBuZXcgTWFwKCk7XHJcblxyXG4gIHB1YmxpYyBzdGF0aWMgc2V0VG9rZW4oa2V5OiBzdHJpbmcsIHZhbHVlOiBhbnkpIHtcclxuICAgIEV2ZW50Q2FjaGUudG9rZW5zLnNldChrZXksIHZhbHVlKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBzdGF0aWMgZ2V0VG9rZW4oa2V5OiBzdHJpbmcpIHtcclxuICAgIHJldHVybiBFdmVudENhY2hlLnRva2Vucy5nZXQoa2V5KTtcclxuICB9XHJcbn1cclxuXHJcbmNsYXNzIFJlcXVlc3RTdWJqZWN0IHsgfVxyXG5jbGFzcyBEYXRhQ2xhc3MgeyB9XHJcbiJdfQ==