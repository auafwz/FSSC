/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { LocaleService } from '@farris/ui-locale';
import { BsModalService } from '@farris/ui-modal';
import { Injectable, Injector, ComponentFactoryResolver } from '@angular/core';
import { Subject } from 'rxjs';
import { EnumEditorComponent } from './enum-editor.component';
import { cloneDeep } from 'lodash-es';
import * as i0 from "@angular/core";
import * as i1 from "@farris/ui-modal";
import * as i2 from "@farris/ui-locale";
/** @enum {number} */
const EnumOutType = {
    'array': 0,
    'object': 1,
};
export { EnumOutType };
EnumOutType[EnumOutType['array']] = 'array';
EnumOutType[EnumOutType['object']] = 'object';
export class EnumEditorService {
    /**
     * @param {?} injector
     * @param {?} cfr
     * @param {?} modalService
     * @param {?} localeService
     */
    constructor(injector, cfr, modalService, localeService) {
        this.injector = injector;
        this.cfr = cfr;
        this.modalService = modalService;
        this.localeService = localeService;
        this.enumEditorRef = null;
        this.dlgRef = null;
        this.originalData = [];
        this.textField = 'name';
        this.valueField = 'value';
        this.outType = EnumOutType.array;
        this.dataChanged = new Subject();
    }
    /**
     * @param {?=} enumData
     * @param {?=} options
     * @return {?}
     */
    showDialog(enumData = [], options = {}) {
        enumData = this.toJSON(enumData);
        /** @type {?} */
        const enumEditorFactory = this.cfr.resolveComponentFactory(EnumEditorComponent);
        this.enumEditorRef = enumEditorFactory.create(this.injector);
        this.enumEditorRef.instance.data = enumData;
        this.originalData = cloneDeep(enumData);
        this.textField = options['textField'] || 'name';
        this.valueField = options['valueField'] || 'value';
        this.outType = options['outType'] || EnumOutType.array;
        options['showSortBtns'] = this.outType === EnumOutType.array;
        this.dlgRef = this.modalService.show(this.enumEditorRef, {
            width: 800, height: 500,
            title: this.localeService.getValue('enumEditor.title'), enableScroll: false,
            minHeight: 398, minWidth: 798, iconCls: 'f-icon f-icon-top_developmenttool',
            buttons: [
                {
                    text: this.localeService.getValue('enumEditor.cancelButton'),
                    cls: 'btn btn-outline-secondary',
                    handle: (/**
                     * @return {?}
                     */
                    () => {
                        this.cancel();
                    })
                },
                {
                    text: this.localeService.getValue('enumEditor.okButton'),
                    cls: 'btn btn-primary',
                    handle: (/**
                     * @return {?}
                     */
                    () => {
                        this.save();
                    })
                }
            ],
            initialState: options,
            dialogFooterStyles: { background: '#F4F6F9' },
            buttonAlign: 'right',
            closed: (/**
             * @param {?} isCloseButtonClick
             * @return {?}
             */
            (isCloseButtonClick) => {
                if (isCloseButtonClick) {
                    this.cancel();
                }
            })
        });
        this.enumEditorRef.instance.height = this.dlgRef.dialog.instance.getContainerSize().height;
        this.dlgRef.dialog.instance.resized.subscribe((/**
         * @param {?} size
         * @return {?}
         */
        size => {
            this.enumEditorRef.instance.height = size.containerHeight;
        }));
        this.enumEditorRef.changeDetectorRef.detectChanges();
        this.dlgRef.dialog.changeDetectorRef.reattach();
        // this.openDialog.emit();
    }
    /**
     * @return {?}
     */
    cancel() {
        this._dataChanged(this.originalData);
        this.dlgRef.close();
    }
    /**
     * @return {?}
     */
    save() {
        /** @type {?} */
        const enumData = this.enumEditorRef.instance.data;
        this._dataChanged(enumData);
        this.dlgRef.close();
    }
    /**
     * @private
     * @param {?} enumData
     * @return {?}
     */
    _dataChanged(enumData) {
        /** @type {?} */
        const str = this.toString(enumData);
        this.dataChanged.next(str);
    }
    /**
     * @param {?} enumData
     * @return {?}
     */
    toString(enumData) {
        if (enumData && enumData.length) {
            if (this.outType === EnumOutType.array) {
                return JSON.stringify(enumData);
            }
            else {
                /** @type {?} */
                const obj = enumData.reduce((/**
                 * @param {?} r
                 * @param {?} c
                 * @return {?}
                 */
                (r, c) => {
                    r[c[this.valueField]] = c[this.textField];
                    return r;
                }), {});
                return JSON.stringify(obj);
            }
        }
        return '';
    }
    /**
     * @param {?} val
     * @return {?}
     */
    toJSON(val) {
        /** @type {?} */
        let enumData = [];
        if (val) {
            if (typeof val === 'string') {
                try {
                    enumData = JSON.parse(val);
                    if (this.outType === EnumOutType.object) {
                        enumData = this.convertObject2Array(enumData);
                    }
                }
                catch (e) {
                    enumData = [];
                    console.warn(e);
                }
            }
            else {
                if (Array.isArray(val)) {
                    enumData = val;
                }
                else {
                    enumData = this.convertObject2Array(val);
                }
            }
        }
        return enumData;
    }
    /**
     * @private
     * @param {?} obj
     * @return {?}
     */
    convertObject2Array(obj) {
        /** @type {?} */
        const _enumData = [];
        Object.keys(obj).forEach((/**
         * @param {?} n
         * @return {?}
         */
        n => {
            _enumData.push({ [this.valueField]: n, [this.textField]: obj[n] });
        }));
        return _enumData;
    }
}
EnumEditorService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
/** @nocollapse */
EnumEditorService.ctorParameters = () => [
    { type: Injector },
    { type: ComponentFactoryResolver },
    { type: BsModalService },
    { type: LocaleService }
];
/** @nocollapse */ EnumEditorService.ngInjectableDef = i0.defineInjectable({ factory: function EnumEditorService_Factory() { return new EnumEditorService(i0.inject(i0.INJECTOR), i0.inject(i0.ComponentFactoryResolver), i0.inject(i1.BsModalService), i0.inject(i2.LocaleService)); }, token: EnumEditorService, providedIn: "root" });
if (false) {
    /** @type {?} */
    EnumEditorService.prototype.enumEditorRef;
    /** @type {?} */
    EnumEditorService.prototype.dlgRef;
    /** @type {?} */
    EnumEditorService.prototype.originalData;
    /** @type {?} */
    EnumEditorService.prototype.textField;
    /** @type {?} */
    EnumEditorService.prototype.valueField;
    /** @type {?} */
    EnumEditorService.prototype.outType;
    /** @type {?} */
    EnumEditorService.prototype.dataChanged;
    /**
     * @type {?}
     * @private
     */
    EnumEditorService.prototype.injector;
    /**
     * @type {?}
     * @private
     */
    EnumEditorService.prototype.cfr;
    /**
     * @type {?}
     * @private
     */
    EnumEditorService.prototype.modalService;
    /**
     * @type {?}
     * @private
     */
    EnumEditorService.prototype.localeService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW51bS1lZGl0b3Iuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvdWktZW51bS1lZGl0b3IvIiwic291cmNlcyI6WyJsaWIvZW51bS1lZGl0b3Iuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ2xELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUNsRCxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSx3QkFBd0IsRUFBZ0IsTUFBTSxlQUFlLENBQUM7QUFDN0YsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMvQixPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUU5RCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sV0FBVyxDQUFDOzs7Ozs7SUFHbEMsVUFBTztJQUNQLFdBQVE7Ozt3QkFEUixPQUFPLEtBQVAsT0FBTzt3QkFDUCxRQUFRLEtBQVIsUUFBUTtBQU9aLE1BQU0sT0FBTyxpQkFBaUI7Ozs7Ozs7SUFhMUIsWUFBb0IsUUFBa0IsRUFBVSxHQUE2QixFQUN6RCxZQUE0QixFQUFVLGFBQTRCO1FBRGxFLGFBQVEsR0FBUixRQUFRLENBQVU7UUFBVSxRQUFHLEdBQUgsR0FBRyxDQUEwQjtRQUN6RCxpQkFBWSxHQUFaLFlBQVksQ0FBZ0I7UUFBVSxrQkFBYSxHQUFiLGFBQWEsQ0FBZTtRQVp0RixrQkFBYSxHQUFzQyxJQUFJLENBQUM7UUFDeEQsV0FBTSxHQUFHLElBQUksQ0FBQztRQUNkLGlCQUFZLEdBQUcsRUFBRSxDQUFDO1FBRWxCLGNBQVMsR0FBRyxNQUFNLENBQUM7UUFDbkIsZUFBVSxHQUFHLE9BQU8sQ0FBQztRQUNyQixZQUFPLEdBQUcsV0FBVyxDQUFDLEtBQUssQ0FBQztRQUU1QixnQkFBVyxHQUFHLElBQUksT0FBTyxFQUFFLENBQUM7SUFJOEQs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QUMsRUFBQyxDQUFDO1FBRUgsT0FBTyxTQUFTLENBQUM7SUFDckIsQ0FBQzs7O1lBeklKLFVBQVUsU0FBQztnQkFDUixVQUFVLEVBQUUsTUFBTTthQUNyQjs7OztZQWRvQixRQUFRO1lBQUUsd0JBQXdCO1lBRDlDLGNBQWM7WUFEZCxhQUFhOzs7OztJQW1CbEIsMENBQXdEOztJQUN4RCxtQ0FBYzs7SUFDZCx5Q0FBa0I7O0lBRWxCLHNDQUFtQjs7SUFDbkIsdUNBQXFCOztJQUNyQixvQ0FBNEI7O0lBRTVCLHdDQUE0Qjs7Ozs7SUFHaEIscUNBQTBCOzs7OztJQUFFLGdDQUFxQzs7Ozs7SUFDakUseUNBQW9DOzs7OztJQUFFLDBDQUFvQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IExvY2FsZVNlcnZpY2UgfSBmcm9tICdAZmFycmlzL3VpLWxvY2FsZSc7XHJcbmltcG9ydCB7IEJzTW9kYWxTZXJ2aWNlIH0gZnJvbSAnQGZhcnJpcy91aS1tb2RhbCc7XHJcbmltcG9ydCB7IEluamVjdGFibGUsIEluamVjdG9yLCBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsIENvbXBvbmVudFJlZiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IEVudW1FZGl0b3JDb21wb25lbnQgfSBmcm9tICcuL2VudW0tZWRpdG9yLmNvbXBvbmVudCc7XHJcblxyXG5pbXBvcnQgeyBjbG9uZURlZXAgfSBmcm9tICdsb2Rhc2gtZXMnO1xyXG5cclxuZXhwb3J0IGVudW0gRW51bU91dFR5cGUge1xyXG4gICAgJ2FycmF5JyxcclxuICAgICdvYmplY3QnXHJcbn1cclxuXHJcblxyXG5ASW5qZWN0YWJsZSh7XHJcbiAgICBwcm92aWRlZEluOiAncm9vdCdcclxufSlcclxuZXhwb3J0IGNsYXNzIEVudW1FZGl0b3JTZXJ2aWNlIHtcclxuXHJcbiAgICBlbnVtRWRpdG9yUmVmOiBDb21wb25lbnRSZWY8RW51bUVkaXRvckNvbXBvbmVudD4gPSBudWxsO1xyXG4gICAgZGxnUmVmID0gbnVsbDtcclxuICAgIG9yaWdpbmFsRGF0YSA9IFtdO1xyXG5cclxuICAgIHRleHRGaWVsZCA9ICduYW1lJztcclxuICAgIHZhbHVlRmllbGQgPSAndmFsdWUnO1xyXG4gICAgb3V0VHlwZSA9IEVudW1PdXRUeXBlLmFycmF5O1xyXG5cclxuICAgIGRhdGFDaGFuZ2VkID0gbmV3IFN1YmplY3QoKTtcclxuXHJcblxyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IsIHByaXZhdGUgY2ZyOiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXHJcbiAgICAgICAgICAgICAgICBwcml2YXRlIG1vZGFsU2VydmljZTogQnNNb2RhbFNlcnZpY2UsIHByaXZhdGUgbG9jYWxlU2VydmljZTogTG9jYWxlU2VydmljZSkgeyB9XHJcblxyXG5cclxuICAgIHNob3dEaWFsb2coZW51bURhdGEgPSBbXSwgb3B0aW9ucyA9IHt9KSB7XHJcbiAgICAgICAgZW51bURhdGEgPSB0aGlzLnRvSlNPTihlbnVtRGF0YSk7XHJcbiAgICAgICAgY29uc3QgZW51bUVkaXRvckZhY3RvcnkgPSB0aGlzLmNmci5yZXNvbHZlQ29tcG9uZW50RmFjdG9yeShFbnVtRWRpdG9yQ29tcG9uZW50KTtcclxuICAgICAgICB0aGlzLmVudW1FZGl0b3JSZWYgPSBlbnVtRWRpdG9yRmFjdG9yeS5jcmVhdGUodGhpcy5pbmplY3Rvcik7XHJcbiAgICAgICAgdGhpcy5lbnVtRWRpdG9yUmVmLmluc3RhbmNlLmRhdGEgPSBlbnVtRGF0YTtcclxuICAgICAgICB0aGlzLm9yaWdpbmFsRGF0YSA9IGNsb25lRGVlcChlbnVtRGF0YSk7XHJcblxyXG4gICAgICAgIHRoaXMudGV4dEZpZWxkID0gb3B0aW9uc1sndGV4dEZpZWxkJ10gfHwgJ25hbWUnO1xyXG4gICAgICAgIHRoaXMudmFsdWVGaWVsZCA9IG9wdGlvbnNbJ3ZhbHVlRmllbGQnXSB8fCAndmFsdWUnO1xyXG4gICAgICAgIHRoaXMub3V0VHlwZSA9IG9wdGlvbnNbJ291dFR5cGUnXSB8fCBFbnVtT3V0VHlwZS5hcnJheTtcclxuXHJcbiAgICAgICAgb3B0aW9uc1snc2hvd1NvcnRCdG5zJ10gPSB0aGlzLm91dFR5cGUgPT09IEVudW1PdXRUeXBlLmFycmF5O1xyXG5cclxuICAgICAgICB0aGlzLmRsZ1JlZiA9IHRoaXMubW9kYWxTZXJ2aWNlLnNob3codGhpcy5lbnVtRWRpdG9yUmVmLCB7XHJcbiAgICAgICAgICAgIHdpZHRoOiA4MDAsIGhlaWdodDogNTAwLFxyXG4gICAgICAgICAgICB0aXRsZTogdGhpcy5sb2NhbGVTZXJ2aWNlLmdldFZhbHVlKCdlbnVtRWRpdG9yLnRpdGxlJyksIGVuYWJsZVNjcm9sbDogZmFsc2UsXHJcbiAgICAgICAgICAgIG1pbkhlaWdodDogMzk4LCBtaW5XaWR0aDogNzk4LCBpY29uQ2xzOiAnZi1pY29uIGYtaWNvbi10b3BfZGV2ZWxvcG1lbnR0b29sJyxcclxuICAgICAgICAgICAgYnV0dG9uczogW1xyXG4gICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgIHRleHQ6IHRoaXMubG9jYWxlU2VydmljZS5nZXRWYWx1ZSgnZW51bUVkaXRvci5jYW5jZWxCdXR0b24nKSxcclxuICAgICAgICAgICAgICAgICAgICBjbHM6ICdidG4gYnRuLW91dGxpbmUtc2Vjb25kYXJ5JyxcclxuICAgICAgICAgICAgICAgICAgICBoYW5kbGU6ICgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW5jZWwoKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgIHRleHQ6IHRoaXMubG9jYWxlU2VydmljZS5nZXRWYWx1ZSgnZW51bUVkaXRvci5va0J1dHRvbicpLFxyXG4gICAgICAgICAgICAgICAgICAgIGNsczogJ2J0biBidG4tcHJpbWFyeScsXHJcbiAgICAgICAgICAgICAgICAgICAgaGFuZGxlOiAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2F2ZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgXSxcclxuICAgICAgICAgICAgaW5pdGlhbFN0YXRlOiBvcHRpb25zLFxyXG4gICAgICAgICAgICBkaWFsb2dGb290ZXJTdHlsZXM6IHsgYmFja2dyb3VuZDogJyNGNEY2RjknIH0sXHJcbiAgICAgICAgICAgIGJ1dHRvbkFsaWduOiAncmlnaHQnLFxyXG4gICAgICAgICAgICBjbG9zZWQ6IChpc0Nsb3NlQnV0dG9uQ2xpY2s6IGJvb2xlYW4pID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChpc0Nsb3NlQnV0dG9uQ2xpY2spIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbmNlbCgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHRoaXMuZW51bUVkaXRvclJlZi5pbnN0YW5jZS5oZWlnaHQgPSB0aGlzLmRsZ1JlZi5kaWFsb2cuaW5zdGFuY2UuZ2V0Q29udGFpbmVyU2l6ZSgpLmhlaWdodDtcclxuXHJcbiAgICAgICAgdGhpcy5kbGdSZWYuZGlhbG9nLmluc3RhbmNlLnJlc2l6ZWQuc3Vic2NyaWJlKHNpemUgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLmVudW1FZGl0b3JSZWYuaW5zdGFuY2UuaGVpZ2h0ID0gc2l6ZS5jb250YWluZXJIZWlnaHQ7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHRoaXMuZW51bUVkaXRvclJlZi5jaGFuZ2VEZXRlY3RvclJlZi5kZXRlY3RDaGFuZ2VzKCk7XHJcblxyXG4gICAgICAgIHRoaXMuZGxnUmVmLmRpYWxvZy5jaGFuZ2VEZXRlY3RvclJlZi5yZWF0dGFjaCgpO1xyXG4gICAgICAgIC8vIHRoaXMub3BlbkRpYWxvZy5lbWl0KCk7XHJcbiAgICB9XHJcblxyXG4gICAgY2FuY2VsKCkge1xyXG4gICAgICAgIHRoaXMuX2RhdGFDaGFuZ2VkKHRoaXMub3JpZ2luYWxEYXRhKTtcclxuICAgICAgICB0aGlzLmRsZ1JlZi5jbG9zZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIHNhdmUoKSB7XHJcbiAgICAgICAgY29uc3QgZW51bURhdGEgPSB0aGlzLmVudW1FZGl0b3JSZWYuaW5zdGFuY2UuZGF0YTtcclxuICAgICAgICB0aGlzLl9kYXRhQ2hhbmdlZChlbnVtRGF0YSk7XHJcbiAgICAgICAgdGhpcy5kbGdSZWYuY2xvc2UoKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIF9kYXRhQ2hhbmdlZChlbnVtRGF0YTogYW55KSB7XHJcbiAgICAgICAgY29uc3Qgc3RyID0gdGhpcy50b1N0cmluZyhlbnVtRGF0YSk7XHJcbiAgICAgICAgdGhpcy5kYXRhQ2hhbmdlZC5uZXh0KHN0cik7XHJcbiAgICB9XHJcblxyXG4gICAgdG9TdHJpbmcoZW51bURhdGE6IGFueSkge1xyXG4gICAgICAgIGlmIChlbnVtRGF0YSAmJiBlbnVtRGF0YS5sZW5ndGgpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMub3V0VHlwZSA9PT0gRW51bU91dFR5cGUuYXJyYXkpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShlbnVtRGF0YSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBvYmogPSBlbnVtRGF0YS5yZWR1Y2UoKHIsIGMpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICByW2NbdGhpcy52YWx1ZUZpZWxkXV0gPSBjW3RoaXMudGV4dEZpZWxkXTtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcjtcclxuICAgICAgICAgICAgICAgIH0sIHt9KTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShvYmopO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiAnJztcclxuICAgIH1cclxuXHJcbiAgICB0b0pTT04odmFsOiBhbnkpIHtcclxuICAgICAgICBsZXQgZW51bURhdGEgPSBbXTtcclxuICAgICAgICBpZiAodmFsKSB7XHJcbiAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsID09PSAnc3RyaW5nJykge1xyXG4gICAgICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgICAgICBlbnVtRGF0YSA9IEpTT04ucGFyc2UodmFsKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5vdXRUeXBlID09PSBFbnVtT3V0VHlwZS5vYmplY3QpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZW51bURhdGEgPSB0aGlzLmNvbnZlcnRPYmplY3QyQXJyYXkoZW51bURhdGEpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgICAgICAgICBlbnVtRGF0YSA9IFtdO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybihlKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbCkpIHtcclxuICAgICAgICAgICAgICAgICAgICBlbnVtRGF0YSA9IHZhbDtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZW51bURhdGEgPSB0aGlzLmNvbnZlcnRPYmplY3QyQXJyYXkodmFsKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gZW51bURhdGE7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBjb252ZXJ0T2JqZWN0MkFycmF5KG9iajogYW55KSB7XHJcbiAgICAgICAgY29uc3QgX2VudW1EYXRhID0gW107XHJcbiAgICAgICAgT2JqZWN0LmtleXMob2JqKS5mb3JFYWNoKG4gPT4ge1xyXG4gICAgICAgICAgICBfZW51bURhdGEucHVzaCh7IFt0aGlzLnZhbHVlRmllbGRdOiBuLCBbdGhpcy50ZXh0RmllbGRdOiBvYmpbbl0gfSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJldHVybiBfZW51bURhdGE7XHJcbiAgICB9XHJcbn1cclxuIl19