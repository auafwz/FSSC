/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { of } from 'rxjs';
import { switchMap } from 'rxjs/operators';
/**
 * 检查帮助输入框值变化后返回的查询结果
 * @param {?=} data
 * @return {?}
 */
function checkSearchResult(data) {
    if (data === void 0) { data = null; }
    if (this.searchOnServer) {
        // this._searchResult = data;
        // this.showDialog();
        this.isShow = true;
    }
    else {
        this.setModelValue(this.displayText);
        this.runDictPickedEvent(null);
    }
}
/**
 * @return {?}
 */
export function onTextChanged() {
    var _this = this;
    /** @type {?} */
    var self = this;
    /** @type {?} */
    var isPending = (/**
     * @return {?}
     */
    function () {
        return _this.lookupUtils.rts.getFormState('lookup.pending');
    });
    /** @type {?} */
    var searchData = (/**
     * @param {?} e
     * @return {?}
     */
    function (e) {
        if (_this.isTextChange && _this.displayText && (!_this.nosearch || e.originalEvent) && !isPending()) {
            _this.lookupUtils.pendingStart();
            _this.dictPickingSubscription = _this.dictPicking({
                instance: _this
            }).pipe(switchMap((/**
             * @param {?} pr
             * @return {?}
             */
            function (pr) {
                /** @type {?} */
                var o = true;
                if (pr === undefined || pr === null) {
                    o = true;
                }
                if (typeof pr === 'boolean') {
                    o = pr;
                }
                if (typeof pr === 'object') {
                    if (pr.showDialog === undefined) {
                        o = true;
                    }
                    else {
                        o = pr.showDialog;
                    }
                    if (pr.data) {
                        /** 保存帮助前传递的数据 */
                        _this.customData = pr.data;
                    }
                }
                if (o) {
                    return _this.httpMgr.getData({
                        search: {
                            field: '*',
                            value: _this.displayText
                        }
                    }, 'search');
                }
                else {
                    return of({ SHOWDIALOG: o, MESSAGE: pr.message || '' });
                }
            }))).subscribe((/**
             * @param {?} data
             * @return {?}
             */
            function (data) {
                _this.closeLoading();
                _this.lookupUtils.pendingEnd();
                if (data.hasOwnProperty('SHOWDIALOG')) {
                    if (data.SHOWDIALOG && data.MESSAGE) {
                        _this.notifyService.warning(data.MESSAGE);
                    }
                    return;
                }
                if (data.items && data.items.length === 1) {
                    /** @type {?} */
                    var rowdata = data.items[0];
                    if (_this.isTree()) {
                        /** @type {?} */
                        var leafNode = _this.treeNodeHelper.getLeafNode(rowdata);
                        if (Array.isArray(leafNode)) {
                            checkSearchResult.bind(self, data)();
                            return;
                        }
                        else {
                            rowdata = leafNode.data;
                        }
                    }
                    if (!_this.singleSelect) {
                        rowdata = [rowdata];
                    }
                    _this.selectItem(rowdata);
                }
                else {
                    checkSearchResult.bind(self, data)();
                }
            }), (/**
             * @param {?} err
             * @return {?}
             */
            function (err) {
                _this.closeLoading();
                _this.lookupUtils.pendingEnd();
                _this.messagerService.error(err ? err.Message : err);
            }));
        }
    });
    /** @type {?} */
    var inputBlurHandler = null;
    if (this.inputGroup && this.inputGroup.textbox && !this.nosearch) {
        this.lookupUtils.setActiveLookupInstance(this);
        inputBlurHandler = this.render2.listen(this.inputGroup.textbox.nativeElement, 'blur', searchData);
    }
    if (this.inputGroup) {
        this.inputGroup.enterHandle.subscribe(searchData);
        this.inputGroup.keydownHandle.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        function (e) {
            /** @type {?} */
            var canOpen = false;
            if (e.code === 'ArrowRight') {
                if (_this.editable) {
                    canOpen = !e.target.value || e.target.selectionStart === e.target.value.length;
                }
                else {
                    canOpen = true;
                }
            }
            else {
                canOpen = e.code === _this.shortcutKey.open;
            }
            if (canOpen) {
                e.stopPropagation();
                e.preventDefault();
                _this.showDialog();
            }
        }));
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib24tdGV4dC1jaGFuZ2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL3VpLWxvb2t1cC8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy9vbi10ZXh0LWNoYW5nZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFTLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNqQyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7Ozs7OztBQU0zQyxTQUFTLGlCQUFpQixDQUFDLElBQVc7SUFBWCxxQkFBQSxFQUFBLFdBQVc7SUFDbEMsSUFBSSxJQUFJLENBQUMsY0FBYyxFQUFFO1FBQ3JCLDZCQUE2QjtRQUM3QixxQkFBcUI7UUFDckIsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUM7S0FDdEI7U0FBTTtRQUNILElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ3JDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztLQUNqQztBQUNMLENBQUM7Ozs7QUFFRCxNQUFNLFVBQVUsYUFBYTtJQUE3QixpQkF3SEM7O1FBdEhTLElBQUksR0FBRyxJQUFJOztRQUVYLFNBQVM7OztJQUFHO1FBQ2QsT0FBTyxLQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztJQUMvRCxDQUFDLENBQUE7O1FBRUssVUFBVTs7OztJQUFHLFVBQUMsQ0FBQztRQUNqQixJQUFJLEtBQUksQ0FBQyxZQUFZLElBQUksS0FBSSxDQUFDLFdBQVcsSUFBSSxDQUFDLENBQUMsS0FBSSxDQUFDLFFBQVEsSUFBSSxDQUFDLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsRUFBRTtZQUM5RixLQUFJLENBQUMsV0FBVyxDQUFDLFlBQVksRUFBRSxDQUFDO1lBRWhDLEtBQUksQ0FBQyx1QkFBdUIsR0FBRyxLQUFJLENBQUMsV0FBVyxD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SSxDQUFDO2FBQzlDO1lBQ0QsSUFBSSxPQUFPLEVBQUU7Z0JBQ1QsQ0FBQyxDQUFDLGVBQWUsRUFBRSxDQUFDO2dCQUNwQixDQUFDLENBQUMsY0FBYyxFQUFFLENBQUM7Z0JBQ25CLEtBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQzthQUNyQjtRQUNMLENBQUMsRUFBQyxDQUFDO0tBQ047QUFFTCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRU1QVFksIG9mIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IHN3aXRjaE1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuaW1wb3J0IHsgTG9va3VwR3JpZFJlc3VsdCwgUGlja2luZ1Jlc3VsdCB9IGZyb20gJy4uL2xvb2t1cC1ncmlkLW9wdGlvbnMnO1xyXG5cclxuXHJcblxyXG4gLyoqIOajgOafpeW4ruWKqei+k+WFpeahhuWAvOWPmOWMluWQjui/lOWbnueahOafpeivoue7k+aenCAqL1xyXG5mdW5jdGlvbiBjaGVja1NlYXJjaFJlc3VsdChkYXRhID0gbnVsbCkge1xyXG4gICAgaWYgKHRoaXMuc2VhcmNoT25TZXJ2ZXIpIHtcclxuICAgICAgICAvLyB0aGlzLl9zZWFyY2hSZXN1bHQgPSBkYXRhO1xyXG4gICAgICAgIC8vIHRoaXMuc2hvd0RpYWxvZygpO1xyXG4gICAgICAgIHRoaXMuaXNTaG93ID0gdHJ1ZTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdGhpcy5zZXRNb2RlbFZhbHVlKHRoaXMuZGlzcGxheVRleHQpO1xyXG4gICAgICAgIHRoaXMucnVuRGljdFBpY2tlZEV2ZW50KG51bGwpO1xyXG4gICAgfVxyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gb25UZXh0Q2hhbmdlZCgpIHtcclxuXHJcbiAgICBjb25zdCBzZWxmID0gdGhpcztcclxuXHJcbiAgICBjb25zdCBpc1BlbmRpbmcgPSAoKSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMubG9va3VwVXRpbHMucnRzLmdldEZvcm1TdGF0ZSgnbG9va3VwLnBlbmRpbmcnKTtcclxuICAgIH07XHJcblxyXG4gICAgY29uc3Qgc2VhcmNoRGF0YSA9IChlKSA9PiB7XHJcbiAgICAgICAgaWYgKHRoaXMuaXNUZXh0Q2hhbmdlICYmIHRoaXMuZGlzcGxheVRleHQgJiYgKCF0aGlzLm5vc2VhcmNoIHx8IGUub3JpZ2luYWxFdmVudCkgJiYgIWlzUGVuZGluZygpKSB7XHJcbiAgICAgICAgICAgIHRoaXMubG9va3VwVXRpbHMucGVuZGluZ1N0YXJ0KCk7XHJcblxyXG4gICAgICAgICAgICB0aGlzLmRpY3RQaWNraW5nU3Vic2NyaXB0aW9uID0gdGhpcy5kaWN0UGlja2luZyh7XHJcbiAgICAgICAgICAgICAgICBpbnN0YW5jZTogdGhpc1xyXG4gICAgICAgICAgICB9KS5waXBlKFxyXG4gICAgICAgICAgICAgICAgc3dpdGNoTWFwKChwcjogUGlja2luZ1Jlc3VsdCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCBvID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAocHIgPT09IHVuZGVmaW5lZCB8fCBwciA9PT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBvID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcHIgPT09ICdib29sZWFuJykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBvID0gcHI7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHByID09PSAnb2JqZWN0Jykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocHIuc2hvd0RpYWxvZyA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG8gPSBwci5zaG93RGlhbG9nO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocHIuZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLyoqIOS/neWtmOW4ruWKqeWJjeS8oOmAkueahOaVsOaNriAqL1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jdXN0b21EYXRhID0gcHIuZGF0YTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKG8pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuaHR0cE1nci5nZXREYXRhKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlYXJjaDoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWVsZDogJyonLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogdGhpcy5kaXNwbGF5VGV4dFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnc2VhcmNoJ1xyXG4gICAgICAgICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvZih7IFNIT1dESUFMT0c6IG8sIE1FU1NBR0U6ICBwci5tZXNzYWdlIHx8ICcnIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICkuc3Vic2NyaWJlKFxyXG4gICAgICAgICAgICAgICAgKGRhdGE6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY2xvc2VMb2FkaW5nKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb29rdXBVdGlscy5wZW5kaW5nRW5kKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGEuaGFzT3duUHJvcGVydHkoJ1NIT1dESUFMT0cnKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YS5TSE9XRElBTE9HICYmIGRhdGEuTUVTU0FHRSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5ub3RpZnlTZXJ2aWNlLndhcm5pbmcoZGF0YS5NRVNTQUdFKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGEuaXRlbXMgJiYgZGF0YS5pdGVtcy5sZW5ndGggPT09IDEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHJvd2RhdGEgPSBkYXRhLml0ZW1zWzBdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5pc1RyZWUoKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbGVhZk5vZGUgPSB0aGlzLnRyZWVOb2RlSGVscGVyLmdldExlYWZOb2RlKHJvd2RhdGEpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkobGVhZk5vZGUpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hlY2tTZWFyY2hSZXN1bHQuYmluZChzZWxmLCBkYXRhKSgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcm93ZGF0YSA9IGxlYWZOb2RlLmRhdGE7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLnNpbmdsZVNlbGVjdCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcm93ZGF0YSA9IFsgcm93ZGF0YSBdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0SXRlbShyb3dkYXRhKTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjaGVja1NlYXJjaFJlc3VsdC5iaW5kKHNlbGYsIGRhdGEpKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSwgKGVycjogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jbG9zZUxvYWRpbmcoKTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmxvb2t1cFV0aWxzLnBlbmRpbmdFbmQoKTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc3NhZ2VyU2VydmljZS5lcnJvcihlcnIgPyBlcnIuTWVzc2FnZSA6IGVycik7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICBsZXQgaW5wdXRCbHVySGFuZGxlciA9IG51bGw7XHJcblxyXG4gICAgaWYgKHRoaXMuaW5wdXRHcm91cCAmJiB0aGlzLmlucHV0R3JvdXAudGV4dGJveCAmJiAhdGhpcy5ub3NlYXJjaCkge1xyXG4gICAgICAgIHRoaXMubG9va3VwVXRpbHMuc2V0QWN0aXZlTG9va3VwSW5zdGFuY2UodGhpcyk7XHJcbiAgICAgICAgaW5wdXRCbHVySGFuZGxlciA9IHRoaXMucmVuZGVyMi5saXN0ZW4odGhpcy5pbnB1dEdyb3VwLnRleHRib3gubmF0aXZlRWxlbWVudCwgJ2JsdXInLCBzZWFyY2hEYXRhICk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHRoaXMuaW5wdXRHcm91cCkge1xyXG4gICAgICAgIHRoaXMuaW5wdXRHcm91cC5lbnRlckhhbmRsZS5zdWJzY3JpYmUoIHNlYXJjaERhdGEpO1xyXG5cclxuICAgICAgICB0aGlzLmlucHV0R3JvdXAua2V5ZG93bkhhbmRsZS5zdWJzY3JpYmUoKGU6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICBsZXQgY2FuT3BlbiA9IGZhbHNlO1xyXG4gICAgICAgICAgICBpZiAoZS5jb2RlID09PSAnQXJyb3dSaWdodCcpIHtcclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLmVkaXRhYmxlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FuT3BlbiA9ICFlLnRhcmdldC52YWx1ZSB8fCBlLnRhcmdldC5zZWxlY3Rpb25TdGFydCA9PT0gZS50YXJnZXQudmFsdWUubGVuZ3RoO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBjYW5PcGVuID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGNhbk9wZW4gPSBlLmNvZGUgPT09IHRoaXMuc2hvcnRjdXRLZXkub3BlbjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoY2FuT3Blbikge1xyXG4gICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcclxuICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuc2hvd0RpYWxvZygpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG59XHJcbiJdfQ==