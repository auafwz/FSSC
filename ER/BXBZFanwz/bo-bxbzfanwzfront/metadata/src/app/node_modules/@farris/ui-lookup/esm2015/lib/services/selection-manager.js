/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
export class SelectionManager {
    /**
     * @param {?} ins
     */
    constructor(ins) {
        this.ins = ins;
    }
    /**
     * @return {?}
     */
    destroy() {
    }
    /**
     * @return {?}
     */
    getBindingData() {
        /** @type {?} */
        let jsonData = this.ins.bindingData;
        if (this.ins.ngControl &&
            this.ins.ngControl.formDirective &&
            this.ins.ngControl.formDirective.form &&
            this.ins.ngControl.formDirective.form.bindingData) {
            /** @type {?} */
            const bindingData = this.ins.ngControl.formDirective.form.bindingData;
            jsonData = bindingData;
            if (bindingData.getObject) {
                jsonData = bindingData.getObject().toJSON();
            }
        }
        return jsonData;
    }
    /**
     * @return {?}
     */
    initDisplayValue() {
        /** @type {?} */
        const jsonData = this.getBindingData();
        if (jsonData && this.ins.mapFields) {
            /** @type {?} */
            const idField = this.ins.idField;
            /** @type {?} */
            let targetField = this.ins.mapFields[idField];
            if (targetField) {
                if (targetField.indexOf(',') > -1) {
                    targetField = targetField.split(',')[0];
                }
                /** @type {?} */
                const val = this.ins.utils.getValue(targetField, jsonData);
                if (val) {
                    this.ins.displayValue = val;
                }
            }
        }
    }
    /**
     * @private
     * @return {?}
     */
    _clearSelections() {
        const { cmpRefInstance: t } = this.getDataCmpInstance();
        if (t) {
            if (this.ins.isTree()) {
                // 树表
                t.clearAll(false);
                if (!t.cdRef.destroyed) {
                    t.cdRef.detectChanges();
                }
            }
            else {
                // 列表
                t.dtBody.selectedRowIndex = -1;
                t.dtBody.selections = undefined;
                if (!t.cd.destroyed) {
                    t.cd.detectChanges();
                }
            }
        }
    }
    /**
     * 帮助窗口打开后，根据 displayValue 选中数据
     * @param {?=} selectedIds
     * @return {?}
     */
    selectCurrentValue(selectedIds = []) {
        if (!this.ins.enableToSelect) {
            return;
        }
        const { cmpRefInstance: t, items } = this.getDataCmpInstance();
        if (!t || !items || !items.length) {
            return;
        }
        this._clearSelections();
        if (!selectedIds || !selectedIds.length) {
            /** @type {?} */
            const selectedRows = this.ins.lookupSelectionSer.getSelections();
            if (selectedRows.length) {
                selectedIds = selectedRows.map((/**
                 * @param {?} n
                 * @return {?}
                 */
                n => n[this.ins.idField]));
            }
        }
        // const _ids = this.getSelectedIds();
        // selectedIds = selectedIds.concat(_ids);
        // selectedIds = Array.from(new Set(selectedIds));
        if (selectedIds && selectedIds.length) {
            if (this.ins.isTree()) {
                // 树表
                this.selected4Treetable(t, selectedIds);
                if (!t.cdRef.destroyed) {
                    t.cdRef.detectChanges();
                }
            }
            else {
                // 列表
                this.selected4Datatable(t, items, selectedIds);
                if (!t.cd.destroyed) {
                    t.cd.detectChanges();
                }
            }
        }
    }
    /**
     * @private
     * @return {?}
     */
    getDataCmpInstance() {
        /** @type {?} */
        let ref = null;
        /** @type {?} */
        let items = null;
        if (this.ins.activeTab === 'datalist') {
            if (this.ins.isTree()) {
                ref = this.ins.lookupCmpMgr.getComponentInstance('treetable');
                items = ((/** @type {?} */ (ref))).serializedValue;
            }
            else {
                items = this.ins.items;
                ref = this.ins.lookupCmpMgr.getComponentInstance();
            }
        }
        else if (this.ins.activeTab === 'favorite') {
            ref = this.ins.lookupCmpMgr.getComponentInstance('fav');
            items = this.ins.favoriteItems;
        }
        return { cmpRefInstance: ref, items };
    }
    /**
     * @private
     * @param {?} t
     * @param {?} items
     * @param {?} values
     * @return {?}
     */
    selected4Datatable(t, items, values) {
        if (this.ins.singleSelect) {
            items.forEach((/**
             * @param {?} item
             * @param {?} index
             * @return {?}
             */
            (item, index) => {
                if (item[this.ins.idField] === values[0]) {
                    if (!t.dtBody.isSelected(item)) {
                        t.dtBody.selectedRowIndex = -1;
                        t.dtBody.selectedRow('', index, item);
                    }
                }
            }));
        }
        else {
            // const values = this.getSelectedIds();
            values.forEach((/**
             * @param {?} id
             * @return {?}
             */
            id => {
                /** @type {?} */
                const r = items.find((/**
                 * @param {?} n
                 * @return {?}
                 */
                n => n[this.ins.idField] == id));
                if (r) {
                    t.checkRow(id);
                }
            }));
        }
    }
    /**
     * @private
     * @param {?} t
     * @param {?} valueArr
     * @return {?}
     */
    selected4Treetable(t, valueArr) {
        if (this.ins.singleSelect) {
            t.selectNode(valueArr[0], false, false);
        }
        else {
            // const valueArr = this.getSelectedIds();
            t.checkedNodes(valueArr, false, false);
            t.selectNodes(valueArr);
        }
    }
    /**
     * @return {?}
     */
    getSelectedIds() {
        /** @type {?} */
        let values = [];
        /** @type {?} */
        const s = this.ins.multipleChoiceSeparator;
        if (!this.ins.singleSelect && this.ins.displayValue && ('' + this.ins.displayValue).indexOf(s) > -1) {
            values = this.ins.displayValue.split(s);
        }
        else {
            if (this.ins.displayValue !== null && this.ins.displayValue !== '' && this.ins.displayValue !== undefined) {
                values = [this.ins.displayValue];
            }
        }
        // 启用显示多选列表
        if (this.ins.showSelected) {
            /** @type {?} */
            const rows = this.ins.lookupSelectionSer.getSelections();
            if (rows && rows.length) {
                values = rows.map((/**
                 * @param {?} n
                 * @return {?}
                 */
                n => n[this.ins.idField]));
            }
            else {
                values = [];
            }
        }
        return values;
    }
}
if (false) {
    /**
     * @type {?}
     * @private
     */
    SelectionManager.prototype.ins;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VsZWN0aW9uLW1hbmFnZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL3VpLWxvb2t1cC8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy9zZWxlY3Rpb24tbWFuYWdlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBSUEsTUFBTSxPQUFPLGdCQUFnQjs7OztJQUN6QixZQUFvQixHQUF3QjtRQUF4QixRQUFHLEdBQUgsR0FBRyxDQUFxQjtJQUU1QyxDQUFDOzs7O0lBRUQsT0FBTztJQUNQLENBQUM7Ozs7SUFFRCxjQUFjOztZQUNOLFFBQVEsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLFdBQVc7UUFDbkMsSUFDSSxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVM7WUFDbEIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsYUFBYTtZQUNoQyxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxhQUFhLENBQUMsSUFBSTtZQUNyQyxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFDbkQ7O2tCQUNRLFdBQVcsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLFdBQVc7WUFDckUsUUFBUSxHQUFHLFdBQVcsQ0FBQztZQUV2QixJQUFJLFdBQVcsQ0FBQyxTQUFTLEVBQUU7Z0JBQ3ZCLFFBQVEsR0FBRyxXQUFXLENBQUMsU0FBUyxFQUFFLENBQUMsTUFBTSxFQUFFLENBQUM7YUFDL0M7U0FDSjtRQUNELE9BQU8sUUFBUSxDQUFDO0lBQ3BCLENBQUM7Ozs7SUFFRCxnQkFBZ0I7O2NBQ04sUUFBUSxHQUFHLElBQUksQ0FBQyxjQUFjLEVBQUU7UUFDdEMsSUFBSSxRQUFRLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxTQUFTLEVBQUU7O2tCQUMxQixPQUFPLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPOztnQkFDNUIsV0FBVyxHQUFH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K0JBQWdDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVHJlZVRhYmxlQ29tcG9uZW50IH0gZnJvbSAnQGZhcnJpcy91aS10cmVldGFibGUnO1xyXG5pbXBvcnQgeyBMb29rdXBHcmlkQ29tcG9uZW50IH0gZnJvbSAnLi4vbG9va3VwLWdyaWQuY29tcG9uZW50JztcclxuXHJcblxyXG5leHBvcnQgY2xhc3MgU2VsZWN0aW9uTWFuYWdlciB7XHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGluczogTG9va3VwR3JpZENvbXBvbmVudCkge1xyXG5cclxuICAgIH1cclxuXHJcbiAgICBkZXN0cm95KCkge1xyXG4gICAgfVxyXG5cclxuICAgIGdldEJpbmRpbmdEYXRhKCkge1xyXG4gICAgICAgIGxldCBqc29uRGF0YSA9IHRoaXMuaW5zLmJpbmRpbmdEYXRhO1xyXG4gICAgICAgIGlmIChcclxuICAgICAgICAgICAgdGhpcy5pbnMubmdDb250cm9sICYmXHJcbiAgICAgICAgICAgIHRoaXMuaW5zLm5nQ29udHJvbC5mb3JtRGlyZWN0aXZlICYmXHJcbiAgICAgICAgICAgIHRoaXMuaW5zLm5nQ29udHJvbC5mb3JtRGlyZWN0aXZlLmZvcm0gJiZcclxuICAgICAgICAgICAgdGhpcy5pbnMubmdDb250cm9sLmZvcm1EaXJlY3RpdmUuZm9ybS5iaW5kaW5nRGF0YVxyXG4gICAgICAgICkge1xyXG4gICAgICAgICAgICBjb25zdCBiaW5kaW5nRGF0YSA9IHRoaXMuaW5zLm5nQ29udHJvbC5mb3JtRGlyZWN0aXZlLmZvcm0uYmluZGluZ0RhdGE7XHJcbiAgICAgICAgICAgIGpzb25EYXRhID0gYmluZGluZ0RhdGE7XHJcblxyXG4gICAgICAgICAgICBpZiAoYmluZGluZ0RhdGEuZ2V0T2JqZWN0KSB7XHJcbiAgICAgICAgICAgICAgICBqc29uRGF0YSA9IGJpbmRpbmdEYXRhLmdldE9iamVjdCgpLnRvSlNPTigpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBqc29uRGF0YTtcclxuICAgIH1cclxuXHJcbiAgICBpbml0RGlzcGxheVZhbHVlKCkge1xyXG4gICAgICAgIGNvbnN0IGpzb25EYXRhID0gdGhpcy5nZXRCaW5kaW5nRGF0YSgpO1xyXG4gICAgICAgIGlmIChqc29uRGF0YSAmJiB0aGlzLmlucy5tYXBGaWVsZHMpIHtcclxuICAgICAgICAgICAgY29uc3QgaWRGaWVsZCA9IHRoaXMuaW5zLmlkRmllbGQ7XHJcbiAgICAgICAgICAgIGxldCB0YXJnZXRGaWVsZCA9IHRoaXMuaW5zLm1hcEZpZWxkc1tpZEZpZWxkXTtcclxuXHJcbiAgICAgICAgICAgIGlmICh0YXJnZXRGaWVsZCkge1xyXG4gICAgICAgICAgICAgICAgaWYgKHRhcmdldEZpZWxkLmluZGV4T2YoJywnKSA+IC0xICkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRhcmdldEZpZWxkID0gdGFyZ2V0RmllbGQuc3BsaXQoJywnKVswXTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBjb25zdCB2YWwgPSB0aGlzLmlucy51dGlscy5nZXRWYWx1ZSh0YXJnZXRGaWVsZCwganNvbkRhdGEpO1xyXG4gICAgICAgICAgICAgICAgaWYgKHZhbCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaW5zLmRpc3BsYXlWYWx1ZSA9IHZhbDtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIF9jbGVhclNlbGVjdGlvbnMoKSB7XHJcbiAgICAgICAgY29uc3QgeyBjbXBSZWZJbnN0YW5jZTogdCB9ID0gdGhpcy5nZXREYXRhQ21wSW5zdGFuY2UoKTtcclxuICAgICAgICBpZiAodCkge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5pbnMuaXNUcmVlKCkpIHtcclxuICAgICAgICAgICAgICAgIC8vIOagkeihqFxyXG4gICAgICAgICAgICAgICAgdC5jbGVhckFsbChmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICBpZiAoIXQuY2RSZWYuZGVzdHJveWVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdC5jZFJlZi5kZXRlY3RDaGFuZ2VzKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAvLyDliJfooahcclxuICAgICAgICAgICAgICAgIHQuZHRCb2R5LnNlbGVjdGVkUm93SW5kZXggPSAtMTtcclxuICAgICAgICAgICAgICAgIHQuZHRCb2R5LnNlbGVjdGlvbnMgPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgICAgICAgICBpZiAoIXQuY2QuZGVzdHJveWVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdC5jZC5kZXRlY3RDaGFuZ2VzKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDluK7liqnnqpflj6PmiZPlvIDlkI7vvIzmoLnmja4gZGlzcGxheVZhbHVlIOmAieS4reaVsOaNrlxyXG4gICAgICovXHJcbiAgICBzZWxlY3RDdXJyZW50VmFsdWUoc2VsZWN0ZWRJZHMgPSBbXSkge1xyXG5cclxuICAgICAgICBpZiAoIXRoaXMuaW5zLmVuYWJsZVRvU2VsZWN0KSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG5cclxuICAgICAgICBjb25zdCB7IGNtcFJlZkluc3RhbmNlOiB0LCBpdGVtcyB9ID0gdGhpcy5nZXREYXRhQ21wSW5zdGFuY2UoKTtcclxuICAgICAgICBpZiAoIXQgfHwgIWl0ZW1zIHx8ICFpdGVtcy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5fY2xlYXJTZWxlY3Rpb25zKCk7XHJcblxyXG4gICAgICAgIGlmICghc2VsZWN0ZWRJZHMgfHwgIXNlbGVjdGVkSWRzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICBjb25zdCBzZWxlY3RlZFJvd3MgPSB0aGlzLmlucy5sb29rdXBTZWxlY3Rpb25TZXIuZ2V0U2VsZWN0aW9ucygpO1xyXG4gICAgICAgICAgICBpZiAoc2VsZWN0ZWRSb3dzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgc2VsZWN0ZWRJZHMgPSBzZWxlY3RlZFJvd3MubWFwKG4gPT4gblt0aGlzLmlucy5pZEZpZWxkXSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIGNvbnN0IF9pZHMgPSB0aGlzLmdldFNlbGVjdGVkSWRzKCk7XHJcbiAgICAgICAgLy8gc2VsZWN0ZWRJZHMgPSBzZWxlY3RlZElkcy5jb25jYXQoX2lkcyk7XHJcbiAgICAgICAgLy8gc2VsZWN0ZWRJZHMgPSBBcnJheS5mcm9tKG5ldyBTZXQoc2VsZWN0ZWRJZHMpKTtcclxuXHJcbiAgICAgICAgaWYgKHNlbGVjdGVkSWRzICYmIHNlbGVjdGVkSWRzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5pbnMuaXNUcmVlKCkpIHtcclxuICAgICAgICAgICAgICAgIC8vIOagkeihqFxyXG4gICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RlZDRUcmVldGFibGUodCwgc2VsZWN0ZWRJZHMpO1xyXG4gICAgICAgICAgICAgICAgaWYgKCF0LmNkUmVmLmRlc3Ryb3llZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHQuY2RSZWYuZGV0ZWN0Q2hhbmdlcygpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgLy8g5YiX6KGoXHJcbiAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdGVkNERhdGF0YWJsZSh0LCBpdGVtcywgc2VsZWN0ZWRJZHMpO1xyXG4gICAgICAgICAgICAgICAgaWYgKCF0LmNkLmRlc3Ryb3llZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHQuY2QuZGV0ZWN0Q2hhbmdlcygpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZ2V0RGF0YUNtcEluc3RhbmNlKCkge1xyXG4gICAgICAgIGxldCByZWYgPSBudWxsO1xyXG4gICAgICAgIGxldCBpdGVtcyA9IG51bGw7XHJcbiAgICAgICAgaWYgKHRoaXMuaW5zLmFjdGl2ZVRhYiA9PT0gJ2RhdGFsaXN0Jykge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5pbnMuaXNUcmVlKCkpIHtcclxuICAgICAgICAgICAgICAgIHJlZiA9IHRoaXMuaW5zLmxvb2t1cENtcE1nci5nZXRDb21wb25lbnRJbnN0YW5jZSgndHJlZXRhYmxlJyk7XHJcbiAgICAgICAgICAgICAgICBpdGVtcyA9IChyZWYgYXMgVHJlZVRhYmxlQ29tcG9uZW50KS5zZXJpYWxpemVkVmFsdWU7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBpdGVtcyA9IHRoaXMuaW5zLml0ZW1zO1xyXG4gICAgICAgICAgICAgICAgcmVmID0gdGhpcy5pbnMubG9va3VwQ21wTWdyLmdldENvbXBvbmVudEluc3RhbmNlKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaW5zLmFjdGl2ZVRhYiA9PT0gJ2Zhdm9yaXRlJykge1xyXG4gICAgICAgICAgICByZWYgPSB0aGlzLmlucy5sb29rdXBDbXBNZ3IuZ2V0Q29tcG9uZW50SW5zdGFuY2UoJ2ZhdicpO1xyXG4gICAgICAgICAgICBpdGVtcyA9IHRoaXMuaW5zLmZhdm9yaXRlSXRlbXM7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB7IGNtcFJlZkluc3RhbmNlOiByZWYsIGl0ZW1zIH07XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzZWxlY3RlZDREYXRhdGFibGUodDogYW55LCBpdGVtczogYW55LCB2YWx1ZXM6IGFueSkge1xyXG4gICAgICAgIGlmICh0aGlzLmlucy5zaW5nbGVTZWxlY3QpIHtcclxuICAgICAgICAgICAgaXRlbXMuZm9yRWFjaCgoaXRlbSwgaW5kZXgpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChpdGVtW3RoaXMuaW5zLmlkRmllbGRdID09PSB2YWx1ZXNbMF0pIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoIXQuZHRCb2R5LmlzU2VsZWN0ZWQoaXRlbSkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdC5kdEJvZHkuc2VsZWN0ZWRSb3dJbmRleCA9IC0xO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0LmR0Qm9keS5zZWxlY3RlZFJvdygnJywgaW5kZXgsIGl0ZW0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgLy8gY29uc3QgdmFsdWVzID0gdGhpcy5nZXRTZWxlY3RlZElkcygpO1xyXG4gICAgICAgICAgICB2YWx1ZXMuZm9yRWFjaChpZCA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCByID0gaXRlbXMuZmluZChuID0+IG5bdGhpcy5pbnMuaWRGaWVsZF0gPT0gaWQpO1xyXG4gICAgICAgICAgICAgICAgaWYgKHIpIHtcclxuICAgICAgICAgICAgICAgICAgICB0LmNoZWNrUm93KGlkKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgc2VsZWN0ZWQ0VHJlZXRhYmxlKHQ6IGFueSwgdmFsdWVBcnI6IGFueSkge1xyXG4gICAgICAgIGlmICh0aGlzLmlucy5zaW5nbGVTZWxlY3QpIHtcclxuICAgICAgICAgICAgdC5zZWxlY3ROb2RlKHZhbHVlQXJyWzBdLCBmYWxzZSwgZmFsc2UpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIC8vIGNvbnN0IHZhbHVlQXJyID0gdGhpcy5nZXRTZWxlY3RlZElkcygpO1xyXG4gICAgICAgICAgICB0LmNoZWNrZWROb2Rlcyh2YWx1ZUFyciwgZmFsc2UsIGZhbHNlKTtcclxuICAgICAgICAgICAgdC5zZWxlY3ROb2Rlcyh2YWx1ZUFycik7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGdldFNlbGVjdGVkSWRzKCkge1xyXG4gICAgICAgIGxldCB2YWx1ZXMgPSBbXTtcclxuICAgICAgICBjb25zdCBzID0gdGhpcy5pbnMubXVsdGlwbGVDaG9pY2VTZXBhcmF0b3I7IC8vIOWkmumAieWIhumalOesplxyXG4gICAgICAgIGlmICghdGhpcy5pbnMuc2luZ2xlU2VsZWN0ICYmIHRoaXMuaW5zLmRpc3BsYXlWYWx1ZSAmJiAoJycgKyB0aGlzLmlucy5kaXNwbGF5VmFsdWUpLmluZGV4T2YocykgPiAtMSkge1xyXG4gICAgICAgICAgICB2YWx1ZXMgPSB0aGlzLmlucy5kaXNwbGF5VmFsdWUuc3BsaXQocyk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuaW5zLmRpc3BsYXlWYWx1ZSAhPT0gbnVsbCAmJiB0aGlzLmlucy5kaXNwbGF5VmFsdWUgIT09ICcnICYmIHRoaXMuaW5zLmRpc3BsYXlWYWx1ZSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICB2YWx1ZXMgPSBbdGhpcy5pbnMuZGlzcGxheVZhbHVlXTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8g5ZCv55So5pi+56S65aSa6YCJ5YiX6KGoXHJcbiAgICAgICAgaWYgKHRoaXMuaW5zLnNob3dTZWxlY3RlZCkge1xyXG4gICAgICAgICAgICBjb25zdCByb3dzID0gdGhpcy5pbnMubG9va3VwU2VsZWN0aW9uU2VyLmdldFNlbGVjdGlvbnMoKTtcclxuICAgICAgICAgICAgaWYgKHJvd3MgJiYgcm93cy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgIHZhbHVlcyA9IHJvd3MubWFwKG4gPT4gblt0aGlzLmlucy5pZEZpZWxkXSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB2YWx1ZXMgPSBbXTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHZhbHVlcztcclxuICAgIH1cclxufVxyXG5cclxuXHJcblxyXG4iXX0=