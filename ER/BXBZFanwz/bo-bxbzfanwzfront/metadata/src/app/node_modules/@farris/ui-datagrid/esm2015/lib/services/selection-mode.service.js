/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { DatagridComponent } from './../datagrid.component';
import { Injectable } from '@angular/core';
import { delay } from 'rxjs/operators';
export class SelectionModeService {
    /**
     * @param {?} grid
     */
    constructor(grid) {
        this.dgRef = null;
        this.oldSettings = null;
        this.selectStartEvent = null;
        this.events = null;
        this.dgRef = grid;
        if (this.dgRef.selectionMode === 'default') {
            grid.zone.runOutsideAngular((/**
             * @return {?}
             */
            () => {
                this.events = this.registerStopSelectionEvent();
            }));
        }
    }
    /**
     * @return {?}
     */
    removeEvents() {
        if (this.events && this.events.length) {
            this.events.forEach((/**
             * @param {?} e
             * @return {?}
             */
            e => {
                e();
            }));
            this.events = null;
        }
    }
    /**
     * @return {?}
     */
    toggleMode() {
        if (this.dgRef) {
            if (this.dgRef.selectionMode === 'default') {
                this.enableWindowsSelectionMode();
            }
            else {
                this.restoreSettings();
            }
        }
    }
    /**
     * @return {?}
     */
    enableWindowsSelectionMode() {
        if (this.dgRef) {
            this.oldSettings = {
                showCheckbox: this.dgRef.showCheckbox,
                keepSelect: this.dgRef.keepSelect,
                onlySelectSelf: this.dgRef.onlySelectSelf,
                selectOnCheck: this.dgRef.selectOnCheck,
                checkOnSelect: this.dgRef.checkOnSelect
            };
            this.dgRef.showCheckbox = true;
            this.dgRef.keepSelect = true;
            this.dgRef.onlySelectSelf = false;
            this.dgRef.selectOnCheck = true;
            this.dgRef.checkOnSelect = true;
            this.dgRef.dfs.updateProperty('keepSelect', true);
            this.dgRef.dfs.updateProperty('onlySelectSelf', false);
            this.dgRef.dfs.updateProperty('selectOnCheck', true);
            this.dgRef.dfs.updateProperty('checkOnSelect', true);
        }
    }
    /**
     * @return {?}
     */
    restoreSettings() {
        if (this.dgRef && this.oldSettings) {
            this.dgRef.showCheckbox = this.oldSettings.showCheckbox;
            this.dgRef.keepSelect = this.oldSettings.keepSelect;
            this.dgRef.onlySelectSelf = this.oldSettings.onlySelectSelf;
            this.dgRef.selectOnCheck = this.oldSettings.selectOnCheck;
            this.dgRef.checkOnSelect = this.oldSettings.checkOnSelect;
            this.dgRef.dfs.updateProperty('keepSelect', this.oldSettings.keepSelect);
            this.dgRef.dfs.updateProperty('onlySelectSelf', this.oldSettings.onlySelectSelf);
            this.dgRef.dfs.updateProperty('selectOnCheck', this.oldSettings.selectOnCheck);
            this.dgRef.dfs.updateProperty('checkOnSelect', this.oldSettings.checkOnSelect);
        }
    }
    /**
     * @private
     * @return {?}
     */
    registerStopSelectionEvent() {
        /** @type {?} */
        const kd = this.dgRef.render2.listen(document, 'keydown', (/**
         * @param {?} event
         * @return {?}
         */
        (event) => {
            if (event.ctrlKey || event.shiftKey) {
                this.unselectable();
            }
        }));
        /** @type {?} */
        const ku = this.dgRef.render2.listen(document, 'keyup', (/**
         * @param {?} event
         * @return {?}
         */
        (event) => {
            if (event.ctrlKey || event.shiftKey || event.keyCode === 17 || event.keyCode === 16) {
                this.enableSelectable();
            }
        }));
        return [kd, ku];
    }
    /**
     * @private
     * @return {?}
     */
    unselectable() {
        this.dgRef.render2.setAttribute(this.dgRef.dgContainer.nativeElement, 'unselectable', 'on');
        this.dgRef.render2.setAttribute(this.dgRef.dgContainer.nativeElement, 'onselectstart', 'return false');
        this.dgRef.render2.setStyle(this.dgRef.dgContainer.nativeElement, '-moz-user-select', 'none');
    }
    /**
     * @private
     * @return {?}
     */
    enableSelectable() {
        this.dgRef.render2.removeAttribute(this.dgRef.dgContainer.nativeElement, 'unselectable');
        this.dgRef.render2.removeAttribute(this.dgRef.dgContainer.nativeElement, 'onselectstart');
        this.dgRef.render2.removeStyle(this.dgRef.dgContainer.nativeElement, '-moz-user-select');
    }
    /**
     * @param {?} param
     * @return {?}
     */
    beforRowClick(param) {
        if (this.dgRef && this.dgRef.selectionMode === 'default') {
            /** @type {?} */
            const isSelected = this.dgRef.dfs.isRowSelected(param.id);
            /** @type {?} */
            const isCtrlKey = param.e.ctrlKey;
            /** @type {?} */
            const isShiftKey = param.e.shiftKey;
            this.dgRef.endEditing();
            if (!isCtrlKey && !isShiftKey) {
                if (!isSelected) {
                    this.dgRef.clearCheckeds();
                }
                else {
                    // 如果有多条选，移除其他选中行
                    /** @type {?} */
                    const currentPagerIds = this.dgRef.getRows().map((/**
                     * @param {?} n
                     * @return {?}
                     */
                    n => n.id));
                    /** @type {?} */
                    const unCheckIDs = this.dgRef.checkValues.filter((/**
                     * @param {?} i
                     * @return {?}
                     */
                    i => currentPagerIds.includes(i) && i != param.id));
                    /** @type {?} */
                    const unSelectIds = this.dgRef.checkValues.filter((/**
                     * @param {?} n
                     * @return {?}
                     */
                    n => !currentPagerIds.includes(n)));
                    // const unCheckIDs = this.dgRef.checkValues.filter(n => n != param.id);
                    if (unCheckIDs && unCheckIDs.length) {
                        this.dgRef.unCheckRows(unCheckIDs, true);
                        this.dgRef.clearSelections([param.id, ...unSelectIds]);
                    }
                }
            }
            else {
                if (isShiftKey) {
                    /** @type {?} */
                    let focusIndex = this.dgRef.focusRowIndex;
                    if (focusIndex === -1) {
                        focusIndex = 0;
                    }
                    /** @type {?} */
                    const endIndex = param.rowIndex;
                    /** @type {?} */
                    let start = focusIndex;
                    /** @type {?} */
                    let end = endIndex;
                    if (focusIndex > endIndex) {
                        start = endIndex;
                        end = focusIndex;
                    }
                    /** @type {?} */
                    const data = this.dgRef.getRows();
                    /** @type {?} */
                    const checkedItems = [...data].splice(start, end - start + 1);
                    /** @type {?} */
                    const willCheckIds = checkedItems.map((/**
                     * @param {?} n
                     * @return {?}
                     */
                    n => {
                        return this.dgRef.dfs.primaryId(n);
                    }));
                    if (!isCtrlKey) {
                        this.dgRef.clearCheckeds(false, false);
                    }
                    // this.dgRef.selectValues = willCheckIds;
                    this.dgRef.checkRows(willCheckIds, true);
                    return true;
                }
            }
            if (isSelected && isCtrlKey) {
                param.e.stopPropagation();
                // 执行取消选择
                this.dgRef.unCheckRow(param.id);
                return true;
            }
            this.dgRef.beforeSelect(param).pipe(delay(100)).subscribe((/**
             * @param {?} canSelect
             * @return {?}
             */
            (canSelect) => {
                if (canSelect) {
                    this.dgRef.dfs.selectRow(param.rowIndex, param.rowData);
                    if (this.dgRef.selectedRow) {
                        this.dgRef.selectedRow.dr = param.dr;
                    }
                }
                this.dgRef.rowClick.emit({ data: param.rowData, grid: this.dgRef, dblclick: false });
                this.dgRef.dgs.setSelecedRow.emit({ selected: true, id: this.dgRef.dfs.primaryId(param.rowData) });
            }));
            return true;
        }
        return false;
    }
    /**
     * @return {?}
     */
    endRowClick() {
        if (this.dgRef && this.dgRef.selectionMode === 'default') {
            this.dgRef.checkOnSelect = false;
        }
    }
}
SelectionModeService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
SelectionModeService.ctorParameters = () => [
    { type: DatagridComponent }
];
if (false) {
    /** @type {?} */
    SelectionModeService.prototype.dgRef;
    /**
     * @type {?}
     * @private
     */
    SelectionModeService.prototype.oldSettings;
    /**
     * @type {?}
     * @private
     */
    SelectionModeService.prototype.selectStartEvent;
    /**
     * @type {?}
     * @private
     */
    SelectionModeService.prototype.events;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VsZWN0aW9uLW1vZGUuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvdWktZGF0YWdyaWQvIiwic291cmNlcyI6WyJsaWIvc2VydmljZXMvc2VsZWN0aW9uLW1vZGUuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFDNUQsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFHdkMsTUFBTSxPQUFPLG9CQUFvQjs7OztJQUs3QixZQUFZLElBQXVCO1FBSm5DLFVBQUssR0FBc0IsSUFBSSxDQUFDO1FBQ3hCLGdCQUFXLEdBQVEsSUFBSSxDQUFDO1FBQ3hCLHFCQUFnQixHQUFRLElBQUksQ0FBQztRQUM3QixXQUFNLEdBQUcsSUFBSSxDQUFDO1FBRWxCLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDO1FBQ2xCLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxhQUFhLEtBQUssU0FBUyxFQUFFO1lBQ3hDLElBQUksQ0FBQyxJQUFJLENBQUMsaUJBQWlCOzs7WUFBQyxHQUFHLEVBQUU7Z0JBQzdCLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLDBCQUEwQixFQUFFLENBQUM7WUFDcEQsQ0FBQyxFQUFDLENBQUM7U0FDTjtJQUNMLENBQUM7Ozs7SUFFRCxZQUFZO1FBQ1IsSUFBSSxJQUFJLENBQUMsTUFBTSxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFO1lBQ25DLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTzs7OztZQUFDLENBQUMsQ0FBQyxFQUFFO2dCQUNwQixDQUFDLEVBQUUsQ0FBQztZQUNSLENBQUMsRUFBQyxDQUFDO1lBRUgsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUM7U0FDdEI7SUFDTCxDQUFDOzs7O0lBRU0sVUFBVTtRQUNiLElBQUksSUFBSSxDQUFDLEtBQUssRUFBRTtZQUNaLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxhQUFhLEtBQUssU0FBUyxFQUFFO2dCQUN4QyxJQUFJLENBQUMsMEJBQTBCLEVBQUUsQ0FBQzthQUNyQztpQkFBTTtnQkFDSCxJQUFJLENBQUMsZUFBZSxFQUFFLENBQUM7YUFDMUI7U0FDSjtJQUNMLENBQUM7Ozs7SUFFTSwwQkFBMEI7UUFDN0IsSUFBSSxJQUFJLENBQUMsS0FBSyxFQUFFO1lBQ1osSUFBSSxDQUFDLFdBQVcsR0FBRztnQkFDZixZQUFZLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxZQUFZO2dCQUNyQyxVQUFVLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxVQUFVO2dCQUNqQyxjQUFjLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxjQUFjO2dCQUN6QyxhQUFhLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxhQUFhO2dCQUN2QyxhQUFhLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxhQUFhO2FBQzFDLENBQUM7WUFFRixJQUFJLENBQUMsS0FBSyxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUM7WUFDL0IsSUFBSSxDQUFDLEtBQUssQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDO1lBQzdCLElBQUksQ0FBQyxLQUFLLENBQUMsY0FBYyxHQUFHLEtBQUssQ0FBQztZQUNsQyxJQUFJLENBQUMsS0FBSyxDQUFDLGFBQWEsR0FBRyxJQUFJLENBQUM7WUFDaEMsSUFBSSxDQUFDLEtBQUssQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDO1lBRWhDLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxZQUFZLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFDbEQsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLGdCQUFnQixFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ3ZELElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxlQUFlLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFDckQsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLGVBQWUsRUFBRSxJQUFJLENBQUMsQ0FBQztTQUN4RDtJQUNMLENBQUM7Ozs7SUFFTSxlQUFlO1FBQ2xCLElBQUksSUFBSSxDQUFDLEtBQUssSUFBSSxJQUFJLENBQUMsV0FBVyxFQUFFO1lBQ2hDLElBQUksQ0FBQyxLQUFLLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsWUFBWSxDQUFDO1lBQ3hELElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsVUFBVSxDQUFDO1lBQ3BELElBQUksQ0FBQyxLQUFLLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsY0FBYyxDQUFDO1lBQzVELElBQUksQ0FBQyxLQUFLLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsYUFBYSxDQUFDO1lBQzFELElBQUksQ0FBQyxLQUFLLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsYUFBYSxDQUFDO1lBRzFELElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxZQUFZLEVBQUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxVQUFVLENBQUMsQ0FBQztZQUN6RSxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUMsZ0JBQWdCLEVBQUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxjQUFjLENBQUMsQ0FBQztZQUNqRixJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUMsZUFBZSxFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsYUFBYSxDQUFDLENBQUM7WUFDL0UsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLGVBQWUsRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1NBQ2xGO0lBQ0wsQ0FBQzs7Ozs7SUFHTywwQkFBMEI7O2NBQ3hCLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFFLFNBQVM7Ozs7UUFBRSxDQUFDLEtBQVUsRUFBRSxFQUFFO1lBQ3JFLElBQUksS0FBSyxDQUFDLE9BQU8sSUFBSSxLQUFLLENBQUMsUUFBUSxFQUFFO2dCQUNqQyxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7YUFDdkI7UUFDTCxDQUFDLEVBQUM7O2NBRUksRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQUUsT0FBTzs7OztRQUFFLENBQUMsS0FBVSxFQUFFLEVBQUU7WUFDbkUsSUFBSSxLQUFLLENBQUMsT0FBTyxJQUFJLEtBQUssQ0FBQyxRQUFRLElBQUksS0FBSyxDQUFDLE9BQU8sS0FBSyxFQUFFLElBQUksS0FBSyxDQUFDLE9BQU8sS0FBSyxFQUFFLEVBQUU7Z0JBQ2pGLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO2FBQzNCO1FBQ0wsQ0FBQyxFQUFDO1FBRUYsT0FBTyxDQUFFLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUNyQixDQUFDOzs7OztJQUVPLFlBQVk7UUFDaEIsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLGFBQWEsRUFBRSxjQUFjLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDNUYsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLGFBQWEsRUFBRSxlQUFlLEVBQUUsY0FBYyxDQUFDLENBQUM7UUFDdkcsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLGFBQWEsRUFBRSxrQkFBa0IsRUFBRSxNQUFNLENBQUMsQ0FBQztJQUNsRyxDQUFDOzs7OztJQUVPLGdCQUFnQjtRQUNwQixJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsYUFBYSxFQUFFLGNBQWMsQ0FBQyxDQUFDO1FBQ3pGLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxhQUFhLEVBQUUsZUFBZSxDQUFDLENBQUM7UUFDMUYsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLGFBQWEsRUFBRSxrQkFBa0IsQ0FBQyxDQUFDO0lBQzdGLENBQUM7Ozs7O0lBRUQsYUFBYSxDQUFDLEtBQVU7UUFDcEIsSUFBSSxJQUFJLENBQUMsS0FBSyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsYUFBYSxLQUFLLFNBQVMsRUFBRTs7a0JBQ2hELFVBQVUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQzs7a0JBQ25ELFNBQVMsR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDLE9BQU87O2tCQUMzQixVQUFVLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxRQUFRO1lBRW5DLElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVSxFQUFFLENBQUM7WUFFeEIsSUFBSSxDQUFDLFNBQVMsSUFBSSxDQUFDLFVBQVUsRUFBRTtnQkFDM0IsSUFBSSxDQUFDLFVBQVUsRUFBRTtvQkFDYixJQUFJLENBQUMsS0FBSyxDQUFDLGFBQWEsRUFBRSxDQUFDO2lCQUM5QjtxQkFBTTs7OzBCQUVHLGVBQWUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sRUFBRSxDQUFDLEdBQUc7Ozs7b0JBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFDOzswQkFDckQsVUFBVSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLE1BQU07Ozs7b0JBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxlQUFlLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxLQUFLLENBQUMsRUFBRSxFQUFDOzswQkFDN0YsV0FBVyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLE1BQU07Ozs7b0JBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLGVBQWUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLEVBQUM7b0JBQ3BGLHdFQUF3RTtvQkFDeEUsSUFBSSxVQUFVLElBQUksVUFBVSxDQUFDLE1BQU0sRUFBRTt3QkFDakMsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxDQUFDO3dCQUN6QyxJQUFJLENBQUMsS0FBSyxDQUFDLGVBQWUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxFQUFFLEVBQUUsR0FBRyxXQUFXLENBQUMsQ0FBQyxDQUFDO3FCQUMxRDtpQkFDSjthQUNKO2lCQUFNO2dCQUNILElBQUksVUFBVSxFQUFFOzt3QkFDUixVQUFVLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxhQUFhO29CQUN6QyxJQUFJLFVBQVUsS0FBSyxDQUFDLENBQUMsRUFBRTt3QkFDbkIsVUFBVSxHQUFHLENBQUMsQ0FBQztxQkFDbEI7OzBCQUVLLFFBQVEsR0FBRyxLQUFLLENBQUMsUUFBUTs7d0JBQzNCLEtBQUssR0FBRyxVQUFVOzt3QkFDbEIsR0FBRyxHQUFHLFFBQVE7b0JBQ2xCLElBQUksVUFBVSxHQUFHLFFBQVEsRUFBRTt3QkFDdkIsS0FBSyxHQUFHLFFBQVEsQ0FBQzt3QkFDakIsR0FBRyxHQUFHLFVBQVUsQ0FBQztxQkFDcEI7OzBCQUVLLElBQUksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sRUFBRTs7MEJBQzNCLFlBQVksR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxHQUFHLEdBQUcsS0FBSyxHQUFHLENBQUMsQ0FBQzs7MEJBQ3ZELFlBQVksR0FBRyxZQUFZLENBQUMsR0FBRzs7OztvQkFBQyxDQUFDLENBQUMsRUFBRTt3QkFDdEMsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQ3ZDLENBQUMsRUFBQztvQkFFRixJQUFJLENBQUMsU0FBUyxFQUFFO3dCQUNaLElBQUksQ0FBQyxLQUFLLENBQUMsYUFBYSxDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsQ0FBQztxQkFDMUM7b0JBQ0QsMENBQTBDO29CQUMxQyxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxZQUFZLEVBQUUsSUFBSSxDQUFDLENBQUM7b0JBQ3pDLE9BQU8sSUFBSSxDQUFDO2lCQUNmO2FBQ0o7WUFFRCxJQUFJLFVBQVUsSUFBSSxTQUFTLEVBQUU7Z0JBQ3pCLEtBQUssQ0FBQyxDQUFDLENBQUMsZUFBZSxFQUFFLENBQUM7Z0JBQzFCLFNBQVM7Z0JBQ1QsSUFBSSxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDO2dCQUNoQyxPQUFPLElBQUksQ0FBQzthQUNmO1lBQ0QsSUFBSSxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLENBQUMsSUFBSSxDQUMvQixLQUFLLENBQUMsR0FBRyxDQUFDLENBQ2IsQ0FBQyxTQUFTOzs7O1lBQUMsQ0FBQyxTQUFrQixFQUFFLEVBQUU7Z0JBQy9CLElBQUksU0FBUyxFQUFFO29CQUNYLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztvQkFDeEQsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsRUFBRTt3QkFDeEIsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsRUFBRSxHQUFHLEtBQUssQ0FBQyxFQUFFLENBQUM7cUJBQ3hDO2lCQUNKO2dCQUNELElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxFQUFFLElBQUksRUFBRSxLQUFLLENBQUMsT0FBTyxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsS0FBSyxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO2dCQUNyRixJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxFQUFFLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDdkcsQ0FBQyxFQUFDLENBQUM7WUFFSCxPQUFPLElBQUksQ0FBQztTQUNmO1FBQ0QsT0FBTyxLQUFLLENBQUM7SUFDakIsQ0FBQzs7OztJQUVELFdBQVc7UUFDUCxJQUFJLElBQUksQ0FBQyxLQUFLLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxhQUFhLEtBQUssU0FBUyxFQUFFO1lBQ3RELElBQUksQ0FBQyxLQUFLLENBQUMsYUFBYSxHQUFHLEtBQUssQ0FBQztTQUNwQztJQUNMLENBQUM7OztZQXZMSixVQUFVOzs7O1lBSkYsaUJBQWlCOzs7O0lBTXRCLHFDQUFnQzs7Ozs7SUFDaEMsMkNBQWdDOzs7OztJQUNoQyxnREFBcUM7Ozs7O0lBQ3JDLHNDQUFzQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERhdGFncmlkQ29tcG9uZW50IH0gZnJvbSAnLi8uLi9kYXRhZ3JpZC5jb21wb25lbnQnO1xyXG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IGRlbGF5IH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgU2VsZWN0aW9uTW9kZVNlcnZpY2Uge1xyXG4gICAgZGdSZWY6IERhdGFncmlkQ29tcG9uZW50ID0gbnVsbDtcclxuICAgIHByaXZhdGUgb2xkU2V0dGluZ3M6IGFueSA9IG51bGw7XHJcbiAgICBwcml2YXRlIHNlbGVjdFN0YXJ0RXZlbnQ6IGFueSA9IG51bGw7XHJcbiAgICBwcml2YXRlIGV2ZW50cyA9IG51bGw7XHJcbiAgICBjb25zdHJ1Y3RvcihncmlkOiBEYXRhZ3JpZENvbXBvbmVudCkge1xyXG4gICAgICAgIHRoaXMuZGdSZWYgPSBncmlkO1xyXG4gICAgICAgIGlmICh0aGlzLmRnUmVmLnNlbGVjdGlvbk1vZGUgPT09ICdkZWZhdWx0Jykge1xyXG4gICAgICAgICAgICBncmlkLnpvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5ldmVudHMgPSB0aGlzLnJlZ2lzdGVyU3RvcFNlbGVjdGlvbkV2ZW50KCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICByZW1vdmVFdmVudHMoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuZXZlbnRzICYmIHRoaXMuZXZlbnRzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICB0aGlzLmV2ZW50cy5mb3JFYWNoKGUgPT4ge1xyXG4gICAgICAgICAgICAgICAgZSgpO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuZXZlbnRzID0gbnVsbDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHRvZ2dsZU1vZGUoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuZGdSZWYpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuZGdSZWYuc2VsZWN0aW9uTW9kZSA9PT0gJ2RlZmF1bHQnKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmVuYWJsZVdpbmRvd3NTZWxlY3Rpb25Nb2RlKCk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlc3RvcmVTZXR0aW5ncygpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBlbmFibGVXaW5kb3dzU2VsZWN0aW9uTW9kZSgpIHtcclxuICAgICAgICBpZiAodGhpcy5kZ1JlZikge1xyXG4gICAgICAgICAgICB0aGlzLm9sZFNldHRpbmdzID0ge1xyXG4gICAgICAgICAgICAgICAgc2hvd0NoZWNrYm94OiB0aGlzLmRnUmVmLnNob3dDaGVja2JveCxcclxuICAgICAgICAgICAgICAgIGtlZXBTZWxlY3Q6IHRoaXMuZGdSZWYua2VlcFNlbGVjdCxcclxuICAgICAgICAgICAgICAgIG9ubHlTZWxlY3RTZWxmOiB0aGlzLmRnUmVmLm9ubHlTZWxlY3RTZWxmLFxyXG4gICAgICAgICAgICAgICAgc2VsZWN0T25DaGVjazogdGhpcy5kZ1JlZi5zZWxlY3RPbkNoZWNrLFxyXG4gICAgICAgICAgICAgICAgY2hlY2tPblNlbGVjdDogdGhpcy5kZ1JlZi5jaGVja09uU2VsZWN0XHJcbiAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICB0aGlzLmRnUmVmLnNob3dDaGVja2JveCA9IHRydWU7XHJcbiAgICAgICAgICAgIHRoaXMuZGdSZWYua2VlcFNlbGVjdCA9IHRydWU7XHJcbiAgICAgICAgICAgIHRoaXMuZGdSZWYub25seVNlbGVjdFNlbGYgPSBmYWxzZTtcclxuICAgICAgICAgICAgdGhpcy5kZ1JlZi5zZWxlY3RPbkNoZWNrID0gdHJ1ZTtcclxuICAgICAgICAgICAgdGhpcy5kZ1JlZi5jaGVja09uU2VsZWN0ID0gdHJ1ZTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuZGdSZWYuZGZzLnVwZGF0ZVByb3BlcnR5KCdrZWVwU2VsZWN0JywgdHJ1ZSk7XHJcbiAgICAgICAgICAgIHRoaXMuZGdSZWYuZGZzLnVwZGF0ZVByb3BlcnR5KCdvbmx5U2VsZWN0U2VsZicsIGZhbHNlKTtcclxuICAgICAgICAgICAgdGhpcy5kZ1JlZi5kZnMudXBkYXRlUHJvcGVydHkoJ3NlbGVjdE9uQ2hlY2snLCB0cnVlKTtcclxuICAgICAgICAgICAgdGhpcy5kZ1JlZi5kZnMudXBkYXRlUHJvcGVydHkoJ2NoZWNrT25TZWxlY3QnLCB0cnVlKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHJlc3RvcmVTZXR0aW5ncygpIHtcclxuICAgICAgICBpZiAodGhpcy5kZ1JlZiAmJiB0aGlzLm9sZFNldHRpbmdzKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZGdSZWYuc2hvd0NoZWNrYm94ID0gdGhpcy5vbGRTZXR0aW5ncy5zaG93Q2hlY2tib3g7XHJcbiAgICAgICAgICAgIHRoaXMuZGdSZWYua2VlcFNlbGVjdCA9IHRoaXMub2xkU2V0dGluZ3Mua2VlcFNlbGVjdDtcclxuICAgICAgICAgICAgdGhpcy5kZ1JlZi5vbmx5U2VsZWN0U2VsZiA9IHRoaXMub2xkU2V0dGluZ3Mub25seVNlbGVjdFNlbGY7XHJcbiAgICAgICAgICAgIHRoaXMuZGdSZWYuc2VsZWN0T25DaGVjayA9IHRoaXMub2xkU2V0dGluZ3Muc2VsZWN0T25DaGVjaztcclxuICAgICAgICAgICAgdGhpcy5kZ1JlZi5jaGVja09uU2VsZWN0ID0gdGhpcy5vbGRTZXR0aW5ncy5jaGVja09uU2VsZWN0O1xyXG5cclxuXHJcbiAgICAgICAgICAgIHRoaXMuZGdSZWYuZGZzLnVwZGF0ZVByb3BlcnR5KCdrZWVwU2VsZWN0JywgdGhpcy5vbGRTZXR0aW5ncy5rZWVwU2VsZWN0KTtcclxuICAgICAgICAgICAgdGhpcy5kZ1JlZi5kZnMudXBkYXRlUHJvcGVydHkoJ29ubHlTZWxlY3RTZWxmJywgdGhpcy5vbGRTZXR0aW5ncy5vbmx5U2VsZWN0U2VsZik7XHJcbiAgICAgICAgICAgIHRoaXMuZGdSZWYuZGZzLnVwZGF0ZVByb3BlcnR5KCdzZWxlY3RPbkNoZWNrJywgdGhpcy5vbGRTZXR0aW5ncy5zZWxlY3RPbkNoZWNrKTtcclxuICAgICAgICAgICAgdGhpcy5kZ1JlZi5kZnMudXBkYXRlUHJvcGVydHkoJ2NoZWNrT25TZWxlY3QnLCB0aGlzLm9sZFNldHRpbmdzLmNoZWNrT25TZWxlY3QpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcblxyXG4gICAgcHJpdmF0ZSByZWdpc3RlclN0b3BTZWxlY3Rpb25FdmVudCgpIHtcclxuICAgICAgICBjb25zdCBrZCA9IHRoaXMuZGdSZWYucmVuZGVyMi5saXN0ZW4oZG9jdW1lbnQsICdrZXlkb3duJywgKGV2ZW50OiBhbnkpID0+IHtcclxuICAgICAgICAgICAgaWYgKGV2ZW50LmN0cmxLZXkgfHwgZXZlbnQuc2hpZnRLZXkpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMudW5zZWxlY3RhYmxlKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgY29uc3Qga3UgPSB0aGlzLmRnUmVmLnJlbmRlcjIubGlzdGVuKGRvY3VtZW50LCAna2V5dXAnLCAoZXZlbnQ6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXZlbnQuY3RybEtleSB8fCBldmVudC5zaGlmdEtleSB8fCBldmVudC5rZXlDb2RlID09PSAxNyB8fCBldmVudC5rZXlDb2RlID09PSAxNikge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5lbmFibGVTZWxlY3RhYmxlKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgcmV0dXJuIFsga2QsIGt1XTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHVuc2VsZWN0YWJsZSgpIHtcclxuICAgICAgICB0aGlzLmRnUmVmLnJlbmRlcjIuc2V0QXR0cmlidXRlKHRoaXMuZGdSZWYuZGdDb250YWluZXIubmF0aXZlRWxlbWVudCwgJ3Vuc2VsZWN0YWJsZScsICdvbicpO1xyXG4gICAgICAgIHRoaXMuZGdSZWYucmVuZGVyMi5zZXRBdHRyaWJ1dGUodGhpcy5kZ1JlZi5kZ0NvbnRhaW5lci5uYXRpdmVFbGVtZW50LCAnb25zZWxlY3RzdGFydCcsICdyZXR1cm4gZmFsc2UnKTtcclxuICAgICAgICB0aGlzLmRnUmVmLnJlbmRlcjIuc2V0U3R5bGUodGhpcy5kZ1JlZi5kZ0NvbnRhaW5lci5uYXRpdmVFbGVtZW50LCAnLW1vei11c2VyLXNlbGVjdCcsICdub25lJyk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBlbmFibGVTZWxlY3RhYmxlKCkge1xyXG4gICAgICAgIHRoaXMuZGdSZWYucmVuZGVyMi5yZW1vdmVBdHRyaWJ1dGUodGhpcy5kZ1JlZi5kZ0NvbnRhaW5lci5uYXRpdmVFbGVtZW50LCAndW5zZWxlY3RhYmxlJyk7XHJcbiAgICAgICAgdGhpcy5kZ1JlZi5yZW5kZXIyLnJlbW92ZUF0dHJpYnV0ZSh0aGlzLmRnUmVmLmRnQ29udGFpbmVyLm5hdGl2ZUVsZW1lbnQsICdvbnNlbGVjdHN0YXJ0Jyk7XHJcbiAgICAgICAgdGhpcy5kZ1JlZi5yZW5kZXIyLnJlbW92ZVN0eWxlKHRoaXMuZGdSZWYuZGdDb250YWluZXIubmF0aXZlRWxlbWVudCwgJy1tb3otdXNlci1zZWxlY3QnKTtcclxuICAgIH1cclxuXHJcbiAgICBiZWZvclJvd0NsaWNrKHBhcmFtOiBhbnkpIHtcclxuICAgICAgICBpZiAodGhpcy5kZ1JlZiAmJiB0aGlzLmRnUmVmLnNlbGVjdGlvbk1vZGUgPT09ICdkZWZhdWx0Jykge1xyXG4gICAgICAgICAgICBjb25zdCBpc1NlbGVjdGVkID0gdGhpcy5kZ1JlZi5kZnMuaXNSb3dTZWxlY3RlZChwYXJhbS5pZCk7XHJcbiAgICAgICAgICAgIGNvbnN0IGlzQ3RybEtleSA9IHBhcmFtLmUuY3RybEtleTtcclxuICAgICAgICAgICAgY29uc3QgaXNTaGlmdEtleSA9IHBhcmFtLmUuc2hpZnRLZXk7XHJcblxyXG4gICAgICAgICAgICB0aGlzLmRnUmVmLmVuZEVkaXRpbmcoKTtcclxuXHJcbiAgICAgICAgICAgIGlmICghaXNDdHJsS2V5ICYmICFpc1NoaWZ0S2V5KSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIWlzU2VsZWN0ZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmRnUmVmLmNsZWFyQ2hlY2tlZHMoKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8g5aaC5p6c5pyJ5aSa5p2h6YCJ77yM56e76Zmk5YW25LuW6YCJ5Lit6KGMXHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY3VycmVudFBhZ2VySWRzID0gdGhpcy5kZ1JlZi5nZXRSb3dzKCkubWFwKG4gPT4gbi5pZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdW5DaGVja0lEcyA9IHRoaXMuZGdSZWYuY2hlY2tWYWx1ZXMuZmlsdGVyKGkgPT4gY3VycmVudFBhZ2VySWRzLmluY2x1ZGVzKGkpICYmIGkgIT0gcGFyYW0uaWQpO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHVuU2VsZWN0SWRzID0gdGhpcy5kZ1JlZi5jaGVja1ZhbHVlcy5maWx0ZXIobiA9PiAhY3VycmVudFBhZ2VySWRzLmluY2x1ZGVzKG4pKTtcclxuICAgICAgICAgICAgICAgICAgICAvLyBjb25zdCB1bkNoZWNrSURzID0gdGhpcy5kZ1JlZi5jaGVja1ZhbHVlcy5maWx0ZXIobiA9PiBuICE9IHBhcmFtLmlkKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAodW5DaGVja0lEcyAmJiB1bkNoZWNrSURzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRnUmVmLnVuQ2hlY2tSb3dzKHVuQ2hlY2tJRHMsIHRydWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRnUmVmLmNsZWFyU2VsZWN0aW9ucyhbcGFyYW0uaWQsIC4uLnVuU2VsZWN0SWRzXSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgaWYgKGlzU2hpZnRLZXkpIHtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgZm9jdXNJbmRleCA9IHRoaXMuZGdSZWYuZm9jdXNSb3dJbmRleDtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZm9jdXNJbmRleCA9PT0gLTEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZm9jdXNJbmRleCA9IDA7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBlbmRJbmRleCA9IHBhcmFtLnJvd0luZGV4O1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCBzdGFydCA9IGZvY3VzSW5kZXg7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IGVuZCA9IGVuZEluZGV4O1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChmb2N1c0luZGV4ID4gZW5kSW5kZXgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQgPSBlbmRJbmRleDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZW5kID0gZm9jdXNJbmRleDtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGRhdGEgPSB0aGlzLmRnUmVmLmdldFJvd3MoKTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBjaGVja2VkSXRlbXMgPSBbLi4uZGF0YV0uc3BsaWNlKHN0YXJ0LCBlbmQgLSBzdGFydCArIDEpO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHdpbGxDaGVja0lkcyA9IGNoZWNrZWRJdGVtcy5tYXAobiA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmRnUmVmLmRmcy5wcmltYXJ5SWQobik7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmICghaXNDdHJsS2V5KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGdSZWYuY2xlYXJDaGVja2VkcyhmYWxzZSwgZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAvLyB0aGlzLmRnUmVmLnNlbGVjdFZhbHVlcyA9IHdpbGxDaGVja0lkcztcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmRnUmVmLmNoZWNrUm93cyh3aWxsQ2hlY2tJZHMsIHRydWUpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAoaXNTZWxlY3RlZCAmJiBpc0N0cmxLZXkpIHtcclxuICAgICAgICAgICAgICAgIHBhcmFtLmUuc3RvcFByb3BhZ2F0aW9uKCk7XHJcbiAgICAgICAgICAgICAgICAvLyDmiafooYzlj5bmtojpgInmi6lcclxuICAgICAgICAgICAgICAgIHRoaXMuZGdSZWYudW5DaGVja1JvdyhwYXJhbS5pZCk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLmRnUmVmLmJlZm9yZVNlbGVjdChwYXJhbSkucGlwZShcclxuICAgICAgICAgICAgICAgIGRlbGF5KDEwMClcclxuICAgICAgICAgICAgKS5zdWJzY3JpYmUoKGNhblNlbGVjdDogYm9vbGVhbikgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGNhblNlbGVjdCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZGdSZWYuZGZzLnNlbGVjdFJvdyhwYXJhbS5yb3dJbmRleCwgcGFyYW0ucm93RGF0YSk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZGdSZWYuc2VsZWN0ZWRSb3cpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kZ1JlZi5zZWxlY3RlZFJvdy5kciA9IHBhcmFtLmRyO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHRoaXMuZGdSZWYucm93Q2xpY2suZW1pdCh7IGRhdGE6IHBhcmFtLnJvd0RhdGEsIGdyaWQ6IHRoaXMuZGdSZWYsIGRibGNsaWNrOiBmYWxzZSB9KTtcclxuICAgICAgICAgICAgICAgIHRoaXMuZGdSZWYuZGdzLnNldFNlbGVjZWRSb3cuZW1pdCh7IHNlbGVjdGVkOiB0cnVlLCBpZDogdGhpcy5kZ1JlZi5kZnMucHJpbWFyeUlkKHBhcmFtLnJvd0RhdGEpIH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcblxyXG4gICAgZW5kUm93Q2xpY2soKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuZGdSZWYgJiYgdGhpcy5kZ1JlZi5zZWxlY3Rpb25Nb2RlID09PSAnZGVmYXVsdCcpIHtcclxuICAgICAgICAgICAgdGhpcy5kZ1JlZi5jaGVja09uU2VsZWN0ID0gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59XHJcblxyXG4iXX0=