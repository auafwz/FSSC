import { take } from 'rxjs/operators';
import { Injectable, Optional } from '@angular/core';
import { ParamService } from './param.service';
import { RuntimeFrameworkService } from './rtf-service';
import { isObservable } from 'rxjs';
/**
 * 应用参数服务
 * @scope FormModule
 */
var ApplicationParamService = /** @class */ (function () {
    function ApplicationParamService(paramService, runtimeFrameworkService) {
        this.paramService = paramService;
        this.runtimeFrameworkService = runtimeFrameworkService;
        if (!this.runtimeFrameworkService) {
            this.runtimeFrameworkService = new RuntimeFrameworkService();
        }
    }
    /**
     * 解析参数
     */
    ApplicationParamService.prototype.parseParams = function (route, frameworkService, viewModel, callback) {
        var _this = this;
        var highOrderInvoke = this.highOrderInvoke(callback);
        if (!this.paramService) {
            route.queryParams.pipe(take(1)).subscribe(function (params) {
                _this.setupParams(params, frameworkService, viewModel, highOrderInvoke);
            });
        }
        else {
            this.paramService.parse().pipe(take(1)).subscribe(function (params) {
                _this.setupParams(params, frameworkService, viewModel, highOrderInvoke);
            });
        }
    };
    /**
     * 设置参数
     */
    ApplicationParamService.prototype.setupParams = function (params, frameworkService, viewModel, callback) {
        var queryParams = this.getParams(params);
        if (!queryParams) {
            callback();
            return;
        }
        // 先设置参数，保证普通路由也能正常执行。
        this.setQueryParams(queryParams, viewModel);
        var funcId = this.getFuncId(queryParams);
        var appId = this.getAppId(queryParams);
        if (!funcId && !appId) {
            callback();
            return;
        }
        if (funcId) {
            this.setStaticParams(funcId, queryParams, frameworkService, viewModel, callback);
        }
        else {
            callback();
        }
    };
    /**
     * 设置查询参数
     */
    ApplicationParamService.prototype.setQueryParams = function (queryParams, viewModel) {
        var parsedQueryParams = {};
        // 设置表单参数
        // 首先判断是否为弹窗
        var isInDialog = this.isInDialog(viewModel);
        var uiState = viewModel && viewModel.uiState && viewModel.uiState.innerData || {};
        // 如果是弹窗，弹窗外的参数（无论表单参数或静态参数）不应该覆盖弹窗的参数。弹窗打开时传递的参数相当于局部变量，不应被覆盖
        Object.keys(queryParams).forEach(function (paramName) {
            if (!isInDialog) {
                parsedQueryParams[paramName] = queryParams[paramName];
            }
            else {
                if (!uiState.hasOwnProperty(paramName)) {
                    parsedQueryParams[paramName] = queryParams[paramName];
                }
            }
        });
        this.updateUIState(viewModel, parsedQueryParams);
    };
    /**
     * 设置静态参数
     */
    ApplicationParamService.prototype.setStaticParams = function (funcId, queryParams, frameworkService, viewModel, callback) {
        var _this = this;
        this.runtimeFrameworkService.getMenuParams(funcId, function (staicParams) {
            var staticParamsObj = _this.mapStaticParamsToObject(staicParams, queryParams, viewModel);
            if (!staticParamsObj) {
                callback();
                return;
            }
            _this.updateUIState(viewModel, staticParamsObj);
            callback();
        });
    };
    /**
     * 将staticParams转换为普通对象
     * @param staticParams，形如：[{'name': 'key1', 'value': 'val1'}, {'name': 'key2', 'value': 'val2'}]
     * @return 形如：{key1: val1, key2: value2 }
     */
    ApplicationParamService.prototype.mapStaticParamsToObject = function (staticParams, queryParams, viewModel) {
        if (!staticParams) {
            return;
        }
        var inDialog = this.isInDialog(viewModel);
        var uiState = viewModel && viewModel.uiState && viewModel.uiState.innerData || {};
        var result = {};
        staticParams.forEach(function (value, key, map) {
            if (!inDialog) {
                // 静态参数不能覆盖查询参数
                if (!queryParams.hasOwnProperty(key)) {
                    result[key] = value;
                }
            }
            else {
                if (!queryParams.hasOwnProperty(key) && !uiState.hasOwnProperty(key)) {
                    result[key] = value;
                }
            }
        });
        return result;
    };
    /**
     * 是否在弹窗内
     * @param viewModel viewmodel
     */
    ApplicationParamService.prototype.isInDialog = function (viewModel) {
        var isInDialog = false;
        if (viewModel && viewModel.uiState) {
            // tslint:disable-next-line: max-line-length
            if (viewModel.uiState.innerData && viewModel.uiState.innerData.hasOwnProperty('DEVKIT_DIALOG') || viewModel.uiState['DEVKIT_DIALOG']) {
                isInDialog = true;
            }
        }
        return isInDialog;
    };
    /**
     * 更新UIState
     */
    ApplicationParamService.prototype.updateUIState = function (viewModel, params) {
        var _this = this;
        if (!viewModel || !params) {
            return;
        }
        var uiState = viewModel.uiState;
        // 兼容使用string传递params对象的场景
        if (typeof params === 'string' && params !== '') {
            params = JSON.parse(params);
        }
        // 在UIState为参数创建属性
        Object.keys(params).forEach(function (propName) {
            uiState.setPropertyValue(propName, params[propName]);
            if (propName && propName === 'union_session') {
                var sessionInfo = params[propName];
                _this.setSessionInfo(viewModel, sessionInfo);
            }
        });
    };
    ApplicationParamService.prototype.setSessionInfo = function (viewModel, sessionInfo) {
        if (!viewModel || !sessionInfo) {
            return;
        }
        if (sessionInfo && typeof sessionInfo === 'string' && sessionInfo.startsWith('{') && sessionInfo.endsWith('}')) {
            sessionInfo = JSON.parse(sessionInfo);
        }
        var token = sessionInfo && sessionInfo.token || null;
        var sessionId = sessionInfo && sessionInfo.sessionId || null;
        if (token) {
            viewModel.frameContext.appContext.Token = token;
        }
        if (sessionId) {
            var befRepository = viewModel.frameContext.repository;
            if (befRepository) {
                befRepository.restService.sessionService.setBeSessionId(sessionId);
            }
        }
    };
    /**
     * 获取功能菜单id
     */
    ApplicationParamService.prototype.getFuncId = function (queryParams) {
        if (!queryParams) {
            return;
        }
        return queryParams['funcId'];
    };
    /**
     * 获取应用id
     */
    ApplicationParamService.prototype.getAppId = function (queryParams) {
        if (!queryParams) {
            return;
        }
        return queryParams['appId'];
    };
    /**
     * 获取url参数对象
     * @param queryParams url参数
     */
    ApplicationParamService.prototype.getParams = function (queryParams) {
        if (!queryParams) {
            return {};
        }
        var result = {};
        if (queryParams.hasOwnProperty('WEB_FORM_ROUTE_PARAMS')) {
            var webFormRouteParams = queryParams['WEB_FORM_ROUTE_PARAMS'];
            if (webFormRouteParams && webFormRouteParams.startsWith('{') && webFormRouteParams.endsWith('}')) {
                webFormRouteParams = decodeURI(encodeURI(webFormRouteParams).replace(/%0A/g, '\\n').replace(/%09/g, '\\t').replace(/%0D/g, '\\r'));
                result = JSON.parse(webFormRouteParams);
            }
            Object.keys(queryParams).forEach(function (prop) {
                if (prop !== 'WEB_FORM_ROUTE_PARAMS') {
                    result[prop] = queryParams[prop];
                }
            });
            return result;
        }
        return queryParams;
    };
    ApplicationParamService.prototype.highOrderInvoke = function (callback) {
        var _this = this;
        return function () {
            try {
                var controlEvent = _this.runtimeFrameworkService.getMenuSwitchControlEvent();
                if (controlEvent && isObservable(controlEvent)) {
                    controlEvent.subscribe(function (event) {
                        if (event) {
                            event.next('ok');
                        }
                    });
                }
            }
            catch (e) {
                console.warn(e);
            }
            if (callback && typeof callback === 'function') {
                callback();
            }
        };
    };
    ApplicationParamService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    ApplicationParamService.ctorParameters = function () { return [
        { type: ParamService, decorators: [{ type: Optional }] },
        { type: RuntimeFrameworkService, decorators: [{ type: Optional }] }
    ]; };
    return ApplicationParamService;
}());
export { ApplicationParamService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwbGljYXRpb24tcGFyYW0uc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy8iLCJzb3VyY2VzIjpbImxpYi9hcHBsaWNhdGlvbi1wYXJhbS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUd0QyxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNyRCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDL0MsT0FBTyxFQUFFLHVCQUF1QixFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRXhELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFcEM7OztHQUdHO0FBRUg7SUFFRSxpQ0FDc0IsWUFBMEIsRUFDMUIsdUJBQWdEO1FBRGhELGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBQzFCLDRCQUF1QixHQUF2Qix1QkFBdUIsQ0FBeUI7UUFFcEUsSUFBSSxDQUFDLElBQUksQ0FBQyx1QkFBdUIsRUFBRTtZQUNqQyxJQUFJLENBQUMsdUJBQXVCLEdBQUcsSUFBSSx1QkFBdUIsRUFBRSxDQUFDO1NBQzlEO0lBQ0gsQ0FBQztJQUNEOztPQUVHO0lBQ0ksNkNBQVcsR0FBbEIsVUFBbUIsS0FBcUIsRUFBRSxnQkFBa0MsRUFBRSxTQUFvQixFQUFFLFFBQW9CO1FBQXhILGlCQVdDO1FBVkMsSUFBTSxlQUFlLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUN2RCxJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRTtZQUN0QixLQUFLLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsVUFBQyxNQUFXO2dCQUNwRCxLQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sRUFBRSxn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SSxLQUFLLEVBQUU7NEJBQ1QsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQzt5QkFDbEI7b0JBQ0gsQ0FBQyxDQUFDLENBQUM7aUJBQ0o7YUFDRjtZQUFDLE9BQU8sQ0FBQyxFQUFFO2dCQUFFLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7YUFBQztZQUMvQixJQUFJLFFBQVEsSUFBSSxPQUFPLFFBQVEsS0FBSyxVQUFVLEVBQUU7Z0JBQzlDLFFBQVEsRUFBRSxDQUFDO2FBQ1o7UUFDSCxDQUFDLENBQUE7SUFDSCxDQUFDOztnQkF4T0YsVUFBVTs7OztnQkFWRixZQUFZLHVCQWFoQixRQUFRO2dCQVpKLHVCQUF1Qix1QkFhM0IsUUFBUTs7SUFxT2IsOEJBQUM7Q0FBQSxBQXpPRCxJQXlPQztTQXhPWSx1QkFBdUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBY3RpdmF0ZWRSb3V0ZSwgUGFyYW1NYXAgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xyXG5pbXBvcnQgeyB0YWtlIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBGcmFtZXdvcmtTZXJ2aWNlIH0gZnJvbSAnQGdzcC1zeXMvcnRmLWNvbW1vbic7XHJcbmltcG9ydCB7IFZpZXdNb2RlbCB9IGZyb20gJ0BmYXJyaXMvZGV2a2l0JztcclxuaW1wb3J0IHsgSW5qZWN0YWJsZSwgT3B0aW9uYWwgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgUGFyYW1TZXJ2aWNlIH0gZnJvbSAnLi9wYXJhbS5zZXJ2aWNlJztcclxuaW1wb3J0IHsgUnVudGltZUZyYW1ld29ya1NlcnZpY2UgfSBmcm9tICcuL3J0Zi1zZXJ2aWNlJztcclxuaW1wb3J0IHsgQmVmUmVwb3NpdG9yeSB9IGZyb20gJ0BmYXJyaXMvYmVmJztcclxuaW1wb3J0IHsgaXNPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XHJcblxyXG4vKipcclxuICog5bqU55So5Y+C5pWw5pyN5YqhXHJcbiAqIEBzY29wZSBGb3JtTW9kdWxlXHJcbiAqL1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgQXBwbGljYXRpb25QYXJhbVNlcnZpY2Uge1xyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgQE9wdGlvbmFsKCkgcHJpdmF0ZSBwYXJhbVNlcnZpY2U6IFBhcmFtU2VydmljZSxcclxuICAgIEBPcHRpb25hbCgpIHByaXZhdGUgcnVudGltZUZyYW1ld29ya1NlcnZpY2U6IFJ1bnRpbWVGcmFtZXdvcmtTZXJ2aWNlLFxyXG4gICkge1xyXG4gICAgaWYgKCF0aGlzLnJ1bnRpbWVGcmFtZXdvcmtTZXJ2aWNlKSB7XHJcbiAgICAgIHRoaXMucnVudGltZUZyYW1ld29ya1NlcnZpY2UgPSBuZXcgUnVudGltZUZyYW1ld29ya1NlcnZpY2UoKTtcclxuICAgIH1cclxuICB9XHJcbiAgLyoqXHJcbiAgICog6Kej5p6Q5Y+C5pWwXHJcbiAgICovXHJcbiAgcHVibGljIHBhcnNlUGFyYW1zKHJvdXRlOiBBY3RpdmF0ZWRSb3V0ZSwgZnJhbWV3b3JrU2VydmljZTogRnJhbWV3b3JrU2VydmljZSwgdmlld01vZGVsOiBWaWV3TW9kZWwsIGNhbGxiYWNrOiAoKSA9PiB2b2lkKSB7XHJcbiAgICBjb25zdCBoaWdoT3JkZXJJbnZva2UgPSB0aGlzLmhpZ2hPcmRlckludm9rZShjYWxsYmFjayk7XHJcbiAgICBpZiAoIXRoaXMucGFyYW1TZXJ2aWNlKSB7XHJcbiAgICAgIHJvdXRlLnF1ZXJ5UGFyYW1zLnBpcGUodGFrZSgxKSkuc3Vic2NyaWJlKChwYXJhbXM6IGFueSkgPT4ge1xyXG4gICAgICAgIHRoaXMuc2V0dXBQYXJhbXMocGFyYW1zLCBmcmFtZXdvcmtTZXJ2aWNlLCB2aWV3TW9kZWwsIGhpZ2hPcmRlckludm9rZSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5wYXJhbVNlcnZpY2UucGFyc2UoKS5waXBlKHRha2UoMSkpLnN1YnNjcmliZShwYXJhbXMgPT4ge1xyXG4gICAgICAgIHRoaXMuc2V0dXBQYXJhbXMocGFyYW1zLCBmcmFtZXdvcmtTZXJ2aWNlLCB2aWV3TW9kZWwsIGhpZ2hPcmRlckludm9rZSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6K6+572u5Y+C5pWwXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBzZXR1cFBhcmFtcyhwYXJhbXMsIGZyYW1ld29ya1NlcnZpY2U6IEZyYW1ld29ya1NlcnZpY2UsIHZpZXdNb2RlbDogVmlld01vZGVsLCBjYWxsYmFjazogKCkgPT4gdm9pZCkge1xyXG4gICAgY29uc3QgcXVlcnlQYXJhbXMgPSB0aGlzLmdldFBhcmFtcyhwYXJhbXMpO1xyXG4gICAgaWYgKCFxdWVyeVBhcmFtcykge1xyXG4gICAgICBjYWxsYmFjaygpO1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgLy8g5YWI6K6+572u5Y+C5pWw77yM5L+d6K+B5pmu6YCa6Lev55Sx5Lmf6IO95q2j5bi45omn6KGM44CCXHJcbiAgICB0aGlzLnNldFF1ZXJ5UGFyYW1zKHF1ZXJ5UGFyYW1zLCB2aWV3TW9kZWwpO1xyXG5cclxuICAgIGNvbnN0IGZ1bmNJZCA9IHRoaXMuZ2V0RnVuY0lkKHF1ZXJ5UGFyYW1zKTtcclxuICAgIGNvbnN0IGFwcElkID0gdGhpcy5nZXRBcHBJZChxdWVyeVBhcmFtcyk7XHJcbiAgICBpZiAoIWZ1bmNJZCAmJiAhYXBwSWQpIHtcclxuICAgICAgY2FsbGJhY2soKTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChmdW5jSWQpIHtcclxuICAgICAgdGhpcy5zZXRTdGF0aWNQYXJhbXMoZnVuY0lkLCBxdWVyeVBhcmFtcywgZnJhbWV3b3JrU2VydmljZSwgdmlld01vZGVsLCBjYWxsYmFjayk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBjYWxsYmFjaygpO1xyXG4gICAgfVxyXG4gIH1cclxuICAvKipcclxuICAgKiDorr7nva7mn6Xor6Llj4LmlbBcclxuICAgKi9cclxuICBwcml2YXRlIHNldFF1ZXJ5UGFyYW1zKHF1ZXJ5UGFyYW1zOiBhbnksIHZpZXdNb2RlbDogVmlld01vZGVsKTogYW55IHtcclxuICAgIGNvbnN0IHBhcnNlZFF1ZXJ5UGFyYW1zID0ge307XHJcbiAgICAvLyDorr7nva7ooajljZXlj4LmlbBcclxuICAgIC8vIOmmluWFiOWIpOaWreaYr+WQpuS4uuW8ueeql1xyXG4gICAgY29uc3QgaXNJbkRpYWxvZyA9IHRoaXMuaXNJbkRpYWxvZyh2aWV3TW9kZWwpO1xyXG4gICAgY29uc3QgdWlTdGF0ZSA9IHZpZXdNb2RlbCAmJiB2aWV3TW9kZWwudWlTdGF0ZSAmJiB2aWV3TW9kZWwudWlTdGF0ZS5pbm5lckRhdGEgfHwge307XHJcbiAgICAvLyDlpoLmnpzmmK/lvLnnqpfvvIzlvLnnqpflpJbnmoTlj4LmlbDvvIjml6DorrrooajljZXlj4LmlbDmiJbpnZnmgIHlj4LmlbDvvInkuI3lupTor6Xopobnm5blvLnnqpfnmoTlj4LmlbDjgILlvLnnqpfmiZPlvIDml7bkvKDpgJLnmoTlj4LmlbDnm7jlvZPkuo7lsYDpg6jlj5jph4/vvIzkuI3lupTooqvopobnm5ZcclxuICAgIE9iamVjdC5rZXlzKHF1ZXJ5UGFyYW1zKS5mb3JFYWNoKChwYXJhbU5hbWU6IHN0cmluZykgPT4ge1xyXG4gICAgICBpZiAoIWlzSW5EaWFsb2cpIHtcclxuICAgICAgICBwYXJzZWRRdWVyeVBhcmFtc1twYXJhbU5hbWVdID0gcXVlcnlQYXJhbXNbcGFyYW1OYW1lXTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBpZiAoIXVpU3RhdGUuaGFzT3duUHJvcGVydHkocGFyYW1OYW1lKSkge1xyXG4gICAgICAgICAgcGFyc2VkUXVlcnlQYXJhbXNbcGFyYW1OYW1lXSA9IHF1ZXJ5UGFyYW1zW3BhcmFtTmFtZV07XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICAgIHRoaXMudXBkYXRlVUlTdGF0ZSh2aWV3TW9kZWwsIHBhcnNlZFF1ZXJ5UGFyYW1zKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiuvue9rumdmeaAgeWPguaVsFxyXG4gICAqL1xyXG4gIHByaXZhdGUgc2V0U3RhdGljUGFyYW1zKFxyXG4gICAgZnVuY0lkOiBzdHJpbmcsIHF1ZXJ5UGFyYW1zOiBhbnksIGZyYW1ld29ya1NlcnZpY2U6IEZyYW1ld29ya1NlcnZpY2UsIHZpZXdNb2RlbDogVmlld01vZGVsLCBjYWxsYmFjazogKCkgPT4gdm9pZFxyXG4gICkge1xyXG4gICAgdGhpcy5ydW50aW1lRnJhbWV3b3JrU2VydmljZS5nZXRNZW51UGFyYW1zKGZ1bmNJZCwgKHN0YWljUGFyYW1zKSA9PiB7XHJcbiAgICAgIGNvbnN0IHN0YXRpY1BhcmFtc09iaiA9IHRoaXMubWFwU3RhdGljUGFyYW1zVG9PYmplY3Qoc3RhaWNQYXJhbXMsIHF1ZXJ5UGFyYW1zLCB2aWV3TW9kZWwpO1xyXG4gICAgICBpZiAoIXN0YXRpY1BhcmFtc09iaikge1xyXG4gICAgICAgIGNhbGxiYWNrKCk7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcbiAgICAgIHRoaXMudXBkYXRlVUlTdGF0ZSh2aWV3TW9kZWwsIHN0YXRpY1BhcmFtc09iaik7XHJcbiAgICAgIGNhbGxiYWNrKCk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWwhnN0YXRpY1BhcmFtc+i9rOaNouS4uuaZrumAmuWvueixoVxyXG4gICAqIEBwYXJhbSBzdGF0aWNQYXJhbXPvvIzlvaLlpoLvvJpbeyduYW1lJzogJ2tleTEnLCAndmFsdWUnOiAndmFsMSd9LCB7J25hbWUnOiAna2V5MicsICd2YWx1ZSc6ICd2YWwyJ31dXHJcbiAgICogQHJldHVybiDlvaLlpoLvvJp7a2V5MTogdmFsMSwga2V5MjogdmFsdWUyIH1cclxuICAgKi9cclxuICBwcml2YXRlIG1hcFN0YXRpY1BhcmFtc1RvT2JqZWN0KHN0YXRpY1BhcmFtczogTWFwPGFueSwgYW55PiwgcXVlcnlQYXJhbXM6IGFueSwgdmlld01vZGVsPzogVmlld01vZGVsKTogYW55IHtcclxuICAgIGlmICghc3RhdGljUGFyYW1zKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGNvbnN0IGluRGlhbG9nID0gdGhpcy5pc0luRGlhbG9nKHZpZXdNb2RlbCk7XHJcbiAgICBjb25zdCB1aVN0YXRlID0gdmlld01vZGVsICYmIHZpZXdNb2RlbC51aVN0YXRlICYmIHZpZXdNb2RlbC51aVN0YXRlLmlubmVyRGF0YSB8fCB7fTtcclxuICAgIGNvbnN0IHJlc3VsdCA9IHt9O1xyXG4gICAgc3RhdGljUGFyYW1zLmZvckVhY2goKHZhbHVlLCBrZXksIG1hcCkgPT4ge1xyXG4gICAgICBpZiAoIWluRGlhbG9nKSB7XHJcbiAgICAgICAgLy8g6Z2Z5oCB5Y+C5pWw5LiN6IO96KaG55uW5p+l6K+i5Y+C5pWwXHJcbiAgICAgICAgaWYgKCFxdWVyeVBhcmFtcy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7XHJcbiAgICAgICAgICByZXN1bHRba2V5XSA9IHZhbHVlO1xyXG4gICAgICAgIH1cclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBpZiAoIXF1ZXJ5UGFyYW1zLmhhc093blByb3BlcnR5KGtleSkgJiYgIXVpU3RhdGUuaGFzT3duUHJvcGVydHkoa2V5KSkge1xyXG4gICAgICAgICAgcmVzdWx0W2tleV0gPSB2YWx1ZTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIHJlc3VsdDtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5piv5ZCm5Zyo5by556qX5YaFXHJcbiAgICogQHBhcmFtIHZpZXdNb2RlbCB2aWV3bW9kZWxcclxuICAgKi9cclxuICBwcml2YXRlIGlzSW5EaWFsb2codmlld01vZGVsOiBWaWV3TW9kZWwpIHtcclxuICAgIGxldCBpc0luRGlhbG9nID0gZmFsc2U7XHJcbiAgICBpZiAodmlld01vZGVsICYmIHZpZXdNb2RlbC51aVN0YXRlKSB7XHJcbiAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogbWF4LWxpbmUtbGVuZ3RoXHJcbiAgICAgIGlmICh2aWV3TW9kZWwudWlTdGF0ZS5pbm5lckRhdGEgJiYgdmlld01vZGVsLnVpU3RhdGUuaW5uZXJEYXRhLmhhc093blByb3BlcnR5KCdERVZLSVRfRElBTE9HJykgfHwgdmlld01vZGVsLnVpU3RhdGVbJ0RFVktJVF9ESUFMT0cnXSkge1xyXG4gICAgICAgIGlzSW5EaWFsb2cgPSB0cnVlO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gaXNJbkRpYWxvZztcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5pu05pawVUlTdGF0ZVxyXG4gICAqL1xyXG4gIHByaXZhdGUgdXBkYXRlVUlTdGF0ZSh2aWV3TW9kZWw6IFZpZXdNb2RlbCwgcGFyYW1zOiBhbnkpIHtcclxuICAgIGlmICghdmlld01vZGVsIHx8ICFwYXJhbXMpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgY29uc3QgdWlTdGF0ZSA9IHZpZXdNb2RlbC51aVN0YXRlO1xyXG5cclxuICAgIC8vIOWFvOWuueS9v+eUqHN0cmluZ+S8oOmAknBhcmFtc+WvueixoeeahOWcuuaZr1xyXG4gICAgaWYgKHR5cGVvZiBwYXJhbXMgPT09ICdzdHJpbmcnICYmIHBhcmFtcyAhPT0gJycpIHtcclxuICAgICAgcGFyYW1zID0gSlNPTi5wYXJzZShwYXJhbXMpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIOWcqFVJU3RhdGXkuLrlj4LmlbDliJvlu7rlsZ7mgKdcclxuICAgIE9iamVjdC5rZXlzKHBhcmFtcykuZm9yRWFjaCgocHJvcE5hbWU6IHN0cmluZykgPT4ge1xyXG4gICAgICB1aVN0YXRlLnNldFByb3BlcnR5VmFsdWUocHJvcE5hbWUsIHBhcmFtc1twcm9wTmFtZV0pO1xyXG4gICAgICBpZiAocHJvcE5hbWUgJiYgcHJvcE5hbWUgPT09ICd1bmlvbl9zZXNzaW9uJykge1xyXG4gICAgICAgIGxldCBzZXNzaW9uSW5mbyA9IHBhcmFtc1twcm9wTmFtZV07XHJcbiAgICAgICAgdGhpcy5zZXRTZXNzaW9uSW5mbyh2aWV3TW9kZWwsIHNlc3Npb25JbmZvKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG4gIHByaXZhdGUgc2V0U2Vzc2lvbkluZm8odmlld01vZGVsOiBWaWV3TW9kZWwsIHNlc3Npb25JbmZvOiBhbnkpIHtcclxuICAgIGlmICghdmlld01vZGVsIHx8ICFzZXNzaW9uSW5mbykge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBpZiAoc2Vzc2lvbkluZm8gJiYgdHlwZW9mIHNlc3Npb25JbmZvID09PSAnc3RyaW5nJyAmJiBzZXNzaW9uSW5mby5zdGFydHNXaXRoKCd7JykgJiYgc2Vzc2lvbkluZm8uZW5kc1dpdGgoJ30nKSkge1xyXG4gICAgICBzZXNzaW9uSW5mbyA9IEpTT04ucGFyc2Uoc2Vzc2lvbkluZm8pO1xyXG4gICAgfVxyXG4gICAgY29uc3QgdG9rZW4gPSBzZXNzaW9uSW5mbyAmJiBzZXNzaW9uSW5mby50b2tlbiB8fCBudWxsO1xyXG4gICAgY29uc3Qgc2Vzc2lvbklkID0gc2Vzc2lvbkluZm8gJiYgc2Vzc2lvbkluZm8uc2Vzc2lvbklkIHx8IG51bGw7XHJcbiAgICBpZiAodG9rZW4pIHtcclxuICAgICAgdmlld01vZGVsLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0LlRva2VuID0gdG9rZW47XHJcbiAgICB9XHJcbiAgICBpZiAoc2Vzc2lvbklkKSB7XHJcbiAgICAgIGNvbnN0IGJlZlJlcG9zaXRvcnkgPSB2aWV3TW9kZWwuZnJhbWVDb250ZXh0LnJlcG9zaXRvcnkgYXMgQmVmUmVwb3NpdG9yeTxhbnk+O1xyXG4gICAgICBpZiAoYmVmUmVwb3NpdG9yeSkge1xyXG4gICAgICAgIGJlZlJlcG9zaXRvcnkucmVzdFNlcnZpY2Uuc2Vzc2lvblNlcnZpY2Uuc2V0QmVTZXNzaW9uSWQoc2Vzc2lvbklkKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuICAvKipcclxuICAgKiDojrflj5blip/og73oj5zljZVpZFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0RnVuY0lkKHF1ZXJ5UGFyYW1zOiBhbnkpOiBhbnkge1xyXG4gICAgaWYgKCFxdWVyeVBhcmFtcykge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcXVlcnlQYXJhbXNbJ2Z1bmNJZCddO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6I635Y+W5bqU55SoaWRcclxuICAgKi9cclxuICBwcml2YXRlIGdldEFwcElkKHF1ZXJ5UGFyYW1zOiBhbnkpOiBhbnkge1xyXG4gICAgaWYgKCFxdWVyeVBhcmFtcykge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcXVlcnlQYXJhbXNbJ2FwcElkJ107XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiOt+WPlnVybOWPguaVsOWvueixoVxyXG4gICAqIEBwYXJhbSBxdWVyeVBhcmFtcyB1cmzlj4LmlbBcclxuICAgKi9cclxuICBwcml2YXRlIGdldFBhcmFtcyhxdWVyeVBhcmFtczogYW55KTogeyBbcHJvcE5hbWU6IHN0cmluZ106IGFueSB9IHtcclxuICAgIGlmICghcXVlcnlQYXJhbXMpIHtcclxuICAgICAgcmV0dXJuIHt9O1xyXG4gICAgfVxyXG4gICAgbGV0IHJlc3VsdCA9IHt9O1xyXG4gICAgaWYgKHF1ZXJ5UGFyYW1zLmhhc093blByb3BlcnR5KCdXRUJfRk9STV9ST1VURV9QQVJBTVMnKSkge1xyXG4gICAgICBsZXQgd2ViRm9ybVJvdXRlUGFyYW1zOiBzdHJpbmcgPSBxdWVyeVBhcmFtc1snV0VCX0ZPUk1fUk9VVEVfUEFSQU1TJ107XHJcbiAgICAgIGlmICh3ZWJGb3JtUm91dGVQYXJhbXMgJiYgd2ViRm9ybVJvdXRlUGFyYW1zLnN0YXJ0c1dpdGgoJ3snKSAmJiB3ZWJGb3JtUm91dGVQYXJhbXMuZW5kc1dpdGgoJ30nKSkge1xyXG4gICAgICAgIHdlYkZvcm1Sb3V0ZVBhcmFtcyA9IGRlY29kZVVSSShlbmNvZGVVUkkod2ViRm9ybVJvdXRlUGFyYW1zKS5yZXBsYWNlKC8lMEEvZywgJ1xcXFxuJykucmVwbGFjZSgvJTA5L2csICdcXFxcdCcpLnJlcGxhY2UoLyUwRC9nLCAnXFxcXHInKSk7XHJcbiAgICAgICAgcmVzdWx0ID0gSlNPTi5wYXJzZSh3ZWJGb3JtUm91dGVQYXJhbXMpO1xyXG4gICAgICB9XHJcbiAgICAgIE9iamVjdC5rZXlzKHF1ZXJ5UGFyYW1zKS5mb3JFYWNoKHByb3AgPT4ge1xyXG4gICAgICAgIGlmIChwcm9wICE9PSAnV0VCX0ZPUk1fUk9VVEVfUEFSQU1TJykge1xyXG4gICAgICAgICAgcmVzdWx0W3Byb3BdID0gcXVlcnlQYXJhbXNbcHJvcF07XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH1cclxuICAgIHJldHVybiBxdWVyeVBhcmFtcztcclxuICB9XHJcbiAgcHJpdmF0ZSBoaWdoT3JkZXJJbnZva2UoY2FsbGJhY2spIHtcclxuICAgIHJldHVybiAoKSA9PiB7XHJcbiAgICAgIHRyeSB7XHJcbiAgICAgICAgY29uc3QgY29udHJvbEV2ZW50ID0gdGhpcy5ydW50aW1lRnJhbWV3b3JrU2VydmljZS5nZXRNZW51U3dpdGNoQ29udHJvbEV2ZW50KCk7XHJcbiAgICAgICAgaWYgKGNvbnRyb2xFdmVudCAmJiBpc09ic2VydmFibGUoY29udHJvbEV2ZW50KSkge1xyXG4gICAgICAgICAgY29udHJvbEV2ZW50LnN1YnNjcmliZSgoZXZlbnQ6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXZlbnQpIHtcclxuICAgICAgICAgICAgICBldmVudC5uZXh0KCdvaycpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgIH0gY2F0Y2ggKGUpIHsgY29uc29sZS53YXJuKGUpO31cclxuICAgICAgaWYgKGNhbGxiYWNrICYmIHR5cGVvZiBjYWxsYmFjayA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICAgIGNhbGxiYWNrKCk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcbn1cclxuIl19