import { Injectable } from '@angular/core';
import { EffectorManager } from '../effector/effector_manager';
import { EntityList } from '../entity/index';
import { Expression } from '../expression/index';
import { ENTITY_TEMPLATE } from '../resolver/index';
import { ExpressionUtil } from '../utils/expression_util';
import { EventHandler } from './event_handler';
export class BindingDataValueChangeEventHandler extends EventHandler {
    filter(event) {
        if (this.expressionObjects && this.expressionObjects.length > 0) {
            return this.expressionObjects.filter((expressionObject) => {
                const deps = expressionObject.deps;
                if (!deps || deps.length < 1 || event.ns !== expressionObject.ns) {
                    return false;
                }
                const eventEntityPaths = this.getEntityPath(event.path);
                eventEntityPaths.splice(0, 0, ENTITY_TEMPLATE);
                return deps.includes(eventEntityPaths.join('/'));
            });
        }
        return null;
    }
    /**
     * 发布事件
     * @param event event
     */
    dispatch(event) {
        const expressions = this.filter(event);
        if (expressions && expressions.length > 0) {
            expressions.forEach((expressionObject) => {
                this.effect(event, expressionObject);
            });
        }
    }
    /**
     * 输出副作用
     * @param event event
     * @param expressionObject 表达式
     * @returns
     */
    effect(event, expressionObject) {
        // 首先计算当前表达式和事件会影响那些路径
        const effector = this.effectorFactory.getEffector(expressionObject);
        if (!effector) {
            return;
        }
        const result = this.analysis(event, expressionObject);
        if (!result) {
            return;
        }
        const eventPaths = this.cleanEventPath(event.path);
        const paths = [];
        if (result.distance === 0) {
            // 值变化之后影响到了一个表内字段或影响到了同级表字段
            if (result.isSameTable === false) {
                // 同级表跳过
                console.warn(`[BindingDataValueChangeEventHandler]不支持多对多关系。`);
                return;
            }
            const prevPaths = eventPaths.slice(0, eventPaths.length - result.eventPropertyNames.length);
            const path = prevPaths.concat(result.expressionPropertyNames);
            const currentRows = this.buildCurrentRows(result.eventTablePaths, path);
            paths.push(path);
            this.output(event, expressionObject, currentRows, effector, paths);
        }
        else {
            if (result.eventFromChildren === true) {
                if (result.distance > 1) {
                    return;
                }
                // 下级表值变化影响到了上级表的表达式
                const prevPaths = eventPaths.slice(0, eventPaths.length - result.eventPropertyNames.length - 2);
                const path = prevPaths.concat(result.expressionPropertyNames);
                paths.push(path);
                const currentRows = this.buildCurrentRows(result.eventTablePaths, eventPaths);
                this.output(event, expressionObject, currentRows, effector, paths);
            }
            else if (result.eventFromParent === true) {
                if (result.distance > 1) {
                    console.warn(`[BindingDataValueChangeEventHandler]不支持多对多关系。`);
                    return;
                }
                // 上级表值变化影响到了下级表的表达式
                const prevPaths = eventPaths.slice(0, eventPaths.length - result.eventPropertyNames.length);
                // 添加下级表nodecode到路径中
                prevPaths.push(result.expressionTablePaths.slice(0).pop());
                // 遍历子表
                const bindingPaths = result.expressionTablePaths;
                const primaryKeyValue = eventPaths[0];
                if (!primaryKeyValue) {
                    return;
                }
                let object = this.frameContext.repository.entityCollection.getEntityById(primaryKeyValue);
                // prevPaths like [1,c,1.1,cc]
                for (let index = 1; index < prevPaths.length; index++) {
                    const propertyName = prevPaths[index];
                    if (object instanceof EntityList) {
                        object = object.get(propertyName);
                    }
                    else {
                        object = object[propertyName];
                    }
                }
                const list = object;
                if (list && list instanceof EntityList) {
                    if (list.count() === 0) {
                        if (expressionObject.type === Expression.ExpressionType.Visible || expressionObject.type === Expression.ExpressionType.Required) {
                            const context = this.buildContext(expressionObject, event);
                            const value = this.perform(expressionObject, context);
                            if (value === undefined && !this.isValidateOrRequiredExpression(expressionObject)) {
                                return;
                            }
                            expressionObject.result = this.convertBooleanTypeExpressionResult(expressionObject, value);
                            if (expressionObject.id) {
                                this.expressionResult.set(expressionObject.id, expressionObject.result);
                            }
                            super.effect(event, expressionObject);
                        }
                    }
                    else {
                        for (let entity of list) {
                            if (entity && entity.primaryValue) {
                                const path = prevPaths.concat([entity.primaryValue]).concat(result.expressionPropertyNames);
                                const currentRows = this.buildCurrentRows(result.expressionTablePaths, path);
                                this.output(event, expressionObject, currentRows, effector, [path]);
                            }
                        }
                    }
                }
            }
            else {
                // 跨表
            }
        }
    }
    output(event, expressionObject, currentRows, effector, paths) {
        const context = this.buildContext(expressionObject, event, null, currentRows);
        const value = this.perform(expressionObject, context);
        if (value === undefined && !this.isValidateOrRequiredExpression(expressionObject)) {
            return;
        }
        expressionObject.result = this.convertBooleanTypeExpressionResult(expressionObject, value);
        ;
        if (expressionObject.id) {
            this.expressionResult.set(expressionObject.id, expressionObject.result);
        }
        EffectorManager.effect(effector, expressionObject, paths);
    }
    /**
     * 获取子表事件行
     * @param paths
     * @param event
     * @returns
     */
    getCurrentRowByEvent(paths, event) {
        event = JSON.parse(JSON.stringify(event));
        let result = null;
        const bindingList = this.bindingData.getValue(paths);
        const eventEntityPath = this.getEntityPath(event.path);
        if (bindingList && bindingList.length > 0) {
            let primaryValue = bindingList.currentItem.primaryKeyValue || null;
            // 使用事件中的主键
            const childrenPaths = ExpressionUtil.getAvailableChildrenPathsFromEntityPaths(eventEntityPath, this.repository.entityTypeInfo);
            if (childrenPaths && childrenPaths.toString() === paths.toString()) {
                // 发生值变化的数据位于要获取当前行的子表中，此时事件行应该是发生值变化的数据id，而不是当前行id
                primaryValue = event.id || null;
                if (!primaryValue) {
                    primaryValue = this.getEventId(event.path, paths[paths.length - 1]);
                }
            }
            if (primaryValue) {
                const bindingObject = bindingList.findById(primaryValue);
                if (bindingObject) {
                    result = bindingObject.toJSON();
                }
            }
        }
        return result;
    }
}
BindingDataValueChangeEventHandler.decorators = [
    { type: Injectable }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmluZGluZ19kYXRhX3ZhbHVlX2NoYW5nZV9ldmVudF9oYW5kbGVyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9kZXZraXQvIiwic291cmNlcyI6WyJsaWIvZXZlbnQtaGFuZGxlci9iaW5kaW5nX2RhdGFfdmFsdWVfY2hhbmdlX2V2ZW50X2hhbmRsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFHL0QsT0FBTyxFQUFVLFVBQVUsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3JELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUNqRCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDcEQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQzFELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUcvQyxNQUFNLE9BQU8sa0NBQW1DLFNBQVEsWUFBWTtJQUMzRCxNQUFNLENBQUMsS0FBMkI7UUFDdkMsSUFBSSxJQUFJLENBQUMsaUJBQWlCLElBQUksSUFBSSxDQUFDLGlCQUFpQixDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDL0QsT0FBTyxJQUFJLENBQUMsaUJBQWlCLENBQUMsTUFBTSxDQUFDLENBQUMsZ0JBQTZDLEVBQUUsRUFBRTtnQkFDckYsTUFBTSxJQUFJLEdBQUcsZ0JBQWdCLENBQUMsSUFBSSxDQUFDO2dCQUNuQyxJQUFJLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxJQUFJLEtBQUssQ0FBQyxFQUFFLEtBQUssZ0JBQWdCLENBQUMsRUFBRSxFQUFFO29CQUNoRSxPQUFPLEtBQUssQ0FBQztpQkFDZDtnQkFDRCxNQUFNLGdCQUFnQixHQUFHLElBQUksQ0FBQyxhQUFh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RjtZQUNELElBQUksWUFBWSxFQUFFO2dCQUNoQixNQUFNLGFBQWEsR0FBRyxXQUFXLENBQUMsUUFBUSxDQUFDLFlBQVksQ0FBQyxDQUFDO2dCQUN6RCxJQUFJLGFBQWEsRUFBRTtvQkFDakIsTUFBTSxHQUFHLGFBQWEsQ0FBQyxNQUFNLEVBQUUsQ0FBQztpQkFDakM7YUFDRjtTQUNGO1FBQ0QsT0FBTyxNQUFNLENBQUM7SUFDaEIsQ0FBQzs7O1lBdEtGLFVBQVUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEVmZmVjdG9yTWFuYWdlciB9IGZyb20gJy4uL2VmZmVjdG9yL2VmZmVjdG9yX21hbmFnZXInO1xyXG5pbXBvcnQgeyBCaW5kaW5nTGlzdCB9IGZyb20gJy4uL2JpbmRpbmctZGF0YSc7XHJcbmltcG9ydCB7IERhdGFQcm9wSW5mbyB9IGZyb20gJy4uL2NvcmUvaW5kZXgnO1xyXG5pbXBvcnQgeyBFbnRpdHksIEVudGl0eUxpc3QgfSBmcm9tICcuLi9lbnRpdHkvaW5kZXgnO1xyXG5pbXBvcnQgeyBFeHByZXNzaW9uIH0gZnJvbSAnLi4vZXhwcmVzc2lvbi9pbmRleCc7XHJcbmltcG9ydCB7IEVOVElUWV9URU1QTEFURSB9IGZyb20gJy4uL3Jlc29sdmVyL2luZGV4JztcclxuaW1wb3J0IHsgRXhwcmVzc2lvblV0aWwgfSBmcm9tICcuLi91dGlscy9leHByZXNzaW9uX3V0aWwnO1xyXG5pbXBvcnQgeyBFdmVudEhhbmRsZXIgfSBmcm9tICcuL2V2ZW50X2hhbmRsZXInO1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgQmluZGluZ0RhdGFWYWx1ZUNoYW5nZUV2ZW50SGFuZGxlciBleHRlbmRzIEV2ZW50SGFuZGxlciB7XHJcbiAgcHVibGljIGZpbHRlcihldmVudDogRXhwcmVzc2lvbi5FdmVudEFyZ3MpIHtcclxuICAgIGlmICh0aGlzLmV4cHJlc3Npb25PYmplY3RzICYmIHRoaXMuZXhwcmVzc2lvbk9iamVjdHMubGVuZ3RoID4gMCkge1xyXG4gICAgICByZXR1cm4gdGhpcy5leHByZXNzaW9uT2JqZWN0cy5maWx0ZXIoKGV4cHJlc3Npb25PYmplY3Q6IEV4cHJlc3Npb24uRXhwcmVzc2lvbk9iamVjdCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGRlcHMgPSBleHByZXNzaW9uT2JqZWN0LmRlcHM7XHJcbiAgICAgICAgaWYgKCFkZXBzIHx8IGRlcHMubGVuZ3RoIDwgMSB8fCBldmVudC5ucyAhPT0gZXhwcmVzc2lvbk9iamVjdC5ucykge1xyXG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBldmVudEVudGl0eVBhdGhzID0gdGhpcy5nZXRFbnRpdHlQYXRoKGV2ZW50LnBhdGgpO1xyXG4gICAgICAgIGV2ZW50RW50aXR5UGF0aHMuc3BsaWNlKDAsIDAsIEVOVElUWV9URU1QTEFURSk7XHJcbiAgICAgICAgcmV0dXJuIGRlcHMuaW5jbHVkZXMoZXZlbnRFbnRpdHlQYXRocy5qb2luKCcvJykpO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICAgIHJldHVybiBudWxsO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDlj5HluIPkuovku7ZcclxuICAgKiBAcGFyYW0gZXZlbnQgZXZlbnRcclxuICAgKi9cclxuICBwdWJsaWMgZGlzcGF0Y2goZXZlbnQ6IEV4cHJlc3Npb24uRXZlbnRBcmdzKSB7XHJcbiAgICBjb25zdCBleHByZXNzaW9ucyA9IHRoaXMuZmlsdGVyKGV2ZW50KTtcclxuICAgIGlmIChleHByZXNzaW9ucyAmJiBleHByZXNzaW9ucy5sZW5ndGggPiAwKSB7XHJcbiAgICAgIGV4cHJlc3Npb25zLmZvckVhY2goKGV4cHJlc3Npb25PYmplY3Q6IEV4cHJlc3Npb24uRXhwcmVzc2lvbk9iamVjdCkgPT4ge1xyXG4gICAgICAgIHRoaXMuZWZmZWN0KGV2ZW50LCBleHByZXNzaW9uT2JqZWN0KTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOi+k+WHuuWJr+S9nOeUqFxyXG4gICAqIEBwYXJhbSBldmVudCBldmVudFxyXG4gICAqIEBwYXJhbSBleHByZXNzaW9uT2JqZWN0IOihqOi+vuW8j1xyXG4gICAqIEByZXR1cm5zIFxyXG4gICAqL1xyXG4gIHB1YmxpYyBlZmZlY3QoZXZlbnQ6IEV4cHJlc3Npb24uRXZlbnRBcmdzLCBleHByZXNzaW9uT2JqZWN0OiBFeHByZXNzaW9uLkV4cHJlc3Npb25PYmplY3QpOiB2b2lkIHtcclxuICAgIC8vIOmmluWFiOiuoeeul+W9k+WJjeihqOi+vuW8j+WSjOS6i+S7tuS8muW9seWTjemCo+S6m+i3r+W+hFxyXG4gICAgY29uc3QgZWZmZWN0b3IgPSB0aGlzLmVmZmVjdG9yRmFjdG9yeS5nZXRFZmZlY3RvcihleHByZXNzaW9uT2JqZWN0KTtcclxuICAgIGlmICghZWZmZWN0b3IpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgY29uc3QgcmVzdWx0ID0gdGhpcy5hbmFseXNpcyhldmVudCwgZXhwcmVzc2lvbk9iamVjdCk7XHJcbiAgICBpZiAoIXJlc3VsdCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBjb25zdCBldmVudFBhdGhzID0gdGhpcy5jbGVhbkV2ZW50UGF0aChldmVudC5wYXRoKTtcclxuICAgIGNvbnN0IHBhdGhzOiBhbnlbXVtdID0gW107XHJcbiAgICBpZiAocmVzdWx0LmRpc3RhbmNlID09PSAwKSB7XHJcbiAgICAgIC8vIOWAvOWPmOWMluS5i+WQjuW9seWTjeWIsOS6huS4gOS4quihqOWGheWtl+auteaIluW9seWTjeWIsOS6huWQjOe6p+ihqOWtl+autVxyXG4gICAgICBpZiAocmVzdWx0LmlzU2FtZVRhYmxlID09PSBmYWxzZSkge1xyXG4gICAgICAgIC8vIOWQjOe6p+ihqOi3s+i/h1xyXG4gICAgICAgIGNvbnNvbGUud2FybihgW0JpbmRpbmdEYXRhVmFsdWVDaGFuZ2VFdmVudEhhbmRsZXJd5LiN5pSv5oyB5aSa5a+55aSa5YWz57O744CCYCk7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcbiAgICAgIGNvbnN0IHByZXZQYXRocyA9IGV2ZW50UGF0aHMuc2xpY2UoMCwgZXZlbnRQYXRocy5sZW5ndGggLSByZXN1bHQuZXZlbnRQcm9wZXJ0eU5hbWVzLmxlbmd0aCk7XHJcbiAgICAgIGNvbnN0IHBhdGggPSBwcmV2UGF0aHMuY29uY2F0KHJlc3VsdC5leHByZXNzaW9uUHJvcGVydHlOYW1lcyk7XHJcbiAgICAgIGNvbnN0IGN1cnJlbnRSb3dzID0gdGhpcy5idWlsZEN1cnJlbnRSb3dzKHJlc3VsdC5ldmVudFRhYmxlUGF0aHMsIHBhdGgpO1xyXG4gICAgICBwYXRocy5wdXNoKHBhdGgpO1xyXG4gICAgICB0aGlzLm91dHB1dChldmVudCwgZXhwcmVzc2lvbk9iamVjdCwgY3VycmVudFJvd3MsIGVmZmVjdG9yLCBwYXRocyk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBpZiAocmVzdWx0LmV2ZW50RnJvbUNoaWxkcmVuID09PSB0cnVlKSB7XHJcbiAgICAgICAgaWYgKHJlc3VsdC5kaXN0YW5jZSA+IDEpIHtcclxuICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8g5LiL57qn6KGo5YC85Y+Y5YyW5b2x5ZON5Yiw5LqG5LiK57qn6KGo55qE6KGo6L6+5byPXHJcbiAgICAgICAgY29uc3QgcHJldlBhdGhzID0gZXZlbnRQYXRocy5zbGljZSgwLCBldmVudFBhdGhzLmxlbmd0aCAtIHJlc3VsdC5ldmVudFByb3BlcnR5TmFtZXMubGVuZ3RoIC0gMik7XHJcbiAgICAgICAgY29uc3QgcGF0aCA9IHByZXZQYXRocy5jb25jYXQocmVzdWx0LmV4cHJlc3Npb25Qcm9wZXJ0eU5hbWVzKTtcclxuICAgICAgICBwYXRocy5wdXNoKHBhdGgpO1xyXG4gICAgICAgIGNvbnN0IGN1cnJlbnRSb3dzID0gdGhpcy5idWlsZEN1cnJlbnRSb3dzKHJlc3VsdC5ldmVudFRhYmxlUGF0aHMsIGV2ZW50UGF0aHMpO1xyXG4gICAgICAgIHRoaXMub3V0cHV0KGV2ZW50LCBleHByZXNzaW9uT2JqZWN0LCBjdXJyZW50Um93cywgZWZmZWN0b3IsIHBhdGhzKTtcclxuICAgICAgfSBlbHNlIGlmIChyZXN1bHQuZXZlbnRGcm9tUGFyZW50ID09PSB0cnVlKSB7XHJcbiAgICAgICAgaWYgKHJlc3VsdC5kaXN0YW5jZSA+IDEpIHtcclxuICAgICAgICAgIGNvbnNvbGUud2FybihgW0JpbmRpbmdEYXRhVmFsdWVDaGFuZ2VFdmVudEhhbmRsZXJd5LiN5pSv5oyB5aSa5a+55aSa5YWz57O744CCYCk7XHJcbiAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIOS4iue6p+ihqOWAvOWPmOWMluW9seWTjeWIsOS6huS4i+e6p+ihqOeahOihqOi+vuW8j1xyXG4gICAgICAgIGNvbnN0IHByZXZQYXRocyA9IGV2ZW50UGF0aHMuc2xpY2UoMCwgZXZlbnRQYXRocy5sZW5ndGggLSByZXN1bHQuZXZlbnRQcm9wZXJ0eU5hbWVzLmxlbmd0aCk7XHJcbiAgICAgICAgLy8g5re75Yqg5LiL57qn6KGobm9kZWNvZGXliLDot6/lvoTkuK1cclxuICAgICAgICBwcmV2UGF0aHMucHVzaChyZXN1bHQuZXhwcmVzc2lvblRhYmxlUGF0aHMuc2xpY2UoMCkucG9wKCkpO1xyXG4gICAgICAgIC8vIOmBjeWOhuWtkOihqFxyXG4gICAgICAgIGNvbnN0IGJpbmRpbmdQYXRocyA9IHJlc3VsdC5leHByZXNzaW9uVGFibGVQYXRocztcclxuICAgICAgICBjb25zdCBwcmltYXJ5S2V5VmFsdWUgPSBldmVudFBhdGhzWzBdO1xyXG4gICAgICAgIGlmICghcHJpbWFyeUtleVZhbHVlKSB7XHJcbiAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGxldCBvYmplY3QgPSB0aGlzLmZyYW1lQ29udGV4dC5yZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24uZ2V0RW50aXR5QnlJZChwcmltYXJ5S2V5VmFsdWUpO1xyXG4gICAgICAgIC8vIHByZXZQYXRocyBsaWtlIFsxLGMsMS4xLGNjXVxyXG4gICAgICAgIGZvciAobGV0IGluZGV4ID0gMTsgaW5kZXggPCBwcmV2UGF0aHMubGVuZ3RoOyBpbmRleCsrKSB7XHJcbiAgICAgICAgICBjb25zdCBwcm9wZXJ0eU5hbWUgPSBwcmV2UGF0aHNbaW5kZXhdO1xyXG4gICAgICAgICAgaWYgKG9iamVjdCBpbnN0YW5jZW9mIEVudGl0eUxpc3QpIHtcclxuICAgICAgICAgICAgb2JqZWN0ID0gb2JqZWN0LmdldChwcm9wZXJ0eU5hbWUpO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgb2JqZWN0ID0gb2JqZWN0W3Byb3BlcnR5TmFtZV07XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IGxpc3QgPSBvYmplY3Q7XHJcbiAgICAgICAgaWYgKGxpc3QgJiYgbGlzdCBpbnN0YW5jZW9mIEVudGl0eUxpc3QpIHtcclxuICAgICAgICAgIGlmIChsaXN0LmNvdW50KCkgPT09IDApIHtcclxuICAgICAgICAgICAgaWYgKGV4cHJlc3Npb25PYmplY3QudHlwZSA9PT0gRXhwcmVzc2lvbi5FeHByZXNzaW9uVHlwZS5WaXNpYmxlIHx8IGV4cHJlc3Npb25PYmplY3QudHlwZSA9PT0gRXhwcmVzc2lvbi5FeHByZXNzaW9uVHlwZS5SZXF1aXJlZCkge1xyXG4gICAgICAgICAgICAgIGNvbnN0IGNvbnRleHQgPSB0aGlzLmJ1aWxkQ29udGV4dChleHByZXNzaW9uT2JqZWN0LCBldmVudCk7XHJcbiAgICAgICAgICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLnBlcmZvcm0oZXhwcmVzc2lvbk9iamVjdCwgY29udGV4dCk7XHJcbiAgICAgICAgICAgICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQgJiYgIXRoaXMuaXNWYWxpZGF0ZU9yUmVxdWlyZWRFeHByZXNzaW9uKGV4cHJlc3Npb25PYmplY3QpKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIGV4cHJlc3Npb25PYmplY3QucmVzdWx0ID0gdGhpcy5jb252ZXJ0Qm9vbGVhblR5cGVFeHByZXNzaW9uUmVzdWx0KGV4cHJlc3Npb25PYmplY3QsIHZhbHVlKTtcclxuICAgICAgICAgICAgICBpZiAoZXhwcmVzc2lvbk9iamVjdC5pZCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5leHByZXNzaW9uUmVzdWx0LnNldChleHByZXNzaW9uT2JqZWN0LmlkLCBleHByZXNzaW9uT2JqZWN0LnJlc3VsdCk7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIHN1cGVyLmVmZmVjdChldmVudCwgZXhwcmVzc2lvbk9iamVjdCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGZvciAobGV0IGVudGl0eSBvZiBsaXN0KSB7XHJcbiAgICAgICAgICAgICAgaWYgKGVudGl0eSAmJiBlbnRpdHkucHJpbWFyeVZhbHVlKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBwYXRoID0gcHJldlBhdGhzLmNvbmNhdChbZW50aXR5LnByaW1hcnlWYWx1ZV0pLmNvbmNhdChyZXN1bHQuZXhwcmVzc2lvblByb3BlcnR5TmFtZXMpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgY3VycmVudFJvd3MgPSB0aGlzLmJ1aWxkQ3VycmVudFJvd3MocmVzdWx0LmV4cHJlc3Npb25UYWJsZVBhdGhzLCBwYXRoKTtcclxuICAgICAgICAgICAgICAgIHRoaXMub3V0cHV0KGV2ZW50LCBleHByZXNzaW9uT2JqZWN0LCBjdXJyZW50Um93cywgZWZmZWN0b3IsIFtwYXRoXSk7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIC8vIOi3qOihqFxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG4gIHB1YmxpYyBvdXRwdXQoZXZlbnQ6IEV4cHJlc3Npb24uRXZlbnRBcmdzLCBleHByZXNzaW9uT2JqZWN0OiBFeHByZXNzaW9uLkV4cHJlc3Npb25PYmplY3QsIGN1cnJlbnRSb3dzOiBFeHByZXNzaW9uLklDdXJyZW50Um93W10sIGVmZmVjdG9yOiBFeHByZXNzaW9uLkVmZmVjdG9yLCBwYXRoczogYW55W11bXSkge1xyXG4gICAgY29uc3QgY29udGV4dCA9IHRoaXMuYnVpbGRDb250ZXh0KGV4cHJlc3Npb25PYmplY3QsIGV2ZW50LCBudWxsLCBjdXJyZW50Um93cyk7XHJcbiAgICBjb25zdCB2YWx1ZSA9IHRoaXMucGVyZm9ybShleHByZXNzaW9uT2JqZWN0LCBjb250ZXh0KTtcclxuICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkICYmICF0aGlzLmlzVmFsaWRhdGVPclJlcXVpcmVkRXhwcmVzc2lvbihleHByZXNzaW9uT2JqZWN0KSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBleHByZXNzaW9uT2JqZWN0LnJlc3VsdCA9IHRoaXMuY29udmVydEJvb2xlYW5UeXBlRXhwcmVzc2lvblJlc3VsdChleHByZXNzaW9uT2JqZWN0LCB2YWx1ZSk7O1xyXG4gICAgaWYgKGV4cHJlc3Npb25PYmplY3QuaWQpIHtcclxuICAgICAgdGhpcy5leHByZXNzaW9uUmVzdWx0LnNldChleHByZXNzaW9uT2JqZWN0LmlkLCBleHByZXNzaW9uT2JqZWN0LnJlc3VsdCk7XHJcbiAgICB9XHJcbiAgICBFZmZlY3Rvck1hbmFnZXIuZWZmZWN0KGVmZmVjdG9yLCBleHByZXNzaW9uT2JqZWN0LCBwYXRocyk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluWtkOihqOS6i+S7tuihjFxyXG4gICAqIEBwYXJhbSBwYXRocyBcclxuICAgKiBAcGFyYW0gZXZlbnQgXHJcbiAgICogQHJldHVybnMgXHJcbiAgICovXHJcbiAgcHVibGljIGdldEN1cnJlbnRSb3dCeUV2ZW50KHBhdGhzOiBzdHJpbmdbXSwgZXZlbnQ6IEV4cHJlc3Npb24uRXZlbnRBcmdzKTogbnVsbCB8IHsgW3Byb3A6IHN0cmluZ106IGFueSB9IHtcclxuICAgIGV2ZW50ID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShldmVudCkpO1xyXG4gICAgbGV0IHJlc3VsdCA9IG51bGw7XHJcbiAgICBjb25zdCBiaW5kaW5nTGlzdDogQmluZGluZ0xpc3QgPSB0aGlzLmJpbmRpbmdEYXRhLmdldFZhbHVlKHBhdGhzKSBhcyBCaW5kaW5nTGlzdDtcclxuICAgIGNvbnN0IGV2ZW50RW50aXR5UGF0aCA9IHRoaXMuZ2V0RW50aXR5UGF0aChldmVudC5wYXRoKTtcclxuICAgIGlmIChiaW5kaW5nTGlzdCAmJiBiaW5kaW5nTGlzdC5sZW5ndGggPiAwKSB7XHJcbiAgICAgIGxldCBwcmltYXJ5VmFsdWUgPSBiaW5kaW5nTGlzdC5jdXJyZW50SXRlbS5wcmltYXJ5S2V5VmFsdWUgfHwgbnVsbDtcclxuICAgICAgLy8g5L2/55So5LqL5Lu25Lit55qE5Li76ZSuXHJcbiAgICAgIGNvbnN0IGNoaWxkcmVuUGF0aHMgPSBFeHByZXNzaW9uVXRpbC5nZXRBdmFpbGFibGVDaGlsZHJlblBhdGhzRnJvbUVudGl0eVBhdGhzKGV2ZW50RW50aXR5UGF0aCwgdGhpcy5yZXBvc2l0b3J5LmVudGl0eVR5cGVJbmZvKTtcclxuICAgICAgaWYgKGNoaWxkcmVuUGF0aHMgJiYgY2hpbGRyZW5QYXRocy50b1N0cmluZygpID09PSBwYXRocy50b1N0cmluZygpKSB7XHJcbiAgICAgICAgLy8g5Y+R55Sf5YC85Y+Y5YyW55qE5pWw5o2u5L2N5LqO6KaB6I635Y+W5b2T5YmN6KGM55qE5a2Q6KGo5Lit77yM5q2k5pe25LqL5Lu26KGM5bqU6K+l5piv5Y+R55Sf5YC85Y+Y5YyW55qE5pWw5o2uaWTvvIzogIzkuI3mmK/lvZPliY3ooYxpZFxyXG4gICAgICAgIHByaW1hcnlWYWx1ZSA9IGV2ZW50LmlkIHx8IG51bGw7XHJcbiAgICAgICAgaWYgKCFwcmltYXJ5VmFsdWUpIHtcclxuICAgICAgICAgIHByaW1hcnlWYWx1ZSA9IHRoaXMuZ2V0RXZlbnRJZChldmVudC5wYXRoLCBwYXRoc1twYXRocy5sZW5ndGggLSAxXSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIGlmIChwcmltYXJ5VmFsdWUpIHtcclxuICAgICAgICBjb25zdCBiaW5kaW5nT2JqZWN0ID0gYmluZGluZ0xpc3QuZmluZEJ5SWQocHJpbWFyeVZhbHVlKTtcclxuICAgICAgICBpZiAoYmluZGluZ09iamVjdCkge1xyXG4gICAgICAgICAgcmVzdWx0ID0gYmluZGluZ09iamVjdC50b0pTT04oKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiByZXN1bHQ7XHJcbiAgfVxyXG59Il19