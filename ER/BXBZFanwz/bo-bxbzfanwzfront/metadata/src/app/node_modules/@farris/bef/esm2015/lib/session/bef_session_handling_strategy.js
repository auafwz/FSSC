/**
 * @fileoverview added by tsickle
 * Generated from: lib/session/bef_session_handling_strategy.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/*
 * @Author: Witt
 * @Date: 2018-10-11 20:32:02
 * @Last Modified by: Witt
 * @Last Modified time: 2020-03-03 16:46:39
 */
import { HttpHeaders } from '@angular/common/http';
import { of } from 'rxjs';
import { tap } from 'rxjs/operators';
import { HttpHeaderUtil } from '../utils/index';
import { HttpService } from '../http_service';
import { AppContext } from '@farris/devkit';
/**
 * BefSession处理策略类
 * @abstract
 */
class BefSessionHandlingStrategy {
    /**
     * 框架SessionId（用户的或者功能菜单的）
     * @protected
     * @param {?=} runtimeContext
     * @return {?}
     */
    getFrmSessionId(runtimeContext) {
        return this.frmSessionService.getCurrentSessionId(runtimeContext);
    }
    /**
     * @protected
     * @return {?}
     */
    get frmSessionId() {
        return this.frmSessionService.getCurrentSessionId();
    }
    /**
     * 构造函数
     * @param {?} storageStrategy
     * @param {?} frmSessionService
     */
    constructor(storageStrategy, frmSessionService) {
        this.storageStrategy = storageStrategy;
        this.frmSessionService = frmSessionService;
    }
    /**
     * 获取框架SessionId
     * @param {?=} runtimeContext
     * @return {?}
     */
    getFrameworkSessionId(runtimeContext) {
        return this.getFrmSessionId(runtimeContext);
    }
    /**
     * 从缓存中获取BeSession
     * @protected
     * @param {?=} runtimeContext
     * @return {?}
     */
    getSessionIdFromStorage(runtimeContext) {
        /** @type {?} */
        const sessionStorageKey = this.getSessionStorageKey(runtimeContext);
        /** @type {?} */
        const beSessionId = this.storageStrategy.getItem(sessionStorageKey);
        return beSessionId;
    }
}
if (false) {
    /**
     * 存储策略
     * @type {?}
     * @protected
     */
    BefSessionHandlingStrategy.prototype.storageStrategy;
    /**
     * 框架Session服务
     * @type {?}
     * @protected
     */
    BefSessionHandlingStrategy.prototype.frmSessionService;
    /**
     * 获取SessionId
     * @abstract
     * @return {?}
     */
    BefSessionHandlingStrategy.prototype.getSessionId = function () { };
    /**
     * @abstract
     * @param {?} sessionId
     * @return {?}
     */
    BefSessionHandlingStrategy.prototype.setSessionId = function (sessionId) { };
    /**
     * @abstract
     * @return {?}
     */
    BefSessionHandlingStrategy.prototype.clearSessionId = function () { };
    /**
     * @abstract
     * @param {?} headers
     * @param {?=} runtimeContext
     * @return {?}
     */
    BefSessionHandlingStrategy.prototype.extendRequestHeaders = function (headers, runtimeContext) { };
    /**
     * @abstract
     * @param {?} headers
     * @return {?}
     */
    BefSessionHandlingStrategy.prototype.handleReponseHeaders = function (headers) { };
    /**
     * @abstract
     * @protected
     * @param {?=} runtimeContext
     * @return {?}
     */
    BefSessionHandlingStrategy.prototype.getSessionStorageKey = function (runtimeContext) { };
}
/**
 * 隔离的BeSession处理策略（此策略必须保证injector为null的情况下正常影讯性）
 * \@summary
 * ----------------------------------------
 * 处理原则：
 * 1、通过createSession创建；
 * 2、每个Repository拥有独立的BeSession；
 * 3、访问BE的EAPI时，通过header里的SessionId传递；
 * ----------------------------------------
 * 兼容性考虑：
 * 1、有产品部直接new BeSessionService()，没有传递
 */
class BefSeparatedSessionHandlingStrategy extends BefSessionHandlingStrategy {
    /**
     * 构造函数
     * @param {?} storageStrategy
     * @param {?} frmSessionService
     * @param {?} httpClient
     * @param {?} beBaseUri
     * @param {?} injector
     */
    constructor(storageStrategy, frmSessionService, httpClient, beBaseUri, injector) {
        super(storageStrategy, frmSessionService);
        this.beSessionUri = beBaseUri;
        this.httpClient = httpClient;
        this.httpService = new HttpService(this.httpClient);
        this.injector = injector;
    }
    /**
     * 获取BeSessionId
     * @return {?}
     */
    getSessionId() {
        /** @type {?} */
        const beSessionId = this.getSessionIdFromStorage();
        if (beSessionId) {
            return of(beSessionId);
        }
        return this.createSession();
    }
    /**
     * 设置BeSessionId
     * @param {?} sessionId
     * @return {?}
     */
    setSessionId(sessionId) {
        /** @type {?} */
        const sessionKey = this.getSessionStorageKey();
        this.storageStrategy.setItem(sessionKey, sessionId);
    }
    /**
     * 清空Sessionid
     * @return {?}
     */
    clearSessionId() {
        /** @type {?} */
        const sessionKey = this.getSessionStorageKey();
        // this.storageStrategy.removeItem(sessionKey);
        this.storageStrategy.clear(this.frmSessionId, sessionKey);
    }
    /**
     * 扩展Session相关头信息
     * @param {?} headers
     * @param {?=} runtimeContext
     * @return {?}
     */
    extendRequestHeaders(headers, runtimeContext) {
        /** @type {?} */
        const frmSessionId = this.getFrameworkSessionId(runtimeContext);
        /** @type {?} */
        const beSessionId = this.getSessionIdFromStorage(runtimeContext);
        headers = HttpHeaderUtil.appendCafRuntimeCommonVariable(headers, frmSessionId);
        if (beSessionId) {
            headers = HttpHeaderUtil.appendCafRuntimeContext(headers, beSessionId);
            headers = HttpHeaderUtil.appendSessionId(headers, beSessionId);
        }
        // const appContext = this.injector.get<AppContext>(AppContext, null);
        //if (appContext) {
        // const appId = appContext.ApplicationId;
        headers = HttpHeaderUtil.appendFuncInstId(headers, this.beSessionUri);
        // }
        // headers = HttpHeaderUtil.appendRequireMessage(headers, true);
        return headers;
    }
    /**
     * 处理服务器端返回的headers
     * @param {?} headers
     * @return {?}
     */
    handleReponseHeaders(headers) {
        console.log(headers);
    }
    /**
     * 创建BeSessionId
     * @return {?}
     */
    createSession() {
        /** @type {?} */
        const params = {
            responseType: 'text'
        };
        if (!!this.frmSessionId) {
            /** @type {?} */
            const appContext = this.injector.get(AppContext, null);
            params.headers = new HttpHeaders({ SessionId: this.frmSessionId });
            params.headers = params.headers.append('X-CAF-Runtime-CommonVariable', this.frmSessionId);
            //if (appContext) {
            // const appId = appContext.ApplicationId;
            params.headers = params.headers.append('Func-Inst-Id', this.beSessionUri);
            //}
            params.headers = HttpHeaderUtil.toJson(params.headers);
        }
        return this.httpService.request('POST', this.beSessionUri, params).pipe(tap((/**
         * @param {?} beSessionId
         * @return {?}
         */
        (beSessionId) => {
            this.setSessionId(beSessionId);
        })));
    }
    /**
     * @return {?}
     */
    extendHttpHeader() {
    }
    /**
     * 获取某个Repository对应的BeSession的唯一key
     * \@summary
     * 1、在使用独立BeSession的组合表单中，需要通过BeSessionUri隔离；
     * 2、在Debug模式下，FrmSessionId=UserSessionid，如果只用它作key，
     * @protected
     * @param {?=} runtimeContext
     * @return {?}
     */
    getSessionStorageKey(runtimeContext) {
        /** @type {?} */
        let sessionId = null;
        if (runtimeContext) {
            sessionId = this.getFrameworkSessionId(runtimeContext);
        }
        else {
            sessionId = this.frmSessionId;
        }
        return `${sessionId}_${this.beSessionUri}`;
    }
}
if (false) {
    /**
     * @type {?}
     * @private
     */
    BefSeparatedSessionHandlingStrategy.prototype.injector;
    /**
     * 创建Session的的EAPI地址
     * @type {?}
     * @private
     */
    BefSeparatedSessionHandlingStrategy.prototype.beSessionUri;
    /**
     * httpClient
     * @type {?}
     * @private
     */
    BefSeparatedSessionHandlingStrategy.prototype.httpClient;
    /**
     * @type {?}
     * @private
     */
    BefSeparatedSessionHandlingStrategy.prototype.httpService;
}
class BefUnifiedSessionHandlingStrategy extends BefSessionHandlingStrategy {
    /**
     * 构造函数
     * @param {?} storageStrategy
     * @param {?} frmSessionService
     * @param {?} beBaseUri
     * @param {?} injector
     */
    constructor(storageStrategy, frmSessionService, beBaseUri, injector) {
        super(storageStrategy, frmSessionService);
        this.beSessionUri = beBaseUri;
        this.injector = injector;
    }
    /**
     * @return {?}
     */
    getSessionId() {
        /** @type {?} */
        const sessionKey = this.getSessionStorageKey();
        /** @type {?} */
        const sessionId = this.storageStrategy.getItem(sessionKey);
        return of(sessionId);
        // return of(null);
    }
    /**
     * 设置BeSessionId
     * @param {?} sessionId
     * @return {?}
     */
    setSessionId(sessionId) {
        /** @type {?} */
        const sessionKey = this.getSessionStorageKey();
        this.storageStrategy.setItem(sessionKey, sessionId);
    }
    /**
     * 清空Sessionid
     * @return {?}
     */
    clearSessionId() {
        /** @type {?} */
        const sessionKey = this.getSessionStorageKey();
        this.storageStrategy.removeItem(sessionKey);
    }
    /**
     * 扩展Session相关头信息
     * @param {?} headers
     * @param {?=} runtimeContext
     * @return {?}
     */
    extendRequestHeaders(headers, runtimeContext) {
        /** @type {?} */
        const frmSessionId = this.getFrameworkSessionId(runtimeContext);
        /** @type {?} */
        const beSessionId = this.getSessionIdFromStorage(runtimeContext);
        // headers = HttpHeaderUtil.appendRequireMessage(headers, true);
        /** @type {?} */
        const appContext = this.injector.get(AppContext, null);
        if (appContext) {
            /** @type {?} */
            const token = appContext.Token;
            headers = HttpHeaderUtil.appendFuncInstId(headers, token);
        }
        headers = HttpHeaderUtil.appendCafRuntimeCommonVariable(headers, frmSessionId);
        if (beSessionId) {
            headers = HttpHeaderUtil.appendCafRuntimeContext(headers, beSessionId);
        }
        return headers;
    }
    /**
     * 处理服务器端返回的headers
     * @param {?} headers
     * @return {?}
     */
    handleReponseHeaders(headers) {
        console.log(headers);
    }
    /**
     * 获取某个Repository对应的BeSession的唯一key
     * \@summary
     * @protected
     * @param {?=} runtimeContext
     * @return {?}
     */
    getSessionStorageKey(runtimeContext) {
        // const isDebug = false;
        // if (isDebug) {
        //   return `${this.frmSessionId}_${this.beSessionUri}`;
        // } else {
        //   return this.frmSessionId;
        // }
        /** @type {?} */
        let sessionId = null;
        if (runtimeContext) {
            sessionId = this.getFrameworkSessionId(runtimeContext);
        }
        else {
            sessionId = this.frmSessionId;
        }
        return `${sessionId}_${this.beSessionUri}`;
    }
}
if (false) {
    /**
     * 创建Session的的EAPI地址
     * @type {?}
     * @private
     */
    BefUnifiedSessionHandlingStrategy.prototype.beSessionUri;
    /**
     * @type {?}
     * @private
     */
    BefUnifiedSessionHandlingStrategy.prototype.injector;
}
export { BefSessionHandlingStrategy, BefSeparatedSessionHandlingStrategy, BefUnifiedSessionHandlingStrategy };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmVmX3Nlc3Npb25faGFuZGxpbmdfc3RyYXRlZ3kuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2JlZi8iLCJzb3VyY2VzIjpbImxpYi9zZXNzaW9uL2JlZl9zZXNzaW9uX2hhbmRsaW5nX3N0cmF0ZWd5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBT0EsT0FBTyxFQUFjLFdBQVcsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQy9ELE9BQU8sRUFBYyxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDdEMsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXJDLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUVoRCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFFOUMsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGdCQUFnQixDQUFDOzs7OztBQUk1QyxNQUFlLDBCQUEwQjs7Ozs7OztJQWM3QixlQUFlLENBQUMsY0FBb0I7UUFDNUMsT0FBTyxJQUFJLENBQUMsaUJBQWlCLENBQUMsbUJBQW1CLENBQUMsY0FBYyxDQUFDLENBQUM7SUFDcEUsQ0FBQzs7Ozs7SUFDRCxJQUFjLFlBQVk7UUFDeEIsT0FBTyxJQUFJLENBQUMsaUJBQWlCLENBQUMsbUJBQW1CLEVBQUUsQ0FBQztJQUN0RCxDQUFDOzs7Ozs7SUFLRCxZQUFZLGVBQXlDLEVBQUUsaUJBQTBDO1FBQy9GLElBQUksQ0FBQyxlQUFlLEdBQUcsZUFBZSxDQUFDO1FBQ3ZDLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxpQkFBaUIsQ0FBQztJQUM3QyxDQUFDOzs7Ozs7SUFlTSxxQkFBcUIsQ0FBQyxjQUFvQjtRQUMvQyxPQUFPLElBQUksQ0FBQyxlQUFlLENBQUMsY0FBYyxDQUFDLENBQUM7SUFDOUMsQ0FBQzs7Ozs7OztJQUtTLHVCQUF1QixDQUFDLGNBQW9COztjQUM5QyxpQkFBaUIsR0FBRyxJQUFJLENBQUMsb0JBQW9CLENBQUMsY0FBYyxDQUFDOztjQUM3RCxXQUFXLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsaUJBQWlCLENBQUM7UUFDbkUsT0FBTyxXQUFXLENBQUM7SUFDckIsQ0FBQztDQUNGOzs7Ozs7O0lBakRDLHFEQUFvRDs7Ozs7O0lBS3BELHVEQUFxRDs7Ozs7O0lBc0JyRCxvRUFBbUQ7Ozs7OztJQUNuRCw2RUFBOEM7Ozs7O0lBQzlDLHNFQUF1Qzs7Ozs7OztJQUN2QyxtR0FBOEY7Ozs7OztJQUM5RixtRkFBaUU7Ozs7Ozs7SUFDakUsMEZBQXNFOzs7Ozs7Ozs7Ozs7OztBQStCeEUsTUFBTSxtQ0FBb0MsU0FBUSwwQkFBMEI7Ozs7Ozs7OztJQWdCMUUsWUFDRSxlQUF5QyxFQUFFLGlCQUEwQyxFQUNyRixVQUFzQixFQUFFLFNBQWlCLEVBQUUsUUFBa0I7UUFFN0QsS0FBSyxDQUFDLGVBQWUsRUFBRSxpQkFBaUIsQ0FBQyxDQUFDO1FBQzFDLElBQUksQ0FBQyxZQUFZLEdBQUcsU0FBUyxDQUFDO1FBQzlCLElBQUksQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDO1FBQzdCLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxXQUFXLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQ3BELElBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDO0lBQzNCLENBQUM7Ozs7O0lBS00sWUFBWTs7Y0FDWCxXQUFXLEdBQUcsSUFBSSxDQUFDLHVCQUF1QixFQUFFO1FBQ2xELElBQUksV0FBVyxFQUFFO1lBQ2YsT0FBTyxFQUFFLENBQUMsV0FBVyxDQUFDLENBQUM7U0FDeEI7UUFDRCxPQUFPLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztJQUU5QixDQUFDOzs7Ozs7SUFLTSxZQUFZLENBQUMsU0FBaUI7O2NBQzdCLFVBQVUsR0FBRyxJQUFJLENBQUMsb0JBQW9CLEVBQUU7UUFDOUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsVUFBVSxFQUFFLFNBQVMsQ0FBQyxDQUFDO0lBQ3RELENBQUM7Ozs7O0lBS00sY0FBYzs7Y0FDYixVQUFVLEdBQUcsSUFBSSxDQUFDLG9CQUFvQixFQUFFO1FBQzlDLCtDQUErQztRQUMvQyxJQUFJLENBQUMsZUFBZSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFLFVBQVUsQ0FBQyxDQUFDO0lBQzVELENBQUM7Ozs7Ozs7SUFLTSxvQkFBb0IsQ0FBQyxPQUFvQixFQUFFLGNBQW9COztjQUM5RCxZQUFZLEdBQUcsSUFBSSxDQUFDLHFCQUFxQixDQUFDLGNBQWMsQ0FBQzs7Y0FDekQsV0FBVyxHQUFHLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxjQUFjLENBQUM7UUFDaEUsT0FBTyxHQUFHLGNBQWMsQ0FBQyw4QkFBOEIsQ0FBQyxPQUFPLEVBQUUsWUFBWSxDQUFDLENBQUM7UUFDL0UsSUFBSSxXQUFXLEVBQUU7WUFDZixPQUFPLEdBQUcsY0FBYyxDQUFDLHVCQUF1QixDQUFDLE9BQU8sRUFBRSxXQUFXLENBQUMsQ0FBQztZQUN2RSxPQUFPLEdBQUcsY0FBYyxDQUFDLGVBQWUsQ0FBQyxPQUFPLEVBQUUsV0FBVyxDQUFDLENBQUM7U0FDaEU7UUFFRCxzRUFBc0U7UUFDdEUsbUJBQW1CO1FBQ25CLDBDQUEwQztRQUMxQyxPQUFPLEdBQUcsY0FBYyxDQUFDLGdCQUFnQixDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDdEUsSUFBSTtRQUNKLGdFQUFnRTtRQUNoRSxPQUFPLE9BQU8sQ0FBQztJQUNqQixDQUFDOzs7Ozs7SUFLTSxvQkFBb0IsQ0FBQyxPQUFvQjtRQUM5QyxPQUFPLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ3ZCLENBQUM7Ozs7O0lBS00sYUFBYTs7Y0FDWixNQUFNLEdBQWdDO1lBQzFDLFlBQVksRUFBRSxNQUFNO1NBQ3JCO1FBQ0QsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRTs7a0JBQ2pCLFVBQVUsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBYSxVQUFVLEVBQUUsSUFBSSxDQUFDO1lBQ2xFLE1BQU0sQ0FBQyxPQUFPLEdBQUcsSUFBSSxXQUFXLENBQUMsRUFBRSxTQUFTLEVBQUUsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDLENBQUM7WUFDbkUsTUFBTSxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyw4QkFBOEIsRUFBRSxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7WUFDMUYsbUJBQW1CO1lBQ25CLDBDQUEwQztZQUMxQyxNQUFNLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLGNBQWMsRUFBRSxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7WUFDMUUsR0FBRztZQUNILE1BQU0sQ0FBQyxPQUFPLEdBQUcsY0FBYyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUM7U0FDeEQ7UUFFRCxPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsWUFBWSxFQUFFLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FDckUsR0FBRzs7OztRQUFDLENBQUMsV0FBbUIsRUFBRSxFQUFFO1lBQzFCLElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDakMsQ0FBQyxFQUFDLENBQ0gsQ0FBQztJQUNKLENBQUM7Ozs7SUFFTSxnQkFBZ0I7SUFDdkIsQ0FBQzs7Ozs7Ozs7OztJQVFTLG9CQUFvQixDQUFDLGNBQW9COztZQUM3QyxTQUFTLEdBQUcsSUFBSTtRQUNwQixJQUFJLGNBQWMsRUFBRTtZQUNsQixTQUFTLEdBQUcsSUFBSSxDQUFDLHFCQUFxQixDQUFDLGNBQWMsQ0FBQyxDQUFDO1NBQ3hEO2FBQU07WUFDTCxTQUFTLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQztTQUMvQjtRQUNELE9BQU8sR0FBRyxTQUFTLElBQUksSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO0lBQzdDLENBQUM7Q0FFRjs7Ozs7O0lBL0hDLHVEQUEyQjs7Ozs7O0lBSTNCLDJEQUE2Qjs7Ozs7O0lBSzdCLHlEQUErQjs7Ozs7SUFFL0IsMERBQWlDOztBQXVIbkMsTUFBTSxpQ0FBa0MsU0FBUSwwQkFBMEI7Ozs7Ozs7O0lBV3hFLFlBQ0UsZUFBeUMsRUFBRSxpQkFBMEMsRUFBRSxTQUFpQixFQUFFLFFBQWtCO1FBRTVILEtBQUssQ0FBQyxlQUFlLEVBQUUsaUJBQWlCLENBQUMsQ0FBQztRQUMxQyxJQUFJLENBQUMsWUFBWSxHQUFHLFNBQVMsQ0FBQztRQUM5QixJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQztJQUMzQixDQUFDOzs7O0lBRU0sWUFBWTs7Y0FDWCxVQUFVLEdBQUcsSUFBSSxDQUFDLG9CQUFvQixFQUFFOztjQUN4QyxTQUFTLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDO1FBQzFELE9BQU8sRUFBRSxDQUFDLFNBQVMsQ0FBQyxDQUFBO1FBQ3BCLG1CQUFtQjtJQUNyQixDQUFDOzs7Ozs7SUFLTSxZQUFZLENBQUMsU0FBaUI7O2NBQzdCLFVBQVUsR0FBRyxJQUFJLENBQUMsb0JBQW9CLEVBQUU7UUFDOUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsVUFBVSxFQUFFLFNBQVMsQ0FBQyxDQUFDO0lBQ3RELENBQUM7Ozs7O0lBS00sY0FBYzs7Y0FDYixVQUFVLEdBQUcsSUFBSSxDQUFDLG9CQUFvQixFQUFFO1FBQzlDLElBQUksQ0FBQyxlQUFlLENBQUMsVUFBVSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQzlDLENBQUM7Ozs7Ozs7SUFLTSxvQkFBb0IsQ0FBQyxPQUFvQixFQUFFLGNBQW9COztjQUM5RCxZQUFZLEdBQUcsSUFBSSxDQUFDLHFCQUFxQixDQUFDLGNBQWMsQ0FBQzs7Y0FDekQsV0FBVyxHQUFHLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxjQUFjLENBQUM7OztjQUUxRCxVQUFVLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQWEsVUFBVSxFQUFFLElBQUksQ0FBQztRQUNsRSxJQUFJLFVBQVUsRUFBRTs7a0JBQ1IsS0FBSyxHQUFHLFVBQVUsQ0FBQyxLQUFLO1lBQzlCLE9BQU8sR0FBRyxjQUFjLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxFQUFFLEtBQUssQ0FBQyxDQUFDO1NBQzNEO1FBQ0QsT0FBTyxHQUFHLGNBQWMsQ0FBQyw4QkFBOEIsQ0FBQyxPQUFPLEVBQUUsWUFBWSxDQUFDLENBQUM7UUFDL0UsSUFBSSxXQUFXLEVBQUU7WUFDZixPQUFPLEdBQUcsY0FBYyxDQUFDLHVCQUF1QixDQUFDLE9BQU8sRUFBRSxXQUFXLENBQUMsQ0FBQztTQUN4RTtRQUNELE9BQU8sT0FBTyxDQUFDO0lBQ2pCLENBQUM7Ozs7OztJQUtNLG9CQUFvQixDQUFDLE9BQW9CO1FBQzlDLE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDdkIsQ0FBQzs7Ozs7Ozs7SUFPUyxvQkFBb0IsQ0FBQyxjQUFvQjs7Ozs7Ozs7WUFPN0MsU0FBUyxHQUFHLElBQUk7UUFDcEIsSUFBSSxjQUFjLEVBQUU7WUFDbEIsU0FBUyxHQUFHLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxjQUFjLENBQUMsQ0FBQztTQUN4RDthQUFNO1lBQ0wsU0FBUyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUM7U0FDL0I7UUFDRCxPQUFPLEdBQUcsU0FBUyxJQUFJLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztJQUM3QyxDQUFDO0NBQ0Y7Ozs7Ozs7SUFuRkMseURBQTZCOzs7OztJQUM3QixxREFBMkI7O0FBb0Y3QixPQUFPLEVBQUUsMEJBQTBCLEVBQUUsbUNBQW1DLEVBQUUsaUNBQWlDLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXHJcbiAqIEBBdXRob3I6IFdpdHRcclxuICogQERhdGU6IDIwMTgtMTAtMTEgMjA6MzI6MDJcclxuICogQExhc3QgTW9kaWZpZWQgYnk6IFdpdHRcclxuICogQExhc3QgTW9kaWZpZWQgdGltZTogMjAyMC0wMy0wMyAxNjo0NjozOVxyXG4gKi9cclxuXHJcbmltcG9ydCB7IEh0dHBDbGllbnQsIEh0dHBIZWFkZXJzIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xyXG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBvZiB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IEZyYW1ld29ya1Nlc3Npb25TZXJ2aWNlIH0gZnJvbSAnLi4vZnJhbWV3b3JrX3Nlc3Npb25fc2VydmljZSc7XHJcbmltcG9ydCB7IEh0dHBIZWFkZXJVdGlsIH0gZnJvbSAnLi4vdXRpbHMvaW5kZXgnO1xyXG5pbXBvcnQgeyBCZVNlc3Npb25TdG9yYWdlU3RyYXRlZ3kgfSBmcm9tICcuL2JlZl9zZXNzaW9uX3N0b3JhZ2Vfc3RyYXRlZ3knO1xyXG5pbXBvcnQgeyBIdHRwU2VydmljZSB9IGZyb20gJy4uL2h0dHBfc2VydmljZSc7XHJcbmltcG9ydCB7IEluamVjdG9yIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEFwcENvbnRleHQgfSBmcm9tICdAZmFycmlzL2RldmtpdCc7XHJcbi8qKlxyXG4gKiBCZWZTZXNzaW9u5aSE55CG562W55Wl57G7XHJcbiAqL1xyXG5hYnN0cmFjdCBjbGFzcyBCZWZTZXNzaW9uSGFuZGxpbmdTdHJhdGVneSB7XHJcblxyXG4gIC8qKlxyXG4gICAqIOWtmOWCqOetlueVpVxyXG4gICAqL1xyXG4gIHByb3RlY3RlZCBzdG9yYWdlU3RyYXRlZ3k6IEJlU2Vzc2lvblN0b3JhZ2VTdHJhdGVneTtcclxuXHJcbiAgLyoqXHJcbiAgICog5qGG5p62U2Vzc2lvbuacjeWKoVxyXG4gICAqL1xyXG4gIHByb3RlY3RlZCBmcm1TZXNzaW9uU2VydmljZTogRnJhbWV3b3JrU2Vzc2lvblNlcnZpY2U7XHJcbiAgLyoqXHJcbiAgICog5qGG5p62U2Vzc2lvbklk77yI55So5oi355qE5oiW6ICF5Yqf6IO96I+c5Y2V55qE77yJXHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIGdldEZybVNlc3Npb25JZChydW50aW1lQ29udGV4dD86IGFueSk6IHN0cmluZyB7XHJcbiAgICByZXR1cm4gdGhpcy5mcm1TZXNzaW9uU2VydmljZS5nZXRDdXJyZW50U2Vzc2lvbklkKHJ1bnRpbWVDb250ZXh0KTtcclxuICB9XHJcbiAgcHJvdGVjdGVkIGdldCBmcm1TZXNzaW9uSWQoKTogc3RyaW5nIHtcclxuICAgIHJldHVybiB0aGlzLmZybVNlc3Npb25TZXJ2aWNlLmdldEN1cnJlbnRTZXNzaW9uSWQoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOaehOmAoOWHveaVsFxyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKHN0b3JhZ2VTdHJhdGVneTogQmVTZXNzaW9uU3RvcmFnZVN0cmF0ZWd5LCBmcm1TZXNzaW9uU2VydmljZTogRnJhbWV3b3JrU2Vzc2lvblNlcnZpY2UpIHtcclxuICAgIHRoaXMuc3RvcmFnZVN0cmF0ZWd5ID0gc3RvcmFnZVN0cmF0ZWd5O1xyXG4gICAgdGhpcy5mcm1TZXNzaW9uU2VydmljZSA9IGZybVNlc3Npb25TZXJ2aWNlO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6I635Y+WU2Vzc2lvbklkXHJcbiAgICovXHJcbiAgcHVibGljIGFic3RyYWN0IGdldFNlc3Npb25JZCgpOiBPYnNlcnZhYmxlPHN0cmluZz47XHJcbiAgcHVibGljIGFic3RyYWN0IHNldFNlc3Npb25JZChzZXNzaW9uSWQpOiB2b2lkO1xyXG4gIHB1YmxpYyBhYnN0cmFjdCBjbGVhclNlc3Npb25JZCgpOiB2b2lkO1xyXG4gIHB1YmxpYyBhYnN0cmFjdCBleHRlbmRSZXF1ZXN0SGVhZGVycyhoZWFkZXJzOiBIdHRwSGVhZGVycywgcnVudGltZUNvbnRleHQ/OiBhbnkpOiBIdHRwSGVhZGVycztcclxuICBwdWJsaWMgYWJzdHJhY3QgaGFuZGxlUmVwb25zZUhlYWRlcnMoaGVhZGVyczogSHR0cEhlYWRlcnMpOiB2b2lkO1xyXG4gIHByb3RlY3RlZCBhYnN0cmFjdCBnZXRTZXNzaW9uU3RvcmFnZUtleShydW50aW1lQ29udGV4dD86IGFueSk6IHN0cmluZztcclxuXHJcbiAgLyoqXHJcbiAgICog6I635Y+W5qGG5p62U2Vzc2lvbklkXHJcbiAgICovXHJcbiAgcHVibGljIGdldEZyYW1ld29ya1Nlc3Npb25JZChydW50aW1lQ29udGV4dD86IGFueSkge1xyXG4gICAgcmV0dXJuIHRoaXMuZ2V0RnJtU2Vzc2lvbklkKHJ1bnRpbWVDb250ZXh0KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOS7jue8k+WtmOS4reiOt+WPlkJlU2Vzc2lvblxyXG4gICAqL1xyXG4gIHByb3RlY3RlZCBnZXRTZXNzaW9uSWRGcm9tU3RvcmFnZShydW50aW1lQ29udGV4dD86IGFueSkge1xyXG4gICAgY29uc3Qgc2Vzc2lvblN0b3JhZ2VLZXkgPSB0aGlzLmdldFNlc3Npb25TdG9yYWdlS2V5KHJ1bnRpbWVDb250ZXh0KTtcclxuICAgIGNvbnN0IGJlU2Vzc2lvbklkID0gdGhpcy5zdG9yYWdlU3RyYXRlZ3kuZ2V0SXRlbShzZXNzaW9uU3RvcmFnZUtleSk7XHJcbiAgICByZXR1cm4gYmVTZXNzaW9uSWQ7XHJcbiAgfVxyXG59XHJcblxyXG4vKipcclxuICog6ZqU56a755qEQmVTZXNzaW9u5aSE55CG562W55Wl77yI5q2k562W55Wl5b+F6aG75L+d6K+BaW5qZWN0b3LkuLpudWxs55qE5oOF5Ya15LiL5q2j5bi45b2x6K6v5oCn77yJXHJcbiAqIEBzdW1tYXJ5XHJcbiAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cclxuICog5aSE55CG5Y6f5YiZ77yaXHJcbiAqIDHjgIHpgJrov4djcmVhdGVTZXNzaW9u5Yib5bu677ybXHJcbiAqIDLjgIHmr4/kuKpSZXBvc2l0b3J55oul5pyJ54us56uL55qEQmVTZXNzaW9u77ybXHJcbiAqIDPjgIHorr/pl65CReeahEVBUEnml7bvvIzpgJrov4doZWFkZXLph4znmoRTZXNzaW9uSWTkvKDpgJLvvJtcclxuICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxyXG4gKiDlhbzlrrnmgKfogIPomZHvvJpcclxuICogMeOAgeacieS6p+WTgemDqOebtOaOpW5ldyBCZVNlc3Npb25TZXJ2aWNlKCnvvIzmsqHmnInkvKDpgJJcclxuICovXHJcbmNsYXNzIEJlZlNlcGFyYXRlZFNlc3Npb25IYW5kbGluZ1N0cmF0ZWd5IGV4dGVuZHMgQmVmU2Vzc2lvbkhhbmRsaW5nU3RyYXRlZ3kge1xyXG4gIHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yO1xyXG4gIC8qKlxyXG4gICAqIOWIm+W7ulNlc3Npb27nmoTnmoRFQVBJ5Zyw5Z2AXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBiZVNlc3Npb25Vcmk6IHN0cmluZztcclxuXHJcbiAgLyoqXHJcbiAgICogaHR0cENsaWVudFxyXG4gICAqL1xyXG4gIHByaXZhdGUgaHR0cENsaWVudDogSHR0cENsaWVudDtcclxuXHJcbiAgcHJpdmF0ZSBodHRwU2VydmljZTogSHR0cFNlcnZpY2U7XHJcbiAgLyoqXHJcbiAgICog5p6E6YCg5Ye95pWwXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBzdG9yYWdlU3RyYXRlZ3k6IEJlU2Vzc2lvblN0b3JhZ2VTdHJhdGVneSwgZnJtU2Vzc2lvblNlcnZpY2U6IEZyYW1ld29ya1Nlc3Npb25TZXJ2aWNlLFxyXG4gICAgaHR0cENsaWVudDogSHR0cENsaWVudCwgYmVCYXNlVXJpOiBzdHJpbmcsIGluamVjdG9yOiBJbmplY3RvclxyXG4gICkge1xyXG4gICAgc3VwZXIoc3RvcmFnZVN0cmF0ZWd5LCBmcm1TZXNzaW9uU2VydmljZSk7XHJcbiAgICB0aGlzLmJlU2Vzc2lvblVyaSA9IGJlQmFzZVVyaTtcclxuICAgIHRoaXMuaHR0cENsaWVudCA9IGh0dHBDbGllbnQ7XHJcbiAgICB0aGlzLmh0dHBTZXJ2aWNlID0gbmV3IEh0dHBTZXJ2aWNlKHRoaXMuaHR0cENsaWVudCk7XHJcbiAgICB0aGlzLmluamVjdG9yID0gaW5qZWN0b3I7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDojrflj5ZCZVNlc3Npb25JZFxyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXRTZXNzaW9uSWQoKTogT2JzZXJ2YWJsZTxzdHJpbmc+IHtcclxuICAgIGNvbnN0IGJlU2Vzc2lvbklkID0gdGhpcy5nZXRTZXNzaW9uSWRGcm9tU3RvcmFnZSgpO1xyXG4gICAgaWYgKGJlU2Vzc2lvbklkKSB7XHJcbiAgICAgIHJldHVybiBvZihiZVNlc3Npb25JZCk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdGhpcy5jcmVhdGVTZXNzaW9uKCk7XHJcblxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6K6+572uQmVTZXNzaW9uSWRcclxuICAgKi9cclxuICBwdWJsaWMgc2V0U2Vzc2lvbklkKHNlc3Npb25JZDogc3RyaW5nKTogdm9pZCB7XHJcbiAgICBjb25zdCBzZXNzaW9uS2V5ID0gdGhpcy5nZXRTZXNzaW9uU3RvcmFnZUtleSgpO1xyXG4gICAgdGhpcy5zdG9yYWdlU3RyYXRlZ3kuc2V0SXRlbShzZXNzaW9uS2V5LCBzZXNzaW9uSWQpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5riF56m6U2Vzc2lvbmlkXHJcbiAgICovXHJcbiAgcHVibGljIGNsZWFyU2Vzc2lvbklkKCkge1xyXG4gICAgY29uc3Qgc2Vzc2lvbktleSA9IHRoaXMuZ2V0U2Vzc2lvblN0b3JhZ2VLZXkoKTtcclxuICAgIC8vIHRoaXMuc3RvcmFnZVN0cmF0ZWd5LnJlbW92ZUl0ZW0oc2Vzc2lvbktleSk7XHJcbiAgICB0aGlzLnN0b3JhZ2VTdHJhdGVneS5jbGVhcih0aGlzLmZybVNlc3Npb25JZCwgc2Vzc2lvbktleSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmianlsZVTZXNzaW9u55u45YWz5aS05L+h5oGvXHJcbiAgICovXHJcbiAgcHVibGljIGV4dGVuZFJlcXVlc3RIZWFkZXJzKGhlYWRlcnM6IEh0dHBIZWFkZXJzLCBydW50aW1lQ29udGV4dD86IGFueSk6IEh0dHBIZWFkZXJzIHtcclxuICAgIGNvbnN0IGZybVNlc3Npb25JZCA9IHRoaXMuZ2V0RnJhbWV3b3JrU2Vzc2lvbklkKHJ1bnRpbWVDb250ZXh0KTtcclxuICAgIGNvbnN0IGJlU2Vzc2lvbklkID0gdGhpcy5nZXRTZXNzaW9uSWRGcm9tU3RvcmFnZShydW50aW1lQ29udGV4dCk7XHJcbiAgICBoZWFkZXJzID0gSHR0cEhlYWRlclV0aWwuYXBwZW5kQ2FmUnVudGltZUNvbW1vblZhcmlhYmxlKGhlYWRlcnMsIGZybVNlc3Npb25JZCk7XHJcbiAgICBpZiAoYmVTZXNzaW9uSWQpIHtcclxuICAgICAgaGVhZGVycyA9IEh0dHBIZWFkZXJVdGlsLmFwcGVuZENhZlJ1bnRpbWVDb250ZXh0KGhlYWRlcnMsIGJlU2Vzc2lvbklkKTtcclxuICAgICAgaGVhZGVycyA9IEh0dHBIZWFkZXJVdGlsLmFwcGVuZFNlc3Npb25JZChoZWFkZXJzLCBiZVNlc3Npb25JZCk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gY29uc3QgYXBwQ29udGV4dCA9IHRoaXMuaW5qZWN0b3IuZ2V0PEFwcENvbnRleHQ+KEFwcENvbnRleHQsIG51bGwpO1xyXG4gICAgLy9pZiAoYXBwQ29udGV4dCkge1xyXG4gICAgLy8gY29uc3QgYXBwSWQgPSBhcHBDb250ZXh0LkFwcGxpY2F0aW9uSWQ7XHJcbiAgICBoZWFkZXJzID0gSHR0cEhlYWRlclV0aWwuYXBwZW5kRnVuY0luc3RJZChoZWFkZXJzLCB0aGlzLmJlU2Vzc2lvblVyaSk7XHJcbiAgICAvLyB9XHJcbiAgICAvLyBoZWFkZXJzID0gSHR0cEhlYWRlclV0aWwuYXBwZW5kUmVxdWlyZU1lc3NhZ2UoaGVhZGVycywgdHJ1ZSk7XHJcbiAgICByZXR1cm4gaGVhZGVycztcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWkhOeQhuacjeWKoeWZqOerr+i/lOWbnueahGhlYWRlcnNcclxuICAgKi9cclxuICBwdWJsaWMgaGFuZGxlUmVwb25zZUhlYWRlcnMoaGVhZGVyczogSHR0cEhlYWRlcnMpOiB2b2lkIHtcclxuICAgIGNvbnNvbGUubG9nKGhlYWRlcnMpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5Yib5bu6QmVTZXNzaW9uSWRcclxuICAgKi9cclxuICBwdWJsaWMgY3JlYXRlU2Vzc2lvbigpOiBPYnNlcnZhYmxlPHN0cmluZz4ge1xyXG4gICAgY29uc3QgcGFyYW1zOiB7IFtwcm9wTmFtZTogc3RyaW5nXTogYW55IH0gPSB7XHJcbiAgICAgIHJlc3BvbnNlVHlwZTogJ3RleHQnXHJcbiAgICB9O1xyXG4gICAgaWYgKCEhdGhpcy5mcm1TZXNzaW9uSWQpIHtcclxuICAgICAgY29uc3QgYXBwQ29udGV4dCA9IHRoaXMuaW5qZWN0b3IuZ2V0PEFwcENvbnRleHQ+KEFwcENvbnRleHQsIG51bGwpO1xyXG4gICAgICBwYXJhbXMuaGVhZGVycyA9IG5ldyBIdHRwSGVhZGVycyh7IFNlc3Npb25JZDogdGhpcy5mcm1TZXNzaW9uSWQgfSk7XHJcbiAgICAgIHBhcmFtcy5oZWFkZXJzID0gcGFyYW1zLmhlYWRlcnMuYXBwZW5kKCdYLUNBRi1SdW50aW1lLUNvbW1vblZhcmlhYmxlJywgdGhpcy5mcm1TZXNzaW9uSWQpO1xyXG4gICAgICAvL2lmIChhcHBDb250ZXh0KSB7XHJcbiAgICAgIC8vIGNvbnN0IGFwcElkID0gYXBwQ29udGV4dC5BcHBsaWNhdGlvbklkO1xyXG4gICAgICBwYXJhbXMuaGVhZGVycyA9IHBhcmFtcy5oZWFkZXJzLmFwcGVuZCgnRnVuYy1JbnN0LUlkJywgdGhpcy5iZVNlc3Npb25VcmkpO1xyXG4gICAgICAvL31cclxuICAgICAgcGFyYW1zLmhlYWRlcnMgPSBIdHRwSGVhZGVyVXRpbC50b0pzb24ocGFyYW1zLmhlYWRlcnMpO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiB0aGlzLmh0dHBTZXJ2aWNlLnJlcXVlc3QoJ1BPU1QnLCB0aGlzLmJlU2Vzc2lvblVyaSwgcGFyYW1zKS5waXBlKFxyXG4gICAgICB0YXAoKGJlU2Vzc2lvbklkOiBzdHJpbmcpID0+IHtcclxuICAgICAgICB0aGlzLnNldFNlc3Npb25JZChiZVNlc3Npb25JZCk7XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGV4dGVuZEh0dHBIZWFkZXIoKSB7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDojrflj5bmn5DkuKpSZXBvc2l0b3J55a+55bqU55qEQmVTZXNzaW9u55qE5ZSv5LiAa2V5XHJcbiAgICogQHN1bW1hcnlcclxuICAgKiAx44CB5Zyo5L2/55So54us56uLQmVTZXNzaW9u55qE57uE5ZCI6KGo5Y2V5Lit77yM6ZyA6KaB6YCa6L+HQmVTZXNzaW9uVXJp6ZqU56a777ybXHJcbiAgICogMuOAgeWcqERlYnVn5qih5byP5LiL77yMRnJtU2Vzc2lvbklkPVVzZXJTZXNzaW9uaWTvvIzlpoLmnpzlj6rnlKjlroPkvZxrZXnvvIxcclxuICAgKi9cclxuICBwcm90ZWN0ZWQgZ2V0U2Vzc2lvblN0b3JhZ2VLZXkocnVudGltZUNvbnRleHQ/OiBhbnkpOiBzdHJpbmcge1xyXG4gICAgbGV0IHNlc3Npb25JZCA9IG51bGw7XHJcbiAgICBpZiAocnVudGltZUNvbnRleHQpIHtcclxuICAgICAgc2Vzc2lvbklkID0gdGhpcy5nZXRGcmFtZXdvcmtTZXNzaW9uSWQocnVudGltZUNvbnRleHQpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgc2Vzc2lvbklkID0gdGhpcy5mcm1TZXNzaW9uSWQ7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gYCR7c2Vzc2lvbklkfV8ke3RoaXMuYmVTZXNzaW9uVXJpfWA7XHJcbiAgfVxyXG5cclxufVxyXG5cclxuXHJcbmNsYXNzIEJlZlVuaWZpZWRTZXNzaW9uSGFuZGxpbmdTdHJhdGVneSBleHRlbmRzIEJlZlNlc3Npb25IYW5kbGluZ1N0cmF0ZWd5IHtcclxuXHJcbiAgLyoqXHJcbiAgICog5Yib5bu6U2Vzc2lvbueahOeahEVBUEnlnLDlnYBcclxuICAgKi9cclxuICBwcml2YXRlIGJlU2Vzc2lvblVyaTogc3RyaW5nO1xyXG4gIHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yO1xyXG5cclxuICAvKipcclxuICAgKiDmnoTpgKDlh73mlbBcclxuICAgKi9cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHN0b3JhZ2VTdHJhdGVneTogQmVTZXNzaW9uU3RvcmFnZVN0cmF0ZWd5LCBmcm1TZXNzaW9uU2VydmljZTogRnJhbWV3b3JrU2Vzc2lvblNlcnZpY2UsIGJlQmFzZVVyaTogc3RyaW5nLCBpbmplY3RvcjogSW5qZWN0b3JcclxuICApIHtcclxuICAgIHN1cGVyKHN0b3JhZ2VTdHJhdGVneSwgZnJtU2Vzc2lvblNlcnZpY2UpO1xyXG4gICAgdGhpcy5iZVNlc3Npb25VcmkgPSBiZUJhc2VVcmk7XHJcbiAgICB0aGlzLmluamVjdG9yID0gaW5qZWN0b3I7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgZ2V0U2Vzc2lvbklkKCk6IE9ic2VydmFibGU8c3RyaW5nPiB7XHJcbiAgICBjb25zdCBzZXNzaW9uS2V5ID0gdGhpcy5nZXRTZXNzaW9uU3RvcmFnZUtleSgpO1xyXG4gICAgY29uc3Qgc2Vzc2lvbklkID0gdGhpcy5zdG9yYWdlU3RyYXRlZ3kuZ2V0SXRlbShzZXNzaW9uS2V5KTtcclxuICAgIHJldHVybiBvZihzZXNzaW9uSWQpXHJcbiAgICAvLyByZXR1cm4gb2YobnVsbCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDorr7nva5CZVNlc3Npb25JZFxyXG4gICAqL1xyXG4gIHB1YmxpYyBzZXRTZXNzaW9uSWQoc2Vzc2lvbklkOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIGNvbnN0IHNlc3Npb25LZXkgPSB0aGlzLmdldFNlc3Npb25TdG9yYWdlS2V5KCk7XHJcbiAgICB0aGlzLnN0b3JhZ2VTdHJhdGVneS5zZXRJdGVtKHNlc3Npb25LZXksIHNlc3Npb25JZCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmuIXnqbpTZXNzaW9uaWRcclxuICAgKi9cclxuICBwdWJsaWMgY2xlYXJTZXNzaW9uSWQoKSB7XHJcbiAgICBjb25zdCBzZXNzaW9uS2V5ID0gdGhpcy5nZXRTZXNzaW9uU3RvcmFnZUtleSgpO1xyXG4gICAgdGhpcy5zdG9yYWdlU3RyYXRlZ3kucmVtb3ZlSXRlbShzZXNzaW9uS2V5KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOaJqeWxlVNlc3Npb27nm7jlhbPlpLTkv6Hmga9cclxuICAgKi9cclxuICBwdWJsaWMgZXh0ZW5kUmVxdWVzdEhlYWRlcnMoaGVhZGVyczogSHR0cEhlYWRlcnMsIHJ1bnRpbWVDb250ZXh0PzogYW55KTogSHR0cEhlYWRlcnMge1xyXG4gICAgY29uc3QgZnJtU2Vzc2lvbklkID0gdGhpcy5nZXRGcmFtZXdvcmtTZXNzaW9uSWQocnVudGltZUNvbnRleHQpO1xyXG4gICAgY29uc3QgYmVTZXNzaW9uSWQgPSB0aGlzLmdldFNlc3Npb25JZEZyb21TdG9yYWdlKHJ1bnRpbWVDb250ZXh0KTtcclxuICAgIC8vIGhlYWRlcnMgPSBIdHRwSGVhZGVyVXRpbC5hcHBlbmRSZXF1aXJlTWVzc2FnZShoZWFkZXJzLCB0cnVlKTtcclxuICAgIGNvbnN0IGFwcENvbnRleHQgPSB0aGlzLmluamVjdG9yLmdldDxBcHBDb250ZXh0PihBcHBDb250ZXh0LCBudWxsKTtcclxuICAgIGlmIChhcHBDb250ZXh0KSB7XHJcbiAgICAgIGNvbnN0IHRva2VuID0gYXBwQ29udGV4dC5Ub2tlbjtcclxuICAgICAgaGVhZGVycyA9IEh0dHBIZWFkZXJVdGlsLmFwcGVuZEZ1bmNJbnN0SWQoaGVhZGVycywgdG9rZW4pO1xyXG4gICAgfVxyXG4gICAgaGVhZGVycyA9IEh0dHBIZWFkZXJVdGlsLmFwcGVuZENhZlJ1bnRpbWVDb21tb25WYXJpYWJsZShoZWFkZXJzLCBmcm1TZXNzaW9uSWQpO1xyXG4gICAgaWYgKGJlU2Vzc2lvbklkKSB7XHJcbiAgICAgIGhlYWRlcnMgPSBIdHRwSGVhZGVyVXRpbC5hcHBlbmRDYWZSdW50aW1lQ29udGV4dChoZWFkZXJzLCBiZVNlc3Npb25JZCk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gaGVhZGVycztcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWkhOeQhuacjeWKoeWZqOerr+i/lOWbnueahGhlYWRlcnNcclxuICAgKi9cclxuICBwdWJsaWMgaGFuZGxlUmVwb25zZUhlYWRlcnMoaGVhZGVyczogSHR0cEhlYWRlcnMpOiB2b2lkIHtcclxuICAgIGNvbnNvbGUubG9nKGhlYWRlcnMpO1xyXG4gIH1cclxuXHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluafkOS4qlJlcG9zaXRvcnnlr7nlupTnmoRCZVNlc3Npb27nmoTllK/kuIBrZXlcclxuICAgKiBAc3VtbWFyeVxyXG4gICAqL1xyXG4gIHByb3RlY3RlZCBnZXRTZXNzaW9uU3RvcmFnZUtleShydW50aW1lQ29udGV4dD86IGFueSk6IHN0cmluZyB7XHJcbiAgICAvLyBjb25zdCBpc0RlYnVnID0gZmFsc2U7XHJcbiAgICAvLyBpZiAoaXNEZWJ1Zykge1xyXG4gICAgLy8gICByZXR1cm4gYCR7dGhpcy5mcm1TZXNzaW9uSWR9XyR7dGhpcy5iZVNlc3Npb25Vcml9YDtcclxuICAgIC8vIH0gZWxzZSB7XHJcbiAgICAvLyAgIHJldHVybiB0aGlzLmZybVNlc3Npb25JZDtcclxuICAgIC8vIH1cclxuICAgIGxldCBzZXNzaW9uSWQgPSBudWxsO1xyXG4gICAgaWYgKHJ1bnRpbWVDb250ZXh0KSB7XHJcbiAgICAgIHNlc3Npb25JZCA9IHRoaXMuZ2V0RnJhbWV3b3JrU2Vzc2lvbklkKHJ1bnRpbWVDb250ZXh0KTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHNlc3Npb25JZCA9IHRoaXMuZnJtU2Vzc2lvbklkO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGAke3Nlc3Npb25JZH1fJHt0aGlzLmJlU2Vzc2lvblVyaX1gO1xyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IHsgQmVmU2Vzc2lvbkhhbmRsaW5nU3RyYXRlZ3ksIEJlZlNlcGFyYXRlZFNlc3Npb25IYW5kbGluZ1N0cmF0ZWd5LCBCZWZVbmlmaWVkU2Vzc2lvbkhhbmRsaW5nU3RyYXRlZ3kgfTtcclxuIl19