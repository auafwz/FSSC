import { Injectable, ElementRef } from '@angular/core';
import { Repository, FrameContext } from '@farris/devkit';
import { FrameContextService } from './frame-context.service';
import { FormControlService } from './form-control.service';
var FIXED_COLUMN_START_INDEX = 5000;
var GRID_COLUMN_START_INDEX = 10000;
/**
 * 表单验证服务
 * @scope FrameComponent
 */
var FocusInvalidService = /** @class */ (function () {
    /**
     * 构造函数
     */
    function FocusInvalidService(repository, frameContext, frameContextService, formControlService) {
        this.repository = repository;
        this.frameContext = frameContext;
        this.frameContextService = frameContextService;
        this.formControlService = formControlService;
    }
    /**
     * 向第一个验证不通过的字段设置焦点
     */
    FocusInvalidService.prototype.focusInvalidInput = function (verifyInformations, rootElement) {
        // 无验证不通过信息时，直接返回。
        if (!verifyInformations || !verifyInformations.length) {
            return;
        }
        var targetField = null;
        var firstVerifyInformation = this.selectFirstVerifyInformation(verifyInformations, rootElement);
        if (firstVerifyInformation) {
            targetField = firstVerifyInformation.targetField;
            if (targetField) {
                var canFocus = this.focusElement(targetField, rootElement);
                if (canFocus) {
                    verifyInformations['focused'] = true;
                }
            }
        }
    };
    /**
     * 设置DataGrid单元格焦点
     */
    FocusInvalidService.prototype.focusGridCell = function (verifyInformations, focusableDataGrid) {
        if (!verifyInformations || !verifyInformations.length || verifyInformations['focused'] == true) {
            return;
        }
        var targetField = null;
        var targetId = null;
        var firstVerifyInformation = this.selectFirstVerifyInformation(verifyInformations);
        if (firstVerifyInformation) {
            targetField = firstVerifyInformation.targetField;
            targetId = firstVerifyInformation.id;
            verifyInformations['focused'] = true;
            focusableDataGrid.editCell(targetId, targetField);
        }
    };
    FocusInvalidService.prototype.updateVerifyInformationsIndex = function (verifyInformations, rootElement) {
        var _this = this;
        verifyInformations = verifyInformations.filter(function (verifyInformation) {
            var frameContexts = _this.getFrameContextsByPropertyPath(verifyInformation.fullPath, '/');
            var frameContext = frameContexts && frameContexts[0] || null;
            return frameContext && frameContext.frameId === _this.frameContext.frameId;
        });
        return verifyInformations.map(function (verifyInformation) {
            var tabIndex = -1;
            if (verifyInformation) {
                if (rootElement && verifyInformation.targetField) {
                    var input = _this.getInputElementById(verifyInformation.targetField, rootElement);
                    tabIndex = input && input.getAttribute('tabindex') || -1;
                    tabIndex = Number(tabIndex);
                }
                var frameContexts = _this.getFrameContextsByPropertyPath(verifyInformation.fullPath, '/');
                var frameContext = frameContexts && frameContexts[0] || null;
                var frameIndex = frameContext.index + 1;
                verifyInformation.tabIndex = tabIndex;
                verifyInformation.domIndex = -1;
                verifyInformation.frameIndex = -1;
                verifyInformation.position = tabIndex;
                if (frameContext) {
                    var domIndex = _this.getFieldIndex(frameContext, verifyInformation.fullPath) || 0;
                    if (domIndex > 0) {
                        var rowIndex = verifyInformation.index || 0;
                        verifyInformation.domIndex = domIndex;
                        verifyInformation.frameIndex = frameContext.index;
                        verifyInformation.position = tabIndex > 0 ? tabIndex : (frameIndex * 1000 + rowIndex * 1000 + domIndex);
                    }
                }
            }
            return verifyInformation;
        });
    };
    FocusInvalidService.prototype.isGridComponent = function (frameContext) {
        if (frameContext) {
            var dataGridColumnsName = frameContext.viewModel['dataGridColumnsName'] || null;
            return dataGridColumnsName ? true : false;
        }
        return undefined;
    };
    FocusInvalidService.prototype.getColumnIndex = function (frameContext, binding) {
        binding = binding.split('/').filter(function (p) { return p; }).join('/');
        var bindingPaths = frameContext.viewModel.bindingPath.split('/').filter(function (p) { return p; });
        var dataGridColumnsName = frameContext.viewModel['dataGridColumnsName'] || null;
        var frameIndex = frameContext.index + 1;
        if (!dataGridColumnsName) {
            return undefined;
        }
        var columns = frameContext.viewModel[dataGridColumnsName];
        if (!columns || columns.length < 1) {
            return undefined;
        }
        // 打平columns
        columns = columns.reduce(function (results, item) {
            if (Array.isArray(item)) {
                return results.concat(item);
            }
            return results.concat([item]);
        }, []);
        var position = -1;
        var _loop_1 = function (index) {
            var column = columns[index];
            var fields = column && column.field && column.field.split('.').filter(function (p) { return p; }) || null;
            if (!fields) {
                return "continue";
            }
            if (bindingPaths.concat(fields).join('/') === binding) {
                var fixed_1 = column.fixed;
                if (fixed_1) {
                    var fixedColumns = columns.filter(function (item) { return item.fixed === fixed_1; });
                    var fixedColumnIndex = this_1.getIndexFromColumns(fixedColumns, binding);
                    if (fixed_1 === 'left') {
                        position = frameIndex * FIXED_COLUMN_START_INDEX + fixedColumnIndex;
                    }
                    else {
                        position = frameIndex * GRID_COLUMN_START_INDEX + 1000 + fixedColumnIndex;
                    }
                }
                else {
                    position = frameIndex * GRID_COLUMN_START_INDEX + index;
                }
                return "break";
            }
        };
        var this_1 = this;
        for (var index = 0; index < columns.length; index++) {
            var state_1 = _loop_1(index);
            if (state_1 === "break")
                break;
        }
        return position;
    };
    FocusInvalidService.prototype.getIndexFromColumns = function (columns, binding) {
        var bindingPaths = this.frameContext.viewModel.bindingPath.split('/').filter(function (p) { return p; });
        return columns.findIndex(function (column) {
            var fields = column && column.field && column.field.split('.').filter(function (p) { return p; }) || null;
            if (!fields) {
                return false;
            }
            if (bindingPaths.concat(fields).join('/') === binding) {
                return true;
            }
            return false;
        });
    };
    FocusInvalidService.prototype.selectFirstVerifyInformation = function (verifyInformations, rootElement) {
        verifyInformations = this.updateVerifyInformationsIndex(verifyInformations, rootElement);
        verifyInformations.sort(function (v1, v2) { return Number(v1.position) - Number(v2.position); });
        return verifyInformations && verifyInformations.length > 0 && verifyInformations[0] || null;
    };
    FocusInvalidService.prototype.getInputElementById = function (targetField, rootElement) {
        var element = rootElement.nativeElement.ownerDocument.getElementById(targetField) || null;
        if (element && element.tagName !== 'INPUT') {
            var inputs = element.getElementsByTagName('input');
            if (inputs.length) {
                element = inputs[0];
            }
        }
        return element;
    };
    FocusInvalidService.prototype.getFrameContextsByPropertyPath = function (propertyPath, separtor) {
        if (separtor === void 0) { separtor = '/'; }
        if (!propertyPath) {
            return [];
        }
        var frameContexts = this.frameContext && this.frameContext.appContext.frameContextManager.getFrameContexts() || [];
        return frameContexts.filter(function (frameContext) {
            var formControls = frameContext && frameContext.form && frameContext.form.ngFormControls || {};
            var bindingPath = frameContext && frameContext.viewModel && frameContext.viewModel.bindingPath || '';
            if (formControls && Object.keys(formControls).length > 0) {
                var key = Object.keys(formControls).find(function (key) {
                    var formControl = formControls[key];
                    if (!formControl || !formControl.binding) {
                        return false;
                    }
                    var bindings = formControl.binding.split('.').filter(function (p) { return p; });
                    var bindingPaths = bindingPath.split('/').filter(function (p) { return p; });
                    var fullPath = bindingPaths.concat(bindings);
                    return propertyPath.split(separtor).filter(function (p) { return p; }).join('/') === fullPath.join('/');
                });
                return key ? true : false;
            }
            return false;
        });
    };
    FocusInvalidService.prototype.getFormControlIndexByBindingPath = function (frameContext, binding) {
        var ngFormControls = this.getFormControlsByFrameContext(frameContext);
        if (!ngFormControls) {
            return null;
        }
        var bindings = binding.split('/').filter(function (p) { return p; });
        return Object.values(ngFormControls).findIndex(function (ngFormControl) {
            if (!ngFormControl) {
                return false;
            }
            var bindingPath = frameContext.viewModel.bindingPath;
            var bindingPaths = bindingPath.split('/').filter(function (p) { return p; });
            var formControlBindingPaths = ngFormControl.binding.split('.').filter(function (p) { return p; });
            var fullPath = bindingPaths.concat(formControlBindingPaths);
            return fullPath.join('/') === bindings.join('/');
        });
    };
    FocusInvalidService.prototype.getFieldIndex = function (frameContext, binding) {
        var isGridComponent = this.isGridComponent(frameContext);
        if (isGridComponent) {
            return this.getColumnIndex(frameContext, binding);
        }
        else {
            return this.getFormControlIndexByBindingPath(frameContext, binding);
        }
    };
    FocusInvalidService.prototype.getFormControlsByFrameContext = function (frameContext) {
        return frameContext && frameContext.form && frameContext.form.ngFormControls || null;
    };
    FocusInvalidService.prototype.focusElement = function (elementId, rootElement) {
        var focused = false;
        var elementToFocus = rootElement.nativeElement.ownerDocument.getElementById(elementId);
        // 未获取到指定字段时，返回，不再设置焦点。
        if (elementToFocus) {
            // 如果有多个id重复的元素，则不定位
            var elements = rootElement.nativeElement.ownerDocument.querySelectorAll("#" + elementId);
            if (elements && elements.length > 1) {
                return focused;
            }
            // 如果绑定目标字段的控件不是Input元素，则查找其下级节点。
            if (elementToFocus.tagName !== 'INPUT') {
                var subElements = elementToFocus.getElementsByTagName('input');
                if (subElements.length) {
                    elementToFocus = subElements[0];
                }
            }
            elementToFocus.focus();
            focused = true;
        }
        return focused;
    };
    /**
     * 设置焦点
     * @param verifyInformation 错误信息
     * @param frameContext 上下文
     * @returns
     */
    FocusInvalidService.prototype.focus = function (verifyInformation, frameContext) {
        if (!verifyInformation) {
            return;
        }
        var isGridValidation = verifyInformation.index !== null;
        if (isGridValidation) {
            var grid_1 = this.getGridRef(frameContext);
            if (grid_1) {
                setTimeout(function () {
                    grid_1.editCell(verifyInformation.id, verifyInformation.targetField);
                }, 0);
            }
        }
        else {
            var frameElement_1 = this.getComponentRef(frameContext);
            var elementId = verifyInformation.targetField;
            this.focusById(elementId, frameElement_1);
        }
    };
    /**
     * 通过控件id设置焦点
     * @param elementId
     * @param elementRef
     */
    FocusInvalidService.prototype.focusById = function (elementId, elementRef) {
        var document = elementRef && elementRef.nativeElement.ownerDocument || window.document;
        if (document) {
            var element = document.getElementById(elementId);
            if (element.tagName !== 'INPUT') {
                var subElements = element.getElementsByTagName('input');
                if (subElements.length) {
                    var input = subElements[0];
                    if (input && typeof input.focus === 'function') {
                        input.focus();
                    }
                }
            }
            else {
                element.focus();
            }
        }
    };
    /**
     * 获取组件实例
     * @param frameContext
     * @returns
     */
    FocusInvalidService.prototype.getComponentRef = function (frameContext) {
        return this.frameContext && this.frameContext.injector.get(ElementRef, null) || null;
    };
    /**
     * 获取grid实例
     * @param frameContext frameContext
     * @returns
     */
    FocusInvalidService.prototype.getGridRef = function (frameContext) {
        var _this = this;
        var namespace = frameContext.namespace;
        var bindingPath = frameContext.viewModel.bindingPath;
        var frameContexts = this.frameContext.appContext.frameContextManager.getFrameContextsByNamespace(namespace) || [];
        var matchedFrameContexts = frameContexts.filter(function (frameContext) { return frameContext.viewModel && frameContext.viewModel.bindingPath.split('/').filter(function (p) { return p; }).toString() === bindingPath.split('/').filter(function (p) { return p; }).toString(); });
        var result = null;
        if (matchedFrameContexts) {
            matchedFrameContexts.every(function (frameContext) {
                var frameId = frameContext.frameId;
                var componentsMap = _this.frameContext.appContext.componentManager.getComponentsByFrameId(frameId);
                if (!componentsMap) {
                    return true;
                }
                var datagridComponent = Array.from(componentsMap.values()).find(function (component) { return component && component['__component_type__'] === 'DatagridComponent'; });
                if (datagridComponent) {
                    result = datagridComponent;
                    return false;
                }
                else {
                    return true;
                }
            });
        }
        return result;
    };
    FocusInvalidService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    FocusInvalidService.ctorParameters = function () { return [
        { type: Repository },
        { type: FrameContext },
        { type: FrameContextService },
        { type: FormControlService }
    ]; };
    return FocusInvalidService;
}());
export { FocusInvalidService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9jdXMtaW52YWxpZC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL2ZvY3VzLWludmFsaWQuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN2RCxPQUFPLEVBQUUsVUFBVSxFQUFFLFlBQVksRUFBaUIsTUFBTSxnQkFBZ0IsQ0FBQztBQUN6RSxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUM5RCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUU1RCxJQUFNLHdCQUF3QixHQUFHLElBQUksQ0FBQztBQUN0QyxJQUFNLHVCQUF1QixHQUFHLEtBQUssQ0FBQztBQUt0Qzs7O0dBR0c7QUFDSDtJQUVFOztPQUVHO0lBQ0gsNkJBQ1UsVUFBMkIsRUFDM0IsWUFBMEIsRUFDMUIsbUJBQXdDLEVBQ3hDLGtCQUFzQztRQUh0QyxlQUFVLEdBQVYsVUFBVSxDQUFpQjtRQUMzQixpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQix3QkFBbUIsR0FBbkIsbUJBQW1CLENBQXFCO1FBQ3hDLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBb0I7SUFFaEQsQ0FBQztJQUVEOztPQUVHO0lBQ0ksK0NBQWlCLEdBQXhCLFVBQXlCLGtCQUF5QixFQUFFLFdBQTRCO1FBQzlFLGtCQUFrQjtRQUNsQixJQUFJLENBQUMsa0JBQWtCLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxNQUFNLEVBQUU7WUFDckQsT0FBTztTQUNSO1FBQ0QsSUFBSSxXQUFXLEdBQUcsSUFBSSxDQUFDO1FBQ3ZCLElBQU0sc0JBQXNCLEdBQUcsSUFBSSxDQUFDLDRCQUE0QixDQUFDLGtCQUFrQixFQUFFLFdBQVcsQ0FBQyxDQUFDO1FBQ2xHLElBQUksc0JBQXNCLEVBQUU7WUFDMUIs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S0FBSSxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsZ0JBQWdCLENBQUMsc0JBQXNCLENBQUMsT0FBTyxDQUFDLENBQUM7Z0JBQ3BHLElBQUksQ0FBQyxhQUFhLEVBQUU7b0JBQ2xCLE9BQU8sSUFBSSxDQUFDO2lCQUNiO2dCQUNELElBQU0saUJBQWlCLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBQyxTQUFjLElBQUssT0FBQSxTQUFTLElBQUksU0FBUyxDQUFDLG9CQUFvQixDQUFDLEtBQUssbUJBQW1CLEVBQXBFLENBQW9FLENBQUMsQ0FBQztnQkFDNUosSUFBSSxpQkFBaUIsRUFBRTtvQkFDckIsTUFBTSxHQUFHLGlCQUFpQixDQUFDO29CQUMzQixPQUFPLEtBQUssQ0FBQztpQkFDZDtxQkFBTTtvQkFDTCxPQUFPLElBQUksQ0FBQztpQkFDYjtZQUNILENBQUMsQ0FBQyxDQUFDO1NBQ0o7UUFDRCxPQUFPLE1BQU0sQ0FBQztJQUNoQixDQUFDOztnQkFqVUYsVUFBVTs7OztnQkFkRixVQUFVO2dCQUFFLFlBQVk7Z0JBQ3hCLG1CQUFtQjtnQkFDbkIsa0JBQWtCOztJQThVM0IsMEJBQUM7Q0FBQSxBQWxVRCxJQWtVQztBQUVELE9BQU8sRUFBNkIsbUJBQW1CLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEVsZW1lbnRSZWYgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgUmVwb3NpdG9yeSwgRnJhbWVDb250ZXh0LCBOZ0Zvcm1Db250cm9sIH0gZnJvbSAnQGZhcnJpcy9kZXZraXQnO1xyXG5pbXBvcnQgeyBGcmFtZUNvbnRleHRTZXJ2aWNlIH0gZnJvbSAnLi9mcmFtZS1jb250ZXh0LnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBGb3JtQ29udHJvbFNlcnZpY2UgfSBmcm9tICcuL2Zvcm0tY29udHJvbC5zZXJ2aWNlJztcclxuXHJcbmNvbnN0IEZJWEVEX0NPTFVNTl9TVEFSVF9JTkRFWCA9IDUwMDA7XHJcbmNvbnN0IEdSSURfQ09MVU1OX1NUQVJUX0lOREVYID0gMTAwMDA7XHJcbmludGVyZmFjZSBGb2N1c2FibGVJbnZhbGlkYXRpb25HcmlkIHtcclxuICBlZGl0Q2VsbChyb3dJZDogYW55LCBmaWVsZDogc3RyaW5nKTogdm9pZDtcclxufVxyXG5cclxuLyoqXHJcbiAqIOihqOWNlemqjOivgeacjeWKoVxyXG4gKiBAc2NvcGUgRnJhbWVDb21wb25lbnRcclxuICovXHJcbkBJbmplY3RhYmxlKClcclxuY2xhc3MgRm9jdXNJbnZhbGlkU2VydmljZSB7XHJcbiAgLyoqXHJcbiAgICog5p6E6YCg5Ye95pWwXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIHJlcG9zaXRvcnk6IFJlcG9zaXRvcnk8YW55PixcclxuICAgIHByaXZhdGUgZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQsXHJcbiAgICBwcml2YXRlIGZyYW1lQ29udGV4dFNlcnZpY2U6IEZyYW1lQ29udGV4dFNlcnZpY2UsXHJcbiAgICBwcml2YXRlIGZvcm1Db250cm9sU2VydmljZTogRm9ybUNvbnRyb2xTZXJ2aWNlXHJcbiAgKSB7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDlkJHnrKzkuIDkuKrpqozor4HkuI3pgJrov4fnmoTlrZfmrrXorr7nva7nhKbngrlcclxuICAgKi9cclxuICBwdWJsaWMgZm9jdXNJbnZhbGlkSW5wdXQodmVyaWZ5SW5mb3JtYXRpb25zOiBhbnlbXSwgcm9vdEVsZW1lbnQ6IEVsZW1lbnRSZWY8YW55Pikge1xyXG4gICAgLy8g5peg6aqM6K+B5LiN6YCa6L+H5L+h5oGv5pe277yM55u05o6l6L+U5Zue44CCXHJcbiAgICBpZiAoIXZlcmlmeUluZm9ybWF0aW9ucyB8fCAhdmVyaWZ5SW5mb3JtYXRpb25zLmxlbmd0aCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBsZXQgdGFyZ2V0RmllbGQgPSBudWxsO1xyXG4gICAgY29uc3QgZmlyc3RWZXJpZnlJbmZvcm1hdGlvbiA9IHRoaXMuc2VsZWN0Rmlyc3RWZXJpZnlJbmZvcm1hdGlvbih2ZXJpZnlJbmZvcm1hdGlvbnMsIHJvb3RFbGVtZW50KTtcclxuICAgIGlmIChmaXJzdFZlcmlmeUluZm9ybWF0aW9uKSB7XHJcbiAgICAgIHRhcmdldEZpZWxkID0gZmlyc3RWZXJpZnlJbmZvcm1hdGlvbi50YXJnZXRGaWVsZDtcclxuICAgICAgaWYgKHRhcmdldEZpZWxkKSB7XHJcbiAgICAgICAgY29uc3QgY2FuRm9jdXMgPSB0aGlzLmZvY3VzRWxlbWVudCh0YXJnZXRGaWVsZCwgcm9vdEVsZW1lbnQpO1xyXG4gICAgICAgIGlmIChjYW5Gb2N1cykge1xyXG4gICAgICAgICAgdmVyaWZ5SW5mb3JtYXRpb25zWydmb2N1c2VkJ10gPSB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6K6+572uRGF0YUdyaWTljZXlhYPmoLznhKbngrlcclxuICAgKi9cclxuICBwdWJsaWMgZm9jdXNHcmlkQ2VsbCh2ZXJpZnlJbmZvcm1hdGlvbnM6IGFueVtdLCBmb2N1c2FibGVEYXRhR3JpZDogRm9jdXNhYmxlSW52YWxpZGF0aW9uR3JpZCkge1xyXG4gICAgaWYgKCF2ZXJpZnlJbmZvcm1hdGlvbnMgfHwgIXZlcmlmeUluZm9ybWF0aW9ucy5sZW5ndGggfHwgdmVyaWZ5SW5mb3JtYXRpb25zWydmb2N1c2VkJ10gPT0gdHJ1ZSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBsZXQgdGFyZ2V0RmllbGQgPSBudWxsO1xyXG4gICAgbGV0IHRhcmdldElkID0gbnVsbDtcclxuICAgIGNvbnN0IGZpcnN0VmVyaWZ5SW5mb3JtYXRpb24gPSB0aGlzLnNlbGVjdEZpcnN0VmVyaWZ5SW5mb3JtYXRpb24odmVyaWZ5SW5mb3JtYXRpb25zKTtcclxuICAgIGlmIChmaXJzdFZlcmlmeUluZm9ybWF0aW9uKSB7XHJcbiAgICAgIHRhcmdldEZpZWxkID0gZmlyc3RWZXJpZnlJbmZvcm1hdGlvbi50YXJnZXRGaWVsZDtcclxuICAgICAgdGFyZ2V0SWQgPSBmaXJzdFZlcmlmeUluZm9ybWF0aW9uLmlkO1xyXG4gICAgICB2ZXJpZnlJbmZvcm1hdGlvbnNbJ2ZvY3VzZWQnXSA9IHRydWU7XHJcbiAgICAgIGZvY3VzYWJsZURhdGFHcmlkLmVkaXRDZWxsKHRhcmdldElkLCB0YXJnZXRGaWVsZCk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIHByaXZhdGUgdXBkYXRlVmVyaWZ5SW5mb3JtYXRpb25zSW5kZXgodmVyaWZ5SW5mb3JtYXRpb25zOiBhbnlbXSwgcm9vdEVsZW1lbnQ/OiBFbGVtZW50UmVmPGFueT4pIHtcclxuICAgIHZlcmlmeUluZm9ybWF0aW9ucyA9IHZlcmlmeUluZm9ybWF0aW9ucy5maWx0ZXIoKHZlcmlmeUluZm9ybWF0aW9uOiBhbnkpID0+IHtcclxuICAgICAgY29uc3QgZnJhbWVDb250ZXh0cyA9IHRoaXMuZ2V0RnJhbWVDb250ZXh0c0J5UHJvcGVydHlQYXRoKHZlcmlmeUluZm9ybWF0aW9uLmZ1bGxQYXRoLCAnLycpO1xyXG4gICAgICBjb25zdCBmcmFtZUNvbnRleHQgPSBmcmFtZUNvbnRleHRzICYmIGZyYW1lQ29udGV4dHNbMF0gfHwgbnVsbDtcclxuICAgICAgcmV0dXJuIGZyYW1lQ29udGV4dCAmJiBmcmFtZUNvbnRleHQuZnJhbWVJZCA9PT0gdGhpcy5mcmFtZUNvbnRleHQuZnJhbWVJZDtcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIHZlcmlmeUluZm9ybWF0aW9ucy5tYXAoKHZlcmlmeUluZm9ybWF0aW9uOiBhbnkpID0+IHtcclxuICAgICAgbGV0IHRhYkluZGV4ID0gLTE7XHJcbiAgICAgIGlmICh2ZXJpZnlJbmZvcm1hdGlvbikge1xyXG4gICAgICAgIGlmIChyb290RWxlbWVudCAmJiB2ZXJpZnlJbmZvcm1hdGlvbi50YXJnZXRGaWVsZCkge1xyXG4gICAgICAgICAgY29uc3QgaW5wdXQgPSB0aGlzLmdldElucHV0RWxlbWVudEJ5SWQodmVyaWZ5SW5mb3JtYXRpb24udGFyZ2V0RmllbGQsIHJvb3RFbGVtZW50KTtcclxuICAgICAgICAgIHRhYkluZGV4ID0gaW5wdXQgJiYgaW5wdXQuZ2V0QXR0cmlidXRlKCd0YWJpbmRleCcpIHx8IC0xO1xyXG4gICAgICAgICAgdGFiSW5kZXggPSBOdW1iZXIodGFiSW5kZXgpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBmcmFtZUNvbnRleHRzID0gdGhpcy5nZXRGcmFtZUNvbnRleHRzQnlQcm9wZXJ0eVBhdGgodmVyaWZ5SW5mb3JtYXRpb24uZnVsbFBhdGgsICcvJyk7XHJcbiAgICAgICAgY29uc3QgZnJhbWVDb250ZXh0ID0gZnJhbWVDb250ZXh0cyAmJiBmcmFtZUNvbnRleHRzWzBdIHx8IG51bGw7XHJcbiAgICAgICAgY29uc3QgZnJhbWVJbmRleCA9IGZyYW1lQ29udGV4dC5pbmRleCArIDE7XHJcbiAgICAgICAgdmVyaWZ5SW5mb3JtYXRpb24udGFiSW5kZXggPSB0YWJJbmRleDtcclxuICAgICAgICB2ZXJpZnlJbmZvcm1hdGlvbi5kb21JbmRleCA9IC0xO1xyXG4gICAgICAgIHZlcmlmeUluZm9ybWF0aW9uLmZyYW1lSW5kZXggPSAtMTtcclxuICAgICAgICB2ZXJpZnlJbmZvcm1hdGlvbi5wb3NpdGlvbiA9IHRhYkluZGV4O1xyXG4gICAgICAgIGlmIChmcmFtZUNvbnRleHQpIHtcclxuICAgICAgICAgIGNvbnN0IGRvbUluZGV4ID0gdGhpcy5nZXRGaWVsZEluZGV4KGZyYW1lQ29udGV4dCwgdmVyaWZ5SW5mb3JtYXRpb24uZnVsbFBhdGgpIHx8IDA7XHJcbiAgICAgICAgICBpZiAoZG9tSW5kZXggPiAwKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHJvd0luZGV4ID0gdmVyaWZ5SW5mb3JtYXRpb24uaW5kZXggfHwgMDtcclxuICAgICAgICAgICAgdmVyaWZ5SW5mb3JtYXRpb24uZG9tSW5kZXggPSBkb21JbmRleDtcclxuICAgICAgICAgICAgdmVyaWZ5SW5mb3JtYXRpb24uZnJhbWVJbmRleCA9IGZyYW1lQ29udGV4dC5pbmRleDtcclxuICAgICAgICAgICAgdmVyaWZ5SW5mb3JtYXRpb24ucG9zaXRpb24gPSB0YWJJbmRleCA+IDAgPyB0YWJJbmRleCA6IChmcmFtZUluZGV4ICogMTAwMCArIHJvd0luZGV4ICogMTAwMCArIGRvbUluZGV4KTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIHZlcmlmeUluZm9ybWF0aW9uO1xyXG4gICAgfSk7XHJcbiAgfVxyXG4gIHByaXZhdGUgaXNHcmlkQ29tcG9uZW50KGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0KSB7XHJcbiAgICBpZiAoZnJhbWVDb250ZXh0KSB7XHJcbiAgICAgIGNvbnN0IGRhdGFHcmlkQ29sdW1uc05hbWUgPSBmcmFtZUNvbnRleHQudmlld01vZGVsWydkYXRhR3JpZENvbHVtbnNOYW1lJ10gfHwgbnVsbDtcclxuICAgICAgcmV0dXJuIGRhdGFHcmlkQ29sdW1uc05hbWUgPyB0cnVlIDogZmFsc2U7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG4gIH1cclxuICBwcml2YXRlIGdldENvbHVtbkluZGV4KGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0LCBiaW5kaW5nOiBzdHJpbmcpIHtcclxuICAgIGJpbmRpbmcgPSBiaW5kaW5nLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCkuam9pbignLycpO1xyXG4gICAgY29uc3QgYmluZGluZ1BhdGhzID0gZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5iaW5kaW5nUGF0aC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApO1xyXG4gICAgY29uc3QgZGF0YUdyaWRDb2x1bW5zTmFtZSA9IGZyYW1lQ29udGV4dC52aWV3TW9kZWxbJ2RhdGFHcmlkQ29sdW1uc05hbWUnXSB8fCBudWxsO1xyXG4gICAgY29uc3QgZnJhbWVJbmRleCA9IGZyYW1lQ29udGV4dC5pbmRleCArIDE7XHJcbiAgICBpZiAoIWRhdGFHcmlkQ29sdW1uc05hbWUpIHtcclxuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcclxuICAgIH1cclxuICAgIGxldCBjb2x1bW5zOiBhbnlbXSA9IGZyYW1lQ29udGV4dC52aWV3TW9kZWxbZGF0YUdyaWRDb2x1bW5zTmFtZV07XHJcbiAgICBpZiAoIWNvbHVtbnMgfHwgY29sdW1ucy5sZW5ndGggPCAxKSB7XHJcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgICB9XHJcbiAgICAvLyDmiZPlubNjb2x1bW5zXHJcbiAgICBjb2x1bW5zID0gY29sdW1ucy5yZWR1Y2UoKHJlc3VsdHM6IGFueVtdLCBpdGVtKSA9PiB7XHJcbiAgICAgIGlmIChBcnJheS5pc0FycmF5KGl0ZW0pKSB7XHJcbiAgICAgICAgcmV0dXJuIHJlc3VsdHMuY29uY2F0KGl0ZW0pO1xyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiByZXN1bHRzLmNvbmNhdChbaXRlbV0pO1xyXG4gICAgfSwgW10pO1xyXG4gICAgbGV0IHBvc2l0aW9uID0gLTE7XHJcbiAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgY29sdW1ucy5sZW5ndGg7IGluZGV4KyspIHtcclxuICAgICAgY29uc3QgY29sdW1uOiBhbnkgfCBhbnlbXSA9IGNvbHVtbnNbaW5kZXhdO1xyXG4gICAgICBjb25zdCBmaWVsZHMgPSBjb2x1bW4gJiYgY29sdW1uLmZpZWxkICYmIGNvbHVtbi5maWVsZC5zcGxpdCgnLicpLmZpbHRlcihwID0+IHApIHx8IG51bGw7XHJcbiAgICAgIGlmICghZmllbGRzKSB7XHJcbiAgICAgICAgY29udGludWU7XHJcbiAgICAgIH1cclxuICAgICAgaWYgKGJpbmRpbmdQYXRocy5jb25jYXQoZmllbGRzKS5qb2luKCcvJykgPT09IGJpbmRpbmcpIHtcclxuICAgICAgICBjb25zdCBmaXhlZCA9IGNvbHVtbi5maXhlZDtcclxuICAgICAgICBpZiAoZml4ZWQpIHtcclxuICAgICAgICAgIGNvbnN0IGZpeGVkQ29sdW1ucyA9IGNvbHVtbnMuZmlsdGVyKGl0ZW0gPT4gaXRlbS5maXhlZCA9PT0gZml4ZWQpO1xyXG4gICAgICAgICAgY29uc3QgZml4ZWRDb2x1bW5JbmRleCA9IHRoaXMuZ2V0SW5kZXhGcm9tQ29sdW1ucyhmaXhlZENvbHVtbnMsIGJpbmRpbmcpO1xyXG4gICAgICAgICAgaWYgKGZpeGVkID09PSAnbGVmdCcpIHtcclxuICAgICAgICAgICAgcG9zaXRpb24gPSBmcmFtZUluZGV4ICogRklYRURfQ09MVU1OX1NUQVJUX0lOREVYICsgZml4ZWRDb2x1bW5JbmRleDtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHBvc2l0aW9uID0gZnJhbWVJbmRleCAqIEdSSURfQ09MVU1OX1NUQVJUX0lOREVYICsgMTAwMCArIGZpeGVkQ29sdW1uSW5kZXg7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHBvc2l0aW9uID0gZnJhbWVJbmRleCAqIEdSSURfQ09MVU1OX1NUQVJUX0lOREVYICsgaW5kZXg7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGJyZWFrO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcG9zaXRpb247XHJcbiAgfVxyXG4gIHByaXZhdGUgZ2V0SW5kZXhGcm9tQ29sdW1ucyhjb2x1bW5zOiBhbnlbXSwgYmluZGluZzogc3RyaW5nKSB7XHJcbiAgICBjb25zdCBiaW5kaW5nUGF0aHMgPSB0aGlzLmZyYW1lQ29udGV4dC52aWV3TW9kZWwuYmluZGluZ1BhdGguc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKTtcclxuICAgIHJldHVybiBjb2x1bW5zLmZpbmRJbmRleChjb2x1bW4gPT4ge1xyXG4gICAgICBjb25zdCBmaWVsZHMgPSBjb2x1bW4gJiYgY29sdW1uLmZpZWxkICYmIGNvbHVtbi5maWVsZC5zcGxpdCgnLicpLmZpbHRlcihwID0+IHApIHx8IG51bGw7XHJcbiAgICAgIGlmICghZmllbGRzKSB7XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICB9XHJcbiAgICAgIGlmIChiaW5kaW5nUGF0aHMuY29uY2F0KGZpZWxkcykuam9pbignLycpID09PSBiaW5kaW5nKSB7XHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfSk7XHJcbiAgfVxyXG4gIHByaXZhdGUgc2VsZWN0Rmlyc3RWZXJpZnlJbmZvcm1hdGlvbih2ZXJpZnlJbmZvcm1hdGlvbnM6IGFueVtdLCByb290RWxlbWVudD86IEVsZW1lbnRSZWY8YW55Pikge1xyXG4gICAgdmVyaWZ5SW5mb3JtYXRpb25zID0gdGhpcy51cGRhdGVWZXJpZnlJbmZvcm1hdGlvbnNJbmRleCh2ZXJpZnlJbmZvcm1hdGlvbnMsIHJvb3RFbGVtZW50KTtcclxuICAgIHZlcmlmeUluZm9ybWF0aW9ucy5zb3J0KCh2MTogYW55LCB2MjogYW55KSA9PiBOdW1iZXIodjEucG9zaXRpb24pIC0gTnVtYmVyKHYyLnBvc2l0aW9uKSk7XHJcbiAgICByZXR1cm4gdmVyaWZ5SW5mb3JtYXRpb25zICYmIHZlcmlmeUluZm9ybWF0aW9ucy5sZW5ndGggPiAwICYmIHZlcmlmeUluZm9ybWF0aW9uc1swXSB8fCBudWxsO1xyXG4gIH1cclxuICBwcml2YXRlIGdldElucHV0RWxlbWVudEJ5SWQodGFyZ2V0RmllbGQ6IHN0cmluZywgcm9vdEVsZW1lbnQ6IEVsZW1lbnRSZWY8YW55Pikge1xyXG4gICAgbGV0IGVsZW1lbnQgPSByb290RWxlbWVudC5uYXRpdmVFbGVtZW50Lm93bmVyRG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQodGFyZ2V0RmllbGQpIHx8IG51bGw7XHJcbiAgICBpZiAoZWxlbWVudCAmJiBlbGVtZW50LnRhZ05hbWUgIT09ICdJTlBVVCcpIHtcclxuICAgICAgY29uc3QgaW5wdXRzID0gZWxlbWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnaW5wdXQnKTtcclxuICAgICAgaWYgKGlucHV0cy5sZW5ndGgpIHtcclxuICAgICAgICBlbGVtZW50ID0gaW5wdXRzWzBdO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gZWxlbWVudDtcclxuICB9XHJcbiAgcHVibGljIGdldEZyYW1lQ29udGV4dHNCeVByb3BlcnR5UGF0aChwcm9wZXJ0eVBhdGg6IHN0cmluZywgc2VwYXJ0b3I6IHN0cmluZyA9ICcvJyk6IEZyYW1lQ29udGV4dFtdIHtcclxuICAgIGlmICghcHJvcGVydHlQYXRoKSB7XHJcbiAgICAgIHJldHVybiBbXTtcclxuICAgIH1cclxuICAgIGNvbnN0IGZyYW1lQ29udGV4dHMgPSB0aGlzLmZyYW1lQ29udGV4dCAmJiB0aGlzLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0LmZyYW1lQ29udGV4dE1hbmFnZXIuZ2V0RnJhbWVDb250ZXh0cygpIHx8IFtdO1xyXG4gICAgcmV0dXJuIGZyYW1lQ29udGV4dHMuZmlsdGVyKChmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCkgPT4ge1xyXG4gICAgICBjb25zdCBmb3JtQ29udHJvbHMgPSBmcmFtZUNvbnRleHQgJiYgZnJhbWVDb250ZXh0LmZvcm0gJiYgZnJhbWVDb250ZXh0LmZvcm0ubmdGb3JtQ29udHJvbHMgfHwge307XHJcbiAgICAgIGNvbnN0IGJpbmRpbmdQYXRoID0gZnJhbWVDb250ZXh0ICYmIGZyYW1lQ29udGV4dC52aWV3TW9kZWwgJiYgZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5iaW5kaW5nUGF0aCB8fCAnJztcclxuICAgICAgaWYgKGZvcm1Db250cm9scyAmJiBPYmplY3Qua2V5cyhmb3JtQ29udHJvbHMpLmxlbmd0aCA+IDApIHtcclxuICAgICAgICBjb25zdCBrZXkgPSBPYmplY3Qua2V5cyhmb3JtQ29udHJvbHMpLmZpbmQoKGtleTogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgICBjb25zdCBmb3JtQ29udHJvbCA9IGZvcm1Db250cm9sc1trZXldO1xyXG4gICAgICAgICAgaWYgKCFmb3JtQ29udHJvbCB8fCAhZm9ybUNvbnRyb2wuYmluZGluZykge1xyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBjb25zdCBiaW5kaW5ncyA9IGZvcm1Db250cm9sLmJpbmRpbmcuc3BsaXQoJy4nKS5maWx0ZXIocCA9PiBwKTtcclxuICAgICAgICAgIGNvbnN0IGJpbmRpbmdQYXRocyA9IGJpbmRpbmdQYXRoLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCk7XHJcbiAgICAgICAgICBjb25zdCBmdWxsUGF0aCA9IGJpbmRpbmdQYXRocy5jb25jYXQoYmluZGluZ3MpO1xyXG4gICAgICAgICAgcmV0dXJuIHByb3BlcnR5UGF0aC5zcGxpdChzZXBhcnRvcikuZmlsdGVyKHAgPT4gcCkuam9pbignLycpID09PSBmdWxsUGF0aC5qb2luKCcvJyk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcmV0dXJuIGtleSA/IHRydWUgOiBmYWxzZTtcclxuICAgICAgfVxyXG4gICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9KTtcclxuICB9XHJcbiAgcHVibGljIGdldEZvcm1Db250cm9sSW5kZXhCeUJpbmRpbmdQYXRoKGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0LCBiaW5kaW5nOiBzdHJpbmcpOiBudW1iZXIge1xyXG4gICAgY29uc3QgbmdGb3JtQ29udHJvbHMgPSB0aGlzLmdldEZvcm1Db250cm9sc0J5RnJhbWVDb250ZXh0KGZyYW1lQ29udGV4dCk7XHJcbiAgICBpZiAoIW5nRm9ybUNvbnRyb2xzKSB7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gICAgY29uc3QgYmluZGluZ3MgPSBiaW5kaW5nLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCk7XHJcbiAgICByZXR1cm4gT2JqZWN0LnZhbHVlcyhuZ0Zvcm1Db250cm9scykuZmluZEluZGV4KChuZ0Zvcm1Db250cm9sOiBOZ0Zvcm1Db250cm9sKSA9PiB7XHJcbiAgICAgIGlmICghbmdGb3JtQ29udHJvbCkge1xyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgfVxyXG4gICAgICBjb25zdCBiaW5kaW5nUGF0aCA9IGZyYW1lQ29udGV4dC52aWV3TW9kZWwuYmluZGluZ1BhdGg7XHJcbiAgICAgIGNvbnN0IGJpbmRpbmdQYXRocyA9IGJpbmRpbmdQYXRoLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCk7XHJcbiAgICAgIGNvbnN0IGZvcm1Db250cm9sQmluZGluZ1BhdGhzID0gbmdGb3JtQ29udHJvbC5iaW5kaW5nLnNwbGl0KCcuJykuZmlsdGVyKHAgPT4gcCk7XHJcbiAgICAgIGNvbnN0IGZ1bGxQYXRoID0gYmluZGluZ1BhdGhzLmNvbmNhdChmb3JtQ29udHJvbEJpbmRpbmdQYXRocyk7XHJcbiAgICAgIHJldHVybiBmdWxsUGF0aC5qb2luKCcvJykgPT09IGJpbmRpbmdzLmpvaW4oJy8nKTtcclxuICAgIH0pO1xyXG4gIH1cclxuICBwdWJsaWMgZ2V0RmllbGRJbmRleChmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCwgYmluZGluZzogc3RyaW5nKSB7XHJcbiAgICBjb25zdCBpc0dyaWRDb21wb25lbnQgPSB0aGlzLmlzR3JpZENvbXBvbmVudChmcmFtZUNvbnRleHQpO1xyXG4gICAgaWYgKGlzR3JpZENvbXBvbmVudCkge1xyXG4gICAgICByZXR1cm4gdGhpcy5nZXRDb2x1bW5JbmRleChmcmFtZUNvbnRleHQsIGJpbmRpbmcpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuIHRoaXMuZ2V0Rm9ybUNvbnRyb2xJbmRleEJ5QmluZGluZ1BhdGgoZnJhbWVDb250ZXh0LCBiaW5kaW5nKTtcclxuICAgIH1cclxuICB9XHJcbiAgcHVibGljIGdldEZvcm1Db250cm9sc0J5RnJhbWVDb250ZXh0KGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0KTogeyBbcHJvcGVydHlOYW1lOiBzdHJpbmddOiBOZ0Zvcm1Db250cm9sIH0gfCBudWxsIHtcclxuICAgIHJldHVybiBmcmFtZUNvbnRleHQgJiYgZnJhbWVDb250ZXh0LmZvcm0gJiYgZnJhbWVDb250ZXh0LmZvcm0ubmdGb3JtQ29udHJvbHMgfHwgbnVsbDtcclxuICB9XHJcbiAgcHVibGljIGZvY3VzRWxlbWVudChlbGVtZW50SWQ6IHN0cmluZywgcm9vdEVsZW1lbnQ6IEVsZW1lbnRSZWY8YW55Pik6IGJvb2xlYW4ge1xyXG4gICAgbGV0IGZvY3VzZWQgPSBmYWxzZTtcclxuICAgIGxldCBlbGVtZW50VG9Gb2N1cyA9IHJvb3RFbGVtZW50Lm5hdGl2ZUVsZW1lbnQub3duZXJEb2N1bWVudC5nZXRFbGVtZW50QnlJZChlbGVtZW50SWQpO1xyXG4gICAgLy8g5pyq6I635Y+W5Yiw5oyH5a6a5a2X5q615pe277yM6L+U5Zue77yM5LiN5YaN6K6+572u54Sm54K544CCXHJcbiAgICBpZiAoZWxlbWVudFRvRm9jdXMpIHtcclxuICAgICAgLy8g5aaC5p6c5pyJ5aSa5LiqaWTph43lpI3nmoTlhYPntKDvvIzliJnkuI3lrprkvY1cclxuICAgICAgY29uc3QgZWxlbWVudHMgPSByb290RWxlbWVudC5uYXRpdmVFbGVtZW50Lm93bmVyRG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChgIyR7ZWxlbWVudElkfWApO1xyXG4gICAgICBpZiAoZWxlbWVudHMgJiYgZWxlbWVudHMubGVuZ3RoID4gMSkge1xyXG4gICAgICAgIHJldHVybiBmb2N1c2VkO1xyXG4gICAgICB9XHJcbiAgICAgIC8vIOWmguaenOe7keWumuebruagh+Wtl+auteeahOaOp+S7tuS4jeaYr0lucHV05YWD57Sg77yM5YiZ5p+l5om+5YW25LiL57qn6IqC54K544CCXHJcbiAgICAgIGlmIChlbGVtZW50VG9Gb2N1cy50YWdOYW1lICE9PSAnSU5QVVQnKSB7XHJcbiAgICAgICAgY29uc3Qgc3ViRWxlbWVudHMgPSBlbGVtZW50VG9Gb2N1cy5nZXRFbGVtZW50c0J5VGFnTmFtZSgnaW5wdXQnKTtcclxuICAgICAgICBpZiAoc3ViRWxlbWVudHMubGVuZ3RoKSB7XHJcbiAgICAgICAgICBlbGVtZW50VG9Gb2N1cyA9IHN1YkVsZW1lbnRzWzBdO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgICBlbGVtZW50VG9Gb2N1cy5mb2N1cygpO1xyXG4gICAgICBmb2N1c2VkID0gdHJ1ZTtcclxuICAgIH1cclxuICAgIHJldHVybiBmb2N1c2VkO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDorr7nva7nhKbngrlcclxuICAgKiBAcGFyYW0gdmVyaWZ5SW5mb3JtYXRpb24g6ZSZ6K+v5L+h5oGvXHJcbiAgICogQHBhcmFtIGZyYW1lQ29udGV4dCDkuIrkuIvmlodcclxuICAgKiBAcmV0dXJucyBcclxuICAgKi9cclxuICBwdWJsaWMgZm9jdXModmVyaWZ5SW5mb3JtYXRpb246IGFueSwgZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQpIHtcclxuICAgIGlmICghdmVyaWZ5SW5mb3JtYXRpb24pIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgY29uc3QgaXNHcmlkVmFsaWRhdGlvbiA9IHZlcmlmeUluZm9ybWF0aW9uLmluZGV4ICE9PSBudWxsO1xyXG4gICAgaWYgKGlzR3JpZFZhbGlkYXRpb24pIHtcclxuICAgICAgY29uc3QgZ3JpZCA9IHRoaXMuZ2V0R3JpZFJlZihmcmFtZUNvbnRleHQpO1xyXG4gICAgICBpZiAoZ3JpZCkge1xyXG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgZ3JpZC5lZGl0Q2VsbCh2ZXJpZnlJbmZvcm1hdGlvbi5pZCwgdmVyaWZ5SW5mb3JtYXRpb24udGFyZ2V0RmllbGQpO1xyXG4gICAgICAgIH0sIDApO1xyXG4gICAgICB9XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBjb25zdCBmcmFtZUVsZW1lbnQgPSB0aGlzLmdldENvbXBvbmVudFJlZihmcmFtZUNvbnRleHQpO1xyXG4gICAgICBjb25zdCBlbGVtZW50SWQgPSB2ZXJpZnlJbmZvcm1hdGlvbi50YXJnZXRGaWVsZDtcclxuICAgICAgdGhpcy5mb2N1c0J5SWQoZWxlbWVudElkLCBmcmFtZUVsZW1lbnQpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6YCa6L+H5o6n5Lu2aWTorr7nva7nhKbngrlcclxuICAgKiBAcGFyYW0gZWxlbWVudElkIFxyXG4gICAqIEBwYXJhbSBlbGVtZW50UmVmIFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZm9jdXNCeUlkKGVsZW1lbnRJZDogc3RyaW5nLCBlbGVtZW50UmVmPzogRWxlbWVudFJlZikge1xyXG4gICAgY29uc3QgZG9jdW1lbnQ6IGFueSA9IGVsZW1lbnRSZWYgJiYgZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50Lm93bmVyRG9jdW1lbnQgfHwgd2luZG93LmRvY3VtZW50O1xyXG4gICAgaWYgKGRvY3VtZW50KSB7XHJcbiAgICAgIGNvbnN0IGVsZW1lbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChlbGVtZW50SWQpO1xyXG4gICAgICBpZiAoZWxlbWVudC50YWdOYW1lICE9PSAnSU5QVVQnKSB7XHJcbiAgICAgICAgY29uc3Qgc3ViRWxlbWVudHMgPSBlbGVtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdpbnB1dCcpO1xyXG4gICAgICAgIGlmIChzdWJFbGVtZW50cy5sZW5ndGgpIHtcclxuICAgICAgICAgIGNvbnN0IGlucHV0ID0gc3ViRWxlbWVudHNbMF07XHJcbiAgICAgICAgICBpZiAoaW5wdXQgJiYgdHlwZW9mIGlucHV0LmZvY3VzID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgICAgICAgIGlucHV0LmZvY3VzKCk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGVsZW1lbnQuZm9jdXMoKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuICAvKipcclxuICAgKiDojrflj5bnu4Tku7blrp7kvotcclxuICAgKiBAcGFyYW0gZnJhbWVDb250ZXh0IFxyXG4gICAqIEByZXR1cm5zIFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0Q29tcG9uZW50UmVmKGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0KSB7XHJcbiAgICByZXR1cm4gdGhpcy5mcmFtZUNvbnRleHQgJiYgdGhpcy5mcmFtZUNvbnRleHQuaW5qZWN0b3IuZ2V0PEVsZW1lbnRSZWY+KEVsZW1lbnRSZWYsIG51bGwpIHx8IG51bGw7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiOt+WPlmdyaWTlrp7kvotcclxuICAgKiBAcGFyYW0gZnJhbWVDb250ZXh0IGZyYW1lQ29udGV4dFxyXG4gICAqIEByZXR1cm5zIFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0R3JpZFJlZihmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCk6IEZvY3VzYWJsZUludmFsaWRhdGlvbkdyaWQge1xyXG4gICAgY29uc3QgbmFtZXNwYWNlID0gZnJhbWVDb250ZXh0Lm5hbWVzcGFjZTtcclxuICAgIGNvbnN0IGJpbmRpbmdQYXRoID0gZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5iaW5kaW5nUGF0aDtcclxuICAgIGNvbnN0IGZyYW1lQ29udGV4dHM6IEZyYW1lQ29udGV4dFtdID0gdGhpcy5mcmFtZUNvbnRleHQuYXBwQ29udGV4dC5mcmFtZUNvbnRleHRNYW5hZ2VyLmdldEZyYW1lQ29udGV4dHNCeU5hbWVzcGFjZShuYW1lc3BhY2UpIHx8IFtdO1xyXG4gICAgY29uc3QgbWF0Y2hlZEZyYW1lQ29udGV4dHMgPSBmcmFtZUNvbnRleHRzLmZpbHRlcigoZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQpID0+IGZyYW1lQ29udGV4dC52aWV3TW9kZWwgJiYgZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5iaW5kaW5nUGF0aC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApLnRvU3RyaW5nKCkgPT09IGJpbmRpbmdQYXRoLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCkudG9TdHJpbmcoKSk7XHJcbiAgICBsZXQgcmVzdWx0ID0gbnVsbDtcclxuICAgIGlmIChtYXRjaGVkRnJhbWVDb250ZXh0cykge1xyXG4gICAgICBtYXRjaGVkRnJhbWVDb250ZXh0cy5ldmVyeSgoZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQpID0+IHtcclxuICAgICAgICBjb25zdCBmcmFtZUlkID0gZnJhbWVDb250ZXh0LmZyYW1lSWQ7XHJcbiAgICAgICAgY29uc3QgY29tcG9uZW50c01hcCA9IHRoaXMuZnJhbWVDb250ZXh0LmFwcENvbnRleHQuY29tcG9uZW50TWFuYWdlci5nZXRDb21wb25lbnRzQnlGcmFtZUlkKGZyYW1lSWQpO1xyXG4gICAgICAgIGlmICghY29tcG9uZW50c01hcCkge1xyXG4gICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IGRhdGFncmlkQ29tcG9uZW50ID0gQXJyYXkuZnJvbShjb21wb25lbnRzTWFwLnZhbHVlcygpKS5maW5kKChjb21wb25lbnQ6IGFueSkgPT4gY29tcG9uZW50ICYmIGNvbXBvbmVudFsnX19jb21wb25lbnRfdHlwZV9fJ10gPT09ICdEYXRhZ3JpZENvbXBvbmVudCcpO1xyXG4gICAgICAgIGlmIChkYXRhZ3JpZENvbXBvbmVudCkge1xyXG4gICAgICAgICAgcmVzdWx0ID0gZGF0YWdyaWRDb21wb25lbnQ7XHJcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcmVzdWx0O1xyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IHsgRm9jdXNhYmxlSW52YWxpZGF0aW9uR3JpZCwgRm9jdXNJbnZhbGlkU2VydmljZSB9O1xyXG4iXX0=