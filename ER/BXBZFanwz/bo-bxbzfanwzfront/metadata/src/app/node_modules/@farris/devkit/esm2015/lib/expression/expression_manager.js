import { Inject, Injectable, Injector } from "@angular/core";
import { BigNumber } from 'bignumber.js';
import { EMPTY, of } from "rxjs";
import { FrameContext } from "../frame/index";
import { Repository } from "../repository/index";
import { ENTITY_TEMPLATE, ResolveService } from "../resolver/index";
import { ExpressionUtil } from "../utils/expression_util";
import { ExpressionExecutor } from "./expression_executor";
import { ExpressionRegistry } from "./expression_registry";
import { Expression } from './types';
import { ExpressionResult } from "./expression_result";
import { MESSAGE_SERVICE_TOKEN, NOTIFY_SERVICE_TOKEN } from "../core/index";
import { TranslateToken } from "../i18n";
export class ExpressionManager {
    constructor(injector, resolveService, expressionExecutor, expressionRegistry, expressionResult, messageService, notifyService) {
        this.injector = injector;
        this.resolveService = resolveService;
        this.expressionExecutor = expressionExecutor;
        this.expressionRegistry = expressionRegistry;
        this.expressionResult = expressionResult;
        this.messageService = messageService;
        this.notifyService = notifyService;
        this.frameContext = null;
        this.frameContext = this.injector.get(FrameContext, null);
    }
    /**
     * 根据表达式id进行计算
     * @param expressionId 表达式id
     * @param viewModel viewModel
     * @param rowData rowData
     * @returns
     */
    eval(expressionId, viewModel, rowData) {
        const expressionObject = this.expressionRegistry.getExpressionById(expressionId);
        if (expressionObject) {
            const customContext = {};
            const bindingPath = viewModel && viewModel.bindingPath || null;
            if (bindingPath && rowData) {
                const bindingPaths = bindingPath.split('/').filter(p => p);
                const bindingList = this.frameContext.bindingData.getValue(bindingPaths);
                let primaryKey = 'id';
                if (bindingList) {
                    primaryKey = bindingList.primaryKey;
                }
                const primaryValue = rowData[primaryKey] || bindingList.currentId;
                if (primaryValue) {
                    customContext.currentRows = [{ bindingPath: bindingPaths.join('/'), primaryValue }];
                }
            }
            let result = this.execute(expressionObject.expression, customContext);
            if (expressionObject.type === Expression.ExpressionType.Readonly || expressionObject.type === Expression.ExpressionType.Required || expressionObject.type === Expression.ExpressionType.Visible) {
                result = result === true ? true : false;
            }
            this.expressionResult.set(expressionId, result);
            return result;
        }
        else {
            // console.warn('ExpressionManager 执行失败，未获取到表达式!');
        }
        return undefined;
    }
    validate(expressionId, options) {
        const expressionObject = this.expressionRegistry.getExpressionById(expressionId);
        if (expressionObject) {
            const patch = options && options.patch || null;
            const customContext = {};
            if (patch) {
                customContext.patch = patch;
            }
            const currentRow = options.currentRow || null;
            const currentRows = options.currentRows || [];
            if (currentRow) {
                customContext.currentRows = customContext.currentRows || [];
                customContext.currentRows.push(currentRow);
            }
            if (currentRows && currentRows.length > 0) {
                customContext.currentRows = customContext.currentRows || [];
                Array.prototype.push.apply(customContext.currentRows, currentRows);
            }
            const result = this.execute(expressionObject.expression, customContext);
            this.expressionResult.set(expressionId, result);
            return result;
        }
        else {
            console.warn('ExpressionManager 执行失败，未获取到表达式!');
        }
        return undefined;
    }
    /**
     * 帮助前封装
     * @param event
     */
    onDataPicking(configs) {
        const expressionId = configs && configs.expressionId || null;
        if (!expressionId) {
            console.warn(`ExpressionManager 相关表达式设置错误，没有表达式编号。`);
            return of(true);
        }
        const result = this.eval(expressionId);
        if (!result) {
            const expressionObject = this.expressionRegistry.getExpressionById(expressionId);
            if (!expressionObject) {
                console.warn(`ExpressionManager 无法找到对应的表达式${expressionId}`);
                return of(true);
            }
            const messageType = expressionObject.messageType || Expression.MessageType.warning;
            const message = expressionObject.message;
            if (message) {
                this.notifyService[messageType](message, { hideTitle: true });
            }
            return EMPTY;
        }
        return of(result);
    }
    /**
     * 执行表达式计算
     * @param expression 表达式
     * @param customContext 自定义上下文
     * @returns
     */
    execute(expression, customContext) {
        const deps = this.resolveService.resolve(expression);
        const groupDependencies = ExpressionUtil.getGroupFunctionDependency(expression, this.frameContext.repository.entityTypeInfo);
        const entityContext = this.buildEntityContext(deps, groupDependencies, customContext);
        const stateContext = this.buildStateContext();
        const data = customContext && customContext.contexts || null;
        const translate = this.injector.get(TranslateToken, null);
        const context = Object.assign({ [this.entityOriginalNodeCode]: entityContext }, stateContext, { BigNumber, frameContext: this.frameContext, bindingData: this.frameContext.bindingData, repository: this.frameContext.repository, CurrentLanguage: translate.getCurrentLanguage() || 'zh-CHS' }, data);
        if (!entityContext) {
            return undefined;
        }
        return this.expressionExecutor.eval(expression, context);
    }
    /**
     * 执行表达式（返回可观察对象）
     * @param expression 表达式
     * @param customContext 自定义上下文
     * @returns
     */
    executeAsync(expression, customContext) {
        const result = this.execute(expression, customContext);
        return of(result);
    }
    /**
     * 构造实体上下文
     * @param deps
     * @param groupDependencies
     * @param context
     * @returns
     */
    buildEntityContext(deps, groupDependencies, context) {
        const currentRows = context && context.currentRows || null;
        const index = deps.findIndex((dep) => {
            const isEntityDependency = this.isEntityDependency(dep);
            // 如果依赖的是state，无需处理，现在需要确定的是返回多少实体的问题，和state没有关系
            // 表达式依赖了实体
            if (isEntityDependency) {
                const isGroupDependency = groupDependencies.findIndex(item => item === dep) !== -1;
                // 是聚合依赖
                if (isGroupDependency) {
                    const dependencyLength = dep.split('/').filter(p => p).length - 1;
                    if (dependencyLength === 1) {
                        // 聚合了主表字段，所有主表数据都需要参与运算，此时已经确定计算的实体上下文了。
                        return true;
                    }
                    else {
                        // 聚合了子表字段，只需要传递当前实体
                        return false;
                    }
                }
                else {
                    // 当前依赖不是聚合，只需要传递当前实体
                    return false;
                }
            }
            return false;
        });
        const isGroupdMainEntity = index !== -1;
        const options = {};
        if (currentRows && currentRows.length > 0) {
            currentRows.forEach((currentRow) => {
                options[currentRow.bindingPath || '/'] = currentRow.primaryValue;
            });
        }
        const entity = this.getEntity(options);
        const patch = context && context.patch || null;
        if (!entity) {
            return null;
        }
        if (patch && Object.keys(patch).length > 0) {
            Object.keys(patch).forEach((key) => {
                const paths = key.split('/').filter(p => p);
                const value = patch[key];
                this.setValue(entity, paths, value);
            });
        }
        if (isGroupdMainEntity) {
            const collection = this.frameContext.repository.entityCollection.toJSON();
            entity['__type__'] = 'List';
            entity['__items__'] = collection;
        }
        return entity;
    }
    setValue(target, paths, value) {
        if (paths.length === 1) {
            target[paths[0]] = value;
        }
        else {
            const propertyName = paths.pop();
            const result = paths.reduce((object, path) => {
                return object && object[path];
            }, target);
            result[propertyName] = value;
        }
    }
    /**
     * 是否为实体依赖
     * @param dep
     * @returns
     */
    isEntityDependency(dep) {
        return dep.startsWith(ENTITY_TEMPLATE);
    }
    /**
     * 获取实体
     * @param options
     * @returns
     */
    getEntity(options) {
        const entityTypeInfo = this.frameContext.repository.entityTypeInfo;
        const bindingData = this.frameContext.bindingData;
        const childrenEntityPaths = [];
        let entity = null;
        if (options['/']) {
            // 修正主表
            entity = this.frameContext.bindingData.list.findById(options['/']);
            if (entity) {
                entity = entity.toJSON();
            }
        }
        else {
            entity = this.frameContext.bindingData.list.currentItem.toJSON();
        }
        if (!entity) {
            return null;
        }
        ExpressionUtil.getChildrenEntityPaths(entityTypeInfo, childrenEntityPaths);
        entity['__type__'] = 'Entity';
        if (!childrenEntityPaths || childrenEntityPaths.length < 1) {
            return entity;
        }
        // 找到所有子表
        childrenEntityPaths.forEach((paths) => {
            let row = null;
            if (options && options[paths.join('/')]) {
                const parentPaths = paths.slice(0, 1);
                if (paths.length == 2 && options[parentPaths.join('/')]) {
                    const parentRow = options[parentPaths.join('/')];
                    // 从从表
                    // 需要切换上级表
                    row = this.getPropertyValue(entity, parentPaths.concat([parentRow, paths[1], options[paths.join('/')]]));
                }
                else {
                    // 不应该使用bindingData，这样就默认使用了当前行
                    const bindingList = bindingData.getValue(paths);
                    const currentRowId = options[paths.join('/')];
                    let currentRow = null;
                    if (currentRowId !== bindingList.currentId) {
                        currentRow = bindingList.findById(currentRowId);
                    }
                    else {
                        currentRow = bindingList.currentItem;
                    }
                    if (currentRow && currentRow.primaryKeyValue) {
                        row = currentRow.toJSON();
                    }
                }
            }
            else {
                // 如果上级表已经切换了当前行，那么下级表也应该切换
                const parentTableCurrentRowChanged = options && !!Object.keys(options).find(path => {
                    const fullPath = path.split('/').join('/');
                    return paths.join('/').startsWith(fullPath);
                }) || false;
                if (parentTableCurrentRowChanged) {
                    const primaryValue = options && options['/'] || bindingData.list.currentId;
                    const entity = this.frameContext.repository.entityCollection.getEntityById(primaryValue);
                    const fullPaths = [];
                    const data = paths.reduce((object, path) => {
                        fullPaths.push(path);
                        const item = object && object[path];
                        if (item) {
                            const currentRowId = options && options[fullPaths.join('/')] || item.items[0] && item.items[0].primaryValue || null;
                            if (currentRowId) {
                                const currentRow = item.get(currentRowId);
                                return currentRow || null;
                            }
                        }
                        return null;
                    }, entity);
                    if (data) {
                        row = data.toJSON();
                    }
                    else {
                        row = {};
                    }
                }
                else {
                    row = ExpressionUtil.getCurrentRowByPaths(paths, bindingData);
                }
            }
            const propertyName = paths.pop();
            let parent = paths.reduce((object, path) => {
                return object && object[path] || null;
            }, entity);
            const list = parent[propertyName];
            const node = Object.assign({ __items__: [] }, row && row || {}, { __type__: 'List' });
            node.length = () => node.__items__.length;
            if (list && Array.isArray(list)) {
                node.__items__ = [].concat(list);
            }
            parent[propertyName] = node;
        });
        return entity;
    }
    getPropertyValue(entity, paths) {
        return paths.reduce((object, path) => {
            if (object['__type__'] === 'List') {
                return object['__items__'].find(item => item.id === path);
            }
            else if (Array.isArray(object)) {
                return object.find(item => item.id === path);
            }
            else {
                return object && object[path];
            }
        }, entity);
    }
    /**
     * 获取主实体原始字段名
     */
    get entityOriginalNodeCode() {
        const repository = this.injector.get(Repository);
        return repository && repository.entityTypeInfo && repository.entityTypeInfo.entityInfo && repository.entityTypeInfo.entityInfo.originalCode || null;
    }
    /**
     * 构造变量上下文
     * @param event
     * @returns
     */
    buildStateContext() {
        const result = {};
        if (this.frameContext) {
            const rootFrameContext = this.frameContext.getVirtualRootFrameContext();
            if (rootFrameContext) {
                const uiState = rootFrameContext.viewModel.uiState;
                const propertyNames = Object.getOwnPropertyNames(uiState) || [];
                propertyNames.forEach((prop) => {
                    if (prop.match(/^[a-zA-Z0-9_\$]+$/g) !== null) {
                        result[prop] = uiState[prop];
                    }
                });
            }
        }
        return result;
    }
}
ExpressionManager.decorators = [
    { type: Injectable }
];
/** @nocollapse */
ExpressionManager.ctorParameters = () => [
    { type: Injector },
    { type: ResolveService },
    { type: ExpressionExecutor },
    { type: ExpressionRegistry },
    { type: ExpressionResult },
    { type: undefined, decorators: [{ type: Inject, args: [MESSAGE_SERVICE_TOKEN,] }] },
    { type: undefined, decorators: [{ type: Inject, args: [NOTIFY_SERVICE_TOKEN,] }] }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhwcmVzc2lvbl9tYW5hZ2VyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9kZXZraXQvIiwic291cmNlcyI6WyJsaWIvZXhwcmVzc2lvbi9leHByZXNzaW9uX21hbmFnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzdELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFFekMsT0FBTyxFQUFFLEtBQUssRUFBYyxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFN0MsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzlDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUNqRCxPQUFPLEVBQUUsZUFBZSxFQUFFLGNBQWMsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ3BFLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUMxRCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUMzRCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUMzRCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBRXJDLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3ZELE9BQU8sRUFBbUMscUJBQXFCLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFN0csT0FBTyxFQUFhLGNBQWMsRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUdwRCxNQUFNLE9BQU8saUJBQWlCO0lBRTVCLFlBQW9CLFFBQWtCLEVBQVUsY0FBOEIsRUFBVSxrQkFBc0MsRUFBVSxrQkFBc0MsRUFBVSxnQkFBa0MsRUFBeUMsY0FBK0IsRUFBd0MsYUFBNkI7UUFBblYsYUFBUSxHQUFSLFFBQVEsQ0FBVTtR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cm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xyXG5pbXBvcnQgeyBCaWdOdW1iZXIgfSBmcm9tICdiaWdudW1iZXIuanMnO1xyXG5pbXBvcnQgeyBCaW5kaW5nRGF0YSwgQmluZGluZ0xpc3QsIEJpbmRpbmdPYmplY3QgfSBmcm9tIFwiLi4vYmluZGluZy1kYXRhL2luZGV4XCI7XHJcbmltcG9ydCB7IEVNUFRZLCBPYnNlcnZhYmxlLCBvZiB9IGZyb20gXCJyeGpzXCI7XHJcbmltcG9ydCB7IEFwcENvbnRleHQgfSBmcm9tIFwiLi4vYXBwL2luZGV4XCI7XHJcbmltcG9ydCB7IEZyYW1lQ29udGV4dCB9IGZyb20gXCIuLi9mcmFtZS9pbmRleFwiO1xyXG5pbXBvcnQgeyBSZXBvc2l0b3J5IH0gZnJvbSBcIi4uL3JlcG9zaXRvcnkvaW5kZXhcIjtcclxuaW1wb3J0IHsgRU5USVRZX1RFTVBMQVRFLCBSZXNvbHZlU2VydmljZSB9IGZyb20gXCIuLi9yZXNvbHZlci9pbmRleFwiO1xyXG5pbXBvcnQgeyBFeHByZXNzaW9uVXRpbCB9IGZyb20gXCIuLi91dGlscy9leHByZXNzaW9uX3V0aWxcIjtcclxuaW1wb3J0IHsgRXhwcmVzc2lvbkV4ZWN1dG9yIH0gZnJvbSBcIi4vZXhwcmVzc2lvbl9leGVjdXRvclwiO1xyXG5pbXBvcnQgeyBFeHByZXNzaW9uUmVnaXN0cnkgfSBmcm9tIFwiLi9leHByZXNzaW9uX3JlZ2lzdHJ5XCI7XHJcbmltcG9ydCB7IEV4cHJlc3Npb24gfSBmcm9tICcuL3R5cGVzJztcclxuaW1wb3J0IHsgVmlld01vZGVsIH0gZnJvbSBcIi4uL3ZpZXctbW9kZWwvaW5kZXhcIjtcclxuaW1wb3J0IHsgRXhwcmVzc2lvblJlc3VsdCB9IGZyb20gXCIuL2V4cHJlc3Npb25fcmVzdWx0XCI7XHJcbmltcG9ydCB7IElNZXNzYWdlU2VydmljZSwgSU5vdGlmeVNlcnZpY2UsIE1FU1NBR0VfU0VSVklDRV9UT0tFTiwgTk9USUZZX1NFUlZJQ0VfVE9LRU4gfSBmcm9tIFwiLi4vY29yZS9pbmRleFwiO1xyXG5pbXBvcnQgeyBFbnRpdHksIEVudGl0eUxpc3QgfSBmcm9tIFwiLi4vZW50aXR5XCI7XHJcbmltcG9ydCB7IFRyYW5zbGF0ZSwgVHJhbnNsYXRlVG9rZW4gfSBmcm9tIFwiLi4vaTE4blwiO1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgRXhwcmVzc2lvbk1hbmFnZXIge1xyXG4gIHByaXZhdGUgZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQgPSBudWxsO1xyXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yLCBwcml2YXRlIHJlc29sdmVTZXJ2aWNlOiBSZXNvbHZlU2VydmljZSwgcHJpdmF0ZSBleHByZXNzaW9uRXhlY3V0b3I6IEV4cHJlc3Npb25FeGVjdXRvciwgcHJpdmF0ZSBleHByZXNzaW9uUmVnaXN0cnk6IEV4cHJlc3Npb25SZWdpc3RyeSwgcHJpdmF0ZSBleHByZXNzaW9uUmVzdWx0OiBFeHByZXNzaW9uUmVzdWx0LCBASW5qZWN0KE1FU1NBR0VfU0VSVklDRV9UT0tFTikgcHJpdmF0ZSBtZXNzYWdlU2VydmljZTogSU1lc3NhZ2VTZXJ2aWNlLCBASW5qZWN0KE5PVElGWV9TRVJWSUNFX1RPS0VOKSBwcml2YXRlIG5vdGlmeVNlcnZpY2U6IElOb3RpZnlTZXJ2aWNlKSB7XHJcbiAgICB0aGlzLmZyYW1lQ29udGV4dCA9IHRoaXMuaW5qZWN0b3IuZ2V0PEZyYW1lQ29udGV4dD4oRnJhbWVDb250ZXh0LCBudWxsKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5qC55o2u6KGo6L6+5byPaWTov5vooYzorqHnrpdcclxuICAgKiBAcGFyYW0gZXhwcmVzc2lvbklkIOihqOi+vuW8j2lkXHJcbiAgICogQHBhcmFtIHZpZXdNb2RlbCB2aWV3TW9kZWxcclxuICAgKiBAcGFyYW0gcm93RGF0YSByb3dEYXRhXHJcbiAgICogQHJldHVybnMgXHJcbiAgICovXHJcbiAgcHVibGljIGV2YWwoZXhwcmVzc2lvbklkOiBzdHJpbmcsIHZpZXdNb2RlbD86IFZpZXdNb2RlbCwgcm93RGF0YT86IGFueSkge1xyXG4gICAgY29uc3QgZXhwcmVzc2lvbk9iamVjdCA9IHRoaXMuZXhwcmVzc2lvblJlZ2lzdHJ5LmdldEV4cHJlc3Npb25CeUlkKGV4cHJlc3Npb25JZCk7XHJcbiAgICBpZiAoZXhwcmVzc2lvbk9iamVjdCkge1xyXG4gICAgICBjb25zdCBjdXN0b21Db250ZXh0OiBFeHByZXNzaW9uLklDdXN0b21Db250ZXh0ID0ge307XHJcbiAgICAgIGNvbnN0IGJpbmRpbmdQYXRoID0gdmlld01vZGVsICYmIHZpZXdNb2RlbC5iaW5kaW5nUGF0aCB8fCBudWxsO1xyXG4gICAgICBpZiAoYmluZGluZ1BhdGggJiYgcm93RGF0YSkge1xyXG4gICAgICAgIGNvbnN0IGJpbmRpbmdQYXRocyA9IGJpbmRpbmdQYXRoLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCk7XHJcbiAgICAgICAgY29uc3QgYmluZGluZ0xpc3QgPSB0aGlzLmZyYW1lQ29udGV4dC5iaW5kaW5nRGF0YS5nZXRWYWx1ZShiaW5kaW5nUGF0aHMpIGFzIEJpbmRpbmdMaXN0O1xyXG4gICAgICAgIGxldCBwcmltYXJ5S2V5ID0gJ2lkJztcclxuICAgICAgICBpZiAoYmluZGluZ0xpc3QpIHtcclxuICAgICAgICAgIHByaW1hcnlLZXkgPSBiaW5kaW5nTGlzdC5wcmltYXJ5S2V5O1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBwcmltYXJ5VmFsdWUgPSByb3dEYXRhW3ByaW1hcnlLZXldIHx8IGJpbmRpbmdMaXN0LmN1cnJlbnRJZDtcclxuICAgICAgICBpZiAocHJpbWFyeVZhbHVlKSB7XHJcbiAgICAgICAgICBjdXN0b21Db250ZXh0LmN1cnJlbnRSb3dzID0gW3sgYmluZGluZ1BhdGg6IGJpbmRpbmdQYXRocy5qb2luKCcvJyksIHByaW1hcnlWYWx1ZSB9XTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgbGV0IHJlc3VsdCA9IHRoaXMuZXhlY3V0ZShleHByZXNzaW9uT2JqZWN0LmV4cHJlc3Npb24sIGN1c3RvbUNvbnRleHQpO1xyXG4gICAgICBpZiAoZXhwcmVzc2lvbk9iamVjdC50eXBlID09PSBFeHByZXNzaW9uLkV4cHJlc3Npb25UeXBlLlJlYWRvbmx5IHx8IGV4cHJlc3Npb25PYmplY3QudHlwZSA9PT0gRXhwcmVzc2lvbi5FeHByZXNzaW9uVHlwZS5SZXF1aXJlZCB8fCBleHByZXNzaW9uT2JqZWN0LnR5cGUgPT09IEV4cHJlc3Npb24uRXhwcmVzc2lvblR5cGUuVmlzaWJsZSkge1xyXG4gICAgICAgIHJlc3VsdCA9IHJlc3VsdCA9PT0gdHJ1ZSA/IHRydWUgOiBmYWxzZTtcclxuICAgICAgfVxyXG4gICAgICB0aGlzLmV4cHJlc3Npb25SZXN1bHQuc2V0KGV4cHJlc3Npb25JZCwgcmVzdWx0KTtcclxuICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIC8vIGNvbnNvbGUud2FybignRXhwcmVzc2lvbk1hbmFnZXIg5omn6KGM5aSx6LSl77yM5pyq6I635Y+W5Yiw6KGo6L6+5byPIScpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcclxuICB9XHJcbiAgcHVibGljIHZhbGlkYXRlKGV4cHJlc3Npb25JZDogc3RyaW5nLCBvcHRpb25zOiBhbnkpIHtcclxuICAgIGNvbnN0IGV4cHJlc3Npb25PYmplY3QgPSB0aGlzLmV4cHJlc3Npb25SZWdpc3RyeS5nZXRFeHByZXNzaW9uQnlJZChleHByZXNzaW9uSWQpO1xyXG4gICAgaWYgKGV4cHJlc3Npb25PYmplY3QpIHtcclxuICAgICAgY29uc3QgcGF0Y2ggPSBvcHRpb25zICYmIG9wdGlvbnMucGF0Y2ggfHwgbnVsbDtcclxuICAgICAgY29uc3QgY3VzdG9tQ29udGV4dDogRXhwcmVzc2lvbi5JQ3VzdG9tQ29udGV4dCA9IHt9O1xyXG4gICAgICBpZiAocGF0Y2gpIHtcclxuICAgICAgICBjdXN0b21Db250ZXh0LnBhdGNoID0gcGF0Y2g7XHJcbiAgICAgIH1cclxuICAgICAgY29uc3QgY3VycmVudFJvdyA9IG9wdGlvbnMuY3VycmVudFJvdyB8fCBudWxsO1xyXG4gICAgICBjb25zdCBjdXJyZW50Um93cyA9IG9wdGlvbnMuY3VycmVudFJvd3MgfHwgW107XHJcbiAgICAgIGlmIChjdXJyZW50Um93KSB7XHJcbiAgICAgICAgY3VzdG9tQ29udGV4dC5jdXJyZW50Um93cyA9IGN1c3RvbUNvbnRleHQuY3VycmVudFJvd3MgfHwgW107XHJcbiAgICAgICAgY3VzdG9tQ29udGV4dC5jdXJyZW50Um93cy5wdXNoKGN1cnJlbnRSb3cpO1xyXG4gICAgICB9XHJcbiAgICAgIGlmIChjdXJyZW50Um93cyAmJiBjdXJyZW50Um93cy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgY3VzdG9tQ29udGV4dC5jdXJyZW50Um93cyA9IGN1c3RvbUNvbnRleHQuY3VycmVudFJvd3MgfHwgW107XHJcbiAgICAgICAgQXJyYXkucHJvdG90eXBlLnB1c2guYXBwbHkoY3VzdG9tQ29udGV4dC5jdXJyZW50Um93cywgY3VycmVudFJvd3MpXHJcbiAgICAgIH1cclxuICAgICAgY29uc3QgcmVzdWx0ID0gdGhpcy5leGVjdXRlKGV4cHJlc3Npb25PYmplY3QuZXhwcmVzc2lvbiwgY3VzdG9tQ29udGV4dCk7XHJcbiAgICAgIHRoaXMuZXhwcmVzc2lvblJlc3VsdC5zZXQoZXhwcmVzc2lvbklkLCByZXN1bHQpO1xyXG4gICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgY29uc29sZS53YXJuKCdFeHByZXNzaW9uTWFuYWdlciDmiafooYzlpLHotKXvvIzmnKrojrflj5bliLDooajovr7lvI8hJyk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDluK7liqnliY3lsIHoo4VcclxuICAgKiBAcGFyYW0gZXZlbnQgXHJcbiAgICovXHJcbiAgcHVibGljIG9uRGF0YVBpY2tpbmcoY29uZmlnczogeyBleHByZXNzaW9uSWQ6IHN0cmluZyB9KSB7XHJcbiAgICBjb25zdCBleHByZXNzaW9uSWQgPSBjb25maWdzICYmIGNvbmZpZ3MuZXhwcmVzc2lvbklkIHx8IG51bGw7XHJcbiAgICBpZiAoIWV4cHJlc3Npb25JZCkge1xyXG4gICAgICBjb25zb2xlLndhcm4oYEV4cHJlc3Npb25NYW5hZ2VyIOebuOWFs+ihqOi+vuW8j+iuvue9rumUmeivr++8jOayoeacieihqOi+vuW8j+e8luWPt+OAgmApO1xyXG4gICAgICByZXR1cm4gb2YodHJ1ZSk7XHJcbiAgICB9XHJcbiAgICBjb25zdCByZXN1bHQgPSB0aGlzLmV2YWwoZXhwcmVzc2lvbklkKTtcclxuICAgIGlmICghcmVzdWx0KSB7XHJcbiAgICAgIGNvbnN0IGV4cHJlc3Npb25PYmplY3QgPSB0aGlzLmV4cHJlc3Npb25SZWdpc3RyeS5nZXRFeHByZXNzaW9uQnlJZChleHByZXNzaW9uSWQpO1xyXG4gICAgICBpZiAoIWV4cHJlc3Npb25PYmplY3QpIHtcclxuICAgICAgICBjb25zb2xlLndhcm4oYEV4cHJlc3Npb25NYW5hZ2VyIOaXoOazleaJvuWIsOWvueW6lOeahOihqOi+vuW8jyR7ZXhwcmVzc2lvbklkfWApO1xyXG4gICAgICAgIHJldHVybiBvZih0cnVlKTtcclxuICAgICAgfVxyXG4gICAgICBjb25zdCBtZXNzYWdlVHlwZSA9IGV4cHJlc3Npb25PYmplY3QubWVzc2FnZVR5cGUgfHwgRXhwcmVzc2lvbi5NZXNzYWdlVHlwZS53YXJuaW5nO1xyXG4gICAgICBjb25zdCBtZXNzYWdlID0gZXhwcmVzc2lvbk9iamVjdC5tZXNzYWdlO1xyXG4gICAgICBpZiAobWVzc2FnZSkge1xyXG4gICAgICAgIHRoaXMubm90aWZ5U2VydmljZVttZXNzYWdlVHlwZV0obWVzc2FnZSwgeyBoaWRlVGl0bGU6IHRydWUgfSk7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIEVNUFRZO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIG9mKHJlc3VsdCk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOaJp+ihjOihqOi+vuW8j+iuoeeul1xyXG4gICAqIEBwYXJhbSBleHByZXNzaW9uIOihqOi+vuW8j1xyXG4gICAqIEBwYXJhbSBjdXN0b21Db250ZXh0IOiHquWumuS5ieS4iuS4i+aWh1xyXG4gICAqIEByZXR1cm5zIFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZXhlY3V0ZShleHByZXNzaW9uOiBzdHJpbmcsIGN1c3RvbUNvbnRleHQ/OiBFeHByZXNzaW9uLklDdXN0b21Db250ZXh0KTogYW55IHtcclxuICAgIGNvbnN0IGRlcHMgPSB0aGlzLnJlc29sdmVTZXJ2aWNlLnJlc29sdmUoZXhwcmVzc2lvbik7XHJcbiAgICBjb25zdCBncm91cERlcGVuZGVuY2llcyA9IEV4cHJlc3Npb25VdGlsLmdldEdyb3VwRnVuY3Rpb25EZXBlbmRlbmN5KGV4cHJlc3Npb24sIHRoaXMuZnJhbWVDb250ZXh0LnJlcG9zaXRvcnkuZW50aXR5VHlwZUluZm8pO1xyXG4gICAgY29uc3QgZW50aXR5Q29udGV4dCA9IHRoaXMuYnVpbGRFbnRpdHlDb250ZXh0KGRlcHMsIGdyb3VwRGVwZW5kZW5jaWVzLCBjdXN0b21Db250ZXh0KTtcclxuICAgIGNvbnN0IHN0YXRlQ29udGV4dCA9IHRoaXMuYnVpbGRTdGF0ZUNvbnRleHQoKTtcclxuICAgIGNvbnN0IGRhdGEgPSBjdXN0b21Db250ZXh0ICYmIGN1c3RvbUNvbnRleHQuY29udGV4dHMgfHwgbnVsbDtcclxuICAgIGNvbnN0IHRyYW5zbGF0ZSA9IHRoaXMuaW5qZWN0b3IuZ2V0PFRyYW5zbGF0ZT4oVHJhbnNsYXRlVG9rZW4sIG51bGwpO1xyXG4gICAgY29uc3QgY29udGV4dCA9IHtcclxuICAgICAgW3RoaXMuZW50aXR5T3JpZ2luYWxOb2RlQ29kZV06IGVudGl0eUNvbnRleHQsXHJcbiAgICAgIC4uLnN0YXRlQ29udGV4dCxcclxuICAgICAgQmlnTnVtYmVyLFxyXG4gICAgICBmcmFtZUNvbnRleHQ6IHRoaXMuZnJhbWVDb250ZXh0LFxyXG4gICAgICBiaW5kaW5nRGF0YTogdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEsXHJcbiAgICAgIHJlcG9zaXRvcnk6IHRoaXMuZnJhbWVDb250ZXh0LnJlcG9zaXRvcnksXHJcbiAgICAgIEN1cnJlbnRMYW5ndWFnZTogdHJhbnNsYXRlLmdldEN1cnJlbnRMYW5ndWFnZSgpIHx8ICd6aC1DSFMnLFxyXG4gICAgICAuLi5kYXRhXHJcbiAgICB9XHJcbiAgICBpZiAoIWVudGl0eUNvbnRleHQpIHtcclxuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcclxuICAgIH1cclxuICAgIHJldHVybiB0aGlzLmV4cHJlc3Npb25FeGVjdXRvci5ldmFsKGV4cHJlc3Npb24sIGNvbnRleHQpO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmiafooYzooajovr7lvI/vvIjov5Tlm57lj6/op4Llr5/lr7nosaHvvIlcclxuICAgKiBAcGFyYW0gZXhwcmVzc2lvbiDooajovr7lvI9cclxuICAgKiBAcGFyYW0gY3VzdG9tQ29udGV4dCDoh6rlrprkuYnkuIrkuIvmlodcclxuICAgKiBAcmV0dXJucyBcclxuICAgKi9cclxuICBwcml2YXRlIGV4ZWN1dGVBc3luYyhleHByZXNzaW9uOiBzdHJpbmcsIGN1c3RvbUNvbnRleHQ/OiBFeHByZXNzaW9uLklDdXN0b21Db250ZXh0KTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMuZXhlY3V0ZShleHByZXNzaW9uLCBjdXN0b21Db250ZXh0KTtcclxuICAgIHJldHVybiBvZihyZXN1bHQpO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmnoTpgKDlrp7kvZPkuIrkuIvmlodcclxuICAgKiBAcGFyYW0gZGVwcyBcclxuICAgKiBAcGFyYW0gZ3JvdXBEZXBlbmRlbmNpZXMgXHJcbiAgICogQHBhcmFtIGNvbnRleHQgXHJcbiAgICogQHJldHVybnMgXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBidWlsZEVudGl0eUNvbnRleHQoZGVwczogc3RyaW5nW10sIGdyb3VwRGVwZW5kZW5jaWVzOiBzdHJpbmdbXSwgY29udGV4dD86IEV4cHJlc3Npb24uSUN1c3RvbUNvbnRleHQpIHtcclxuXHJcbiAgICBjb25zdCBjdXJyZW50Um93cyA9IGNvbnRleHQgJiYgY29udGV4dC5jdXJyZW50Um93cyB8fCBudWxsO1xyXG4gICAgY29uc3QgaW5kZXggPSBkZXBzLmZpbmRJbmRleCgoZGVwOiBzdHJpbmcpID0+IHtcclxuICAgICAgY29uc3QgaXNFbnRpdHlEZXBlbmRlbmN5ID0gdGhpcy5pc0VudGl0eURlcGVuZGVuY3koZGVwKTtcclxuICAgICAgLy8g5aaC5p6c5L6d6LWW55qE5pivc3RhdGXvvIzml6DpnIDlpITnkIbvvIznjrDlnKjpnIDopoHnoa7lrprnmoTmmK/ov5Tlm57lpJrlsJHlrp7kvZPnmoTpl67popjvvIzlkoxzdGF0ZeayoeacieWFs+ezu1xyXG4gICAgICAvLyDooajovr7lvI/kvp3otZbkuoblrp7kvZNcclxuICAgICAgaWYgKGlzRW50aXR5RGVwZW5kZW5jeSkge1xyXG4gICAgICAgIGNvbnN0IGlzR3JvdXBEZXBlbmRlbmN5ID0gZ3JvdXBEZXBlbmRlbmNpZXMuZmluZEluZGV4KGl0ZW0gPT4gaXRlbSA9PT0gZGVwKSAhPT0gLTE7XHJcbiAgICAgICAgLy8g5piv6IGa5ZCI5L6d6LWWXHJcbiAgICAgICAgaWYgKGlzR3JvdXBEZXBlbmRlbmN5KSB7XHJcbiAgICAgICAgICBjb25zdCBkZXBlbmRlbmN5TGVuZ3RoID0gZGVwLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCkubGVuZ3RoIC0gMTtcclxuICAgICAgICAgIGlmIChkZXBlbmRlbmN5TGVuZ3RoID09PSAxKSB7XHJcbiAgICAgICAgICAgIC8vIOiBmuWQiOS6huS4u+ihqOWtl+aute+8jOaJgOacieS4u+ihqOaVsOaNrumDvemcgOimgeWPguS4jui/kOeul++8jOatpOaXtuW3sue7j+ehruWumuiuoeeul+eahOWunuS9k+S4iuS4i+aWh+S6huOAglxyXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIC8vIOiBmuWQiOS6huWtkOihqOWtl+aute+8jOWPqumcgOimgeS8oOmAkuW9k+WJjeWunuS9k1xyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIC8vIOW9k+WJjeS+nei1luS4jeaYr+iBmuWQiO+8jOWPqumcgOimgeS8oOmAkuW9k+WJjeWunuS9k1xyXG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9KVxyXG4gICAgY29uc3QgaXNHcm91cGRNYWluRW50aXR5ID0gaW5kZXggIT09IC0xO1xyXG5cclxuICAgIGNvbnN0IG9wdGlvbnMgPSB7fTtcclxuICAgIGlmIChjdXJyZW50Um93cyAmJiBjdXJyZW50Um93cy5sZW5ndGggPiAwKSB7XHJcbiAgICAgIGN1cnJlbnRSb3dzLmZvckVhY2goKGN1cnJlbnRSb3c6IEV4cHJlc3Npb24uSUN1cnJlbnRSb3cpID0+IHtcclxuICAgICAgICBvcHRpb25zW2N1cnJlbnRSb3cuYmluZGluZ1BhdGggfHwgJy8nXSA9IGN1cnJlbnRSb3cucHJpbWFyeVZhbHVlO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICAgIGNvbnN0IGVudGl0eSA9IHRoaXMuZ2V0RW50aXR5KG9wdGlvbnMpO1xyXG4gICAgY29uc3QgcGF0Y2ggPSBjb250ZXh0ICYmIGNvbnRleHQucGF0Y2ggfHwgbnVsbDtcclxuICAgIGlmICghZW50aXR5KSB7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gICAgaWYgKHBhdGNoICYmIE9iamVjdC5rZXlzKHBhdGNoKS5sZW5ndGggPiAwKSB7XHJcbiAgICAgIE9iamVjdC5rZXlzKHBhdGNoKS5mb3JFYWNoKChrZXk6IHN0cmluZykgPT4ge1xyXG4gICAgICAgIGNvbnN0IHBhdGhzID0ga2V5LnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCk7XHJcbiAgICAgICAgY29uc3QgdmFsdWUgPSBwYXRjaFtrZXldO1xyXG4gICAgICAgIHRoaXMuc2V0VmFsdWUoZW50aXR5LCBwYXRocywgdmFsdWUpO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICAgIGlmIChpc0dyb3VwZE1haW5FbnRpdHkpIHtcclxuICAgICAgY29uc3QgY29sbGVjdGlvbiA9IHRoaXMuZnJhbWVDb250ZXh0LnJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi50b0pTT04oKTtcclxuICAgICAgZW50aXR5WydfX3R5cGVfXyddID0gJ0xpc3QnO1xyXG4gICAgICBlbnRpdHlbJ19faXRlbXNfXyddID0gY29sbGVjdGlvbjtcclxuICAgIH1cclxuICAgIHJldHVybiBlbnRpdHk7XHJcbiAgfVxyXG4gIHByaXZhdGUgc2V0VmFsdWUodGFyZ2V0OiBhbnksIHBhdGhzOiBzdHJpbmdbXSwgdmFsdWU6IGFueSkge1xyXG4gICAgaWYgKHBhdGhzLmxlbmd0aCA9PT0gMSkge1xyXG4gICAgICB0YXJnZXRbcGF0aHNbMF1dID0gdmFsdWU7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBjb25zdCBwcm9wZXJ0eU5hbWUgPSBwYXRocy5wb3AoKTtcclxuICAgICAgY29uc3QgcmVzdWx0ID0gcGF0aHMucmVkdWNlKChvYmplY3Q6IGFueSwgcGF0aDogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIG9iamVjdCAmJiBvYmplY3RbcGF0aF07XHJcbiAgICAgIH0sIHRhcmdldCk7XHJcbiAgICAgIHJlc3VsdFtwcm9wZXJ0eU5hbWVdID0gdmFsdWU7XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOaYr+WQpuS4uuWunuS9k+S+nei1llxyXG4gICAqIEBwYXJhbSBkZXAgXHJcbiAgICogQHJldHVybnMgXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBpc0VudGl0eURlcGVuZGVuY3koZGVwOiBzdHJpbmcpIHtcclxuICAgIHJldHVybiBkZXAuc3RhcnRzV2l0aChFTlRJVFlfVEVNUExBVEUpO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDojrflj5blrp7kvZNcclxuICAgKiBAcGFyYW0gb3B0aW9ucyBcclxuICAgKiBAcmV0dXJucyBcclxuICAgKi9cclxuICBwdWJsaWMgZ2V0RW50aXR5KG9wdGlvbnM6IHsgW2JpbmRpbmdQYXRoOiBzdHJpbmddOiBzdHJpbmcgfSkge1xyXG4gICAgY29uc3QgZW50aXR5VHlwZUluZm8gPSB0aGlzLmZyYW1lQ29udGV4dC5yZXBvc2l0b3J5LmVudGl0eVR5cGVJbmZvO1xyXG4gICAgY29uc3QgYmluZGluZ0RhdGEgPSB0aGlzLmZyYW1lQ29udGV4dC5iaW5kaW5nRGF0YTtcclxuICAgIGNvbnN0IGNoaWxkcmVuRW50aXR5UGF0aHMgPSBbXTtcclxuXHJcbiAgICBsZXQgZW50aXR5ID0gbnVsbDtcclxuICAgIGlmIChvcHRpb25zWycvJ10pIHtcclxuICAgICAgLy8g5L+u5q2j5Li76KGoXHJcbiAgICAgIGVudGl0eSA9IHRoaXMuZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhLmxpc3QuZmluZEJ5SWQob3B0aW9uc1snLyddKTtcclxuICAgICAgaWYgKGVudGl0eSkge1xyXG4gICAgICAgIGVudGl0eSA9IGVudGl0eS50b0pTT04oKTtcclxuICAgICAgfVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgZW50aXR5ID0gdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEubGlzdC5jdXJyZW50SXRlbS50b0pTT04oKTtcclxuICAgIH1cclxuICAgIGlmICghZW50aXR5KSB7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gICAgRXhwcmVzc2lvblV0aWwuZ2V0Q2hpbGRyZW5FbnRpdHlQYXRocyhlbnRpdHlUeXBlSW5mbywgY2hpbGRyZW5FbnRpdHlQYXRocyk7XHJcbiAgICBlbnRpdHlbJ19fdHlwZV9fJ10gPSAnRW50aXR5JztcclxuICAgIGlmICghY2hpbGRyZW5FbnRpdHlQYXRocyB8fCBjaGlsZHJlbkVudGl0eVBhdGhzLmxlbmd0aCA8IDEpIHtcclxuICAgICAgcmV0dXJuIGVudGl0eTtcclxuICAgIH1cclxuICAgIC8vIOaJvuWIsOaJgOacieWtkOihqFxyXG4gICAgY2hpbGRyZW5FbnRpdHlQYXRocy5mb3JFYWNoKChwYXRoczogc3RyaW5nW10pID0+IHtcclxuICAgICAgbGV0IHJvdyA9IG51bGw7XHJcbiAgICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnNbcGF0aHMuam9pbignLycpXSkge1xyXG4gICAgICAgIGNvbnN0IHBhcmVudFBhdGhzID0gcGF0aHMuc2xpY2UoMCwgMSk7XHJcbiAgICAgICAgaWYgKHBhdGhzLmxlbmd0aCA9PSAyICYmIG9wdGlvbnNbcGFyZW50UGF0aHMuam9pbignLycpXSkge1xyXG4gICAgICAgICAgY29uc3QgcGFyZW50Um93ID0gb3B0aW9uc1twYXJlbnRQYXRocy5qb2luKCcvJyldO1xyXG4gICAgICAgICAgLy8g5LuO5LuO6KGoXHJcbiAgICAgICAgICAvLyDpnIDopoHliIfmjaLkuIrnuqfooahcclxuICAgICAgICAgIHJvdyA9IHRoaXMuZ2V0UHJvcGVydHlWYWx1ZShlbnRpdHksIHBhcmVudFBhdGhzLmNvbmNhdChbcGFyZW50Um93LCBwYXRoc1sxXSwgb3B0aW9uc1twYXRocy5qb2luKCcvJyldXSkpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAvLyDkuI3lupTor6Xkvb/nlKhiaW5kaW5nRGF0Ye+8jOi/meagt+Wwsem7mOiupOS9v+eUqOS6huW9k+WJjeihjFxyXG4gICAgICAgICAgY29uc3QgYmluZGluZ0xpc3Q6IEJpbmRpbmdMaXN0ID0gYmluZGluZ0RhdGEuZ2V0VmFsdWUocGF0aHMpIGFzIEJpbmRpbmdMaXN0O1xyXG4gICAgICAgICAgY29uc3QgY3VycmVudFJvd0lkID0gb3B0aW9uc1twYXRocy5qb2luKCcvJyldO1xyXG4gICAgICAgICAgbGV0IGN1cnJlbnRSb3c6IEJpbmRpbmdPYmplY3QgPSBudWxsO1xyXG4gICAgICAgICAgaWYgKGN1cnJlbnRSb3dJZCAhPT0gYmluZGluZ0xpc3QuY3VycmVudElkKSB7XHJcbiAgICAgICAgICAgIGN1cnJlbnRSb3cgPSBiaW5kaW5nTGlzdC5maW5kQnlJZChjdXJyZW50Um93SWQpO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgY3VycmVudFJvdyA9IGJpbmRpbmdMaXN0LmN1cnJlbnRJdGVtO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgaWYgKGN1cnJlbnRSb3cgJiYgY3VycmVudFJvdy5wcmltYXJ5S2V5VmFsdWUpIHtcclxuICAgICAgICAgICAgcm93ID0gY3VycmVudFJvdy50b0pTT04oKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgLy8g5aaC5p6c5LiK57qn6KGo5bey57uP5YiH5o2i5LqG5b2T5YmN6KGM77yM6YKj5LmI5LiL57qn6KGo5Lmf5bqU6K+l5YiH5o2iXHJcbiAgICAgICAgY29uc3QgcGFyZW50VGFibGVDdXJyZW50Um93Q2hhbmdlZCA9IG9wdGlvbnMgJiYgISFPYmplY3Qua2V5cyhvcHRpb25zKS5maW5kKHBhdGggPT4ge1xyXG4gICAgICAgICAgY29uc3QgZnVsbFBhdGggPSBwYXRoLnNwbGl0KCcvJykuam9pbignLycpO1xyXG4gICAgICAgICAgcmV0dXJuIHBhdGhzLmpvaW4oJy8nKS5zdGFydHNXaXRoKGZ1bGxQYXRoKTtcclxuICAgICAgICB9KSB8fCBmYWxzZTtcclxuICAgICAgICBpZiAocGFyZW50VGFibGVDdXJyZW50Um93Q2hhbmdlZCkge1xyXG4gICAgICAgICAgY29uc3QgcHJpbWFyeVZhbHVlID0gb3B0aW9ucyAmJiBvcHRpb25zWycvJ10gfHwgYmluZGluZ0RhdGEubGlzdC5jdXJyZW50SWQ7XHJcbiAgICAgICAgICBjb25zdCBlbnRpdHkgPSB0aGlzLmZyYW1lQ29udGV4dC5yZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24uZ2V0RW50aXR5QnlJZChwcmltYXJ5VmFsdWUpO1xyXG4gICAgICAgICAgY29uc3QgZnVsbFBhdGhzID0gW107XHJcbiAgICAgICAgICBjb25zdCBkYXRhID0gcGF0aHMucmVkdWNlKChvYmplY3QsIHBhdGgpID0+IHtcclxuICAgICAgICAgICAgZnVsbFBhdGhzLnB1c2gocGF0aCk7XHJcbiAgICAgICAgICAgIGNvbnN0IGl0ZW0gPSBvYmplY3QgJiYgb2JqZWN0W3BhdGhdIGFzIEVudGl0eUxpc3Q8RW50aXR5PjtcclxuICAgICAgICAgICAgaWYgKGl0ZW0pIHtcclxuICAgICAgICAgICAgICBjb25zdCBjdXJyZW50Um93SWQgPSBvcHRpb25zICYmIG9wdGlvbnNbZnVsbFBhdGhzLmpvaW4oJy8nKV0gfHwgaXRlbS5pdGVtc1swXSAmJiBpdGVtLml0ZW1zWzBdLnByaW1hcnlWYWx1ZSB8fCBudWxsO1xyXG4gICAgICAgICAgICAgIGlmIChjdXJyZW50Um93SWQpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRSb3cgPSBpdGVtLmdldChjdXJyZW50Um93SWQpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRSb3cgfHwgbnVsbDtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgICB9LCBlbnRpdHkpIGFzIEVudGl0eTtcclxuICAgICAgICAgIGlmIChkYXRhKSB7XHJcbiAgICAgICAgICAgIHJvdyA9IGRhdGEudG9KU09OKCk7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByb3cgPSB7fTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgcm93ID0gRXhwcmVzc2lvblV0aWwuZ2V0Q3VycmVudFJvd0J5UGF0aHMocGF0aHMsIGJpbmRpbmdEYXRhKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgY29uc3QgcHJvcGVydHlOYW1lID0gcGF0aHMucG9wKCk7XHJcbiAgICAgIGxldCBwYXJlbnQgPSBwYXRocy5yZWR1Y2UoKG9iamVjdDogYW55LCBwYXRoOiBzdHJpbmcpID0+IHtcclxuICAgICAgICByZXR1cm4gb2JqZWN0ICYmIG9iamVjdFtwYXRoXSB8fCBudWxsO1xyXG4gICAgICB9LCBlbnRpdHkpO1xyXG4gICAgICBjb25zdCBsaXN0ID0gcGFyZW50W3Byb3BlcnR5TmFtZV07XHJcbiAgICAgIGNvbnN0IG5vZGU6IGFueSA9IHsgX19pdGVtc19fOiBbXSwgLi4ucm93ICYmIHJvdyB8fCB7fSwgX190eXBlX186ICdMaXN0JyB9O1xyXG4gICAgICBub2RlLmxlbmd0aCA9ICgpID0+IG5vZGUuX19pdGVtc19fLmxlbmd0aDtcclxuICAgICAgaWYgKGxpc3QgJiYgQXJyYXkuaXNBcnJheShsaXN0KSkge1xyXG4gICAgICAgIG5vZGUuX19pdGVtc19fID0gW10uY29uY2F0KGxpc3QpO1xyXG4gICAgICB9XHJcbiAgICAgIHBhcmVudFtwcm9wZXJ0eU5hbWVdID0gbm9kZTtcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIGVudGl0eTtcclxuICB9XHJcbiAgcHJpdmF0ZSBnZXRQcm9wZXJ0eVZhbHVlKGVudGl0eTogYW55LCBwYXRoczogc3RyaW5nW10pIHtcclxuICAgIHJldHVybiBwYXRocy5yZWR1Y2UoKG9iamVjdDogYW55LCBwYXRoOiBzdHJpbmcpID0+IHtcclxuICAgICAgaWYgKG9iamVjdFsnX190eXBlX18nXSA9PT0gJ0xpc3QnKSB7XHJcbiAgICAgICAgcmV0dXJuIG9iamVjdFsnX19pdGVtc19fJ10uZmluZChpdGVtID0+IGl0ZW0uaWQgPT09IHBhdGgpO1xyXG4gICAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkob2JqZWN0KSkge1xyXG4gICAgICAgIHJldHVybiBvYmplY3QuZmluZChpdGVtID0+IGl0ZW0uaWQgPT09IHBhdGgpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHJldHVybiBvYmplY3QgJiYgb2JqZWN0W3BhdGhdO1xyXG4gICAgICB9XHJcbiAgICB9LCBlbnRpdHkpO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDojrflj5bkuLvlrp7kvZPljp/lp4vlrZfmrrXlkI1cclxuICAgKi9cclxuICBwcm90ZWN0ZWQgZ2V0IGVudGl0eU9yaWdpbmFsTm9kZUNvZGUoKTogc3RyaW5nIHtcclxuICAgIGNvbnN0IHJlcG9zaXRvcnkgPSB0aGlzLmluamVjdG9yLmdldChSZXBvc2l0b3J5KTtcclxuICAgIHJldHVybiByZXBvc2l0b3J5ICYmIHJlcG9zaXRvcnkuZW50aXR5VHlwZUluZm8gJiYgcmVwb3NpdG9yeS5lbnRpdHlUeXBlSW5mby5lbnRpdHlJbmZvICYmIHJlcG9zaXRvcnkuZW50aXR5VHlwZUluZm8uZW50aXR5SW5mby5vcmlnaW5hbENvZGUgfHwgbnVsbDtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5p6E6YCg5Y+Y6YeP5LiK5LiL5paHXHJcbiAgICogQHBhcmFtIGV2ZW50IFxyXG4gICAqIEByZXR1cm5zIFxyXG4gICAqL1xyXG4gIHB1YmxpYyBidWlsZFN0YXRlQ29udGV4dCgpIHtcclxuICAgIGNvbnN0IHJlc3VsdCA9IHt9O1xyXG4gICAgaWYgKHRoaXMuZnJhbWVDb250ZXh0KSB7XHJcbiAgICAgIGNvbnN0IHJvb3RGcmFtZUNvbnRleHQgPSB0aGlzLmZyYW1lQ29udGV4dC5nZXRWaXJ0dWFsUm9vdEZyYW1lQ29udGV4dCgpO1xyXG4gICAgICBpZiAocm9vdEZyYW1lQ29udGV4dCkge1xyXG4gICAgICAgIGNvbnN0IHVpU3RhdGUgPSByb290RnJhbWVDb250ZXh0LnZpZXdNb2RlbC51aVN0YXRlO1xyXG4gICAgICAgIGNvbnN0IHByb3BlcnR5TmFtZXMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyh1aVN0YXRlKSB8fCBbXTtcclxuICAgICAgICBwcm9wZXJ0eU5hbWVzLmZvckVhY2goKHByb3A6IHN0cmluZykgPT4ge1xyXG4gICAgICAgICAgaWYgKHByb3AubWF0Y2goL15bYS16QS1aMC05X1xcJF0rJC9nKSAhPT0gbnVsbCkge1xyXG4gICAgICAgICAgICByZXN1bHRbcHJvcF0gPSB1aVN0YXRlW3Byb3BdO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcmVzdWx0O1xyXG4gIH1cclxufSJdfQ==