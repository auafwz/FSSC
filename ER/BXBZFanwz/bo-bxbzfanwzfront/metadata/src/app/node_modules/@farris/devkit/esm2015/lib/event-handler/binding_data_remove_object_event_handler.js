import { Injectable } from "@angular/core";
import { EffectorManager } from "../effector/effector_manager";
import { Expression } from "../expression";
import { ENTITY_TEMPLATE } from "../resolver/index";
import { EventHandler } from "./event_handler";
/**
 * 删除数据时需要计算的表达式
 * 1、依赖被删除数据表的上级表达式（不考虑同表内的聚合依赖）
 */
export class BindingDataRemoveObjectEventHandler extends EventHandler {
    /**
     * 过滤出需要计算的表达式
     * @param event event
     * @returns
     */
    filter(event) {
        if (this.expressionObjects && this.expressionObjects.length > 0) {
            // 找到聚合相关表达式
            const expressions = this.expressionObjects.filter((expressionObject) => {
                if (expressionObject.ns !== event.ns || !expressionObject.deps || expressionObject.deps.length < 1) {
                    return false;
                }
                const info = this.analysis(event, expressionObject);
                if (!info) {
                    return false;
                }
                // event.path like [id:xxxx] or [id:xxxx,子表s]
                const eventTablePaths = this.buildEntityPath(event.path);
                // 主表删除
                if (eventTablePaths.length === 0) {
                    if (expressionObject.bindingType === Expression.ExpressionBindingType.Field) {
                        return false;
                    }
                }
                // 从表或从从表删除
                eventTablePaths.splice(0, 0, ENTITY_TEMPLATE);
                // eventEntityPath like ['ENTITY~','formEEUR1E1s'] // 从表新增
                // deps like ['ENTITY~/formEEUR1E1s/udt/udt_field','ENTITY~/formEEUR1E1s/ref/ref_udt/ref_udt_field']
                // 仅处理上级表达式
                if (info.eventTablePaths.length - 1 !== info.expressionTablePaths.length) {
                    return false;
                }
                // 不支持跨表
                if (!info.eventTablePaths.join(Expression.DEPENDENCY_SPLITER).startsWith(info.expressionTablePaths.join(Expression.DEPENDENCY_SPLITER))) {
                    return false;
                }
                const index = expressionObject.deps.findIndex((dep) => {
                    // 依赖
                    if (!dep.startsWith(eventTablePaths.join(Expression.DEPENDENCY_SPLITER))) {
                        return false;
                    }
                    const deps = dep.split(Expression.DEPENDENCY_SPLITER).filter(p => p).slice(1);
                    const dependPathInfo = this.getPathInfo(deps.join(Expression.DEPENDENCY_SPLITER));
                    if (dependPathInfo && dependPathInfo.paths.join(Expression.DEPENDENCY_SPLITER) === info.eventTablePaths.join(Expression.DEPENDENCY_SPLITER)) {
                        return true;
                    }
                    return false;
                });
                return index === -1 ? false : true;
            });
            return expressions;
        }
    }
    /**
     * 发布事件
     * @param event event
     */
    dispatch(event) {
        const expressions = this.filter(event);
        if (expressions && expressions.length > 0) {
            expressions.forEach((expressionObject) => {
                const entityContext = this.buildEntityContext(event, expressionObject);
                const context = this.buildContext(expressionObject, event, entityContext);
                const result = this.perform(expressionObject, context);
                if (result === undefined && !this.isValidateOrRequiredExpression(expressionObject)) {
                    return;
                }
                expressionObject.result = this.convertBooleanTypeExpressionResult(expressionObject, result);
                ;
                if (expressionObject.id) {
                    this.expressionResult.set(expressionObject.id, expressionObject.result);
                }
                this.effect(event, expressionObject);
            });
        }
    }
    /**
     * 删除副作用器
     * @param event event
     * @param expressionObject 表达式
     * @returns
     */
    effect(event, expressionObject) {
        const effectTo = expressionObject.bindingType;
        const eventPath = this.cleanEventPath(event.path);
        const effector = this.effectorFactory.getEffector(expressionObject);
        if (!effector) {
            return;
        }
        const info = this.analysis(event, expressionObject);
        if (!info) {
            console.warn(`[BindingDataRemoveObjectEventHandler][analysis]获取路径信息失败。`);
            return;
        }
        const expressionPaths = expressionObject.path.split('/').filter(p => p);
        if (effectTo === Expression.ExpressionBindingType.Field) {
            const paths = [];
            const propertyPaths = expressionPaths.slice(info.expressionTablePaths.length);
            // 删除场景仅需要计算事件表上面的表
            if (info.distance !== 0) {
                // 表达式和事件不在同一个表，即下级表删除了一批数据
                if (info.eventFromParent === true) {
                    // 在过滤时这种情况的应该就排除掉了
                    console.warn(`[BindingDataRemoveObjectEventHandler][effect_error]`);
                    return;
                }
                else if (info.eventFromChildren === true) {
                    const prevPaths = eventPath.slice(0, eventPath.length - 1);
                    const path = prevPaths.concat(propertyPaths);
                    paths.push(path);
                }
                else {
                    console.warn(`[BindingDataRemoveObjectEventHandler][effect_error]`);
                    return;
                }
            }
            EffectorManager.effect(effector, expressionObject, paths);
        }
        else if (effectTo === Expression.ExpressionBindingType.State) {
            console.error('not supported！');
        }
    }
    /**
     * 获取子表事件行
     * @param paths
     * @param event
     * @returns
     */
    getCurrentRowByEvent(paths, event) {
        return this.getCurrentRowByPaths(paths);
    }
}
BindingDataRemoveObjectEventHandler.decorators = [
    { type: Injectable }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmluZGluZ19kYXRhX3JlbW92ZV9vYmplY3RfZXZlbnRfaGFuZGxlci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL2V2ZW50LWhhbmRsZXIvYmluZGluZ19kYXRhX3JlbW92ZV9vYmplY3RfZXZlbnRfaGFuZGxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUMvRCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNwRCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFFL0M7OztHQUdHO0FBRUgsTUFBTSxPQUFPLG1DQUFvQyxTQUFRLFlBQVk7SUFDbkU7Ozs7T0FJRztJQUNJLE1BQU0sQ0FBQyxLQUEyQjtRQUN2QyxJQUFJLElBQUksQ0FBQyxpQkFBaUIsSUFBSSxJQUFJLENBQUMsaUJBQWlCLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUMvRCxZQUFZO1lBQ1osTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLE1BQU0sQ0FBQyxDQUFDLGdCQUE2QyxFQUFFLEVBQUU7Z0JBQ2xHLElBQUksZ0JBQWdCLENBQUMsRUFBRSxLQUFLLEtBQUssQ0FBQyxFQUFFLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLElBQUksZ0JBQWdCLENBQUMsSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7b0JBQ2xHLE9BQU8sS0FBSyxDQUFDO2lCQUNkO2dCQUNELE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxFQUFFLGdCQUFnQixDQUFDLENBQUM7Z0JBQ3BELElBQUksQ0FBQyxJQUFJLEVBQUU7b0JBQ1QsT0FBTyxLQUFLLENBQUM7aUJBQ2Q7Z0JBQ0QsNkNBQTZDO2dCQUM3QyxNQUFNLGVBQWUsR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDekQsT0FBTztnQkFDUCxJQUFJLGVBQWUsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO29CQUNoQyxJQUFJLGdCQUFnQixDQUFDLFdBQVcsS0FBSyxVQUFVLENBQUMscUJBQXFCLENBQUMsS0FBSyxFQUFFO3dCQUMzRSxPQUFPLEtBQUssQ0FBQztxQkFDZDtpQkFDRjtnQkFDRCxXQUFXO2dCQUNYLGVBQWUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxlQUFlLENBQUMsQ0FBQztnQkFDOUMsMERBQTBEO2dCQUMxRCxvR0FBb0c7Z0JBQ3BHLFdBQVc7Z0JBQ1gsSUFBSSxJQUFJLENBQUMsZUFBZSxDQUFDLE1BQU0sR0FBRyxDQUFDLEtBQUssSUFBSSxDQUFDLG9CQUFvQixDQUFDLE1BQU0sRUFBRTtvQkFDeEUsT0FBTyxLQUFLLENBQUM7aUJBQ2Q7Z0JBQ0QsUUFBUTtnQkFDUixJQUFJLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLGtCQUFrQixDQUFDLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLGtCQUFrQixDQUFDLENBQUMsRUFBRTtvQkFDdkksT0FBTyxLQUFLLENBQUM7aUJBQ2Q7Z0JBQ0QsTUFBTSxLQUFLLEdBQUcsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLEdBQVcsRUFBRSxFQUFFO29CQUM1RCxLQUFLO29CQUNMLElBQUksQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLGtCQUFrQixDQUFDLENBQUMsRUFBRTt3QkFDeEUsT0FBTyxLQUFLLENBQUM7cUJBQ2Q7b0JBQ0QsTUFBTSxJQUFJLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQzlFLE1BQU0sY0FBYyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxDQUFDO29CQUNsRixJQUFJLGNBQWMsSUFBSSxjQUFjLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsa0JBQWtCLENBQUMsS0FBSyxJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsa0JBQWtCLENBQUMsRUFBRTt3QkFDM0ksT0FBTyxJQUFJLENBQUM7cUJBQ2I7b0JBQ0QsT0FBTyxLQUFLLENBQUM7Z0JBQ2YsQ0FBQyxDQUFDLENBQUM7Z0JBQ0gsT0FBTyxLQUFLLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO1lBQ3JDLENBQUMsQ0FBQyxDQUFDO1lBQ0gsT0FBTyxXQUFXLENBQUM7U0FDcEI7SUFDSCxDQUFDO0lBQ0Q7OztPQUdHO0lBQ0ksUUFBUSxDQUFDLEtBQTJCO1FBQ3pDLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDdkMsSUFBSSxXQUFXLElBQUksV0FBVyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDekMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDLGdCQUE2QyxFQUFFLEVBQUU7Z0JBQ3BFLE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxLQUFLLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQztnQkFDdkUsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxnQkFBZ0IsRUFBRSxLQUFLLEVBQUUsYUFBYSxDQUFDLENBQUM7Z0JBQzFFLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLEVBQUUsT0FBTyxDQUFDLENBQUM7Z0JBQ3ZELElBQUksTUFBTSxLQUFLLFNBQVMsSUFBSSxDQUFDLElBQUksQ0FBQyw4QkFBOEIsQ0FBQyxnQkFBZ0IsQ0FBQyxFQUFFO29CQUNsRixPQUFPO2lCQUNSO2dCQUNELGdCQUFnQixDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsa0NBQWtDLENBQUMsZ0JBQWdCLEVBQUUsTUFBTSxDQUFDLENBQUM7Z0JBQUEsQ0FBQztnQkFDN0YsSUFBSSxnQkFBZ0IsQ0FBQyxFQUFFLEVBQUU7b0JBQ3ZCLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLENBQUMsRUFBRSxFQUFFLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxDQUFDO2lCQUN6RTtnQkFDRCxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDO1lBQ3ZDLENBQUMsQ0FBQyxDQUFDO1NBQ0o7SUFDSCxDQUFDO0lBQ0Q7Ozs7O09BS0c7SUFDSSxNQUFNLENBQUMsS0FBMkIsRUFBRSxnQkFBNkM7UUFDdEYsTUFBTSxRQUFRLEdBQUcsZ0JBQWdCLENBQUMsV0FBVyxDQUFDO1FBQzlDLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ2xELE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsV0FBVyxDQUFDLGdCQUFnQixDQUFDLENBQUM7UUFDcEUsSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUNiLE9BQU87U0FDUjtRQUNELE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxFQUFFLGdCQUFnQixDQUFDLENBQUM7UUFDcEQsSUFBSSxDQUFDLElBQUksRUFBRTtZQUNULE9BQU8sQ0FBQyxJQUFJLENBQUMsMERBQTBELENBQUMsQ0FBQztZQUN6RSxPQUFPO1NBQ1I7UUFDRCxNQUFNLGVBQWUsR0FBRyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3hFLElBQUksUUFBUSxLQUFLLFVBQVUsQ0FBQyxxQkFBcUIsQ0FBQyxLQUFLLEVBQUU7WUFDdkQsTUFBTSxLQUFLLEdBQVksRUFBRSxDQUFDO1lBQzFCLE1BQU0sYUFBYSxHQUFHLGVBQWUsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQzlFLG1CQUFtQjtZQUNuQixJQUFJLElBQUksQ0FBQyxRQUFRLEtBQUssQ0FBQyxFQUFFO2dCQUN2QiwyQkFBMkI7Z0JBQzNCLElBQUksSUFBSSxDQUFDLGVBQWUsS0FBSyxJQUFJLEVBQUU7b0JBQ2pDLG1CQUFtQjtvQkFDbkIsT0FBTyxDQUFDLElBQUksQ0FBQyxxREFBcUQsQ0FBQyxDQUFDO29CQUNwRSxPQUFPO2lCQUNSO3FCQUFNLElBQUksSUFBSSxDQUFDLGlCQUFpQixLQUFLLElBQUksRUFBRTtvQkFDMUMsTUFBTSxTQUFTLEdBQUcsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsU0FBUyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQztvQkFDM0QsTUFBTSxJQUFJLEdBQUcsU0FBUyxDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUMsQ0FBQztvQkFDN0MsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztpQkFDbEI7cUJBQU07b0JBQ0wsT0FBTyxDQUFDLElBQUksQ0FBQyxxREFBcUQsQ0FBQyxDQUFDO29CQUNwRSxPQUFPO2lCQUNSO2FBQ0Y7WUFDRCxlQUFlLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxnQkFBZ0IsRUFBRSxLQUFLLENBQUMsQ0FBQztTQUMzRDthQUFNLElBQUksUUFBUSxLQUFLLFVBQVUsQ0FBQyxxQkFBcUIsQ0FBQyxLQUFLLEVBQUU7WUFDOUQsT0FBTyxDQUFDLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1NBQ2pDO0lBQ0gsQ0FBQztJQUNEOzs7OztPQUtHO0lBQ0ksb0JBQW9CLENBQUMsS0FBZSxFQUFFLEtBQTJCO1FBQ3RFLE9BQU8sSUFBSSxDQUFDLG9CQUFvQixDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQzFDLENBQUM7OztZQWhJRixVQUFVIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XHJcbmltcG9ydCB7IEVmZmVjdG9yTWFuYWdlciB9IGZyb20gXCIuLi9lZmZlY3Rvci9lZmZlY3Rvcl9tYW5hZ2VyXCI7XHJcbmltcG9ydCB7IEV4cHJlc3Npb24gfSBmcm9tIFwiLi4vZXhwcmVzc2lvblwiO1xyXG5pbXBvcnQgeyBFTlRJVFlfVEVNUExBVEUgfSBmcm9tIFwiLi4vcmVzb2x2ZXIvaW5kZXhcIjtcclxuaW1wb3J0IHsgRXZlbnRIYW5kbGVyIH0gZnJvbSBcIi4vZXZlbnRfaGFuZGxlclwiO1xyXG5cclxuLyoqXHJcbiAqIOWIoOmZpOaVsOaNruaXtumcgOimgeiuoeeul+eahOihqOi+vuW8j1xyXG4gKiAx44CB5L6d6LWW6KKr5Yig6Zmk5pWw5o2u6KGo55qE5LiK57qn6KGo6L6+5byP77yI5LiN6ICD6JmR5ZCM6KGo5YaF55qE6IGa5ZCI5L6d6LWW77yJXHJcbiAqL1xyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBCaW5kaW5nRGF0YVJlbW92ZU9iamVjdEV2ZW50SGFuZGxlciBleHRlbmRzIEV2ZW50SGFuZGxlciB7XHJcbiAgLyoqXHJcbiAgICog6L+H5ruk5Ye66ZyA6KaB6K6h566X55qE6KGo6L6+5byPXHJcbiAgICogQHBhcmFtIGV2ZW50IGV2ZW50XHJcbiAgICogQHJldHVybnMgXHJcbiAgICovXHJcbiAgcHVibGljIGZpbHRlcihldmVudDogRXhwcmVzc2lvbi5FdmVudEFyZ3MpIHtcclxuICAgIGlmICh0aGlzLmV4cHJlc3Npb25PYmplY3RzICYmIHRoaXMuZXhwcmVzc2lvbk9iamVjdHMubGVuZ3RoID4gMCkge1xyXG4gICAgICAvLyDmib7liLDogZrlkIjnm7jlhbPooajovr7lvI9cclxuICAgICAgY29uc3QgZXhwcmVzc2lvbnMgPSB0aGlzLmV4cHJlc3Npb25PYmplY3RzLmZpbHRlcigoZXhwcmVzc2lvbk9iamVjdDogRXhwcmVzc2lvbi5FeHByZXNzaW9uT2JqZWN0KSA9PiB7XHJcbiAgICAgICAgaWYgKGV4cHJlc3Npb25PYmplY3QubnMgIT09IGV2ZW50Lm5zIHx8ICFleHByZXNzaW9uT2JqZWN0LmRlcHMgfHwgZXhwcmVzc2lvbk9iamVjdC5kZXBzLmxlbmd0aCA8IDEpIHtcclxuICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgaW5mbyA9IHRoaXMuYW5hbHlzaXMoZXZlbnQsIGV4cHJlc3Npb25PYmplY3QpO1xyXG4gICAgICAgIGlmICghaW5mbykge1xyXG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBldmVudC5wYXRoIGxpa2UgW2lkOnh4eHhdIG9yIFtpZDp4eHh4LOWtkOihqHNdXHJcbiAgICAgICAgY29uc3QgZXZlbnRUYWJsZVBhdGhzID0gdGhpcy5idWlsZEVudGl0eVBhdGgoZXZlbnQucGF0aCk7XHJcbiAgICAgICAgLy8g5Li76KGo5Yig6ZmkXHJcbiAgICAgICAgaWYgKGV2ZW50VGFibGVQYXRocy5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgIGlmIChleHByZXNzaW9uT2JqZWN0LmJpbmRpbmdUeXBlID09PSBFeHByZXNzaW9uLkV4cHJlc3Npb25CaW5kaW5nVHlwZS5GaWVsZCkge1xyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIOS7juihqOaIluS7juS7juihqOWIoOmZpFxyXG4gICAgICAgIGV2ZW50VGFibGVQYXRocy5zcGxpY2UoMCwgMCwgRU5USVRZX1RFTVBMQVRFKTtcclxuICAgICAgICAvLyBldmVudEVudGl0eVBhdGggbGlrZSBbJ0VOVElUWX4nLCdmb3JtRUVVUjFFMXMnXSAvLyDku47ooajmlrDlop5cclxuICAgICAgICAvLyBkZXBzIGxpa2UgWydFTlRJVFl+L2Zvcm1FRVVSMUUxcy91ZHQvdWR0X2ZpZWxkJywnRU5USVRZfi9mb3JtRUVVUjFFMXMvcmVmL3JlZl91ZHQvcmVmX3VkdF9maWVsZCddXHJcbiAgICAgICAgLy8g5LuF5aSE55CG5LiK57qn6KGo6L6+5byPXHJcbiAgICAgICAgaWYgKGluZm8uZXZlbnRUYWJsZVBhdGhzLmxlbmd0aCAtIDEgIT09IGluZm8uZXhwcmVzc2lvblRhYmxlUGF0aHMubGVuZ3RoKSB7XHJcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIOS4jeaUr+aMgei3qOihqFxyXG4gICAgICAgIGlmICghaW5mby5ldmVudFRhYmxlUGF0aHMuam9pbihFeHByZXNzaW9uLkRFUEVOREVOQ1lfU1BMSVRFUikuc3RhcnRzV2l0aChpbmZvLmV4cHJlc3Npb25UYWJsZVBhdGhzLmpvaW4oRXhwcmVzc2lvbi5ERVBFTkRFTkNZX1NQTElURVIpKSkge1xyXG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBpbmRleCA9IGV4cHJlc3Npb25PYmplY3QuZGVwcy5maW5kSW5kZXgoKGRlcDogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgICAvLyDkvp3otZZcclxuICAgICAgICAgIGlmICghZGVwLnN0YXJ0c1dpdGgoZXZlbnRUYWJsZVBhdGhzLmpvaW4oRXhwcmVzc2lvbi5ERVBFTkRFTkNZX1NQTElURVIpKSkge1xyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBjb25zdCBkZXBzID0gZGVwLnNwbGl0KEV4cHJlc3Npb24uREVQRU5ERU5DWV9TUExJVEVSKS5maWx0ZXIocCA9PiBwKS5zbGljZSgxKTtcclxuICAgICAgICAgIGNvbnN0IGRlcGVuZFBhdGhJbmZvID0gdGhpcy5nZXRQYXRoSW5mbyhkZXBzLmpvaW4oRXhwcmVzc2lvbi5ERVBFTkRFTkNZX1NQTElURVIpKTtcclxuICAgICAgICAgIGlmIChkZXBlbmRQYXRoSW5mbyAmJiBkZXBlbmRQYXRoSW5mby5wYXRocy5qb2luKEV4cHJlc3Npb24uREVQRU5ERU5DWV9TUExJVEVSKSA9PT0gaW5mby5ldmVudFRhYmxlUGF0aHMuam9pbihFeHByZXNzaW9uLkRFUEVOREVOQ1lfU1BMSVRFUikpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcmV0dXJuIGluZGV4ID09PSAtMSA/IGZhbHNlIDogdHJ1ZTtcclxuICAgICAgfSk7XHJcbiAgICAgIHJldHVybiBleHByZXNzaW9ucztcclxuICAgIH1cclxuICB9XHJcbiAgLyoqXHJcbiAgICog5Y+R5biD5LqL5Lu2XHJcbiAgICogQHBhcmFtIGV2ZW50IGV2ZW50XHJcbiAgICovXHJcbiAgcHVibGljIGRpc3BhdGNoKGV2ZW50OiBFeHByZXNzaW9uLkV2ZW50QXJncykge1xyXG4gICAgY29uc3QgZXhwcmVzc2lvbnMgPSB0aGlzLmZpbHRlcihldmVudCk7XHJcbiAgICBpZiAoZXhwcmVzc2lvbnMgJiYgZXhwcmVzc2lvbnMubGVuZ3RoID4gMCkge1xyXG4gICAgICBleHByZXNzaW9ucy5mb3JFYWNoKChleHByZXNzaW9uT2JqZWN0OiBFeHByZXNzaW9uLkV4cHJlc3Npb25PYmplY3QpID0+IHtcclxuICAgICAgICBjb25zdCBlbnRpdHlDb250ZXh0ID0gdGhpcy5idWlsZEVudGl0eUNvbnRleHQoZXZlbnQsIGV4cHJlc3Npb25PYmplY3QpO1xyXG4gICAgICAgIGNvbnN0IGNvbnRleHQgPSB0aGlzLmJ1aWxkQ29udGV4dChleHByZXNzaW9uT2JqZWN0LCBldmVudCwgZW50aXR5Q29udGV4dCk7XHJcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gdGhpcy5wZXJmb3JtKGV4cHJlc3Npb25PYmplY3QsIGNvbnRleHQpO1xyXG4gICAgICAgIGlmIChyZXN1bHQgPT09IHVuZGVmaW5lZCAmJiAhdGhpcy5pc1ZhbGlkYXRlT3JSZXF1aXJlZEV4cHJlc3Npb24oZXhwcmVzc2lvbk9iamVjdCkpIHtcclxuICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgZXhwcmVzc2lvbk9iamVjdC5yZXN1bHQgPSB0aGlzLmNvbnZlcnRCb29sZWFuVHlwZUV4cHJlc3Npb25SZXN1bHQoZXhwcmVzc2lvbk9iamVjdCwgcmVzdWx0KTs7XHJcbiAgICAgICAgaWYgKGV4cHJlc3Npb25PYmplY3QuaWQpIHtcclxuICAgICAgICAgIHRoaXMuZXhwcmVzc2lvblJlc3VsdC5zZXQoZXhwcmVzc2lvbk9iamVjdC5pZCwgZXhwcmVzc2lvbk9iamVjdC5yZXN1bHQpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmVmZmVjdChldmVudCwgZXhwcmVzc2lvbk9iamVjdCk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH1cclxuICAvKipcclxuICAgKiDliKDpmaTlia/kvZznlKjlmahcclxuICAgKiBAcGFyYW0gZXZlbnQgZXZlbnRcclxuICAgKiBAcGFyYW0gZXhwcmVzc2lvbk9iamVjdCDooajovr7lvI9cclxuICAgKiBAcmV0dXJucyBcclxuICAgKi9cclxuICBwdWJsaWMgZWZmZWN0KGV2ZW50OiBFeHByZXNzaW9uLkV2ZW50QXJncywgZXhwcmVzc2lvbk9iamVjdDogRXhwcmVzc2lvbi5FeHByZXNzaW9uT2JqZWN0KTogdm9pZCB7XHJcbiAgICBjb25zdCBlZmZlY3RUbyA9IGV4cHJlc3Npb25PYmplY3QuYmluZGluZ1R5cGU7XHJcbiAgICBjb25zdCBldmVudFBhdGggPSB0aGlzLmNsZWFuRXZlbnRQYXRoKGV2ZW50LnBhdGgpO1xyXG4gICAgY29uc3QgZWZmZWN0b3IgPSB0aGlzLmVmZmVjdG9yRmFjdG9yeS5nZXRFZmZlY3RvcihleHByZXNzaW9uT2JqZWN0KTtcclxuICAgIGlmICghZWZmZWN0b3IpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgY29uc3QgaW5mbyA9IHRoaXMuYW5hbHlzaXMoZXZlbnQsIGV4cHJlc3Npb25PYmplY3QpO1xyXG4gICAgaWYgKCFpbmZvKSB7XHJcbiAgICAgIGNvbnNvbGUud2FybihgW0JpbmRpbmdEYXRhUmVtb3ZlT2JqZWN0RXZlbnRIYW5kbGVyXVthbmFseXNpc13ojrflj5bot6/lvoTkv6Hmga/lpLHotKXjgIJgKTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgY29uc3QgZXhwcmVzc2lvblBhdGhzID0gZXhwcmVzc2lvbk9iamVjdC5wYXRoLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCk7XHJcbiAgICBpZiAoZWZmZWN0VG8gPT09IEV4cHJlc3Npb24uRXhwcmVzc2lvbkJpbmRpbmdUeXBlLkZpZWxkKSB7XHJcbiAgICAgIGNvbnN0IHBhdGhzOiBhbnlbXVtdID0gW107XHJcbiAgICAgIGNvbnN0IHByb3BlcnR5UGF0aHMgPSBleHByZXNzaW9uUGF0aHMuc2xpY2UoaW5mby5leHByZXNzaW9uVGFibGVQYXRocy5sZW5ndGgpO1xyXG4gICAgICAvLyDliKDpmaTlnLrmma/ku4XpnIDopoHorqHnrpfkuovku7booajkuIrpnaLnmoTooahcclxuICAgICAgaWYgKGluZm8uZGlzdGFuY2UgIT09IDApIHtcclxuICAgICAgICAvLyDooajovr7lvI/lkozkuovku7bkuI3lnKjlkIzkuIDkuKrooajvvIzljbPkuIvnuqfooajliKDpmaTkuobkuIDmibnmlbDmja5cclxuICAgICAgICBpZiAoaW5mby5ldmVudEZyb21QYXJlbnQgPT09IHRydWUpIHtcclxuICAgICAgICAgIC8vIOWcqOi/h+a7pOaXtui/meenjeaDheWGteeahOW6lOivpeWwseaOkumZpOaOieS6hlxyXG4gICAgICAgICAgY29uc29sZS53YXJuKGBbQmluZGluZ0RhdGFSZW1vdmVPYmplY3RFdmVudEhhbmRsZXJdW2VmZmVjdF9lcnJvcl1gKTtcclxuICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9IGVsc2UgaWYgKGluZm8uZXZlbnRGcm9tQ2hpbGRyZW4gPT09IHRydWUpIHtcclxuICAgICAgICAgIGNvbnN0IHByZXZQYXRocyA9IGV2ZW50UGF0aC5zbGljZSgwLCBldmVudFBhdGgubGVuZ3RoIC0gMSk7XHJcbiAgICAgICAgICBjb25zdCBwYXRoID0gcHJldlBhdGhzLmNvbmNhdChwcm9wZXJ0eVBhdGhzKTtcclxuICAgICAgICAgIHBhdGhzLnB1c2gocGF0aCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIGNvbnNvbGUud2FybihgW0JpbmRpbmdEYXRhUmVtb3ZlT2JqZWN0RXZlbnRIYW5kbGVyXVtlZmZlY3RfZXJyb3JdYCk7XHJcbiAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIEVmZmVjdG9yTWFuYWdlci5lZmZlY3QoZWZmZWN0b3IsIGV4cHJlc3Npb25PYmplY3QsIHBhdGhzKTtcclxuICAgIH0gZWxzZSBpZiAoZWZmZWN0VG8gPT09IEV4cHJlc3Npb24uRXhwcmVzc2lvbkJpbmRpbmdUeXBlLlN0YXRlKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ25vdCBzdXBwb3J0ZWTvvIEnKTtcclxuICAgIH1cclxuICB9XHJcbiAgLyoqXHJcbiAgICog6I635Y+W5a2Q6KGo5LqL5Lu26KGMXHJcbiAgICogQHBhcmFtIHBhdGhzIFxyXG4gICAqIEBwYXJhbSBldmVudCBcclxuICAgKiBAcmV0dXJucyBcclxuICAgKi9cclxuICBwdWJsaWMgZ2V0Q3VycmVudFJvd0J5RXZlbnQocGF0aHM6IHN0cmluZ1tdLCBldmVudDogRXhwcmVzc2lvbi5FdmVudEFyZ3MpOiBudWxsIHwgeyBbcHJvcDogc3RyaW5nXTogYW55IH0ge1xyXG4gICAgcmV0dXJuIHRoaXMuZ2V0Q3VycmVudFJvd0J5UGF0aHMocGF0aHMpO1xyXG4gIH1cclxufSJdfQ==