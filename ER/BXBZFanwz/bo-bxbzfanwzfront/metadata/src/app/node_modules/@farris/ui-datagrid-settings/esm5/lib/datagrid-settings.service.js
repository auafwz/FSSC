/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { map, switchMap } from 'rxjs/operators';
import { of } from 'rxjs';
import { Injectable, Injector, InjectionToken, ComponentFactoryResolver, ApplicationRef } from '@angular/core';
import { BsModalService } from '@farris/ui-modal';
import { MessagerService } from '@farris/ui-messager';
import { DatagridSettingsComponent } from './datagrid-settings.component';
import { cloneDeep } from 'lodash-es';
import { LocaleService } from '@farris/ui-locale';
import { IdService } from '@farris/ui-common';
import { SimpleColumnsComponent } from './simple-mode/simple-columns.component';
/** @type {?} */
export var GRID_SETTINGS_WEBAPI = new InjectionToken(' Farris DataGrid User Setting WebApi URI.');
var DatagridSettingsService = /** @class */ (function () {
    function DatagridSettingsService(injector, modalSer, messager, idService, localeSer) {
        this.injector = injector;
        this.modalSer = modalSer;
        this.messager = messager;
        this.idService = idService;
        this.localeSer = localeSer;
        this.multiSortMsg = '列表中未开启多列排序的功能。 请检查！';
        this.columnsSortableMsg = '未开启列的排序功能。请检查！';
        this.notSupportHeaderGroupMsg = '暂不支持多表头设置';
        this.notShowDialog = '多表头暂不支持列显示设置；同时未启用列排序功能。';
        this.gridInstance = null;
        this.gridRefs = null;
        this.saving = false;
        this.cfr = null;
        this.app = null;
        this.cfr = this.injector.get(ComponentFactoryResolver);
        this.app = this.injector.get(ApplicationRef);
    }
    /**
     * @param {?=} id
     * @return {?}
     */
    DatagridSettingsService.prototype.destroy = /**
     * @param {?=} id
     * @return {?}
     */
    function (id) {
        if (id && this.gridRefs && this.gridRefs[id]) {
            delete this.gridRefs[id];
        }
        else {
            this.gridRefs = null;
        }
    };
    /**
     * @param {?} dg
     * @return {?}
     */
    DatagridSettingsService.prototype.registerGridInstance = /**
     * @param {?} dg
     * @return {?}
     */
    function (dg) {
        if (!dg) {
            console.log('DatagridSettingService: grid instance is null.');
            return;
        }
        /** @type {?} */
        var id = dg.id;
        this.gridRefs = this.gridRefs || {};
        if (!this.gridRefs[id]) {
            this.gridRefs[id] = dg;
        }
    };
    /**
     * @param {?} dgID
     * @return {?}
     */
    DatagridSettingsService.prototype.getGridInstance = /**
     * @param {?} dgID
     * @return {?}
     */
    function (dgID) {
        return this.gridRefs ? this.gridRefs[dgID] : null;
    };
    /**
     * @return {?}
     */
    DatagridSettingsService.prototype.getSearchTypes = /**
     * @return {?}
     */
    function () {
        return [
            { value: 'all', title: this.localeSer.getValue('datagrid.settings.allColumns') },
            { value: 'visible', title: this.localeSer.getValue('datagrid.settings.visibleColumns') },
            { value: 'hidden', title: this.localeSer.getValue('datagrid.settings.hiddenColumns') }
        ];
    };
    /**
     * @param {?} gridInstance
     * @return {?}
     */
    DatagridSettingsService.prototype.showSimple = /**
     * @param {?} gridInstance
     * @return {?}
     */
    function (gridInstance) {
        var _this = this;
        /** @type {?} */
        var columns = this.convertColumnsToSimple(gridInstance.columns);
        columns[0] = columns[0].filter((/**
         * @param {?} n
         * @return {?}
         */
        function (n) { return n.field && n.field !== gridInstance.ControlPanelFeild; }));
        /** @type {?} */
        var searchTypes = this.getSearchTypes();
        if (this.cfr) {
            /** @type {?} */
            var cmpFactory = this.cfr.resolveComponentFactory(SimpleColumnsComponent);
            /** @type {?} */
            var simpleRef_1 = cmpFactory.create(this.injector);
            this.app.attachView(simpleRef_1.hostView);
            simpleRef_1.instance.columns = columns;
            simpleRef_1.instance.seartTypes = searchTypes;
            simpleRef_1.instance.gridInstance = gridInstance;
            if (document.querySelector('#page-wrapper')) {
                simpleRef_1.instance.top = 76;
            }
            document.body.appendChild(simpleRef_1.location.nativeElement);
            simpleRef_1.instance.closed.subscribe((/**
             * @return {?}
             */
            function () {
                simpleRef_1.location.nativeElement.remove();
                simpleRef_1.destroy();
                simpleRef_1 = null;
            }));
            simpleRef_1.instance.advanced.subscribe((/**
             * @return {?}
             */
            function () {
                _this.showAdvanced(gridInstance);
            }));
            simpleRef_1.instance.submit.subscribe((/**
             * @param {?} e
             * @return {?}
             */
            function (e) {
                e.target.disabled = true;
                if (_this.saving) {
                    return;
                }
                if (!_this.saving) {
                    _this.updateGridView(e, gridInstance, e.target);
                }
            }));
            simpleRef_1.hostView.detectChanges();
            return simpleRef_1;
        }
    };
    /**
     * @param {?} gridInstance
     * @param {?=} opts
     * @return {?}
     */
    DatagridSettingsService.prototype.show = /**
     * @param {?} gridInstance
     * @param {?=} opts
     * @return {?}
     */
    function (gridInstance, opts) {
        this.registerGridInstance(gridInstance);
        if (gridInstance.enableSimpleMode) {
            return this.showSimple(gridInstance);
        }
        else {
            return this.showAdvanced(gridInstance, opts);
        }
    };
    /**
     * @private
     * @param {?} gridInstance
     * @param {?=} opts
     * @return {?}
     */
    DatagridSettingsService.prototype.showAdvanced = /**
     * @private
     * @param {?} gridInstance
     * @param {?=} opts
     * @return {?}
     */
    function (gridInstance, opts) {
        var _this = this;
        /** @type {?} */
        var _editColSortInfo = true;
        /** @type {?} */
        var editColSortInfo = this.canSetColumnSort(gridInstance);
        if (editColSortInfo !== true) {
            // this.messager.warning(msg);
            // return;
            _editColSortInfo = false;
        }
        /** @type {?} */
        var showSetColumnsTab = !this.isHeaderGroup(gridInstance);
        /** @type {?} */
        var getActiveTabIndex = (/**
         * @return {?}
         */
        function () {
            if (showSetColumnsTab) {
                return 1;
            }
            else {
                if (_editColSortInfo) {
                    return 2;
                }
                else {
                    return -1;
                }
            }
        });
        /** @type {?} */
        var activeTabIndex = getActiveTabIndex();
        if (activeTabIndex === -1) {
            this.messager.warning(this.notShowDialog);
            return;
        }
        /** @type {?} */
        var columns = this.convertColumnsToSimple(gridInstance.columns);
        columns[0] = columns[0].filter((/**
         * @param {?} n
         * @return {?}
         */
        function (n) { return n.field && n.field !== gridInstance.ControlPanelFeild; }));
        /** @type {?} */
        var treeData = this.convertColumns2TreeData(cloneDeep(columns), true);
        /** @type {?} */
        var viewColumnsTreeData = this.convertColumns2TreeData(cloneDeep(columns), false);
        this.checkViewTreeNodes(viewColumnsTreeData);
        /** @type {?} */
        var modalRef = null;
        /** @type {?} */
        var okText = this.localeSer.getValue('datagrid.settings.ok') || '确定';
        /** @type {?} */
        var cancelText = this.localeSer.getValue('datagrid.settings.cancel') || '取消';
        /** @type {?} */
        var resetText = this.localeSer.getValue('datagrid.settings.reset') || '重置';
        /** @type {?} */
        var defaultOpts = {
            width: 760, height: 560, showHeader: false, title: '控制面板',
            initialState: {
                columns: columns,
                sortTreeData: treeData,
                viewTreeData: viewColumnsTreeData,
                gridInstance: gridInstance,
                canSetColumnSort: _editColSortInfo,
                canSetColumnVisible: showSetColumnsTab,
                activeTabIndex: activeTabIndex
            },
            showButtons: false
        };
        /** @type {?} */
        var modalOpts = Object.assign(defaultOpts, opts || {});
        modalRef = this.modalSer.show(DatagridSettingsComponent, modalOpts);
        /** @type {?} */
        var instance = (/** @type {?} */ (modalRef.content));
        instance.enableReset = true;
        instance.modalRef = modalRef;
        instance.canSetColumnSort = _editColSortInfo;
        instance.canSetColumnVisible = !this.isHeaderGroup(gridInstance);
        instance.submitHandle.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        function (e) {
            e.target.disabled = true;
            if (_this.saving) {
                return;
            }
            if (!_this.saving) {
                _this.updateGridView(modalRef, gridInstance, e.target);
            }
        }));
        instance.cancelHandle.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        function (e) {
            modalRef.close();
        }));
        instance.concise.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        function (e) {
            modalRef.close();
            _this.showSimple(gridInstance);
        }));
        /** @type {?} */
        var modalContainer = (/** @type {?} */ (modalRef.dialog.instance));
        modalContainer.draggbar.handle = instance.header.nativeElement;
        return modalRef;
    };
    /**
     * @private
     * @param {?} gridInstance
     * @return {?}
     */
    DatagridSettingsService.prototype.canSetColumnSort = /**
     * @private
     * @param {?} gridInstance
     * @return {?}
     */
    function (gridInstance) {
        if (gridInstance.multiSort && this.hasEnableSortColumns(gridInstance)) {
            return true;
        }
        else {
            if (!this.hasEnableSortColumns(gridInstance)) {
                return this.columnsSortableMsg;
            }
            else if (!gridInstance.multiSort) {
                return this.multiSortMsg;
            }
        }
    };
    /**
     * @private
     * @param {?} gridInstance
     * @return {?}
     */
    DatagridSettingsService.prototype.hasEnableSortColumns = /**
     * @private
     * @param {?} gridInstance
     * @return {?}
     */
    function (gridInstance) {
        /** @type {?} */
        var sortColumnsCount = gridInstance.flatColumns.reduce((/**
         * @param {?} c
         * @param {?} r
         * @return {?}
         */
        function (c, r) {
            if (r.sortable) {
                return c + 1;
            }
            return c;
        }), 0);
        return sortColumnsCount > 0;
    };
    /**
     * @private
     * @param {?} grid
     * @return {?}
     */
    DatagridSettingsService.prototype.isHeaderGroup = /**
     * @private
     * @param {?} grid
     * @return {?}
     */
    function (grid) {
        /** @type {?} */
        var flag = grid.columns.length > 1;
        if (flag) {
            return this.notSupportHeaderGroupMsg;
        }
        return flag;
    };
    /**
     * @private
     * @param {?} cols
     * @param {?} rowIndex
     * @param {?} colStartIndex
     * @param {?} colCount
     * @param {?=} forSort
     * @return {?}
     */
    DatagridSettingsService.prototype.getChilds = /**
     * @private
     * @param {?} cols
     * @param {?} rowIndex
     * @param {?} colStartIndex
     * @param {?} colCount
     * @param {?=} forSort
     * @return {?}
     */
    function (cols, rowIndex, colStartIndex, colCount, forSort) {
        var _this = this;
        if (forSort === void 0) { forSort = false; }
        /** @type {?} */
        var childCols = [];
        /** @type {?} */
        var _count = colStartIndex;
        if (!cols[rowIndex]) {
            return [];
        }
        cols[rowIndex].slice().forEach((/**
         * @param {?} element
         * @return {?}
         */
        function (element) {
            _count = _count + element.colspan;
            if (_count <= colCount) {
                childCols.push(element);
            }
        }));
        cols[rowIndex].splice(0, childCols.length);
        return childCols.map((/**
         * @param {?} c
         * @param {?} i
         * @return {?}
         */
        function (c, i) {
            /** @type {?} */
            var n = {
                data: c,
                selectable: forSort ? !!c.sortable : true
            };
            if (c.colspan && c.colspan > 1) {
                n = {
                    data: c,
                    selectable: false,
                    expanded: true,
                    children: _this.getChilds(cols, rowIndex + 1, 0, c.colspan)
                };
            }
            return n;
        }));
    };
    /**
     * @param {?} cols
     * @param {?=} forSort
     * @return {?}
     */
    DatagridSettingsService.prototype.convertColumns2TreeData = /**
     * @param {?} cols
     * @param {?=} forSort
     * @return {?}
     */
    function (cols, forSort) {
        var _this = this;
        if (forSort === void 0) { forSort = false; }
        /** @type {?} */
        var columns = cols.map((/**
         * @param {?} c
         * @return {?}
         */
        function (c) {
            c.map((/**
             * @param {?} _
             * @return {?}
             */
            function (_) {
                _.colspan = _.colspan || 1;
                return _;
            }));
            return c;
        }));
        if (columns.length === 1) {
            return columns[0].map((/**
             * @param {?} c
             * @return {?}
             */
            function (c) {
                return {
                    data: c,
                    selectable: forSort ? !!c.sortable : true
                };
            }));
        }
        else {
            return columns[0].map((/**
             * @param {?} c
             * @param {?} i
             * @return {?}
             */
            function (c, i) {
                if (c.colspan && c.colspan > 1) {
                    return {
                        data: c,
                        selectable: false,
                        expanded: true,
                        children: _this.getChilds(columns, 1, 0, c.colspan, forSort)
                    };
                }
                else {
                    return {
                        data: c,
                        selectable: forSort ? !!c.sortable : true
                    };
                }
            }));
        }
    };
    /**
     * @private
     * @param {?} treeNodes
     * @return {?}
     */
    DatagridSettingsService.prototype.checkViewTreeNodes = /**
     * @private
     * @param {?} treeNodes
     * @return {?}
     */
    function (treeNodes) {
        var _this = this;
        treeNodes.forEach((/**
         * @param {?} tn
         * @return {?}
         */
        function (tn) {
            if (!tn.children || !tn.children.length) {
                tn.selectable = true;
            }
            else {
                tn.selectable = false;
                _this.checkViewTreeNodes(tn.children);
            }
        }));
    };
    /**
     * @private
     * @param {?} cols
     * @return {?}
     */
    DatagridSettingsService.prototype.convertColumnsToSimple = /**
     * @private
     * @param {?} cols
     * @return {?}
     */
    function (cols) {
        // 移除设置列
        return cols.map((/**
         * @param {?} _cols
         * @return {?}
         */
        function (_cols) {
            return _cols.map((/**
             * @param {?} c
             * @return {?}
             */
            function (c) {
                if (c.field !== '_datagrid-setting-control_') {
                    return {
                        field: c.field,
                        title: c.title,
                        colspan: c.colspan,
                        rowspan: c.rowspan,
                        sortable: c.sortable,
                        order: c.order,
                        halign: c.halign || 'left',
                        align: c.align || 'left',
                        visible: c.visible,
                        allowGrouping: c.allowGrouping,
                        groupFooter: c.groupFooter,
                        footer: c.footer,
                        width: c.width || 100,
                        dataType: c.dataType || 'string'
                    };
                }
            })).filter((/**
             * @param {?} n
             * @return {?}
             */
            function (n) { return n; }));
        }));
    };
    /**
     * @private
     * @param {?} gridInstance
     * @return {?}
     */
    DatagridSettingsService.prototype.resetGridView = /**
     * @private
     * @param {?} gridInstance
     * @return {?}
     */
    function (gridInstance) {
        if (!gridInstance) {
            return;
        }
        /** @type {?} */
        var dfs = gridInstance.dfs;
        if (dfs) {
            /** @type {?} */
            var options = dfs['_state'].initialOptions;
            if (options.sort) {
                if (options.sort.sortName) {
                    gridInstance.sortName = options.sort.sortName;
                }
                if (options.sort.sortOrder) {
                    gridInstance.sortOrder = options.sort.sortOrder;
                }
            }
            gridInstance.groupField = options.groupField || '';
            // TODO: 还需要修正默认列的显示顺序
            if (options.columnFields && options.columnFields.length) {
                /** @type {?} */
                var newColumns_1 = [];
                options.columnFields.forEach((/**
                 * @param {?} c
                 * @return {?}
                 */
                function (c) {
                    /** @type {?} */
                    var col = gridInstance.columns[0].find((/**
                     * @param {?} n
                     * @return {?}
                     */
                    function (n) { return n.field === c.field; }));
                    if (col) {
                        col.visible = c.visible;
                        col.halign = c.halign;
                        col.align = c.align;
                        col.width = c.width;
                        col.footer = c.footer;
                        col.groupFooter = c.groupFooter;
                        newColumns_1.push(col);
                    }
                }));
                gridInstance.columns[0] = newColumns_1;
            }
            // gridInstance['checkOptions']();
            gridInstance['columnsChanged']();
        }
    };
    /**
     * @private
     * @param {?} modalRef
     * @param {?} gridInstance
     * @param {?=} btn
     * @return {?}
     */
    DatagridSettingsService.prototype.updateGridView = /**
     * @private
     * @param {?} modalRef
     * @param {?} gridInstance
     * @param {?=} btn
     * @return {?}
     */
    function (modalRef, gridInstance, btn) {
        var _this = this;
        if (btn === void 0) { btn = null; }
        /** @type {?} */
        var settings = modalRef.content;
        if (settings) {
            /** @type {?} */
            var key = this.createConfigKey(gridInstance.id);
            var sortInfo_1 = settings.sortInfo, viewColumns_1 = settings.viewColumns, columnFormat_1 = settings.columnFormat, groupFields = settings.groupFields;
            this.saving = true;
            /** @type {?} */
            var groupField = '';
            if (gridInstance.groupRows && groupFields && groupFields.length) {
                groupField = groupFields.join(',');
            }
            gridInstance.groupField = groupField;
            this.setUserConfig(key, { sortInfo: sortInfo_1, viewColumns: viewColumns_1, groupField: groupField, columnFormat: columnFormat_1 }).subscribe((/**
             * @return {?}
             */
            function () {
                if (btn) {
                    btn.disabled = false;
                }
                _this.saving = false;
                modalRef.close();
                if (sortInfo_1 && Object.keys(sortInfo_1).length) {
                    var sortName = sortInfo_1.sortName, sortOrder = sortInfo_1.sortOrder;
                    if (sortName && sortName.length) {
                        gridInstance.sort(sortName.join(','), sortOrder.join(','));
                    }
                    else {
                        gridInstance.clearSort();
                    }
                }
                else {
                    gridInstance.clearSort();
                }
                if (viewColumns_1 && viewColumns_1.length) {
                    gridInstance.columns = gridInstance.columns.map((/**
                     * @param {?} cols
                     * @return {?}
                     */
                    function (cols) {
                        _this.updateColumnFormat(cols, columnFormat_1, gridInstance);
                        return _this.newVisibleOrderColumns(cols, viewColumns_1, columnFormat_1);
                    }));
                }
                gridInstance.columnsChanged(true);
            }));
        }
        else {
            modalRef.close();
        }
    };
    /**
     * @param {?} cols
     * @param {?} viewColumns
     * @param {?} columnFormat
     * @return {?}
     */
    DatagridSettingsService.prototype.newVisibleOrderColumns = /**
     * @param {?} cols
     * @param {?} viewColumns
     * @param {?} columnFormat
     * @return {?}
     */
    function (cols, viewColumns, columnFormat) {
        var _this = this;
        /** @type {?} */
        var hideColumns = [];
        cols.forEach((/**
         * @param {?} element
         * @param {?} index
         * @return {?}
         */
        function (element, index) {
            if (_this.isNewAddColumn(element.field, columnFormat) && element.field !== '_datagrid-setting-control_') {
                viewColumns.push(element.field);
            }
            else {
                element.visible = viewColumns.includes(element.field);
                if (!element.visible) {
                    hideColumns.push(element);
                }
            }
        }));
        // 清理不存在的列
        /** @type {?} */
        var newCols = viewColumns.map((/**
         * @param {?} field
         * @return {?}
         */
        function (field) {
            return cols.find((/**
             * @param {?} c
             * @return {?}
             */
            function (c) { return c.field === field; }));
        })).filter((/**
         * @param {?} n
         * @return {?}
         */
        function (n) { return n; }));
        if (hideColumns.length) {
            newCols = newCols.concat(hideColumns);
        }
        return newCols.filter((/**
         * @param {?} c
         * @return {?}
         */
        function (c) { return c && c.field && c.field !== '_datagrid-setting-control_'; }));
    };
    /**
     * 是否为新增加的字段
     * 新增的字段，需要在列表中展示出来，并保存到个性化设置中
     */
    /**
     * 是否为新增加的字段
     * 新增的字段，需要在列表中展示出来，并保存到个性化设置中
     * @private
     * @param {?} field
     * @param {?} columns
     * @return {?}
     */
    DatagridSettingsService.prototype.isNewAddColumn = /**
     * 是否为新增加的字段
     * 新增的字段，需要在列表中展示出来，并保存到个性化设置中
     * @private
     * @param {?} field
     * @param {?} columns
     * @return {?}
     */
    function (field, columns) {
        return !columns.find((/**
         * @param {?} c
         * @return {?}
         */
        function (c) { return c.field === field; }));
    };
    /**
     * @param {?} cols
     * @param {?} columnFormat
     * @param {?} gridInstance
     * @return {?}
     */
    DatagridSettingsService.prototype.updateColumnFormat = /**
     * @param {?} cols
     * @param {?} columnFormat
     * @param {?} gridInstance
     * @return {?}
     */
    function (cols, columnFormat, gridInstance) {
        if (columnFormat && columnFormat.length) {
            cols.forEach((/**
             * @param {?} col
             * @return {?}
             */
            function (col) {
                /** @type {?} */
                var formatCol = columnFormat.find((/**
                 * @param {?} f
                 * @return {?}
                 */
                function (f) { return f.field === col.field; }));
                if (formatCol) {
                    col.width = formatCol.width;
                    col.halign = formatCol.halign || 'left';
                    col.align = formatCol.align || 'left';
                    if (gridInstance.groupRows && (col.allowGrouping || col.allowGrouping === undefined)) {
                        if (!col.groupFooter) {
                            col.groupFooter = formatCol.groupFooter;
                        }
                        if (col.groupFooter && col.groupFooter.options) {
                            col.groupFooter.options.text = formatCol.groupFooter.options.text || '';
                            col.groupFooter.options.calculationType =
                                formatCol.groupFooter.options.calculationType !== undefined &&
                                    formatCol.groupFooter.options.calculationType !== null ?
                                    parseInt(formatCol.groupFooter.options.calculationType, 10) : -1;
                        }
                    }
                    if (gridInstance.showFooter && !gridInstance.footerTemplate) {
                        if (!col.footer) {
                            col.footer = formatCol.footer;
                        }
                        if (col.footer && col.footer.options) {
                            col.footer.options.text = formatCol.footer.options.text || '';
                            col.footer.options.calculationType =
                                formatCol.footer.options.calculationType !== undefined &&
                                    formatCol.footer.options.calculationType !== null ?
                                    parseInt(formatCol.footer.options.calculationType, 10) : -1;
                        }
                    }
                }
            }));
        }
    };
    // 创建唯一key, 由uri + gridId 组成，并混淆
    // 创建唯一key, 由uri + gridId 组成，并混淆
    /**
     * @private
     * @param {?} gridId
     * @return {?}
     */
    DatagridSettingsService.prototype.createConfigKey = 
    // 创建唯一key, 由uri + gridId 组成，并混淆
    /**
     * @private
     * @param {?} gridId
     * @return {?}
     */
    function (gridId) {
        /** @type {?} */
        var grid = this.getGridInstance(gridId);
        if (grid) {
            return grid.dgs.createConfigKey(gridId);
        }
        else {
            console.log('DatagridSettingService: Can not find the grid instance.');
        }
    };
    /**
     * @param {?} gridId
     * @return {?}
     */
    DatagridSettingsService.prototype.saveUserConfig = /**
     * @param {?} gridId
     * @return {?}
     */
    function (gridId) {
        /** @type {?} */
        var gridInstance = this.getGridInstance(gridId);
        /** @type {?} */
        var key = this.createConfigKey(gridId);
        /** @type {?} */
        var config = { sortInfo: {}, viewColumns: [], groupField: '', columnFormat: [] };
        if (gridInstance) {
            var sortName = gridInstance.sortName, sortOrder = gridInstance.sortOrder, columns = gridInstance.columns;
            if (sortName) {
                /** @type {?} */
                var sortInfo = {
                    sortName: sortName.split(','),
                    sortOrder: sortOrder.split(',')
                };
                config.sortInfo = sortInfo;
            }
            /** @type {?} */
            var viewColumns = columns[0].filter((/**
             * @param {?} n
             * @return {?}
             */
            function (n) { return n.visible || n.visible === undefined; })).map((/**
             * @param {?} n
             * @return {?}
             */
            function (n) { return n.field; }));
            config.viewColumns = viewColumns;
            config.columnFormat = this.convertColumnsToSimple(columns)[0];
            if (gridInstance.groupRows) {
                config.groupField = gridInstance.groupField;
            }
        }
        return this.setUserConfig(key, config);
    };
    /**
     * @param {?} key
     * @param {?} config
     * @return {?}
     */
    DatagridSettingsService.prototype.setUserConfig = /**
     * @param {?} key
     * @param {?} config
     * @return {?}
     */
    function (key, config) {
        /** @type {?} */
        var LOCALEID = this.localeSer.localeId;
        /** @type {?} */
        var currentConfig = localStorage.getItem(key);
        /** @type {?} */
        var _config = (currentConfig ? JSON.parse(currentConfig) : {}) || {};
        if (config) {
            if (_config) {
                _config[LOCALEID] = config;
            }
            localStorage.setItem(key, JSON.stringify(_config));
        }
        else {
            localStorage.removeItem(key);
        }
        if (this.httpRestService) {
            // 保存至数据库
            return this._saveUserConfig(key, config ? _config : '');
        }
        return of(true);
    };
    /**
     * @param {?} key
     * @return {?}
     */
    DatagridSettingsService.prototype.getUserConfig = /**
     * @param {?} key
     * @return {?}
     */
    function (key) {
        if (this.httpRestService) {
            return this._getUserConfig(key);
        }
        else {
            /** @type {?} */
            var config = localStorage.getItem(key);
            if (config) {
                /** @type {?} */
                var con = JSON.parse(config);
                if (con[this.localeSer.localeId]) {
                    return of(con[this.localeSer.localeId]);
                }
                else {
                    if (Object.keys(con).indexOf('viewColumns') > -1) {
                        return of(con);
                    }
                    return null;
                }
            }
            else {
                return of(null);
            }
        }
    };
    /**
     * @param {?} gridID
     * @return {?}
     */
    DatagridSettingsService.prototype.getSettings = /**
     * @param {?} gridID
     * @return {?}
     */
    function (gridID) {
        /** @type {?} */
        var key = this.createConfigKey(gridID);
        return this.getUserConfig(key);
    };
    /**
     * @private
     * @param {?} key
     * @param {?} config
     * @return {?}
     */
    DatagridSettingsService.prototype._saveUserConfig = /**
     * @private
     * @param {?} key
     * @param {?} config
     * @return {?}
     */
    function (key, config) {
        try {
            /** @type {?} */
            var userConfigSetting = {
                configkey1: key,
                configkey2: '',
                configkey3: '',
                textvalue: config ? JSON.stringify(config) : ''
            };
            return this.httpRestService.saveUserSettings(userConfigSetting);
        }
        catch (e) {
            console.error(e);
        }
    };
    /**
     * @param {?} gridInstance
     * @param {?} modalRef
     * @return {?}
     */
    DatagridSettingsService.prototype.resetUserConfig = /**
     * @param {?} gridInstance
     * @param {?} modalRef
     * @return {?}
     */
    function (gridInstance, modalRef) {
        var _this = this;
        /** @type {?} */
        var restorDefaultText = this.localeSer.getValue('datagrid.settings.restoreDefaultSettingsText') || '确认要恢复默认设置吗？';
        this.messager.confirm(restorDefaultText).pipe(switchMap((/**
         * @param {?} t
         * @return {?}
         */
        function (t) {
            if (t) {
                /** @type {?} */
                var key = _this.createConfigKey(gridInstance.id);
                return _this.setUserConfig(key, '');
            }
            return of(t);
        }))).subscribe((/**
         * @param {?} t
         * @return {?}
         */
        function (t) {
            if (t) {
                _this.resetGridView(gridInstance);
                modalRef.close();
            }
        }));
    };
    /**
     * @private
     * @param {?} key
     * @return {?}
     */
    DatagridSettingsService.prototype._getUserConfig = /**
     * @private
     * @param {?} key
     * @return {?}
     */
    function (key) {
        var _this = this;
        try {
            return this.httpRestService.getUserSettings(key).pipe(map((/**
             * @param {?} ucs
             * @return {?}
             */
            function (ucs) {
                var _a;
                if (ucs && ucs.textValue) {
                    /** @type {?} */
                    var c = JSON.parse(ucs.textValue);
                    if (c) {
                        if (c[_this.localeSer.localeId]) {
                            localStorage.setItem(key, ucs.textValue);
                            return c[_this.localeSer.localeId];
                        }
                        else {
                            localStorage.setItem(key, JSON.stringify((_a = {}, _a[_this.localeSer.localeId] = c, _a)));
                            if (Object.keys(c).indexOf('viewColumns') > -1) {
                                return c;
                            }
                            return null;
                        }
                    }
                    return null;
                }
                return null;
            })));
        }
        catch (e) {
            console.error(e);
        }
    };
    DatagridSettingsService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    DatagridSettingsService.ctorParameters = function () { return [
        { type: Injector },
        { type: BsModalService },
        { type: MessagerService },
        { type: IdService },
        { type: LocaleService }
    ]; };
    return DatagridSettingsService;
}());
export { DatagridSettingsService };
if (false) {
    /**
     * @type {?}
     * @private
     */
    DatagridSettingsService.prototype.multiSortMsg;
    /**
     * @type {?}
     * @private
     */
    DatagridSettingsService.prototype.columnsSortableMsg;
    /**
     * @type {?}
     * @private
     */
    DatagridSettingsService.prototype.notSupportHeaderGroupMsg;
    /**
     * @type {?}
     * @private
     */
    DatagridSettingsService.prototype.notShowDialog;
    /** @type {?} */
    DatagridSettingsService.prototype.httpRestService;
    /** @type {?} */
    DatagridSettingsService.prototype.gridInstance;
    /**
     * @type {?}
     * @private
     */
    DatagridSettingsService.prototype.gridRefs;
    /**
     * @type {?}
     * @private
     */
    DatagridSettingsService.prototype.saving;
    /**
     * @type {?}
     * @private
     */
    DatagridSettingsService.prototype.cfr;
    /**
     * @type {?}
     * @private
     */
    DatagridSettingsService.prototype.app;
    /**
     * @type {?}
     * @private
     */
    DatagridSettingsService.prototype.injector;
    /**
     * @type {?}
     * @private
     */
    DatagridSettingsService.prototype.modalSer;
    /**
     * @type {?}
     * @private
     */
    DatagridSettingsService.prototype.messager;
    /**
     * @type {?}
     * @private
     */
    DatagridSettingsService.prototype.idService;
    /**
     * @type {?}
     * @private
     */
    DatagridSettingsService.prototype.localeSer;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YWdyaWQtc2V0dGluZ3Muc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvdWktZGF0YWdyaWQtc2V0dGluZ3MvIiwic291cmNlcyI6WyJsaWIvZGF0YWdyaWQtc2V0dGluZ3Muc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQU8sTUFBTSxnQkFBZ0IsQ0FBQztBQUNyRCxPQUFPLEVBQWMsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3RDLE9BQU8sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLGNBQWMsRUFBRSx3QkFBd0IsRUFBRSxjQUFjLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFL0csT0FBTyxFQUFFLGNBQWMsRUFBeUMsTUFBTSxrQkFBa0IsQ0FBQztBQUN6RixPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDdEQsT0FBTyxFQUFFLHlCQUF5QixFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFDMUUsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUN0QyxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFFbEQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQzlDLE9BQU8sRUFBRSxzQkFBc0IsRUFBRSxNQUFNLHdDQUF3QyxDQUFDOztBQUVoRixNQUFNLEtBQU8sb0JBQW9CLEdBQUksSUFBSSxjQUFjLENBQUMsMkNBQTJDLENBQUM7QUFFcEc7SUFlSSxpQ0FBb0IsUUFBa0IsRUFBVSxRQUF3QixFQUNwRCxRQUF5QixFQUFVLFNBQW9CLEVBQ3ZELFNBQXdCO1FBRnhCLGFBQVEsR0FBUixRQUFRLENBQVU7UUFBVSxhQUFRLEdBQVIsUUFBUSxDQUFnQjtRQUNwRCxhQUFRLEdBQVIsUUFBUSxDQUFpQjtRQUFVLGNBQVMsR0FBVCxTQUFTLENBQVc7UUFDdkQsY0FBUyxHQUFU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K0NBQXlCOzs7OztJQUN6QiwyQ0FBNEQ7Ozs7O0lBRTVELHlDQUF1Qjs7Ozs7SUFDdkIsc0NBQTZDOzs7OztJQUM3QyxzQ0FBbUM7Ozs7O0lBQ3ZCLDJDQUEwQjs7Ozs7SUFBRSwyQ0FBZ0M7Ozs7O0lBQzVELDJDQUFpQzs7Ozs7SUFBRSw0Q0FBNEI7Ozs7O0lBQy9ELDRDQUFnQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IG1hcCwgc3dpdGNoTWFwLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IE9ic2VydmFibGUsIG9mIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IEluamVjdGFibGUsIEluamVjdG9yLCBJbmplY3Rpb25Ub2tlbiwgQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLCBBcHBsaWNhdGlvblJlZiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBEYXRhZ3JpZENvbXBvbmVudCwgRGF0YUNvbHVtbiB9IGZyb20gJ0BmYXJyaXMvdWktZGF0YWdyaWQnO1xyXG5pbXBvcnQgeyBCc01vZGFsU2VydmljZSwgTW9kYWxPcHRpb25zLCBNb2RhbENvbnRhaW5lckNvbXBvbmVudCB9IGZyb20gJ0BmYXJyaXMvdWktbW9kYWwnO1xyXG5pbXBvcnQgeyBNZXNzYWdlclNlcnZpY2UgfSBmcm9tICdAZmFycmlzL3VpLW1lc3NhZ2VyJztcclxuaW1wb3J0IHsgRGF0YWdyaWRTZXR0aW5nc0NvbXBvbmVudCB9IGZyb20gJy4vZGF0YWdyaWQtc2V0dGluZ3MuY29tcG9uZW50JztcclxuaW1wb3J0IHsgY2xvbmVEZWVwIH0gZnJvbSAnbG9kYXNoLWVzJztcclxuaW1wb3J0IHsgTG9jYWxlU2VydmljZSB9IGZyb20gJ0BmYXJyaXMvdWktbG9jYWxlJztcclxuaW1wb3J0IHsgVHJlZU5vZGUgfSBmcm9tICdAZmFycmlzL3VpLXRyZWV0YWJsZSc7XHJcbmltcG9ydCB7IElkU2VydmljZSB9IGZyb20gJ0BmYXJyaXMvdWktY29tbW9uJztcclxuaW1wb3J0IHsgU2ltcGxlQ29sdW1uc0NvbXBvbmVudCB9IGZyb20gJy4vc2ltcGxlLW1vZGUvc2ltcGxlLWNvbHVtbnMuY29tcG9uZW50JztcclxuXHJcbmV4cG9ydCBjb25zdCBHUklEX1NFVFRJTkdTX1dFQkFQSSA9ICBuZXcgSW5qZWN0aW9uVG9rZW4oJyBGYXJyaXMgRGF0YUdyaWQgVXNlciBTZXR0aW5nIFdlYkFwaSBVUkkuJyk7XHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBEYXRhZ3JpZFNldHRpbmdzU2VydmljZSB7XHJcblxyXG4gICAgcHJpdmF0ZSBtdWx0aVNvcnRNc2cgPSAn5YiX6KGo5Lit5pyq5byA5ZCv5aSa5YiX5o6S5bqP55qE5Yqf6IO944CCIOivt+ajgOafpe+8gSc7XHJcbiAgICBwcml2YXRlIGNvbHVtbnNTb3J0YWJsZU1zZyA9ICfmnKrlvIDlkK/liJfnmoTmjpLluo/lip/og73jgILor7fmo4Dmn6XvvIEnO1xyXG4gICAgcHJpdmF0ZSBub3RTdXBwb3J0SGVhZGVyR3JvdXBNc2cgPSAn5pqC5LiN5pSv5oyB5aSa6KGo5aS06K6+572uJztcclxuICAgIHByaXZhdGUgbm90U2hvd0RpYWxvZyA9ICflpJrooajlpLTmmoLkuI3mlK/mjIHliJfmmL7npLrorr7nva7vvJvlkIzml7bmnKrlkK/nlKjliJfmjpLluo/lip/og73jgIInO1xyXG5cclxuICAgIHB1YmxpYyBodHRwUmVzdFNlcnZpY2U6IGFueTtcclxuICAgIGdyaWRJbnN0YW5jZTogYW55ID0gbnVsbDtcclxuICAgIHByaXZhdGUgZ3JpZFJlZnM6IHtba2V5OiBzdHJpbmddOiBEYXRhZ3JpZENvbXBvbmVudH0gPSBudWxsO1xyXG5cclxuICAgIHByaXZhdGUgc2F2aW5nID0gZmFsc2U7XHJcbiAgICBwcml2YXRlIGNmcjogQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyID0gbnVsbDtcclxuICAgIHByaXZhdGUgYXBwOiBBcHBsaWNhdGlvblJlZiA9IG51bGw7XHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGluamVjdG9yOiBJbmplY3RvciwgcHJpdmF0ZSBtb2RhbFNlcjogQnNNb2RhbFNlcnZpY2UsXHJcbiAgICAgICAgICAgICAgICBwcml2YXRlIG1lc3NhZ2VyOiBNZXNzYWdlclNlcnZpY2UsIHByaXZhdGUgaWRTZXJ2aWNlOiBJZFNlcnZpY2UsXHJcbiAgICAgICAgICAgICAgICBwcml2YXRlIGxvY2FsZVNlcjogTG9jYWxlU2VydmljZSkge1xyXG5cclxuICAgICAgICB0aGlzLmNmciA9IHRoaXMuaW5qZWN0b3IuZ2V0KENvbXBvbmVudEZhY3RvcnlSZXNvbHZlcik7XHJcbiAgICAgICAgdGhpcy5hcHAgPSB0aGlzLmluamVjdG9yLmdldChBcHBsaWNhdGlvblJlZik7XHJcbiAgICB9XHJcblxyXG4gICAgZGVzdHJveShpZD86IHN0cmluZykge1xyXG4gICAgICAgIGlmIChpZCAmJiB0aGlzLmdyaWRSZWZzICYmIHRoaXMuZ3JpZFJlZnNbaWRdKSB7XHJcbiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmdyaWRSZWZzW2lkXTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLmdyaWRSZWZzID0gbnVsbDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmVnaXN0ZXJHcmlkSW5zdGFuY2UoZGc6IERhdGFncmlkQ29tcG9uZW50KSB7XHJcbiAgICAgICAgaWYgKCFkZykge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZygnRGF0YWdyaWRTZXR0aW5nU2VydmljZTogZ3JpZCBpbnN0YW5jZSBpcyBudWxsLicpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IGlkID0gZGcuaWQ7XHJcbiAgICAgICAgdGhpcy5ncmlkUmVmcyA9IHRoaXMuZ3JpZFJlZnMgfHwge307XHJcbiAgICAgICAgaWYgKCF0aGlzLmdyaWRSZWZzW2lkXSkge1xyXG4gICAgICAgICAgICB0aGlzLmdyaWRSZWZzW2lkXSA9IGRnO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBnZXRHcmlkSW5zdGFuY2UoZGdJRDogc3RyaW5nKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZ3JpZFJlZnMgPyB0aGlzLmdyaWRSZWZzW2RnSURdIDogbnVsbDtcclxuICAgIH1cclxuXHJcbiAgICBnZXRTZWFyY2hUeXBlcygpIHtcclxuICAgICAgICByZXR1cm4gW1xyXG4gICAgICAgICAgICB7IHZhbHVlOiAnYWxsJywgdGl0bGU6IHRoaXMubG9jYWxlU2VyLmdldFZhbHVlKCdkYXRhZ3JpZC5zZXR0aW5ncy5hbGxDb2x1bW5zJykgfSxcclxuICAgICAgICAgICAgeyB2YWx1ZTogJ3Zpc2libGUnLCB0aXRsZTogdGhpcy5sb2NhbGVTZXIuZ2V0VmFsdWUoJ2RhdGFncmlkLnNldHRpbmdzLnZpc2libGVDb2x1bW5zJykgfSxcclxuICAgICAgICAgICAgeyB2YWx1ZTogJ2hpZGRlbicsIHRpdGxlOiB0aGlzLmxvY2FsZVNlci5nZXRWYWx1ZSgnZGF0YWdyaWQuc2V0dGluZ3MuaGlkZGVuQ29sdW1ucycpIH1cclxuICAgICAgICBdO1xyXG4gICAgfVxyXG5cclxuICAgIHNob3dTaW1wbGUoZ3JpZEluc3RhbmNlOiBEYXRhZ3JpZENvbXBvbmVudCkge1xyXG4gICAgICAgIGNvbnN0IGNvbHVtbnMgPSB0aGlzLmNvbnZlcnRDb2x1bW5zVG9TaW1wbGUoZ3JpZEluc3RhbmNlLmNvbHVtbnMpO1xyXG4gICAgICAgIGNvbHVtbnNbMF0gPSBjb2x1bW5zWzBdLmZpbHRlcihuID0+IG4uZmllbGQgJiYgbi5maWVsZCAhPT0gZ3JpZEluc3RhbmNlLkNvbnRyb2xQYW5lbEZlaWxkKTtcclxuXHJcbiAgICAgICAgY29uc3Qgc2VhcmNoVHlwZXMgPSB0aGlzLmdldFNlYXJjaFR5cGVzKCk7XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmNmcikge1xyXG4gICAgICAgICAgICBjb25zdCBjbXBGYWN0b3J5ID0gdGhpcy5jZnIucmVzb2x2ZUNvbXBvbmVudEZhY3RvcnkoU2ltcGxlQ29sdW1uc0NvbXBvbmVudCk7XHJcbiAgICAgICAgICAgIGxldCBzaW1wbGVSZWYgPSBjbXBGYWN0b3J5LmNyZWF0ZSh0aGlzLmluamVjdG9yKTtcclxuICAgICAgICAgICAgdGhpcy5hcHAuYXR0YWNoVmlldyhzaW1wbGVSZWYuaG9zdFZpZXcpO1xyXG4gICAgICAgICAgICBzaW1wbGVSZWYuaW5zdGFuY2UuY29sdW1ucyA9IGNvbHVtbnM7XHJcbiAgICAgICAgICAgIHNpbXBsZVJlZi5pbnN0YW5jZS5zZWFydFR5cGVzID0gc2VhcmNoVHlwZXM7XHJcbiAgICAgICAgICAgIHNpbXBsZVJlZi5pbnN0YW5jZS5ncmlkSW5zdGFuY2UgPSBncmlkSW5zdGFuY2U7XHJcblxyXG4gICAgICAgICAgICBpZiAoZG9jdW1lbnQucXVlcnlTZWxlY3RvcignI3BhZ2Utd3JhcHBlcicpKSB7XHJcbiAgICAgICAgICAgICAgICBzaW1wbGVSZWYuaW5zdGFuY2UudG9wID0gNzY7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoc2ltcGxlUmVmLmxvY2F0aW9uLm5hdGl2ZUVsZW1lbnQpO1xyXG5cclxuXHJcbiAgICAgICAgICAgIHNpbXBsZVJlZi5pbnN0YW5jZS5jbG9zZWQuc3Vic2NyaWJlKCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBzaW1wbGVSZWYubG9jYXRpb24ubmF0aXZlRWxlbWVudC5yZW1vdmUoKTtcclxuICAgICAgICAgICAgICAgIHNpbXBsZVJlZi5kZXN0cm95KCk7XHJcbiAgICAgICAgICAgICAgICBzaW1wbGVSZWYgPSBudWxsO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIHNpbXBsZVJlZi5pbnN0YW5jZS5hZHZhbmNlZC5zdWJzY3JpYmUoKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zaG93QWR2YW5jZWQoZ3JpZEluc3RhbmNlKTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBzaW1wbGVSZWYuaW5zdGFuY2Uuc3VibWl0LnN1YnNjcmliZSggKGU6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgZS50YXJnZXQuZGlzYWJsZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuc2F2aW5nKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKCF0aGlzLnNhdmluZykge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlR3JpZFZpZXcoZSwgZ3JpZEluc3RhbmNlLCBlLnRhcmdldCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgc2ltcGxlUmVmLmhvc3RWaWV3LmRldGVjdENoYW5nZXMoKTtcclxuXHJcbiAgICAgICAgICAgIHJldHVybiBzaW1wbGVSZWY7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuXHJcbiAgICBzaG93KGdyaWRJbnN0YW5jZTogRGF0YWdyaWRDb21wb25lbnQsIG9wdHM/OiBNb2RhbE9wdGlvbnMpIHtcclxuICAgICAgICB0aGlzLnJlZ2lzdGVyR3JpZEluc3RhbmNlKGdyaWRJbnN0YW5jZSk7XHJcblxyXG4gICAgICAgIGlmIChncmlkSW5zdGFuY2UuZW5hYmxlU2ltcGxlTW9kZSkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5zaG93U2ltcGxlKGdyaWRJbnN0YW5jZSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2hvd0FkdmFuY2VkKGdyaWRJbnN0YW5jZSwgb3B0cyk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgc2hvd0FkdmFuY2VkKGdyaWRJbnN0YW5jZTogRGF0YWdyaWRDb21wb25lbnQsIG9wdHM/OiBNb2RhbE9wdGlvbnMpIHtcclxuICAgICAgICBsZXQgX2VkaXRDb2xTb3J0SW5mbyA9IHRydWU7XHJcbiAgICAgICAgY29uc3QgZWRpdENvbFNvcnRJbmZvID0gdGhpcy5jYW5TZXRDb2x1bW5Tb3J0KGdyaWRJbnN0YW5jZSk7XHJcbiAgICAgICAgaWYgKGVkaXRDb2xTb3J0SW5mbyAhPT0gdHJ1ZSkge1xyXG4gICAgICAgICAgICAvLyB0aGlzLm1lc3NhZ2VyLndhcm5pbmcobXNnKTtcclxuICAgICAgICAgICAgLy8gcmV0dXJuO1xyXG4gICAgICAgICAgICBfZWRpdENvbFNvcnRJbmZvID0gZmFsc2U7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBzaG93U2V0Q29sdW1uc1RhYiA9ICF0aGlzLmlzSGVhZGVyR3JvdXAoZ3JpZEluc3RhbmNlKTtcclxuICAgICAgICBjb25zdCBnZXRBY3RpdmVUYWJJbmRleCA9ICgpID0+IHtcclxuICAgICAgICAgICAgaWYgKHNob3dTZXRDb2x1bW5zVGFiKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gMTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGlmIChfZWRpdENvbFNvcnRJbmZvKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDI7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiAtMTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcbiAgICAgICAgY29uc3QgYWN0aXZlVGFiSW5kZXggPSBnZXRBY3RpdmVUYWJJbmRleCgpO1xyXG5cclxuICAgICAgICBpZiAoYWN0aXZlVGFiSW5kZXggPT09IC0xKSB7XHJcbiAgICAgICAgICAgIHRoaXMubWVzc2FnZXIud2FybmluZyh0aGlzLm5vdFNob3dEaWFsb2cpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBjb2x1bW5zID0gdGhpcy5jb252ZXJ0Q29sdW1uc1RvU2ltcGxlKGdyaWRJbnN0YW5jZS5jb2x1bW5zKTtcclxuICAgICAgICBjb2x1bW5zWzBdID0gY29sdW1uc1swXS5maWx0ZXIobiA9PiBuLmZpZWxkICYmIG4uZmllbGQgIT09IGdyaWRJbnN0YW5jZS5Db250cm9sUGFuZWxGZWlsZCk7XHJcbiAgICAgICAgY29uc3QgdHJlZURhdGEgPSB0aGlzLmNvbnZlcnRDb2x1bW5zMlRyZWVEYXRhKGNsb25lRGVlcChjb2x1bW5zKSwgdHJ1ZSk7XHJcbiAgICAgICAgY29uc3Qgdmlld0NvbHVtbnNUcmVlRGF0YSA9IHRoaXMuY29udmVydENvbHVtbnMyVHJlZURhdGEoY2xvbmVEZWVwKGNvbHVtbnMpLCBmYWxzZSk7XHJcbiAgICAgICAgdGhpcy5jaGVja1ZpZXdUcmVlTm9kZXModmlld0NvbHVtbnNUcmVlRGF0YSk7XHJcblxyXG4gICAgICAgIGxldCBtb2RhbFJlZiA9IG51bGw7XHJcblxyXG4gICAgICAgIGNvbnN0IG9rVGV4dCA9IHRoaXMubG9jYWxlU2VyLmdldFZhbHVlKCdkYXRhZ3JpZC5zZXR0aW5ncy5vaycpIHx8ICfnoa7lrponO1xyXG4gICAgICAgIGNvbnN0IGNhbmNlbFRleHQgPSB0aGlzLmxvY2FsZVNlci5nZXRWYWx1ZSgnZGF0YWdyaWQuc2V0dGluZ3MuY2FuY2VsJykgfHwgJ+WPlua2iCc7XHJcbiAgICAgICAgY29uc3QgcmVzZXRUZXh0ID0gIHRoaXMubG9jYWxlU2VyLmdldFZhbHVlKCdkYXRhZ3JpZC5zZXR0aW5ncy5yZXNldCcpIHx8ICfph43nva4nO1xyXG5cclxuXHJcbiAgICAgICAgY29uc3QgZGVmYXVsdE9wdHMgPSB7XHJcbiAgICAgICAgICAgIHdpZHRoOiA3NjAsIGhlaWdodDogNTYwLCBzaG93SGVhZGVyOiBmYWxzZSwgdGl0bGU6ICfmjqfliLbpnaLmnb8nLFxyXG4gICAgICAgICAgICBpbml0aWFsU3RhdGU6IHtcclxuICAgICAgICAgICAgICAgIGNvbHVtbnMsXHJcbiAgICAgICAgICAgICAgICBzb3J0VHJlZURhdGE6IHRyZWVEYXRhLFxyXG4gICAgICAgICAgICAgICAgdmlld1RyZWVEYXRhOiB2aWV3Q29sdW1uc1RyZWVEYXRhLFxyXG4gICAgICAgICAgICAgICAgZ3JpZEluc3RhbmNlLFxyXG4gICAgICAgICAgICAgICAgY2FuU2V0Q29sdW1uU29ydDogX2VkaXRDb2xTb3J0SW5mbyxcclxuICAgICAgICAgICAgICAgIGNhblNldENvbHVtblZpc2libGU6IHNob3dTZXRDb2x1bW5zVGFiLFxyXG4gICAgICAgICAgICAgICAgYWN0aXZlVGFiSW5kZXhcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgc2hvd0J1dHRvbnM6IGZhbHNlXHJcbiAgICAgICAgfTtcclxuICAgICAgICBjb25zdCBtb2RhbE9wdHMgPSBPYmplY3QuYXNzaWduKGRlZmF1bHRPcHRzLCBvcHRzIHx8IHt9KTtcclxuXHJcbiAgICAgICAgbW9kYWxSZWYgPSB0aGlzLm1vZGFsU2VyLnNob3coRGF0YWdyaWRTZXR0aW5nc0NvbXBvbmVudCwgbW9kYWxPcHRzKTtcclxuICAgICAgICBjb25zdCBpbnN0YW5jZSA9IG1vZGFsUmVmLmNvbnRlbnQgYXMgRGF0YWdyaWRTZXR0aW5nc0NvbXBvbmVudDtcclxuICAgICAgICBpbnN0YW5jZS5lbmFibGVSZXNldCA9IHRydWU7XHJcbiAgICAgICAgaW5zdGFuY2UubW9kYWxSZWYgPSBtb2RhbFJlZjtcclxuICAgICAgICBpbnN0YW5jZS5jYW5TZXRDb2x1bW5Tb3J0ID0gX2VkaXRDb2xTb3J0SW5mbztcclxuICAgICAgICBpbnN0YW5jZS5jYW5TZXRDb2x1bW5WaXNpYmxlID0gIXRoaXMuaXNIZWFkZXJHcm91cChncmlkSW5zdGFuY2UpO1xyXG5cclxuICAgICAgICBpbnN0YW5jZS5zdWJtaXRIYW5kbGUuc3Vic2NyaWJlKChlKSA9PiB7XHJcbiAgICAgICAgICAgIGUudGFyZ2V0LmRpc2FibGVkID0gdHJ1ZTtcclxuICAgICAgICAgICAgaWYgKHRoaXMuc2F2aW5nKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKCF0aGlzLnNhdmluZykge1xyXG4gICAgICAgICAgICAgICAgdGhpcy51cGRhdGVHcmlkVmlldyhtb2RhbFJlZiwgZ3JpZEluc3RhbmNlLCBlLnRhcmdldCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgaW5zdGFuY2UuY2FuY2VsSGFuZGxlLnN1YnNjcmliZSgoZSkgPT4ge1xyXG4gICAgICAgICAgICBtb2RhbFJlZi5jbG9zZSgpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBpbnN0YW5jZS5jb25jaXNlLnN1YnNjcmliZSgoZSkgPT4ge1xyXG4gICAgICAgICAgICBtb2RhbFJlZi5jbG9zZSgpO1xyXG4gICAgICAgICAgICB0aGlzLnNob3dTaW1wbGUoZ3JpZEluc3RhbmNlKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgY29uc3QgbW9kYWxDb250YWluZXIgPSBtb2RhbFJlZi5kaWFsb2cuaW5zdGFuY2UgYXMgTW9kYWxDb250YWluZXJDb21wb25lbnQ7XHJcbiAgICAgICAgbW9kYWxDb250YWluZXIuZHJhZ2diYXIuaGFuZGxlID0gaW5zdGFuY2UuaGVhZGVyLm5hdGl2ZUVsZW1lbnQ7XHJcbiAgICAgICAgcmV0dXJuIG1vZGFsUmVmO1xyXG4gICAgfVxyXG5cclxuXHJcblxyXG4gICAgcHJpdmF0ZSBjYW5TZXRDb2x1bW5Tb3J0KGdyaWRJbnN0YW5jZTogRGF0YWdyaWRDb21wb25lbnQpIHtcclxuICAgICAgICBpZiAoZ3JpZEluc3RhbmNlLm11bHRpU29ydCAmJiB0aGlzLmhhc0VuYWJsZVNvcnRDb2x1bW5zKGdyaWRJbnN0YW5jZSkpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgaWYgKCF0aGlzLmhhc0VuYWJsZVNvcnRDb2x1bW5zKGdyaWRJbnN0YW5jZSkpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmNvbHVtbnNTb3J0YWJsZU1zZztcclxuICAgICAgICAgICAgfSBlbHNlIGlmICghZ3JpZEluc3RhbmNlLm11bHRpU29ydCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMubXVsdGlTb3J0TXNnO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgaGFzRW5hYmxlU29ydENvbHVtbnMoZ3JpZEluc3RhbmNlOiBEYXRhZ3JpZENvbXBvbmVudCkge1xyXG4gICAgICAgIGNvbnN0IHNvcnRDb2x1bW5zQ291bnQgPSBncmlkSW5zdGFuY2UuZmxhdENvbHVtbnMucmVkdWNlKChjLCByKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChyLnNvcnRhYmxlKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gYyArIDE7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIGM7XHJcbiAgICAgICAgfSwgMCk7XHJcblxyXG4gICAgICAgIHJldHVybiBzb3J0Q29sdW1uc0NvdW50ID4gMDtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGlzSGVhZGVyR3JvdXAoZ3JpZDogRGF0YWdyaWRDb21wb25lbnQpIHtcclxuICAgICAgICBjb25zdCBmbGFnID0gZ3JpZC5jb2x1bW5zLmxlbmd0aCA+IDE7XHJcbiAgICAgICAgaWYgKGZsYWcpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMubm90U3VwcG9ydEhlYWRlckdyb3VwTXNnO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gZmxhZztcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdldENoaWxkcyhjb2xzLCByb3dJbmRleCwgY29sU3RhcnRJbmRleCwgY29sQ291bnQsIGZvclNvcnQgPSBmYWxzZSkge1xyXG4gICAgICAgIGNvbnN0IGNoaWxkQ29scyA9IFtdO1xyXG4gICAgICAgIGxldCBfY291bnQgPSBjb2xTdGFydEluZGV4O1xyXG4gICAgICAgIGlmICghY29sc1tyb3dJbmRleF0pIHtcclxuICAgICAgICAgICAgcmV0dXJuICBbXTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbHNbcm93SW5kZXhdLnNsaWNlKCkuZm9yRWFjaChlbGVtZW50ID0+IHtcclxuICAgICAgICAgICAgX2NvdW50ID0gX2NvdW50ICsgZWxlbWVudC5jb2xzcGFuO1xyXG4gICAgICAgICAgICBpZiAoIF9jb3VudCA8PSBjb2xDb3VudCApIHtcclxuICAgICAgICAgICAgICAgIGNoaWxkQ29scy5wdXNoKGVsZW1lbnQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGNvbHNbcm93SW5kZXhdLnNwbGljZSgwLCBjaGlsZENvbHMubGVuZ3RoKTtcclxuXHJcbiAgICAgICAgcmV0dXJuIGNoaWxkQ29scy5tYXAoKGMsIGkpID0+IHtcclxuICAgICAgICAgICAgbGV0IG46IGFueSA9IHtcclxuICAgICAgICAgICAgICAgIGRhdGE6IGMsXHJcbiAgICAgICAgICAgICAgICBzZWxlY3RhYmxlOiBmb3JTb3J0ID8gISFjLnNvcnRhYmxlIDogdHJ1ZVxyXG4gICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgaWYgKGMuY29sc3BhbiAmJiBjLmNvbHNwYW4gPiAxKSB7XHJcbiAgICAgICAgICAgICAgICBuID0ge1xyXG4gICAgICAgICAgICAgICAgICAgIGRhdGE6IGMsXHJcbiAgICAgICAgICAgICAgICAgICAgc2VsZWN0YWJsZTogZmFsc2UsXHJcbiAgICAgICAgICAgICAgICAgICAgZXhwYW5kZWQ6IHRydWUsXHJcbiAgICAgICAgICAgICAgICAgICAgY2hpbGRyZW46IHRoaXMuZ2V0Q2hpbGRzKGNvbHMsIHJvd0luZGV4ICsgMSwgMCAsIGMuY29sc3BhbilcclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIG47XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBjb252ZXJ0Q29sdW1uczJUcmVlRGF0YShjb2xzOiBEYXRhQ29sdW1uW11bXSwgZm9yU29ydCA9IGZhbHNlKSB7XHJcbiAgICAgICAgY29uc3QgY29sdW1ucyA9IGNvbHMubWFwKChjOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgYy5tYXAoKF8pID0+IHtcclxuICAgICAgICAgICAgICAgIF8uY29sc3BhbiA9IF8uY29sc3BhbiB8fCAxO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIF87XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICByZXR1cm4gYztcclxuICAgICAgICB9KTtcclxuICAgICAgICBpZiAoY29sdW1ucy5sZW5ndGggPT09IDEpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGNvbHVtbnNbMF0ubWFwKGMgPT4ge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgICAgICBkYXRhOiBjLFxyXG4gICAgICAgICAgICAgICAgICAgIHNlbGVjdGFibGU6IGZvclNvcnQgPyAhIWMuc29ydGFibGUgOiB0cnVlXHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByZXR1cm4gY29sdW1uc1swXS5tYXAoKGMsIGkpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChjLmNvbHNwYW4gJiYgYy5jb2xzcGFuID4gMSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGE6IGMsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGFibGU6IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBleHBhbmRlZDogdHJ1ZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRyZW46IHRoaXMuZ2V0Q2hpbGRzKGNvbHVtbnMsIDEsIDAsIGMuY29sc3BhbiwgZm9yU29ydClcclxuICAgICAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkYXRhOiBjLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RhYmxlOiBmb3JTb3J0ID8gISFjLnNvcnRhYmxlIDogdHJ1ZVxyXG4gICAgICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcblxyXG4gICAgcHJpdmF0ZSBjaGVja1ZpZXdUcmVlTm9kZXModHJlZU5vZGVzOiBUcmVlTm9kZVtdKSB7XHJcbiAgICAgICAgdHJlZU5vZGVzLmZvckVhY2goKHRuOiBUcmVlTm9kZSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoIXRuLmNoaWxkcmVuIHx8ICF0bi5jaGlsZHJlbi5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgIHRuLnNlbGVjdGFibGUgPSB0cnVlO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdG4uc2VsZWN0YWJsZSA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jaGVja1ZpZXdUcmVlTm9kZXModG4uY2hpbGRyZW4pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBjb252ZXJ0Q29sdW1uc1RvU2ltcGxlKGNvbHM6IGFueSkge1xyXG4gICAgICAgIC8vIOenu+mZpOiuvue9ruWIl1xyXG4gICAgICAgIHJldHVybiBjb2xzLm1hcCggKF9jb2xzOiBEYXRhQ29sdW1uW10pID0+IHtcclxuICAgICAgICAgICAgcmV0dXJuIF9jb2xzLm1hcCggKGM6IERhdGFDb2x1bW4pID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChjLmZpZWxkICE9PSAnX2RhdGFncmlkLXNldHRpbmctY29udHJvbF8nKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZmllbGQ6IGMuZmllbGQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRpdGxlOiBjLnRpdGxlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb2xzcGFuOiBjLmNvbHNwYW4sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJvd3NwYW46IGMucm93c3BhbixcclxuICAgICAgICAgICAgICAgICAgICAgICAgc29ydGFibGU6IGMuc29ydGFibGUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG9yZGVyOiBjLm9yZGVyLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBoYWxpZ246IGMuaGFsaWduIHx8ICdsZWZ0JyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgYWxpZ246IGMuYWxpZ24gfHwgJ2xlZnQnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB2aXNpYmxlOiBjLnZpc2libGUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGFsbG93R3JvdXBpbmc6IGMuYWxsb3dHcm91cGluZyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgZ3JvdXBGb290ZXI6IGMuZ3JvdXBGb290ZXIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvb3RlcjogYy5mb290ZXIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoOiBjLndpZHRoIHx8IDEwMCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVR5cGU6IGMuZGF0YVR5cGUgfHwgJ3N0cmluZydcclxuICAgICAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KS5maWx0ZXIobiA9PiBuKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHJlc2V0R3JpZFZpZXcoZ3JpZEluc3RhbmNlOiBhbnkpIHtcclxuICAgICAgICBpZiAoIWdyaWRJbnN0YW5jZSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IGRmcyA9IGdyaWRJbnN0YW5jZS5kZnM7XHJcbiAgICAgICAgaWYgKGRmcykge1xyXG4gICAgICAgICAgICBjb25zdCBvcHRpb25zID0gZGZzWydfc3RhdGUnXS5pbml0aWFsT3B0aW9ucztcclxuXHJcbiAgICAgICAgICAgIGlmIChvcHRpb25zLnNvcnQpIHtcclxuICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLnNvcnQuc29ydE5hbWUpIHtcclxuICAgICAgICAgICAgICAgICAgICBncmlkSW5zdGFuY2Uuc29ydE5hbWUgPSBvcHRpb25zLnNvcnQuc29ydE5hbWU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5zb3J0LnNvcnRPcmRlcikge1xyXG4gICAgICAgICAgICAgICAgICAgIGdyaWRJbnN0YW5jZS5zb3J0T3JkZXIgPSBvcHRpb25zLnNvcnQuc29ydE9yZGVyO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBncmlkSW5zdGFuY2UuZ3JvdXBGaWVsZCA9IG9wdGlvbnMuZ3JvdXBGaWVsZCB8fCAnJztcclxuICAgICAgICAgICAgLy8gVE9ETzog6L+Y6ZyA6KaB5L+u5q2j6buY6K6k5YiX55qE5pi+56S66aG65bqPXHJcbiAgICAgICAgICAgIGlmIChvcHRpb25zLmNvbHVtbkZpZWxkcyAmJiBvcHRpb25zLmNvbHVtbkZpZWxkcy5sZW5ndGgpIHtcclxuXHJcbiAgICAgICAgICAgICAgICBjb25zdCBuZXdDb2x1bW5zID0gW107XHJcbiAgICAgICAgICAgICAgICBvcHRpb25zLmNvbHVtbkZpZWxkcy5mb3JFYWNoKGMgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvbCA9IGdyaWRJbnN0YW5jZS5jb2x1bW5zWzBdLmZpbmQoKG46IGFueSkgPT4gbi5maWVsZCA9PT0gYy5maWVsZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb2wudmlzaWJsZSA9IGMudmlzaWJsZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29sLmhhbGlnbiA9IGMuaGFsaWduO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb2wuYWxpZ24gPSBjLmFsaWduO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb2wud2lkdGggPSBjLndpZHRoO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb2wuZm9vdGVyID0gYy5mb290ZXI7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbC5ncm91cEZvb3RlciA9IGMuZ3JvdXBGb290ZXI7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG5ld0NvbHVtbnMucHVzaChjb2wpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgIGdyaWRJbnN0YW5jZS5jb2x1bW5zWzBdID0gbmV3Q29sdW1ucztcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLy8gZ3JpZEluc3RhbmNlWydjaGVja09wdGlvbnMnXSgpO1xyXG4gICAgICAgICAgICBncmlkSW5zdGFuY2VbJ2NvbHVtbnNDaGFuZ2VkJ10oKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSB1cGRhdGVHcmlkVmlldyhtb2RhbFJlZiwgZ3JpZEluc3RhbmNlLCBidG4gPSBudWxsKSB7XHJcbiAgICAgICAgY29uc3Qgc2V0dGluZ3MgPSBtb2RhbFJlZi5jb250ZW50O1xyXG5cclxuICAgICAgICBpZiAoc2V0dGluZ3MpIHtcclxuICAgICAgICAgICAgY29uc3Qga2V5ID0gdGhpcy5jcmVhdGVDb25maWdLZXkoZ3JpZEluc3RhbmNlLmlkKTtcclxuICAgICAgICAgICAgY29uc3QgeyBzb3J0SW5mbywgdmlld0NvbHVtbnMsIGNvbHVtbkZvcm1hdCwgZ3JvdXBGaWVsZHMgfSA9IHNldHRpbmdzO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5zYXZpbmcgPSB0cnVlO1xyXG5cclxuICAgICAgICAgICAgbGV0IGdyb3VwRmllbGQgPSAnJztcclxuICAgICAgICAgICAgaWYgKGdyaWRJbnN0YW5jZS5ncm91cFJvd3MgJiYgZ3JvdXBGaWVsZHMgJiYgZ3JvdXBGaWVsZHMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICBncm91cEZpZWxkID0gZ3JvdXBGaWVsZHMuam9pbignLCcpIDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBncmlkSW5zdGFuY2UuZ3JvdXBGaWVsZCA9IGdyb3VwRmllbGQ7XHJcblxyXG4gICAgICAgICAgICB0aGlzLnNldFVzZXJDb25maWcoa2V5LCB7IHNvcnRJbmZvLCB2aWV3Q29sdW1ucywgZ3JvdXBGaWVsZCwgY29sdW1uRm9ybWF0IH0pLnN1YnNjcmliZSggKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGJ0bikge1xyXG4gICAgICAgICAgICAgICAgICAgIGJ0bi5kaXNhYmxlZCA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgdGhpcy5zYXZpbmcgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgIG1vZGFsUmVmLmNsb3NlKCk7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKHNvcnRJbmZvICYmIE9iamVjdC5rZXlzKHNvcnRJbmZvKS5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCB7IHNvcnROYW1lLCBzb3J0T3JkZXIgfSA9IHNvcnRJbmZvO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChzb3J0TmFtZSAmJiBzb3J0TmFtZS5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZ3JpZEluc3RhbmNlLnNvcnQoc29ydE5hbWUuam9pbignLCcpLCBzb3J0T3JkZXIuam9pbignLCcpKTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBncmlkSW5zdGFuY2UuY2xlYXJTb3J0KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBncmlkSW5zdGFuY2UuY2xlYXJTb3J0KCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKHZpZXdDb2x1bW5zICYmIHZpZXdDb2x1bW5zLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGdyaWRJbnN0YW5jZS5jb2x1bW5zID0gZ3JpZEluc3RhbmNlLmNvbHVtbnMubWFwKGNvbHMgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUNvbHVtbkZvcm1hdChjb2xzLCBjb2x1bW5Gb3JtYXQsIGdyaWRJbnN0YW5jZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLm5ld1Zpc2libGVPcmRlckNvbHVtbnMoY29scywgdmlld0NvbHVtbnMsIGNvbHVtbkZvcm1hdCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgZ3JpZEluc3RhbmNlLmNvbHVtbnNDaGFuZ2VkKHRydWUpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBtb2RhbFJlZi5jbG9zZSgpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcblxyXG4gICAgbmV3VmlzaWJsZU9yZGVyQ29sdW1ucyhjb2xzOiBhbnksIHZpZXdDb2x1bW5zOiBhbnksIGNvbHVtbkZvcm1hdDogYW55KSB7XHJcbiAgICAgICAgY29uc3QgaGlkZUNvbHVtbnMgPSBbXTtcclxuICAgICAgICBjb2xzLmZvckVhY2goKGVsZW1lbnQsIGluZGV4KSA9PiB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmlzTmV3QWRkQ29sdW1uKGVsZW1lbnQuZmllbGQsIGNvbHVtbkZvcm1hdCkgJiYgZWxlbWVudC5maWVsZCAhPT0gJ19kYXRhZ3JpZC1zZXR0aW5nLWNvbnRyb2xfJykge1xyXG4gICAgICAgICAgICAgICAgdmlld0NvbHVtbnMucHVzaChlbGVtZW50LmZpZWxkKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGVsZW1lbnQudmlzaWJsZSA9IHZpZXdDb2x1bW5zLmluY2x1ZGVzKGVsZW1lbnQuZmllbGQpO1xyXG4gICAgICAgICAgICAgICAgaWYgKCFlbGVtZW50LnZpc2libGUpIHtcclxuICAgICAgICAgICAgICAgICAgICBoaWRlQ29sdW1ucy5wdXNoKGVsZW1lbnQpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIC8vIOa4heeQhuS4jeWtmOWcqOeahOWIl1xyXG4gICAgICAgIGxldCBuZXdDb2xzID0gdmlld0NvbHVtbnMubWFwKCBmaWVsZCA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiBjb2xzLmZpbmQoYyA9PiBjLmZpZWxkID09PSBmaWVsZCk7XHJcbiAgICAgICAgfSkuZmlsdGVyKG4gPT4gbik7XHJcblxyXG4gICAgICAgIGlmIChoaWRlQ29sdW1ucy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgbmV3Q29scyA9IG5ld0NvbHMuY29uY2F0KGhpZGVDb2x1bW5zKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBuZXdDb2xzLmZpbHRlcihjID0+IGMgJiYgYy5maWVsZCAmJiBjLmZpZWxkICE9PSAnX2RhdGFncmlkLXNldHRpbmctY29udHJvbF8nICk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDmmK/lkKbkuLrmlrDlop7liqDnmoTlrZfmrrVcclxuICAgICAqIOaWsOWinueahOWtl+aute+8jOmcgOimgeWcqOWIl+ihqOS4reWxleekuuWHuuadpe+8jOW5tuS/neWtmOWIsOS4quaAp+WMluiuvue9ruS4rVxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIGlzTmV3QWRkQ29sdW1uKGZpZWxkOiBhbnksIGNvbHVtbnM6IGFueSkge1xyXG4gICAgICAgIHJldHVybiAhY29sdW1ucy5maW5kKGMgPT4gYy5maWVsZCA9PT0gZmllbGQpO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICB1cGRhdGVDb2x1bW5Gb3JtYXQoY29sczogYW55W10sIGNvbHVtbkZvcm1hdDogYW55W10sIGdyaWRJbnN0YW5jZSkge1xyXG4gICAgICAgIGlmIChjb2x1bW5Gb3JtYXQgJiYgY29sdW1uRm9ybWF0Lmxlbmd0aCkge1xyXG4gICAgICAgICAgICBjb2xzLmZvckVhY2goY29sID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGZvcm1hdENvbCA9IGNvbHVtbkZvcm1hdC5maW5kKGY9PiBmLmZpZWxkID09PSBjb2wuZmllbGQpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGZvcm1hdENvbCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbC53aWR0aCA9IGZvcm1hdENvbC53aWR0aDtcclxuICAgICAgICAgICAgICAgICAgICBjb2wuaGFsaWduID0gZm9ybWF0Q29sLmhhbGlnbiB8fCAnbGVmdCc7XHJcbiAgICAgICAgICAgICAgICAgICAgY29sLmFsaWduID0gZm9ybWF0Q29sLmFsaWduIHx8ICdsZWZ0JztcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGdyaWRJbnN0YW5jZS5ncm91cFJvd3MgJiYgKGNvbC5hbGxvd0dyb3VwaW5nIHx8IGNvbC5hbGxvd0dyb3VwaW5nID09PSB1bmRlZmluZWQpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghY29sLmdyb3VwRm9vdGVyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2wuZ3JvdXBGb290ZXIgPSBmb3JtYXRDb2wuZ3JvdXBGb290ZXI7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb2wuZ3JvdXBGb290ZXIgJiYgY29sLmdyb3VwRm9vdGVyLm9wdGlvbnMpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbC5ncm91cEZvb3Rlci5vcHRpb25zLnRleHQgPSBmb3JtYXRDb2wuZ3JvdXBGb290ZXIub3B0aW9ucy50ZXh0IHx8ICcnO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sLmdyb3VwRm9vdGVyLm9wdGlvbnMuY2FsY3VsYXRpb25UeXBlID1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JtYXRDb2wuZ3JvdXBGb290ZXIub3B0aW9ucy5jYWxjdWxhdGlvblR5cGUgIT09IHVuZGVmaW5lZCAmJlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1hdENvbC5ncm91cEZvb3Rlci5vcHRpb25zLmNhbGN1bGF0aW9uVHlwZSAhPT0gbnVsbCA/XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyc2VJbnQoZm9ybWF0Q29sLmdyb3VwRm9vdGVyLm9wdGlvbnMuY2FsY3VsYXRpb25UeXBlLCAxMCkgOiAtMTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGdyaWRJbnN0YW5jZS5zaG93Rm9vdGVyICYmICFncmlkSW5zdGFuY2UuZm9vdGVyVGVtcGxhdGUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFjb2wuZm9vdGVyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2wuZm9vdGVyID0gZm9ybWF0Q29sLmZvb3RlcjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbC5mb290ZXIgJiYgY29sLmZvb3Rlci5vcHRpb25zKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2wuZm9vdGVyLm9wdGlvbnMudGV4dCA9IGZvcm1hdENvbC5mb290ZXIub3B0aW9ucy50ZXh0IHx8ICcnO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sLmZvb3Rlci5vcHRpb25zLmNhbGN1bGF0aW9uVHlwZSA9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9ybWF0Q29sLmZvb3Rlci5vcHRpb25zLmNhbGN1bGF0aW9uVHlwZSAhPT0gdW5kZWZpbmVkICYmXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9ybWF0Q29sLmZvb3Rlci5vcHRpb25zLmNhbGN1bGF0aW9uVHlwZSAhPT0gbnVsbCA/XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyc2VJbnQoZm9ybWF0Q29sLmZvb3Rlci5vcHRpb25zLmNhbGN1bGF0aW9uVHlwZSwgMTApIDogLTE7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyDliJvlu7rllK/kuIBrZXksIOeUsXVyaSArIGdyaWRJZCDnu4TmiJDvvIzlubbmt7fmt4ZcclxuICAgIHByaXZhdGUgY3JlYXRlQ29uZmlnS2V5KGdyaWRJZDogc3RyaW5nKSB7XHJcbiAgICAgICAgY29uc3QgZ3JpZCA9IHRoaXMuZ2V0R3JpZEluc3RhbmNlKGdyaWRJZCk7XHJcbiAgICAgICAgaWYgKGdyaWQpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGdyaWQuZGdzLmNyZWF0ZUNvbmZpZ0tleShncmlkSWQpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdEYXRhZ3JpZFNldHRpbmdTZXJ2aWNlOiBDYW4gbm90IGZpbmQgdGhlIGdyaWQgaW5zdGFuY2UuJyk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgIH1cclxuXHJcbiAgICBzYXZlVXNlckNvbmZpZyhncmlkSWQ6IHN0cmluZykge1xyXG4gICAgICAgIGNvbnN0IGdyaWRJbnN0YW5jZSA9IHRoaXMuZ2V0R3JpZEluc3RhbmNlKGdyaWRJZCk7XHJcbiAgICAgICAgY29uc3Qga2V5ID0gdGhpcy5jcmVhdGVDb25maWdLZXkoZ3JpZElkKTtcclxuICAgICAgICBjb25zdCBjb25maWcgPSB7c29ydEluZm86IHt9LCB2aWV3Q29sdW1uczogW10sIGdyb3VwRmllbGQ6ICcnLCBjb2x1bW5Gb3JtYXQ6IFtdfTtcclxuXHJcbiAgICAgICAgaWYgKGdyaWRJbnN0YW5jZSkge1xyXG4gICAgICAgICAgICBjb25zdCB7IHNvcnROYW1lLCBzb3J0T3JkZXIsIGNvbHVtbnN9ID0gZ3JpZEluc3RhbmNlO1xyXG4gICAgICAgICAgICBpZiAoc29ydE5hbWUpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHNvcnRJbmZvID0ge1xyXG4gICAgICAgICAgICAgICAgICAgIHNvcnROYW1lOiBzb3J0TmFtZS5zcGxpdCgnLCcpLFxyXG4gICAgICAgICAgICAgICAgICAgIHNvcnRPcmRlcjogc29ydE9yZGVyLnNwbGl0KCcsJylcclxuICAgICAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICAgICAgY29uZmlnLnNvcnRJbmZvID0gc29ydEluZm87XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGNvbnN0IHZpZXdDb2x1bW5zID0gY29sdW1uc1swXS5maWx0ZXIobiA9PiBuLnZpc2libGUgfHwgbi52aXNpYmxlID09PSB1bmRlZmluZWQpLm1hcChuID0+IG4uZmllbGQpO1xyXG4gICAgICAgICAgICBjb25maWcudmlld0NvbHVtbnMgPSB2aWV3Q29sdW1ucztcclxuICAgICAgICAgICAgY29uZmlnLmNvbHVtbkZvcm1hdCA9IHRoaXMuY29udmVydENvbHVtbnNUb1NpbXBsZShjb2x1bW5zKVswXTtcclxuXHJcbiAgICAgICAgICAgIGlmIChncmlkSW5zdGFuY2UuZ3JvdXBSb3dzKSB7XHJcbiAgICAgICAgICAgICAgICBjb25maWcuZ3JvdXBGaWVsZCA9IGdyaWRJbnN0YW5jZS5ncm91cEZpZWxkO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gdGhpcy5zZXRVc2VyQ29uZmlnKGtleSwgY29uZmlnKTtcclxuICAgIH1cclxuXHJcbiAgICBzZXRVc2VyQ29uZmlnKGtleTogc3RyaW5nLCBjb25maWc6IGFueSk6IE9ic2VydmFibGU8YW55PiB7XHJcblxyXG4gICAgICAgIGNvbnN0IExPQ0FMRUlEID0gdGhpcy5sb2NhbGVTZXIubG9jYWxlSWQ7XHJcbiAgICAgICAgY29uc3QgY3VycmVudENvbmZpZyA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKGtleSk7XHJcbiAgICAgICAgY29uc3QgX2NvbmZpZyA9IChjdXJyZW50Q29uZmlnID8gSlNPTi5wYXJzZShjdXJyZW50Q29uZmlnKSA6IHsgfSkgfHwge307XHJcbiAgICAgICAgaWYgKGNvbmZpZykge1xyXG4gICAgICAgICAgICBpZiAoX2NvbmZpZykge1xyXG4gICAgICAgICAgICAgICAgX2NvbmZpZ1tMT0NBTEVJRF0gPSBjb25maWc7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKGtleSwgSlNPTi5zdHJpbmdpZnkoX2NvbmZpZykpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKGtleSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh0aGlzLmh0dHBSZXN0U2VydmljZSkge1xyXG4gICAgICAgICAgICAvLyDkv53lrZjoh7PmlbDmja7lupNcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3NhdmVVc2VyQ29uZmlnKGtleSwgIGNvbmZpZyA/IF9jb25maWcgOiAgJycpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIG9mKHRydWUpO1xyXG4gICAgfVxyXG5cclxuICAgIGdldFVzZXJDb25maWcoa2V5KTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgICAgICBpZiAodGhpcy5odHRwUmVzdFNlcnZpY2UpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2dldFVzZXJDb25maWcoa2V5KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBjb25zdCBjb25maWcgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShrZXkpO1xyXG4gICAgICAgICAgICBpZiAoY29uZmlnKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBjb24gPSBKU09OLnBhcnNlKGNvbmZpZyk7XHJcbiAgICAgICAgICAgICAgICBpZiAoY29uW3RoaXMubG9jYWxlU2VyLmxvY2FsZUlkXSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBvZihjb25bdGhpcy5sb2NhbGVTZXIubG9jYWxlSWRdKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKE9iamVjdC5rZXlzKGNvbikuaW5kZXhPZigndmlld0NvbHVtbnMnKSA+IC0xKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvZihjb24pO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBvZihudWxsKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBnZXRTZXR0aW5ncyhncmlkSUQ6IHN0cmluZykge1xyXG4gICAgICAgIGNvbnN0IGtleSA9IHRoaXMuY3JlYXRlQ29uZmlnS2V5KGdyaWRJRCk7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0VXNlckNvbmZpZyhrZXkpO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICBwcml2YXRlIF9zYXZlVXNlckNvbmZpZyhrZXksIGNvbmZpZykge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHVzZXJDb25maWdTZXR0aW5nID0ge1xyXG4gICAgICAgICAgICAgICAgY29uZmlna2V5MToga2V5LFxyXG4gICAgICAgICAgICAgICAgY29uZmlna2V5MjogJycsXHJcbiAgICAgICAgICAgICAgICBjb25maWdrZXkzOiAnJyxcclxuICAgICAgICAgICAgICAgIHRleHR2YWx1ZTogY29uZmlnID8gSlNPTi5zdHJpbmdpZnkoY29uZmlnKSA6ICAnJ1xyXG4gICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuaHR0cFJlc3RTZXJ2aWNlLnNhdmVVc2VyU2V0dGluZ3ModXNlckNvbmZpZ1NldHRpbmcpO1xyXG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgY29uc29sZS5lcnJvcihlKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmVzZXRVc2VyQ29uZmlnKGdyaWRJbnN0YW5jZSwgbW9kYWxSZWYpIHtcclxuICAgICAgICBjb25zdCByZXN0b3JEZWZhdWx0VGV4dCA9IHRoaXMubG9jYWxlU2VyLmdldFZhbHVlKCdkYXRhZ3JpZC5zZXR0aW5ncy5yZXN0b3JlRGVmYXVsdFNldHRpbmdzVGV4dCcpIHx8ICfnoa7orqTopoHmgaLlpI3pu5jorqTorr7nva7lkJfvvJ8nO1xyXG4gICAgICAgIHRoaXMubWVzc2FnZXIuY29uZmlybShyZXN0b3JEZWZhdWx0VGV4dCkucGlwZShcclxuICAgICAgICAgICAgc3dpdGNoTWFwKCAodDogYm9vbGVhbikgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKHQpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBrZXkgPSB0aGlzLmNyZWF0ZUNvbmZpZ0tleShncmlkSW5zdGFuY2UuaWQpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnNldFVzZXJDb25maWcoa2V5LCAnJyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gb2YodCk7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgKS5zdWJzY3JpYmUoKHQ6IGJvb2xlYW4pID0+IHtcclxuICAgICAgICAgICAgaWYgKHQpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMucmVzZXRHcmlkVmlldyhncmlkSW5zdGFuY2UpO1xyXG4gICAgICAgICAgICAgICAgbW9kYWxSZWYuY2xvc2UoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgX2dldFVzZXJDb25maWcoa2V5KSB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuaHR0cFJlc3RTZXJ2aWNlLmdldFVzZXJTZXR0aW5ncyhrZXkpLnBpcGUoXHJcbiAgICAgICAgICAgICAgICBtYXAoKHVjczogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHVjcyAmJiB1Y3MudGV4dFZhbHVlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGMgPSBKU09OLnBhcnNlKHVjcy50ZXh0VmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNbdGhpcy5sb2NhbGVTZXIubG9jYWxlSWRdKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oa2V5LCB1Y3MudGV4dFZhbHVlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY1t0aGlzLmxvY2FsZVNlci5sb2NhbGVJZF07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKGtleSwgSlNPTi5zdHJpbmdpZnkoe1t0aGlzLmxvY2FsZVNlci5sb2NhbGVJZF06IGN9KSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKE9iamVjdC5rZXlzKGMpLmluZGV4T2YoJ3ZpZXdDb2x1bW5zJykgPiAtMSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKGUpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbn1cclxuIl19