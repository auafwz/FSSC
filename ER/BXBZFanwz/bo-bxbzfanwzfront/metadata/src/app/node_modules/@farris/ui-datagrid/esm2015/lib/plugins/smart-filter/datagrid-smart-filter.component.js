/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { cloneDeep } from 'lodash-es';
import { IdService } from '@farris/ui-common';
import { Component, ViewChild, TemplateRef, Renderer2, ElementRef, NgZone, Injector, Input, HostListener, Optional } from '@angular/core';
import { FilterPanelService } from '@farris/ui-filter-panel';
import { DatagridComponent } from '../../datagrid.component';
import { DatagridSmartFilterService } from '../../services/datagrid-smart-filter.service';
export class DatagridSmartFilterComponent {
    /**
     * @param {?} render
     * @param {?} el
     * @param {?} zone
     * @param {?} inject
     * @param {?} filterPanelService
     * @param {?} smartFilterSer
     * @param {?} dg
     */
    constructor(render, el, zone, inject, filterPanelService, smartFilterSer, dg) {
        this.render = render;
        this.el = el;
        this.zone = zone;
        this.inject = inject;
        this.filterPanelService = filterPanelService;
        this.smartFilterSer = smartFilterSer;
        this.dg = dg;
        this.filterData = null;
        this.disabled = false;
        this.smartFilterDataChanged$ = null;
        this.removeFilter$ = null;
        this.clearAllFilter$ = null;
        this.smartFilterEvents = [];
        this.idService = this.inject.get(IdService, null);
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        if (!this.removeFilter$) {
            this.removeFilter$ = this.smartFilterSer.removeFilter.subscribe((/**
             * @param {?} e
             * @return {?}
             */
            (e) => {
                if (e && e.labelCode === this.column.field) {
                    this.filterData = null;
                    this.render.removeClass(this.el.nativeElement, 'active');
                }
            }));
            this.smartFilterEvents.push(this.removeFilter$);
        }
        if (!this.clearAllFilter$) {
            this.clearAllFilter$ = this.smartFilterSer.clearAllFilter.subscribe((/**
             * @return {?}
             */
            () => {
                this.filterData = null;
                this.render.removeClass(this.el.nativeElement, 'active');
            }));
            this.smartFilterEvents.push(this.clearAllFilter$);
        }
        if (this.dg && !this.smartFilterDataChanged$) {
            this.smartFilterDataChanged$ = this.dg.dgs['smartFilterDataChange'].subscribe((/**
             * @param {?} e
             * @return {?}
             */
            (e) => {
                if (e && this.column.field === e.fieldCode) {
                    this.filterData.value = e.value;
                    this.filterData.control.single = e.control.single;
                }
            }));
            this.smartFilterEvents.push(this.smartFilterDataChanged$);
        }
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        if (this.filterPanelRef) {
            this.filterPanelService.hidePanel();
            this.filterPanelRef = null;
        }
        if (this.smartFilterEvents && this.smartFilterEvents.length) {
            this.smartFilterEvents.forEach((/**
             * @param {?} n
             * @return {?}
             */
            n => {
                n.unsubscribe();
                n = null;
            }));
            this.smartFilterEvents = [];
        }
    }
    /**
     * @private
     * @return {?}
     */
    getFilterData() {
        const { field, title } = this.column;
        if (!this.filterData) {
            this.filterData = {
                id: field,
                labelCode: field,
                code: field,
                name: title,
                control: this.smartFilterSer.getColumnFilterData(this.column),
                placeHolder: '',
                value: {
                    value: ''
                }
            };
        }
        return cloneDeep(this.filterData);
    }
    /**
     * @private
     * @param {?} $event
     * @return {?}
     */
    getPanelPosition($event) {
        /** @type {?} */
        let x = $event.pageX - 33;
        /** @type {?} */
        const y = $event.pageY + 9;
        /** @type {?} */
        const targetRect = $event.target.getBoundingClientRect();
        /** @type {?} */
        let moveArrow = 0;
        if (window.innerWidth - x < 380) {
            /** @type {?} */
            const i = 380 - (window.innerWidth - x);
            x = x - i - 20;
            moveArrow = targetRect.left - x;
        }
        return { x, y, moveArrow };
    }
    /**
     * @private
     * @return {?}
     */
    hideFilterPanel() {
        if (this.filterPanelRef) {
            this.filterPanelService.hidePanel();
            this.filterPanelRef = null;
            if (!this.filterData || !this.filterData.valueText) {
                this.render.removeClass(this.el.nativeElement, 'active');
            }
        }
    }
    /**
     * @private
     * @param {?} e
     * @return {?}
     */
    clearColumnFilter(e) {
        this.hideFilterPanel();
        this.filterData = null;
        this.smartFilterSer.removeCondition(e);
    }
    /**
     * @param {?} $event
     * @return {?}
     */
    showFilterPanel($event) {
        $event.stopPropagation();
        this.render.addClass(this.el.nativeElement, 'active');
        const { x, y, moveArrow } = this.getPanelPosition($event);
        this.filterPanelRef = this.filterPanelService.showPanel({
            left: x,
            top: y,
            item: this.getFilterData(),
            panelExtendTemplate: this.column.sortable ? this.sortTmp : null,
            localStorageKey: 'smartfilter_' + this.dg.dgs.createConfigKey(this.dg.id),
            target: $event.target
        });
        if (moveArrow) {
            /** @type {?} */
            const arrowEl = this.filterPanelRef['el'].querySelector('.f-filter-panel-arrow');
            if (arrowEl) {
                this.render.setStyle(arrowEl, 'left', `${moveArrow}px`);
            }
        }
        this.filterPanelRef.hidePanel.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        e => {
            this.hideFilterPanel();
        }));
        this.filterPanelRef.filterSubmit.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        e => {
            // console.log('提交', e);
            if (e.filter && e.filter.length) {
                this.filterData = e.item || null;
                this.hideFilterPanel();
                this.smartFilterSer.filterConditionChanged({ conditions: e.filter, controlData: e.item });
            }
            else {
                this.clearColumnFilter(e.item);
            }
        }));
        this.filterPanelRef.clearFilter.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        (e) => {
            this.clearColumnFilter(e);
        }));
    }
    /**
     * @param {?} $event
     * @return {?}
     */
    onClick($event) {
        $event.stopPropagation();
        if (this.disabled) {
            return;
        }
        this.showFilterPanel($event);
        return false;
    }
    /**
     * @param {?} $event
     * @param {?} order
     * @return {?}
     */
    onSort($event, order) {
        $event.stopPropagation();
        if (this.column.order === order) {
            this.column.order = '';
        }
        else {
            this.column.order = order;
        }
        /** @type {?} */
        const sortName = this.dg.sortName;
        /** @type {?} */
        const sortOrder = this.dg.sortOrder;
        /** @type {?} */
        let sortFields = [];
        /** @type {?} */
        let sortOrders = [];
        if (sortName) {
            sortFields = sortName.split(',');
            sortOrders = sortOrder.split(',');
        }
        /** @type {?} */
        let newOrder = this.column.order;
        /** @type {?} */
        const i = sortFields.findIndex((/**
         * @param {?} n
         * @return {?}
         */
        n => n === this.column.field));
        if (i >= 0) {
            if (newOrder === '') {
                newOrder = undefined;
                sortFields.splice(i, 1);
                sortOrders.splice(i, 1);
            }
            else {
                sortOrders[i] = newOrder;
            }
        }
        else {
            if (this.dg.multiSort) {
                sortFields.push(this.column.field);
                sortOrders.push(newOrder);
            }
            else {
                sortFields = [this.column.field];
                sortOrders = [newOrder];
            }
        }
        this.dg.sortName = sortFields.join(',');
        this.dg.sortOrder = sortOrders.join(',');
        this.dg.dfs.setSortInfo(this.dg.sortName, this.dg.sortOrder);
        this.dg.beforeSortColumn(this.dg.sortName, this.dg.sortOrder, this.dg).subscribe((/**
         * @return {?}
         */
        () => {
            this.dg.onColumnSorted();
        }));
    }
}
DatagridSmartFilterComponent.decorators = [
    { type: Component, args: [{
                selector: 'datagrid-smart-filter, [datagrid-smart-filter]',
                template: "<ng-template #sort>\r\n    <div class=\"f-filter-panel-sort-wrapper f-filter-panel-sort-wrapper-hasfilter\">\r\n        <div class=\"f-filter-panel-sort\">\r\n            <div class=\"panel-sort-up panel-sort-item\" [class.active]=\"column?.order === 'asc'\" (click)=\"onSort($event, 'asc')\">\r\n                <span class=\"panel-sort-item-icon f-icon f-icon-col-ascendingorder\"></span>\r\n                <span class=\"panel-sort-item-text\">{{ 'datagrid.settings.asc' | locale: '\u5347\u5E8F' }}</span>\r\n            </div>\r\n            <div class=\"panel-sort-down panel-sort-item\" [class.active]=\"column?.order === 'desc'\"  (click)=\"onSort($event, 'desc')\">\r\n                <span class=\"panel-sort-item-icon f-icon f-icon-col-descendingorder\"></span>\r\n                <span class=\"panel-sort-item-text\">{{ 'datagrid.settings.desc' | locale: '\u964D\u5E8F' }}</span>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</ng-template>",
                providers: [
                    FilterPanelService
                ]
            }] }
];
/** @nocollapse */
DatagridSmartFilterComponent.ctorParameters = () => [
    { type: Renderer2 },
    { type: ElementRef },
    { type: NgZone },
    { type: Injector },
    { type: FilterPanelService },
    { type: DatagridSmartFilterService },
    { type: DatagridComponent, decorators: [{ type: Optional }] }
];
DatagridSmartFilterComponent.propDecorators = {
    column: [{ type: Input }],
    filterData: [{ type: Input }],
    disabled: [{ type: Input }],
    sortTmp: [{ type: ViewChild, args: ['sort',] }],
    onClick: [{ type: HostListener, args: ['click', ['$event'],] }]
};
if (false) {
    /** @type {?} */
    DatagridSmartFilterComponent.prototype.column;
    /** @type {?} */
    DatagridSmartFilterComponent.prototype.filterData;
    /** @type {?} */
    DatagridSmartFilterComponent.prototype.disabled;
    /** @type {?} */
    DatagridSmartFilterComponent.prototype.sortTmp;
    /** @type {?} */
    DatagridSmartFilterComponent.prototype.filterPanelRef;
    /**
     * @type {?}
     * @private
     */
    DatagridSmartFilterComponent.prototype.idService;
    /**
     * @type {?}
     * @private
     */
    DatagridSmartFilterComponent.prototype.smartFilterDataChanged$;
    /**
     * @type {?}
     * @private
     */
    DatagridSmartFilterComponent.prototype.removeFilter$;
    /**
     * @type {?}
     * @private
     */
    DatagridSmartFilterComponent.prototype.clearAllFilter$;
    /**
     * @type {?}
     * @private
     */
    DatagridSmartFilterComponent.prototype.smartFilterEvents;
    /**
     * @type {?}
     * @private
     */
    DatagridSmartFilterComponent.prototype.render;
    /**
     * @type {?}
     * @private
     */
    DatagridSmartFilterComponent.prototype.el;
    /**
     * @type {?}
     * @private
     */
    DatagridSmartFilterComponent.prototype.zone;
    /**
     * @type {?}
     * @private
     */
    DatagridSmartFilterComponent.prototype.inject;
    /**
     * @type {?}
     * @private
     */
    DatagridSmartFilterComponent.prototype.filterPanelService;
    /**
     * @type {?}
     * @private
     */
    DatagridSmartFilterComponent.prototype.smartFilterSer;
    /**
     * @type {?}
     * @private
     */
    DatagridSmartFilterComponent.prototype.dg;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YWdyaWQtc21hcnQtZmlsdGVyLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvdWktZGF0YWdyaWQvIiwic291cmNlcyI6WyJsaWIvcGx1Z2lucy9zbWFydC1maWx0ZXIvZGF0YWdyaWQtc21hcnQtZmlsdGVyLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUN0QyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDOUMsT0FBTyxFQUNILFNBQVMsRUFBVSxTQUFTLEVBQUUsV0FBVyxFQUFFLFNBQVMsRUFBRSxVQUFVLEVBQ2hFLE1BQU0sRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFhLFlBQVksRUFBRSxRQUFRLEVBQzdELE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxrQkFBa0IsRUFBd0IsTUFBTSx5QkFBeUIsQ0FBQztBQUNuRixPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUM3RCxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSw4Q0FBOEMsQ0FBQztBQVMxRixNQUFNLE9BQU8sNEJBQTRCOzs7Ozs7Ozs7O0lBYXJDLFlBQ1ksTUFBaUIsRUFBVSxFQUFjLEVBQ3pDLElBQVksRUFBVSxNQUFnQixFQUN0QyxrQkFBc0MsRUFDdEMsY0FBMEMsRUFDOUIsRUFBcUI7UUFKakMsV0FBTSxHQUFOLE1BQU0sQ0FBVztRQUFVLE9BQUUsR0FBRixFQUFFLENBQVk7UUFDekMsU0FBSSxHQUFKLElBQUksQ0FBUTtRQUFVLFdBQU0sR0FBTixNQUFNLENBQVU7UUFDdEMsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFvQjtRQUN0QyxtQkFBYyxHQUFkLGNBQWMsQ0FBNEI7UUFDOUIsT0FBRSxHQUFGLEVBQUUsQ0FBbUI7UUFoQnBDLGVBQVUsR0FBRyxJQUFJLENBQUM7UUFDbEIsYUFBUSxHQUFH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Q0FBQyxTQUFTOzs7UUFBQyxHQUFHLEVBQUU7WUFDbEYsSUFBSSxDQUFDLEVBQUUsQ0FBQyxjQUFjLEVBQUUsQ0FBQztRQUM3QixDQUFDLEVBQUMsQ0FBQztJQUNQLENBQUM7OztZQWxPSixTQUFTLFNBQUM7Z0JBQ1AsUUFBUSxFQUFFLGdEQUFnRDtnQkFDMUQsODhCQUFtRDtnQkFDbkQsU0FBUyxFQUFFO29CQUNQLGtCQUFrQjtpQkFDckI7YUFDSjs7OztZQWI4QyxTQUFTO1lBQUUsVUFBVTtZQUNoRSxNQUFNO1lBQUUsUUFBUTtZQUVYLGtCQUFrQjtZQUVsQiwwQkFBMEI7WUFEMUIsaUJBQWlCLHVCQTRCakIsUUFBUTs7O3FCQWpCWixLQUFLO3lCQUNMLEtBQUs7dUJBQ0wsS0FBSztzQkFFTCxTQUFTLFNBQUMsTUFBTTtzQkErSmhCLFlBQVksU0FBQyxPQUFPLEVBQUUsQ0FBQyxRQUFRLENBQUM7Ozs7SUFuS2pDLDhDQUFnQjs7SUFDaEIsa0RBQTJCOztJQUMzQixnREFBMEI7O0lBRTFCLCtDQUE2Qzs7SUFFN0Msc0RBQXFDOzs7OztJQUNyQyxpREFBNkI7Ozs7O0lBQzdCLCtEQUF1Qzs7Ozs7SUFDdkMscURBQTZCOzs7OztJQUM3Qix1REFBK0I7Ozs7O0lBQy9CLHlEQUErQjs7Ozs7SUFFM0IsOENBQXlCOzs7OztJQUFFLDBDQUFzQjs7Ozs7SUFDakQsNENBQW9COzs7OztJQUFFLDhDQUF3Qjs7Ozs7SUFDOUMsMERBQThDOzs7OztJQUM5QyxzREFBa0Q7Ozs7O0lBQ2xELDBDQUF5QyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGNsb25lRGVlcCB9IGZyb20gJ2xvZGFzaC1lcyc7XHJcbmltcG9ydCB7IElkU2VydmljZSB9IGZyb20gJ0BmYXJyaXMvdWktY29tbW9uJztcclxuaW1wb3J0IHtcclxuICAgIENvbXBvbmVudCwgT25Jbml0LCBWaWV3Q2hpbGQsIFRlbXBsYXRlUmVmLCBSZW5kZXJlcjIsIEVsZW1lbnRSZWYsXHJcbiAgICBOZ1pvbmUsIEluamVjdG9yLCBJbnB1dCwgT25EZXN0cm95LCBIb3N0TGlzdGVuZXIsIE9wdGlvbmFsXHJcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEZpbHRlclBhbmVsU2VydmljZSwgRmlsdGVyUGFuZWxDb21wb25lbnQgfSBmcm9tICdAZmFycmlzL3VpLWZpbHRlci1wYW5lbCc7XHJcbmltcG9ydCB7IERhdGFncmlkQ29tcG9uZW50IH0gZnJvbSAnLi4vLi4vZGF0YWdyaWQuY29tcG9uZW50JztcclxuaW1wb3J0IHsgRGF0YWdyaWRTbWFydEZpbHRlclNlcnZpY2UgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9kYXRhZ3JpZC1zbWFydC1maWx0ZXIuc2VydmljZSc7XHJcblxyXG5AQ29tcG9uZW50KHtcclxuICAgIHNlbGVjdG9yOiAnZGF0YWdyaWQtc21hcnQtZmlsdGVyLCBbZGF0YWdyaWQtc21hcnQtZmlsdGVyXScsXHJcbiAgICB0ZW1wbGF0ZVVybDogJ2RhdGFncmlkLXNtYXJ0LWZpbHRlci5jb21wb25lbnQuaHRtbCcsXHJcbiAgICBwcm92aWRlcnM6IFtcclxuICAgICAgICBGaWx0ZXJQYW5lbFNlcnZpY2VcclxuICAgIF1cclxufSlcclxuZXhwb3J0IGNsYXNzIERhdGFncmlkU21hcnRGaWx0ZXJDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIE9uRGVzdHJveSB7XHJcbiAgICBASW5wdXQoKSBjb2x1bW47XHJcbiAgICBASW5wdXQoKSBmaWx0ZXJEYXRhID0gbnVsbDtcclxuICAgIEBJbnB1dCgpIGRpc2FibGVkID0gZmFsc2U7XHJcblxyXG4gICAgQFZpZXdDaGlsZCgnc29ydCcpIHNvcnRUbXA6IFRlbXBsYXRlUmVmPGFueT47XHJcblxyXG4gICAgZmlsdGVyUGFuZWxSZWY6IEZpbHRlclBhbmVsQ29tcG9uZW50O1xyXG4gICAgcHJpdmF0ZSBpZFNlcnZpY2U6IElkU2VydmljZTtcclxuICAgIHByaXZhdGUgc21hcnRGaWx0ZXJEYXRhQ2hhbmdlZCQgPSBudWxsO1xyXG4gICAgcHJpdmF0ZSByZW1vdmVGaWx0ZXIkID0gbnVsbDtcclxuICAgIHByaXZhdGUgY2xlYXJBbGxGaWx0ZXIkID0gbnVsbDtcclxuICAgIHByaXZhdGUgc21hcnRGaWx0ZXJFdmVudHMgPSBbXTtcclxuICAgIGNvbnN0cnVjdG9yKFxyXG4gICAgICAgIHByaXZhdGUgcmVuZGVyOiBSZW5kZXJlcjIsIHByaXZhdGUgZWw6IEVsZW1lbnRSZWYsXHJcbiAgICAgICAgcHJpdmF0ZSB6b25lOiBOZ1pvbmUsIHByaXZhdGUgaW5qZWN0OiBJbmplY3RvcixcclxuICAgICAgICBwcml2YXRlIGZpbHRlclBhbmVsU2VydmljZTogRmlsdGVyUGFuZWxTZXJ2aWNlLFxyXG4gICAgICAgIHByaXZhdGUgc21hcnRGaWx0ZXJTZXI6IERhdGFncmlkU21hcnRGaWx0ZXJTZXJ2aWNlLFxyXG4gICAgICAgIEBPcHRpb25hbCgpIHByaXZhdGUgZGc6IERhdGFncmlkQ29tcG9uZW50XHJcbiAgICAgICAgKSB7XHJcbiAgICAgICAgICAgIHRoaXMuaWRTZXJ2aWNlID0gdGhpcy5pbmplY3QuZ2V0KElkU2VydmljZSwgbnVsbCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgIG5nT25Jbml0KCkge1xyXG5cclxuICAgICAgICBpZiAoIXRoaXMucmVtb3ZlRmlsdGVyJCkge1xyXG4gICAgICAgICAgICB0aGlzLnJlbW92ZUZpbHRlciQgPSB0aGlzLnNtYXJ0RmlsdGVyU2VyLnJlbW92ZUZpbHRlci5zdWJzY3JpYmUoKGU6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGUgJiYgZS5sYWJlbENvZGUgID09PSB0aGlzLmNvbHVtbi5maWVsZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZmlsdGVyRGF0YSA9IG51bGw7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW5kZXIucmVtb3ZlQ2xhc3ModGhpcy5lbC5uYXRpdmVFbGVtZW50LCAnYWN0aXZlJyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5zbWFydEZpbHRlckV2ZW50cy5wdXNoKHRoaXMucmVtb3ZlRmlsdGVyJCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoIXRoaXMuY2xlYXJBbGxGaWx0ZXIkKSB7XHJcbiAgICAgICAgICAgIHRoaXMuY2xlYXJBbGxGaWx0ZXIkID0gdGhpcy5zbWFydEZpbHRlclNlci5jbGVhckFsbEZpbHRlci5zdWJzY3JpYmUoICgpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZmlsdGVyRGF0YSA9IG51bGw7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlci5yZW1vdmVDbGFzcyh0aGlzLmVsLm5hdGl2ZUVsZW1lbnQsICdhY3RpdmUnKTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICB0aGlzLnNtYXJ0RmlsdGVyRXZlbnRzLnB1c2godGhpcy5jbGVhckFsbEZpbHRlciQpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodGhpcy5kZyAmJiAhdGhpcy5zbWFydEZpbHRlckRhdGFDaGFuZ2VkJCkge1xyXG4gICAgICAgICAgICB0aGlzLnNtYXJ0RmlsdGVyRGF0YUNoYW5nZWQkID0gdGhpcy5kZy5kZ3NbJ3NtYXJ0RmlsdGVyRGF0YUNoYW5nZSddLnN1YnNjcmliZSgoZTogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZSAmJiB0aGlzLmNvbHVtbi5maWVsZCA9PT0gZS5maWVsZENvZGUpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmZpbHRlckRhdGEudmFsdWUgPSBlLnZhbHVlO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZmlsdGVyRGF0YS5jb250cm9sLnNpbmdsZSA9IGUuY29udHJvbC5zaW5nbGU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB0aGlzLnNtYXJ0RmlsdGVyRXZlbnRzLnB1c2godGhpcy5zbWFydEZpbHRlckRhdGFDaGFuZ2VkJCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIG5nT25EZXN0cm95KCkge1xyXG4gICAgICAgIGlmICh0aGlzLmZpbHRlclBhbmVsUmVmKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZmlsdGVyUGFuZWxTZXJ2aWNlLmhpZGVQYW5lbCgpO1xyXG4gICAgICAgICAgICB0aGlzLmZpbHRlclBhbmVsUmVmID0gbnVsbDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0aGlzLnNtYXJ0RmlsdGVyRXZlbnRzICYmIHRoaXMuc21hcnRGaWx0ZXJFdmVudHMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc21hcnRGaWx0ZXJFdmVudHMuZm9yRWFjaChuID0+IHtcclxuICAgICAgICAgICAgICAgIG4udW5zdWJzY3JpYmUoKTtcclxuICAgICAgICAgICAgICAgIG4gPSBudWxsO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuc21hcnRGaWx0ZXJFdmVudHMgPSBbXTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG5cclxuXHJcbiAgICBwcml2YXRlIGdldEZpbHRlckRhdGEoKSB7XHJcbiAgICAgICAgY29uc3QgeyBmaWVsZCwgdGl0bGUgfSA9IHRoaXMuY29sdW1uO1xyXG4gICAgICAgIGlmICghdGhpcy5maWx0ZXJEYXRhKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZmlsdGVyRGF0YSA9IHtcclxuICAgICAgICAgICAgICAgIGlkOiBmaWVsZCxcclxuICAgICAgICAgICAgICAgIGxhYmVsQ29kZTogZmllbGQsXHJcbiAgICAgICAgICAgICAgICBjb2RlOiBmaWVsZCxcclxuICAgICAgICAgICAgICAgIG5hbWU6IHRpdGxlLFxyXG4gICAgICAgICAgICAgICAgY29udHJvbDogdGhpcy5zbWFydEZpbHRlclNlci5nZXRDb2x1bW5GaWx0ZXJEYXRhKHRoaXMuY29sdW1uKSxcclxuICAgICAgICAgICAgICAgIHBsYWNlSG9sZGVyOiAnJyxcclxuICAgICAgICAgICAgICAgIHZhbHVlOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFsdWU6ICcnXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gY2xvbmVEZWVwKHRoaXMuZmlsdGVyRGF0YSk7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIHByaXZhdGUgZ2V0UGFuZWxQb3NpdGlvbigkZXZlbnQpIHtcclxuICAgICAgICBsZXQgeCA9ICRldmVudC5wYWdlWCAtIDMzO1xyXG4gICAgICAgIGNvbnN0IHkgPSAkZXZlbnQucGFnZVkgKyAgOTtcclxuICAgICAgICBjb25zdCB0YXJnZXRSZWN0ID0gJGV2ZW50LnRhcmdldC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcclxuICAgICAgICBsZXQgbW92ZUFycm93ID0gMDtcclxuICAgICAgICBpZiAod2luZG93LmlubmVyV2lkdGggLSB4IDwgMzgwKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGkgPSAzODAgLSAod2luZG93LmlubmVyV2lkdGggLSB4KTtcclxuICAgICAgICAgICAgeCA9IHggLSBpIC0gMjA7XHJcbiAgICAgICAgICAgIG1vdmVBcnJvdyA9IHRhcmdldFJlY3QubGVmdCAtIHg7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4geyB4LCB5LCBtb3ZlQXJyb3d9O1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgaGlkZUZpbHRlclBhbmVsKCkge1xyXG4gICAgICAgIGlmICh0aGlzLmZpbHRlclBhbmVsUmVmKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZmlsdGVyUGFuZWxTZXJ2aWNlLmhpZGVQYW5lbCgpO1xyXG4gICAgICAgICAgICB0aGlzLmZpbHRlclBhbmVsUmVmID0gbnVsbDtcclxuICAgICAgICAgICAgaWYgKCF0aGlzLmZpbHRlckRhdGEgfHwgIXRoaXMuZmlsdGVyRGF0YS52YWx1ZVRleHQpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyLnJlbW92ZUNsYXNzKHRoaXMuZWwubmF0aXZlRWxlbWVudCwgJ2FjdGl2ZScpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgY2xlYXJDb2x1bW5GaWx0ZXIoZSkge1xyXG4gICAgICAgIHRoaXMuaGlkZUZpbHRlclBhbmVsKCk7XHJcbiAgICAgICAgdGhpcy5maWx0ZXJEYXRhID0gbnVsbDtcclxuICAgICAgICB0aGlzLnNtYXJ0RmlsdGVyU2VyLnJlbW92ZUNvbmRpdGlvbihlKTtcclxuICAgIH1cclxuXHJcbiAgICBzaG93RmlsdGVyUGFuZWwoJGV2ZW50KSB7XHJcbiAgICAgICAgJGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xyXG5cclxuICAgICAgICB0aGlzLnJlbmRlci5hZGRDbGFzcyh0aGlzLmVsLm5hdGl2ZUVsZW1lbnQsICdhY3RpdmUnKTtcclxuICAgICAgICBjb25zdCB7IHgsIHksIG1vdmVBcnJvdyB9ID0gdGhpcy5nZXRQYW5lbFBvc2l0aW9uKCRldmVudCk7XHJcbiAgICAgICAgdGhpcy5maWx0ZXJQYW5lbFJlZiA9IHRoaXMuZmlsdGVyUGFuZWxTZXJ2aWNlLnNob3dQYW5lbCh7XHJcbiAgICAgICAgICAgIGxlZnQ6IHgsXHJcbiAgICAgICAgICAgIHRvcDogeSxcclxuICAgICAgICAgICAgaXRlbTogdGhpcy5nZXRGaWx0ZXJEYXRhKCksXHJcbiAgICAgICAgICAgIHBhbmVsRXh0ZW5kVGVtcGxhdGU6IHRoaXMuY29sdW1uLnNvcnRhYmxlID8gdGhpcy5zb3J0VG1wIDogbnVsbCxcclxuICAgICAgICAgICAgbG9jYWxTdG9yYWdlS2V5OiAnc21hcnRmaWx0ZXJfJyArIHRoaXMuZGcuZGdzLmNyZWF0ZUNvbmZpZ0tleSh0aGlzLmRnLmlkKSxcclxuICAgICAgICAgICAgdGFyZ2V0OiAkZXZlbnQudGFyZ2V0XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGlmIChtb3ZlQXJyb3cpIHtcclxuICAgICAgICAgICAgY29uc3QgYXJyb3dFbCA9IHRoaXMuZmlsdGVyUGFuZWxSZWZbJ2VsJ10ucXVlcnlTZWxlY3RvcignLmYtZmlsdGVyLXBhbmVsLWFycm93Jyk7XHJcbiAgICAgICAgICAgIGlmIChhcnJvd0VsKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlci5zZXRTdHlsZShhcnJvd0VsLCAnbGVmdCcsIGAke21vdmVBcnJvd31weGApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLmZpbHRlclBhbmVsUmVmLmhpZGVQYW5lbC5zdWJzY3JpYmUoZSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuaGlkZUZpbHRlclBhbmVsKCk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHRoaXMuZmlsdGVyUGFuZWxSZWYuZmlsdGVyU3VibWl0LnN1YnNjcmliZShlID0+IHtcclxuICAgICAgICAgICAgLy8gY29uc29sZS5sb2coJ+aPkOS6pCcsIGUpO1xyXG4gICAgICAgICAgICBpZiAoZS5maWx0ZXIgJiYgZS5maWx0ZXIubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmZpbHRlckRhdGEgPSBlLml0ZW0gfHwgbnVsbDtcclxuICAgICAgICAgICAgICAgIHRoaXMuaGlkZUZpbHRlclBhbmVsKCk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNtYXJ0RmlsdGVyU2VyLmZpbHRlckNvbmRpdGlvbkNoYW5nZWQoeyBjb25kaXRpb25zOiBlLmZpbHRlciwgY29udHJvbERhdGE6IGUuaXRlbSB9KTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuY2xlYXJDb2x1bW5GaWx0ZXIoZS5pdGVtKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICB0aGlzLmZpbHRlclBhbmVsUmVmLmNsZWFyRmlsdGVyLnN1YnNjcmliZSgoZTogYW55KSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuY2xlYXJDb2x1bW5GaWx0ZXIoZSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgQEhvc3RMaXN0ZW5lcignY2xpY2snLCBbJyRldmVudCddKVxyXG4gICAgb25DbGljaygkZXZlbnQpIHtcclxuICAgICAgICAkZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XHJcbiAgICAgICAgaWYgKHRoaXMuZGlzYWJsZWQpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLnNob3dGaWx0ZXJQYW5lbCgkZXZlbnQpO1xyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuXHJcbiAgICBvblNvcnQoJGV2ZW50LCBvcmRlcikge1xyXG4gICAgICAgICRldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcclxuXHJcbiAgICAgICAgaWYgKHRoaXMuY29sdW1uLm9yZGVyID09PSBvcmRlcikge1xyXG4gICAgICAgICAgICB0aGlzLmNvbHVtbi5vcmRlciA9ICcnO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuY29sdW1uLm9yZGVyID0gb3JkZXI7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBzb3J0TmFtZSA9IHRoaXMuZGcuc29ydE5hbWU7XHJcbiAgICAgICAgY29uc3Qgc29ydE9yZGVyID0gdGhpcy5kZy5zb3J0T3JkZXI7XHJcbiAgICAgICAgbGV0IHNvcnRGaWVsZHMgPSBbXTtcclxuICAgICAgICBsZXQgc29ydE9yZGVycyA9IFtdO1xyXG4gICAgICAgIGlmIChzb3J0TmFtZSkge1xyXG4gICAgICAgICAgICBzb3J0RmllbGRzID0gc29ydE5hbWUuc3BsaXQoJywnKTtcclxuICAgICAgICAgICAgc29ydE9yZGVycyA9IHNvcnRPcmRlci5zcGxpdCgnLCcpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgbGV0IG5ld09yZGVyID0gIHRoaXMuY29sdW1uLm9yZGVyO1xyXG4gICAgICAgIGNvbnN0IGkgPSBzb3J0RmllbGRzLmZpbmRJbmRleChuID0+IG4gPT09IHRoaXMuY29sdW1uLmZpZWxkKTtcclxuICAgICAgICBpZiAoaSA+PSAwKSB7XHJcbiAgICAgICAgICAgIGlmIChuZXdPcmRlciA9PT0gJycpIHtcclxuICAgICAgICAgICAgICAgIG5ld09yZGVyID0gdW5kZWZpbmVkO1xyXG4gICAgICAgICAgICAgICAgc29ydEZpZWxkcy5zcGxpY2UoaSwgMSk7XHJcbiAgICAgICAgICAgICAgICBzb3J0T3JkZXJzLnNwbGljZShpLCAxKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHNvcnRPcmRlcnNbaV0gPSBuZXdPcmRlcjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmRnLm11bHRpU29ydCkge1xyXG4gICAgICAgICAgICAgICAgc29ydEZpZWxkcy5wdXNoKHRoaXMuY29sdW1uLmZpZWxkKTtcclxuICAgICAgICAgICAgICAgIHNvcnRPcmRlcnMucHVzaChuZXdPcmRlcik7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBzb3J0RmllbGRzID0gW3RoaXMuY29sdW1uLmZpZWxkXTtcclxuICAgICAgICAgICAgICAgIHNvcnRPcmRlcnMgPSBbbmV3T3JkZXJdO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLmRnLnNvcnROYW1lID0gc29ydEZpZWxkcy5qb2luKCcsJyk7XHJcbiAgICAgICAgdGhpcy5kZy5zb3J0T3JkZXIgPSBzb3J0T3JkZXJzLmpvaW4oJywnKTtcclxuICAgICAgICB0aGlzLmRnLmRmcy5zZXRTb3J0SW5mbyh0aGlzLmRnLnNvcnROYW1lLCB0aGlzLmRnLnNvcnRPcmRlcik7XHJcblxyXG4gICAgICAgIHRoaXMuZGcuYmVmb3JlU29ydENvbHVtbih0aGlzLmRnLnNvcnROYW1lLCB0aGlzLmRnLnNvcnRPcmRlciwgdGhpcy5kZykuc3Vic2NyaWJlKCgpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5kZy5vbkNvbHVtblNvcnRlZCgpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==