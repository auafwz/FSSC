import { DynamicCommandHandler } from '../command';
import { DomService } from '../schema';
import { SchemaService } from '../schema/schema.service';
var ContextMetadataBuilder = /** @class */ (function () {
    function ContextMetadataBuilder() {
    }
    /**
     * 构造应用程序上下文元数据
     * @param formMetadataContent 表单元数据
     * @param stateMachineMetadata 状态机元数
     * @returns 应用程序上下文元数据
     */
    ContextMetadataBuilder.prototype.buildAppContextMetadata = function (formMetadataContent, stateMachineMetadata) {
        var module = formMetadataContent.module;
        var uiStates = module.states;
        var appContextMetadata = {
            identify: module.code,
            namespace: '',
            stateMachine: this.buildStataMachineMetadata(stateMachineMetadata),
            uiStates: this.buildUiStateMetadata(uiStates)
        };
        return appContextMetadata;
    };
    /**
     * 构造视图上下文元数据
     * @param componentId 组件标识
     * @param viewModel 视图模型元数据
     * @param declarations 外部接口定义
     * @param subscriptions 事件订阅定义
     * @returns 视图上下文元数据
     */
    ContextMetadataBuilder.prototype.buildViewContextMetadata = function (component, viewModel, schema, controllers) {
        var contextMetadata = {
            identify: component.id,
            namespace: '',
            commands: this.buildCommand(viewModel.commands),
            commandHandlers: this.buildCommandHandlers(viewModel.commands, controllers),
            commandHandlerExtends: [],
            form: this.buildFormMetadata(viewModel),
            formControls: this.buildFormControlMetadata(viewModel.fields, viewModel, schema, component),
            subForms: null,
            uiStates: this.buildUiStateMetadata(viewModel.states),
            bindingTo: viewModel.bindTo,
            viewModelCode: viewModel.code
        };
        return contextMetadata;
    };
    ContextMetadataBuilder.prototype.buildCommand = function (commandMetadataArray) {
        var commands = {};
        commandMetadataArray.reduce(function (previousValue, commandMetadata) {
            var ngCommand = {
                name: commandMetadata.code,
                params: {},
                paramDescriptions: {}
            };
            commandMetadata.params.reduce(function (previousCommand, param) {
                previousCommand.params[param.name] = param.value;
                previousCommand.paramDescriptions[param.name] = { type: 'string' };
                return previousCommand;
            }, ngCommand);
            previousValue[commandMetadata.code] = ngCommand;
            return previousValue;
        }, commands);
        return commands;
    };
    ContextMetadataBuilder.prototype.buildFormMetadata = function (viewModel) {
        return {
            formGroupName: viewModel.name,
            enableValidate: viewModel.enableValidation
        };
    };
    ContextMetadataBuilder.prototype.buildFormControlMetadata = function (formFields, viewModel, schema, component) {
        var formControls = {};
        var formFieldIds = formFields.map(function (formField) { return formField.id; });
        var schemaService = new SchemaService();
        var formFieldsMap = schemaService.getFieldsByIds(formFieldIds, schema, viewModel);
        var domService = new DomService();
        formFields.reduce(function (previousValue, field) {
            var schemaEntityField = formFieldsMap.has(field.id) ? formFieldsMap.get(field.id) : null;
            var binding = schemaEntityField ? schemaEntityField.bindingPath : '';
            var domElements = domService.getElementByBinding(component.contents, field.id);
            var validRules = [];
            var matchedElement = domElements[0];
            if (matchedElement) {
                var keys_1 = 'maxValue,minValue,required,require';
                Object.keys(matchedElement).forEach(function (key) {
                    if (keys_1.includes(key)) {
                        if (key === 'maxValue' && (matchedElement[key] !== null && matchedElement[key] !== undefined)) {
                            // 把最大值属性转换成validRule
                            validRules.push({ type: 'maxValue', constraints: [matchedElement[key]] });
                        }
                        else if (key === 'minValue' && (matchedElement[key] !== null && matchedElement[key] !== undefined)) {
                            // 把最小值属性转换成validRule
                            validRules.push({ type: 'minValue', constraints: [matchedElement[key]] });
                        }
                        else if (key === 'required' || key === 'require') {
                            // 把必填属性转换成validRule
                            // 必填表达式可以为状态机
                            if (matchedElement[key] === 'true' || matchedElement[key] === true) {
                                validRules.push({ type: 'required', constraints: [true] });
                            }
                        }
                    }
                });
            }
            previousValue[field.fieldName] = {
                /** 控件标识 */
                id: field.fieldName + "_" + field.id.substr(0, 13).replace('-', '_'),
                /** 控件名称 todo: 需要支持多语言 */
                name: matchedElement ? matchedElement.title : field.fieldName,
                /** 绑定字段路径 */
                binding: binding,
                /** 控件值更新时机 */
                updateOn: field.updateOn,
                /** 控件默认名称 */
                defaultI18nValue: matchedElement ? matchedElement.title : field.fieldName,
                /** 验证规则 */
                validRules: validRules
            };
            return previousValue;
        }, formControls);
        return formControls;
    };
    /**
     * 由状态机元数据创建状态机上下文描述
     * @param stateMachineMetadata 状态机元数据
     * @returns 状态机上下文描述
     */
    ContextMetadataBuilder.prototype.buildStataMachineMetadata = function (stateMachineMetadata) {
        var _this = this;
        // 声明状态机上下文元数据
        var stateMachine = {
            states: {},
            renderStates: {},
            actions: {}
        };
        if (!stateMachineMetadata) {
            return stateMachine;
        }
        // 由状态机元数据构造NgState
        stateMachineMetadata.state.reduce(function (previousValue, state) {
            previousValue.states[state.state] = {
                initialState: state.state === stateMachineMetadata.initialState
            };
            return previousValue;
        }, stateMachine);
        // 由状态机元数据构造NgRenderState
        Object.keys(stateMachineMetadata.renderState)
            .reduce(function (previousValue, renderStateName) {
            var renderStateMetadata = stateMachineMetadata.renderState[renderStateName];
            var renderFunction = _this.buildRenderFunction(renderStateMetadata);
            previousValue.renderStates[renderStateName] = {
                render: renderFunction
            };
            // previousValue.renderStates[renderStateName] = {
            //   render: (context: StateMachineContext) => {
            //     return context.parser.parse(renderStateMetadata.condition, this);
            //   }
            // };
            return previousValue;
        }, stateMachine);
        // 由状态机元数据构造NgAction
        Object.keys(stateMachineMetadata.action)
            .reduce(function (previousValue, actionName) {
            var actionMetadata = stateMachineMetadata.action[actionName];
            previousValue.actions[actionName] = {
                precondition: actionMetadata.precondition,
                transitTo: actionMetadata.transitTo
            };
            return previousValue;
        }, stateMachine);
        // 返回状态机元数据
        return stateMachine;
    };
    ContextMetadataBuilder.prototype.buildUiStateMetadata = function (states) {
        var uiStates = {};
        states.reduce(function (previousValue, uiState) {
            previousValue[uiState.code] = {
                stateName: uiState.code
            };
            return previousValue;
        }, uiStates);
        return uiStates;
    };
    ContextMetadataBuilder.prototype.buildRenderFunction = function (renderStateMetadata) {
        if (renderStateMetadata && renderStateMetadata.condition.length) {
            var renderFunctionString = renderStateMetadata.condition.reduce(function (previousFunctionString, condition) {
                var conditionTarget = condition.target;
                if (!conditionTarget.startsWith('\'')) {
                    conditionTarget = "'" + conditionTarget;
                }
                if (!conditionTarget.endsWith('\'')) {
                    conditionTarget = conditionTarget + "'";
                }
                var conditionSource = condition.source;
                if (conditionSource.indexOf('\'') < 0) {
                    conditionSource = "'" + conditionSource + "'";
                }
                if (conditionSource.indexOf('getUIState') > -1) {
                    conditionSource = conditionSource.replace('getUIState', 'context.getUIState');
                }
                if (conditionSource.indexOf('getData') > -1) {
                    conditionSource = conditionSource.replace('getData', 'context.getData');
                }
                // tslint:disable-next-line: max-line-length
                var functionString = (condition.lBracket || '') + "context.parse(" + conditionSource + ",'source')" + condition.compare + "context.parse(" + condition.target + ",'target')" + (condition.rBracket || '');
                if (condition.relation) {
                    switch (condition.relation.trim().toLocaleLowerCase()) {
                        case 'or':
                            functionString += '||';
                            break;
                        case 'and':
                            functionString += '&&';
                            break;
                    }
                }
                return previousFunctionString + functionString;
            }, '');
            if (renderFunctionString) {
                return new Function('context', "return " + renderFunctionString + ";");
            }
        }
        return new Function('context', 'return true;');
    };
    ContextMetadataBuilder.prototype.buildCommandHandlers = function (commandMetadataArray, controllers) {
        var commandHandlers = [];
        commandMetadataArray.reduce(function (previousValue, commandReference) {
            var commandName = commandReference.code;
            var controllerId = commandReference.cmpId;
            var controller = controllers[controllerId];
            var method = Object.assign({}, controller.methods[commandReference.handlerName]);
            method.params = method.params.map(function (param) { return Object.assign({}, param); });
            if (method.params && method.params.length) {
                commandReference.params.reduce(function (previousMethodValue, param) {
                    var methodParam = previousMethodValue.params.find(function (value) { return value.name === param.name; });
                    if (methodParam) {
                        methodParam.expression = param.value;
                    }
                    return previousMethodValue;
                }, method);
            }
            var commandHandler = new DynamicCommandHandler(commandName, method);
            previousValue.push(commandHandler);
            return previousValue;
        }, commandHandlers);
        return commandHandlers;
    };
    return ContextMetadataBuilder;
}());
export { ContextMetadataBuilder };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwX21ldGFkYXRhX2NvbGxlY3Rvci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL2FwcC9hcHBfbWV0YWRhdGFfY29sbGVjdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBK0UscUJBQXFCLEVBQUUsTUFBTSxZQUFZLENBQUM7QUFHaEksT0FBTyxFQUFFLFVBQVUsRUFBNkIsTUFBTSxXQUFXLENBQUM7QUFLbEUsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBS3pEO0lBRUU7SUFFQSxDQUFDO0lBRUQ7Ozs7O09BS0c7SUFDSSx3REFBdUIsR0FBOUIsVUFBK0IsbUJBQXdCLEVBQUUsb0JBQW1DO1FBQzFGLElBQU0sTUFBTSxHQUFHLG1CQUFtQixDQUFDLE1BQU0sQ0FBQztRQUMxQyxJQUFNLFFBQVEsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDO1FBQy9CLElBQU0sa0JBQWtCLEdBQUc7WUFDekIsUUFBUSxFQUFFLE1BQU0sQ0FBQyxJQUFJO1lBQ3JCLFNBQVMsRUFBRSxFQUFFO1lBQ2IsWUFBWSxFQUFFLElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxvQkFBb0IsQ0FBQztZQUNsRSxRQUFRLEVBQUUsSUFBSSxDQUFDLG9CQUFvQixDQUFDLFFBQVEsQ0FBQztTQUM5QyxDQUFDO1FBQ0YsT0FBTyxrQkFBa0IsQ0FBQztJQUM1QixDQUFDO0lBR0Q7Ozs7Ozs7T0FPRztJQUNJLHlEQUF3QixHQUEvQixVQUNFLFNBQWMsRUFDZCxTQUF5QixFQUN6QixNQUFjLEVBQ2QsV0FBZ0Q7UUFFaEQsSUFBTSxlQUFlLEdBQUc7WUFDdEIsUUFBUSxFQUFFLFNBQVMsQ0FBQyxFQUFFO1lBQ3RCLFNBQVMsRUFBRSxFQUFFO1lBQ2IsUUFBUSxFQUFFLElBQUksQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQztZQUMvQyxlQUFlLEVBQUUsSUFBSSxDQUFDLG9CQUFvQixD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LHFCQUFxQixDQUFDLFdBQVcsRUFBRSxNQUFNLENBQUMsQ0FBQztZQUN0RSxhQUFhLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDO1lBQ25DLE9BQU8sYUFBYSxDQUFDO1FBQ3ZCLENBQUMsRUFBRSxlQUFlLENBQUMsQ0FBQztRQUNwQixPQUFPLGVBQWUsQ0FBQztJQUN6QixDQUFDO0lBQ0gsNkJBQUM7QUFBRCxDQUFDLEFBdFFELElBc1FDIiwic291cmNlc0NvbnRlbnQiOlsiXHJcbmltcG9ydCB7IENvbW1hbmRDb250cm9sbGVyLCBDb21tYW5kSGFuZGxlciwgQ29tbWFuZEhhbmRsZXJFeHRlbmRlciwgQ29udHJvbGxlck1ldGhvZCwgRHluYW1pY0NvbW1hbmRIYW5kbGVyIH0gZnJvbSAnLi4vY29tbWFuZCc7XHJcbmltcG9ydCB7IFZhbGlkYXRlUnVsZSB9IGZyb20gJy4uL2VudGl0eSc7XHJcbmltcG9ydCB7IE5nRm9ybUNvbnRyb2wsIE5nVmFsaWRhdGVGb3JtIH0gZnJvbSAnLi4vZm9ybSc7XHJcbmltcG9ydCB7IERvbVNlcnZpY2UsIFNjaGVtYSwgU2NoZW1hRW50aXR5RmllbGQgfSBmcm9tICcuLi9zY2hlbWEnO1xyXG5pbXBvcnQge1xyXG4gIElGb3JtVmlld01vZGVsLCBJRm9ybVZpZXdNb2RlbENvbW1hbmQsIElGb3JtVmlld01vZGVsQ29tbWFuZFBhcmFtLCBJRm9ybVZpZXdNb2RlbEZpZWxkLFxyXG4gIElGb3JtVmlld01vZGVsVWlTdGF0ZSwgSVJlbmRlclN0YXRlLCBJU3RhdGVNYWNoaW5lXHJcbn0gZnJvbSAnLi4vc2NoZW1hL2Zvcm0tbWV0YWRhdGEnO1xyXG5pbXBvcnQgeyBTY2hlbWFTZXJ2aWNlIH0gZnJvbSAnLi4vc2NoZW1hL3NjaGVtYS5zZXJ2aWNlJztcclxuaW1wb3J0IHsgTmdQYXJhbSB9IGZyb20gJy4uL3VpLXN0YXRlJztcclxuaW1wb3J0IHsgTmdDb21tYW5kIH0gZnJvbSAnLi4vdmlldy1tb2RlbCc7XHJcbmltcG9ydCB7IElDb250ZXh0TWV0YWRhdGEsIElDb250ZXh0U3RhdGVNYWNoaW5lTWV0YWRhdGEgfSBmcm9tICcuL2FwcF9tZXRhZGF0YSc7XHJcblxyXG5leHBvcnQgY2xhc3MgQ29udGV4dE1ldGFkYXRhQnVpbGRlciB7XHJcblxyXG4gIGNvbnN0cnVjdG9yKCkge1xyXG5cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOaehOmAoOW6lOeUqOeoi+W6j+S4iuS4i+aWh+WFg+aVsOaNrlxyXG4gICAqIEBwYXJhbSBmb3JtTWV0YWRhdGFDb250ZW50IOihqOWNleWFg+aVsOaNrlxyXG4gICAqIEBwYXJhbSBzdGF0ZU1hY2hpbmVNZXRhZGF0YSDnirbmgIHmnLrlhYPmlbBcclxuICAgKiBAcmV0dXJucyDlupTnlKjnqIvluo/kuIrkuIvmloflhYPmlbDmja5cclxuICAgKi9cclxuICBwdWJsaWMgYnVpbGRBcHBDb250ZXh0TWV0YWRhdGEoZm9ybU1ldGFkYXRhQ29udGVudDogYW55LCBzdGF0ZU1hY2hpbmVNZXRhZGF0YTogSVN0YXRlTWFjaGluZSk6IElDb250ZXh0TWV0YWRhdGEge1xyXG4gICAgY29uc3QgbW9kdWxlID0gZm9ybU1ldGFkYXRhQ29udGVudC5tb2R1bGU7XHJcbiAgICBjb25zdCB1aVN0YXRlcyA9IG1vZHVsZS5zdGF0ZXM7XHJcbiAgICBjb25zdCBhcHBDb250ZXh0TWV0YWRhdGEgPSB7XHJcbiAgICAgIGlkZW50aWZ5OiBtb2R1bGUuY29kZSxcclxuICAgICAgbmFtZXNwYWNlOiAnJyxcclxuICAgICAgc3RhdGVNYWNoaW5lOiB0aGlzLmJ1aWxkU3RhdGFNYWNoaW5lTWV0YWRhdGEoc3RhdGVNYWNoaW5lTWV0YWRhdGEpLFxyXG4gICAgICB1aVN0YXRlczogdGhpcy5idWlsZFVpU3RhdGVNZXRhZGF0YSh1aVN0YXRlcylcclxuICAgIH07XHJcbiAgICByZXR1cm4gYXBwQ29udGV4dE1ldGFkYXRhO1xyXG4gIH1cclxuXHJcblxyXG4gIC8qKlxyXG4gICAqIOaehOmAoOinhuWbvuS4iuS4i+aWh+WFg+aVsOaNrlxyXG4gICAqIEBwYXJhbSBjb21wb25lbnRJZCDnu4Tku7bmoIfor4ZcclxuICAgKiBAcGFyYW0gdmlld01vZGVsIOinhuWbvuaooeWei+WFg+aVsOaNrlxyXG4gICAqIEBwYXJhbSBkZWNsYXJhdGlvbnMg5aSW6YOo5o6l5Y+j5a6a5LmJXHJcbiAgICogQHBhcmFtIHN1YnNjcmlwdGlvbnMg5LqL5Lu26K6i6ZiF5a6a5LmJXHJcbiAgICogQHJldHVybnMg6KeG5Zu+5LiK5LiL5paH5YWD5pWw5o2uXHJcbiAgICovXHJcbiAgcHVibGljIGJ1aWxkVmlld0NvbnRleHRNZXRhZGF0YShcclxuICAgIGNvbXBvbmVudDogYW55LFxyXG4gICAgdmlld01vZGVsOiBJRm9ybVZpZXdNb2RlbCxcclxuICAgIHNjaGVtYTogU2NoZW1hLFxyXG4gICAgY29udHJvbGxlcnM6IHsgW2lkOiBzdHJpbmddOiBDb21tYW5kQ29udHJvbGxlciB9XHJcbiAgKTogSUNvbnRleHRNZXRhZGF0YSB7XHJcbiAgICBjb25zdCBjb250ZXh0TWV0YWRhdGEgPSB7XHJcbiAgICAgIGlkZW50aWZ5OiBjb21wb25lbnQuaWQsXHJcbiAgICAgIG5hbWVzcGFjZTogJycsXHJcbiAgICAgIGNvbW1hbmRzOiB0aGlzLmJ1aWxkQ29tbWFuZCh2aWV3TW9kZWwuY29tbWFuZHMpLFxyXG4gICAgICBjb21tYW5kSGFuZGxlcnM6IHRoaXMuYnVpbGRDb21tYW5kSGFuZGxlcnModmlld01vZGVsLmNvbW1hbmRzLCBjb250cm9sbGVycyksXHJcbiAgICAgIGNvbW1hbmRIYW5kbGVyRXh0ZW5kczogW10sXHJcbiAgICAgIGZvcm06IHRoaXMuYnVpbGRGb3JtTWV0YWRhdGEodmlld01vZGVsKSxcclxuICAgICAgZm9ybUNvbnRyb2xzOiB0aGlzLmJ1aWxkRm9ybUNvbnRyb2xNZXRhZGF0YSh2aWV3TW9kZWwuZmllbGRzLCB2aWV3TW9kZWwsIHNjaGVtYSwgY29tcG9uZW50KSxcclxuICAgICAgc3ViRm9ybXM6IG51bGwsXHJcbiAgICAgIHVpU3RhdGVzOiB0aGlzLmJ1aWxkVWlTdGF0ZU1ldGFkYXRhKHZpZXdNb2RlbC5zdGF0ZXMpLFxyXG4gICAgICBiaW5kaW5nVG86IHZpZXdNb2RlbC5iaW5kVG8sXHJcbiAgICAgIHZpZXdNb2RlbENvZGU6IHZpZXdNb2RlbC5jb2RlXHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGNvbnRleHRNZXRhZGF0YTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgYnVpbGRDb21tYW5kKGNvbW1hbmRNZXRhZGF0YUFycmF5OiBJRm9ybVZpZXdNb2RlbENvbW1hbmRbXSk6IHsgW2NvbW1hbmROYW1lOiBzdHJpbmddOiBOZ0NvbW1hbmQgfSB7XHJcbiAgICBjb25zdCBjb21tYW5kcyA9IHt9O1xyXG4gICAgY29tbWFuZE1ldGFkYXRhQXJyYXkucmVkdWNlPHsgW2NvbW1hbmROYW1lOiBzdHJpbmddOiBOZ0NvbW1hbmQgfT4oKHByZXZpb3VzVmFsdWUsIGNvbW1hbmRNZXRhZGF0YTogSUZvcm1WaWV3TW9kZWxDb21tYW5kKSA9PiB7XHJcbiAgICAgIGNvbnN0IG5nQ29tbWFuZDogTmdDb21tYW5kID0ge1xyXG4gICAgICAgIG5hbWU6IGNvbW1hbmRNZXRhZGF0YS5jb2RlLFxyXG4gICAgICAgIHBhcmFtczoge30sXHJcbiAgICAgICAgcGFyYW1EZXNjcmlwdGlvbnM6IHt9XHJcbiAgICAgIH07XHJcbiAgICAgIGNvbW1hbmRNZXRhZGF0YS5wYXJhbXMucmVkdWNlPE5nQ29tbWFuZD4oKHByZXZpb3VzQ29tbWFuZCwgcGFyYW0pID0+IHtcclxuICAgICAgICBwcmV2aW91c0NvbW1hbmQucGFyYW1zW3BhcmFtLm5hbWVdID0gcGFyYW0udmFsdWU7XHJcbiAgICAgICAgcHJldmlvdXNDb21tYW5kLnBhcmFtRGVzY3JpcHRpb25zW3BhcmFtLm5hbWVdID0geyB0eXBlOiAnc3RyaW5nJyB9O1xyXG4gICAgICAgIHJldHVybiBwcmV2aW91c0NvbW1hbmQ7XHJcbiAgICAgIH0sIG5nQ29tbWFuZCk7XHJcbiAgICAgIHByZXZpb3VzVmFsdWVbY29tbWFuZE1ldGFkYXRhLmNvZGVdID0gbmdDb21tYW5kO1xyXG4gICAgICByZXR1cm4gcHJldmlvdXNWYWx1ZTtcclxuICAgIH0sIGNvbW1hbmRzKTtcclxuICAgIHJldHVybiBjb21tYW5kcztcclxuICB9XHJcblxyXG4gIHByaXZhdGUgYnVpbGRGb3JtTWV0YWRhdGEodmlld01vZGVsOiBJRm9ybVZpZXdNb2RlbCk6IE5nVmFsaWRhdGVGb3JtIHtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIGZvcm1Hcm91cE5hbWU6IHZpZXdNb2RlbC5uYW1lLFxyXG4gICAgICBlbmFibGVWYWxpZGF0ZTogdmlld01vZGVsLmVuYWJsZVZhbGlkYXRpb25cclxuICAgIH07XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGJ1aWxkRm9ybUNvbnRyb2xNZXRhZGF0YShmb3JtRmllbGRzOiBJRm9ybVZpZXdNb2RlbEZpZWxkW10sIHZpZXdNb2RlbDogSUZvcm1WaWV3TW9kZWwsIHNjaGVtYTogU2NoZW1hLCBjb21wb25lbnQ6IGFueSlcclxuICAgIDogeyBbY29udHJvbE5hbWU6IHN0cmluZ106IE5nRm9ybUNvbnRyb2wgfSB7XHJcbiAgICBjb25zdCBmb3JtQ29udHJvbHM6IHsgW2NvbnRyb2xOYW1lOiBzdHJpbmddOiBOZ0Zvcm1Db250cm9sIH0gPSB7fTtcclxuICAgIGNvbnN0IGZvcm1GaWVsZElkcyA9IGZvcm1GaWVsZHMubWFwKGZvcm1GaWVsZCA9PiBmb3JtRmllbGQuaWQpO1xyXG4gICAgY29uc3Qgc2NoZW1hU2VydmljZSA9IG5ldyBTY2hlbWFTZXJ2aWNlKCk7XHJcbiAgICBjb25zdCBmb3JtRmllbGRzTWFwID0gc2NoZW1hU2VydmljZS5nZXRGaWVsZHNCeUlkcyhmb3JtRmllbGRJZHMsIHNjaGVtYSwgdmlld01vZGVsKTtcclxuICAgIGNvbnN0IGRvbVNlcnZpY2UgPSBuZXcgRG9tU2VydmljZSgpO1xyXG5cclxuICAgIGZvcm1GaWVsZHMucmVkdWNlPHsgW2NvbnRyb2xOYW1lOiBzdHJpbmddOiBOZ0Zvcm1Db250cm9sIH0+KChwcmV2aW91c1ZhbHVlLCBmaWVsZCkgPT4ge1xyXG4gICAgICBjb25zdCBzY2hlbWFFbnRpdHlGaWVsZDogU2NoZW1hRW50aXR5RmllbGQgPSBmb3JtRmllbGRzTWFwLmhhcyhmaWVsZC5pZCkgPyBmb3JtRmllbGRzTWFwLmdldChmaWVsZC5pZCkgOiBudWxsO1xyXG4gICAgICBjb25zdCBiaW5kaW5nID0gc2NoZW1hRW50aXR5RmllbGQgPyBzY2hlbWFFbnRpdHlGaWVsZC5iaW5kaW5nUGF0aCA6ICcnO1xyXG4gICAgICBjb25zdCBkb21FbGVtZW50cyA9IGRvbVNlcnZpY2UuZ2V0RWxlbWVudEJ5QmluZGluZyhjb21wb25lbnQuY29udGVudHMsIGZpZWxkLmlkKTtcclxuICAgICAgY29uc3QgdmFsaWRSdWxlczogVmFsaWRhdGVSdWxlW10gPSBbXTtcclxuICAgICAgY29uc3QgbWF0Y2hlZEVsZW1lbnQgPSBkb21FbGVtZW50c1swXTtcclxuICAgICAgaWYgKG1hdGNoZWRFbGVtZW50KSB7XHJcbiAgICAgICAgY29uc3Qga2V5cyA9ICdtYXhWYWx1ZSxtaW5WYWx1ZSxyZXF1aXJlZCxyZXF1aXJlJztcclxuICAgICAgICBPYmplY3Qua2V5cyhtYXRjaGVkRWxlbWVudCkuZm9yRWFjaChrZXkgPT4ge1xyXG4gICAgICAgICAgaWYgKGtleXMuaW5jbHVkZXMoa2V5KSkge1xyXG4gICAgICAgICAgICBpZiAoa2V5ID09PSAnbWF4VmFsdWUnICYmIChtYXRjaGVkRWxlbWVudFtrZXldICE9PSBudWxsICYmIG1hdGNoZWRFbGVtZW50W2tleV0gIT09IHVuZGVmaW5lZCkpIHtcclxuICAgICAgICAgICAgICAvLyDmiormnIDlpKflgLzlsZ7mgKfovazmjaLmiJB2YWxpZFJ1bGVcclxuICAgICAgICAgICAgICB2YWxpZFJ1bGVzLnB1c2goeyB0eXBlOiAnbWF4VmFsdWUnLCBjb25zdHJhaW50czogW21hdGNoZWRFbGVtZW50W2tleV1dIH0pO1xyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKGtleSA9PT0gJ21pblZhbHVlJyAmJiAobWF0Y2hlZEVsZW1lbnRba2V5XSAhPT0gbnVsbCAmJiBtYXRjaGVkRWxlbWVudFtrZXldICE9PSB1bmRlZmluZWQpKSB7XHJcbiAgICAgICAgICAgICAgLy8g5oqK5pyA5bCP5YC85bGe5oCn6L2s5o2i5oiQdmFsaWRSdWxlXHJcbiAgICAgICAgICAgICAgdmFsaWRSdWxlcy5wdXNoKHsgdHlwZTogJ21pblZhbHVlJywgY29uc3RyYWludHM6IFttYXRjaGVkRWxlbWVudFtrZXldXSB9KTtcclxuICAgICAgICAgICAgfSBlbHNlIGlmIChrZXkgPT09ICdyZXF1aXJlZCcgfHwga2V5ID09PSAncmVxdWlyZScpIHtcclxuICAgICAgICAgICAgICAvLyDmiorlv4XloavlsZ7mgKfovazmjaLmiJB2YWxpZFJ1bGVcclxuICAgICAgICAgICAgICAvLyDlv4Xloavooajovr7lvI/lj6/ku6XkuLrnirbmgIHmnLpcclxuICAgICAgICAgICAgICBpZiAobWF0Y2hlZEVsZW1lbnRba2V5XSA9PT0gJ3RydWUnIHx8IG1hdGNoZWRFbGVtZW50W2tleV0gPT09IHRydWUpIHtcclxuICAgICAgICAgICAgICAgIHZhbGlkUnVsZXMucHVzaCh7IHR5cGU6ICdyZXF1aXJlZCcsIGNvbnN0cmFpbnRzOiBbdHJ1ZV0gfSk7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH1cclxuICAgICAgcHJldmlvdXNWYWx1ZVtmaWVsZC5maWVsZE5hbWVdID0ge1xyXG4gICAgICAgIC8qKiDmjqfku7bmoIfor4YgKi9cclxuICAgICAgICBpZDogYCR7ZmllbGQuZmllbGROYW1lfV8ke2ZpZWxkLmlkLnN1YnN0cigwLCAxMykucmVwbGFjZSgnLScsICdfJyl9YCxcclxuICAgICAgICAvKiog5o6n5Lu25ZCN56ewIHRvZG86IOmcgOimgeaUr+aMgeWkmuivreiogCAqL1xyXG4gICAgICAgIG5hbWU6IG1hdGNoZWRFbGVtZW50ID8gbWF0Y2hlZEVsZW1lbnQudGl0bGUgOiBmaWVsZC5maWVsZE5hbWUsXHJcbiAgICAgICAgLyoqIOe7keWumuWtl+autei3r+W+hCAqL1xyXG4gICAgICAgIGJpbmRpbmcsXHJcbiAgICAgICAgLyoqIOaOp+S7tuWAvOabtOaWsOaXtuacuiAqL1xyXG4gICAgICAgIHVwZGF0ZU9uOiBmaWVsZC51cGRhdGVPbixcclxuICAgICAgICAvKiog5o6n5Lu26buY6K6k5ZCN56ewICovXHJcbiAgICAgICAgZGVmYXVsdEkxOG5WYWx1ZTogbWF0Y2hlZEVsZW1lbnQgPyBtYXRjaGVkRWxlbWVudC50aXRsZSA6IGZpZWxkLmZpZWxkTmFtZSxcclxuICAgICAgICAvKiog6aqM6K+B6KeE5YiZICovXHJcbiAgICAgICAgdmFsaWRSdWxlc1xyXG4gICAgICB9O1xyXG4gICAgICByZXR1cm4gcHJldmlvdXNWYWx1ZTtcclxuICAgIH0sIGZvcm1Db250cm9scyk7XHJcbiAgICByZXR1cm4gZm9ybUNvbnRyb2xzO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDnlLHnirbmgIHmnLrlhYPmlbDmja7liJvlu7rnirbmgIHmnLrkuIrkuIvmlofmj4/ov7BcclxuICAgKiBAcGFyYW0gc3RhdGVNYWNoaW5lTWV0YWRhdGEg54q25oCB5py65YWD5pWw5o2uXHJcbiAgICogQHJldHVybnMg54q25oCB5py65LiK5LiL5paH5o+P6L+wXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBidWlsZFN0YXRhTWFjaGluZU1ldGFkYXRhKHN0YXRlTWFjaGluZU1ldGFkYXRhOiBJU3RhdGVNYWNoaW5lKTogSUNvbnRleHRTdGF0ZU1hY2hpbmVNZXRhZGF0YSB7XHJcbiAgICAvLyDlo7DmmI7nirbmgIHmnLrkuIrkuIvmloflhYPmlbDmja5cclxuICAgIGNvbnN0IHN0YXRlTWFjaGluZTogSUNvbnRleHRTdGF0ZU1hY2hpbmVNZXRhZGF0YSA9IHtcclxuICAgICAgc3RhdGVzOiB7fSxcclxuICAgICAgcmVuZGVyU3RhdGVzOiB7fSxcclxuICAgICAgYWN0aW9uczoge31cclxuICAgIH07XHJcblxyXG4gICAgaWYgKCFzdGF0ZU1hY2hpbmVNZXRhZGF0YSkge1xyXG4gICAgICByZXR1cm4gc3RhdGVNYWNoaW5lO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIOeUseeKtuaAgeacuuWFg+aVsOaNruaehOmAoE5nU3RhdGVcclxuICAgIHN0YXRlTWFjaGluZU1ldGFkYXRhLnN0YXRlLnJlZHVjZTxJQ29udGV4dFN0YXRlTWFjaGluZU1ldGFkYXRhPigocHJldmlvdXNWYWx1ZSwgc3RhdGUpID0+IHtcclxuICAgICAgcHJldmlvdXNWYWx1ZS5zdGF0ZXNbc3RhdGUuc3RhdGVdID0ge1xyXG4gICAgICAgIGluaXRpYWxTdGF0ZTogc3RhdGUuc3RhdGUgPT09IHN0YXRlTWFjaGluZU1ldGFkYXRhLmluaXRpYWxTdGF0ZVxyXG4gICAgICB9O1xyXG4gICAgICByZXR1cm4gcHJldmlvdXNWYWx1ZTtcclxuICAgIH0sIHN0YXRlTWFjaGluZSk7XHJcbiAgICAvLyDnlLHnirbmgIHmnLrlhYPmlbDmja7mnoTpgKBOZ1JlbmRlclN0YXRlXHJcbiAgICBPYmplY3Qua2V5cyhzdGF0ZU1hY2hpbmVNZXRhZGF0YS5yZW5kZXJTdGF0ZSlcclxuICAgICAgLnJlZHVjZTxJQ29udGV4dFN0YXRlTWFjaGluZU1ldGFkYXRhPigocHJldmlvdXNWYWx1ZSwgcmVuZGVyU3RhdGVOYW1lKSA9PiB7XHJcbiAgICAgICAgY29uc3QgcmVuZGVyU3RhdGVNZXRhZGF0YSA9IHN0YXRlTWFjaGluZU1ldGFkYXRhLnJlbmRlclN0YXRlW3JlbmRlclN0YXRlTmFtZV07XHJcbiAgICAgICAgY29uc3QgcmVuZGVyRnVuY3Rpb24gPSB0aGlzLmJ1aWxkUmVuZGVyRnVuY3Rpb24ocmVuZGVyU3RhdGVNZXRhZGF0YSk7XHJcbiAgICAgICAgcHJldmlvdXNWYWx1ZS5yZW5kZXJTdGF0ZXNbcmVuZGVyU3RhdGVOYW1lXSA9IHtcclxuICAgICAgICAgIHJlbmRlcjogcmVuZGVyRnVuY3Rpb25cclxuICAgICAgICB9O1xyXG4gICAgICAgIC8vIHByZXZpb3VzVmFsdWUucmVuZGVyU3RhdGVzW3JlbmRlclN0YXRlTmFtZV0gPSB7XHJcbiAgICAgICAgLy8gICByZW5kZXI6IChjb250ZXh0OiBTdGF0ZU1hY2hpbmVDb250ZXh0KSA9PiB7XHJcbiAgICAgICAgLy8gICAgIHJldHVybiBjb250ZXh0LnBhcnNlci5wYXJzZShyZW5kZXJTdGF0ZU1ldGFkYXRhLmNvbmRpdGlvbiwgdGhpcyk7XHJcbiAgICAgICAgLy8gICB9XHJcbiAgICAgICAgLy8gfTtcclxuICAgICAgICByZXR1cm4gcHJldmlvdXNWYWx1ZTtcclxuICAgICAgfSwgc3RhdGVNYWNoaW5lKTtcclxuICAgIC8vIOeUseeKtuaAgeacuuWFg+aVsOaNruaehOmAoE5nQWN0aW9uXHJcbiAgICBPYmplY3Qua2V5cyhzdGF0ZU1hY2hpbmVNZXRhZGF0YS5hY3Rpb24pXHJcbiAgICAgIC5yZWR1Y2U8SUNvbnRleHRTdGF0ZU1hY2hpbmVNZXRhZGF0YT4oKHByZXZpb3VzVmFsdWUsIGFjdGlvbk5hbWUpID0+IHtcclxuICAgICAgICBjb25zdCBhY3Rpb25NZXRhZGF0YSA9IHN0YXRlTWFjaGluZU1ldGFkYXRhLmFjdGlvblthY3Rpb25OYW1lXTtcclxuICAgICAgICBwcmV2aW91c1ZhbHVlLmFjdGlvbnNbYWN0aW9uTmFtZV0gPSB7XHJcbiAgICAgICAgICBwcmVjb25kaXRpb246IGFjdGlvbk1ldGFkYXRhLnByZWNvbmRpdGlvbixcclxuICAgICAgICAgIHRyYW5zaXRUbzogYWN0aW9uTWV0YWRhdGEudHJhbnNpdFRvXHJcbiAgICAgICAgfTtcclxuICAgICAgICByZXR1cm4gcHJldmlvdXNWYWx1ZTtcclxuICAgICAgfSwgc3RhdGVNYWNoaW5lKTtcclxuICAgIC8vIOi/lOWbnueKtuaAgeacuuWFg+aVsOaNrlxyXG4gICAgcmV0dXJuIHN0YXRlTWFjaGluZTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgYnVpbGRVaVN0YXRlTWV0YWRhdGEoc3RhdGVzOiBJRm9ybVZpZXdNb2RlbFVpU3RhdGVbXSk6IHsgW3N0YXRlTmFtZTogc3RyaW5nXTogTmdQYXJhbSB9IHtcclxuICAgIGNvbnN0IHVpU3RhdGVzOiB7IFtzdGF0ZU5hbWU6IHN0cmluZ106IE5nUGFyYW0gfSA9IHt9O1xyXG4gICAgc3RhdGVzLnJlZHVjZTx7IFtzdGF0ZU5hbWU6IHN0cmluZ106IE5nUGFyYW0gfT4oKHByZXZpb3VzVmFsdWUsIHVpU3RhdGUpID0+IHtcclxuICAgICAgcHJldmlvdXNWYWx1ZVt1aVN0YXRlLmNvZGVdID0ge1xyXG4gICAgICAgIHN0YXRlTmFtZTogdWlTdGF0ZS5jb2RlXHJcbiAgICAgIH07XHJcbiAgICAgIHJldHVybiBwcmV2aW91c1ZhbHVlO1xyXG4gICAgfSwgdWlTdGF0ZXMpO1xyXG4gICAgcmV0dXJuIHVpU3RhdGVzO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBidWlsZFJlbmRlckZ1bmN0aW9uKHJlbmRlclN0YXRlTWV0YWRhdGE6IElSZW5kZXJTdGF0ZSk6IGFueSB7XHJcbiAgICBpZiAocmVuZGVyU3RhdGVNZXRhZGF0YSAmJiByZW5kZXJTdGF0ZU1ldGFkYXRhLmNvbmRpdGlvbi5sZW5ndGgpIHtcclxuICAgICAgY29uc3QgcmVuZGVyRnVuY3Rpb25TdHJpbmcgPSByZW5kZXJTdGF0ZU1ldGFkYXRhLmNvbmRpdGlvbi5yZWR1Y2U8c3RyaW5nPigocHJldmlvdXNGdW5jdGlvblN0cmluZywgY29uZGl0aW9uKSA9PiB7XHJcbiAgICAgICAgbGV0IGNvbmRpdGlvblRhcmdldCA9IGNvbmRpdGlvbi50YXJnZXQ7XHJcbiAgICAgICAgaWYgKCFjb25kaXRpb25UYXJnZXQuc3RhcnRzV2l0aCgnXFwnJykpIHtcclxuICAgICAgICAgIGNvbmRpdGlvblRhcmdldCA9IGAnJHtjb25kaXRpb25UYXJnZXR9YDtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKCFjb25kaXRpb25UYXJnZXQuZW5kc1dpdGgoJ1xcJycpKSB7XHJcbiAgICAgICAgICBjb25kaXRpb25UYXJnZXQgPSBgJHtjb25kaXRpb25UYXJnZXR9J2A7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGxldCBjb25kaXRpb25Tb3VyY2UgPSBjb25kaXRpb24uc291cmNlO1xyXG4gICAgICAgIGlmIChjb25kaXRpb25Tb3VyY2UuaW5kZXhPZignXFwnJykgPCAwKSB7XHJcbiAgICAgICAgICBjb25kaXRpb25Tb3VyY2UgPSBgJyR7Y29uZGl0aW9uU291cmNlfSdgO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoY29uZGl0aW9uU291cmNlLmluZGV4T2YoJ2dldFVJU3RhdGUnKSA+IC0xKSB7XHJcbiAgICAgICAgICBjb25kaXRpb25Tb3VyY2UgPSBjb25kaXRpb25Tb3VyY2UucmVwbGFjZSgnZ2V0VUlTdGF0ZScsICdjb250ZXh0LmdldFVJU3RhdGUnKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGNvbmRpdGlvblNvdXJjZS5pbmRleE9mKCdnZXREYXRhJykgPiAtMSkge1xyXG4gICAgICAgICAgY29uZGl0aW9uU291cmNlID0gY29uZGl0aW9uU291cmNlLnJlcGxhY2UoJ2dldERhdGEnLCAnY29udGV4dC5nZXREYXRhJyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogbWF4LWxpbmUtbGVuZ3RoXHJcbiAgICAgICAgbGV0IGZ1bmN0aW9uU3RyaW5nID0gYCR7Y29uZGl0aW9uLmxCcmFja2V0IHx8ICcnfWNvbnRleHQucGFyc2UoJHtjb25kaXRpb25Tb3VyY2V9LCdzb3VyY2UnKSR7Y29uZGl0aW9uLmNvbXBhcmV9Y29udGV4dC5wYXJzZSgke2NvbmRpdGlvbi50YXJnZXR9LCd0YXJnZXQnKSR7Y29uZGl0aW9uLnJCcmFja2V0IHx8ICcnfWA7XHJcbiAgICAgICAgaWYgKGNvbmRpdGlvbi5yZWxhdGlvbikge1xyXG4gICAgICAgICAgc3dpdGNoIChjb25kaXRpb24ucmVsYXRpb24udHJpbSgpLnRvTG9jYWxlTG93ZXJDYXNlKCkpIHtcclxuICAgICAgICAgICAgY2FzZSAnb3InOlxyXG4gICAgICAgICAgICAgIGZ1bmN0aW9uU3RyaW5nICs9ICd8fCc7XHJcbiAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgJ2FuZCc6XHJcbiAgICAgICAgICAgICAgZnVuY3Rpb25TdHJpbmcgKz0gJyYmJztcclxuICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHByZXZpb3VzRnVuY3Rpb25TdHJpbmcgKyBmdW5jdGlvblN0cmluZztcclxuICAgICAgfSwgJycpO1xyXG4gICAgICBpZiAocmVuZGVyRnVuY3Rpb25TdHJpbmcpIHtcclxuICAgICAgICByZXR1cm4gbmV3IEZ1bmN0aW9uKCdjb250ZXh0JywgYHJldHVybiAke3JlbmRlckZ1bmN0aW9uU3RyaW5nfTtgKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIG5ldyBGdW5jdGlvbignY29udGV4dCcsICdyZXR1cm4gdHJ1ZTsnKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgYnVpbGRDb21tYW5kSGFuZGxlcnMoY29tbWFuZE1ldGFkYXRhQXJyYXk6IElGb3JtVmlld01vZGVsQ29tbWFuZFtdLCBjb250cm9sbGVyczogeyBbaWQ6IHN0cmluZ106IENvbW1hbmRDb250cm9sbGVyIH0pXHJcbiAgICA6IENvbW1hbmRIYW5kbGVyW10ge1xyXG4gICAgY29uc3QgY29tbWFuZEhhbmRsZXJzOiBDb21tYW5kSGFuZGxlcltdID0gW107XHJcbiAgICBjb21tYW5kTWV0YWRhdGFBcnJheS5yZWR1Y2U8Q29tbWFuZEhhbmRsZXJbXT4oKHByZXZpb3VzVmFsdWU6IENvbW1hbmRIYW5kbGVyW10sIGNvbW1hbmRSZWZlcmVuY2U6IElGb3JtVmlld01vZGVsQ29tbWFuZCkgPT4ge1xyXG4gICAgICBjb25zdCBjb21tYW5kTmFtZSA9IGNvbW1hbmRSZWZlcmVuY2UuY29kZTtcclxuICAgICAgY29uc3QgY29udHJvbGxlcklkID0gY29tbWFuZFJlZmVyZW5jZS5jbXBJZDtcclxuICAgICAgY29uc3QgY29udHJvbGxlciA9IGNvbnRyb2xsZXJzW2NvbnRyb2xsZXJJZF07XHJcbiAgICAgIGNvbnN0IG1ldGhvZCA9IE9iamVjdC5hc3NpZ24oe30sIGNvbnRyb2xsZXIubWV0aG9kc1tjb21tYW5kUmVmZXJlbmNlLmhhbmRsZXJOYW1lXSk7XHJcbiAgICAgIG1ldGhvZC5wYXJhbXMgPSBtZXRob2QucGFyYW1zLm1hcChwYXJhbSA9PiBPYmplY3QuYXNzaWduKHt9LCBwYXJhbSkpO1xyXG4gICAgICBpZiAobWV0aG9kLnBhcmFtcyAmJiBtZXRob2QucGFyYW1zLmxlbmd0aCkge1xyXG4gICAgICAgIGNvbW1hbmRSZWZlcmVuY2UucGFyYW1zLnJlZHVjZTxDb250cm9sbGVyTWV0aG9kPigocHJldmlvdXNNZXRob2RWYWx1ZTogQ29udHJvbGxlck1ldGhvZCwgcGFyYW06IElGb3JtVmlld01vZGVsQ29tbWFuZFBhcmFtKSA9PiB7XHJcbiAgICAgICAgICBjb25zdCBtZXRob2RQYXJhbSA9IHByZXZpb3VzTWV0aG9kVmFsdWUucGFyYW1zLmZpbmQodmFsdWUgPT4gdmFsdWUubmFtZSA9PT0gcGFyYW0ubmFtZSk7XHJcbiAgICAgICAgICBpZiAobWV0aG9kUGFyYW0pIHtcclxuICAgICAgICAgICAgbWV0aG9kUGFyYW0uZXhwcmVzc2lvbiA9IHBhcmFtLnZhbHVlO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgcmV0dXJuIHByZXZpb3VzTWV0aG9kVmFsdWU7XHJcbiAgICAgICAgfSwgbWV0aG9kKTtcclxuICAgICAgfVxyXG4gICAgICBjb25zdCBjb21tYW5kSGFuZGxlciA9IG5ldyBEeW5hbWljQ29tbWFuZEhhbmRsZXIoY29tbWFuZE5hbWUsIG1ldGhvZCk7XHJcbiAgICAgIHByZXZpb3VzVmFsdWUucHVzaChjb21tYW5kSGFuZGxlcik7XHJcbiAgICAgIHJldHVybiBwcmV2aW91c1ZhbHVlO1xyXG4gICAgfSwgY29tbWFuZEhhbmRsZXJzKTtcclxuICAgIHJldHVybiBjb21tYW5kSGFuZGxlcnM7XHJcbiAgfVxyXG59XHJcbiJdfQ==