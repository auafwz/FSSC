/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { Subject } from 'rxjs';
import { ColumnFilterType } from '../types/data-column';
import { BooleanFilterControl, DateFilterControl, EnumFilterControl, NumberFilterControl, TextFilterControl } from '../plugins/smart-filter/controlData/filter-control.options';
export class DatagridSmartFilterService {
    constructor() {
        this.conditions = [];
        this.controlData = [];
        this.filterChanged = new Subject();
        this.removeFilter = new Subject();
        this.clearAllFilter = new Subject();
    }
    /**
     * @param {?} col
     * @return {?}
     */
    getColumnFilterData(col) {
        /** @type {?} */
        let filterControlData = {
            controltype: 'text',
        };
        if (col.filter !== undefined) {
            if (typeof col.filter === 'boolean') {
                if (col.formatter) {
                    if (typeof col.formatter === 'object' && Object.keys(col.formatter).length) {
                        /** @type {?} */
                        const options = col.formatter['options'];
                        switch (col.formatter['type']) {
                            case 'number':
                                return NumberFilterControl(col);
                            case 'enum':
                                return EnumFilterControl(col, options);
                            case 'boolean':
                                return BooleanFilterControl(col);
                            case 'datetime':
                                /** @type {?} */
                                let tye = 'datetime';
                                /** @type {?} */
                                let fmt = 'yyyy-MM-dd';
                                /** @type {?} */
                                let returnFmt = 'yyyy-MM-dd';
                                if (options && options.format) {
                                    fmt = options.format;
                                    if (fmt.indexOf('HH:') == -1) {
                                        tye = 'date';
                                    }
                                    else {
                                        returnFmt += ' HH:mm';
                                        if (fmt.indexOf('ss') > -1) {
                                            returnFmt += ':ss';
                                        }
                                    }
                                }
                                else {
                                    tye = 'date';
                                }
                                filterControlData = {
                                    controltype: 'flexibleDate',
                                    dateFormat: fmt,
                                    single: false,
                                    showType: 3,
                                    showTime: tye === 'datetime'
                                };
                                break;
                            default:
                                return TextFilterControl(col);
                        }
                    }
                }
                return filterControlData;
            }
            else {
                switch (col.filter.type) {
                    case ColumnFilterType.enum:
                        return EnumFilterControl(col, col.filter.options);
                    case ColumnFilterType.date:
                    case ColumnFilterType.datetime:
                        return DateFilterControl(col, col.filter.options);
                    case ColumnFilterType.number:
                        return NumberFilterControl(col);
                    case ColumnFilterType.boolean:
                        return BooleanFilterControl(col);
                }
            }
        }
        return filterControlData;
    }
    /**
     * @param {?} e
     * @return {?}
     */
    filterConditionChanged(e) {
        /** @type {?} */
        const items = e.conditions;
        if (!this.conditions || !this.conditions.length) {
            this.conditions.push(...items);
            this.controlData.push(Object.assign({}, e.controlData));
        }
        else {
            /// TODO, CONTROLDATA 的索引与conditions 的索引很可能不是1个
            this.conditions = this.conditions.filter((/**
             * @param {?} n
             * @return {?}
             */
            n => n.FilterField !== items[0].FilterField));
            if (items.length === 1) {
                this.conditions.push(Object.assign({}, items[0]));
            }
            else {
                this.conditions.push(...items);
            }
            if (e.controlData) {
                /** @type {?} */
                const ctrlIdx = this.controlData.findIndex((/**
                 * @param {?} n
                 * @return {?}
                 */
                n => n.labelCode === e.controlData.labelCode));
                if (ctrlIdx > -1) {
                    this.controlData[ctrlIdx] = Object.assign({}, e.controlData);
                }
                else {
                    this.controlData.push(Object.assign({}, e.controlData));
                }
            }
        }
        this.filterChanged.next({ conditions: [...this.conditions], controlData: [...this.controlData] });
    }
    /**
     * @param {?} e
     * @param {?=} emitRemove
     * @return {?}
     */
    removeCondition(e, emitRemove = false) {
        if (this.conditions && this.conditions.length) {
            this.conditions = this.conditions.filter((/**
             * @param {?} n
             * @return {?}
             */
            n => n.FilterField !== e.labelCode));
            this.controlData = this.controlData.filter((/**
             * @param {?} n
             * @return {?}
             */
            n => n.labelCode !== e.labelCode));
        }
        this.filterChanged.next({ conditions: [...this.conditions], controlData: [...this.controlData] });
        if (emitRemove) {
            this.removeFilter.next(e);
        }
    }
    /**
     * @return {?}
     */
    clearAll() {
        this.conditions = [];
        this.controlData = [];
        this.clearAllFilter.next(null);
    }
}
DatagridSmartFilterService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
DatagridSmartFilterService.ctorParameters = () => [];
if (false) {
    /**
     * @type {?}
     * @private
     */
    DatagridSmartFilterService.prototype.conditions;
    /**
     * @type {?}
     * @private
     */
    DatagridSmartFilterService.prototype.controlData;
    /** @type {?} */
    DatagridSmartFilterService.prototype.filterChanged;
    /** @type {?} */
    DatagridSmartFilterService.prototype.removeFilter;
    /** @type {?} */
    DatagridSmartFilterService.prototype.clearAllFilter;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YWdyaWQtc21hcnQtZmlsdGVyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL3VpLWRhdGFncmlkLyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2VzL2RhdGFncmlkLXNtYXJ0LWZpbHRlci5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDL0IsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFFeEQsT0FBTyxFQUFFLG9CQUFvQixFQUFFLGlCQUFpQixFQUFFLGlCQUFpQixFQUMzRCxtQkFBbUIsRUFBRSxpQkFBaUIsRUFBRSxNQUFNLDREQUE0RCxDQUFDO0FBR25ILE1BQU0sT0FBTywwQkFBMEI7SUFTbkM7UUFSUSxlQUFVLEdBQVUsRUFBRSxDQUFDO1FBQ3ZCLGdCQUFXLEdBQVEsRUFBRSxDQUFDO1FBRTlCLGtCQUFhLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQztRQUU5QixpQkFBWSxHQUFHLElBQUksT0FBTyxFQUFFLENBQUM7UUFDN0IsbUJBQWMsR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFDO0lBRWYsQ0FBQzs7Ozs7SUFHakIsbUJBQW1CLENBQUMsR0FBUTs7WUFDcEIsaUJBQWlCLEdBQVE7WUFDekIsV0FBVyxFQUFFLE1BQU07U0FDdEI7UUFDRCxJQUFJLEdBQUcsQ0FBQyxNQUFNLEtBQUssU0FBUyxFQUFFO1lBQzFCLElBQUksT0FBTyxHQUFHLENBQUMsTUFBTSxLQUFLLFNBQVMsRUFBRTtnQkFDakMsSUFBSSxHQUFHLENBQUMsU0FBUyxFQUFFO29CQUNmLElBQUksT0FBTyxHQUFHLENBQUMsU0FBUyxLQUFLLFFBQVEsSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQyxNQUFNLEVBQUU7OzhC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Q0FBQyxXQUFXLEtBQUssQ0FBQyxDQUFDLFNBQVMsRUFBQyxDQUFDO1lBQzdFLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNOzs7O1lBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsU0FBUyxLQUFLLENBQUMsQ0FBQyxTQUFTLEVBQUMsQ0FBQztTQUNoRjtRQUNELElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLEVBQUMsVUFBVSxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLEVBQUUsV0FBVyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ2pHLElBQUksVUFBVSxFQUFFO1lBQ1osSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDN0I7SUFDTCxDQUFDOzs7O0lBRUQsUUFBUTtRQUNKLElBQUksQ0FBQyxVQUFVLEdBQUcsRUFBRSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxXQUFXLEdBQUcsRUFBRSxDQUFDO1FBQ3RCLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ25DLENBQUM7OztZQTVISixVQUFVOzs7Ozs7Ozs7SUFFUCxnREFBK0I7Ozs7O0lBQy9CLGlEQUE4Qjs7SUFFOUIsbURBQThCOztJQUU5QixrREFBNkI7O0lBQzdCLG9EQUErQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBDb2x1bW5GaWx0ZXJUeXBlIH0gZnJvbSAnLi4vdHlwZXMvZGF0YS1jb2x1bW4nO1xyXG5cclxuaW1wb3J0IHsgQm9vbGVhbkZpbHRlckNvbnRyb2wsIERhdGVGaWx0ZXJDb250cm9sLCBFbnVtRmlsdGVyQ29udHJvbCxcclxuICAgICAgICBOdW1iZXJGaWx0ZXJDb250cm9sLCBUZXh0RmlsdGVyQ29udHJvbCB9IGZyb20gJy4uL3BsdWdpbnMvc21hcnQtZmlsdGVyL2NvbnRyb2xEYXRhL2ZpbHRlci1jb250cm9sLm9wdGlvbnMnO1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgRGF0YWdyaWRTbWFydEZpbHRlclNlcnZpY2Uge1xyXG4gICAgcHJpdmF0ZSBjb25kaXRpb25zOiBhbnlbXSA9IFtdO1xyXG4gICAgcHJpdmF0ZSBjb250cm9sRGF0YTogYW55ID0gW107XHJcblxyXG4gICAgZmlsdGVyQ2hhbmdlZCA9IG5ldyBTdWJqZWN0KCk7XHJcblxyXG4gICAgcmVtb3ZlRmlsdGVyID0gbmV3IFN1YmplY3QoKTtcclxuICAgIGNsZWFyQWxsRmlsdGVyID0gbmV3IFN1YmplY3QoKTtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcigpIHsgfVxyXG5cclxuXHJcbiAgICBnZXRDb2x1bW5GaWx0ZXJEYXRhKGNvbDogYW55KSB7XHJcbiAgICAgICAgbGV0IGZpbHRlckNvbnRyb2xEYXRhOiBhbnkgPSB7XHJcbiAgICAgICAgICAgIGNvbnRyb2x0eXBlOiAndGV4dCcsXHJcbiAgICAgICAgfTtcclxuICAgICAgICBpZiAoY29sLmZpbHRlciAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgIGlmICh0eXBlb2YgY29sLmZpbHRlciA9PT0gJ2Jvb2xlYW4nKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoY29sLmZvcm1hdHRlcikge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgY29sLmZvcm1hdHRlciA9PT0gJ29iamVjdCcgJiYgT2JqZWN0LmtleXMoY29sLmZvcm1hdHRlcikubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG9wdGlvbnM6IGFueSA9IGNvbC5mb3JtYXR0ZXJbJ29wdGlvbnMnXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChjb2wuZm9ybWF0dGVyWyd0eXBlJ10pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ251bWJlcic6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIE51bWJlckZpbHRlckNvbnRyb2woY29sKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2VudW0nOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBFbnVtRmlsdGVyQ29udHJvbChjb2wsIG9wdGlvbnMpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnYm9vbGVhbic6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEJvb2xlYW5GaWx0ZXJDb250cm9sKGNvbCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdkYXRldGltZSc6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHR5ZSA9ICdkYXRldGltZSc7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGZtdCA9ICd5eXl5LU1NLWRkJztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgcmV0dXJuRm10ID0gJ3l5eXktTU0tZGQnO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMuZm9ybWF0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZtdCA9IG9wdGlvbnMuZm9ybWF0O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm10LmluZGV4T2YoJ0hIOicpID09IC0xKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eWUgPSAnZGF0ZSc7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm5GbXQgKz0gJyBISDptbSc7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm10LmluZGV4T2YoJ3NzJykgPiAtMSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybkZtdCArPSAnOnNzJztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5ZSA9ICdkYXRlJztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsdGVyQ29udHJvbERhdGEgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2x0eXBlOiAnZmxleGlibGVEYXRlJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0ZUZvcm1hdDogZm10LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaW5nbGU6IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaG93VHlwZTogMyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hvd1RpbWU6IHR5ZSA9PT0gJ2RhdGV0aW1lJ1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBUZXh0RmlsdGVyQ29udHJvbChjb2wpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZpbHRlckNvbnRyb2xEYXRhO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgc3dpdGNoIChjb2wuZmlsdGVyLnR5cGUpIHtcclxuICAgICAgICAgICAgICAgICAgICBjYXNlIENvbHVtbkZpbHRlclR5cGUuZW51bTpcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEVudW1GaWx0ZXJDb250cm9sKGNvbCwgY29sLmZpbHRlci5vcHRpb25zKTtcclxuICAgICAgICAgICAgICAgICAgICBjYXNlIENvbHVtbkZpbHRlclR5cGUuZGF0ZTpcclxuICAgICAgICAgICAgICAgICAgICBjYXNlIENvbHVtbkZpbHRlclR5cGUuZGF0ZXRpbWU6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBEYXRlRmlsdGVyQ29udHJvbChjb2wsIGNvbC5maWx0ZXIub3B0aW9ucyk7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSBDb2x1bW5GaWx0ZXJUeXBlLm51bWJlcjpcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIE51bWJlckZpbHRlckNvbnRyb2woY29sKTtcclxuICAgICAgICAgICAgICAgICAgICBjYXNlIENvbHVtbkZpbHRlclR5cGUuYm9vbGVhbjpcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEJvb2xlYW5GaWx0ZXJDb250cm9sKGNvbCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBmaWx0ZXJDb250cm9sRGF0YTtcclxuICAgIH1cclxuXHJcblxyXG5cclxuICAgIGZpbHRlckNvbmRpdGlvbkNoYW5nZWQoZToge2NvbmRpdGlvbnM6IGFueVtdLCBjb250cm9sRGF0YTogYW55fSkge1xyXG4gICAgICAgIGNvbnN0IGl0ZW1zID0gZS5jb25kaXRpb25zO1xyXG5cclxuICAgICAgICBpZiAoIXRoaXMuY29uZGl0aW9ucyB8fCAhdGhpcy5jb25kaXRpb25zLmxlbmd0aCkge1xyXG4gICAgICAgICAgICB0aGlzLmNvbmRpdGlvbnMucHVzaCguLi5pdGVtcyk7XHJcbiAgICAgICAgICAgIHRoaXMuY29udHJvbERhdGEucHVzaCh7Li4uZS5jb250cm9sRGF0YX0pO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIC8vLyBUT0RPLCBDT05UUk9MREFUQSDnmoTntKLlvJXkuI5jb25kaXRpb25zIOeahOe0ouW8leW+iOWPr+iDveS4jeaYrzHkuKpcclxuXHJcbiAgICAgICAgICAgIHRoaXMuY29uZGl0aW9ucyA9IHRoaXMuY29uZGl0aW9ucy5maWx0ZXIobiA9PiBuLkZpbHRlckZpZWxkICE9PSBpdGVtc1swXS5GaWx0ZXJGaWVsZCk7XHJcbiAgICAgICAgICAgIGlmIChpdGVtcy5sZW5ndGggPT09IDEpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuY29uZGl0aW9ucy5wdXNoKHsgLi4uaXRlbXNbMF0gfSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmNvbmRpdGlvbnMucHVzaCguLi5pdGVtcyk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChlLmNvbnRyb2xEYXRhKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBjdHJsSWR4ID0gdGhpcy5jb250cm9sRGF0YS5maW5kSW5kZXgobiA9PiBuLmxhYmVsQ29kZSA9PT0gZS5jb250cm9sRGF0YS5sYWJlbENvZGUpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGN0cmxJZHggPiAtMSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY29udHJvbERhdGFbY3RybElkeF0gPSB7Li4uZS5jb250cm9sRGF0YX07XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY29udHJvbERhdGEucHVzaCh7Li4uZS5jb250cm9sRGF0YX0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLmZpbHRlckNoYW5nZWQubmV4dCh7Y29uZGl0aW9uczogWy4uLnRoaXMuY29uZGl0aW9uc10sIGNvbnRyb2xEYXRhOiBbLi4udGhpcy5jb250cm9sRGF0YV0gfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcmVtb3ZlQ29uZGl0aW9uKGUsIGVtaXRSZW1vdmUgPSBmYWxzZSkge1xyXG4gICAgICAgIGlmICh0aGlzLmNvbmRpdGlvbnMgJiYgdGhpcy5jb25kaXRpb25zLmxlbmd0aCkge1xyXG4gICAgICAgICAgICB0aGlzLmNvbmRpdGlvbnMgPSB0aGlzLmNvbmRpdGlvbnMuZmlsdGVyKG4gPT4gbi5GaWx0ZXJGaWVsZCAhPT0gZS5sYWJlbENvZGUpO1xyXG4gICAgICAgICAgICB0aGlzLmNvbnRyb2xEYXRhID0gdGhpcy5jb250cm9sRGF0YS5maWx0ZXIobiA9PiBuLmxhYmVsQ29kZSAhPT0gZS5sYWJlbENvZGUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmZpbHRlckNoYW5nZWQubmV4dCh7Y29uZGl0aW9uczogWy4uLnRoaXMuY29uZGl0aW9uc10sIGNvbnRyb2xEYXRhOiBbLi4udGhpcy5jb250cm9sRGF0YV0gfSk7XHJcbiAgICAgICAgaWYgKGVtaXRSZW1vdmUpIHtcclxuICAgICAgICAgICAgdGhpcy5yZW1vdmVGaWx0ZXIubmV4dChlKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgY2xlYXJBbGwoKSB7XHJcbiAgICAgICAgdGhpcy5jb25kaXRpb25zID0gW107XHJcbiAgICAgICAgdGhpcy5jb250cm9sRGF0YSA9IFtdO1xyXG4gICAgICAgIHRoaXMuY2xlYXJBbGxGaWx0ZXIubmV4dChudWxsKTtcclxuICAgIH1cclxufVxyXG4iXX0=