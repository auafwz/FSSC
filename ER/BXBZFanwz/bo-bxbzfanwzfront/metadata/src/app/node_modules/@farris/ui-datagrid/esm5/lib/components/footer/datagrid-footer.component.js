/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { DatagridComponent } from './../../datagrid.component';
/*
 * @Author: 疯狂秀才(Lucas Huang)
 * @Date: 2019-08-12 15:01:21
 * @LastEditors: 疯狂秀才(Lucas Huang)
 * @LastEditTime: 2019-11-09 15:24:45
 * @QQ: 1055818239
 * @Version: v0.0.1
 */
import { Component, Input, ElementRef, Renderer2, ViewChild, Injector, Inject, forwardRef, ChangeDetectorRef } from '@angular/core';
import { DatagridService } from '../../services/datagrid.service';
import { FIXED_LEFT_SHADOW_CLS, FIXED_RIGHT_SHADOW_CLS, SCROLL_X_ACTION, SCROLL_X_REACH_START_ACTION } from '../../types/constant';
var DatagridFooterComponent = /** @class */ (function () {
    function DatagridFooterComponent(render, injector, dg) {
        var _this = this;
        this.render = render;
        this.injector = injector;
        this.dg = dg;
        this._footerData = [];
        /**
         * 显示位置，默认为 底部
         */
        this.position = 'bottom';
        this.scrollX = 0;
        this.showShadowCls = false;
        this.rightFixedColumnWidth = 0;
        this.cdRef = null;
        this.dg = this.injector.get(DatagridComponent);
        this.dgs = this.injector.get(DatagridService);
        this.cdRef = this.injector.get(ChangeDetectorRef);
        this.scrollXSubscription = this.dgs.scorll$.subscribe((/**
         * @param {?} d
         * @return {?}
         */
        function (d) {
            _this.scrollX = d.x;
            if (d.type === SCROLL_X_ACTION) {
                if (!_this.dg.footerTemplate) {
                    _this.render.setStyle(_this.footerBody.nativeElement, 'transform', "translate3d(-" + d.x + "px, 0px, 0px)");
                    if (_this.fixedLeft) {
                        if (d.x) {
                            _this.render.addClass(_this.fixedLeft.nativeElement, FIXED_LEFT_SHADOW_CLS);
                        }
                        else {
                            _this.render.removeClass(_this.fixedLeft.nativeElement, FIXED_LEFT_SHADOW_CLS);
                        }
                    }
                }
            }
            if (d.type === SCROLL_X_REACH_START_ACTION) {
                if (_this.fixedLeft) {
                    _this.render.removeClass(_this.fixedLeft.nativeElement, FIXED_LEFT_SHADOW_CLS);
                }
            }
        }));
        this.dgs.showFixedShadow.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        function (e) {
            if (_this.fixedRight) {
                _this.setFixedColumnPosition(e.showRightShadow, e.x);
            }
        }));
        this.dgs.showGridHeader.subscribe((/**
         * @param {?} hh
         * @return {?}
         */
        function (hh) {
            _this.setFooterPosition(false);
        }));
        this.dgs.scrollbarUpdate.subscribe((/**
         * @param {?} ps
         * @return {?}
         */
        function (ps) {
            _this.rightFixedColumnWidth = _this.getRightFixedColWidth(ps.scrollbarRef);
            if (_this.fixedRight) {
                _this.setFixedColumnPosition(_this.showShadowCls, 0);
            }
            if (_this.cdRef) {
                _this.cdRef.detectChanges();
            }
        }));
    }
    Object.defineProperty(DatagridFooterComponent.prototype, "data", {
        get: /**
         * @return {?}
         */
        function () {
            return this._footerData;
        },
        set: /**
         * @param {?} val
         * @return {?}
         */
        function (val) {
            this._footerData = val;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(DatagridFooterComponent.prototype, "fr", {
        set: /**
         * @param {?} val
         * @return {?}
         */
        function (val) {
            if (val) {
                this.fixedRight = val;
            }
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @return {?}
     */
    DatagridFooterComponent.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        this.renderFooterStyle();
        this.setFooterPosition(false);
        this.rightFixedColumnWidth = this.getRightFixedColWidth();
    };
    /**
     * @param {?} changes
     * @return {?}
     */
    DatagridFooterComponent.prototype.ngOnChanges = /**
     * @param {?} changes
     * @return {?}
     */
    function (changes) {
        if (changes.position) {
            this.setFooterPosition(true);
        }
        if (changes.columnsGroup && !changes.columnsGroup.isFirstChange()) {
            this.rightFixedColumnWidth = this.getRightFixedColWidth();
        }
    };
    /**
     * @return {?}
     */
    DatagridFooterComponent.prototype.ngOnDestroy = /**
     * @return {?}
     */
    function () {
        if (this.scrollXSubscription) {
            this.scrollXSubscription.unsubscribe();
            this.scrollXSubscription = null;
        }
    };
    /**
     * @private
     * @param {?=} ps
     * @return {?}
     */
    DatagridFooterComponent.prototype.getRightFixedColWidth = /**
     * @private
     * @param {?=} ps
     * @return {?}
     */
    function (ps) {
        if (ps === void 0) { ps = null; }
        if (!this.columnsGroup) {
            return 0;
        }
        /** @type {?} */
        var w = this.columnsGroup.rightFixedWidth;
        if (!ps) {
            ps = this.dg.scrollInstance.instance;
        }
        if (ps && ps.scrollbarYActive && this.dg.scrollBarShowMode === 'allways') {
            return w += 18;
        }
        return w;
    };
    /**
     * @private
     * @param {?=} emit
     * @return {?}
     */
    DatagridFooterComponent.prototype.setFooterPosition = /**
     * @private
     * @param {?=} emit
     * @return {?}
     */
    function (emit) {
        if (emit === void 0) { emit = true; }
        if (this.position === 'bottom') {
            /** @type {?} */
            var positionBottom = 0;
            if (this.dg.pagination) {
                positionBottom = this.dg.pagerHeight || 40;
            }
            this.render.removeStyle(this.footerContainer.nativeElement, 'top');
            this.render.setStyle(this.footerContainer.nativeElement, 'bottom', positionBottom + "px");
        }
        if (this.position === 'top') {
            /** @type {?} */
            var positionTop = 0;
            if (this.dg.showHeader) {
                positionTop = this.dg.realHeaderHeight || 35;
            }
            if (this.dg.showRowGroupPanel) {
                positionTop += this.dg.rowGroupPanelHeight;
            }
            if (this.dg.showFilterBar) {
                positionTop += this.dg.filterBarHeight;
            }
            this.render.removeStyle(this.footerContainer.nativeElement, 'bottom');
            this.render.setStyle(this.footerContainer.nativeElement, 'top', positionTop + "px");
        }
        if (emit) {
            this.dgs.footerPositionChanged.emit();
        }
    };
    /**
     * @private
     * @return {?}
     */
    DatagridFooterComponent.prototype.renderFooterStyle = /**
     * @private
     * @return {?}
     */
    function () {
        if (this.dg.footerStyler) {
            /** @type {?} */
            var trStyleAndCls = this.dgs.getCustomStyle(this.dg.footerStyler, null);
            /** @type {?} */
            var cssRuleID = this.dg.customStyleKey() + " .f-datagrid-footer";
            /** @type {?} */
            var cssRuleId2 = this.dg.customStyleKey() + " .f-datagrid-footer .f-datagrid-body-fixed-left," + this.dg.customStyleKey() + " .f-datagrid-footer .f-datagrid-body-fixed-right";
            if (trStyleAndCls && Object.keys(trStyleAndCls).length) {
                /** @type {?} */
                var cssRule = [];
                if (trStyleAndCls.style) {
                    cssRule.push(cssRuleID + " " + JSON.stringify(trStyleAndCls.style));
                    cssRule.push(cssRuleId2 + " " + JSON.stringify(trStyleAndCls.style));
                }
                this.dgs.appendCssRules(cssRule);
                // this.dg.renderCustomStyle(trStyleAndCls, this.footerContainer.nativeElement, cssRule);
            }
            else {
                this.dgs.removeCssRule([cssRuleID, cssRuleId2]);
            }
        }
    };
    /**
     * @param {?} isShow
     * @param {?} scrollLeft
     * @return {?}
     */
    DatagridFooterComponent.prototype.setFixedColumnPosition = /**
     * @param {?} isShow
     * @param {?} scrollLeft
     * @return {?}
     */
    function (isShow, scrollLeft) {
        this.showShadowCls = isShow;
        /** @type {?} */
        var method = isShow ? 'addClass' : 'removeClass';
        this.render[method](this.fixedRight.nativeElement, FIXED_RIGHT_SHADOW_CLS);
        /** @type {?} */
        var realWidth = this.columnsGroup.leftFixedWidth + this.columnsGroup.normalWidth + this.rightFixedColumnWidth;
        /** @type {?} */
        var gridWidth = this.dg.width;
        /** @type {?} */
        var l = this.dg.width - (this.dg.showBorder ? 2 : 0) - this.rightFixedColumnWidth;
        if (gridWidth > realWidth) {
            l = this.columnsGroup.leftFixedWidth + this.columnsGroup.normalWidth;
        }
        this.render.setStyle(this.fixedRight.nativeElement, 'left', l + 'px');
    };
    DatagridFooterComponent.decorators = [
        { type: Component, args: [{
                    selector: 'datagrid-footer',
                    template: "<!--\r\n * @Author: \u75AF\u72C2\u79C0\u624D(Lucas Huang)\r\n * @Date: 2019-08-12 15:02:10\r\n * @LastEditors: \u75AF\u72C2\u79C0\u624D(Lucas Huang)\r\n * @LastEditTime: 2019-10-31 14:50:47\r\n * @QQ: 1055818239\r\n * @Version: v0.0.1\r\n -->\r\n\r\n<ng-template #footer_content_template let-columns let-left=\"fixedLeft\" let-right=\"fixedRight\">\r\n    <table cellpadding=\"0\" cellspacing=\"0\" border=\"0\" style=\"border:0; width: 100%\" class=\"f-datagrid-rows\">\r\n        <colgroup>\r\n            <col width=\"36px\" *ngIf=\"dg.showCheckbox && left\"/>\r\n            <col [width]=\"dg.lineNumberWidth + 'px'\" *ngIf=\"dg.showLineNumber && left\"/>\r\n            <col *ngFor=\"let col of columns\" [width]=\"col.width + 'px'\"/>\r\n        </colgroup>\r\n        <tbody>\r\n            <tr #tr class=\"f-datagrid-body-row f-datagrid-footer-row\"\r\n                [attr.id]=\"'footer-'+ (row| rowDataId: right: left)\"\r\n                *ngFor=\"let row of data;let rowIndex = index;trackBy: dg.trackByRows\" \r\n                [attr.index]=\"rowIndex\">\r\n\r\n                <td *ngIf=\"dg.showCheckbox && left\" class=\"f-datagrid-cell f-datagrid-cell-checkbox\" style=\"text-align: center\"></td>\r\n                <td *ngIf=\"dg.showLineNumber  && left\" class=\"f-datagrid-cell f-datagrid-cell-rownumber\" ></td>\r\n\r\n                <td class=\"f-datagrid-cell {{ 'footer-td-'+ col.field }}\"\r\n                    [style.width.px]=\"col.width\"\r\n                    [attr.colspan]=\"col.footer?.colspan || 1\"\r\n                    [style.display]=\"col.footer?.visible === false ? 'none': ''\"\r\n                    [attr.field]=\"col.field\" [attr.align]=\"col.footer?.align || col.align\"\r\n                    *ngFor=\"let col of columns; let ci = index;\"\r\n                    footer-cell-styler [column]=\"col\" [rowData]=\"row\" [rowIndex]=\"rowIndex\">\r\n                    <div class=\"f-datagrid-cell-content\" style=\"width: 100%\">\r\n                        <span *ngIf=\"col.footer && col.footer.formatter\" [innerHtml]=\"col | formatCellData: row : false: true | safe: 'html'\"></span>\r\n                        <span *ngIf=\"!col.footer || !col.footer.formatter\">{{ col | formatCellData: row : false: true }}</span>\r\n                    </div>\r\n                </td>\r\n            </tr>\r\n        </tbody>\r\n    </table>\r\n</ng-template>\r\n\r\n<div #footerContainer class=\"f-datagrid-footer\"\r\n    [class.f-datagrid-toolbar-top]=\"position === 'top'\"  \r\n    [class.f-datagrid-toolbar-bottom]=\"position === 'bottom'\"\r\n    [style.height.px]=\"height\"\r\n    >\r\n    <ng-container *ngIf=\"!dg.footerTemplate\">\r\n        \r\n        <div #fixedLeft class=\"f-datagrid-body-fixed-left\" \r\n            [style.width.px]=\"columnsGroup?.leftFixedWidth\" [style.height.px]=\"height\" \r\n            *ngIf=\"columnsGroup?.leftFixed && columnsGroup?.leftFixed.length  || dg?.showLineNumber || dg?.showCheckbox \">\r\n\r\n            <ng-container *ngTemplateOutlet=\"footer_content_template; context: {$implicit: columnsGroup?.leftFixed, fixedLeft: true}\"></ng-container>\r\n            \r\n        </div>\r\n\r\n        <div #fixedRight class=\"f-datagrid-body-fixed-right\" style=\"position: absolute;border: 0;\"\r\n            [style.width.px]=\"rightFixedColumnWidth\" [style.height.px]=\"height\"\r\n            *ngIf=\"columnsGroup?.rightFixed && columnsGroup?.rightFixed.length\">\r\n\r\n            <ng-container *ngTemplateOutlet=\"footer_content_template; context: {$implicit: columnsGroup?.rightFixed, fixedRight: true}\"></ng-container>\r\n            \r\n        </div>\r\n\r\n        <div #footerBody class=\"f-datagrid-footer-rows\" style=\"position: absolute;\"\r\n            [style.left.px]=\"columnsGroup?.leftFixedWidth\" [style.width.px]=\"columnsGroup?.normalWidth\" >\r\n            <ng-container *ngTemplateOutlet=\"footer_content_template; context: {$implicit: columnsGroup?.normalColumns}\"></ng-container>\r\n        </div>\r\n\r\n    </ng-container>\r\n\r\n\r\n    <ng-container *ngIf=\"dg.footerTemplate\" [ngTemplateOutlet]=\"dg.footerTemplate\" [ngTemplateOutletContext]=\"{footerData: data }\" ></ng-container>\r\n    \r\n</div>"
                }] }
    ];
    /** @nocollapse */
    DatagridFooterComponent.ctorParameters = function () { return [
        { type: Renderer2 },
        { type: Injector },
        { type: DatagridComponent, decorators: [{ type: Inject, args: [forwardRef((/**
                         * @return {?}
                         */
                        function () { return DatagridComponent; })),] }] }
    ]; };
    DatagridFooterComponent.propDecorators = {
        data: [{ type: Input }],
        height: [{ type: Input }],
        width: [{ type: Input }],
        columns: [{ type: Input }],
        columnsGroup: [{ type: Input }],
        position: [{ type: Input }],
        footerContainer: [{ type: ViewChild, args: ['footerContainer',] }],
        footerBody: [{ type: ViewChild, args: ['footerBody',] }],
        fixedLeft: [{ type: ViewChild, args: ['fixedLeft',] }],
        fr: [{ type: ViewChild, args: ['fixedRight',] }]
    };
    return DatagridFooterComponent;
}());
export { DatagridFooterComponent };
if (false) {
    /**
     * @type {?}
     * @private
     */
    DatagridFooterComponent.prototype._footerData;
    /** @type {?} */
    DatagridFooterComponent.prototype.height;
    /** @type {?} */
    DatagridFooterComponent.prototype.width;
    /** @type {?} */
    DatagridFooterComponent.prototype.columns;
    /** @type {?} */
    DatagridFooterComponent.prototype.columnsGroup;
    /**
     * 显示位置，默认为 底部
     * @type {?}
     */
    DatagridFooterComponent.prototype.position;
    /** @type {?} */
    DatagridFooterComponent.prototype.footerContainer;
    /** @type {?} */
    DatagridFooterComponent.prototype.footerBody;
    /** @type {?} */
    DatagridFooterComponent.prototype.fixedLeft;
    /**
     * @type {?}
     * @private
     */
    DatagridFooterComponent.prototype.fixedRight;
    /** @type {?} */
    DatagridFooterComponent.prototype.scrollXSubscription;
    /**
     * @type {?}
     * @private
     */
    DatagridFooterComponent.prototype.dgs;
    /**
     * @type {?}
     * @private
     */
    DatagridFooterComponent.prototype.scrollX;
    /**
     * @type {?}
     * @private
     */
    DatagridFooterComponent.prototype.showShadowCls;
    /** @type {?} */
    DatagridFooterComponent.prototype.rightFixedColumnWidth;
    /**
     * @type {?}
     * @private
     */
    DatagridFooterComponent.prototype.cdRef;
    /**
     * @type {?}
     * @private
     */
    DatagridFooterComponent.prototype.render;
    /**
     * @type {?}
     * @private
     */
    DatagridFooterComponent.prototype.injector;
    /** @type {?} */
    DatagridFooterComponent.prototype.dg;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YWdyaWQtZm9vdGVyLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvdWktZGF0YWdyaWQvIiwic291cmNlcyI6WyJsaWIvY29tcG9uZW50cy9mb290ZXIvZGF0YWdyaWQtZm9vdGVyLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sNEJBQTRCLENBQUM7Ozs7Ozs7OztBQVMvRCxPQUFPLEVBQUUsU0FBUyxFQUFVLEtBQUssRUFBRSxVQUFVLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBYSxRQUFRLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBNEIsaUJBQWlCLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDakwsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLGlDQUFpQyxDQUFDO0FBQ2xFLE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxzQkFBc0IsRUFBRSxlQUFlLEVBQUUsMkJBQTJCLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUduSTtJQXVDSSxpQ0FDWSxNQUFpQixFQUFVLFFBQWtCLEVBQ0QsRUFBcUI7UUFGN0UsaUJBa0RDO1FBakRXLFdBQU0sR0FBTixNQUFNLENBQVc7UUFBVSxhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQ0QsT0FBRSxHQUFGLEVBQUUsQ0FBbUI7UUFwQ3JFLGdCQUFXLEdBQUcsRUFBRSxDQUFDOzs7O1FBY2hCLGFBQVEsR0FBcUIsUUFBUSxDQUFDO1FBZXZDLFlBQU8sR0FBRyxDQUFDLENBQUM7UUFDWixrQkFBYSxHQUFHLEtBQUssQ0FBQztRQUM5QiwwQkFBcUIsR0FBRyxDQUFDLENBQUM7UUFDbEIsVUFBSyxHQUFzQixJQUFJLENBQUM7UUFNcEMsSUFBSSxDQUFDLEVBQUUsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1FBQy9DLElBQUksQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FB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QUFRO2dCQVQvRSxpQkFBaUIsdUJBdURqQixNQUFNLFNBQUMsVUFBVTs7O3dCQUFDLGNBQU0sT0FBQSxpQkFBaUIsRUFBakIsQ0FBaUIsRUFBQzs7O3VCQW5DOUMsS0FBSzt5QkFPTCxLQUFLO3dCQUNMLEtBQUs7MEJBQ0wsS0FBSzsrQkFDTCxLQUFLOzJCQUdMLEtBQUs7a0NBR0wsU0FBUyxTQUFDLGlCQUFpQjs2QkFDM0IsU0FBUyxTQUFDLFlBQVk7NEJBQ3RCLFNBQVMsU0FBQyxXQUFXO3FCQUVyQixTQUFTLFNBQUMsWUFBWTs7SUErSzNCLDhCQUFDO0NBQUEsQUF6TUQsSUF5TUM7U0FyTVksdUJBQXVCOzs7Ozs7SUFDaEMsOENBQXlCOztJQVF6Qix5Q0FBd0I7O0lBQ3hCLHdDQUF1Qjs7SUFDdkIsMENBQXdCOztJQUN4QiwrQ0FBMkI7Ozs7O0lBRzNCLDJDQUErQzs7SUFHL0Msa0RBQTBEOztJQUMxRCw2Q0FBZ0Q7O0lBQ2hELDRDQUE4Qzs7Ozs7SUFDOUMsNkNBQStCOztJQU0vQixzREFBa0M7Ozs7O0lBRWxDLHNDQUE2Qjs7Ozs7SUFDN0IsMENBQW9COzs7OztJQUNwQixnREFBOEI7O0lBQzlCLHdEQUEwQjs7Ozs7SUFDMUIsd0NBQXdDOzs7OztJQUdwQyx5Q0FBeUI7Ozs7O0lBQUUsMkNBQTBCOztJQUNyRCxxQ0FBeUUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBEYXRhZ3JpZENvbXBvbmVudCB9IGZyb20gJy4vLi4vLi4vZGF0YWdyaWQuY29tcG9uZW50JztcclxuLypcclxuICogQEF1dGhvcjog55av54uC56eA5omNKEx1Y2FzIEh1YW5nKVxyXG4gKiBARGF0ZTogMjAxOS0wOC0xMiAxNTowMToyMVxyXG4gKiBATGFzdEVkaXRvcnM6IOeWr+eLguengOaJjShMdWNhcyBIdWFuZylcclxuICogQExhc3RFZGl0VGltZTogMjAxOS0xMS0wOSAxNToyNDo0NVxyXG4gKiBAUVE6IDEwNTU4MTgyMzlcclxuICogQFZlcnNpb246IHYwLjAuMVxyXG4gKi9cclxuaW1wb3J0IHsgQ29tcG9uZW50LCBPbkluaXQsIElucHV0LCBFbGVtZW50UmVmLCBSZW5kZXJlcjIsIFZpZXdDaGlsZCwgT25EZXN0cm95LCBJbmplY3RvciwgSW5qZWN0LCBmb3J3YXJkUmVmLCBPbkNoYW5nZXMsIFNpbXBsZUNoYW5nZXMsIENoYW5nZURldGVjdG9yUmVmIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IERhdGFncmlkU2VydmljZSB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL2RhdGFncmlkLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBGSVhFRF9MRUZUX1NIQURPV19DTFMsIEZJWEVEX1JJR0hUX1NIQURPV19DTFMsIFNDUk9MTF9YX0FDVElPTiwgU0NST0xMX1hfUkVBQ0hfU1RBUlRfQUNUSU9OIH0gZnJvbSAnLi4vLi4vdHlwZXMvY29uc3RhbnQnO1xyXG5pbXBvcnQgeyBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcclxuXHJcbkBDb21wb25lbnQoe1xyXG4gICAgc2VsZWN0b3I6ICdkYXRhZ3JpZC1mb290ZXInLFxyXG4gICAgdGVtcGxhdGVVcmw6ICcuL2RhdGFncmlkLWZvb3Rlci5jb21wb25lbnQuaHRtbCdcclxufSlcclxuZXhwb3J0IGNsYXNzIERhdGFncmlkRm9vdGVyQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBPbkNoYW5nZXMsIE9uRGVzdHJveSB7XHJcbiAgICBwcml2YXRlIF9mb290ZXJEYXRhID0gW107XHJcbiAgICBASW5wdXQoKSBnZXQgZGF0YSgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fZm9vdGVyRGF0YTtcclxuICAgIH1cclxuICAgIHNldCBkYXRhKHZhbDogYW55W10pIHtcclxuICAgICAgICB0aGlzLl9mb290ZXJEYXRhID0gdmFsO1xyXG4gICAgfVxyXG5cclxuICAgIEBJbnB1dCgpIGhlaWdodDogbnVtYmVyO1xyXG4gICAgQElucHV0KCkgd2lkdGg6IG51bWJlcjtcclxuICAgIEBJbnB1dCgpIGNvbHVtbnM6IGFueVtdO1xyXG4gICAgQElucHV0KCkgY29sdW1uc0dyb3VwOiBhbnk7XHJcblxyXG4gICAgLyoqIOaYvuekuuS9jee9ru+8jOm7mOiupOS4uiDlupXpg6ggKi9cclxuICAgIEBJbnB1dCgpIHBvc2l0aW9uOiAndG9wJyB8ICdib3R0b20nID0gJ2JvdHRvbSc7XHJcblxyXG5cclxuICAgIEBWaWV3Q2hpbGQoJ2Zvb3RlckNvbnRhaW5lcicpIGZvb3RlckNvbnRhaW5lcjogRWxlbWVudFJlZjtcclxuICAgIEBWaWV3Q2hpbGQoJ2Zvb3RlckJvZHknKSBmb290ZXJCb2R5OiBFbGVtZW50UmVmO1xyXG4gICAgQFZpZXdDaGlsZCgnZml4ZWRMZWZ0JykgZml4ZWRMZWZ0OiBFbGVtZW50UmVmO1xyXG4gICAgcHJpdmF0ZSBmaXhlZFJpZ2h0OiBFbGVtZW50UmVmO1xyXG4gICAgQFZpZXdDaGlsZCgnZml4ZWRSaWdodCcpIHNldCBmcih2YWwpIHtcclxuICAgICAgICBpZiAodmFsKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZml4ZWRSaWdodCA9IHZhbDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBzY3JvbGxYU3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XHJcblxyXG4gICAgcHJpdmF0ZSBkZ3M6IERhdGFncmlkU2VydmljZTtcclxuICAgIHByaXZhdGUgc2Nyb2xsWCA9IDA7XHJcbiAgICBwcml2YXRlIHNob3dTaGFkb3dDbHMgPSBmYWxzZTtcclxuICAgIHJpZ2h0Rml4ZWRDb2x1bW5XaWR0aCA9IDA7XHJcbiAgICBwcml2YXRlIGNkUmVmOiBDaGFuZ2VEZXRlY3RvclJlZiA9IG51bGw7XHJcblxyXG4gICAgY29uc3RydWN0b3IoXHJcbiAgICAgICAgcHJpdmF0ZSByZW5kZXI6IFJlbmRlcmVyMiwgcHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IsXHJcbiAgICAgICAgQEluamVjdChmb3J3YXJkUmVmKCgpID0+IERhdGFncmlkQ29tcG9uZW50KSkgcHVibGljIGRnOiBEYXRhZ3JpZENvbXBvbmVudFxyXG4gICAgKSB7XHJcbiAgICAgICAgdGhpcy5kZyA9IHRoaXMuaW5qZWN0b3IuZ2V0KERhdGFncmlkQ29tcG9uZW50KTtcclxuICAgICAgICB0aGlzLmRncyA9IHRoaXMuaW5qZWN0b3IuZ2V0KERhdGFncmlkU2VydmljZSk7XHJcbiAgICAgICAgdGhpcy5jZFJlZiA9IHRoaXMuaW5qZWN0b3IuZ2V0KENoYW5nZURldGVjdG9yUmVmKTtcclxuXHJcbiAgICAgICAgdGhpcy5zY3JvbGxYU3Vic2NyaXB0aW9uID0gdGhpcy5kZ3Muc2NvcmxsJC5zdWJzY3JpYmUoKGQ6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLnNjcm9sbFggPSBkLng7XHJcbiAgICAgICAgICAgIGlmIChkLnR5cGUgPT09IFNDUk9MTF9YX0FDVElPTikge1xyXG4gICAgICAgICAgICAgICAgaWYgKCF0aGlzLmRnLmZvb3RlclRlbXBsYXRlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW5kZXIuc2V0U3R5bGUodGhpcy5mb290ZXJCb2R5Lm5hdGl2ZUVsZW1lbnQsICAndHJhbnNmb3JtJywgYHRyYW5zbGF0ZTNkKC0ke2QueH1weCwgMHB4LCAwcHgpYCApO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5maXhlZExlZnQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGQueCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW5kZXIuYWRkQ2xhc3ModGhpcy5maXhlZExlZnQubmF0aXZlRWxlbWVudCwgRklYRURfTEVGVF9TSEFET1dfQ0xTKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyLnJlbW92ZUNsYXNzKHRoaXMuZml4ZWRMZWZ0Lm5hdGl2ZUVsZW1lbnQsIEZJWEVEX0xFRlRfU0hBRE9XX0NMUyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChkLnR5cGUgPT09IFNDUk9MTF9YX1JFQUNIX1NUQVJUX0FDVElPTikge1xyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuZml4ZWRMZWZ0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW5kZXIucmVtb3ZlQ2xhc3ModGhpcy5maXhlZExlZnQubmF0aXZlRWxlbWVudCwgRklYRURfTEVGVF9TSEFET1dfQ0xTKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICB0aGlzLmRncy5zaG93Rml4ZWRTaGFkb3cuc3Vic2NyaWJlKChlOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuZml4ZWRSaWdodCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zZXRGaXhlZENvbHVtblBvc2l0aW9uKGUuc2hvd1JpZ2h0U2hhZG93LCBlLngpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHRoaXMuZGdzLnNob3dHcmlkSGVhZGVyLnN1YnNjcmliZShoaCA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuc2V0Rm9vdGVyUG9zaXRpb24oZmFsc2UpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICB0aGlzLmRncy5zY3JvbGxiYXJVcGRhdGUuc3Vic2NyaWJlKChwczogYW55KSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMucmlnaHRGaXhlZENvbHVtbldpZHRoID0gdGhpcy5nZXRSaWdodEZpeGVkQ29sV2lkdGgocHMuc2Nyb2xsYmFyUmVmKTtcclxuICAgICAgICAgICAgaWYgKHRoaXMuZml4ZWRSaWdodCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zZXRGaXhlZENvbHVtblBvc2l0aW9uKHRoaXMuc2hvd1NoYWRvd0NscywgMCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKHRoaXMuY2RSZWYpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuY2RSZWYuZGV0ZWN0Q2hhbmdlcygpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgbmdPbkluaXQoKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5yZW5kZXJGb290ZXJTdHlsZSgpO1xyXG4gICAgICAgIHRoaXMuc2V0Rm9vdGVyUG9zaXRpb24oZmFsc2UpO1xyXG5cclxuICAgICAgICB0aGlzLnJpZ2h0Rml4ZWRDb2x1bW5XaWR0aCA9IHRoaXMuZ2V0UmlnaHRGaXhlZENvbFdpZHRoKCk7XHJcbiAgICB9XHJcblxyXG4gICAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcykge1xyXG4gICAgICAgIGlmIChjaGFuZ2VzLnBvc2l0aW9uKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc2V0Rm9vdGVyUG9zaXRpb24odHJ1ZSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoY2hhbmdlcy5jb2x1bW5zR3JvdXAgJiYgIWNoYW5nZXMuY29sdW1uc0dyb3VwLmlzRmlyc3RDaGFuZ2UoKSkge1xyXG4gICAgICAgICAgICB0aGlzLnJpZ2h0Rml4ZWRDb2x1bW5XaWR0aCA9IHRoaXMuZ2V0UmlnaHRGaXhlZENvbFdpZHRoKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIG5nT25EZXN0cm95KCkge1xyXG4gICAgICAgIGlmICh0aGlzLnNjcm9sbFhTdWJzY3JpcHRpb24pIHtcclxuICAgICAgICAgICAgdGhpcy5zY3JvbGxYU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XHJcbiAgICAgICAgICAgIHRoaXMuc2Nyb2xsWFN1YnNjcmlwdGlvbiA9IG51bGw7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZ2V0UmlnaHRGaXhlZENvbFdpZHRoKHBzID0gbnVsbCkge1xyXG4gICAgICAgIGlmICghdGhpcy5jb2x1bW5zR3JvdXApIHtcclxuICAgICAgICAgICAgcmV0dXJuIDA7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBsZXQgdyA9IHRoaXMuY29sdW1uc0dyb3VwLnJpZ2h0Rml4ZWRXaWR0aDtcclxuXHJcbiAgICAgICAgaWYgKCFwcykge1xyXG4gICAgICAgICAgICBwcyA9IHRoaXMuZGcuc2Nyb2xsSW5zdGFuY2UuaW5zdGFuY2U7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAocHMgJiYgcHMuc2Nyb2xsYmFyWUFjdGl2ZSAmJiB0aGlzLmRnLnNjcm9sbEJhclNob3dNb2RlID09PSAnYWxsd2F5cycpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHcgKz0gMTg7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB3O1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgc2V0Rm9vdGVyUG9zaXRpb24oZW1pdCA9IHRydWUpIHtcclxuICAgICAgICBpZiAodGhpcy5wb3NpdGlvbiA9PT0gJ2JvdHRvbScpIHtcclxuICAgICAgICAgICAgbGV0IHBvc2l0aW9uQm90dG9tID0gMDtcclxuICAgICAgICAgICAgaWYgKHRoaXMuZGcucGFnaW5hdGlvbikge1xyXG4gICAgICAgICAgICAgICAgcG9zaXRpb25Cb3R0b20gPSB0aGlzLmRnLnBhZ2VySGVpZ2h0IHx8IDQwO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMucmVuZGVyLnJlbW92ZVN0eWxlKHRoaXMuZm9vdGVyQ29udGFpbmVyLm5hdGl2ZUVsZW1lbnQsICd0b3AnKTtcclxuICAgICAgICAgICAgdGhpcy5yZW5kZXIuc2V0U3R5bGUodGhpcy5mb290ZXJDb250YWluZXIubmF0aXZlRWxlbWVudCwgJ2JvdHRvbScsIGAke3Bvc2l0aW9uQm90dG9tfXB4YCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh0aGlzLnBvc2l0aW9uID09PSAndG9wJykge1xyXG4gICAgICAgICAgICBsZXQgcG9zaXRpb25Ub3AgPSAwO1xyXG4gICAgICAgICAgICBpZiAodGhpcy5kZy5zaG93SGVhZGVyKSB7XHJcbiAgICAgICAgICAgICAgICBwb3NpdGlvblRvcCA9IHRoaXMuZGcucmVhbEhlYWRlckhlaWdodCB8fCAzNTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKHRoaXMuZGcuc2hvd1Jvd0dyb3VwUGFuZWwpIHtcclxuICAgICAgICAgICAgICAgIHBvc2l0aW9uVG9wICs9IHRoaXMuZGcucm93R3JvdXBQYW5lbEhlaWdodDtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKHRoaXMuZGcuc2hvd0ZpbHRlckJhcikge1xyXG4gICAgICAgICAgICAgICAgcG9zaXRpb25Ub3AgKz0gdGhpcy5kZy5maWx0ZXJCYXJIZWlnaHQ7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHRoaXMucmVuZGVyLnJlbW92ZVN0eWxlKHRoaXMuZm9vdGVyQ29udGFpbmVyLm5hdGl2ZUVsZW1lbnQsICdib3R0b20nKTtcclxuICAgICAgICAgICAgdGhpcy5yZW5kZXIuc2V0U3R5bGUodGhpcy5mb290ZXJDb250YWluZXIubmF0aXZlRWxlbWVudCwgJ3RvcCcsIGAke3Bvc2l0aW9uVG9wfXB4YCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChlbWl0KSB7XHJcbiAgICAgICAgICAgIHRoaXMuZGdzLmZvb3RlclBvc2l0aW9uQ2hhbmdlZC5lbWl0KCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgcmVuZGVyRm9vdGVyU3R5bGUoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuZGcuZm9vdGVyU3R5bGVyKSB7XHJcblxyXG4gICAgICAgICAgICBjb25zdCB0clN0eWxlQW5kQ2xzID0gdGhpcy5kZ3MuZ2V0Q3VzdG9tU3R5bGUodGhpcy5kZy5mb290ZXJTdHlsZXIsIG51bGwpO1xyXG5cclxuICAgICAgICAgICAgY29uc3QgY3NzUnVsZUlEID0gYCR7dGhpcy5kZy5jdXN0b21TdHlsZUtleSgpfSAuZi1kYXRhZ3JpZC1mb290ZXJgO1xyXG4gICAgICAgICAgICBjb25zdCBjc3NSdWxlSWQyID0gYCR7dGhpcy5kZy5jdXN0b21TdHlsZUtleSgpfSAuZi1kYXRhZ3JpZC1mb290ZXIgLmYtZGF0YWdyaWQtYm9keS1maXhlZC1sZWZ0LCR7dGhpcy5kZy5jdXN0b21TdHlsZUtleSgpfSAuZi1kYXRhZ3JpZC1mb290ZXIgLmYtZGF0YWdyaWQtYm9keS1maXhlZC1yaWdodGA7XHJcblxyXG4gICAgICAgICAgICBpZiAodHJTdHlsZUFuZENscyAmJiBPYmplY3Qua2V5cyh0clN0eWxlQW5kQ2xzKS5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGNzc1J1bGUgPSBbXTtcclxuICAgICAgICAgICAgICAgIGlmICh0clN0eWxlQW5kQ2xzLnN0eWxlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY3NzUnVsZS5wdXNoKGAke2Nzc1J1bGVJRH0gJHtKU09OLnN0cmluZ2lmeSh0clN0eWxlQW5kQ2xzLnN0eWxlKX1gKTtcclxuICAgICAgICAgICAgICAgICAgICBjc3NSdWxlLnB1c2goYCR7Y3NzUnVsZUlkMn0gJHtKU09OLnN0cmluZ2lmeSh0clN0eWxlQW5kQ2xzLnN0eWxlKX1gKTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICB0aGlzLmRncy5hcHBlbmRDc3NSdWxlcyhjc3NSdWxlKTtcclxuXHJcbiAgICAgICAgICAgICAgICAvLyB0aGlzLmRnLnJlbmRlckN1c3RvbVN0eWxlKHRyU3R5bGVBbmRDbHMsIHRoaXMuZm9vdGVyQ29udGFpbmVyLm5hdGl2ZUVsZW1lbnQsIGNzc1J1bGUpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5kZ3MucmVtb3ZlQ3NzUnVsZShbY3NzUnVsZUlELCBjc3NSdWxlSWQyXSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgfVxyXG5cclxuICAgIHNldEZpeGVkQ29sdW1uUG9zaXRpb24oaXNTaG93LCBzY3JvbGxMZWZ0KSB7XHJcbiAgICAgICAgdGhpcy5zaG93U2hhZG93Q2xzID0gaXNTaG93O1xyXG4gICAgICAgIGNvbnN0IG1ldGhvZCA9IGlzU2hvdyA/ICdhZGRDbGFzcycgOiAncmVtb3ZlQ2xhc3MnO1xyXG4gICAgICAgIHRoaXMucmVuZGVyW21ldGhvZF0odGhpcy5maXhlZFJpZ2h0Lm5hdGl2ZUVsZW1lbnQsIEZJWEVEX1JJR0hUX1NIQURPV19DTFMpO1xyXG5cclxuICAgICAgICBjb25zdCByZWFsV2lkdGggPSB0aGlzLmNvbHVtbnNHcm91cC5sZWZ0Rml4ZWRXaWR0aCArIHRoaXMuY29sdW1uc0dyb3VwLm5vcm1hbFdpZHRoICsgdGhpcy5yaWdodEZpeGVkQ29sdW1uV2lkdGg7XHJcbiAgICAgICAgY29uc3QgZ3JpZFdpZHRoID0gdGhpcy5kZy53aWR0aDtcclxuICAgICAgICBsZXQgbCA9IHRoaXMuZGcud2lkdGggLSAodGhpcy5kZy5zaG93Qm9yZGVyID8gMiA6IDApIC0gdGhpcy5yaWdodEZpeGVkQ29sdW1uV2lkdGg7XHJcbiAgICAgICAgaWYgKGdyaWRXaWR0aCA+IHJlYWxXaWR0aCkge1xyXG4gICAgICAgICAgICBsID0gdGhpcy5jb2x1bW5zR3JvdXAubGVmdEZpeGVkV2lkdGggKyB0aGlzLmNvbHVtbnNHcm91cC5ub3JtYWxXaWR0aDtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5yZW5kZXIuc2V0U3R5bGUodGhpcy5maXhlZFJpZ2h0Lm5hdGl2ZUVsZW1lbnQsICdsZWZ0JywgbCArICdweCcpO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==