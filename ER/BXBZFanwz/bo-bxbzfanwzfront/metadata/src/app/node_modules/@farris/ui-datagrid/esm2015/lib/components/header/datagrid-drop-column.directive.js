/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Directive, NgZone, Injector, Renderer2, ElementRef, Input } from '@angular/core';
import { dropHandlers, smoothDnD, constants } from '@farris/smooth-dnd';
import { DatagridComponent } from './../../datagrid.component';
import { DragDropColumnService } from './drag-drop-column.service';
smoothDnD.dropHandler = dropHandlers.reactDropHandler().handler;
smoothDnD.wrapChild = false;
const { wrapperClass, animationClass } = constants;
export class DropColumnDirective {
    /**
     * @param {?} ngzone
     * @param {?} injector
     * @param {?} render
     * @param {?} el
     * @param {?} dg
     * @param {?} dndSer
     */
    constructor(ngzone, injector, render, el, dg, dndSer) {
        this.ngzone = ngzone;
        this.injector = injector;
        this.render = render;
        this.el = el;
        this.dg = dg;
        this.dndSer = dndSer;
        this.options = {
            orientation: 'horizontal',
            behaviour: 'move',
            dragHandleSelector: '.group-field',
            dropPlaceholder: {
                className: 'drop-group-field',
            },
            getGhostParent: (/**
             * @return {?}
             */
            () => {
                return document.body;
            }),
            shouldAcceptDrop: (/**
             * @param {?} sourceContainerOptions
             * @param {?} payload
             * @return {?}
             */
            (sourceContainerOptions, payload) => {
                // console.log(sourceContainerOptions, payload);
                if (typeof payload === 'number') {
                    return true;
                }
                if (this.getGroupFields().length < 3) {
                    return payload.allowGrouping === undefined || payload.allowGrouping;
                }
                return false;
            }),
            getChildPayload: (/**
             * @param {?} index
             * @return {?}
             */
            (index) => {
                return index;
            }),
            // dragClass: 'drag-column-moving',
            onDropReady: (/**
             * @param {?} dropResult
             * @return {?}
             */
            (dropResult) => {
                this.ngzone.run((/**
                 * @return {?}
                 */
                () => {
                    this.onDropReady(dropResult);
                }));
            }),
            onDrop: (/**
             * @param {?} dropResult
             * @return {?}
             */
            (dropResult) => {
                this.ngzone.run((/**
                 * @return {?}
                 */
                () => {
                    this.onDrop(dropResult);
                }));
            }),
            onDragEnter: (/**
             * @return {?}
             */
            () => {
                this.ngzone.run((/**
                 * @return {?}
                 */
                () => {
                    this.onDragEnter();
                }));
            }),
            onDragStart: (/**
             * @param {?} info
             * @return {?}
             */
            (info) => {
                this.ngzone.run((/**
                 * @return {?}
                 */
                () => {
                    this.onDragStart(info);
                }));
            }),
            onDragEnd: (/**
             * @param {?} info
             * @return {?}
             */
            (info) => {
                this.ngzone.run((/**
                 * @return {?}
                 */
                () => {
                    this.onDragEnd(info);
                }));
            })
        };
    }
    /**
     * @return {?}
     */
    ngAfterViewInit() {
        this.initDnD();
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        this.disposeDnd();
    }
    /**
     * @private
     * @return {?}
     */
    disposeDnd() {
        if (this.container) {
            this.container.dispose();
            this.container = null;
        }
    }
    /**
     * @private
     * @return {?}
     */
    initDnD() {
        this.disposeDnd();
        if (this.dg.showRowGroupPanel) {
            this.container = smoothDnD(this.el.nativeElement, this.options);
        }
    }
    /**
     * @private
     * @param {?} dropResult
     * @return {?}
     */
    onDropReady(dropResult) {
        // console.log('DROP READY', dropResult);
    }
    /**
     * @private
     * @return {?}
     */
    getGroupFields() {
        return this.dg.groupField ? this.dg.groupField.split(',') : [];
    }
    /**
     * @private
     * @param {?} dropResult
     * @return {?}
     */
    onDrop(dropResult) {
        // console.log('DROP', dropResult);
        const { addedIndex, payload, removedIndex } = dropResult;
        if (addedIndex === null) {
            return;
        }
        /** @type {?} */
        const newGroupFields = this.getGroupFields();
        if (removedIndex === null) {
            if (!newGroupFields.some((/**
             * @param {?} v
             * @return {?}
             */
            (v) => v === payload.field))) {
                // newGroupFields.splice(0, 0, payload.field);
                newGroupFields.push(payload.field);
            }
        }
        else {
            this.dndSer.moveItem(newGroupFields, addedIndex, removedIndex);
        }
        this.dg.groupField = newGroupFields.join(',');
        // this.dg.toggleVisibleColumn([this.dg.groupField], false);
        if (this.dg.useControlPanel && this.dg.settingService) {
            this.dg.settingService.saveUserConfig(this.dg.id).subscribe((/**
             * @return {?}
             */
            () => {
                this.dg.columnsChanged();
            }));
        }
        else {
            this.dg.columnsChanged();
        }
        this.dg.groupFieldChange.emit({ newGroupField: this.dg.groupField, grid: this.dg });
    }
    /**
     * @private
     * @param {?} info
     * @return {?}
     */
    onDragStart(info) {
        // console.log('DRAG START', info);
    }
    /**
     * @private
     * @param {?} info
     * @return {?}
     */
    onDragEnd(info) {
        // console.log('DRAG END', info);
    }
    /**
     * @private
     * @return {?}
     */
    onDragEnter() {
        // console.log('DRAG ENTER');
    }
}
DropColumnDirective.decorators = [
    { type: Directive, args: [{
                selector: '[drop-column]',
                providers: [
                    DragDropColumnService
                ]
            },] }
];
/** @nocollapse */
DropColumnDirective.ctorParameters = () => [
    { type: NgZone },
    { type: Injector },
    { type: Renderer2 },
    { type: ElementRef },
    { type: DatagridComponent },
    { type: DragDropColumnService }
];
DropColumnDirective.propDecorators = {
    options: [{ type: Input }]
};
if (false) {
    /** @type {?} */
    DropColumnDirective.prototype.options;
    /**
     * @type {?}
     * @private
     */
    DropColumnDirective.prototype.container;
    /**
     * @type {?}
     * @private
     */
    DropColumnDirective.prototype.ngzone;
    /**
     * @type {?}
     * @private
     */
    DropColumnDirective.prototype.injector;
    /**
     * @type {?}
     * @private
     */
    DropColumnDirective.prototype.render;
    /**
     * @type {?}
     * @private
     */
    DropColumnDirective.prototype.el;
    /**
     * @type {?}
     * @private
     */
    DropColumnDirective.prototype.dg;
    /**
     * @type {?}
     * @private
     */
    DropColumnDirective.prototype.dndSer;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YWdyaWQtZHJvcC1jb2x1bW4uZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy91aS1kYXRhZ3JpZC8iLCJzb3VyY2VzIjpbImxpYi9jb21wb25lbnRzL2hlYWRlci9kYXRhZ3JpZC1kcm9wLWNvbHVtbi5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUNBLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFpQixLQUFLLEVBQWEsTUFBTSxlQUFlLENBQUM7QUFDcEgsT0FBTyxFQUFFLFlBQVksRUFBRSxTQUFTLEVBQWdDLFNBQVMsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3RHLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBRS9ELE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBR25FLFNBQVMsQ0FBQyxXQUFXLEdBQUcsWUFBWSxDQUFDLGdCQUFnQixFQUFFLENBQUMsT0FBTyxDQUFDO0FBQ2hFLFNBQVMsQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFDO01BQ3RCLEVBQUUsWUFBWSxFQUFFLGNBQWMsRUFBRSxHQUFHLFNBQVM7QUFRbEQsTUFBTSxPQUFPLG1CQUFtQjs7Ozs7Ozs7O0lBdUQ1QixZQUFvQixNQUFjLEVBQVUsUUFBa0IsRUFBVSxNQUFpQixFQUFVLEVBQWMsRUFDN0YsRUFBcUIsRUFBVSxNQUE2QjtRQUQ1RCxXQUFNLEdBQU4sTUFBTSxDQUFRO1FBQVUsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUFVLFdBQU0sR0FBTixNQUFNLENBQVc7UUFBVSxPQUFFLEdBQUYsRUFBRSxDQUFZO1FBQzdGLE9BQUUsR0FBRixFQUFFLENBQW1CO1FBQVUsV0FBTSxHQUFOLE1BQU0sQ0FBdUI7UUF2RHZFLFlBQU8sR0FBcUI7WUFDakMsV0FBVyxFQUFFLFlBQVk7WUFDekIsU0FBUyxFQUFFLE1BQU07WUFD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OUQsSUFBSSxDQUFDLEVBQUUsQ0FBQyxjQUFjLEVBQUUsQ0FBQztZQUM3QixDQUFDLEVBQUMsQ0FBQztTQUNOO2FBQU07WUFDSCxJQUFJLENBQUMsRUFBRSxDQUFDLGNBQWMsRUFBRSxDQUFDO1NBQzVCO1FBRUQsSUFBSSxDQUFDLEVBQUUsQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsRUFBRSxhQUFhLEVBQUUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxVQUFVLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ3hGLENBQUM7Ozs7OztJQUVPLFdBQVcsQ0FBQyxJQUFJO1FBQ3BCLG1DQUFtQztJQUN2QyxDQUFDOzs7Ozs7SUFFTyxTQUFTLENBQUMsSUFBSTtRQUNsQixpQ0FBaUM7SUFDckMsQ0FBQzs7Ozs7SUFHTyxXQUFXO1FBQ2YsNkJBQTZCO0lBQ2pDLENBQUM7OztZQTdJSixTQUFTLFNBQUM7Z0JBQ1AsUUFBUSxFQUFFLGVBQWU7Z0JBQ3pCLFNBQVMsRUFBRTtvQkFDUCxxQkFBcUI7aUJBQ3hCO2FBQ0o7Ozs7WUFoQm1CLE1BQU07WUFBRSxRQUFRO1lBQUUsU0FBUztZQUFFLFVBQVU7WUFFbEQsaUJBQWlCO1lBRWpCLHFCQUFxQjs7O3NCQWN6QixLQUFLOzs7O0lBQU4sc0NBbURFOzs7OztJQUVGLHdDQUF1Qjs7Ozs7SUFDWCxxQ0FBc0I7Ozs7O0lBQUUsdUNBQTBCOzs7OztJQUFFLHFDQUF5Qjs7Ozs7SUFBRSxpQ0FBc0I7Ozs7O0lBQ3JHLGlDQUE2Qjs7Ozs7SUFBRSxxQ0FBcUMiLCJzb3VyY2VzQ29udGVudCI6WyJcclxuaW1wb3J0IHsgRGlyZWN0aXZlLCBOZ1pvbmUsIEluamVjdG9yLCBSZW5kZXJlcjIsIEVsZW1lbnRSZWYsIEFmdGVyVmlld0luaXQsIElucHV0LCBPbkRlc3Ryb3kgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgZHJvcEhhbmRsZXJzLCBzbW9vdGhEbkQsIERyb3BSZXN1bHQsIENvbnRhaW5lck9wdGlvbnMsIGNvbnN0YW50cyB9IGZyb20gJ0BmYXJyaXMvc21vb3RoLWRuZCc7XHJcbmltcG9ydCB7IERhdGFncmlkQ29tcG9uZW50IH0gZnJvbSAnLi8uLi8uLi9kYXRhZ3JpZC5jb21wb25lbnQnO1xyXG5pbXBvcnQgeyBEcmFnU3RhcnRFbmRJbmZvIH0gZnJvbSAnLi9kYXRhZ3JpZC1kcmFnLWNvbHVtbi5kaXJlY3RpdmUnO1xyXG5pbXBvcnQgeyBEcmFnRHJvcENvbHVtblNlcnZpY2UgfSBmcm9tICcuL2RyYWctZHJvcC1jb2x1bW4uc2VydmljZSc7XHJcblxyXG5cclxuc21vb3RoRG5ELmRyb3BIYW5kbGVyID0gZHJvcEhhbmRsZXJzLnJlYWN0RHJvcEhhbmRsZXIoKS5oYW5kbGVyO1xyXG5zbW9vdGhEbkQud3JhcENoaWxkID0gZmFsc2U7XHJcbmNvbnN0IHsgd3JhcHBlckNsYXNzLCBhbmltYXRpb25DbGFzcyB9ID0gY29uc3RhbnRzO1xyXG5cclxuQERpcmVjdGl2ZSh7XHJcbiAgICBzZWxlY3RvcjogJ1tkcm9wLWNvbHVtbl0nLFxyXG4gICAgcHJvdmlkZXJzOiBbXHJcbiAgICAgICAgRHJhZ0Ryb3BDb2x1bW5TZXJ2aWNlXHJcbiAgICBdXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBEcm9wQ29sdW1uRGlyZWN0aXZlIGltcGxlbWVudHMgQWZ0ZXJWaWV3SW5pdCwgT25EZXN0cm95IHtcclxuICAgIEBJbnB1dCgpIG9wdGlvbnM6IENvbnRhaW5lck9wdGlvbnMgPSB7XHJcbiAgICAgICAgb3JpZW50YXRpb246ICdob3Jpem9udGFsJyxcclxuICAgICAgICBiZWhhdmlvdXI6ICdtb3ZlJyxcclxuICAgICAgICBkcmFnSGFuZGxlU2VsZWN0b3I6ICcuZ3JvdXAtZmllbGQnLFxyXG4gICAgICAgIGRyb3BQbGFjZWhvbGRlcjoge1xyXG4gICAgICAgICAgICBjbGFzc05hbWU6ICdkcm9wLWdyb3VwLWZpZWxkJyxcclxuICAgICAgICB9LFxyXG4gICAgICAgIGdldEdob3N0UGFyZW50OiAoKSA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiBkb2N1bWVudC5ib2R5O1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgc2hvdWxkQWNjZXB0RHJvcDogKHNvdXJjZUNvbnRhaW5lck9wdGlvbnMsIHBheWxvYWQpID0+IHtcclxuICAgICAgICAgICAgLy8gY29uc29sZS5sb2coc291cmNlQ29udGFpbmVyT3B0aW9ucywgcGF5bG9hZCk7XHJcblxyXG4gICAgICAgICAgICBpZiAodHlwZW9mIHBheWxvYWQgPT09ICdudW1iZXInKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKHRoaXMuZ2V0R3JvdXBGaWVsZHMoKS5sZW5ndGggPCAzKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcGF5bG9hZC5hbGxvd0dyb3VwaW5nID09PSB1bmRlZmluZWQgfHwgcGF5bG9hZC5hbGxvd0dyb3VwaW5nO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGdldENoaWxkUGF5bG9hZDogKGluZGV4KSA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiBpbmRleDtcclxuICAgICAgICB9LFxyXG4gICAgICAgIC8vIGRyYWdDbGFzczogJ2RyYWctY29sdW1uLW1vdmluZycsXHJcbiAgICAgICAgb25Ecm9wUmVhZHk6IChkcm9wUmVzdWx0OiBEcm9wUmVzdWx0KSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMubmd6b25lLnJ1bigoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLm9uRHJvcFJlYWR5KGRyb3BSZXN1bHQpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIG9uRHJvcDogKGRyb3BSZXN1bHQ6IERyb3BSZXN1bHQpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5uZ3pvbmUucnVuKCgpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMub25Ecm9wKGRyb3BSZXN1bHQpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIG9uRHJhZ0VudGVyOiAoKSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMubmd6b25lLnJ1bigoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLm9uRHJhZ0VudGVyKCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgb25EcmFnU3RhcnQ6IChpbmZvOiBEcmFnU3RhcnRFbmRJbmZvKSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMubmd6b25lLnJ1bigoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLm9uRHJhZ1N0YXJ0KGluZm8pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIG9uRHJhZ0VuZDogKGluZm86IERyYWdTdGFydEVuZEluZm8pID0+IHtcclxuICAgICAgICAgICAgdGhpcy5uZ3pvbmUucnVuKCgpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMub25EcmFnRW5kKGluZm8pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgIHByaXZhdGUgY29udGFpbmVyOiBhbnk7XHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIG5nem9uZTogTmdab25lLCBwcml2YXRlIGluamVjdG9yOiBJbmplY3RvciwgcHJpdmF0ZSByZW5kZXI6IFJlbmRlcmVyMiwgcHJpdmF0ZSBlbDogRWxlbWVudFJlZixcclxuICAgICAgICAgICAgICAgIHByaXZhdGUgZGc6IERhdGFncmlkQ29tcG9uZW50LCBwcml2YXRlIGRuZFNlcjogRHJhZ0Ryb3BDb2x1bW5TZXJ2aWNlKSB7IH1cclxuXHJcbiAgICBuZ0FmdGVyVmlld0luaXQoKSB7XHJcbiAgICAgICAgdGhpcy5pbml0RG5EKCk7XHJcbiAgICB9XHJcblxyXG4gICAgbmdPbkRlc3Ryb3koKSB7XHJcbiAgICAgICAgdGhpcy5kaXNwb3NlRG5kKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBkaXNwb3NlRG5kKCkge1xyXG4gICAgICAgIGlmICh0aGlzLmNvbnRhaW5lcikge1xyXG4gICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5kaXNwb3NlKCk7XHJcbiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyID0gbnVsbDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBpbml0RG5EKCkge1xyXG4gICAgICAgIHRoaXMuZGlzcG9zZURuZCgpO1xyXG4gICAgICAgIGlmICh0aGlzLmRnLnNob3dSb3dHcm91cFBhbmVsKSB7XHJcbiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyID0gc21vb3RoRG5EKFxyXG4gICAgICAgICAgICAgICAgdGhpcy5lbC5uYXRpdmVFbGVtZW50LFxyXG4gICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgb25Ecm9wUmVhZHkoZHJvcFJlc3VsdCkge1xyXG4gICAgICAgIC8vIGNvbnNvbGUubG9nKCdEUk9QIFJFQURZJywgZHJvcFJlc3VsdCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXRHcm91cEZpZWxkcygpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5kZy5ncm91cEZpZWxkID8gdGhpcy5kZy5ncm91cEZpZWxkLnNwbGl0KCcsJykgOiBbXTtcclxuICAgIH1cclxuXHJcblxyXG4gICAgcHJpdmF0ZSBvbkRyb3AoZHJvcFJlc3VsdDogRHJvcFJlc3VsdCkge1xyXG4gICAgICAgIC8vIGNvbnNvbGUubG9nKCdEUk9QJywgZHJvcFJlc3VsdCk7XHJcbiAgICAgICAgY29uc3QgeyBhZGRlZEluZGV4LCBwYXlsb2FkLCByZW1vdmVkSW5kZXggfSA9IGRyb3BSZXN1bHQ7XHJcblxyXG4gICAgICAgIGlmIChhZGRlZEluZGV4ID09PSBudWxsKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IG5ld0dyb3VwRmllbGRzID0gdGhpcy5nZXRHcm91cEZpZWxkcygpO1xyXG5cclxuICAgICAgICBpZiAocmVtb3ZlZEluZGV4ID09PSBudWxsKSB7XHJcbiAgICAgICAgICAgIGlmICghbmV3R3JvdXBGaWVsZHMuc29tZSgodikgPT4gdiA9PT0gcGF5bG9hZC5maWVsZCkpIHtcclxuICAgICAgICAgICAgICAgIC8vIG5ld0dyb3VwRmllbGRzLnNwbGljZSgwLCAwLCBwYXlsb2FkLmZpZWxkKTtcclxuICAgICAgICAgICAgICAgIG5ld0dyb3VwRmllbGRzLnB1c2gocGF5bG9hZC5maWVsZCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLmRuZFNlci5tb3ZlSXRlbShuZXdHcm91cEZpZWxkcywgYWRkZWRJbmRleCwgcmVtb3ZlZEluZGV4KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5kZy5ncm91cEZpZWxkID0gbmV3R3JvdXBGaWVsZHMuam9pbignLCcpO1xyXG4gICAgICAgIC8vIHRoaXMuZGcudG9nZ2xlVmlzaWJsZUNvbHVtbihbdGhpcy5kZy5ncm91cEZpZWxkXSwgZmFsc2UpO1xyXG5cclxuICAgICAgICBpZiAodGhpcy5kZy51c2VDb250cm9sUGFuZWwgJiYgdGhpcy5kZy5zZXR0aW5nU2VydmljZSkge1xyXG4gICAgICAgICAgICB0aGlzLmRnLnNldHRpbmdTZXJ2aWNlLnNhdmVVc2VyQ29uZmlnKHRoaXMuZGcuaWQpLnN1YnNjcmliZSggKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5kZy5jb2x1bW5zQ2hhbmdlZCgpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLmRnLmNvbHVtbnNDaGFuZ2VkKCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLmRnLmdyb3VwRmllbGRDaGFuZ2UuZW1pdCh7IG5ld0dyb3VwRmllbGQ6IHRoaXMuZGcuZ3JvdXBGaWVsZCwgZ3JpZDogdGhpcy5kZyB9KTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIG9uRHJhZ1N0YXJ0KGluZm8pIHtcclxuICAgICAgICAvLyBjb25zb2xlLmxvZygnRFJBRyBTVEFSVCcsIGluZm8pO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgb25EcmFnRW5kKGluZm8pIHtcclxuICAgICAgICAvLyBjb25zb2xlLmxvZygnRFJBRyBFTkQnLCBpbmZvKTtcclxuICAgIH1cclxuXHJcblxyXG4gICAgcHJpdmF0ZSBvbkRyYWdFbnRlcigpIHtcclxuICAgICAgICAvLyBjb25zb2xlLmxvZygnRFJBRyBFTlRFUicpO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==