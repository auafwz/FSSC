/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable, NgZone } from '@angular/core';
import { CommonUtils, RuntimeStateService } from '@farris/ui-common';
import { FilterRelation, Compare } from '@farris/ui-common/types';
import { cloneDeep } from 'lodash-es';
export class LookupUtils {
    /**
     * @param {?} utils
     * @param {?} rts
     * @param {?} ngZone
     */
    constructor(utils, rts, ngZone) {
        this.utils = utils;
        this.rts = rts;
        this.ngZone = ngZone;
    }
    /**
     * @param {?} lookupIns
     * @return {?}
     */
    setActiveLookupInstance(lookupIns) {
        if (this.rts) {
            this.rts.setLookupInstance(lookupIns);
        }
    }
    /**
     * @return {?}
     */
    pendingStart() {
        if (this.rts) {
            this.rts.updateFormState({
                lookup: {
                    pending: true
                }
            });
            // 禁用页面的所有鼠标事件
            document.body.style['pointer-events'] = 'none';
        }
    }
    /**
     * @return {?}
     */
    pendingEnd() {
        if (this.rts) {
            this.rts.updateFormState({
                lookup: {
                    pending: false
                }
            });
            // 激活鼠标事件
            document.body.style['pointer-events'] = '';
        }
    }
    /**
     * @private
     * @param {?} field
     * @param {?} value
     * @return {?}
     */
    createFilterCondition(field, value) {
        return {
            filterField: field,
            value,
            lbracket: '',
            rbracket: '',
            relation: FilterRelation.Or,
            compare: Compare.Like
        };
    }
    /**
     * @param {?} condition
     * @param {?} fields
     * @param {?} searchData
     * @return {?}
     */
    mergeCondition(condition, fields, searchData) {
        if (!condition) {
            condition = {
                pagination: {
                    pageIndex: 1,
                    pageSize: 20
                },
                filterConditions: [],
                sortConditions: []
            };
        }
        else {
            condition = cloneDeep(condition);
        }
        const { field = '*', value = '' } = Object.assign({}, searchData);
        if (value) {
            if (field === '*') {
                if (fields && fields.length) {
                    /** @type {?} */
                    const searchConditions = fields.map((/**
                     * @param {?} f
                     * @return {?}
                     */
                    (f) => {
                        return this.createFilterCondition(f, value);
                    }));
                    if (searchConditions.length) {
                        searchConditions[0].lbracket = '(';
                        /** @type {?} */
                        const lastSearchConditions = searchConditions[searchConditions.length - 1];
                        lastSearchConditions.rbracket = ')';
                        lastSearchConditions.relation = FilterRelation.Empty;
                    }
                    if (condition.filterConditions && condition.filterConditions.length) {
                        condition.filterConditions[condition.filterConditions.length - 1].relation = FilterRelation.And;
                        condition.filterConditions = condition.filterConditions.concat(searchConditions);
                    }
                    else {
                        condition.filterConditions = searchConditions;
                    }
                }
            }
            else {
                /** @type {?} */
                const searchCondition = this.createFilterCondition(field, value);
                searchCondition.relation = FilterRelation.Empty;
                if (condition.filterConditions && condition.filterConditions.length) {
                    condition.filterConditions[condition.filterConditions.length - 1].relation = FilterRelation.And;
                    condition.filterConditions.push(searchCondition);
                }
                else {
                    condition.filterConditions = [searchCondition];
                }
            }
        }
        return condition;
    }
    /**
     * @private
     * @param {?} n
     * @return {?}
     */
    canSelectable(n) {
        if (n.hasOwnProperty('farris_selectable')) {
            return !!n['farris_selectable'];
        }
        return true;
    }
    /**
     * 将数据转树形结构
     * @param {?} data
     * @param {?} parentId
     * @param {?=} parentIdField
     * @param {?=} idField
     * @return {?}
     */
    makeTreeWithParentID(data, parentId, parentIdField = 'parentId', idField = 'id') {
        /** @type {?} */
        const nodes = new Map();
        /** @type {?} */
        const result = [];
        /** @type {?} */
        const unattached = [];
        data.forEach((/**
         * @param {?} t
         * @return {?}
         */
        t => {
            /** @type {?} */
            const node = {
                data: t,
                children: [],
                selectable: this.canSelectable(t),
                parent: null,
                parents: []
            };
            /** @type {?} */
            const id = t[idField];
            nodes.set(id, node);
            /** @type {?} */
            const PID = this.utils.getValue(parentIdField, t);
            if (PID === parentId) {
                result.push(node);
            }
            else {
                /** @type {?} */
                const parent = nodes.get(PID);
                if (parent) {
                    node.parent = PID;
                    node.parents = [...parent.parents, PID];
                    parent.children.push(node);
                }
                else {
                    unattached.push(node);
                }
            }
        }));
        unattached.forEach((/**
         * @param {?} n
         * @return {?}
         */
        n => {
            /** @type {?} */
            const pid = this.utils.getValue(parentIdField, n.data);
            /** @type {?} */
            const parent = nodes.get(pid);
            if (parent) {
                n.parent = pid;
                n.parents = [...parent.parents, pid];
                parent.children.push(n);
            }
        }));
        return result;
    }
    /**
     * @param {?} data
     * @param {?} treeInfo
     * @return {?}
     */
    makeTree(data, treeInfo) {
        /** @type {?} */
        const treeInfoField = treeInfo.dataField;
        /** @type {?} */
        const layerField = treeInfo.layerField;
        /** @type {?} */
        const pathField = treeInfo.pathField;
        /** @type {?} */
        const nodes = new Map();
        /** @type {?} */
        const result = [];
        /** @type {?} */
        const unattached = [];
        data.forEach((/**
         * @param {?} t
         * @return {?}
         */
        t => {
            /** @type {?} */
            const node = {
                data: t,
                children: [],
                selectable: this.canSelectable(t)
            };
            /** @type {?} */
            const pathCode = t[treeInfoField][pathField];
            nodes.set(pathCode, node);
            if (t[treeInfoField][layerField] === 1) {
                result.push(node);
            }
            else {
                /** @type {?} */
                const parentPathCode = pathCode.substr(0, pathCode.length - 4);
                /** @type {?} */
                const parent = nodes.get(parentPathCode);
                if (parent) {
                    parent.children.push(node);
                }
                else {
                    unattached.push(node);
                }
            }
        }));
        unattached.forEach((/**
         * @param {?} n
         * @return {?}
         */
        n => {
            /** @type {?} */
            const pathCode = n.data[treeInfoField][pathField];
            /** @type {?} */
            const parent = nodes.get(pathCode.substr(0, pathCode.length - 4));
            if (parent) {
                parent.children.push(n);
            }
        }));
        return result;
    }
}
LookupUtils.decorators = [
    { type: Injectable }
];
/** @nocollapse */
LookupUtils.ctorParameters = () => [
    { type: CommonUtils },
    { type: RuntimeStateService },
    { type: NgZone }
];
if (false) {
    /**
     * @type {?}
     * @private
     */
    LookupUtils.prototype.utils;
    /**
     * @type {?}
     * @private
     */
    LookupUtils.prototype.rts;
    /**
     * @type {?}
     * @private
     */
    LookupUtils.prototype.ngZone;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbHMuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL3VpLWxvb2t1cC8iLCJzb3VyY2VzIjpbImxpYi91dGlscy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDbkQsT0FBTyxFQUFFLFdBQVcsRUFBRSxtQkFBbUIsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ3JFLE9BQU8sRUFBRSxjQUFjLEVBQW1CLE9BQU8sRUFBZ0IsTUFBTSx5QkFBeUIsQ0FBQztBQUNqRyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBSXRDLE1BQU0sT0FBTyxXQUFXOzs7Ozs7SUFFcEIsWUFBb0IsS0FBa0IsRUFBVSxHQUF3QixFQUFVLE1BQWM7UUFBNUUsVUFBSyxHQUFMLEtBQUssQ0FBYTtRQUFVLFFBQUcsR0FBSCxHQUFHLENBQXFCO1FBQVUsV0FBTSxHQUFOLE1BQU0sQ0FBUTtJQUFJLENBQUM7Ozs7O0lBRXJHLHVCQUF1QixDQUFDLFNBQWM7UUFDbEMsSUFBSSxJQUFJLENBQUMsR0FBRyxFQUFFO1lBQ1YsSUFBSSxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsQ0FBQyxTQUFTLENBQUMsQ0FBQztTQUN6QztJQUNMLENBQUM7Ozs7SUFFRCxZQUFZO1FBQ1IsSUFBSSxJQUFJLENBQUMsR0FBRyxFQUFFO1lBQ1YsSUFBSSxDQUFDLEdBQUcsQ0FBQyxlQUFlLENBQUM7Z0JBQ3JCLE1BQU0sRUFBRTtvQkFDSixPQUFPLEVBQUUsSUFBSTtpQkFDaEI7YUFDSixDQUFDLENBQUM7WUFFSCxjQUFjO1lBQ2QsUUFBUSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxNQUFNLENBQUM7U0FDbEQ7SUFDTCxDQUFDOzs7O0lBRUQsVUFBVTtRQUNOLElBQUksSUFBSSxDQUFDLEdBQUcsRUFBRTtZQUNWLElBQUksQ0FBQyxHQUFHLENBQUMsZUFB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QUNSLE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO2FBQzNCO1FBQ0wsQ0FBQyxFQUFDLENBQUM7UUFFSCxPQUFPLE1BQU0sQ0FBQztJQUNsQixDQUFDOzs7WUEvTEosVUFBVTs7OztZQUxGLFdBQVc7WUFBRSxtQkFBbUI7WUFEcEIsTUFBTTs7Ozs7OztJQVNYLDRCQUEwQjs7Ozs7SUFBRSwwQkFBZ0M7Ozs7O0lBQUUsNkJBQXNCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgTmdab25lIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IENvbW1vblV0aWxzLCBSdW50aW1lU3RhdGVTZXJ2aWNlIH0gZnJvbSAnQGZhcnJpcy91aS1jb21tb24nO1xyXG5pbXBvcnQgeyBGaWx0ZXJSZWxhdGlvbiwgRmlsdGVyQ29uZGl0aW9uLCBDb21wYXJlLCBFbnRpdHlGaWx0ZXIgfSBmcm9tICdAZmFycmlzL3VpLWNvbW1vbi90eXBlcyc7XHJcbmltcG9ydCB7IGNsb25lRGVlcCB9IGZyb20gJ2xvZGFzaC1lcyc7XHJcbmltcG9ydCB7IFRyZWVJbmZvIH0gZnJvbSAnLi9sb29rdXAtZ3JpZC1vcHRpb25zJztcclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIExvb2t1cFV0aWxzIHtcclxuXHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIHV0aWxzOiBDb21tb25VdGlscywgcHJpdmF0ZSBydHM6IFJ1bnRpbWVTdGF0ZVNlcnZpY2UsIHByaXZhdGUgbmdab25lOiBOZ1pvbmUpIHsgfVxyXG5cclxuICAgIHNldEFjdGl2ZUxvb2t1cEluc3RhbmNlKGxvb2t1cEluczogYW55KSB7XHJcbiAgICAgICAgaWYgKHRoaXMucnRzKSB7XHJcbiAgICAgICAgICAgIHRoaXMucnRzLnNldExvb2t1cEluc3RhbmNlKGxvb2t1cElucyk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHBlbmRpbmdTdGFydCgpIHtcclxuICAgICAgICBpZiAodGhpcy5ydHMpIHtcclxuICAgICAgICAgICAgdGhpcy5ydHMudXBkYXRlRm9ybVN0YXRlKHtcclxuICAgICAgICAgICAgICAgIGxvb2t1cDoge1xyXG4gICAgICAgICAgICAgICAgICAgIHBlbmRpbmc6IHRydWVcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAvLyDnpoHnlKjpobXpnaLnmoTmiYDmnInpvKDmoIfkuovku7ZcclxuICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5zdHlsZVsncG9pbnRlci1ldmVudHMnXSA9ICdub25lJztcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcGVuZGluZ0VuZCgpIHtcclxuICAgICAgICBpZiAodGhpcy5ydHMpIHtcclxuICAgICAgICAgICAgdGhpcy5ydHMudXBkYXRlRm9ybVN0YXRlKHtcclxuICAgICAgICAgICAgICAgIGxvb2t1cDoge1xyXG4gICAgICAgICAgICAgICAgICAgIHBlbmRpbmc6IGZhbHNlXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgLy8g5r+A5rS76byg5qCH5LqL5Lu2XHJcbiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuc3R5bGVbJ3BvaW50ZXItZXZlbnRzJ10gPSAnJztcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG5cclxuICAgIHByaXZhdGUgY3JlYXRlRmlsdGVyQ29uZGl0aW9uKGZpZWxkOiBzdHJpbmcsIHZhbHVlOiBzdHJpbmcpIHtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBmaWx0ZXJGaWVsZDogZmllbGQsXHJcbiAgICAgICAgICAgIHZhbHVlLFxyXG4gICAgICAgICAgICBsYnJhY2tldDogJycsXHJcbiAgICAgICAgICAgIHJicmFja2V0OiAnJyxcclxuICAgICAgICAgICAgcmVsYXRpb246IEZpbHRlclJlbGF0aW9uLk9yLFxyXG4gICAgICAgICAgICBjb21wYXJlOiBDb21wYXJlLkxpa2VcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIG1lcmdlQ29uZGl0aW9uKGNvbmRpdGlvbjogRW50aXR5RmlsdGVyLCBmaWVsZHM6IHN0cmluZ1tdLCBzZWFyY2hEYXRhOiB7IGZpZWxkOiBzdHJpbmcsIHZhbHVlOiBzdHJpbmcgfSkge1xyXG4gICAgICAgIGlmICghY29uZGl0aW9uKSB7XHJcbiAgICAgICAgICAgIGNvbmRpdGlvbiA9IHtcclxuICAgICAgICAgICAgICAgIHBhZ2luYXRpb246IHtcclxuICAgICAgICAgICAgICAgICAgICBwYWdlSW5kZXg6IDEsXHJcbiAgICAgICAgICAgICAgICAgICAgcGFnZVNpemU6IDIwXHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgZmlsdGVyQ29uZGl0aW9uczogW10sXHJcbiAgICAgICAgICAgICAgICBzb3J0Q29uZGl0aW9uczogW11cclxuICAgICAgICAgICAgfTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBjb25kaXRpb24gPSBjbG9uZURlZXAoY29uZGl0aW9uKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IHsgZmllbGQgPSAnKicsIHZhbHVlID0gJycgfSA9IHsgLi4uc2VhcmNoRGF0YSB9O1xyXG5cclxuICAgICAgICBpZiAodmFsdWUpIHtcclxuICAgICAgICAgICAgaWYgKGZpZWxkID09PSAnKicpIHtcclxuICAgICAgICAgICAgICAgIGlmIChmaWVsZHMgJiYgZmllbGRzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHNlYXJjaENvbmRpdGlvbnM6IEZpbHRlckNvbmRpdGlvbltdID0gZmllbGRzLm1hcCgoZjogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmNyZWF0ZUZpbHRlckNvbmRpdGlvbihmLCB2YWx1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChzZWFyY2hDb25kaXRpb25zLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzZWFyY2hDb25kaXRpb25zWzBdLmxicmFja2V0ID0gJygnO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBsYXN0U2VhcmNoQ29uZGl0aW9ucyA9IHNlYXJjaENvbmRpdGlvbnNbc2VhcmNoQ29uZGl0aW9ucy5sZW5ndGggLSAxXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGFzdFNlYXJjaENvbmRpdGlvbnMucmJyYWNrZXQgPSAnKSc7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RTZWFyY2hDb25kaXRpb25zLnJlbGF0aW9uID0gRmlsdGVyUmVsYXRpb24uRW1wdHk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICBpZiAoY29uZGl0aW9uLmZpbHRlckNvbmRpdGlvbnMgJiYgY29uZGl0aW9uLmZpbHRlckNvbmRpdGlvbnMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbmRpdGlvbi5maWx0ZXJDb25kaXRpb25zW2NvbmRpdGlvbi5maWx0ZXJDb25kaXRpb25zLmxlbmd0aCAtIDFdLnJlbGF0aW9uID0gRmlsdGVyUmVsYXRpb24uQW5kO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25kaXRpb24uZmlsdGVyQ29uZGl0aW9ucyA9IGNvbmRpdGlvbi5maWx0ZXJDb25kaXRpb25zLmNvbmNhdChzZWFyY2hDb25kaXRpb25zKTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25kaXRpb24uZmlsdGVyQ29uZGl0aW9ucyA9IHNlYXJjaENvbmRpdGlvbnM7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgc2VhcmNoQ29uZGl0aW9uID0gdGhpcy5jcmVhdGVGaWx0ZXJDb25kaXRpb24oZmllbGQsIHZhbHVlKTtcclxuICAgICAgICAgICAgICAgIHNlYXJjaENvbmRpdGlvbi5yZWxhdGlvbiA9IEZpbHRlclJlbGF0aW9uLkVtcHR5O1xyXG4gICAgICAgICAgICAgICAgaWYgKGNvbmRpdGlvbi5maWx0ZXJDb25kaXRpb25zICYmIGNvbmRpdGlvbi5maWx0ZXJDb25kaXRpb25zLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbmRpdGlvbi5maWx0ZXJDb25kaXRpb25zW2NvbmRpdGlvbi5maWx0ZXJDb25kaXRpb25zLmxlbmd0aCAtIDFdLnJlbGF0aW9uID0gRmlsdGVyUmVsYXRpb24uQW5kO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbmRpdGlvbi5maWx0ZXJDb25kaXRpb25zLnB1c2goc2VhcmNoQ29uZGl0aW9uKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uZGl0aW9uLmZpbHRlckNvbmRpdGlvbnMgPSBbc2VhcmNoQ29uZGl0aW9uXTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIGNvbmRpdGlvbjtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGNhblNlbGVjdGFibGUobjogYW55KSB7XHJcbiAgICAgICAgaWYgKG4uaGFzT3duUHJvcGVydHkoJ2ZhcnJpc19zZWxlY3RhYmxlJykpIHtcclxuICAgICAgICAgICAgcmV0dXJuICEhblsnZmFycmlzX3NlbGVjdGFibGUnXTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqIOWwhuaVsOaNrui9rOagkeW9oue7k+aehCAqL1xyXG4gICAgbWFrZVRyZWVXaXRoUGFyZW50SUQoZGF0YTogYW55W10sIHBhcmVudElkLCBwYXJlbnRJZEZpZWxkID0gJ3BhcmVudElkJywgaWRGaWVsZCA9ICdpZCcpIHtcclxuICAgICAgICBjb25zdCBub2RlcyA9IG5ldyBNYXA8c3RyaW5nLCBhbnk+KCk7XHJcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gW107XHJcbiAgICAgICAgY29uc3QgdW5hdHRhY2hlZCA9IFtdO1xyXG4gICAgICAgIGRhdGEuZm9yRWFjaCh0ID0+IHtcclxuICAgICAgICAgICAgY29uc3Qgbm9kZSA9IHtcclxuICAgICAgICAgICAgICAgIGRhdGE6IHQsXHJcbiAgICAgICAgICAgICAgICBjaGlsZHJlbjogW10sXHJcbiAgICAgICAgICAgICAgICBzZWxlY3RhYmxlOiB0aGlzLmNhblNlbGVjdGFibGUodCksXHJcbiAgICAgICAgICAgICAgICBwYXJlbnQ6IG51bGwsXHJcbiAgICAgICAgICAgICAgICBwYXJlbnRzOiBbXVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICBjb25zdCBpZCA9IHRbaWRGaWVsZF07XHJcbiAgICAgICAgICAgIG5vZGVzLnNldChpZCwgbm9kZSk7XHJcbiAgICAgICAgICAgIGNvbnN0IFBJRCA9IHRoaXMudXRpbHMuZ2V0VmFsdWUocGFyZW50SWRGaWVsZCwgdCk7XHJcbiAgICAgICAgICAgIGlmIChQSUQgPT09IHBhcmVudElkKSB7XHJcbiAgICAgICAgICAgICAgICByZXN1bHQucHVzaChub2RlKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHBhcmVudCA9IG5vZGVzLmdldChQSUQpO1xyXG4gICAgICAgICAgICAgICAgaWYgKHBhcmVudCkge1xyXG4gICAgICAgICAgICAgICAgICAgIG5vZGUucGFyZW50ID0gUElEO1xyXG4gICAgICAgICAgICAgICAgICAgIG5vZGUucGFyZW50cyA9IFsuLi5wYXJlbnQucGFyZW50cywgUElEXTtcclxuICAgICAgICAgICAgICAgICAgICBwYXJlbnQuY2hpbGRyZW4ucHVzaChub2RlKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdW5hdHRhY2hlZC5wdXNoKG5vZGUpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHVuYXR0YWNoZWQuZm9yRWFjaChuID0+IHtcclxuICAgICAgICAgICAgY29uc3QgcGlkID0gdGhpcy51dGlscy5nZXRWYWx1ZShwYXJlbnRJZEZpZWxkLCBuLmRhdGEpO1xyXG4gICAgICAgICAgICBjb25zdCBwYXJlbnQgPSBub2Rlcy5nZXQocGlkKTtcclxuICAgICAgICAgICAgaWYgKHBhcmVudCkge1xyXG4gICAgICAgICAgICAgICAgbi5wYXJlbnQgPSBwaWQ7XHJcbiAgICAgICAgICAgICAgICBuLnBhcmVudHMgPSBbLi4ucGFyZW50LnBhcmVudHMsIHBpZF07XHJcbiAgICAgICAgICAgICAgICBwYXJlbnQuY2hpbGRyZW4ucHVzaChuKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgfVxyXG5cclxuICAgIG1ha2VUcmVlKGRhdGEsIHRyZWVJbmZvOiBUcmVlSW5mbykge1xyXG4gICAgICAgIGNvbnN0IHRyZWVJbmZvRmllbGQgPSB0cmVlSW5mby5kYXRhRmllbGQ7XHJcbiAgICAgICAgY29uc3QgbGF5ZXJGaWVsZCA9IHRyZWVJbmZvLmxheWVyRmllbGQ7XHJcbiAgICAgICAgY29uc3QgcGF0aEZpZWxkID0gdHJlZUluZm8ucGF0aEZpZWxkO1xyXG5cclxuICAgICAgICBjb25zdCBub2RlcyA9IG5ldyBNYXA8c3RyaW5nLCBhbnk+KCk7XHJcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gW107XHJcbiAgICAgICAgY29uc3QgdW5hdHRhY2hlZCA9IFtdO1xyXG4gICAgICAgIGRhdGEuZm9yRWFjaCh0ID0+IHtcclxuICAgICAgICAgICAgY29uc3Qgbm9kZSA9IHtcclxuICAgICAgICAgICAgICAgIGRhdGE6IHQsXHJcbiAgICAgICAgICAgICAgICBjaGlsZHJlbjogW10sXHJcbiAgICAgICAgICAgICAgICBzZWxlY3RhYmxlOiB0aGlzLmNhblNlbGVjdGFibGUodClcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgY29uc3QgcGF0aENvZGUgPSB0W3RyZWVJbmZvRmllbGRdW3BhdGhGaWVsZF07XHJcbiAgICAgICAgICAgIG5vZGVzLnNldChwYXRoQ29kZSwgbm9kZSk7XHJcblxyXG4gICAgICAgICAgICBpZiAodFt0cmVlSW5mb0ZpZWxkXVtsYXllckZpZWxkXSA9PT0gMSkge1xyXG4gICAgICAgICAgICAgICAgcmVzdWx0LnB1c2gobm9kZSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBwYXJlbnRQYXRoQ29kZSA9IHBhdGhDb2RlLnN1YnN0cigwLCBwYXRoQ29kZS5sZW5ndGggLSA0KTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHBhcmVudCA9IG5vZGVzLmdldChwYXJlbnRQYXRoQ29kZSk7XHJcbiAgICAgICAgICAgICAgICBpZiAocGFyZW50KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcGFyZW50LmNoaWxkcmVuLnB1c2gobm9kZSk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHVuYXR0YWNoZWQucHVzaChub2RlKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuXHJcbiAgICAgICAgdW5hdHRhY2hlZC5mb3JFYWNoKG4gPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBwYXRoQ29kZSA9IG4uZGF0YVt0cmVlSW5mb0ZpZWxkXVtwYXRoRmllbGRdO1xyXG4gICAgICAgICAgICBjb25zdCBwYXJlbnQgPSBub2Rlcy5nZXQocGF0aENvZGUuc3Vic3RyKDAsIHBhdGhDb2RlLmxlbmd0aCAtIDQpKTtcclxuICAgICAgICAgICAgaWYgKHBhcmVudCkge1xyXG4gICAgICAgICAgICAgICAgcGFyZW50LmNoaWxkcmVuLnB1c2gobik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH1cclxufVxyXG4iXX0=