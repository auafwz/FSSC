/*
 * @Author: Witt
 * @Date: 2018-11-15 15:56:11
 * @Last Modified by: aalizzwell
 * @Last Modified time: 2019-07-09 16:23:04
 */
import { Injectable, Optional } from '@angular/core';
import { Router } from '@angular/router';
import { RouterParamService } from '@farris/devkit';
import { FrameworkService, AppService } from '@gsp-sys/rtf-common';
import { MenuStateService } from './menu-state.service';
import { Subject } from 'rxjs';
import { LanguageService } from './languag.service';
// tslint:disable: no-string-literal
/**
 * 路由服务
 * @scope FormModule
 */
class RouterService {
    constructor(router, routerParamService, frameworkService, appService, menuStateService, languageService) {
        this.router = router;
        this.routerParamService = routerParamService;
        this.frameworkService = frameworkService;
        this.appService = appService;
        this.menuStateService = menuStateService;
        this.languageService = languageService;
        /**
         * 上次切换的TabId
         */
        this.lastSwitchId = null;
        /**
         * 上次关闭的TabId
         */
        this.lastCloseId = null;
        // private menuStateService: MenuStateService = null;
        this.onClosed = null;
        if (!this.menuStateService) {
            this.menuStateService = new MenuStateService();
        }
        if (!this.languageService) {
            this.languageService = LanguageService.getInstance();
        }
        this.onClosed = new Subject();
        this.registerEvent();
    }
    /**
     * 切换路由
     * @param url 菜单ID
     * @param params 路由参数
     */
    route(url, params) {
        url = this.router.createUrlTree([url]).toString();
        this.setParams(url, params);
        this.router.navigateByUrl(url);
    }
    /**
     * 注册运行框架事件
     */
    registerEvent() {
        const menuId = this.getAppId() || this.getFuncId();
        this.frameworkService.eventListner(this.frameworkService.FuncSwitch, e => {
            if (!e) {
                return;
            }
            const id = this.getOriginalId(e.id) || e.tabId;
            const menuState = this.menuStateService.getMenuState(id);
            if (!!id && menuId === id && !!menuState && menuState.length > 0) {
                this.formReload();
                this.lastSwitchId = id;
            }
        });
        this.frameworkService.eventListner(this.frameworkService.FuncClosed, e => {
            if (!e) {
                return;
            }
            this.onClosed.next(e);
            const id = this.getOriginalId(e.id) || e.tabId;
            if (menuId === id) {
                return;
            }
            const menuState = this.menuStateService.getMenuState(menuId, id);
            // && id !== this.lastCloseId
            if (!!id && !!menuState && menuState.length > 0) {
                this.removeMenuState(id);
                this.formReload();
                this.lastCloseId = id;
            }
        });
    }
    removeMenuState(tabId) {
        if (this['context']) {
            this.menuStateService.removeMenu(tabId);
        }
    }
    /**
     * 获取原始功能id
     * @param id id
     */
    getOriginalId(id) {
        if (!id) {
            return id;
        }
        if (id.indexOf('_') !== -1) {
            id = id.split('_')[0];
        }
        return id;
    }
    /**
     * 刷新组件数据
     */
    formReload() {
        try {
            this['context']['frameContext']['appContext']['refresh']();
        }
        catch (_a) { }
    }
    /**
     * 打开功能菜单
     * @param funcId 菜单内码
     * @param params 路由参数，形如： { key1: val1, key2: value2 }
     */
    openMenu(funcId, params, reload) {
        if (typeof reload === 'undefined' || typeof reload !== 'boolean') {
            reload = false;
        }
        const paramsMap = this.buildParamMap(params);
        const parentMenuId = this.getFuncId() || this.getAppId();
        this.menuStateService.addMenuState(parentMenuId, funcId);
        paramsMap.set('WEB_FORM_ROUTER_PARENT_ID', parentMenuId);
        this.frameworkService.openFuncWithParam(funcId, paramsMap, reload);
    }
    /**
     * 打开应用
     * @param appId 应用内码
     * @param appEntrance 应用入口
     * @param params 路由参数，形如： { key1: val1, key2: value2 }
     */
    openApp(appId, appEntrance, params, reload) {
        if (typeof reload === 'undefined' || typeof reload !== 'boolean') {
            reload = false;
        }
        const paramMap = this.buildParamMap(params);
        const parentMenuId = this.getAppId() || this.getFuncId();
        this.menuStateService.addMenuState(parentMenuId, appId);
        paramMap.set('WEB_FORM_ROUTER_PARENT_ID', parentMenuId);
        if (!!this.appService) {
            this.appService.openApp(appId, appEntrance, paramMap, reload);
        }
    }
    /**
     * 构造参数
     */
    buildParamMap(params) {
        if (typeof params === 'undefined' || params === null || (typeof params === 'string' && params.length < 1)) {
            params = {};
        }
        const paramMap = new Map();
        if (typeof params === 'object') {
            params = JSON.stringify(params);
        }
        params = window['encodeURIComponent'](params);
        paramMap.set('WEB_FORM_ROUTE_PARAMS', params);
        return paramMap;
    }
    /**
     * 关闭功能菜单
     */
    closeMenu() {
        const funcId = this.getFuncId();
        const appId = this.getAppId();
        const { isDialogComponent, rootComponent } = this.findDialog();
        if (isDialogComponent) {
            const modalRef = this.get(rootComponent, 'dialogRef');
            modalRef['close']();
            return;
        }
        if (funcId !== null && typeof funcId === 'string' && funcId.length > 0) {
            this.closeFunc(funcId);
        }
        else if (appId !== null && typeof appId === 'string' && appId.length > 0) {
            const appEntrance = this.getAppEntrance();
            this.closeApp(appId, appEntrance);
        }
        else {
            console.error(this.languageService['notSupportMenuType']);
        }
    }
    /**
     * 查找弹窗组件
     */
    findDialog() {
        let frameContext = this.get(this, 'context.frameContext');
        let isDialogComponent = this.get(frameContext, 'frameComponent.isDialogRootComponent', false);
        let parentFrameContext = this.get(frameContext, 'parent');
        while (parentFrameContext != null && !isDialogComponent) {
            frameContext = this.get(frameContext, 'parent');
            parentFrameContext = this.get(parentFrameContext, 'parent');
            isDialogComponent = this.get(frameContext, 'frameComponent.isDialogRootComponent', false);
        }
        const rootComponent = this.get(frameContext, 'frameComponent');
        return { isDialogComponent, rootComponent };
    }
    /**
     * loadsh get
     * @param object 对象
     * @param path 路径
     * @param defaultVal 默认值
     */
    get(object, path, defaultVal = null) {
        const PATH = Array.isArray(path)
            ? path
            : path.split('.').filter(i => i.length);
        if (!PATH.length) {
            return object === undefined ? defaultVal : object;
        }
        if (object === null || object === undefined || typeof (object[PATH[0]]) === 'undefined') {
            return defaultVal;
        }
        return this.get(object[PATH.shift()], PATH, defaultVal);
    }
    /**
     * 关闭菜单
     * @param funcId 菜单id
     */
    closeFunc(funcId) {
        if (!funcId) {
            funcId = this.getFuncId();
        }
        if (!!this.frameworkService) {
            this.frameworkService.closeFunc(funcId).subscribe();
        }
    }
    /**
     * 关闭app
     * @param appId 应用id
     */
    closeApp(appId, appEntrance) {
        if (!appId) {
            appId = this.getAppId();
        }
        if (typeof appEntrance === 'undefined') {
            appEntrance = this.getAppEntrance();
        }
        if (!!this.appService) {
            this.appService.closeApp(appId, appEntrance).subscribe();
        }
    }
    /**
     * 设置参数
     * @param params 路由参数
     */
    setParams(url, params) {
        let paramsObj;
        if (typeof params === 'string' && params !== '') {
            paramsObj = JSON.parse(params);
        }
        else {
            paramsObj = params || {};
        }
        // 设置路由参数
        this.routerParamService.setParams(url, paramsObj);
    }
    /**
     * 获取funcId
     */
    getFuncId() {
        const hash = window.location.hash;
        if (!hash) {
            return null;
        }
        const params = this.decodeURLParams(hash);
        if (params && params.hasOwnProperty('funcId')) {
            return params.funcId;
        }
        else {
            return null;
        }
    }
    /**
     * 获取appId
     */
    getAppId() {
        const hash = window.location.hash;
        if (!hash) {
            return null;
        }
        const params = this.decodeURLParams(hash);
        if (params && params.hasOwnProperty('appId')) {
            return params.appId;
        }
        else {
            return null;
        }
    }
    getParentMenuId() {
        const hash = window.location.hash;
        if (!hash) {
            return null;
        }
        const params = this.decodeURLParams(hash);
        if (params && params.hasOwnProperty('WEB_FORM_ROUTER_PARENT_ID')) {
            return params.WEB_FORM_ROUTER_PARENT_ID;
        }
        else {
            return null;
        }
    }
    /**
     * 获取应用入口
     */
    getAppEntrance() {
        const hash = window.location.hash;
        if (!hash) {
            return null;
        }
        const params = this.decodeURLParams(hash);
        if (params && params.hasOwnProperty('appEntrance')) {
            return params.appEntrance;
        }
        else {
            return null;
        }
    }
    /**
     * 解码参数
     * @param query search|hash
     */
    decodeURLParams(query) {
        if (typeof query === 'undefined') {
            query = window.location.hash || window.location.search;
        }
        const hashes = query.slice(query.indexOf('?') + 1).split('&');
        return hashes.reduce((params, hash) => {
            const split = hash.indexOf('=');
            const key = hash.slice(0, split);
            const val = hash.slice(split + 1);
            return Object.assign(params, { [key]: decodeURIComponent(val) });
        }, {});
    }
}
RouterService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
RouterService.ctorParameters = () => [
    { type: Router },
    { type: RouterParamService },
    { type: FrameworkService },
    { type: AppService, decorators: [{ type: Optional }] },
    { type: MenuStateService, decorators: [{ type: Optional }] },
    { type: LanguageService, decorators: [{ type: Optional }] }
];
export { RouterService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm91dGVyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMvIiwic291cmNlcyI6WyJsaWIvcm91dGVyLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7O0dBS0c7QUFFSCxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNyRCxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDekMsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDcEQsT0FBTyxFQUFFLGdCQUFnQixFQUFFLFVBQVUsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ25FLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ3hELE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDL0IsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBRXBELG9DQUFvQztBQUNwQzs7O0dBR0c7QUFDSCxNQUNNLGFBQWE7SUFXakIsWUFDVSxNQUFjLEVBQ2Qsa0JBQXNDLEVBQ3RDLGdCQUFrQyxFQUN0QixVQUFzQixFQUN0QixnQkFBa0MsRUFDbEMsZUFBZ0M7UUFMNUMsV0FBTSxHQUFOLE1BQU0sQ0FBUTtRQUNkLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBb0I7UUFDdEMscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUN0QixlQUFVLEdBQVYsVUFBVSxDQUFZO1FBQ3RCLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFDbEMsb0JBQWUsR0FBZixlQUFlLENBQWlCO1FBaEJ0RDs7V0FFRztRQUNLLGlCQUFZLEdBQVcsSUFBSSxDQUFDO1FBQ3BDOztXQUVHO1FBQ0ssZ0JBQVcsR0FBVyxJQUFJLENBQUM7UUFDbkMscURBQXFEO1FBQzlDLGFBQVEsR0FBaUIsSUFBSSxDQUFDO1FBU25DLElBQUksQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLEVBQUU7WUFDMUIsSUFBSSxDQUFDLGdCQUFnQixHQUFHLElBQUksZ0JBQWdCLEVBQUUsQ0FBQztTQUNoRDtRQUNELElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxFQUFFO1lBQ3pCLElBQUksQ0FBQyxlQUFlLEdBQUcsZUFBZSxDQUFDLFdBQVcsRUFBRSxDQUFDO1NBQ3REO1FBQ0QsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLE9BQU8sRUFBTyxDQUFDO1FBQ25DLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztJQUN2QixDQUFDO0lBRUQ7Ozs7T0FJRztJQUNJLEtBQUssQ0FBQyxHQUFXLEVBQUUsTUFBVztRQUNuQyxHQUFHLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ2xELElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQzVCLElBQUksQ0FBQyxNQUFNLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ2pDLENBQUM7SUFDRDs7T0FFRztJQUNJLGFBQWE7UUFDbEIsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLFFBQVEsRUFBRSxJQUFJLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQztRQUNuRCxJQUFJLENBQUMsZ0JBQWdCLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFDLEVBQUU7WUFDdkUsSUFBSSxDQUFDLENBQUMsRUFBRTtnQkFDTixPQUFPO2FBQ1I7WUFDRCxNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsS0FBSyxDQUFDO1lBQy9DLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxZQUFZLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDekQsSUFBSSxDQUFDLENBQUMsRUFBRSxJQUFJLE1BQU0sS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFDLFNBQVMsSUFBSSxTQUFTLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtnQkFDaEUsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO2dCQUNsQixJQUFJLENBQUMsWUFBWSxHQUFHLEVBQUUsQ0FBQzthQUN4QjtRQUNILENBQUMsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsVUFBVSxFQUFFLENBQUMsQ0FBQyxFQUFFO1lBQ3ZFLElBQUksQ0FBQyxDQUFDLEVBQUU7Z0JBQ04sT0FBTzthQUNSO1lBQ0QsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDdEIsTUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLEtBQUssQ0FBQztZQUMvQyxJQUFJLE1BQU0sS0FBSyxFQUFFLEVBQUU7Z0JBQ2pCLE9BQU87YUFDUjtZQUNELE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxZQUFZLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBQ2pFLDZCQUE2QjtZQUM3QixJQUFJLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLFNBQVMsSUFBSSxTQUFTLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtnQkFDL0MsSUFBSSxDQUFDLGVBQWUsQ0FBQyxFQUFFLENBQUMsQ0FBQztnQkFDekIsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO2dCQUNsQixJQUFJLENBQUMsV0FBVyxHQUFHLEVBQUUsQ0FBQzthQUN2QjtRQUNILENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVPLGVBQWUsQ0FBQyxLQUFhO1FBQ25DLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFO1lBQ25CLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDekM7SUFDSCxDQUFDO0lBQ0Q7OztPQUdHO0lBQ0ssYUFBYSxDQUFDLEVBQVU7UUFDOUIsSUFBSSxDQUFDLEVBQUUsRUFBRTtZQUNQLE9BQU8sRUFBRSxDQUFDO1NBQ1g7UUFDRCxJQUFJLEVBQUUsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUU7WUFDMUIsRUFBRSxHQUFHLEVBQUUsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDdkI7UUFDRCxPQUFPLEVBQUUsQ0FBQztJQUNaLENBQUM7SUFDRDs7T0FFRztJQUNLLFVBQVU7UUFDaEIsSUFBSTtZQUNGLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxjQUFjLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFDO1NBQzVEO1FBQUMsV0FBSyxHQUFHO0lBQ1osQ0FBQztJQUNEOzs7O09BSUc7SUFDSSxRQUFRLENBQUMsTUFBYyxFQUFFLE1BQVcsRUFBRSxNQUFnQjtRQUMzRCxJQUFJLE9BQU8sTUFBTSxLQUFLLFdBQVcsSUFBSSxPQUFPLE1BQU0sS0FBSyxTQUFTLEVBQUU7WUFDaEUsTUFBTSxHQUFHLEtBQUssQ0FBQztTQUNoQjtRQUNELE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDN0MsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLFNBQVMsRUFBRSxJQUFJLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUN6RCxJQUFJLENBQUMsZ0JBQWdCLENBQUMsWUFBWSxDQUFDLFlBQVksRUFBRSxNQUFNLENBQUMsQ0FBQztRQUN6RCxTQUFTLENBQUMsR0FBRyxDQUFDLDJCQUEyQixFQUFFLFlBQVksQ0FBQyxDQUFDO1FBQ3pELElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxpQkFBaUIsQ0FBQyxNQUFNLEVBQUUsU0FBUyxFQUFFLE1BQU0sQ0FBQyxDQUFDO0lBQ3JFLENBQUM7SUFFRDs7Ozs7T0FLRztJQUNJLE9BQU8sQ0FBQyxLQUFhLEVBQUUsV0FBbUIsRUFBRSxNQUFXLEVBQUUsTUFBZ0I7UUFDOUUsSUFBSSxPQUFPLE1BQU0sS0FBSyxXQUFXLElBQUksT0FBTyxNQUFNLEtBQUssU0FBUyxFQUFFO1lBQ2hFLE1BQU0sR0FBRyxLQUFLLENBQUM7U0FDaEI7UUFDRCxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQzVDLE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxRQUFRLEVBQUUsSUFBSSxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7UUFDekQsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFlBQVksQ0FBQyxZQUFZLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDeEQsUUFBUSxDQUFDLEdBQUcsQ0FBQywyQkFBMkIsRUFBRSxZQUFZLENBQUMsQ0FBQztRQUN4RCxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFO1lBQ3JCLElBQUksQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxXQUFXLEVBQUUsUUFBUSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1NBQy9EO0lBQ0gsQ0FBQztJQUVEOztPQUVHO0lBQ0ssYUFBYSxDQUFDLE1BQVc7UUFDL0IsSUFBSSxPQUFPLE1BQU0sS0FBSyxXQUFXLElBQUksTUFBTSxLQUFLLElBQUksSUFBSSxDQUFDLE9BQU8sTUFBTSxLQUFLLFFBQVEsSUFBSSxNQUFNLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxFQUFFO1lBQ3pHLE1BQU0sR0FBRyxFQUFFLENBQUM7U0FDYjtRQUNELE1BQU0sUUFBUSxHQUFHLElBQUksR0FBRyxFQUFlLENBQUM7UUFDeEMsSUFBSSxPQUFPLE1BQU0sS0FBSyxRQUFRLEVBQUU7WUFDOUIsTUFBTSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDakM7UUFDRCxNQUFNLEdBQUcsTUFBTSxDQUFDLG9CQUFvQixDQUFDLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDOUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyx1QkFBdUIsRUFBRSxNQUFNLENBQUMsQ0FBQztRQUM5QyxPQUFPLFFBQVEsQ0FBQztJQUNsQixDQUFDO0lBRUQ7O09BRUc7SUFDSSxTQUFTO1FBQ2QsTUFBTSxNQUFNLEdBQWtCLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQztRQUMvQyxNQUFNLEtBQUssR0FBa0IsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQzdDLE1BQU0sRUFBRSxpQkFBaUIsRUFBRSxhQUFhLEVBQUUsR0FBRyxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7UUFDL0QsSUFBSSxpQkFBaUIsRUFBRTtZQUNyQixNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLGFBQWEsRUFBRSxXQUFXLENBQUMsQ0FBQztZQUN0RCxRQUFRLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQztZQUNwQixPQUFPO1NBQ1I7UUFFRCxJQUFJLE1BQU0sS0FBSyxJQUFJLElBQUksT0FBTyxNQUFNLEtBQUssUUFBUSxJQUFJLE1BQU0sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQ3RFLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDeEI7YUFBTSxJQUFJLEtBQUssS0FBSyxJQUFJLElBQUksT0FBTyxLQUFLLEtBQUssUUFBUSxJQUFJLEtBQUssQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQzFFLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztZQUMxQyxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRSxXQUFXLENBQUMsQ0FBQztTQUNuQzthQUFNO1lBQ0wsT0FBTyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLG9CQUFvQixDQUFDLENBQUMsQ0FBQztTQUMzRDtJQUNILENBQUM7SUFFRDs7T0FFRztJQUNLLFVBQVU7UUFDaEIsSUFBSSxZQUFZLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsc0JBQXNCLENBQUMsQ0FBQztRQUMxRCxJQUFJLGlCQUFpQixHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsWUFBWSxFQUFFLHNDQUFzQyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBRTlGLElBQUksa0JBQWtCLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxZQUFZLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFDMUQsT0FBTyxrQkFBa0IsSUFBSSxJQUFJLElBQUksQ0FBQyxpQkFBaUIsRUFBRTtZQUN2RCxZQUFZLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxZQUFZLEVBQUUsUUFBUSxDQUFDLENBQUM7WUFDaEQsa0JBQWtCLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsRUFBRSxRQUFRLENBQUMsQ0FBQztZQUM1RCxpQkFBaUIsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLFlBQVksRUFBRSxzQ0FBc0MsRUFBRSxLQUFLLENBQUMsQ0FBQztTQUMzRjtRQUNELE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsWUFBWSxFQUFFLGdCQUFnQixDQUFDLENBQUM7UUFDL0QsT0FBTyxFQUFFLGlCQUFpQixFQUFFLGFBQWEsRUFBRSxDQUFDO0lBRTlDLENBQUM7SUFFRDs7Ozs7T0FLRztJQUNLLEdBQUcsQ0FBQyxNQUFXLEVBQUUsSUFBNEIsRUFBRSxhQUFrQixJQUFJO1FBQzNFLE1BQU0sSUFBSSxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDO1lBQzlCLENBQUMsQ0FBQyxJQUFJO1lBQ04sQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQzFDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFO1lBQ2hCLE9BQU8sTUFBTSxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUM7U0FDbkQ7UUFFRCxJQUFJLE1BQU0sS0FBSyxJQUFJLElBQUksTUFBTSxLQUFLLFNBQVMsSUFBSSxPQUFPLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssV0FBVyxFQUFFO1lBQ3ZGLE9BQU8sVUFBVSxDQUFDO1NBQ25CO1FBRUQsT0FBTyxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUMsRUFBRSxJQUFJLEVBQUUsVUFBVSxDQUFDLENBQUM7SUFDMUQsQ0FBQztJQUVEOzs7T0FHRztJQUNJLFNBQVMsQ0FBQyxNQUFlO1FBQzlCLElBQUksQ0FBQyxNQUFNLEVBQUU7WUFDWCxNQUFNLEdBQUcsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO1NBQzNCO1FBQ0QsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLGdCQUFnQixFQUFFO1lBQzNCLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUMsU0FBUyxFQUFFLENBQUM7U0FDckQ7SUFDSCxDQUFDO0lBRUQ7OztPQUdHO0lBQ0ksUUFBUSxDQUFDLEtBQWMsRUFBRSxXQUFvQjtRQUNsRCxJQUFJLENBQUMsS0FBSyxFQUFFO1lBQ1YsS0FBSyxHQUFHLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztTQUN6QjtRQUNELElBQUksT0FBTyxXQUFXLEtBQUssV0FBVyxFQUFFO1lBQ3RDLFdBQVcsR0FBRyxJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7U0FDckM7UUFDRCxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFO1lBQ3JCLElBQUksQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRSxXQUFXLENBQUMsQ0FBQyxTQUFTLEVBQUUsQ0FBQztTQUMxRDtJQUNILENBQUM7SUFFRDs7O09BR0c7SUFDSyxTQUFTLENBQUMsR0FBVyxFQUFFLE1BQXdDO1FBQ3JFLElBQUksU0FBUyxDQUFDO1FBQ2QsSUFBSSxPQUFPLE1BQU0sS0FBSyxRQUFRLElBQUksTUFBTSxLQUFLLEVBQUUsRUFBRTtZQUMvQyxTQUFTLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQztTQUNoQzthQUFNO1lBQ0wsU0FBUyxHQUFHLE1BQU0sSUFBSSxFQUFFLENBQUM7U0FDMUI7UUFFRCxTQUFTO1FBQ1QsSUFBSSxDQUFDLGtCQUFrQixDQUFDLFNBQVMsQ0FBQyxHQUFHLEVBQUUsU0FBUyxDQUFDLENBQUM7SUFDcEQsQ0FBQztJQUVEOztPQUVHO0lBQ0ssU0FBUztRQUNmLE1BQU0sSUFBSSxHQUFHLE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDO1FBQ2xDLElBQUksQ0FBQyxJQUFJLEVBQUU7WUFDVCxPQUFPLElBQUksQ0FBQztTQUNiO1FBQ0QsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUMxQyxJQUFJLE1BQU0sSUFBSSxNQUFNLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxFQUFFO1lBQzdDLE9BQU8sTUFBTSxDQUFDLE1BQU0sQ0FBQztTQUN0QjthQUFNO1lBQ0wsT0FBTyxJQUFJLENBQUM7U0FDYjtJQUNILENBQUM7SUFFRDs7T0FFRztJQUNLLFFBQVE7UUFDZCxNQUFNLElBQUksR0FBRyxNQUFNLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQztRQUNsQyxJQUFJLENBQUMsSUFBSSxFQUFFO1lBQ1QsT0FBTyxJQUFJLENBQUM7U0FDYjtRQUNELE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDMUMsSUFBSSxNQUFNLElBQUksTUFBTSxDQUFDLGNBQWMsQ0FBQyxPQUFPLENBQUMsRUFBRTtZQUM1QyxPQUFPLE1BQU0sQ0FBQyxLQUFLLENBQUM7U0FDckI7YUFBTTtZQUNMLE9BQU8sSUFBSSxDQUFDO1NBQ2I7SUFDSCxDQUFDO0lBRU8sZUFBZTtRQUNyQixNQUFNLElBQUksR0FBRyxNQUFNLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQztRQUNsQyxJQUFJLENBQUMsSUFBSSxFQUFFO1lBQ1QsT0FBTyxJQUFJLENBQUM7U0FDYjtRQUNELE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDMUMsSUFBSSxNQUFNLElBQUksTUFBTSxDQUFDLGNBQWMsQ0FBQywyQkFBMkIsQ0FBQyxFQUFFO1lBQ2hFLE9BQU8sTUFBTSxDQUFDLHlCQUF5QixDQUFDO1NBQ3pDO2FBQU07WUFDTCxPQUFPLElBQUksQ0FBQztTQUNiO0lBQ0gsQ0FBQztJQUNEOztPQUVHO0lBQ0ssY0FBYztRQUNwQixNQUFNLElBQUksR0FBRyxNQUFNLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQztRQUNsQyxJQUFJLENBQUMsSUFBSSxFQUFFO1lBQ1QsT0FBTyxJQUFJLENBQUM7U0FDYjtRQUNELE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDMUMsSUFBSSxNQUFNLElBQUksTUFBTSxDQUFDLGNBQWMsQ0FBQyxhQUFhLENBQUMsRUFBRTtZQUNsRCxPQUFPLE1BQU0sQ0FBQyxXQUFXLENBQUM7U0FDM0I7YUFBTTtZQUNMLE9BQU8sSUFBSSxDQUFDO1NBQ2I7SUFDSCxDQUFDO0lBQ0Q7OztPQUdHO0lBQ0ssZUFBZSxDQUFDLEtBQWE7UUFDbkMsSUFBSSxPQUFPLEtBQUssS0FBSyxXQUFXLEVBQUU7WUFDaEMsS0FBSyxHQUFHLE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxJQUFJLE1BQU0sQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDO1NBQ3hEO1FBQ0QsTUFBTSxNQUFNLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUM5RCxPQUFPLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxNQUFNLEVBQUUsSUFBSSxFQUFFLEVBQUU7WUFDcEMsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNoQyxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUNqQyxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsQ0FBQztZQUNsQyxPQUFPLE1BQU0sQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQyxHQUFHLENBQUMsRUFBRSxrQkFBa0IsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDbkUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ1QsQ0FBQzs7O1lBOVVGLFVBQVU7Ozs7WUFaRixNQUFNO1lBQ04sa0JBQWtCO1lBQ2xCLGdCQUFnQjtZQUFFLFVBQVUsdUJBMEJoQyxRQUFRO1lBekJKLGdCQUFnQix1QkEwQnBCLFFBQVE7WUF4QkosZUFBZSx1QkF5Qm5CLFFBQVE7O0FBK1RiLE9BQU8sRUFBRSxhQUFhLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXHJcbiAqIEBBdXRob3I6IFdpdHRcclxuICogQERhdGU6IDIwMTgtMTEtMTUgMTU6NTY6MTFcclxuICogQExhc3QgTW9kaWZpZWQgYnk6IGFhbGl6endlbGxcclxuICogQExhc3QgTW9kaWZpZWQgdGltZTogMjAxOS0wNy0wOSAxNjoyMzowNFxyXG4gKi9cclxuXHJcbmltcG9ydCB7IEluamVjdGFibGUsIE9wdGlvbmFsIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IFJvdXRlciB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XHJcbmltcG9ydCB7IFJvdXRlclBhcmFtU2VydmljZSB9IGZyb20gJ0BmYXJyaXMvZGV2a2l0JztcclxuaW1wb3J0IHsgRnJhbWV3b3JrU2VydmljZSwgQXBwU2VydmljZSB9IGZyb20gJ0Bnc3Atc3lzL3J0Zi1jb21tb24nO1xyXG5pbXBvcnQgeyBNZW51U3RhdGVTZXJ2aWNlIH0gZnJvbSAnLi9tZW51LXN0YXRlLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IExhbmd1YWdlU2VydmljZSB9IGZyb20gJy4vbGFuZ3VhZy5zZXJ2aWNlJztcclxuXHJcbi8vIHRzbGludDpkaXNhYmxlOiBuby1zdHJpbmctbGl0ZXJhbFxyXG4vKipcclxuICog6Lev55Sx5pyN5YqhXHJcbiAqIEBzY29wZSBGb3JtTW9kdWxlXHJcbiAqL1xyXG5ASW5qZWN0YWJsZSgpXHJcbmNsYXNzIFJvdXRlclNlcnZpY2Uge1xyXG4gIC8qKlxyXG4gICAqIOS4iuasoeWIh+aNoueahFRhYklkXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBsYXN0U3dpdGNoSWQ6IHN0cmluZyA9IG51bGw7XHJcbiAgLyoqXHJcbiAgICog5LiK5qyh5YWz6Zet55qEVGFiSWRcclxuICAgKi9cclxuICBwcml2YXRlIGxhc3RDbG9zZUlkOiBzdHJpbmcgPSBudWxsO1xyXG4gIC8vIHByaXZhdGUgbWVudVN0YXRlU2VydmljZTogTWVudVN0YXRlU2VydmljZSA9IG51bGw7XHJcbiAgcHVibGljIG9uQ2xvc2VkOiBTdWJqZWN0PGFueT4gPSBudWxsO1xyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJpdmF0ZSByb3V0ZXI6IFJvdXRlcixcclxuICAgIHByaXZhdGUgcm91dGVyUGFyYW1TZXJ2aWNlOiBSb3V0ZXJQYXJhbVNlcnZpY2UsXHJcbiAgICBwcml2YXRlIGZyYW1ld29ya1NlcnZpY2U6IEZyYW1ld29ya1NlcnZpY2UsXHJcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIGFwcFNlcnZpY2U6IEFwcFNlcnZpY2UsXHJcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIG1lbnVTdGF0ZVNlcnZpY2U6IE1lbnVTdGF0ZVNlcnZpY2UsXHJcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIGxhbmd1YWdlU2VydmljZTogTGFuZ3VhZ2VTZXJ2aWNlLFxyXG4gICkge1xyXG4gICAgaWYgKCF0aGlzLm1lbnVTdGF0ZVNlcnZpY2UpIHtcclxuICAgICAgdGhpcy5tZW51U3RhdGVTZXJ2aWNlID0gbmV3IE1lbnVTdGF0ZVNlcnZpY2UoKTtcclxuICAgIH1cclxuICAgIGlmICghdGhpcy5sYW5ndWFnZVNlcnZpY2UpIHtcclxuICAgICAgdGhpcy5sYW5ndWFnZVNlcnZpY2UgPSBMYW5ndWFnZVNlcnZpY2UuZ2V0SW5zdGFuY2UoKTtcclxuICAgIH1cclxuICAgIHRoaXMub25DbG9zZWQgPSBuZXcgU3ViamVjdDxhbnk+KCk7XHJcbiAgICB0aGlzLnJlZ2lzdGVyRXZlbnQoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWIh+aNoui3r+eUsVxyXG4gICAqIEBwYXJhbSB1cmwg6I+c5Y2VSURcclxuICAgKiBAcGFyYW0gcGFyYW1zIOi3r+eUseWPguaVsFxyXG4gICAqL1xyXG4gIHB1YmxpYyByb3V0ZSh1cmw6IHN0cmluZywgcGFyYW1zOiBhbnkpIHtcclxuICAgIHVybCA9IHRoaXMucm91dGVyLmNyZWF0ZVVybFRyZWUoW3VybF0pLnRvU3RyaW5nKCk7XHJcbiAgICB0aGlzLnNldFBhcmFtcyh1cmwsIHBhcmFtcyk7XHJcbiAgICB0aGlzLnJvdXRlci5uYXZpZ2F0ZUJ5VXJsKHVybCk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOazqOWGjOi/kOihjOahhuaetuS6i+S7tlxyXG4gICAqL1xyXG4gIHB1YmxpYyByZWdpc3RlckV2ZW50KCkge1xyXG4gICAgY29uc3QgbWVudUlkID0gdGhpcy5nZXRBcHBJZCgpIHx8IHRoaXMuZ2V0RnVuY0lkKCk7XHJcbiAgICB0aGlzLmZyYW1ld29ya1NlcnZpY2UuZXZlbnRMaXN0bmVyKHRoaXMuZnJhbWV3b3JrU2VydmljZS5GdW5jU3dpdGNoLCBlID0+IHtcclxuICAgICAgaWYgKCFlKSB7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcbiAgICAgIGNvbnN0IGlkID0gdGhpcy5nZXRPcmlnaW5hbElkKGUuaWQpIHx8IGUudGFiSWQ7XHJcbiAgICAgIGNvbnN0IG1lbnVTdGF0ZSA9IHRoaXMubWVudVN0YXRlU2VydmljZS5nZXRNZW51U3RhdGUoaWQpO1xyXG4gICAgICBpZiAoISFpZCAmJiBtZW51SWQgPT09IGlkICYmICEhbWVudVN0YXRlICYmIG1lbnVTdGF0ZS5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgdGhpcy5mb3JtUmVsb2FkKCk7XHJcbiAgICAgICAgdGhpcy5sYXN0U3dpdGNoSWQgPSBpZDtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcblxyXG4gICAgdGhpcy5mcmFtZXdvcmtTZXJ2aWNlLmV2ZW50TGlzdG5lcih0aGlzLmZyYW1ld29ya1NlcnZpY2UuRnVuY0Nsb3NlZCwgZSA9PiB7XHJcbiAgICAgIGlmICghZSkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG4gICAgICB0aGlzLm9uQ2xvc2VkLm5leHQoZSk7XHJcbiAgICAgIGNvbnN0IGlkID0gdGhpcy5nZXRPcmlnaW5hbElkKGUuaWQpIHx8IGUudGFiSWQ7XHJcbiAgICAgIGlmIChtZW51SWQgPT09IGlkKSB7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcbiAgICAgIGNvbnN0IG1lbnVTdGF0ZSA9IHRoaXMubWVudVN0YXRlU2VydmljZS5nZXRNZW51U3RhdGUobWVudUlkLCBpZCk7XHJcbiAgICAgIC8vICYmIGlkICE9PSB0aGlzLmxhc3RDbG9zZUlkXHJcbiAgICAgIGlmICghIWlkICYmICEhbWVudVN0YXRlICYmIG1lbnVTdGF0ZS5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgdGhpcy5yZW1vdmVNZW51U3RhdGUoaWQpO1xyXG4gICAgICAgIHRoaXMuZm9ybVJlbG9hZCgpO1xyXG4gICAgICAgIHRoaXMubGFzdENsb3NlSWQgPSBpZDtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHJlbW92ZU1lbnVTdGF0ZSh0YWJJZDogc3RyaW5nKSB7XHJcbiAgICBpZiAodGhpc1snY29udGV4dCddKSB7XHJcbiAgICAgIHRoaXMubWVudVN0YXRlU2VydmljZS5yZW1vdmVNZW51KHRhYklkKTtcclxuICAgIH1cclxuICB9XHJcbiAgLyoqXHJcbiAgICog6I635Y+W5Y6f5aeL5Yqf6IO9aWRcclxuICAgKiBAcGFyYW0gaWQgaWRcclxuICAgKi9cclxuICBwcml2YXRlIGdldE9yaWdpbmFsSWQoaWQ6IHN0cmluZykge1xyXG4gICAgaWYgKCFpZCkge1xyXG4gICAgICByZXR1cm4gaWQ7XHJcbiAgICB9XHJcbiAgICBpZiAoaWQuaW5kZXhPZignXycpICE9PSAtMSkge1xyXG4gICAgICBpZCA9IGlkLnNwbGl0KCdfJylbMF07XHJcbiAgICB9XHJcbiAgICByZXR1cm4gaWQ7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOWIt+aWsOe7hOS7tuaVsOaNrlxyXG4gICAqL1xyXG4gIHByaXZhdGUgZm9ybVJlbG9hZCgpIHtcclxuICAgIHRyeSB7XHJcbiAgICAgIHRoaXNbJ2NvbnRleHQnXVsnZnJhbWVDb250ZXh0J11bJ2FwcENvbnRleHQnXVsncmVmcmVzaCddKCk7XHJcbiAgICB9IGNhdGNoeyB9XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOaJk+W8gOWKn+iDveiPnOWNlVxyXG4gICAqIEBwYXJhbSBmdW5jSWQg6I+c5Y2V5YaF56CBXHJcbiAgICogQHBhcmFtIHBhcmFtcyDot6/nlLHlj4LmlbDvvIzlvaLlpoLvvJogeyBrZXkxOiB2YWwxLCBrZXkyOiB2YWx1ZTIgfVxyXG4gICAqL1xyXG4gIHB1YmxpYyBvcGVuTWVudShmdW5jSWQ6IHN0cmluZywgcGFyYW1zOiBhbnksIHJlbG9hZD86IGJvb2xlYW4pIHtcclxuICAgIGlmICh0eXBlb2YgcmVsb2FkID09PSAndW5kZWZpbmVkJyB8fCB0eXBlb2YgcmVsb2FkICE9PSAnYm9vbGVhbicpIHtcclxuICAgICAgcmVsb2FkID0gZmFsc2U7XHJcbiAgICB9XHJcbiAgICBjb25zdCBwYXJhbXNNYXAgPSB0aGlzLmJ1aWxkUGFyYW1NYXAocGFyYW1zKTtcclxuICAgIGNvbnN0IHBhcmVudE1lbnVJZCA9IHRoaXMuZ2V0RnVuY0lkKCkgfHwgdGhpcy5nZXRBcHBJZCgpO1xyXG4gICAgdGhpcy5tZW51U3RhdGVTZXJ2aWNlLmFkZE1lbnVTdGF0ZShwYXJlbnRNZW51SWQsIGZ1bmNJZCk7XHJcbiAgICBwYXJhbXNNYXAuc2V0KCdXRUJfRk9STV9ST1VURVJfUEFSRU5UX0lEJywgcGFyZW50TWVudUlkKTtcclxuICAgIHRoaXMuZnJhbWV3b3JrU2VydmljZS5vcGVuRnVuY1dpdGhQYXJhbShmdW5jSWQsIHBhcmFtc01hcCwgcmVsb2FkKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOaJk+W8gOW6lOeUqFxyXG4gICAqIEBwYXJhbSBhcHBJZCDlupTnlKjlhoXnoIFcclxuICAgKiBAcGFyYW0gYXBwRW50cmFuY2Ug5bqU55So5YWl5Y+jXHJcbiAgICogQHBhcmFtIHBhcmFtcyDot6/nlLHlj4LmlbDvvIzlvaLlpoLvvJogeyBrZXkxOiB2YWwxLCBrZXkyOiB2YWx1ZTIgfVxyXG4gICAqL1xyXG4gIHB1YmxpYyBvcGVuQXBwKGFwcElkOiBzdHJpbmcsIGFwcEVudHJhbmNlOiBzdHJpbmcsIHBhcmFtczogYW55LCByZWxvYWQ/OiBib29sZWFuKSB7XHJcbiAgICBpZiAodHlwZW9mIHJlbG9hZCA9PT0gJ3VuZGVmaW5lZCcgfHwgdHlwZW9mIHJlbG9hZCAhPT0gJ2Jvb2xlYW4nKSB7XHJcbiAgICAgIHJlbG9hZCA9IGZhbHNlO1xyXG4gICAgfVxyXG4gICAgY29uc3QgcGFyYW1NYXAgPSB0aGlzLmJ1aWxkUGFyYW1NYXAocGFyYW1zKTtcclxuICAgIGNvbnN0IHBhcmVudE1lbnVJZCA9IHRoaXMuZ2V0QXBwSWQoKSB8fCB0aGlzLmdldEZ1bmNJZCgpO1xyXG4gICAgdGhpcy5tZW51U3RhdGVTZXJ2aWNlLmFkZE1lbnVTdGF0ZShwYXJlbnRNZW51SWQsIGFwcElkKTtcclxuICAgIHBhcmFtTWFwLnNldCgnV0VCX0ZPUk1fUk9VVEVSX1BBUkVOVF9JRCcsIHBhcmVudE1lbnVJZCk7XHJcbiAgICBpZiAoISF0aGlzLmFwcFNlcnZpY2UpIHtcclxuICAgICAgdGhpcy5hcHBTZXJ2aWNlLm9wZW5BcHAoYXBwSWQsIGFwcEVudHJhbmNlLCBwYXJhbU1hcCwgcmVsb2FkKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOaehOmAoOWPguaVsFxyXG4gICAqL1xyXG4gIHByaXZhdGUgYnVpbGRQYXJhbU1hcChwYXJhbXM6IGFueSk6IE1hcDxzdHJpbmcsIHN0cmluZz4ge1xyXG4gICAgaWYgKHR5cGVvZiBwYXJhbXMgPT09ICd1bmRlZmluZWQnIHx8IHBhcmFtcyA9PT0gbnVsbCB8fCAodHlwZW9mIHBhcmFtcyA9PT0gJ3N0cmluZycgJiYgcGFyYW1zLmxlbmd0aCA8IDEpKSB7XHJcbiAgICAgIHBhcmFtcyA9IHt9O1xyXG4gICAgfVxyXG4gICAgY29uc3QgcGFyYW1NYXAgPSBuZXcgTWFwPHN0cmluZywgYW55PigpO1xyXG4gICAgaWYgKHR5cGVvZiBwYXJhbXMgPT09ICdvYmplY3QnKSB7XHJcbiAgICAgIHBhcmFtcyA9IEpTT04uc3RyaW5naWZ5KHBhcmFtcyk7XHJcbiAgICB9XHJcbiAgICBwYXJhbXMgPSB3aW5kb3dbJ2VuY29kZVVSSUNvbXBvbmVudCddKHBhcmFtcyk7XHJcbiAgICBwYXJhbU1hcC5zZXQoJ1dFQl9GT1JNX1JPVVRFX1BBUkFNUycsIHBhcmFtcyk7XHJcbiAgICByZXR1cm4gcGFyYW1NYXA7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDlhbPpl63lip/og73oj5zljZVcclxuICAgKi9cclxuICBwdWJsaWMgY2xvc2VNZW51KCkge1xyXG4gICAgY29uc3QgZnVuY0lkOiBzdHJpbmcgfCBudWxsID0gdGhpcy5nZXRGdW5jSWQoKTtcclxuICAgIGNvbnN0IGFwcElkOiBzdHJpbmcgfCBudWxsID0gdGhpcy5nZXRBcHBJZCgpO1xyXG4gICAgY29uc3QgeyBpc0RpYWxvZ0NvbXBvbmVudCwgcm9vdENvbXBvbmVudCB9ID0gdGhpcy5maW5kRGlhbG9nKCk7XHJcbiAgICBpZiAoaXNEaWFsb2dDb21wb25lbnQpIHtcclxuICAgICAgY29uc3QgbW9kYWxSZWYgPSB0aGlzLmdldChyb290Q29tcG9uZW50LCAnZGlhbG9nUmVmJyk7XHJcbiAgICAgIG1vZGFsUmVmWydjbG9zZSddKCk7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoZnVuY0lkICE9PSBudWxsICYmIHR5cGVvZiBmdW5jSWQgPT09ICdzdHJpbmcnICYmIGZ1bmNJZC5sZW5ndGggPiAwKSB7XHJcbiAgICAgIHRoaXMuY2xvc2VGdW5jKGZ1bmNJZCk7XHJcbiAgICB9IGVsc2UgaWYgKGFwcElkICE9PSBudWxsICYmIHR5cGVvZiBhcHBJZCA9PT0gJ3N0cmluZycgJiYgYXBwSWQubGVuZ3RoID4gMCkge1xyXG4gICAgICBjb25zdCBhcHBFbnRyYW5jZSA9IHRoaXMuZ2V0QXBwRW50cmFuY2UoKTtcclxuICAgICAgdGhpcy5jbG9zZUFwcChhcHBJZCwgYXBwRW50cmFuY2UpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgY29uc29sZS5lcnJvcih0aGlzLmxhbmd1YWdlU2VydmljZVsnbm90U3VwcG9ydE1lbnVUeXBlJ10pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5p+l5om+5by556qX57uE5Lu2XHJcbiAgICovXHJcbiAgcHJpdmF0ZSBmaW5kRGlhbG9nKCkge1xyXG4gICAgbGV0IGZyYW1lQ29udGV4dCA9IHRoaXMuZ2V0KHRoaXMsICdjb250ZXh0LmZyYW1lQ29udGV4dCcpO1xyXG4gICAgbGV0IGlzRGlhbG9nQ29tcG9uZW50ID0gdGhpcy5nZXQoZnJhbWVDb250ZXh0LCAnZnJhbWVDb21wb25lbnQuaXNEaWFsb2dSb290Q29tcG9uZW50JywgZmFsc2UpO1xyXG5cclxuICAgIGxldCBwYXJlbnRGcmFtZUNvbnRleHQgPSB0aGlzLmdldChmcmFtZUNvbnRleHQsICdwYXJlbnQnKTtcclxuICAgIHdoaWxlIChwYXJlbnRGcmFtZUNvbnRleHQgIT0gbnVsbCAmJiAhaXNEaWFsb2dDb21wb25lbnQpIHtcclxuICAgICAgZnJhbWVDb250ZXh0ID0gdGhpcy5nZXQoZnJhbWVDb250ZXh0LCAncGFyZW50Jyk7XHJcbiAgICAgIHBhcmVudEZyYW1lQ29udGV4dCA9IHRoaXMuZ2V0KHBhcmVudEZyYW1lQ29udGV4dCwgJ3BhcmVudCcpO1xyXG4gICAgICBpc0RpYWxvZ0NvbXBvbmVudCA9IHRoaXMuZ2V0KGZyYW1lQ29udGV4dCwgJ2ZyYW1lQ29tcG9uZW50LmlzRGlhbG9nUm9vdENvbXBvbmVudCcsIGZhbHNlKTtcclxuICAgIH1cclxuICAgIGNvbnN0IHJvb3RDb21wb25lbnQgPSB0aGlzLmdldChmcmFtZUNvbnRleHQsICdmcmFtZUNvbXBvbmVudCcpO1xyXG4gICAgcmV0dXJuIHsgaXNEaWFsb2dDb21wb25lbnQsIHJvb3RDb21wb25lbnQgfTtcclxuXHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBsb2Fkc2ggZ2V0XHJcbiAgICogQHBhcmFtIG9iamVjdCDlr7nosaFcclxuICAgKiBAcGFyYW0gcGF0aCDot6/lvoRcclxuICAgKiBAcGFyYW0gZGVmYXVsdFZhbCDpu5jorqTlgLxcclxuICAgKi9cclxuICBwcml2YXRlIGdldChvYmplY3Q6IGFueSwgcGF0aDogQXJyYXk8c3RyaW5nPiB8IHN0cmluZywgZGVmYXVsdFZhbDogYW55ID0gbnVsbCkge1xyXG4gICAgY29uc3QgUEFUSCA9IEFycmF5LmlzQXJyYXkocGF0aClcclxuICAgICAgPyBwYXRoXHJcbiAgICAgIDogcGF0aC5zcGxpdCgnLicpLmZpbHRlcihpID0+IGkubGVuZ3RoKTtcclxuICAgIGlmICghUEFUSC5sZW5ndGgpIHtcclxuICAgICAgcmV0dXJuIG9iamVjdCA9PT0gdW5kZWZpbmVkID8gZGVmYXVsdFZhbCA6IG9iamVjdDtcclxuICAgIH1cclxuXHJcbiAgICBpZiAob2JqZWN0ID09PSBudWxsIHx8IG9iamVjdCA9PT0gdW5kZWZpbmVkIHx8IHR5cGVvZiAob2JqZWN0W1BBVEhbMF1dKSA9PT0gJ3VuZGVmaW5lZCcpIHtcclxuICAgICAgcmV0dXJuIGRlZmF1bHRWYWw7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHRoaXMuZ2V0KG9iamVjdFtQQVRILnNoaWZ0KCldLCBQQVRILCBkZWZhdWx0VmFsKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWFs+mXreiPnOWNlVxyXG4gICAqIEBwYXJhbSBmdW5jSWQg6I+c5Y2VaWRcclxuICAgKi9cclxuICBwdWJsaWMgY2xvc2VGdW5jKGZ1bmNJZD86IHN0cmluZykge1xyXG4gICAgaWYgKCFmdW5jSWQpIHtcclxuICAgICAgZnVuY0lkID0gdGhpcy5nZXRGdW5jSWQoKTtcclxuICAgIH1cclxuICAgIGlmICghIXRoaXMuZnJhbWV3b3JrU2VydmljZSkge1xyXG4gICAgICB0aGlzLmZyYW1ld29ya1NlcnZpY2UuY2xvc2VGdW5jKGZ1bmNJZCkuc3Vic2NyaWJlKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDlhbPpl61hcHBcclxuICAgKiBAcGFyYW0gYXBwSWQg5bqU55SoaWRcclxuICAgKi9cclxuICBwdWJsaWMgY2xvc2VBcHAoYXBwSWQ/OiBzdHJpbmcsIGFwcEVudHJhbmNlPzogc3RyaW5nKSB7XHJcbiAgICBpZiAoIWFwcElkKSB7XHJcbiAgICAgIGFwcElkID0gdGhpcy5nZXRBcHBJZCgpO1xyXG4gICAgfVxyXG4gICAgaWYgKHR5cGVvZiBhcHBFbnRyYW5jZSA9PT0gJ3VuZGVmaW5lZCcpIHtcclxuICAgICAgYXBwRW50cmFuY2UgPSB0aGlzLmdldEFwcEVudHJhbmNlKCk7XHJcbiAgICB9XHJcbiAgICBpZiAoISF0aGlzLmFwcFNlcnZpY2UpIHtcclxuICAgICAgdGhpcy5hcHBTZXJ2aWNlLmNsb3NlQXBwKGFwcElkLCBhcHBFbnRyYW5jZSkuc3Vic2NyaWJlKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDorr7nva7lj4LmlbBcclxuICAgKiBAcGFyYW0gcGFyYW1zIOi3r+eUseWPguaVsFxyXG4gICAqL1xyXG4gIHByaXZhdGUgc2V0UGFyYW1zKHVybDogc3RyaW5nLCBwYXJhbXM6IHN0cmluZyB8IHsgW2tleTogc3RyaW5nXTogYW55OyB9KSB7XHJcbiAgICBsZXQgcGFyYW1zT2JqO1xyXG4gICAgaWYgKHR5cGVvZiBwYXJhbXMgPT09ICdzdHJpbmcnICYmIHBhcmFtcyAhPT0gJycpIHtcclxuICAgICAgcGFyYW1zT2JqID0gSlNPTi5wYXJzZShwYXJhbXMpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcGFyYW1zT2JqID0gcGFyYW1zIHx8IHt9O1xyXG4gICAgfVxyXG5cclxuICAgIC8vIOiuvue9rui3r+eUseWPguaVsFxyXG4gICAgdGhpcy5yb3V0ZXJQYXJhbVNlcnZpY2Uuc2V0UGFyYW1zKHVybCwgcGFyYW1zT2JqKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPlmZ1bmNJZFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0RnVuY0lkKCkge1xyXG4gICAgY29uc3QgaGFzaCA9IHdpbmRvdy5sb2NhdGlvbi5oYXNoO1xyXG4gICAgaWYgKCFoYXNoKSB7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gICAgY29uc3QgcGFyYW1zID0gdGhpcy5kZWNvZGVVUkxQYXJhbXMoaGFzaCk7XHJcbiAgICBpZiAocGFyYW1zICYmIHBhcmFtcy5oYXNPd25Qcm9wZXJ0eSgnZnVuY0lkJykpIHtcclxuICAgICAgcmV0dXJuIHBhcmFtcy5mdW5jSWQ7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPlmFwcElkXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXRBcHBJZCgpIHtcclxuICAgIGNvbnN0IGhhc2ggPSB3aW5kb3cubG9jYXRpb24uaGFzaDtcclxuICAgIGlmICghaGFzaCkge1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuICAgIGNvbnN0IHBhcmFtcyA9IHRoaXMuZGVjb2RlVVJMUGFyYW1zKGhhc2gpO1xyXG4gICAgaWYgKHBhcmFtcyAmJiBwYXJhbXMuaGFzT3duUHJvcGVydHkoJ2FwcElkJykpIHtcclxuICAgICAgcmV0dXJuIHBhcmFtcy5hcHBJZDtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXRQYXJlbnRNZW51SWQoKSB7XHJcbiAgICBjb25zdCBoYXNoID0gd2luZG93LmxvY2F0aW9uLmhhc2g7XHJcbiAgICBpZiAoIWhhc2gpIHtcclxuICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcbiAgICBjb25zdCBwYXJhbXMgPSB0aGlzLmRlY29kZVVSTFBhcmFtcyhoYXNoKTtcclxuICAgIGlmIChwYXJhbXMgJiYgcGFyYW1zLmhhc093blByb3BlcnR5KCdXRUJfRk9STV9ST1VURVJfUEFSRU5UX0lEJykpIHtcclxuICAgICAgcmV0dXJuIHBhcmFtcy5XRUJfRk9STV9ST1VURVJfUEFSRU5UX0lEO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluW6lOeUqOWFpeWPo1xyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0QXBwRW50cmFuY2UoKSB7XHJcbiAgICBjb25zdCBoYXNoID0gd2luZG93LmxvY2F0aW9uLmhhc2g7XHJcbiAgICBpZiAoIWhhc2gpIHtcclxuICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcbiAgICBjb25zdCBwYXJhbXMgPSB0aGlzLmRlY29kZVVSTFBhcmFtcyhoYXNoKTtcclxuICAgIGlmIChwYXJhbXMgJiYgcGFyYW1zLmhhc093blByb3BlcnR5KCdhcHBFbnRyYW5jZScpKSB7XHJcbiAgICAgIHJldHVybiBwYXJhbXMuYXBwRW50cmFuY2U7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuICB9XHJcbiAgLyoqXHJcbiAgICog6Kej56CB5Y+C5pWwXHJcbiAgICogQHBhcmFtIHF1ZXJ5IHNlYXJjaHxoYXNoXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBkZWNvZGVVUkxQYXJhbXMocXVlcnk6IHN0cmluZyk6IHsgW3Byb3BOYW1lOiBzdHJpbmddOiBhbnkgfSB7XHJcbiAgICBpZiAodHlwZW9mIHF1ZXJ5ID09PSAndW5kZWZpbmVkJykge1xyXG4gICAgICBxdWVyeSA9IHdpbmRvdy5sb2NhdGlvbi5oYXNoIHx8IHdpbmRvdy5sb2NhdGlvbi5zZWFyY2g7XHJcbiAgICB9XHJcbiAgICBjb25zdCBoYXNoZXMgPSBxdWVyeS5zbGljZShxdWVyeS5pbmRleE9mKCc/JykgKyAxKS5zcGxpdCgnJicpO1xyXG4gICAgcmV0dXJuIGhhc2hlcy5yZWR1Y2UoKHBhcmFtcywgaGFzaCkgPT4ge1xyXG4gICAgICBjb25zdCBzcGxpdCA9IGhhc2guaW5kZXhPZignPScpO1xyXG4gICAgICBjb25zdCBrZXkgPSBoYXNoLnNsaWNlKDAsIHNwbGl0KTtcclxuICAgICAgY29uc3QgdmFsID0gaGFzaC5zbGljZShzcGxpdCArIDEpO1xyXG4gICAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihwYXJhbXMsIHsgW2tleV06IGRlY29kZVVSSUNvbXBvbmVudCh2YWwpIH0pO1xyXG4gICAgfSwge30pO1xyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IHsgUm91dGVyU2VydmljZSB9O1xyXG4iXX0=