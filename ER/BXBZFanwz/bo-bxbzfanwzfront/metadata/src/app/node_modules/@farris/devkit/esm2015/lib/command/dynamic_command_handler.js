import { ReflectiveInjector } from '@angular/core';
import { isObservable, of, Subject } from 'rxjs';
import { CommandHandler } from './command_handler';
export class DynamicCommandHandler extends CommandHandler {
    constructor(commandName, method) {
        super();
        this.commandName = commandName;
        this.method = method;
    }
    dynamicInvoke(serviceTocken, method, args, context) {
        const serviceInstance = context.frameContext.injector.get(serviceTocken, null);
        if (serviceInstance) {
            this.setContextToServiceInstance(serviceInstance, context);
            const parsedStageParams = this.parseService.parse(args, context);
            const parsedArgs = parsedStageParams.map(param => param.expression);
            // tslint:disable-next-line: ban-types
            const serviceMethod = serviceInstance[method];
            return serviceMethod.apply(serviceInstance, parsedArgs);
        }
    }
    dynamicInvoke2(methodObject, context) {
        const { source: serviceUri, service: serviceName, method } = methodObject;
        const args = methodObject.params.map(stageParam => {
            return Object.assign({}, stageParam);
        });
        const result$ = new Subject();
        // const serviceSpecifer = controllerMap.imports[serviceUri] || serviceUri;
        const serviceSpecifer = serviceUri;
        if (serviceSpecifer) {
            System.import(serviceSpecifer)
                .then((serviceModule) => {
                const serviceConstructor = serviceModule[serviceName];
                if (serviceConstructor) {
                    // const resolvedReflectiveProviders = ReflectiveInjector.resolve([{ provide: serviceName, useClass: serviceConstructor }]);
                    const resolvedReflectiveProviders = this.loadProvidersFromModule(serviceModule);
                    const reflectiveInjector = ReflectiveInjector.fromResolvedProviders(resolvedReflectiveProviders, context.frameContext.injector);
                    const originalContextInjector = context.frameContext.injector;
                    context.frameContext.injector = reflectiveInjector;
                    const serviceInstance = reflectiveInjector.get(serviceName, null);
                    if (serviceInstance) {
                        this.setContextToServiceInstance(serviceInstance, context);
                        const parsedStageParams = this.parseService.parse(args, context);
                        const parsedArgs = parsedStageParams.map(param => param.expression);
                        // tslint:disable-next-line: ban-types
                        const serviceMethod = serviceInstance[method];
                        const serviceMethodResult = serviceMethod.apply(serviceInstance, parsedArgs);
                        const result$$ = isObservable(serviceMethodResult) ? serviceMethodResult : of(serviceMethodResult);
                        result$$.subscribe({
                            next: (result) => {
                                result$.next(result);
                            },
                            error: (error) => {
                                result$.error(error);
                            },
                            complete: () => {
                                result$.complete();
                                context.frameContext.injector = originalContextInjector;
                            },
                        });
                        // return serviceMethod.apply(serviceInstance, parsedArgs);
                    }
                }
            });
        }
        return result$;
    }
    schedule() {
        this.scheduleStages(this.method.stages, null);
        // this.method.stages.reduce((preStage: MethodStage, currentStage: MethodStage) => {
        //   if (currentStage.type === '0') {
        //     this.addTask(currentStage.name, (context: CommandContext) => {
        //       return this.dynamicInvoke2(currentStage as ExecutingStage, context);
        //     });
        //     if (preStage) {
        //       this.addLink(preStage.name, currentStage.name, `1===1`);
        //     }
        //   } else if (currentStage.type === '2') {
        //   } else {
        //     throw new Error(`unknow method stage type, the ${currentStage.name}'s type is ${currentStage.type}`);
        //   }
        //   return currentStage;
        // }, null);
    }
    scheduleStages(stages, initialStage) {
        stages.reduce((preStage, currentStage) => {
            if (currentStage.type === 'executing') {
                this.addTask(currentStage.name, (context) => {
                    return this.dynamicInvoke2(currentStage, context);
                });
            }
            else if (currentStage.type === 'fork') {
                const forkStages = currentStage.stages;
                forkStages.forEach(forkStage => {
                    this.scheduleStages(forkStage.stages, forkStage);
                });
                this.scheduleStages(currentStage.stages, currentStage);
            }
            else if (currentStage.type === 'determing') {
                this.addTask(currentStage.name, (context) => {
                    return of(true);
                });
            }
            else {
                throw new Error(`unknow method stage type, the ${currentStage.name}'s type is ${currentStage.type}`);
            }
            if (preStage) {
                const condition = preStage.type === 'determing' ? preStage.condition : `1===1`;
                this.addLink(preStage.name, currentStage.name, condition);
            }
            return currentStage;
        }, initialStage);
    }
    loadProvidersFromModule(serviceModule) {
        const providerArray = [];
        for (const propertyName in serviceModule) {
            if (Object.prototype.hasOwnProperty.call(serviceModule, propertyName)) {
                const propertyValue = serviceModule[propertyName];
                if (this.isInjectableService(propertyValue)) {
                    // const providerName = propertyValue.name === 'e' ? propertyName : propertyValue.name;
                    const providerName = propertyName;
                    providerArray.push({ provide: providerName, useClass: propertyValue });
                    providerArray.push(propertyValue);
                }
            }
        }
        const resolvedReflectiveProviders = ReflectiveInjector.resolve(providerArray);
        return resolvedReflectiveProviders;
    }
    isInjectableService(propertyValue) {
        let hasInjectableDecorator = false;
        const isFunction = propertyValue instanceof Function;
        if (isFunction && propertyValue.hasOwnProperty('decorators')) {
            const decorators = propertyValue.decorators;
            const injectableDecorators = decorators.filter(decorator => {
                if (decorator.type && decorator.type.prototype && decorator.type.prototype.ngMetadataName === 'Injectable') {
                    return decorator;
                }
            });
            hasInjectableDecorator = injectableDecorators && injectableDecorators.length > 0;
        }
        else if (isFunction && propertyValue.hasOwnProperty('__annotations__')) {
            const decorators = propertyValue.__annotations__;
            const injectableDecorators = decorators.filter(decoratorFactory => {
                if (decoratorFactory && decoratorFactory.ngMetadataName && decoratorFactory.ngMetadataName === 'Injectable') {
                    return decoratorFactory;
                }
            });
            hasInjectableDecorator = injectableDecorators && injectableDecorators.length > 0;
        }
        return hasInjectableDecorator;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHluYW1pY19jb21tYW5kX2hhbmRsZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2RldmtpdC8iLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kL2R5bmFtaWNfY29tbWFuZF9oYW5kbGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNuRCxPQUFPLEVBQUUsWUFBWSxFQUFFLEVBQUUsRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFakQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBd0ZuRCxNQUFNLE9BQU8scUJBQXNCLFNBQVEsY0FBYztJQUV2RCxZQUFtQixXQUFtQixFQUFVLE1BQXdCO1FBQ3RFLEtBQUssRUFBRSxDQUFDO1FBRFMsZ0JBQVcsR0FBWCxXQUFXLENBQVE7UUFBVSxXQUFNLEdBQU4sTUFBTSxDQUFrQjtJQUV4RSxDQUFDO0lBRU0sYUFBYSxDQUFDLGFBQXFCLEVBQUUsTUFBYyxFQUFFLElBQWtCLEVBQUUsT0FBdUI7UUFDckcsTUFBTSxlQUFlLEdBQUcsT0FBTyxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLGFBQWEsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUMvRSxJQUFJLGVBQWUsRUFBRTtZQUNuQixJQUFJLENBQUMsMkJBQTJCLENBQUMsZUFBZSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1lBQzNELE1BQU0saUJBQWlCLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBaUIsQ0FBQztZQUNqRixNQUFNLFVBQVUsR0FBRyxpQkFBaUIsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUM7WUFDcEUsc0NBQXNDO1lBQ3RDLE1BQU0sYUFBYSxHQUFHLGVBQWUsQ0FBQyxNQUFNLENBQWEsQ0FBQztZQUMxRCxPQUFPLGFBQWEsQ0FBQyxLQUFLLENBQUMsZUFBZSxFQUFFLFVBQVUsQ0FBQyxDQUFDO1NBQ3pEO0lBQ0gsQ0FBQztJQUVNLGNBQWMsQ0FBQyxZQUE0QixFQUFFLE9BQXVCO1FBQ3pFLE1BQU0sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxFQUFFLEdBQUcsWUFBWSxDQUFDO1FBQzFFLE1BQU0sSUFBSSxHQUFHLFlBQVksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxFQUFFO1lBQ2hELE9BQU8sTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsVUFBVSxDQUFDLENBQUM7UUFDdkMsQ0FBQyxDQUFDLENBQUM7UUFDSCxNQUFNLE9BQU8sR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFDO1FBQzlCLDJFQUEyRTtRQUMzRSxNQUFNLGVBQWUsR0FBRyxVQUFVLENBQUM7UUFDbkMsSUFBSSxlQUFlLEVBQUU7WUFDbkIsTUFBTSxDQUFDLE1BQU0sQ0FBQyxlQUFlLENBQUM7aUJBQzNCLElBQUksQ0FBQyxDQUFDLGFBQWtCLEVBQUUsRUFBRTtnQkFDM0IsTUFBTSxrQkFBa0IsR0FBRyxhQUFhLENBQUMsV0FBVyxDQUFDLENBQUM7Z0JBQ3RELElBQUksa0JBQWtCLEVBQUU7b0JBQ3RCLDRIQUE0SDtvQkFDNUgsTUFBTSwyQkFBMkIsR0FBRyxJQUFJLENBQUMsdUJBQXVCLENBQUMsYUFBYSxDQUFDLENBQUM7b0JBQ2hGLE1BQU0sa0JBQWtCLEdBQUcsa0JBQWtCLENBQUMscUJBQXFCLENBQUMsMkJBQTJCLEVBQUUsT0FBTyxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsQ0FBQztvQkFDaEksTUFBTSx1QkFBdUIsR0FBRyxPQUFPLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQztvQkFDOUQsT0FBTyxDQUFDLFlBQVksQ0FBQyxRQUFRLEdBQUcsa0JBQWtCLENBQUM7b0JBQ25ELE1BQU0sZUFBZSxHQUFHLGtCQUFrQixDQUFDLEdBQUcsQ0FBQyxXQUFXLEVBQUUsSUFBSSxDQUFDLENBQUM7b0JBQ2xFLElBQUksZUFBZSxFQUFFO3dCQUNuQixJQUFJLENBQUMsMkJBQTJCLENBQUMsZUFBZSxFQUFFLE9BQU8sQ0FBQyxDQUFDO3dCQUMzRCxNQUFNLGlCQUFpQixHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxPQUFPLENBQWlCLENBQUM7d0JBQ2pGLE1BQU0sVUFBVSxHQUFHLGlCQUFpQixDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsQ0FBQzt3QkFDcEUsc0NBQXNDO3dCQUN0QyxNQUFNLGFBQWEsR0FBRyxlQUFlLENBQUMsTUFBTSxDQUFhLENBQUM7d0JBQzFELE1BQU0sbUJBQW1CLEdBQUcsYUFBYSxDQUFDLEtBQUssQ0FBQyxlQUFlLEVBQUUsVUFBVSxDQUFDLENBQUM7d0JBQzdFLE1BQU0sUUFBUSxHQUFHLFlBQVksQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDLENBQUMsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLG1CQUFtQixDQUFDLENBQUM7d0JBQ25HLFFBQVEsQ0FBQyxTQUFTLENBQUM7NEJBQ2pCLElBQUksRUFBRSxDQUFDLE1BQVcsRUFBRSxFQUFFO2dDQUNwQixPQUFPLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDOzRCQUN2QixDQUFDOzRCQUNELEtBQUssRUFBRSxDQUFDLEtBQVUsRUFBRSxFQUFFO2dDQUNwQixPQUFPLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDOzRCQUN2QixDQUFDOzRCQUNELFFBQVEsRUFBRSxHQUFHLEVBQUU7Z0NBQ2IsT0FBTyxDQUFDLFFBQVEsRUFBRSxDQUFDO2dDQUNuQixPQUFPLENBQUMsWUFBWSxDQUFDLFFBQVEsR0FBRyx1QkFBdUIsQ0FBQzs0QkFDMUQsQ0FBQzt5QkFDRixDQUFDLENBQUM7d0JBQ0gsMkRBQTJEO3FCQUM1RDtpQkFDRjtZQUNILENBQUMsQ0FBQyxDQUFDO1NBQ047UUFDRCxPQUFPLE9BQU8sQ0FBQztJQUNqQixDQUFDO0lBRUQsUUFBUTtRQUNOLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDOUMsb0ZBQW9GO1FBQ3BGLHFDQUFxQztRQUNyQyxxRUFBcUU7UUFDckUsNkVBQTZFO1FBQzdFLFVBQVU7UUFDVixzQkFBc0I7UUFDdEIsaUVBQWlFO1FBQ2pFLFFBQVE7UUFDUiw0Q0FBNEM7UUFFNUMsYUFBYTtRQUNiLDRHQUE0RztRQUM1RyxNQUFNO1FBQ04seUJBQXlCO1FBQ3pCLFlBQVk7SUFDZCxDQUFDO0lBRUQsY0FBYyxDQUFDLE1BQXFCLEVBQUUsWUFBeUI7UUFDN0QsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLFFBQXFCLEVBQUUsWUFBeUIsRUFBRSxFQUFFO1lBQ2pFLElBQUksWUFBWSxDQUFDLElBQUksS0FBSyxXQUFXLEVBQUU7Z0JBQ3JDLElBQUksQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLElBQUksRUFBRSxDQUFDLE9BQXVCLEVBQUUsRUFBRTtvQkFDMUQsT0FBTyxJQUFJLENBQUMsY0FBYyxDQUFDLFlBQThCLEVBQUUsT0FBTyxDQUFDLENBQUM7Z0JBQ3RFLENBQUMsQ0FBQyxDQUFDO2FBQ0o7aUJBQU0sSUFBSSxZQUFZLENBQUMsSUFBSSxLQUFLLE1BQU0sRUFBRTtnQkFDdkMsTUFBTSxVQUFVLEdBQUksWUFBMEIsQ0FBQyxNQUFNLENBQUM7Z0JBQ3RELFVBQVUsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLEVBQUU7b0JBQzdCLElBQUksQ0FBQyxjQUFjLENBQUMsU0FBUyxDQUFDLE1BQU0sRUFBRSxTQUFTLENBQUMsQ0FBQztnQkFDbkQsQ0FBQyxDQUFDLENBQUM7Z0JBQ0gsSUFBSSxDQUFDLGNBQWMsQ0FBRSxZQUFpQyxDQUFDLE1BQU0sRUFBRSxZQUFZLENBQUMsQ0FBQzthQUM5RTtpQkFBTSxJQUFJLFlBQVksQ0FBQyxJQUFJLEtBQUssV0FBVyxFQUFFO2dCQUM1QyxJQUFJLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxPQUF1QixFQUFFLEVBQUU7b0JBQzFELE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNsQixDQUFDLENBQUMsQ0FBQzthQUNKO2lCQUFNO2dCQUNMLE1BQU0sSUFBSSxLQUFLLENBQUMsaUNBQWlDLFlBQVksQ0FBQyxJQUFJLGNBQWMsWUFBWSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUM7YUFDdEc7WUFDRCxJQUFJLFFBQVEsRUFBRTtnQkFDWixNQUFNLFNBQVMsR0FBRyxRQUFRLENBQUMsSUFBSSxLQUFLLFdBQVcsQ0FBQyxDQUFDLENBQUUsUUFBNkIsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQztnQkFDckcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLFlBQVksQ0FBQyxJQUFJLEVBQUUsU0FBUyxDQUFDLENBQUM7YUFDM0Q7WUFDRCxPQUFPLFlBQVksQ0FBQztRQUN0QixDQUFDLEVBQUUsWUFBWSxDQUFDLENBQUM7SUFDbkIsQ0FBQztJQUVPLHVCQUF1QixDQUFDLGFBQThDO1FBQzVFLE1BQU0sYUFBYSxHQUFHLEVBQUUsQ0FBQztRQUN6QixLQUFLLE1BQU0sWUFBWSxJQUFJLGFBQWEsRUFBRTtZQUN4QyxJQUFJLE1BQU0sQ0FBQyxTQUFTLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsWUFBWSxDQUFDLEVBQUU7Z0JBQ3JFLE1BQU0sYUFBYSxHQUFHLGFBQWEsQ0FBQyxZQUFZLENBQUMsQ0FBQztnQkFDbEQsSUFBSSxJQUFJLENBQUMsbUJBQW1CLENBQUMsYUFBYSxDQUFDLEVBQUU7b0JBQzNDLHVGQUF1RjtvQkFDdkYsTUFBTSxZQUFZLEdBQUcsWUFBWSxDQUFDO29CQUNsQyxhQUFhLENBQUMsSUFBSSxDQUFDLEVBQUUsT0FBTyxFQUFFLFlBQVksRUFBRSxRQUFRLEVBQUUsYUFBYSxFQUFFLENBQUMsQ0FBQztvQkFDdkUsYUFBYSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQztpQkFDbkM7YUFDRjtTQUNGO1FBQ0QsTUFBTSwyQkFBMkIsR0FBRyxrQkFBa0IsQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDOUUsT0FBTywyQkFBMkIsQ0FBQztJQUNyQyxDQUFDO0lBRU8sbUJBQW1CLENBQUMsYUFBa0I7UUFDNUMsSUFBSSxzQkFBc0IsR0FBRyxLQUFLLENBQUM7UUFDbkMsTUFBTSxVQUFVLEdBQUcsYUFBYSxZQUFZLFFBQVEsQ0FBQztRQUNyRCxJQUFJLFVBQVUsSUFBSSxhQUFhLENBQUMsY0FBYyxDQUFDLFlBQVksQ0FBQyxFQUFFO1lBQzVELE1BQU0sVUFBVSxHQUFHLGFBQWEsQ0FBQyxVQUFtQixDQUFDO1lBQ3JELE1BQU0sb0JBQW9CLEdBQUcsVUFBVSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsRUFBRTtnQkFDekQsSUFBSSxTQUFTLENBQUMsSUFBSSxJQUFJLFNBQVMsQ0FBQyxJQUFJLENBQUMsU0FBUyxJQUFJLFNBQVMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLGNBQWMsS0FBSyxZQUFZLEVBQUU7b0JBQzFHLE9BQU8sU0FBUyxDQUFDO2lCQUNsQjtZQUNILENBQUMsQ0FBQyxDQUFDO1lBQ0gsc0JBQXNCLEdBQUcsb0JBQW9CLElBQUksb0JBQW9CLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztTQUNsRjthQUFNLElBQUksVUFBVSxJQUFJLGFBQWEsQ0FBQyxjQUFjLENBQUMsaUJBQWlCLENBQUMsRUFBRTtZQUN4RSxNQUFNLFVBQVUsR0FBRyxhQUFhLENBQUMsZUFBd0IsQ0FBQztZQUMxRCxNQUFNLG9CQUFvQixHQUFHLFVBQVUsQ0FBQyxNQUFNLENBQUMsZ0JBQWdCLENBQUMsRUFBRTtnQkFDaEUsSUFBSSxnQkFBZ0IsSUFBSSxnQkFBZ0IsQ0FBQyxjQUFjLElBQUksZ0JBQWdCLENBQUMsY0FBYyxLQUFLLFlBQVksRUFBRTtvQkFDM0csT0FBTyxnQkFBZ0IsQ0FBQztpQkFDekI7WUFDSCxDQUFDLENBQUMsQ0FBQztZQUNILHNCQUFzQixHQUFHLG9CQUFvQixJQUFJLG9CQUFvQixDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUM7U0FDbEY7UUFDRCxPQUFPLHNCQUFzQixDQUFDO0lBQ2hDLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJlZmxlY3RpdmVJbmplY3RvciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBpc09ic2VydmFibGUsIG9mLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IENvbW1hbmRDb250ZXh0IH0gZnJvbSAnLi9jb21tYW5kX2NvbnRleHQnO1xyXG5pbXBvcnQgeyBDb21tYW5kSGFuZGxlciB9IGZyb20gJy4vY29tbWFuZF9oYW5kbGVyJztcclxuaW1wb3J0IHtcclxuICBDb250cm9sbGVyTWV0aG9kLCBEZXRlcm1pbmluZ1N0YWdlLCBFeGVjdXRpbmdTdGFnZSxcclxuICBGb3JrU3RhZ2UsIE1ldGhvZFN0YWdlLCBTdGFnZVBhcmFtXHJcbn0gZnJvbSAnLi9keW5hbWljX2NvbW1hbmRfaGFuZGxlcl9tZXRhZGF0YSc7XHJcblxyXG4vKipcclxuICogQEluamVjdGFibGUoKVxyXG4gKiBATmdDb21tYW5kSGFuZGxlcih7XHJcbiAqICAgICBjb21tYW5kTmFtZTogJ2FkZDEnXHJcbiAqIH0pXHJcbiAqIGV4cG9ydCBjbGFzcyBhZGQxSGFuZGxlciBleHRlbmRzIENvbW1hbmRIYW5kbGVyIHtcclxuICogICAgIGNvbnN0cnVjdG9yKFxyXG4gKiAgICAgICAgIHB1YmxpYyBfTGlzdERhdGFTZXJ2aWNlMTogTGlzdERhdGFTZXJ2aWNlMSxcclxuICogICAgICAgICBwdWJsaWMgX1N0YXRlTWFjaGluZVNlcnZpY2UxOiBTdGF0ZU1hY2hpbmVTZXJ2aWNlMVxyXG4gKiAgICAgKSB7XHJcbiAqICAgICAgICAgc3VwZXIoKTtcclxuICogICAgIH1cclxuICpcclxuICogICAgIHNjaGVkdWxlKCkge1xyXG4gKiAgICAgICAgIHRoaXMuYWRkVGFzaygnYXBwZW5kJywgKGNvbnRleHQ6IENvbW1hbmRDb250ZXh0KSA9PiB7XHJcbiAqICAgICAgICAgICAgIGNvbnN0IGFyZ3MgPSBbXTtcclxuICogICAgICAgICAgICAgcmV0dXJuIHRoaXMuaW52b2tlKHRoaXMuX0xpc3REYXRhU2VydmljZTEsICdhcHBlbmQnLCBhcmdzLCBjb250ZXh0KTtcclxuICogICAgICAgICB9KTtcclxuICpcclxuICogICAgICAgICB0aGlzLmFkZFRhc2soJ3RyYW5zaXQnLCAoY29udGV4dDogQ29tbWFuZENvbnRleHQpID0+IHtcclxuICogICAgICAgICAgICAgY29uc3QgYXJncyA9IFtcclxuICogICAgICAgICAgICAgICAgICdDcmVhdGUnXHJcbiAqICAgICAgICAgICAgICAgICAgICAgXTtcclxuICogICAgICAgICAgICAgcmV0dXJuIHRoaXMuaW52b2tlKHRoaXMuX1N0YXRlTWFjaGluZVNlcnZpY2UxLCAndHJhbnNpdCcsIGFyZ3MsIGNvbnRleHQpO1xyXG4gKiAgICAgICAgIH0pO1xyXG4gKlxyXG4gKiAgICAgICAgIHRoaXMuYWRkTGluaygnYXBwZW5kJywgJ3RyYW5zaXQnLCBgMT09MWApO1xyXG4gKiAgICAgfVxyXG4gKiB9XHJcbiAqL1xyXG5cclxuLy8gY29uc3QgY29udHJvbGxlck1hcCA9IHtcclxuLy8gICBpbXBvcnRzOiB7XHJcbi8vICAgICBWYWxpZGF0aW9uU2VydmljZTogJy9wbGF0Zm9ybS9jb21tb24vd2ViL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy5qcycsXHJcbi8vICAgICBGb2N1c0ludmFsaWRTZXJ2aWNlOiAnL3BsYXRmb3JtL2NvbW1vbi93ZWIvQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLmpzJyxcclxuLy8gICAgIENoYW5nZUl0ZW1TZXJ2aWNlOiAnL3BsYXRmb3JtL2NvbW1vbi93ZWIvQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLmpzJyxcclxuLy8gICAgIFVJU3RhdGVTZXJ2aWNlOiAnL3BsYXRmb3JtL2NvbW1vbi93ZWIvQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLmpzJyxcclxuLy8gICAgIFN0YXRlTWFjaGluZVNlcnZpY2U6ICcvcGxhdGZvcm0vY29tbW9uL3dlYi9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMuanMnLFxyXG4vLyAgICAgQmluZGluZ0RhdGFTZXJ2aWNlOiAnL3BsYXRmb3JtL2NvbW1vbi93ZWIvQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLmpzJyxcclxuLy8gICAgIENvbW1hbmRTZXJ2aWNlOiAnL3BsYXRmb3JtL2NvbW1vbi93ZWIvQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLmpzJyxcclxuLy8gICAgIEVudGl0eVRyYXZlcnNpbmdTZXJ2aWNlOiAnL3BsYXRmb3JtL2NvbW1vbi93ZWIvQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLmpzJyxcclxuLy8gICAgIEVudGl0eU1hbmlwdWxhdGlvblNlcnZpY2U6ICcvcGxhdGZvcm0vY29tbW9uL3dlYi9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMuanMnLFxyXG4vLyAgICAgRW50aXR5QWdncmVnYXRpb25TZXJ2aWNlOiAnL3BsYXRmb3JtL2NvbW1vbi93ZWIvQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLmpzJyxcclxuLy8gICAgIEVudGl0eUxpc3RTZXJ2aWNlOiAnL3BsYXRmb3JtL2NvbW1vbi93ZWIvQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLmpzJyxcclxuLy8gICAgIEVudGl0eVNlcnZpY2U6ICcvcGxhdGZvcm0vY29tbW9uL3dlYi9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMuanMnLFxyXG4vLyAgICAgTGlzdERhdGFTZXJ2aWNlOiAnL3BsYXRmb3JtL2NvbW1vbi93ZWIvQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLmpzJyxcclxuLy8gICAgIFRyZWVEYXRhU2VydmljZTogJy9wbGF0Zm9ybS9jb21tb24vd2ViL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy5qcycsXHJcbi8vICAgICBTdWJUcmVlRGF0YVNlcnZpY2U6ICcvcGxhdGZvcm0vY29tbW9uL3dlYi9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMuanMnLFxyXG4vLyAgICAgQ2FyZERhdGFTZXJ2aWNlOiAnL3BsYXRmb3JtL2NvbW1vbi93ZWIvQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLmpzJyxcclxuLy8gICAgIFN1Ykxpc3REYXRhU2VydmljZTogJy9wbGF0Zm9ybS9jb21tb24vd2ViL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy5qcycsXHJcbi8vICAgICBSZW1vdmVEYXRhU2VydmljZTogJy9wbGF0Zm9ybS9jb21tb24vd2ViL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy5qcycsXHJcbi8vICAgICBTYXZlRGF0YVNlcnZpY2U6ICcvcGxhdGZvcm0vY29tbW9uL3dlYi9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMuanMnLFxyXG4vLyAgICAgRWRpdERhdGFTZXJ2aWNlOiAnL3BsYXRmb3JtL2NvbW1vbi93ZWIvQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLmpzJyxcclxuLy8gICAgIEZpbHRlckNvbmRpdGlvbkRhdGFTZXJ2aWNlOiAnL3BsYXRmb3JtL2NvbW1vbi93ZWIvQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLmpzJyxcclxuLy8gICAgIFJlbW90ZVN1bW1hcnlTZXJ2aWNlOiAnL3BsYXRmb3JtL2NvbW1vbi93ZWIvQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLmpzJyxcclxuLy8gICAgIEJlQWN0aW9uU2VydmljZTogJy9wbGF0Zm9ybS9jb21tb24vd2ViL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy5qcycsXHJcbi8vICAgICBBcHByb3ZlU2VydmljZTogJy9wbGF0Zm9ybS9jb21tb24vd2ViL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy5qcycsXHJcbi8vICAgICBQcmludFNlcnZpY2U6ICcvcGxhdGZvcm0vY29tbW9uL3dlYi9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMuanMnLFxyXG4vLyAgICAgQXR0YWNobWVudERhdGFTZXJ2aWNlOiAnL3BsYXRmb3JtL2NvbW1vbi93ZWIvQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLmpzJyxcclxuLy8gICAgIEF0dGFjaG1lbnRTZXJ2aWNlOiAnL3BsYXRmb3JtL2NvbW1vbi93ZWIvQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLmpzJyxcclxuLy8gICAgIEZpbGVTZXJ2aWNlOiAnL3BsYXRmb3JtL2NvbW1vbi93ZWIvQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLmpzJyxcclxuLy8gICAgIE5hdmlnYXRpb25NaWRkbGV3YXJlU2VydmljZTogJy9wbGF0Zm9ybS9jb21tb24vd2ViL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy5qcycsXHJcbi8vICAgICBHcmlkTWlkZGxld2FyZVNlcnZpY2U6ICcvcGxhdGZvcm0vY29tbW9uL3dlYi9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMuanMnLFxyXG4vLyAgICAgU2lkZWJhclNlcnZpY2U6ICcvcGxhdGZvcm0vY29tbW9uL3dlYi9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMuanMnLFxyXG4vLyAgICAgRmFycmlzRm9ybVNlcnZpY2U6ICcvcGxhdGZvcm0vY29tbW9uL3dlYi9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMuanMnLFxyXG4vLyAgICAgRGlhbG9nU2VydmljZTogJy9wbGF0Zm9ybS9jb21tb24vd2ViL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy5qcycsXHJcbi8vICAgICBOYXZpZ2F0aW9uRXZlbnRTZXJ2aWNlOiAnL3BsYXRmb3JtL2NvbW1vbi93ZWIvQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLmpzJyxcclxuLy8gICAgIE5hdmlnYXRpb25TZXJ2aWNlOiAnL3BsYXRmb3JtL2NvbW1vbi93ZWIvQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLmpzJyxcclxuLy8gICAgIFJvdXRlclNlcnZpY2U6ICcvcGxhdGZvcm0vY29tbW9uL3dlYi9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMuanMnLFxyXG4vLyAgICAgQXV0aG9yaXR5U2VydmljZTogJy9wbGF0Zm9ybS9jb21tb24vd2ViL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy5qcycsXHJcbi8vICAgICBFbmRFZGl0U2VydmljZTogJy9wbGF0Zm9ybS9jb21tb24vd2ViL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy5qcycsXHJcbi8vICAgICBCYXRjaEVkaXREaWFsb2dTZXJ2aWNlOiAnL3BsYXRmb3JtL2NvbW1vbi93ZWIvQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLmpzJyxcclxuLy8gICAgIEJhdGNoRWRpdFNlcnZpY2U6ICcvcGxhdGZvcm0vY29tbW9uL3dlYi9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMuanMnLFxyXG4vLyAgICAgRGlzY3Vzc2lvbkdyb3VwU2VydmljZTogJy9wbGF0Zm9ybS9jb21tb24vd2ViL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy5qcycsXHJcbi8vICAgICBMb2NhbGl6YXRpb25TZXJ2aWNlOiAnL3BsYXRmb3JtL2NvbW1vbi93ZWIvQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLmpzJyxcclxuLy8gICAgIERhdGFHcmlkU2VydmljZTogJy9wbGF0Zm9ybS9jb21tb24vd2ViL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy5qcycsXHJcbi8vICAgICBGb3JtQXR0ZW50aW9uU2VydmljZTogJy9wbGF0Zm9ybS9jb21tb24vd2ViL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy5qcycsXHJcbi8vICAgfVxyXG4vLyB9O1xyXG5cclxuZGVjbGFyZSBjb25zdCBTeXN0ZW06IGFueTtcclxuXHJcbmV4cG9ydCBjbGFzcyBEeW5hbWljQ29tbWFuZEhhbmRsZXIgZXh0ZW5kcyBDb21tYW5kSGFuZGxlciB7XHJcblxyXG4gIGNvbnN0cnVjdG9yKHB1YmxpYyBjb21tYW5kTmFtZTogc3RyaW5nLCBwcml2YXRlIG1ldGhvZDogQ29udHJvbGxlck1ldGhvZCkge1xyXG4gICAgc3VwZXIoKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBkeW5hbWljSW52b2tlKHNlcnZpY2VUb2NrZW46IHN0cmluZywgbWV0aG9kOiBzdHJpbmcsIGFyZ3M6IFN0YWdlUGFyYW1bXSwgY29udGV4dDogQ29tbWFuZENvbnRleHQpIHtcclxuICAgIGNvbnN0IHNlcnZpY2VJbnN0YW5jZSA9IGNvbnRleHQuZnJhbWVDb250ZXh0LmluamVjdG9yLmdldChzZXJ2aWNlVG9ja2VuLCBudWxsKTtcclxuICAgIGlmIChzZXJ2aWNlSW5zdGFuY2UpIHtcclxuICAgICAgdGhpcy5zZXRDb250ZXh0VG9TZXJ2aWNlSW5zdGFuY2Uoc2VydmljZUluc3RhbmNlLCBjb250ZXh0KTtcclxuICAgICAgY29uc3QgcGFyc2VkU3RhZ2VQYXJhbXMgPSB0aGlzLnBhcnNlU2VydmljZS5wYXJzZShhcmdzLCBjb250ZXh0KSBhcyBTdGFnZVBhcmFtW107XHJcbiAgICAgIGNvbnN0IHBhcnNlZEFyZ3MgPSBwYXJzZWRTdGFnZVBhcmFtcy5tYXAocGFyYW0gPT4gcGFyYW0uZXhwcmVzc2lvbik7XHJcbiAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogYmFuLXR5cGVzXHJcbiAgICAgIGNvbnN0IHNlcnZpY2VNZXRob2QgPSBzZXJ2aWNlSW5zdGFuY2VbbWV0aG9kXSBhcyBGdW5jdGlvbjtcclxuICAgICAgcmV0dXJuIHNlcnZpY2VNZXRob2QuYXBwbHkoc2VydmljZUluc3RhbmNlLCBwYXJzZWRBcmdzKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHB1YmxpYyBkeW5hbWljSW52b2tlMihtZXRob2RPYmplY3Q6IEV4ZWN1dGluZ1N0YWdlLCBjb250ZXh0OiBDb21tYW5kQ29udGV4dCkge1xyXG4gICAgY29uc3QgeyBzb3VyY2U6IHNlcnZpY2VVcmksIHNlcnZpY2U6IHNlcnZpY2VOYW1lLCBtZXRob2QgfSA9IG1ldGhvZE9iamVjdDtcclxuICAgIGNvbnN0IGFyZ3MgPSBtZXRob2RPYmplY3QucGFyYW1zLm1hcChzdGFnZVBhcmFtID0+IHtcclxuICAgICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oe30sIHN0YWdlUGFyYW0pO1xyXG4gICAgfSk7XHJcbiAgICBjb25zdCByZXN1bHQkID0gbmV3IFN1YmplY3QoKTtcclxuICAgIC8vIGNvbnN0IHNlcnZpY2VTcGVjaWZlciA9IGNvbnRyb2xsZXJNYXAuaW1wb3J0c1tzZXJ2aWNlVXJpXSB8fCBzZXJ2aWNlVXJpO1xyXG4gICAgY29uc3Qgc2VydmljZVNwZWNpZmVyID0gc2VydmljZVVyaTtcclxuICAgIGlmIChzZXJ2aWNlU3BlY2lmZXIpIHtcclxuICAgICAgU3lzdGVtLmltcG9ydChzZXJ2aWNlU3BlY2lmZXIpXHJcbiAgICAgICAgLnRoZW4oKHNlcnZpY2VNb2R1bGU6IGFueSkgPT4ge1xyXG4gICAgICAgICAgY29uc3Qgc2VydmljZUNvbnN0cnVjdG9yID0gc2VydmljZU1vZHVsZVtzZXJ2aWNlTmFtZV07XHJcbiAgICAgICAgICBpZiAoc2VydmljZUNvbnN0cnVjdG9yKSB7XHJcbiAgICAgICAgICAgIC8vIGNvbnN0IHJlc29sdmVkUmVmbGVjdGl2ZVByb3ZpZGVycyA9IFJlZmxlY3RpdmVJbmplY3Rvci5yZXNvbHZlKFt7IHByb3ZpZGU6IHNlcnZpY2VOYW1lLCB1c2VDbGFzczogc2VydmljZUNvbnN0cnVjdG9yIH1dKTtcclxuICAgICAgICAgICAgY29uc3QgcmVzb2x2ZWRSZWZsZWN0aXZlUHJvdmlkZXJzID0gdGhpcy5sb2FkUHJvdmlkZXJzRnJvbU1vZHVsZShzZXJ2aWNlTW9kdWxlKTtcclxuICAgICAgICAgICAgY29uc3QgcmVmbGVjdGl2ZUluamVjdG9yID0gUmVmbGVjdGl2ZUluamVjdG9yLmZyb21SZXNvbHZlZFByb3ZpZGVycyhyZXNvbHZlZFJlZmxlY3RpdmVQcm92aWRlcnMsIGNvbnRleHQuZnJhbWVDb250ZXh0LmluamVjdG9yKTtcclxuICAgICAgICAgICAgY29uc3Qgb3JpZ2luYWxDb250ZXh0SW5qZWN0b3IgPSBjb250ZXh0LmZyYW1lQ29udGV4dC5pbmplY3RvcjtcclxuICAgICAgICAgICAgY29udGV4dC5mcmFtZUNvbnRleHQuaW5qZWN0b3IgPSByZWZsZWN0aXZlSW5qZWN0b3I7XHJcbiAgICAgICAgICAgIGNvbnN0IHNlcnZpY2VJbnN0YW5jZSA9IHJlZmxlY3RpdmVJbmplY3Rvci5nZXQoc2VydmljZU5hbWUsIG51bGwpO1xyXG4gICAgICAgICAgICBpZiAoc2VydmljZUluc3RhbmNlKSB7XHJcbiAgICAgICAgICAgICAgdGhpcy5zZXRDb250ZXh0VG9TZXJ2aWNlSW5zdGFuY2Uoc2VydmljZUluc3RhbmNlLCBjb250ZXh0KTtcclxuICAgICAgICAgICAgICBjb25zdCBwYXJzZWRTdGFnZVBhcmFtcyA9IHRoaXMucGFyc2VTZXJ2aWNlLnBhcnNlKGFyZ3MsIGNvbnRleHQpIGFzIFN0YWdlUGFyYW1bXTtcclxuICAgICAgICAgICAgICBjb25zdCBwYXJzZWRBcmdzID0gcGFyc2VkU3RhZ2VQYXJhbXMubWFwKHBhcmFtID0+IHBhcmFtLmV4cHJlc3Npb24pO1xyXG4gICAgICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogYmFuLXR5cGVzXHJcbiAgICAgICAgICAgICAgY29uc3Qgc2VydmljZU1ldGhvZCA9IHNlcnZpY2VJbnN0YW5jZVttZXRob2RdIGFzIEZ1bmN0aW9uO1xyXG4gICAgICAgICAgICAgIGNvbnN0IHNlcnZpY2VNZXRob2RSZXN1bHQgPSBzZXJ2aWNlTWV0aG9kLmFwcGx5KHNlcnZpY2VJbnN0YW5jZSwgcGFyc2VkQXJncyk7XHJcbiAgICAgICAgICAgICAgY29uc3QgcmVzdWx0JCQgPSBpc09ic2VydmFibGUoc2VydmljZU1ldGhvZFJlc3VsdCkgPyBzZXJ2aWNlTWV0aG9kUmVzdWx0IDogb2Yoc2VydmljZU1ldGhvZFJlc3VsdCk7XHJcbiAgICAgICAgICAgICAgcmVzdWx0JCQuc3Vic2NyaWJlKHtcclxuICAgICAgICAgICAgICAgIG5leHQ6IChyZXN1bHQ6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICByZXN1bHQkLm5leHQocmVzdWx0KTtcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICBlcnJvcjogKGVycm9yOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgICAgcmVzdWx0JC5lcnJvcihlcnJvcik7XHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgY29tcGxldGU6ICgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgcmVzdWx0JC5jb21wbGV0ZSgpO1xyXG4gICAgICAgICAgICAgICAgICBjb250ZXh0LmZyYW1lQ29udGV4dC5pbmplY3RvciA9IG9yaWdpbmFsQ29udGV4dEluamVjdG9yO1xyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAvLyByZXR1cm4gc2VydmljZU1ldGhvZC5hcHBseShzZXJ2aWNlSW5zdGFuY2UsIHBhcnNlZEFyZ3MpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcmVzdWx0JDtcclxuICB9XHJcblxyXG4gIHNjaGVkdWxlKCkge1xyXG4gICAgdGhpcy5zY2hlZHVsZVN0YWdlcyh0aGlzLm1ldGhvZC5zdGFnZXMsIG51bGwpO1xyXG4gICAgLy8gdGhpcy5tZXRob2Quc3RhZ2VzLnJlZHVjZSgocHJlU3RhZ2U6IE1ldGhvZFN0YWdlLCBjdXJyZW50U3RhZ2U6IE1ldGhvZFN0YWdlKSA9PiB7XHJcbiAgICAvLyAgIGlmIChjdXJyZW50U3RhZ2UudHlwZSA9PT0gJzAnKSB7XHJcbiAgICAvLyAgICAgdGhpcy5hZGRUYXNrKGN1cnJlbnRTdGFnZS5uYW1lLCAoY29udGV4dDogQ29tbWFuZENvbnRleHQpID0+IHtcclxuICAgIC8vICAgICAgIHJldHVybiB0aGlzLmR5bmFtaWNJbnZva2UyKGN1cnJlbnRTdGFnZSBhcyBFeGVjdXRpbmdTdGFnZSwgY29udGV4dCk7XHJcbiAgICAvLyAgICAgfSk7XHJcbiAgICAvLyAgICAgaWYgKHByZVN0YWdlKSB7XHJcbiAgICAvLyAgICAgICB0aGlzLmFkZExpbmsocHJlU3RhZ2UubmFtZSwgY3VycmVudFN0YWdlLm5hbWUsIGAxPT09MWApO1xyXG4gICAgLy8gICAgIH1cclxuICAgIC8vICAgfSBlbHNlIGlmIChjdXJyZW50U3RhZ2UudHlwZSA9PT0gJzInKSB7XHJcblxyXG4gICAgLy8gICB9IGVsc2Uge1xyXG4gICAgLy8gICAgIHRocm93IG5ldyBFcnJvcihgdW5rbm93IG1ldGhvZCBzdGFnZSB0eXBlLCB0aGUgJHtjdXJyZW50U3RhZ2UubmFtZX0ncyB0eXBlIGlzICR7Y3VycmVudFN0YWdlLnR5cGV9YCk7XHJcbiAgICAvLyAgIH1cclxuICAgIC8vICAgcmV0dXJuIGN1cnJlbnRTdGFnZTtcclxuICAgIC8vIH0sIG51bGwpO1xyXG4gIH1cclxuXHJcbiAgc2NoZWR1bGVTdGFnZXMoc3RhZ2VzOiBNZXRob2RTdGFnZVtdLCBpbml0aWFsU3RhZ2U6IE1ldGhvZFN0YWdlKSB7XHJcbiAgICBzdGFnZXMucmVkdWNlKChwcmVTdGFnZTogTWV0aG9kU3RhZ2UsIGN1cnJlbnRTdGFnZTogTWV0aG9kU3RhZ2UpID0+IHtcclxuICAgICAgaWYgKGN1cnJlbnRTdGFnZS50eXBlID09PSAnZXhlY3V0aW5nJykge1xyXG4gICAgICAgIHRoaXMuYWRkVGFzayhjdXJyZW50U3RhZ2UubmFtZSwgKGNvbnRleHQ6IENvbW1hbmRDb250ZXh0KSA9PiB7XHJcbiAgICAgICAgICByZXR1cm4gdGhpcy5keW5hbWljSW52b2tlMihjdXJyZW50U3RhZ2UgYXMgRXhlY3V0aW5nU3RhZ2UsIGNvbnRleHQpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICB9IGVsc2UgaWYgKGN1cnJlbnRTdGFnZS50eXBlID09PSAnZm9yaycpIHtcclxuICAgICAgICBjb25zdCBmb3JrU3RhZ2VzID0gKGN1cnJlbnRTdGFnZSBhcyBGb3JrU3RhZ2UpLnN0YWdlcztcclxuICAgICAgICBmb3JrU3RhZ2VzLmZvckVhY2goZm9ya1N0YWdlID0+IHtcclxuICAgICAgICAgIHRoaXMuc2NoZWR1bGVTdGFnZXMoZm9ya1N0YWdlLnN0YWdlcywgZm9ya1N0YWdlKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICB0aGlzLnNjaGVkdWxlU3RhZ2VzKChjdXJyZW50U3RhZ2UgYXMgRGV0ZXJtaW5pbmdTdGFnZSkuc3RhZ2VzLCBjdXJyZW50U3RhZ2UpO1xyXG4gICAgICB9IGVsc2UgaWYgKGN1cnJlbnRTdGFnZS50eXBlID09PSAnZGV0ZXJtaW5nJykge1xyXG4gICAgICAgIHRoaXMuYWRkVGFzayhjdXJyZW50U3RhZ2UubmFtZSwgKGNvbnRleHQ6IENvbW1hbmRDb250ZXh0KSA9PiB7XHJcbiAgICAgICAgICByZXR1cm4gb2YodHJ1ZSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGB1bmtub3cgbWV0aG9kIHN0YWdlIHR5cGUsIHRoZSAke2N1cnJlbnRTdGFnZS5uYW1lfSdzIHR5cGUgaXMgJHtjdXJyZW50U3RhZ2UudHlwZX1gKTtcclxuICAgICAgfVxyXG4gICAgICBpZiAocHJlU3RhZ2UpIHtcclxuICAgICAgICBjb25zdCBjb25kaXRpb24gPSBwcmVTdGFnZS50eXBlID09PSAnZGV0ZXJtaW5nJyA/IChwcmVTdGFnZSBhcyBEZXRlcm1pbmluZ1N0YWdlKS5jb25kaXRpb24gOiBgMT09PTFgO1xyXG4gICAgICAgIHRoaXMuYWRkTGluayhwcmVTdGFnZS5uYW1lLCBjdXJyZW50U3RhZ2UubmFtZSwgY29uZGl0aW9uKTtcclxuICAgICAgfVxyXG4gICAgICByZXR1cm4gY3VycmVudFN0YWdlO1xyXG4gICAgfSwgaW5pdGlhbFN0YWdlKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgbG9hZFByb3ZpZGVyc0Zyb21Nb2R1bGUoc2VydmljZU1vZHVsZTogeyBbcHJvcGVydHlOYW1lOiBzdHJpbmddOiBhbnkgfSkge1xyXG4gICAgY29uc3QgcHJvdmlkZXJBcnJheSA9IFtdO1xyXG4gICAgZm9yIChjb25zdCBwcm9wZXJ0eU5hbWUgaW4gc2VydmljZU1vZHVsZSkge1xyXG4gICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHNlcnZpY2VNb2R1bGUsIHByb3BlcnR5TmFtZSkpIHtcclxuICAgICAgICBjb25zdCBwcm9wZXJ0eVZhbHVlID0gc2VydmljZU1vZHVsZVtwcm9wZXJ0eU5hbWVdO1xyXG4gICAgICAgIGlmICh0aGlzLmlzSW5qZWN0YWJsZVNlcnZpY2UocHJvcGVydHlWYWx1ZSkpIHtcclxuICAgICAgICAgIC8vIGNvbnN0IHByb3ZpZGVyTmFtZSA9IHByb3BlcnR5VmFsdWUubmFtZSA9PT0gJ2UnID8gcHJvcGVydHlOYW1lIDogcHJvcGVydHlWYWx1ZS5uYW1lO1xyXG4gICAgICAgICAgY29uc3QgcHJvdmlkZXJOYW1lID0gcHJvcGVydHlOYW1lO1xyXG4gICAgICAgICAgcHJvdmlkZXJBcnJheS5wdXNoKHsgcHJvdmlkZTogcHJvdmlkZXJOYW1lLCB1c2VDbGFzczogcHJvcGVydHlWYWx1ZSB9KTtcclxuICAgICAgICAgIHByb3ZpZGVyQXJyYXkucHVzaChwcm9wZXJ0eVZhbHVlKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIGNvbnN0IHJlc29sdmVkUmVmbGVjdGl2ZVByb3ZpZGVycyA9IFJlZmxlY3RpdmVJbmplY3Rvci5yZXNvbHZlKHByb3ZpZGVyQXJyYXkpO1xyXG4gICAgcmV0dXJuIHJlc29sdmVkUmVmbGVjdGl2ZVByb3ZpZGVycztcclxuICB9XHJcblxyXG4gIHByaXZhdGUgaXNJbmplY3RhYmxlU2VydmljZShwcm9wZXJ0eVZhbHVlOiBhbnkpIHtcclxuICAgIGxldCBoYXNJbmplY3RhYmxlRGVjb3JhdG9yID0gZmFsc2U7XHJcbiAgICBjb25zdCBpc0Z1bmN0aW9uID0gcHJvcGVydHlWYWx1ZSBpbnN0YW5jZW9mIEZ1bmN0aW9uO1xyXG4gICAgaWYgKGlzRnVuY3Rpb24gJiYgcHJvcGVydHlWYWx1ZS5oYXNPd25Qcm9wZXJ0eSgnZGVjb3JhdG9ycycpKSB7XHJcbiAgICAgIGNvbnN0IGRlY29yYXRvcnMgPSBwcm9wZXJ0eVZhbHVlLmRlY29yYXRvcnMgYXMgYW55W107XHJcbiAgICAgIGNvbnN0IGluamVjdGFibGVEZWNvcmF0b3JzID0gZGVjb3JhdG9ycy5maWx0ZXIoZGVjb3JhdG9yID0+IHtcclxuICAgICAgICBpZiAoZGVjb3JhdG9yLnR5cGUgJiYgZGVjb3JhdG9yLnR5cGUucHJvdG90eXBlICYmIGRlY29yYXRvci50eXBlLnByb3RvdHlwZS5uZ01ldGFkYXRhTmFtZSA9PT0gJ0luamVjdGFibGUnKSB7XHJcbiAgICAgICAgICByZXR1cm4gZGVjb3JhdG9yO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICAgIGhhc0luamVjdGFibGVEZWNvcmF0b3IgPSBpbmplY3RhYmxlRGVjb3JhdG9ycyAmJiBpbmplY3RhYmxlRGVjb3JhdG9ycy5sZW5ndGggPiAwO1xyXG4gICAgfSBlbHNlIGlmIChpc0Z1bmN0aW9uICYmIHByb3BlcnR5VmFsdWUuaGFzT3duUHJvcGVydHkoJ19fYW5ub3RhdGlvbnNfXycpKSB7XHJcbiAgICAgIGNvbnN0IGRlY29yYXRvcnMgPSBwcm9wZXJ0eVZhbHVlLl9fYW5ub3RhdGlvbnNfXyBhcyBhbnlbXTtcclxuICAgICAgY29uc3QgaW5qZWN0YWJsZURlY29yYXRvcnMgPSBkZWNvcmF0b3JzLmZpbHRlcihkZWNvcmF0b3JGYWN0b3J5ID0+IHtcclxuICAgICAgICBpZiAoZGVjb3JhdG9yRmFjdG9yeSAmJiBkZWNvcmF0b3JGYWN0b3J5Lm5nTWV0YWRhdGFOYW1lICYmIGRlY29yYXRvckZhY3RvcnkubmdNZXRhZGF0YU5hbWUgPT09ICdJbmplY3RhYmxlJykge1xyXG4gICAgICAgICAgcmV0dXJuIGRlY29yYXRvckZhY3Rvcnk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgICAgaGFzSW5qZWN0YWJsZURlY29yYXRvciA9IGluamVjdGFibGVEZWNvcmF0b3JzICYmIGluamVjdGFibGVEZWNvcmF0b3JzLmxlbmd0aCA+IDA7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gaGFzSW5qZWN0YWJsZURlY29yYXRvcjtcclxuICB9XHJcbn1cclxuIl19