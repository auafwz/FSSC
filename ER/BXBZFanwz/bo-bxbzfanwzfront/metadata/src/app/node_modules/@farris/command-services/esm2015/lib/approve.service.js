import { Injectable, Optional } from '@angular/core';
import { empty, of, from, EMPTY } from 'rxjs';
import { tap, map, switchMap, catchError } from 'rxjs/operators';
import { BeActionService } from './be-action.service';
import { FormMessageService } from './form-message.service';
import { FormNotifyService } from './form-notify.service';
import { LanguageService } from './languag.service';
import { FormLoadingService } from './form-loading/form-loading.service';
import { FormErrorService } from './error/form-error.service';
import { WFSubmiteService } from '@gsp-wf/rtdevkit';
import { WfTaskHandlerService } from '@gsp-wf/wf-task-handler';
import { FrameContext } from '@farris/devkit';
import { WFFlowchartService } from '@gsp-wf/ui-flowchart';
import { FormNotifyStrategyService } from './form-notify-strategy.service';
// tslint:disable: max-line-length
/**
 * 审批服务
 * @Scope FrameComponent
 */
class ApproveService {
    /**
     * 构造函数
     */
    constructor(formLoadingService, beActionService, msgService, notifyService, languageService, formErrorService, frameContext, submitter, flowchartService, wfTaskHandlerService) {
        this.formLoadingService = formLoadingService;
        this.beActionService = beActionService;
        this.msgService = msgService;
        this.notifyService = notifyService;
        this.languageService = languageService;
        this.formErrorService = formErrorService;
        this.frameContext = frameContext;
        this.submitter = submitter;
        this.flowchartService = flowchartService;
        this.wfTaskHandlerService = wfTaskHandlerService;
        if (this.frameContext) {
            this.repository = this.frameContext.repository;
            if (!this.wfTaskHandlerService) {
                this.wfTaskHandlerService = this.frameContext.injector.get(WfTaskHandlerService, null);
            }
        }
    }
    /**
     * 带有交互的提交审批
     */
    submitApproveWithInteraction(bizBillID) {
        return this.submitApprove(bizBillID);
    }
    /**
     * 提交审批
     * @param bizBillID 业务单据id
     * @param interactionResult 前端交互结果
     * @deprecated 已废弃，清使用包含入口单据的审批
     */
    submitApprove(bizBillID, interactionResult) {
        if (!bizBillID) {
            // this.msgService.error(this.languageService.unallowEmptyBizBillId);
            this.notifyService.info(this.languageService.unallowEmptyBizBillId, { hideTitle: true });
            return empty();
        }
        const actionUri = 'submittoapprovevoaction';
        const restService = this.beActionService.getRestService();
        const body = {
            requestInfo: restService.buildRequestInfo(),
            bizInstID: bizBillID,
            interactionResult: interactionResult ? {
                procDefId: interactionResult.processDefinitionId
            } : {}
        };
        this.formLoadingService.show();
        // 添加提示
        const action$ = this.beActionService.invokeAction(actionUri, 'PUT', null, null, body);
        // 目前包含三种情况：
        // 1. 第一次提交成功，服务端返回流程实例id
        // 2. 第一次提交成功，服务端返回流程实例id，并返回多个参与者，交互时提交参与者
        // 3. 第一次提交未成功，服务端返回多个流程定义，需要交互后第二次提交审批；第二次提交会出现情况1和情况2
        return action$.pipe(map((result) => {
            if (result && result.returnValue && result.returnValue.excutionResponse) {
                var wfResponse = result.returnValue.excutionResponse;
                return wfResponse;
            }
        }), switchMap((response) => {
            if (response && response.procInstId) {
                if (this.repository) {
                    const updating$ = this.repository.updateById(bizBillID);
                    return updating$.pipe(tap(() => {
                        this.formLoadingService.hide();
                        // this.notifyService.info(this.languageService.submitSuccess);
                        FormNotifyStrategyService.success(this.notifyService, this.languageService.submitSuccess);
                    }), map(() => {
                        return response;
                    }));
                }
                else {
                    this.formLoadingService.hide();
                    // this.notifyService.info(this.languageService.submitSuccess);
                    FormNotifyStrategyService.success(this.notifyService, this.languageService.submitSuccess);
                    return of(response);
                }
            }
            else {
                return of(response);
            }
        }), switchMap((response) => {
            if (response.needInteraction) {
                return from(new Promise((resolve) => {
                    this.submitter.excute(response, (interactionResponse) => {
                        // 如果此次未提交，而选择后得到了流程定义ID，则在此提交审批
                        if (!response.procInstId && interactionResponse.processDefinitionId) {
                            this.submitApprove(bizBillID, interactionResponse).subscribe(() => {
                                resolve();
                            });
                        }
                        else {
                            resolve();
                        }
                    });
                }));
            }
            else {
                return of(null);
            }
        }), catchError(error => {
            this.formLoadingService.hide();
            // this.formErrorService.exception(this.languageService.submitFaild, error);
            return of(error);
        }));
    }
    /**
     * 提交审批(带入口单据)
     * @param bizBillID 业务单据Id
     * @param bizDefKey 入口单据Id
     * @param options options
     * @param interactionResult 交互结果
     */
    submitApproveWithBizDefKey(bizBillID, bizDefKey, options, interactionResult) {
        if (!bizBillID) {
            this.notifyService.warning(this.languageService.unallowEmptyBizBillId, { hideTitle: true });
            return EMPTY;
        }
        if (!bizDefKey) {
            this.notifyService.warning(this.languageService.bizDefKeyRequired, { hideTitle: true });
            return EMPTY;
        }
        try {
            if (options && typeof (options) === 'string') {
                options = JSON.parse(options);
            }
        }
        catch (e) {
            throw new Error('ArgumentError:options not a valid json string.');
        }
        const actionUri = 'submittoapprovewithpayload';
        const restService = this.beActionService.getRestService();
        const body = {
            requestInfo: restService.buildRequestInfo(),
            approvePayload: {
                startProcessPayload: {
                    bizDefKey: bizDefKey,
                    dataId: bizBillID,
                    name: options && options.name || '',
                    variables: options && options.variables || {}
                }
            }
        };
        if (interactionResult) {
            body.approvePayload.startProcessPayload.processDefinitionId = interactionResult.processDefinitionId;
            body.approvePayload.startProcessPayload.processDefinitionKey = interactionResult['processDefinitionKey'];
        }
        this.formLoadingService.show();
        // 添加提示
        const action$ = this.beActionService.invokeAction(actionUri, 'PUT', null, null, body);
        // 目前包含三种情况：
        // 1. 第一次提交成功，服务端返回流程实例id
        // 2. 第一次提交成功，服务端返回流程实例id，并返回多个参与者，交互时提交参与者
        // 3. 第一次提交未成功，服务端返回多个流程定义，需要交互后第二次提交审批；第二次提交会出现情况1和情况2
        return action$.pipe(map((result) => {
            if (result && result.returnValue && result.returnValue.excutionResponse) {
                const wfResponse = result.returnValue.excutionResponse;
                return wfResponse;
            }
        }), switchMap((response) => {
            if (response && response.procInstId) {
                if (this.repository) {
                    const updating$ = this.repository.updateById(bizBillID);
                    return updating$.pipe(tap(() => {
                        this.formLoadingService.hide();
                        // this.notifyService.info(this.languageService.submitSuccess);
                        FormNotifyStrategyService.success(this.notifyService, this.languageService.submitSuccess);
                    }), map(() => {
                        return response;
                    }));
                }
                else {
                    this.formLoadingService.hide();
                    // this.notifyService.info(this.languageService.submitSuccess);
                    FormNotifyStrategyService.success(this.notifyService, this.languageService.submitSuccess);
                    return of(response);
                }
            }
            else {
                return of(response);
            }
        }), switchMap((response) => {
            if (response.needInteraction) {
                return from(new Promise((resolve) => {
                    this.submitter.excute(response, (interactionResponse) => {
                        // 如果此次未提交，而选择后得到了流程定义ID，则在此提交审批
                        console.log(response);
                        if (!response.procInstId && interactionResponse.processDefinitionId) {
                            this.submitApproveWithBizDefKey(bizBillID, bizDefKey, options, interactionResponse).subscribe(() => {
                                resolve();
                            });
                        }
                        else {
                            resolve();
                        }
                    });
                }));
            }
            else {
                return of(null);
            }
        }), catchError(error => {
            this.formLoadingService.hide();
            // this.formErrorService.exception(this.languageService.submitFaild, error);
            return of(error);
        }));
    }
    /**
     * 提交审批(带入口单据使用wf控件)
     * @param bizBillID 业务单据Id
     * @param bizDefKey 入口单据Id
     * @param options 上下文参数
     * @param variables 可选参数
     */
    submitApproveWithBizDefKeyUseControl(bizBillID, bizDefKey, options = {}, variables) {
        if (!bizBillID) {
            this.notifyService.warning(this.languageService.unallowEmptyBizBillId, { hideTitle: true });
            return EMPTY;
        }
        if (!bizDefKey) {
            this.notifyService.warning(this.languageService.bizDefKeyRequired, { hideTitle: true });
            return EMPTY;
        }
        if (!options || typeof options !== 'object') {
            options = {};
        }
        const payload = Object.assign({ dataId: bizBillID, bizDefKey }, options);
        // 处理variables参数
        if (variables) {
            if (variables.startsWith('{') && variables.endsWith('}')) {
                try {
                    variables = JSON.parse(variables);
                }
                catch (_a) {
                    console.log('variables parse failed!');
                    variables = {};
                }
            }
            payload.variables = variables;
        }
        return this.wfTaskHandlerService && this.wfTaskHandlerService.startProcess(payload);
    }
    /**
     * 子表提交审批
     * @param bizDefKey 入口单据Id
     * @param bizId 业务单据Id（主表）
     * @param childBizId 业务单据Id（从表）
     * @param options 上下文参数
     * @param variables 可选参数
     */
    childSubmitApproveWithBizDefKey(bizDefKey, bizId, childBizId, options = {}, variables) {
        // 入口单据不能为空
        if (!bizDefKey) {
            this.notifyService.warning(this.languageService.bizDefKeyRequired, { hideTitle: true });
            return EMPTY;
        }
        // 主业务单据Id不能为空
        if (!bizId) {
            this.notifyService.warning(this.languageService.unallowEmptyBizBillId, { hideTitle: true });
            return EMPTY;
        }
        // 从表业务单据Id不能为空
        if (!childBizId) {
            this.notifyService.warning(this.languageService.unallowEmptyChildBizBillId, { hideTitle: true });
            return EMPTY;
        }
        if (!options || typeof options !== 'object') {
            options = {};
        }
        const payload = Object.assign({ dataId: `${bizId},${childBizId}`, bizDefKey }, options);
        // 处理variables参数
        if (variables) {
            if (variables.startsWith('{') && variables.endsWith('}')) {
                try {
                    variables = JSON.parse(variables);
                }
                catch (_a) {
                    console.log('variables parse failed!');
                    variables = {};
                }
            }
            payload.variables = variables;
        }
        return this.wfTaskHandlerService && this.wfTaskHandlerService.startProcess(payload);
    }
    /**
     * 取消审批
     * @deprecated 已废弃，请使用cancelSubmit
     */
    cancelApprove(bizBillID) {
        if (!bizBillID) {
            this.notifyService.warning(this.languageService.unallowEmptyBizBillId, { hideTitle: true });
            return empty();
        }
        const actionUri = 'canceltosubmitvoaction';
        const restService = this.beActionService.getRestService();
        const body = {
            requestInfo: restService.buildRequestInfo(),
            bizInstID: bizBillID,
        };
        this.formLoadingService.show();
        const action$ = this.beActionService.executeAction(actionUri, 'PUT', null, null, body);
        return action$.pipe(switchMap(() => {
            if (this.repository) {
                const updating$ = this.repository.updateById(bizBillID);
                return updating$.pipe(tap(() => {
                    this.formLoadingService.hide();
                    // this.notifyService.info(this.languageService.cancelApproveSuccess);
                    FormNotifyStrategyService.success(this.notifyService, this.languageService.cancelApproveSuccess);
                }));
            }
            else {
                this.formLoadingService.hide();
                // this.notifyService.info(this.languageService.cancelApproveSuccess);
                FormNotifyStrategyService.success(this.notifyService, this.languageService.cancelApproveSuccess);
                return of();
            }
        }), catchError(error => {
            this.formLoadingService.hide();
            // this.formErrorService.exception(this.languageService.cancelApproveFailed, error);
            return of(error);
        }));
    }
    /**
     * 取消审批(支持主表、子表)
     * @param procInstId 流程实例Id
     */
    cancelSubmit(procInstId) {
        if (!procInstId) {
            this.notifyService.warning(this.languageService.procInsIdRequired, { hideTitle: true });
            return EMPTY;
        }
        return this.wfTaskHandlerService && this.wfTaskHandlerService.cancelSubmit({ procInstId: procInstId });
    }
    /**
     * 查看流程图
     * @param procInstId 流程实例ID
     */
    viewProcess(procInstId) {
        if (this.flowchartService) {
            if (!procInstId) {
                this.notifyService.warning(this.languageService.noProcessInstanceId, { hideTitle: true });
                return;
            }
            return this.flowchartService.viewFlowChart(procInstId);
        }
    }
    /**
     * 转换配置大小写
     * @param jsonObj Object
     * @deprecated
     */
    switchPrefixLetter(jsonObj, toUpper) {
        if (typeof (jsonObj) === 'object' && !!jsonObj) {
            if (Array.isArray(jsonObj)) {
                for (var i = 0; i < jsonObj.length; i++) {
                    this.switchPrefixLetter(jsonObj[i], toUpper);
                }
            }
            else {
                for (const key of Object.keys(jsonObj)) {
                    var newKey = (toUpper ? key.substring(0, 1).toUpperCase() : key.substring(0, 1).toLowerCase()) + key.substring(1);
                    jsonObj[newKey] = jsonObj[key];
                    if (typeof jsonObj[key] === 'object') {
                        this.switchPrefixLetter(jsonObj[key], toUpper);
                    }
                    delete (jsonObj[key]);
                }
            }
        }
        return jsonObj;
    }
}
ApproveService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
ApproveService.ctorParameters = () => [
    { type: FormLoadingService },
    { type: BeActionService },
    { type: FormMessageService },
    { type: FormNotifyService },
    { type: LanguageService, decorators: [{ type: Optional }] },
    { type: FormErrorService },
    { type: FrameContext },
    { type: WFSubmiteService, decorators: [{ type: Optional }] },
    { type: WFFlowchartService, decorators: [{ type: Optional }] },
    { type: WfTaskHandlerService, decorators: [{ type: Optional }] }
];
export { ApproveService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwcm92ZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL2FwcHJvdmUuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNyRCxPQUFPLEVBQWMsS0FBSyxFQUFFLEVBQUUsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzFELE9BQU8sRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxVQUFVLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNqRSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDdEQsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDNUQsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDMUQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ3BELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHFDQUFxQyxDQUFDO0FBQ3pFLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBQzlELE9BQU8sRUFBRSxnQkFBZ0IsRUFBeUMsTUFBTSxrQkFBa0IsQ0FBQztBQUMzRixPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUUvRCxPQUFPLEVBQVUsWUFBWSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDdEQsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDMUQsT0FBTyxFQUFFLHlCQUF5QixFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFFM0Usa0NBQWtDO0FBQ2xDOzs7R0FHRztBQUNILE1BQ00sY0FBYztJQU9sQjs7T0FFRztJQUNILFlBQ1Usa0JBQXND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QUFDLEdBQUcsQ0FBQyxFQUFFLE9BQU8sQ0FBQyxDQUFDO3FCQUNoRDtvQkFDRCxPQUFPLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7aUJBQ3ZCO2FBQ0Y7U0FDRjtRQUNELE9BQU8sT0FBTyxDQUFDO0lBQ2pCLENBQUM7OztZQTlaRixVQUFVOzs7O1lBZEYsa0JBQWtCO1lBSmxCLGVBQWU7WUFDZixrQkFBa0I7WUFDbEIsaUJBQWlCO1lBQ2pCLGVBQWUsdUJBK0JuQixRQUFRO1lBN0JKLGdCQUFnQjtZQUlSLFlBQVk7WUFIcEIsZ0JBQWdCLHVCQStCcEIsUUFBUTtZQTNCSixrQkFBa0IsdUJBNEJ0QixRQUFRO1lBL0JKLG9CQUFvQix1QkFnQ3hCLFFBQVE7O0FBMlliLE9BQU8sRUFBRSxjQUFjLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIE9wdGlvbmFsIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IE9ic2VydmFibGUsIGVtcHR5LCBvZiwgZnJvbSwgRU1QVFkgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgdGFwLCBtYXAsIHN3aXRjaE1hcCwgY2F0Y2hFcnJvciB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuaW1wb3J0IHsgQmVBY3Rpb25TZXJ2aWNlIH0gZnJvbSAnLi9iZS1hY3Rpb24uc2VydmljZSc7XHJcbmltcG9ydCB7IEZvcm1NZXNzYWdlU2VydmljZSB9IGZyb20gJy4vZm9ybS1tZXNzYWdlLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBGb3JtTm90aWZ5U2VydmljZSB9IGZyb20gJy4vZm9ybS1ub3RpZnkuc2VydmljZSc7XHJcbmltcG9ydCB7IExhbmd1YWdlU2VydmljZSB9IGZyb20gJy4vbGFuZ3VhZy5zZXJ2aWNlJztcclxuaW1wb3J0IHsgRm9ybUxvYWRpbmdTZXJ2aWNlIH0gZnJvbSAnLi9mb3JtLWxvYWRpbmcvZm9ybS1sb2FkaW5nLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBGb3JtRXJyb3JTZXJ2aWNlIH0gZnJvbSAnLi9lcnJvci9mb3JtLWVycm9yLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBXRlN1Ym1pdGVTZXJ2aWNlLCBJbnRlcmFjdGlvblJlc3BvbnNlLCBFeGN1dGlvblJlc3BvbnNlIH0gZnJvbSAnQGdzcC13Zi9ydGRldmtpdCc7XHJcbmltcG9ydCB7IFdmVGFza0hhbmRsZXJTZXJ2aWNlIH0gZnJvbSAnQGdzcC13Zi93Zi10YXNrLWhhbmRsZXInO1xyXG5pbXBvcnQgeyBCZWZSZXBvc2l0b3J5IH0gZnJvbSAnQGZhcnJpcy9iZWYnO1xyXG5pbXBvcnQgeyBFbnRpdHksIEZyYW1lQ29udGV4dCB9IGZyb20gJ0BmYXJyaXMvZGV2a2l0JztcclxuaW1wb3J0IHsgV0ZGbG93Y2hhcnRTZXJ2aWNlIH0gZnJvbSAnQGdzcC13Zi91aS1mbG93Y2hhcnQnO1xyXG5pbXBvcnQgeyBGb3JtTm90aWZ5U3RyYXRlZ3lTZXJ2aWNlIH0gZnJvbSAnLi9mb3JtLW5vdGlmeS1zdHJhdGVneS5zZXJ2aWNlJztcclxuaW1wb3J0IHsgQm9keVdpdGhSZXF1ZXN0SW5mbyB9IGZyb20gJy4vLi4vbGliL3R5cGVzJztcclxuLy8gdHNsaW50OmRpc2FibGU6IG1heC1saW5lLWxlbmd0aFxyXG4vKipcclxuICog5a6h5om55pyN5YqhXHJcbiAqIEBTY29wZSBGcmFtZUNvbXBvbmVudFxyXG4gKi9cclxuQEluamVjdGFibGUoKVxyXG5jbGFzcyBBcHByb3ZlU2VydmljZSB7XHJcblxyXG4gIC8qKlxyXG4gICAqIOWunuS9k+S7k+W6k1xyXG4gICAqL1xyXG4gIHByaXZhdGUgcmVwb3NpdG9yeTogQmVmUmVwb3NpdG9yeTxFbnRpdHk+O1xyXG5cclxuICAvKipcclxuICAgKiDmnoTpgKDlh73mlbBcclxuICAgKi9cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHByaXZhdGUgZm9ybUxvYWRpbmdTZXJ2aWNlOiBGb3JtTG9hZGluZ1NlcnZpY2UsXHJcbiAgICBwcml2YXRlIGJlQWN0aW9uU2VydmljZTogQmVBY3Rpb25TZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSBtc2dTZXJ2aWNlOiBGb3JtTWVzc2FnZVNlcnZpY2UsXHJcbiAgICBwcml2YXRlIG5vdGlmeVNlcnZpY2U6IEZvcm1Ob3RpZnlTZXJ2aWNlLFxyXG4gICAgQE9wdGlvbmFsKCkgcHJpdmF0ZSBsYW5ndWFnZVNlcnZpY2U6IExhbmd1YWdlU2VydmljZSxcclxuICAgIHByaXZhdGUgZm9ybUVycm9yU2VydmljZTogRm9ybUVycm9yU2VydmljZSxcclxuICAgIHByaXZhdGUgZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQsXHJcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIHN1Ym1pdHRlcjogV0ZTdWJtaXRlU2VydmljZSxcclxuICAgIEBPcHRpb25hbCgpIHByaXZhdGUgZmxvd2NoYXJ0U2VydmljZTogV0ZGbG93Y2hhcnRTZXJ2aWNlLFxyXG4gICAgQE9wdGlvbmFsKCkgcHJpdmF0ZSB3ZlRhc2tIYW5kbGVyU2VydmljZTogV2ZUYXNrSGFuZGxlclNlcnZpY2VcclxuICApIHtcclxuICAgIGlmICh0aGlzLmZyYW1lQ29udGV4dCkge1xyXG4gICAgICB0aGlzLnJlcG9zaXRvcnkgPSB0aGlzLmZyYW1lQ29udGV4dC5yZXBvc2l0b3J5IGFzIEJlZlJlcG9zaXRvcnk8RW50aXR5PjtcclxuICAgICAgaWYgKCF0aGlzLndmVGFza0hhbmRsZXJTZXJ2aWNlKSB7XHJcbiAgICAgICAgdGhpcy53ZlRhc2tIYW5kbGVyU2VydmljZSA9IHRoaXMuZnJhbWVDb250ZXh0LmluamVjdG9yLmdldChXZlRhc2tIYW5kbGVyU2VydmljZSwgbnVsbCk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOW4puacieS6pOS6kueahOaPkOS6pOWuoeaJuVxyXG4gICAqL1xyXG4gIHN1Ym1pdEFwcHJvdmVXaXRoSW50ZXJhY3Rpb24oYml6QmlsbElEOiBzdHJpbmcpIHtcclxuICAgIHJldHVybiB0aGlzLnN1Ym1pdEFwcHJvdmUoYml6QmlsbElEKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOaPkOS6pOWuoeaJuVxyXG4gICAqIEBwYXJhbSBiaXpCaWxsSUQg5Lia5Yqh5Y2V5o2uaWRcclxuICAgKiBAcGFyYW0gaW50ZXJhY3Rpb25SZXN1bHQg5YmN56uv5Lqk5LqS57uT5p6cXHJcbiAgICogQGRlcHJlY2F0ZWQg5bey5bqf5byD77yM5riF5L2/55So5YyF5ZCr5YWl5Y+j5Y2V5o2u55qE5a6h5om5XHJcbiAgICovXHJcbiAgc3VibWl0QXBwcm92ZShiaXpCaWxsSUQ6IHN0cmluZywgaW50ZXJhY3Rpb25SZXN1bHQ/OiBJbnRlcmFjdGlvblJlc3BvbnNlKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIGlmICghYml6QmlsbElEKSB7XHJcbiAgICAgIC8vIHRoaXMubXNnU2VydmljZS5lcnJvcih0aGlzLmxhbmd1YWdlU2VydmljZS51bmFsbG93RW1wdHlCaXpCaWxsSWQpO1xyXG4gICAgICB0aGlzLm5vdGlmeVNlcnZpY2UuaW5mbyh0aGlzLmxhbmd1YWdlU2VydmljZS51bmFsbG93RW1wdHlCaXpCaWxsSWQsIHsgaGlkZVRpdGxlOiB0cnVlIH0pO1xyXG4gICAgICByZXR1cm4gZW1wdHkoKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBhY3Rpb25VcmkgPSAnc3VibWl0dG9hcHByb3Zldm9hY3Rpb24nO1xyXG5cclxuICAgIGNvbnN0IHJlc3RTZXJ2aWNlID0gdGhpcy5iZUFjdGlvblNlcnZpY2UuZ2V0UmVzdFNlcnZpY2UoKTtcclxuXHJcbiAgICBjb25zdCBib2R5OiBCb2R5V2l0aFJlcXVlc3RJbmZvID0ge1xyXG4gICAgICByZXF1ZXN0SW5mbzogcmVzdFNlcnZpY2UuYnVpbGRSZXF1ZXN0SW5mbygpLFxyXG4gICAgICBiaXpJbnN0SUQ6IGJpekJpbGxJRCxcclxuICAgICAgaW50ZXJhY3Rpb25SZXN1bHQ6IGludGVyYWN0aW9uUmVzdWx0ID8ge1xyXG4gICAgICAgIHByb2NEZWZJZDogaW50ZXJhY3Rpb25SZXN1bHQucHJvY2Vzc0RlZmluaXRpb25JZFxyXG4gICAgICB9IDoge31cclxuICAgIH07XHJcblxyXG4gICAgdGhpcy5mb3JtTG9hZGluZ1NlcnZpY2Uuc2hvdygpO1xyXG5cclxuICAgIC8vIOa3u+WKoOaPkOekulxyXG4gICAgY29uc3QgYWN0aW9uJCA9IHRoaXMuYmVBY3Rpb25TZXJ2aWNlLmludm9rZUFjdGlvbihhY3Rpb25VcmksICdQVVQnLCBudWxsLCBudWxsLCBib2R5KTtcclxuICAgIC8vIOebruWJjeWMheWQq+S4ieenjeaDheWGte+8mlxyXG4gICAgLy8gMS4g56ys5LiA5qyh5o+Q5Lqk5oiQ5Yqf77yM5pyN5Yqh56uv6L+U5Zue5rWB56iL5a6e5L6LaWRcclxuICAgIC8vIDIuIOesrOS4gOasoeaPkOS6pOaIkOWKn++8jOacjeWKoeerr+i/lOWbnua1geeoi+WunuS+i2lk77yM5bm26L+U5Zue5aSa5Liq5Y+C5LiO6ICF77yM5Lqk5LqS5pe25o+Q5Lqk5Y+C5LiO6ICFXHJcbiAgICAvLyAzLiDnrKzkuIDmrKHmj5DkuqTmnKrmiJDlip/vvIzmnI3liqHnq6/ov5Tlm57lpJrkuKrmtYHnqIvlrprkuYnvvIzpnIDopoHkuqTkupLlkI7nrKzkuozmrKHmj5DkuqTlrqHmibnvvJvnrKzkuozmrKHmj5DkuqTkvJrlh7rnjrDmg4XlhrUx5ZKM5oOF5Ya1MlxyXG5cclxuICAgIHJldHVybiBhY3Rpb24kLnBpcGUoXHJcbiAgICAgIG1hcCgocmVzdWx0KTogRXhjdXRpb25SZXNwb25zZSA9PiB7XHJcbiAgICAgICAgaWYgKHJlc3VsdCAmJiByZXN1bHQucmV0dXJuVmFsdWUgJiYgcmVzdWx0LnJldHVyblZhbHVlLmV4Y3V0aW9uUmVzcG9uc2UpIHtcclxuICAgICAgICAgIHZhciB3ZlJlc3BvbnNlOiBFeGN1dGlvblJlc3BvbnNlID0gcmVzdWx0LnJldHVyblZhbHVlLmV4Y3V0aW9uUmVzcG9uc2U7XHJcbiAgICAgICAgICByZXR1cm4gd2ZSZXNwb25zZTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pLFxyXG4gICAgICBzd2l0Y2hNYXAoKHJlc3BvbnNlOiBFeGN1dGlvblJlc3BvbnNlKSA9PiB7XHJcbiAgICAgICAgaWYgKHJlc3BvbnNlICYmIHJlc3BvbnNlLnByb2NJbnN0SWQpIHtcclxuICAgICAgICAgIGlmICh0aGlzLnJlcG9zaXRvcnkpIHtcclxuICAgICAgICAgICAgY29uc3QgdXBkYXRpbmckID0gdGhpcy5yZXBvc2l0b3J5LnVwZGF0ZUJ5SWQoYml6QmlsbElEKTtcclxuICAgICAgICAgICAgcmV0dXJuIHVwZGF0aW5nJC5waXBlKHRhcCgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgdGhpcy5mb3JtTG9hZGluZ1NlcnZpY2UuaGlkZSgpO1xyXG4gICAgICAgICAgICAgIC8vIHRoaXMubm90aWZ5U2VydmljZS5pbmZvKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLnN1Ym1pdFN1Y2Nlc3MpO1xyXG4gICAgICAgICAgICAgIEZvcm1Ob3RpZnlTdHJhdGVneVNlcnZpY2Uuc3VjY2Vzcyh0aGlzLm5vdGlmeVNlcnZpY2UsIHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLnN1Ym1pdFN1Y2Nlc3MpO1xyXG4gICAgICAgICAgICB9KSwgbWFwKCgpID0+IHtcclxuICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2U7XHJcbiAgICAgICAgICAgIH0pKTtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuZm9ybUxvYWRpbmdTZXJ2aWNlLmhpZGUoKTtcclxuICAgICAgICAgICAgLy8gdGhpcy5ub3RpZnlTZXJ2aWNlLmluZm8odGhpcy5sYW5ndWFnZVNlcnZpY2Uuc3VibWl0U3VjY2Vzcyk7XHJcbiAgICAgICAgICAgIEZvcm1Ob3RpZnlTdHJhdGVneVNlcnZpY2Uuc3VjY2Vzcyh0aGlzLm5vdGlmeVNlcnZpY2UsIHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLnN1Ym1pdFN1Y2Nlc3MpO1xyXG4gICAgICAgICAgICByZXR1cm4gb2YocmVzcG9uc2UpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICByZXR1cm4gb2YocmVzcG9uc2UpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSksXHJcbiAgICAgIHN3aXRjaE1hcCgocmVzcG9uc2U6IEV4Y3V0aW9uUmVzcG9uc2UpID0+IHtcclxuICAgICAgICBpZiAocmVzcG9uc2UubmVlZEludGVyYWN0aW9uKSB7XHJcbiAgICAgICAgICByZXR1cm4gZnJvbShuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLnN1Ym1pdHRlci5leGN1dGUocmVzcG9uc2UsIChpbnRlcmFjdGlvblJlc3BvbnNlOiBJbnRlcmFjdGlvblJlc3BvbnNlKSA9PiB7XHJcbiAgICAgICAgICAgICAgLy8g5aaC5p6c5q2k5qyh5pyq5o+Q5Lqk77yM6ICM6YCJ5oup5ZCO5b6X5Yiw5LqG5rWB56iL5a6a5LmJSUTvvIzliJnlnKjmraTmj5DkuqTlrqHmiblcclxuICAgICAgICAgICAgICBpZiAoIXJlc3BvbnNlLnByb2NJbnN0SWQgJiYgaW50ZXJhY3Rpb25SZXNwb25zZS5wcm9jZXNzRGVmaW5pdGlvbklkKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnN1Ym1pdEFwcHJvdmUoYml6QmlsbElELCBpbnRlcmFjdGlvblJlc3BvbnNlKS5zdWJzY3JpYmUoKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICByZXNvbHZlKCk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICB9KSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHJldHVybiBvZihudWxsKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pLFxyXG4gICAgICBjYXRjaEVycm9yKFxyXG4gICAgICAgIGVycm9yID0+IHtcclxuICAgICAgICAgIHRoaXMuZm9ybUxvYWRpbmdTZXJ2aWNlLmhpZGUoKTtcclxuICAgICAgICAgIC8vIHRoaXMuZm9ybUVycm9yU2VydmljZS5leGNlcHRpb24odGhpcy5sYW5ndWFnZVNlcnZpY2Uuc3VibWl0RmFpbGQsIGVycm9yKTtcclxuICAgICAgICAgIHJldHVybiBvZihlcnJvcik7XHJcbiAgICAgICAgfVxyXG4gICAgICApXHJcbiAgICApO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmj5DkuqTlrqHmibko5bim5YWl5Y+j5Y2V5o2uKVxyXG4gICAqIEBwYXJhbSBiaXpCaWxsSUQg5Lia5Yqh5Y2V5o2uSWRcclxuICAgKiBAcGFyYW0gYml6RGVmS2V5IOWFpeWPo+WNleaNrklkXHJcbiAgICogQHBhcmFtIG9wdGlvbnMgb3B0aW9uc1xyXG4gICAqIEBwYXJhbSBpbnRlcmFjdGlvblJlc3VsdCDkuqTkupLnu5PmnpxcclxuICAgKi9cclxuXHJcbiAgcHVibGljIHN1Ym1pdEFwcHJvdmVXaXRoQml6RGVmS2V5KGJpekJpbGxJRDogc3RyaW5nLCBiaXpEZWZLZXk6IHN0cmluZywgb3B0aW9ucz86IGFueSwgaW50ZXJhY3Rpb25SZXN1bHQ/OiBJbnRlcmFjdGlvblJlc3BvbnNlKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIGlmICghYml6QmlsbElEKSB7XHJcbiAgICAgIHRoaXMubm90aWZ5U2VydmljZS53YXJuaW5nKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLnVuYWxsb3dFbXB0eUJpekJpbGxJZCwgeyBoaWRlVGl0bGU6IHRydWUgfSk7XHJcbiAgICAgIHJldHVybiBFTVBUWTtcclxuICAgIH1cclxuICAgIGlmICghYml6RGVmS2V5KSB7XHJcbiAgICAgIHRoaXMubm90aWZ5U2VydmljZS53YXJuaW5nKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLmJpekRlZktleVJlcXVpcmVkLCB7IGhpZGVUaXRsZTogdHJ1ZSB9KTtcclxuICAgICAgcmV0dXJuIEVNUFRZO1xyXG4gICAgfVxyXG4gICAgdHJ5IHtcclxuICAgICAgaWYgKG9wdGlvbnMgJiYgdHlwZW9mIChvcHRpb25zKSA9PT0gJ3N0cmluZycpIHtcclxuICAgICAgICBvcHRpb25zID0gSlNPTi5wYXJzZShvcHRpb25zKTtcclxuICAgICAgfVxyXG4gICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0FyZ3VtZW50RXJyb3I6b3B0aW9ucyBub3QgYSB2YWxpZCBqc29uIHN0cmluZy4nKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBhY3Rpb25VcmkgPSAnc3VibWl0dG9hcHByb3Zld2l0aHBheWxvYWQnO1xyXG5cclxuICAgIGNvbnN0IHJlc3RTZXJ2aWNlID0gdGhpcy5iZUFjdGlvblNlcnZpY2UuZ2V0UmVzdFNlcnZpY2UoKTtcclxuXHJcbiAgICBjb25zdCBib2R5OiBCb2R5V2l0aFJlcXVlc3RJbmZvID0ge1xyXG4gICAgICByZXF1ZXN0SW5mbzogcmVzdFNlcnZpY2UuYnVpbGRSZXF1ZXN0SW5mbygpLFxyXG4gICAgICBhcHByb3ZlUGF5bG9hZDoge1xyXG4gICAgICAgIHN0YXJ0UHJvY2Vzc1BheWxvYWQ6IHtcclxuICAgICAgICAgIGJpekRlZktleTogYml6RGVmS2V5LFxyXG4gICAgICAgICAgZGF0YUlkOiBiaXpCaWxsSUQsXHJcbiAgICAgICAgICBuYW1lOiBvcHRpb25zICYmIG9wdGlvbnMubmFtZSB8fCAnJyxcclxuICAgICAgICAgIHZhcmlhYmxlczogb3B0aW9ucyAmJiBvcHRpb25zLnZhcmlhYmxlcyB8fCB7fVxyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfTtcclxuICAgIGlmIChpbnRlcmFjdGlvblJlc3VsdCkge1xyXG4gICAgICBib2R5LmFwcHJvdmVQYXlsb2FkLnN0YXJ0UHJvY2Vzc1BheWxvYWQucHJvY2Vzc0RlZmluaXRpb25JZCA9IGludGVyYWN0aW9uUmVzdWx0LnByb2Nlc3NEZWZpbml0aW9uSWQ7XHJcbiAgICAgIGJvZHkuYXBwcm92ZVBheWxvYWQuc3RhcnRQcm9jZXNzUGF5bG9hZC5wcm9jZXNzRGVmaW5pdGlvbktleSA9IGludGVyYWN0aW9uUmVzdWx0Wydwcm9jZXNzRGVmaW5pdGlvbktleSddO1xyXG4gICAgfVxyXG4gICAgdGhpcy5mb3JtTG9hZGluZ1NlcnZpY2Uuc2hvdygpO1xyXG5cclxuICAgIC8vIOa3u+WKoOaPkOekulxyXG4gICAgY29uc3QgYWN0aW9uJCA9IHRoaXMuYmVBY3Rpb25TZXJ2aWNlLmludm9rZUFjdGlvbihhY3Rpb25VcmksICdQVVQnLCBudWxsLCBudWxsLCBib2R5KTtcclxuICAgIC8vIOebruWJjeWMheWQq+S4ieenjeaDheWGte+8mlxyXG4gICAgLy8gMS4g56ys5LiA5qyh5o+Q5Lqk5oiQ5Yqf77yM5pyN5Yqh56uv6L+U5Zue5rWB56iL5a6e5L6LaWRcclxuICAgIC8vIDIuIOesrOS4gOasoeaPkOS6pOaIkOWKn++8jOacjeWKoeerr+i/lOWbnua1geeoi+WunuS+i2lk77yM5bm26L+U5Zue5aSa5Liq5Y+C5LiO6ICF77yM5Lqk5LqS5pe25o+Q5Lqk5Y+C5LiO6ICFXHJcbiAgICAvLyAzLiDnrKzkuIDmrKHmj5DkuqTmnKrmiJDlip/vvIzmnI3liqHnq6/ov5Tlm57lpJrkuKrmtYHnqIvlrprkuYnvvIzpnIDopoHkuqTkupLlkI7nrKzkuozmrKHmj5DkuqTlrqHmibnvvJvnrKzkuozmrKHmj5DkuqTkvJrlh7rnjrDmg4XlhrUx5ZKM5oOF5Ya1MlxyXG5cclxuICAgIHJldHVybiBhY3Rpb24kLnBpcGUoXHJcbiAgICAgIG1hcCgocmVzdWx0KTogRXhjdXRpb25SZXNwb25zZSA9PiB7XHJcbiAgICAgICAgaWYgKHJlc3VsdCAmJiByZXN1bHQucmV0dXJuVmFsdWUgJiYgcmVzdWx0LnJldHVyblZhbHVlLmV4Y3V0aW9uUmVzcG9uc2UpIHtcclxuICAgICAgICAgIGNvbnN0IHdmUmVzcG9uc2U6IEV4Y3V0aW9uUmVzcG9uc2UgPSByZXN1bHQucmV0dXJuVmFsdWUuZXhjdXRpb25SZXNwb25zZTtcclxuICAgICAgICAgIHJldHVybiB3ZlJlc3BvbnNlO1xyXG4gICAgICAgIH1cclxuICAgICAgfSksXHJcbiAgICAgIHN3aXRjaE1hcCgocmVzcG9uc2U6IEV4Y3V0aW9uUmVzcG9uc2UpID0+IHtcclxuICAgICAgICBpZiAocmVzcG9uc2UgJiYgcmVzcG9uc2UucHJvY0luc3RJZCkge1xyXG4gICAgICAgICAgaWYgKHRoaXMucmVwb3NpdG9yeSkge1xyXG4gICAgICAgICAgICBjb25zdCB1cGRhdGluZyQgPSB0aGlzLnJlcG9zaXRvcnkudXBkYXRlQnlJZChiaXpCaWxsSUQpO1xyXG4gICAgICAgICAgICByZXR1cm4gdXBkYXRpbmckLnBpcGUodGFwKCgpID0+IHtcclxuICAgICAgICAgICAgICB0aGlzLmZvcm1Mb2FkaW5nU2VydmljZS5oaWRlKCk7XHJcbiAgICAgICAgICAgICAgLy8gdGhpcy5ub3RpZnlTZXJ2aWNlLmluZm8odGhpcy5sYW5ndWFnZVNlcnZpY2Uuc3VibWl0U3VjY2Vzcyk7XHJcbiAgICAgICAgICAgICAgRm9ybU5vdGlmeVN0cmF0ZWd5U2VydmljZS5zdWNjZXNzKHRoaXMubm90aWZ5U2VydmljZSwgdGhpcy5sYW5ndWFnZVNlcnZpY2Uuc3VibWl0U3VjY2Vzcyk7XHJcbiAgICAgICAgICAgIH0pLCBtYXAoKCkgPT4ge1xyXG4gICAgICAgICAgICAgIHJldHVybiByZXNwb25zZTtcclxuICAgICAgICAgICAgfSkpO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5mb3JtTG9hZGluZ1NlcnZpY2UuaGlkZSgpO1xyXG4gICAgICAgICAgICAvLyB0aGlzLm5vdGlmeVNlcnZpY2UuaW5mbyh0aGlzLmxhbmd1YWdlU2VydmljZS5zdWJtaXRTdWNjZXNzKTtcclxuICAgICAgICAgICAgRm9ybU5vdGlmeVN0cmF0ZWd5U2VydmljZS5zdWNjZXNzKHRoaXMubm90aWZ5U2VydmljZSwgdGhpcy5sYW5ndWFnZVNlcnZpY2Uuc3VibWl0U3VjY2Vzcyk7XHJcbiAgICAgICAgICAgIHJldHVybiBvZihyZXNwb25zZSk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHJldHVybiBvZihyZXNwb25zZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KSxcclxuICAgICAgc3dpdGNoTWFwKChyZXNwb25zZTogRXhjdXRpb25SZXNwb25zZSkgPT4ge1xyXG4gICAgICAgIGlmIChyZXNwb25zZS5uZWVkSW50ZXJhY3Rpb24pIHtcclxuICAgICAgICAgIHJldHVybiBmcm9tKG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuc3VibWl0dGVyLmV4Y3V0ZShyZXNwb25zZSwgKGludGVyYWN0aW9uUmVzcG9uc2U6IEludGVyYWN0aW9uUmVzcG9uc2UpID0+IHtcclxuICAgICAgICAgICAgICAvLyDlpoLmnpzmraTmrKHmnKrmj5DkuqTvvIzogIzpgInmi6nlkI7lvpfliLDkuobmtYHnqIvlrprkuYlJRO+8jOWImeWcqOatpOaPkOS6pOWuoeaJuVxyXG4gICAgICAgICAgICAgIGNvbnNvbGUubG9nKHJlc3BvbnNlKTtcclxuICAgICAgICAgICAgICBpZiAoIXJlc3BvbnNlLnByb2NJbnN0SWQgJiYgaW50ZXJhY3Rpb25SZXNwb25zZS5wcm9jZXNzRGVmaW5pdGlvbklkKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnN1Ym1pdEFwcHJvdmVXaXRoQml6RGVmS2V5KGJpekJpbGxJRCwgYml6RGVmS2V5LCBvcHRpb25zLCBpbnRlcmFjdGlvblJlc3BvbnNlKS5zdWJzY3JpYmUoKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICByZXNvbHZlKCk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICB9KSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHJldHVybiBvZihudWxsKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pLFxyXG4gICAgICBjYXRjaEVycm9yKFxyXG4gICAgICAgIGVycm9yID0+IHtcclxuICAgICAgICAgIHRoaXMuZm9ybUxvYWRpbmdTZXJ2aWNlLmhpZGUoKTtcclxuICAgICAgICAgIC8vIHRoaXMuZm9ybUVycm9yU2VydmljZS5leGNlcHRpb24odGhpcy5sYW5ndWFnZVNlcnZpY2Uuc3VibWl0RmFpbGQsIGVycm9yKTtcclxuICAgICAgICAgIHJldHVybiBvZihlcnJvcik7XHJcbiAgICAgICAgfVxyXG4gICAgICApXHJcbiAgICApO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmj5DkuqTlrqHmibko5bim5YWl5Y+j5Y2V5o2u5L2/55Sod2bmjqfku7YpXHJcbiAgICogQHBhcmFtIGJpekJpbGxJRCDkuJrliqHljZXmja5JZFxyXG4gICAqIEBwYXJhbSBiaXpEZWZLZXkg5YWl5Y+j5Y2V5o2uSWRcclxuICAgKiBAcGFyYW0gb3B0aW9ucyDkuIrkuIvmloflj4LmlbBcclxuICAgKiBAcGFyYW0gdmFyaWFibGVzIOWPr+mAieWPguaVsFxyXG4gICAqL1xyXG4gIHB1YmxpYyBzdWJtaXRBcHByb3ZlV2l0aEJpekRlZktleVVzZUNvbnRyb2woYml6QmlsbElEOiBzdHJpbmcsIGJpekRlZktleTogc3RyaW5nLCBvcHRpb25zOiBhbnkgPSB7fSwgdmFyaWFibGVzPzogYW55KSB7XHJcbiAgICBpZiAoIWJpekJpbGxJRCkge1xyXG4gICAgICB0aGlzLm5vdGlmeVNlcnZpY2Uud2FybmluZyh0aGlzLmxhbmd1YWdlU2VydmljZS51bmFsbG93RW1wdHlCaXpCaWxsSWQsIHsgaGlkZVRpdGxlOiB0cnVlIH0pO1xyXG4gICAgICByZXR1cm4gRU1QVFk7XHJcbiAgICB9XHJcbiAgICBpZiAoIWJpekRlZktleSkge1xyXG4gICAgICB0aGlzLm5vdGlmeVNlcnZpY2Uud2FybmluZyh0aGlzLmxhbmd1YWdlU2VydmljZS5iaXpEZWZLZXlSZXF1aXJlZCwgeyBoaWRlVGl0bGU6IHRydWUgfSk7XHJcbiAgICAgIHJldHVybiBFTVBUWTtcclxuICAgIH1cclxuICAgIGlmICghb3B0aW9ucyB8fCB0eXBlb2Ygb3B0aW9ucyAhPT0gJ29iamVjdCcpIHtcclxuICAgICAgb3B0aW9ucyA9IHt9O1xyXG4gICAgfVxyXG4gICAgY29uc3QgcGF5bG9hZDogYW55ID0ge1xyXG4gICAgICBkYXRhSWQ6IGJpekJpbGxJRCxcclxuICAgICAgYml6RGVmS2V5LFxyXG4gICAgICAuLi5vcHRpb25zXHJcbiAgICB9O1xyXG4gICAgLy8g5aSE55CGdmFyaWFibGVz5Y+C5pWwXHJcbiAgICBpZiAodmFyaWFibGVzKSB7XHJcbiAgICAgIGlmICh2YXJpYWJsZXMuc3RhcnRzV2l0aCgneycpICYmIHZhcmlhYmxlcy5lbmRzV2l0aCgnfScpKSB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgIHZhcmlhYmxlcyA9IEpTT04ucGFyc2UodmFyaWFibGVzKTtcclxuICAgICAgICB9IGNhdGNoIHtcclxuICAgICAgICAgIGNvbnNvbGUubG9nKCd2YXJpYWJsZXMgcGFyc2UgZmFpbGVkIScpO1xyXG4gICAgICAgICAgdmFyaWFibGVzID0ge307XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIHBheWxvYWQudmFyaWFibGVzID0gdmFyaWFibGVzO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHRoaXMud2ZUYXNrSGFuZGxlclNlcnZpY2UgJiYgdGhpcy53ZlRhc2tIYW5kbGVyU2VydmljZS5zdGFydFByb2Nlc3MocGF5bG9hZCk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOWtkOihqOaPkOS6pOWuoeaJuVxyXG4gICAqIEBwYXJhbSBiaXpEZWZLZXkg5YWl5Y+j5Y2V5o2uSWRcclxuICAgKiBAcGFyYW0gYml6SWQg5Lia5Yqh5Y2V5o2uSWTvvIjkuLvooajvvIlcclxuICAgKiBAcGFyYW0gY2hpbGRCaXpJZCDkuJrliqHljZXmja5JZO+8iOS7juihqO+8iVxyXG4gICAqIEBwYXJhbSBvcHRpb25zIOS4iuS4i+aWh+WPguaVsFxyXG4gICAqIEBwYXJhbSB2YXJpYWJsZXMg5Y+v6YCJ5Y+C5pWwXHJcbiAgICovXHJcbiAgcHVibGljIGNoaWxkU3VibWl0QXBwcm92ZVdpdGhCaXpEZWZLZXkoYml6RGVmS2V5OiBzdHJpbmcsIGJpeklkOiBzdHJpbmcsIGNoaWxkQml6SWQ6IHN0cmluZywgb3B0aW9uczogYW55ID0ge30sIHZhcmlhYmxlcz86IGFueSk6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICAvLyDlhaXlj6PljZXmja7kuI3og73kuLrnqbpcclxuICAgIGlmICghYml6RGVmS2V5KSB7XHJcbiAgICAgIHRoaXMubm90aWZ5U2VydmljZS53YXJuaW5nKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLmJpekRlZktleVJlcXVpcmVkLCB7IGhpZGVUaXRsZTogdHJ1ZSB9KTtcclxuICAgICAgcmV0dXJuIEVNUFRZO1xyXG4gICAgfVxyXG4gICAgLy8g5Li75Lia5Yqh5Y2V5o2uSWTkuI3og73kuLrnqbpcclxuICAgIGlmICghYml6SWQpIHtcclxuICAgICAgdGhpcy5ub3RpZnlTZXJ2aWNlLndhcm5pbmcodGhpcy5sYW5ndWFnZVNlcnZpY2UudW5hbGxvd0VtcHR5Qml6QmlsbElkLCB7IGhpZGVUaXRsZTogdHJ1ZSB9KTtcclxuICAgICAgcmV0dXJuIEVNUFRZO1xyXG4gICAgfVxyXG4gICAgLy8g5LuO6KGo5Lia5Yqh5Y2V5o2uSWTkuI3og73kuLrnqbpcclxuICAgIGlmICghY2hpbGRCaXpJZCkge1xyXG4gICAgICB0aGlzLm5vdGlmeVNlcnZpY2Uud2FybmluZyh0aGlzLmxhbmd1YWdlU2VydmljZS51bmFsbG93RW1wdHlDaGlsZEJpekJpbGxJZCwgeyBoaWRlVGl0bGU6IHRydWUgfSk7XHJcbiAgICAgIHJldHVybiBFTVBUWTtcclxuICAgIH1cclxuICAgIGlmICghb3B0aW9ucyB8fCB0eXBlb2Ygb3B0aW9ucyAhPT0gJ29iamVjdCcpIHtcclxuICAgICAgb3B0aW9ucyA9IHt9O1xyXG4gICAgfVxyXG4gICAgY29uc3QgcGF5bG9hZDogYW55ID0ge1xyXG4gICAgICBkYXRhSWQ6IGAke2JpeklkfSwke2NoaWxkQml6SWR9YCxcclxuICAgICAgYml6RGVmS2V5LFxyXG4gICAgICAuLi5vcHRpb25zXHJcbiAgICB9O1xyXG4gICAgLy8g5aSE55CGdmFyaWFibGVz5Y+C5pWwXHJcbiAgICBpZiAodmFyaWFibGVzKSB7XHJcbiAgICAgIGlmICh2YXJpYWJsZXMuc3RhcnRzV2l0aCgneycpICYmIHZhcmlhYmxlcy5lbmRzV2l0aCgnfScpKSB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgIHZhcmlhYmxlcyA9IEpTT04ucGFyc2UodmFyaWFibGVzKTtcclxuICAgICAgICB9IGNhdGNoIHtcclxuICAgICAgICAgIGNvbnNvbGUubG9nKCd2YXJpYWJsZXMgcGFyc2UgZmFpbGVkIScpO1xyXG4gICAgICAgICAgdmFyaWFibGVzID0ge307XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIHBheWxvYWQudmFyaWFibGVzID0gdmFyaWFibGVzO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHRoaXMud2ZUYXNrSGFuZGxlclNlcnZpY2UgJiYgdGhpcy53ZlRhc2tIYW5kbGVyU2VydmljZS5zdGFydFByb2Nlc3MocGF5bG9hZCk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOWPlua2iOWuoeaJuVxyXG4gICAqIEBkZXByZWNhdGVkIOW3suW6n+W8g++8jOivt+S9v+eUqGNhbmNlbFN1Ym1pdFxyXG4gICAqL1xyXG4gIHB1YmxpYyBjYW5jZWxBcHByb3ZlKGJpekJpbGxJRDogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIGlmICghYml6QmlsbElEKSB7XHJcbiAgICAgIHRoaXMubm90aWZ5U2VydmljZS53YXJuaW5nKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLnVuYWxsb3dFbXB0eUJpekJpbGxJZCwgeyBoaWRlVGl0bGU6IHRydWUgfSk7XHJcbiAgICAgIHJldHVybiBlbXB0eSgpO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGFjdGlvblVyaSA9ICdjYW5jZWx0b3N1Ym1pdHZvYWN0aW9uJztcclxuXHJcbiAgICBjb25zdCByZXN0U2VydmljZSA9IHRoaXMuYmVBY3Rpb25TZXJ2aWNlLmdldFJlc3RTZXJ2aWNlKCk7XHJcblxyXG4gICAgY29uc3QgYm9keSA9IHtcclxuICAgICAgcmVxdWVzdEluZm86IHJlc3RTZXJ2aWNlLmJ1aWxkUmVxdWVzdEluZm8oKSxcclxuICAgICAgYml6SW5zdElEOiBiaXpCaWxsSUQsXHJcbiAgICB9O1xyXG5cclxuICAgIHRoaXMuZm9ybUxvYWRpbmdTZXJ2aWNlLnNob3coKTtcclxuXHJcbiAgICBjb25zdCBhY3Rpb24kID0gdGhpcy5iZUFjdGlvblNlcnZpY2UuZXhlY3V0ZUFjdGlvbihhY3Rpb25VcmksICdQVVQnLCBudWxsLCBudWxsLCBib2R5KTtcclxuICAgIHJldHVybiBhY3Rpb24kLnBpcGUoXHJcbiAgICAgIHN3aXRjaE1hcCgoKSA9PiB7XHJcbiAgICAgICAgaWYgKHRoaXMucmVwb3NpdG9yeSkge1xyXG4gICAgICAgICAgY29uc3QgdXBkYXRpbmckID0gdGhpcy5yZXBvc2l0b3J5LnVwZGF0ZUJ5SWQoYml6QmlsbElEKTtcclxuICAgICAgICAgIHJldHVybiB1cGRhdGluZyQucGlwZSh0YXAoKCkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLmZvcm1Mb2FkaW5nU2VydmljZS5oaWRlKCk7XHJcbiAgICAgICAgICAgIC8vIHRoaXMubm90aWZ5U2VydmljZS5pbmZvKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLmNhbmNlbEFwcHJvdmVTdWNjZXNzKTtcclxuICAgICAgICAgICAgRm9ybU5vdGlmeVN0cmF0ZWd5U2VydmljZS5zdWNjZXNzKHRoaXMubm90aWZ5U2VydmljZSwgdGhpcy5sYW5ndWFnZVNlcnZpY2UuY2FuY2VsQXBwcm92ZVN1Y2Nlc3MpO1xyXG4gICAgICAgICAgfSkpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICB0aGlzLmZvcm1Mb2FkaW5nU2VydmljZS5oaWRlKCk7XHJcbiAgICAgICAgICAvLyB0aGlzLm5vdGlmeVNlcnZpY2UuaW5mbyh0aGlzLmxhbmd1YWdlU2VydmljZS5jYW5jZWxBcHByb3ZlU3VjY2Vzcyk7XHJcbiAgICAgICAgICBGb3JtTm90aWZ5U3RyYXRlZ3lTZXJ2aWNlLnN1Y2Nlc3ModGhpcy5ub3RpZnlTZXJ2aWNlLCB0aGlzLmxhbmd1YWdlU2VydmljZS5jYW5jZWxBcHByb3ZlU3VjY2Vzcyk7XHJcbiAgICAgICAgICByZXR1cm4gb2YoKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgKSxcclxuICAgICAgY2F0Y2hFcnJvcihlcnJvciA9PiB7XHJcbiAgICAgICAgdGhpcy5mb3JtTG9hZGluZ1NlcnZpY2UuaGlkZSgpO1xyXG4gICAgICAgIC8vIHRoaXMuZm9ybUVycm9yU2VydmljZS5leGNlcHRpb24odGhpcy5sYW5ndWFnZVNlcnZpY2UuY2FuY2VsQXBwcm92ZUZhaWxlZCwgZXJyb3IpO1xyXG4gICAgICAgIHJldHVybiBvZihlcnJvcik7XHJcbiAgICAgIH0pKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5Y+W5raI5a6h5om5KOaUr+aMgeS4u+ihqOOAgeWtkOihqClcclxuICAgKiBAcGFyYW0gcHJvY0luc3RJZCDmtYHnqIvlrp7kvotJZFxyXG4gICAqL1xyXG4gIHB1YmxpYyBjYW5jZWxTdWJtaXQocHJvY0luc3RJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIGlmICghcHJvY0luc3RJZCkge1xyXG4gICAgICB0aGlzLm5vdGlmeVNlcnZpY2Uud2FybmluZyh0aGlzLmxhbmd1YWdlU2VydmljZS5wcm9jSW5zSWRSZXF1aXJlZCwgeyBoaWRlVGl0bGU6IHRydWUgfSk7XHJcbiAgICAgIHJldHVybiBFTVBUWTtcclxuICAgIH1cclxuICAgIHJldHVybiB0aGlzLndmVGFza0hhbmRsZXJTZXJ2aWNlICYmIHRoaXMud2ZUYXNrSGFuZGxlclNlcnZpY2UuY2FuY2VsU3VibWl0KHsgcHJvY0luc3RJZDogcHJvY0luc3RJZCB9KTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5p+l55yL5rWB56iL5Zu+XHJcbiAgICogQHBhcmFtIHByb2NJbnN0SWQg5rWB56iL5a6e5L6LSURcclxuICAgKi9cclxuICB2aWV3UHJvY2Vzcyhwcm9jSW5zdElkOiBzdHJpbmcpIHtcclxuICAgIGlmICh0aGlzLmZsb3djaGFydFNlcnZpY2UpIHtcclxuICAgICAgaWYgKCFwcm9jSW5zdElkKSB7XHJcbiAgICAgICAgdGhpcy5ub3RpZnlTZXJ2aWNlLndhcm5pbmcodGhpcy5sYW5ndWFnZVNlcnZpY2Uubm9Qcm9jZXNzSW5zdGFuY2VJZCwgeyBoaWRlVGl0bGU6IHRydWUgfSk7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiB0aGlzLmZsb3djaGFydFNlcnZpY2Uudmlld0Zsb3dDaGFydChwcm9jSW5zdElkKTtcclxuICAgIH1cclxuICB9XHJcblxyXG5cclxuICAvKipcclxuICAgKiDovazmjaLphY3nva7lpKflsI/lhplcclxuICAgKiBAcGFyYW0ganNvbk9iaiBPYmplY3RcclxuICAgKiBAZGVwcmVjYXRlZFxyXG4gICAqL1xyXG4gIHByaXZhdGUgc3dpdGNoUHJlZml4TGV0dGVyKGpzb25PYmo6IGFueSwgdG9VcHBlcjogYm9vbGVhbik6IGFueSB7XHJcbiAgICBpZiAodHlwZW9mIChqc29uT2JqKSA9PT0gJ29iamVjdCcgJiYgISFqc29uT2JqKSB7XHJcbiAgICAgIGlmIChBcnJheS5pc0FycmF5KGpzb25PYmopKSB7XHJcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBqc29uT2JqLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICB0aGlzLnN3aXRjaFByZWZpeExldHRlcihqc29uT2JqW2ldLCB0b1VwcGVyKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgZm9yIChjb25zdCBrZXkgb2YgT2JqZWN0LmtleXMoanNvbk9iaikpIHtcclxuICAgICAgICAgIHZhciBuZXdLZXkgPSAodG9VcHBlciA/IGtleS5zdWJzdHJpbmcoMCwgMSkudG9VcHBlckNhc2UoKSA6IGtleS5zdWJzdHJpbmcoMCwgMSkudG9Mb3dlckNhc2UoKSkgKyBrZXkuc3Vic3RyaW5nKDEpO1xyXG4gICAgICAgICAganNvbk9ialtuZXdLZXldID0ganNvbk9ialtrZXldO1xyXG4gICAgICAgICAgaWYgKHR5cGVvZiBqc29uT2JqW2tleV0gPT09ICdvYmplY3QnKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc3dpdGNoUHJlZml4TGV0dGVyKGpzb25PYmpba2V5XSwgdG9VcHBlcik7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBkZWxldGUgKGpzb25PYmpba2V5XSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4ganNvbk9iajtcclxuICB9XHJcbn1cclxuZXhwb3J0IHsgQXBwcm92ZVNlcnZpY2UgfTtcclxuIl19