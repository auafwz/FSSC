import * as tslib_1 from "tslib";
import { MetadataUtil } from '../../metadata/index';
import { NG_FIELD, NG_OBJECT, NG_Dynamic, NG_LIST } from './field_decorator';
import { Cacheable, DefaultCacheProvider } from '../../cache';
/**
 * 属性注解器通用方法
 */
var FieldMetadataUtil = /** @class */ (function () {
    function FieldMetadataUtil() {
    }
    /**
     * 获取实体所有的简单属性元数据
     * @param target 实体类型
     * @returns 形如：{[propName: string]: NgObjectProperty}
     */
    FieldMetadataUtil.getNgFields = function (target) {
        return MetadataUtil.getPropsMetadatasByName(target, NG_FIELD);
    };
    /**
     * 获取某个简单属性的元数据
     */
    FieldMetadataUtil.getNgField = function (target, propName) {
        var ngFields = this.getNgFields(target);
        var ngField = ngFields[propName];
        return ngField;
    };
    /**
     * 获取实体属性在原始数据中的属性名
     */
    FieldMetadataUtil.getDataField = function (target, propName) {
        var ngField = this.getNgField(target, propName);
        return ngField.dataField || propName;
    };
    /**
     * 获取标注为NgObject的属性的元数据
     * @param target 实体类型
     * @returns 形如：{[propName: string]: NgObjectProperty}
     */
    FieldMetadataUtil.getNgObjects = function (target) {
        return MetadataUtil.getPropsMetadatasByName(target, NG_OBJECT);
    };
    FieldMetadataUtil.getNgDynamic = function (target) {
        return MetadataUtil.getPropsMetadatasByName(target, NG_Dynamic);
    };
    /**
     * 获取标注为NgList的属性的元数据
     * @param target 实体类型
     * @returns 形如：{[propName: string]: NgListProperty}
     */
    FieldMetadataUtil.getNgList = function (target) {
        return MetadataUtil.getPropsMetadatasByName(target, NG_LIST);
    };
    /**
     * 获取实体标注为主键的属性元数据
     * @param target 实体类型
     */
    FieldMetadataUtil.getPrimaryFieldMetadata = function (target) {
        var ngFieldObj = FieldMetadataUtil.getNgFields(target);
        var primaryKey = Object.keys(ngFieldObj).find(function (prop) {
            return ngFieldObj[prop].primary;
        });
        if (primaryKey) {
            var propMeta = ngFieldObj[primaryKey];
            propMeta.property = primaryKey;
            if (!propMeta.dataField) {
                propMeta.dataField = primaryKey;
            }
            return propMeta;
        }
        return undefined;
    };
    /**
     * 获取主键名称，没有主键时返回空字符串
     */
    FieldMetadataUtil.getPrimaryKey = function (entityType) {
        var primaryNgField = this.getPrimaryFieldMetadata(entityType);
        if (!primaryNgField) {
            return '';
        }
        return primaryNgField.property;
    };
    // static udtMap = {};
    /**
     * 获取NgField 的验证规则元数据
     * @param target 实体类Type
     */
    FieldMetadataUtil.getValidationMetadata = function (target) {
        var fieldMetadatas = FieldMetadataUtil.getNgFields(target);
        // this.udtMap = Object.assign(this.udtMap || {}, FieldMetadataUtil.getNgObjects(target) || {});
        // let udtParentName = '';
        // Object.keys(this.udtMap).forEach(key => {
        //   // 当前实体是udt类型时
        //   if (this.udtMap[key].type.name === target.name) {
        //     // 找出当前udt实体的父级信息
        //     udtParentName = key;
        //   }
        // });
        var metadatas = {};
        // let primaryId = '';
        // let udtPrimaryId = '';
        // 不进行验证的属性名
        // const excludeIDs = [];
        // 排除udt的主键
        // Object.keys(fieldMetadatas).forEach(key => {
        //   if (fieldMetadatas[key].primary || fieldMetadatas[key].foreign) {
        //     primaryId = fieldMetadatas[key].dataField;
        //     udtPrimaryId = fieldMetadatas[key].dataField + '_ID';
        //     excludeIDs.push(fieldMetadatas[key].dataField);
        //   }
        // });
        Object.keys(fieldMetadatas).forEach(function (key) {
            if (fieldMetadatas[key].primary || fieldMetadatas[key].foreign) {
                return;
            }
            var validRules = fieldMetadatas[key].validRules;
            // if (excludeIDs.indexOf(key) > -1) {
            //   return;
            // }
            if (validRules && validRules.length) {
                validRules.map(function (rule) {
                    rule.property = key;
                    rule['targetName'] = target.name;
                });
                metadatas[key] = validRules;
            }
        });
        return metadatas;
    };
    FieldMetadataUtil.getValidationMetadataWithPath = function (object) {
        var target = object.constructor;
        var fieldMetadatas = FieldMetadataUtil.getNgFields(target);
        var parentPaths = object.getPaths().path || [];
        var metadatas = {};
        Object.keys(fieldMetadatas).forEach(function (key) {
            if (fieldMetadatas[key].primary || fieldMetadatas[key].foreign) {
                return;
            }
            var validRules = fieldMetadatas[key].validRules;
            if (validRules && validRules.length) {
                var propertyPath = parentPaths.concat([]);
                propertyPath.push(key);
                var property_1 = propertyPath.join('.');
                validRules.map(function (rule) {
                    rule.property = key;
                    rule['targetName'] = target.name;
                    rule['path'] = property_1;
                });
                metadatas[key] = validRules;
            }
        });
        return metadatas;
    };
    tslib_1.__decorate([
        Cacheable({ key: (function (context, args) { return args[0]; }), provider: new DefaultCacheProvider() }),
        tslib_1.__metadata("design:type", Function),
        tslib_1.__metadata("design:paramtypes", [Object]),
        tslib_1.__metadata("design:returntype", Object)
    ], FieldMetadataUtil, "getNgFields", null);
    tslib_1.__decorate([
        Cacheable({ key: (function (context, args) { return args[0]; }), provider: new DefaultCacheProvider() }),
        tslib_1.__metadata("design:type", Function),
        tslib_1.__metadata("design:paramtypes", [Object]),
        tslib_1.__metadata("design:returntype", Object)
    ], FieldMetadataUtil, "getNgObjects", null);
    tslib_1.__decorate([
        Cacheable({ key: (function (context, args) { return args[0]; }), provider: new DefaultCacheProvider() }),
        tslib_1.__metadata("design:type", Function),
        tslib_1.__metadata("design:paramtypes", [Object]),
        tslib_1.__metadata("design:returntype", Object)
    ], FieldMetadataUtil, "getNgList", null);
    tslib_1.__decorate([
        Cacheable({ key: (function (context, args) { return args[0]; }), provider: new DefaultCacheProvider() }),
        tslib_1.__metadata("design:type", Function),
        tslib_1.__metadata("design:paramtypes", [Object]),
        tslib_1.__metadata("design:returntype", Object)
    ], FieldMetadataUtil, "getPrimaryFieldMetadata", null);
    tslib_1.__decorate([
        Cacheable({ key: (function (context, args) { return args[0]; }), provider: new DefaultCacheProvider() }),
        tslib_1.__metadata("design:type", Function),
        tslib_1.__metadata("design:paramtypes", [Object]),
        tslib_1.__metadata("design:returntype", void 0)
    ], FieldMetadataUtil, "getPrimaryKey", null);
    tslib_1.__decorate([
        Cacheable({ key: (function (context, args) { return args[0]; }), provider: new DefaultCacheProvider() }),
        tslib_1.__metadata("design:type", Function),
        tslib_1.__metadata("design:paramtypes", [Object]),
        tslib_1.__metadata("design:returntype", Object)
    ], FieldMetadataUtil, "getValidationMetadata", null);
    tslib_1.__decorate([
        Cacheable({ key: (function (context, args) { return args[0]; }), provider: new DefaultCacheProvider() }),
        tslib_1.__metadata("design:type", Function),
        tslib_1.__metadata("design:paramtypes", [Object]),
        tslib_1.__metadata("design:returntype", Object)
    ], FieldMetadataUtil, "getValidationMetadataWithPath", null);
    return FieldMetadataUtil;
}());
export { FieldMetadataUtil };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmllbGRfbWV0YWRhdGFfdXRpbC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL2VudGl0eS9tZXRhZGF0YS9maWVsZF9tZXRhZGF0YV91dGlsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDcEQsT0FBTyxFQUNMLFFBQVEsRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFFLE9BQU8sRUFDekMsTUFBTSxtQkFBbUIsQ0FBQztBQUUzQixPQUFPLEVBQUUsU0FBUyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sYUFBYSxDQUFDO0FBRTlEOztHQUVHO0FBQ0g7SUFBQTtJQW1LQSxDQUFDO0lBbEtDOzs7O09BSUc7SUFFSSw2QkFBVyxHQUFsQixVQUFtQixNQUFXO1FBQzVCLE9BQU8sWUFBWSxDQUFDLHVCQUF1QixDQUFDLE1BQU0sRUFBRSxRQUFRLENBQUMsQ0FBQztJQUNoRSxDQUFDO0lBRUQ7O09BRUc7SUFDSSw0QkFBVSxHQUFqQixVQUFrQixNQUFXLEVBQUUsUUFBZ0I7UUFDN0MsSUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUMxQyxJQUFNLE9BQU8sR0FBRyxRQUFRLENBQUMsUUFBUSxDQUFvQixDQUFDO1FBQ3RELE9BQU8sT0FBTyxDQUFDO0lBQ2pCLENBQUM7SUFFRDs7T0FFRztJQUNJLDhCQUFZLEdBQW5CLFVBQW9CLE1BQVcsRUFBRSxRQUFnQjtRQUMvQyxJQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sRUFBRSxRQUFRLENBQUMsQ0FBQztRQUNsRCxPQUFPLE9BQU8sQ0FBQyxTQUFTLElBQUksUUFBUSxDQUFDO0lBQ3ZDLENBQUM7SUFFRDs7OztPQUlHO0lBRUksOEJBQVksR0FBbkIsVUFBb0IsTUFBVztRQUM3QixPQUFPLFlBQVksQ0FBQyx1QkFBdUIsQ0FB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VUFBQyxPQUFZLEVBQUUsSUFBVyxJQUFLLE9BQUEsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFQLENBQU8sQ0FBQyxFQUFFLFFBQVEsRUFBRSxJQUFJLG9CQUFvQixFQUFFLEVBQUUsQ0FBQzs7Ozt3REEwQ25HO0lBRUQ7UUFEQyxTQUFTLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQyxVQUFDLE9BQVksRUFBRSxJQUFXLElBQUssT0FBQSxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQVAsQ0FBTyxDQUFDLEVBQUUsUUFBUSxFQUFFLElBQUksb0JBQW9CLEVBQUUsRUFBRSxDQUFDOzs7O2dFQTBCbEc7SUFDSCx3QkFBQztDQUFBLEFBbktELElBbUtDO1NBbktZLGlCQUFpQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE1ldGFkYXRhVXRpbCB9IGZyb20gJy4uLy4uL21ldGFkYXRhL2luZGV4JztcclxuaW1wb3J0IHtcclxuICBOR19GSUVMRCwgTkdfT0JKRUNULCBOR19EeW5hbWljLCBOR19MSVNULCBOZ0ZpZWxkUHJvcGVydHksIE5nT2JqZWN0UHJvcGVydHksIE5nTGlzdFByb3BlcnR5XHJcbn0gZnJvbSAnLi9maWVsZF9kZWNvcmF0b3InO1xyXG5pbXBvcnQgeyBWYWxpZGF0ZVJ1bGUgfSBmcm9tICcuLi92YWxpZGF0b3IvdHlwZXMnO1xyXG5pbXBvcnQgeyBDYWNoZWFibGUsIERlZmF1bHRDYWNoZVByb3ZpZGVyIH0gZnJvbSAnLi4vLi4vY2FjaGUnO1xyXG5cclxuLyoqXHJcbiAqIOWxnuaAp+azqOino+WZqOmAmueUqOaWueazlVxyXG4gKi9cclxuZXhwb3J0IGNsYXNzIEZpZWxkTWV0YWRhdGFVdGlsIHtcclxuICAvKipcclxuICAgKiDojrflj5blrp7kvZPmiYDmnInnmoTnroDljZXlsZ7mgKflhYPmlbDmja5cclxuICAgKiBAcGFyYW0gdGFyZ2V0IOWunuS9k+exu+Wei1xyXG4gICAqIEByZXR1cm5zIOW9ouWmgu+8mntbcHJvcE5hbWU6IHN0cmluZ106IE5nT2JqZWN0UHJvcGVydHl9XHJcbiAgICovXHJcbiAgQENhY2hlYWJsZSh7IGtleTogKChjb250ZXh0OiBhbnksIGFyZ3M6IGFueVtdKSA9PiBhcmdzWzBdKSwgcHJvdmlkZXI6IG5ldyBEZWZhdWx0Q2FjaGVQcm92aWRlcigpIH0pXHJcbiAgc3RhdGljIGdldE5nRmllbGRzKHRhcmdldDogYW55KTogeyBbcHJvcE5hbWU6IHN0cmluZ106IE5nRmllbGRQcm9wZXJ0eSB9IHtcclxuICAgIHJldHVybiBNZXRhZGF0YVV0aWwuZ2V0UHJvcHNNZXRhZGF0YXNCeU5hbWUodGFyZ2V0LCBOR19GSUVMRCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDojrflj5bmn5DkuKrnroDljZXlsZ7mgKfnmoTlhYPmlbDmja5cclxuICAgKi9cclxuICBzdGF0aWMgZ2V0TmdGaWVsZCh0YXJnZXQ6IGFueSwgcHJvcE5hbWU6IHN0cmluZyk6IE5nRmllbGRQcm9wZXJ0eSB7XHJcbiAgICBjb25zdCBuZ0ZpZWxkcyA9IHRoaXMuZ2V0TmdGaWVsZHModGFyZ2V0KTtcclxuICAgIGNvbnN0IG5nRmllbGQgPSBuZ0ZpZWxkc1twcm9wTmFtZV0gYXMgTmdGaWVsZFByb3BlcnR5O1xyXG4gICAgcmV0dXJuIG5nRmllbGQ7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDojrflj5blrp7kvZPlsZ7mgKflnKjljp/lp4vmlbDmja7kuK3nmoTlsZ7mgKflkI1cclxuICAgKi9cclxuICBzdGF0aWMgZ2V0RGF0YUZpZWxkKHRhcmdldDogYW55LCBwcm9wTmFtZTogc3RyaW5nKSB7XHJcbiAgICBjb25zdCBuZ0ZpZWxkID0gdGhpcy5nZXROZ0ZpZWxkKHRhcmdldCwgcHJvcE5hbWUpO1xyXG4gICAgcmV0dXJuIG5nRmllbGQuZGF0YUZpZWxkIHx8IHByb3BOYW1lO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6I635Y+W5qCH5rOo5Li6TmdPYmplY3TnmoTlsZ7mgKfnmoTlhYPmlbDmja5cclxuICAgKiBAcGFyYW0gdGFyZ2V0IOWunuS9k+exu+Wei1xyXG4gICAqIEByZXR1cm5zIOW9ouWmgu+8mntbcHJvcE5hbWU6IHN0cmluZ106IE5nT2JqZWN0UHJvcGVydHl9XHJcbiAgICovXHJcbiAgQENhY2hlYWJsZSh7IGtleTogKChjb250ZXh0OiBhbnksIGFyZ3M6IGFueVtdKSA9PiBhcmdzWzBdKSwgcHJvdmlkZXI6IG5ldyBEZWZhdWx0Q2FjaGVQcm92aWRlcigpIH0pXHJcbiAgc3RhdGljIGdldE5nT2JqZWN0cyh0YXJnZXQ6IGFueSk6IHsgW3Byb3BOYW1lOiBzdHJpbmddOiBOZ09iamVjdFByb3BlcnR5IH0ge1xyXG4gICAgcmV0dXJuIE1ldGFkYXRhVXRpbC5nZXRQcm9wc01ldGFkYXRhc0J5TmFtZSh0YXJnZXQsIE5HX09CSkVDVCk7XHJcbiAgfVxyXG5cclxuICBzdGF0aWMgZ2V0TmdEeW5hbWljKHRhcmdldDogYW55KTogeyBbcHJvcE5hbWU6IHN0cmluZ106IE5nT2JqZWN0UHJvcGVydHkgfSB7XHJcbiAgICByZXR1cm4gTWV0YWRhdGFVdGlsLmdldFByb3BzTWV0YWRhdGFzQnlOYW1lKHRhcmdldCwgTkdfRHluYW1pYyk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDojrflj5bmoIfms6jkuLpOZ0xpc3TnmoTlsZ7mgKfnmoTlhYPmlbDmja5cclxuICAgKiBAcGFyYW0gdGFyZ2V0IOWunuS9k+exu+Wei1xyXG4gICAqIEByZXR1cm5zIOW9ouWmgu+8mntbcHJvcE5hbWU6IHN0cmluZ106IE5nTGlzdFByb3BlcnR5fVxyXG4gICAqL1xyXG4gIEBDYWNoZWFibGUoeyBrZXk6ICgoY29udGV4dDogYW55LCBhcmdzOiBhbnlbXSkgPT4gYXJnc1swXSksIHByb3ZpZGVyOiBuZXcgRGVmYXVsdENhY2hlUHJvdmlkZXIoKSB9KVxyXG4gIHN0YXRpYyBnZXROZ0xpc3QodGFyZ2V0OiBhbnkpOiB7IFtwcm9wTmFtZTogc3RyaW5nXTogTmdMaXN0UHJvcGVydHkgfSB7XHJcbiAgICByZXR1cm4gTWV0YWRhdGFVdGlsLmdldFByb3BzTWV0YWRhdGFzQnlOYW1lKHRhcmdldCwgTkdfTElTVCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDojrflj5blrp7kvZPmoIfms6jkuLrkuLvplK7nmoTlsZ7mgKflhYPmlbDmja5cclxuICAgKiBAcGFyYW0gdGFyZ2V0IOWunuS9k+exu+Wei1xyXG4gICAqL1xyXG4gIEBDYWNoZWFibGUoeyBrZXk6ICgoY29udGV4dDogYW55LCBhcmdzOiBhbnlbXSkgPT4gYXJnc1swXSksIHByb3ZpZGVyOiBuZXcgRGVmYXVsdENhY2hlUHJvdmlkZXIoKSB9KVxyXG4gIHN0YXRpYyBnZXRQcmltYXJ5RmllbGRNZXRhZGF0YSh0YXJnZXQ6IGFueSk6IE5nRmllbGRQcm9wZXJ0eSB8IHVuZGVmaW5lZCB7XHJcbiAgICBjb25zdCBuZ0ZpZWxkT2JqID0gRmllbGRNZXRhZGF0YVV0aWwuZ2V0TmdGaWVsZHModGFyZ2V0KTtcclxuICAgIGNvbnN0IHByaW1hcnlLZXkgPSBPYmplY3Qua2V5cyhuZ0ZpZWxkT2JqKS5maW5kKChwcm9wOiBzdHJpbmcpID0+IHtcclxuICAgICAgcmV0dXJuIG5nRmllbGRPYmpbcHJvcF0ucHJpbWFyeTtcclxuICAgIH0pO1xyXG5cclxuICAgIGlmIChwcmltYXJ5S2V5KSB7XHJcbiAgICAgIGNvbnN0IHByb3BNZXRhID0gbmdGaWVsZE9ialtwcmltYXJ5S2V5XTtcclxuICAgICAgcHJvcE1ldGEucHJvcGVydHkgPSBwcmltYXJ5S2V5O1xyXG4gICAgICBpZiAoIXByb3BNZXRhLmRhdGFGaWVsZCkge1xyXG4gICAgICAgIHByb3BNZXRhLmRhdGFGaWVsZCA9IHByaW1hcnlLZXk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHJldHVybiBwcm9wTWV0YTtcclxuICAgIH1cclxuICAgIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDojrflj5bkuLvplK7lkI3np7DvvIzmsqHmnInkuLvplK7ml7bov5Tlm57nqbrlrZfnrKbkuLJcclxuICAgKi9cclxuICBAQ2FjaGVhYmxlKHsga2V5OiAoKGNvbnRleHQ6IGFueSwgYXJnczogYW55W10pID0+IGFyZ3NbMF0pLCBwcm92aWRlcjogbmV3IERlZmF1bHRDYWNoZVByb3ZpZGVyKCkgfSlcclxuICBzdGF0aWMgZ2V0UHJpbWFyeUtleShlbnRpdHlUeXBlOiBhbnkpIHtcclxuICAgIGNvbnN0IHByaW1hcnlOZ0ZpZWxkID0gdGhpcy5nZXRQcmltYXJ5RmllbGRNZXRhZGF0YShlbnRpdHlUeXBlKTtcclxuICAgIGlmICghcHJpbWFyeU5nRmllbGQpIHtcclxuICAgICAgcmV0dXJuICcnO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHByaW1hcnlOZ0ZpZWxkLnByb3BlcnR5O1xyXG4gIH1cclxuXHJcbiAgLy8gc3RhdGljIHVkdE1hcCA9IHt9O1xyXG5cclxuICAvKipcclxuICAgKiDojrflj5ZOZ0ZpZWxkIOeahOmqjOivgeinhOWImeWFg+aVsOaNrlxyXG4gICAqIEBwYXJhbSB0YXJnZXQg5a6e5L2T57G7VHlwZVxyXG4gICAqL1xyXG4gICBAQ2FjaGVhYmxlKHsga2V5OiAoKGNvbnRleHQ6IGFueSwgYXJnczogYW55W10pID0+IGFyZ3NbMF0pLCBwcm92aWRlcjogbmV3IERlZmF1bHRDYWNoZVByb3ZpZGVyKCkgfSlcclxuICBzdGF0aWMgZ2V0VmFsaWRhdGlvbk1ldGFkYXRhKHRhcmdldDogYW55KTogeyBba2V5OiBzdHJpbmddOiBWYWxpZGF0ZVJ1bGVbXSB9IHtcclxuICAgIGNvbnN0IGZpZWxkTWV0YWRhdGFzID0gRmllbGRNZXRhZGF0YVV0aWwuZ2V0TmdGaWVsZHModGFyZ2V0KTtcclxuICAgIC8vIHRoaXMudWR0TWFwID0gT2JqZWN0LmFzc2lnbih0aGlzLnVkdE1hcCB8fCB7fSwgRmllbGRNZXRhZGF0YVV0aWwuZ2V0TmdPYmplY3RzKHRhcmdldCkgfHwge30pO1xyXG4gICAgLy8gbGV0IHVkdFBhcmVudE5hbWUgPSAnJztcclxuICAgIC8vIE9iamVjdC5rZXlzKHRoaXMudWR0TWFwKS5mb3JFYWNoKGtleSA9PiB7XHJcbiAgICAvLyAgIC8vIOW9k+WJjeWunuS9k+aYr3VkdOexu+Wei+aXtlxyXG4gICAgLy8gICBpZiAodGhpcy51ZHRNYXBba2V5XS50eXBlLm5hbWUgPT09IHRhcmdldC5uYW1lKSB7XHJcbiAgICAvLyAgICAgLy8g5om+5Ye65b2T5YmNdWR05a6e5L2T55qE54i257qn5L+h5oGvXHJcbiAgICAvLyAgICAgdWR0UGFyZW50TmFtZSA9IGtleTtcclxuICAgIC8vICAgfVxyXG4gICAgLy8gfSk7XHJcbiAgICBjb25zdCBtZXRhZGF0YXM6IHsgW2tleTogc3RyaW5nXTogVmFsaWRhdGVSdWxlW10gfSA9IHt9O1xyXG4gICAgLy8gbGV0IHByaW1hcnlJZCA9ICcnO1xyXG4gICAgLy8gbGV0IHVkdFByaW1hcnlJZCA9ICcnO1xyXG4gICAgLy8g5LiN6L+b6KGM6aqM6K+B55qE5bGe5oCn5ZCNXHJcbiAgICAvLyBjb25zdCBleGNsdWRlSURzID0gW107XHJcbiAgICAvLyDmjpLpmaR1ZHTnmoTkuLvplK5cclxuICAgIC8vIE9iamVjdC5rZXlzKGZpZWxkTWV0YWRhdGFzKS5mb3JFYWNoKGtleSA9PiB7XHJcbiAgICAvLyAgIGlmIChmaWVsZE1ldGFkYXRhc1trZXldLnByaW1hcnkgfHwgZmllbGRNZXRhZGF0YXNba2V5XS5mb3JlaWduKSB7XHJcbiAgICAvLyAgICAgcHJpbWFyeUlkID0gZmllbGRNZXRhZGF0YXNba2V5XS5kYXRhRmllbGQ7XHJcbiAgICAvLyAgICAgdWR0UHJpbWFyeUlkID0gZmllbGRNZXRhZGF0YXNba2V5XS5kYXRhRmllbGQgKyAnX0lEJztcclxuICAgIC8vICAgICBleGNsdWRlSURzLnB1c2goZmllbGRNZXRhZGF0YXNba2V5XS5kYXRhRmllbGQpO1xyXG4gICAgLy8gICB9XHJcbiAgICAvLyB9KTtcclxuICAgIE9iamVjdC5rZXlzKGZpZWxkTWV0YWRhdGFzKS5mb3JFYWNoKGtleSA9PiB7XHJcbiAgICAgIGlmIChmaWVsZE1ldGFkYXRhc1trZXldLnByaW1hcnkgfHwgZmllbGRNZXRhZGF0YXNba2V5XS5mb3JlaWduKSB7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcbiAgICAgIGNvbnN0IHZhbGlkUnVsZXMgPSBmaWVsZE1ldGFkYXRhc1trZXldLnZhbGlkUnVsZXM7XHJcbiAgICAgIC8vIGlmIChleGNsdWRlSURzLmluZGV4T2Yoa2V5KSA+IC0xKSB7XHJcbiAgICAgIC8vICAgcmV0dXJuO1xyXG4gICAgICAvLyB9XHJcbiAgICAgIGlmICh2YWxpZFJ1bGVzICYmIHZhbGlkUnVsZXMubGVuZ3RoKSB7XHJcbiAgICAgICAgdmFsaWRSdWxlcy5tYXAocnVsZSA9PiB7XHJcbiAgICAgICAgICBydWxlLnByb3BlcnR5ID0ga2V5O1xyXG4gICAgICAgICAgcnVsZVsndGFyZ2V0TmFtZSddID0gdGFyZ2V0Lm5hbWU7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgbWV0YWRhdGFzW2tleV0gPSB2YWxpZFJ1bGVzO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICAgIHJldHVybiBtZXRhZGF0YXM7XHJcbiAgfVxyXG4gIEBDYWNoZWFibGUoeyBrZXk6ICgoY29udGV4dDogYW55LCBhcmdzOiBhbnlbXSkgPT4gYXJnc1swXSksIHByb3ZpZGVyOiBuZXcgRGVmYXVsdENhY2hlUHJvdmlkZXIoKSB9KVxyXG4gIHN0YXRpYyBnZXRWYWxpZGF0aW9uTWV0YWRhdGFXaXRoUGF0aChvYmplY3Q6IGFueSk6IHsgW2tleTogc3RyaW5nXTogVmFsaWRhdGVSdWxlW10gfSB7XHJcbiAgICBjb25zdCB0YXJnZXQgPSBvYmplY3QuY29uc3RydWN0b3I7XHJcbiAgICBjb25zdCBmaWVsZE1ldGFkYXRhcyA9IEZpZWxkTWV0YWRhdGFVdGlsLmdldE5nRmllbGRzKHRhcmdldCk7XHJcbiAgICBjb25zdCBwYXJlbnRQYXRocyA9IG9iamVjdC5nZXRQYXRocygpLnBhdGggfHwgW107XHJcbiAgICBjb25zdCBtZXRhZGF0YXM6IHsgW2tleTogc3RyaW5nXTogVmFsaWRhdGVSdWxlW10gfSA9IHt9O1xyXG5cclxuICAgIE9iamVjdC5rZXlzKGZpZWxkTWV0YWRhdGFzKS5mb3JFYWNoKGtleSA9PiB7XHJcbiAgICAgIGlmIChmaWVsZE1ldGFkYXRhc1trZXldLnByaW1hcnkgfHwgZmllbGRNZXRhZGF0YXNba2V5XS5mb3JlaWduKSB7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcbiAgICAgIGNvbnN0IHZhbGlkUnVsZXMgPSBmaWVsZE1ldGFkYXRhc1trZXldLnZhbGlkUnVsZXM7XHJcblxyXG4gICAgICBpZiAodmFsaWRSdWxlcyAmJiB2YWxpZFJ1bGVzLmxlbmd0aCkge1xyXG4gICAgICAgIGNvbnN0IHByb3BlcnR5UGF0aCA9IHBhcmVudFBhdGhzLmNvbmNhdChbXSk7XHJcbiAgICAgICAgcHJvcGVydHlQYXRoLnB1c2goa2V5KTtcclxuICAgICAgICBjb25zdCBwcm9wZXJ0eSA9IHByb3BlcnR5UGF0aC5qb2luKCcuJyk7XHJcbiAgICAgICAgdmFsaWRSdWxlcy5tYXAocnVsZSA9PiB7XHJcbiAgICAgICAgICBydWxlLnByb3BlcnR5ID0ga2V5O1xyXG4gICAgICAgICAgcnVsZVsndGFyZ2V0TmFtZSddID0gdGFyZ2V0Lm5hbWU7XHJcbiAgICAgICAgICBydWxlWydwYXRoJ10gPSBwcm9wZXJ0eTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBtZXRhZGF0YXNba2V5XSA9IHZhbGlkUnVsZXM7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIG1ldGFkYXRhcztcclxuICB9XHJcbn1cclxuIl19