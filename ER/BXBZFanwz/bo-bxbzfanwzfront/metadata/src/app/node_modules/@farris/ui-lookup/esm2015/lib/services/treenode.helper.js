/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
export class TreeNodeHelper {
    /**
     * @param {?} instance
     */
    constructor(instance) {
        this.instance = instance;
        this.flatAllNodes = [];
    }
    /**
     * @param {?} treeNode
     * @return {?}
     */
    getTreeInfo(treeNode) {
        if (treeNode.data[this.treeInfo.dataField]) {
            return treeNode.data[this.treeInfo.dataField];
        }
        /** @type {?} */
        const data = treeNode.data;
        if (data && this.treeInfo.dataField) {
            /** @type {?} */
            const treeInfoDataField = this.treeInfo.dataField.toLowerCase();
            /** @type {?} */
            const dataField = Object.keys(treeNode.data).find((/**
             * @param {?} n
             * @return {?}
             */
            n => {
                return n.toLowerCase() === treeInfoDataField;
            }));
            if (dataField) {
                return data[dataField];
            }
            else {
                console.error(`未找到树形信息数据字段【${this.treeInfo.dataField}】`);
            }
        }
        else {
            console.error(`未找到树形信息数据字段【${this.treeInfo.dataField}】`);
        }
    }
    /**
     * @param {?} treeNode
     * @return {?}
     */
    getTreeNodeLayer(treeNode) {
        return this.getTreeInfo(treeNode)[this.treeInfo.layerField];
    }
    /**
     * 更新节点的展开状态。 根据组件中 expandLevel 的值决定
     * -1：不展开，0：全部展开，>0 展开到指定级数
     * @param {?} treeNodes
     * @param {?=} treeInfo
     * @return {?}
     */
    updateTreeNodeExpanded(treeNodes, treeInfo = null) {
        if (treeInfo) {
            this.treeInfo = treeInfo;
        }
        else {
            this.treeInfo = this.instance.treeInfo;
        }
        /** @type {?} */
        const expandLevel = this.instance.expandLevel;
        if (expandLevel === -1) {
            return;
        }
        if (!this.flatAllNodes.length) {
            this.flatAllNodes = this.treeData2Flat(null, treeNodes, 0, []);
        }
        treeNodes.forEach((/**
         * @param {?} tn
         * @return {?}
         */
        (tn) => {
            tn.expanded = this.shoudExpand(expandLevel, this.getTreeNodeLayer(tn));
            if (this.isSelectNodeParent(tn)) {
                tn.expanded = true;
            }
            if (tn.children && tn.children.length) {
                this.updateTreeNodeExpanded(tn.children, treeInfo);
            }
            else {
                tn.leaf = true;
            }
        }));
    }
    /**
     * @private
     * @param {?} parent
     * @param {?} nodes
     * @param {?} level
     * @param {?} parentIds
     * @return {?}
     */
    treeData2Flat(parent, nodes, level, parentIds) {
        /** @type {?} */
        const idField = this.instance.idField;
        /** @type {?} */
        let arr = [];
        if (nodes && nodes.length) {
            nodes.forEach((/**
             * @param {?} node
             * @param {?} index
             * @return {?}
             */
            (node, index) => {
                // node.parent = parent;
                // node.parent = parent;
                /** @type {?} */
                let parents = [];
                if (parent) {
                    /** @type {?} */
                    const parentID = parent.data[idField];
                    /** @type {?} */
                    const _parents = parentIds || [];
                    parents = parents.concat(_parents.map((/**
                     * @param {?} n
                     * @return {?}
                     */
                    n => n)));
                    parents.push(parentID);
                }
                /** @type {?} */
                const rowNode = {
                    id: node.data[idField],
                    node,
                    level,
                    parents,
                };
                arr.push(rowNode);
                arr = arr.concat(this.treeData2Flat(node, node.children, level + 1, parents));
            }));
        }
        return arr;
    }
    /**
     * @private
     * @param {?} expandLevel
     * @param {?} nodeLayer
     * @return {?}
     */
    shoudExpand(expandLevel, nodeLayer) {
        if (expandLevel === -1) {
            // -1 为不展开
            return false;
        }
        else if (expandLevel === 0) {
            // 0 为全部展开
            return true;
        }
        else {
            // 没有启用分层加载，通过展开层级确定是否展开该节点
            return nodeLayer <= expandLevel;
        }
    }
    /**
     * @private
     * @param {?} treeNode
     * @return {?}
     */
    isSelectNodeParent(treeNode) {
        if (this.instance.navSelectedIds) {
            /** @type {?} */
            const allParentIds = this.flatAllNodes.find((/**
             * @param {?} f
             * @return {?}
             */
            f => f.id === this.instance.navSelectedIds)).parents;
            if (allParentIds && allParentIds.length) {
                return allParentIds.includes(treeNode.id);
            }
            return false;
        }
        return false;
    }
    /**
     * @param {?} treeNode
     * @return {?}
     */
    getLeafNode(treeNode) {
        if (treeNode && (!treeNode.children || !treeNode.children.length)) {
            return treeNode;
        }
        else {
            if (treeNode.children.length === 1) {
                return this.getLeafNode(treeNode.children[0]);
            }
            else {
                return treeNode.children;
            }
        }
    }
    /**
     * @param {?} items
     * @param {?=} result
     * @return {?}
     */
    flatTreeNodes(items, result = []) {
        items = items || [];
        return items.reduce((/**
         * @param {?} c
         * @param {?} n
         * @return {?}
         */
        (c, n) => {
            c.push(n);
            if (n.children && n.children.length) {
                this.flatTreeNodes(n.children, c);
            }
            return c;
        }), result);
    }
}
if (false) {
    /** @type {?} */
    TreeNodeHelper.prototype.treeInfo;
    /** @type {?} */
    TreeNodeHelper.prototype.flatAllNodes;
    /**
     * @type {?}
     * @private
     */
    TreeNodeHelper.prototype.instance;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJlZW5vZGUuaGVscGVyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy91aS1sb29rdXAvIiwic291cmNlcyI6WyJsaWIvc2VydmljZXMvdHJlZW5vZGUuaGVscGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFJQSxNQUFNLE9BQU8sY0FBYzs7OztJQUd2QixZQUFvQixRQUE2QjtRQUE3QixhQUFRLEdBQVIsUUFBUSxDQUFxQjtRQURqRCxpQkFBWSxHQUFHLEVBQUUsQ0FBQztJQUNtQyxDQUFDOzs7OztJQUV0RCxXQUFXLENBQUMsUUFBa0I7UUFDMUIsSUFBSSxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLEVBQUU7WUFDeEMsT0FBTyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLENBQUM7U0FDakQ7O2NBRUssSUFBSSxHQUFHLFFBQVEsQ0FBQyxJQUFJO1FBQzFCLElBQUksSUFBSSxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxFQUFFOztrQkFFM0IsaUJBQWlCLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsV0FBVyxFQUFFOztrQkFDekQsU0FBUyxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUk7Ozs7WUFBQyxDQUFDLENBQUMsRUFBRTtnQkFDbEQsT0FBTyxDQUFDLENBQUMsV0FBVyxFQUFFLEtBQUssaUJBQWlCLENBQUM7WUFDakQsQ0FBQyxFQUFDO1lBQ0YsSUFBSSxTQUFTLEVBQUU7Z0JBQ1gsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7YUFDMUI7aUJBQU07Z0JBQ0gsT0FBTyxDQUFDLEtBQUssQ0FBQyxlQUFlLElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxHQUFHLENBQUMsQ0FBQzthQUM1RDtTQUNKO2FBQU07WUFDSCxPQUFPLENBQUMsS0FBSyxDQUFD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Q0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7YUFDakQ7aUJBQU07Z0JBQ0gsT0FBTyxRQUFRLENBQUMsUUFBUSxDQUFDO2FBQzVCO1NBQ0o7SUFDTCxDQUFDOzs7Ozs7SUFFRCxhQUFhLENBQUMsS0FBSyxFQUFFLE1BQU0sR0FBRyxFQUFFO1FBQzVCLEtBQUssR0FBRyxLQUFLLElBQUksRUFBRSxDQUFDO1FBQ3BCLE9BQVEsS0FBSyxDQUFDLE1BQU07Ozs7O1FBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDMUIsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNWLElBQUksQ0FBQyxDQUFDLFFBQVEsSUFBSSxDQUFDLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFBRTtnQkFDakMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQyxDQUFDO2FBQ3JDO1lBQ0QsT0FBTyxDQUFDLENBQUM7UUFDYixDQUFDLEdBQUUsTUFBTSxDQUFDLENBQUM7SUFDZixDQUFDO0NBQ0o7OztJQXJJRyxrQ0FBbUI7O0lBQ25CLHNDQUFrQjs7Ozs7SUFDTixrQ0FBcUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBUcmVlTm9kZSB9IGZyb20gJ0BmYXJyaXMvdWktdHJlZXRhYmxlJztcclxuaW1wb3J0IHsgTG9va3VwR3JpZENvbXBvbmVudCB9IGZyb20gJy4uL2xvb2t1cC1ncmlkLmNvbXBvbmVudCc7XHJcbmltcG9ydCB7IFRyZWVJbmZvIH0gZnJvbSAnLi4vbG9va3VwLWdyaWQtb3B0aW9ucyc7XHJcblxyXG5leHBvcnQgY2xhc3MgVHJlZU5vZGVIZWxwZXIge1xyXG4gICAgdHJlZUluZm86IFRyZWVJbmZvO1xyXG4gICAgZmxhdEFsbE5vZGVzID0gW107XHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGluc3RhbmNlOiBMb29rdXBHcmlkQ29tcG9uZW50KSB7IH1cclxuXHJcbiAgICBnZXRUcmVlSW5mbyh0cmVlTm9kZTogVHJlZU5vZGUpIHtcclxuICAgICAgICBpZiAodHJlZU5vZGUuZGF0YVt0aGlzLnRyZWVJbmZvLmRhdGFGaWVsZF0pIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRyZWVOb2RlLmRhdGFbdGhpcy50cmVlSW5mby5kYXRhRmllbGRdO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgZGF0YSA9IHRyZWVOb2RlLmRhdGE7XHJcbiAgICAgICAgaWYgKGRhdGEgJiYgdGhpcy50cmVlSW5mby5kYXRhRmllbGQpIHtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IHRyZWVJbmZvRGF0YUZpZWxkID0gdGhpcy50cmVlSW5mby5kYXRhRmllbGQudG9Mb3dlckNhc2UoKTtcclxuICAgICAgICAgICAgY29uc3QgZGF0YUZpZWxkID0gT2JqZWN0LmtleXModHJlZU5vZGUuZGF0YSkuZmluZChuID0+IHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBuLnRvTG93ZXJDYXNlKCkgPT09IHRyZWVJbmZvRGF0YUZpZWxkO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgaWYgKGRhdGFGaWVsZCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGRhdGFbZGF0YUZpZWxkXTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYOacquaJvuWIsOagkeW9ouS/oeaBr+aVsOaNruWtl+auteOAkCR7dGhpcy50cmVlSW5mby5kYXRhRmllbGR944CRYCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKGDmnKrmib7liLDmoJHlvaLkv6Hmga/mlbDmja7lrZfmrrXjgJAke3RoaXMudHJlZUluZm8uZGF0YUZpZWxkfeOAkWApO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBnZXRUcmVlTm9kZUxheWVyKHRyZWVOb2RlOiBUcmVlTm9kZSkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmdldFRyZWVJbmZvKHRyZWVOb2RlKVt0aGlzLnRyZWVJbmZvLmxheWVyRmllbGRdO1xyXG4gICAgfVxyXG4gICAgLyoqIOabtOaWsOiKgueCueeahOWxleW8gOeKtuaAgeOAgiDmoLnmja7nu4Tku7bkuK0gZXhwYW5kTGV2ZWwg55qE5YC85Yaz5a6aXHJcbiAgICAgKiAtMe+8muS4jeWxleW8gO+8jDDvvJrlhajpg6jlsZXlvIDvvIw+MCDlsZXlvIDliLDmjIflrprnuqfmlbBcclxuICAgICAqL1xyXG4gICAgdXBkYXRlVHJlZU5vZGVFeHBhbmRlZCh0cmVlTm9kZXM6IFRyZWVOb2RlW10sIHRyZWVJbmZvOiBUcmVlSW5mbyA9IG51bGwpIHtcclxuICAgICAgICBpZiAodHJlZUluZm8pIHtcclxuICAgICAgICAgICAgdGhpcy50cmVlSW5mbyA9IHRyZWVJbmZvO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMudHJlZUluZm8gPSB0aGlzLmluc3RhbmNlLnRyZWVJbmZvO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBleHBhbmRMZXZlbCA9IHRoaXMuaW5zdGFuY2UuZXhwYW5kTGV2ZWw7XHJcbiAgICAgICAgaWYgKGV4cGFuZExldmVsID09PSAtMSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICghdGhpcy5mbGF0QWxsTm9kZXMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZmxhdEFsbE5vZGVzID0gdGhpcy50cmVlRGF0YTJGbGF0KG51bGwsIHRyZWVOb2RlcywgMCwgW10pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdHJlZU5vZGVzLmZvckVhY2goKHRuOiBUcmVlTm9kZSkgPT4ge1xyXG4gICAgICAgICAgICB0bi5leHBhbmRlZCA9IHRoaXMuc2hvdWRFeHBhbmQoZXhwYW5kTGV2ZWwsIHRoaXMuZ2V0VHJlZU5vZGVMYXllcih0bikpO1xyXG4gICAgICAgICAgICBpZiAodGhpcy5pc1NlbGVjdE5vZGVQYXJlbnQodG4pKSB7XHJcbiAgICAgICAgICAgICAgICB0bi5leHBhbmRlZCA9IHRydWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKHRuLmNoaWxkcmVuICYmIHRuLmNoaWxkcmVuLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy51cGRhdGVUcmVlTm9kZUV4cGFuZGVkKHRuLmNoaWxkcmVuLCB0cmVlSW5mbyk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0bi5sZWFmID0gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgdHJlZURhdGEyRmxhdChwYXJlbnQsIG5vZGVzLCBsZXZlbCwgcGFyZW50SWRzKSB7XHJcbiAgICAgICAgY29uc3QgaWRGaWVsZCA9IHRoaXMuaW5zdGFuY2UuaWRGaWVsZDtcclxuICAgICAgICBsZXQgYXJyID0gW107XHJcbiAgICAgICAgaWYgKG5vZGVzICYmIG5vZGVzLmxlbmd0aCkge1xyXG5cclxuICAgICAgICAgICAgbm9kZXMuZm9yRWFjaCgobm9kZSwgaW5kZXgpID0+IHtcclxuICAgICAgICAgICAgICAgIC8vIG5vZGUucGFyZW50ID0gcGFyZW50O1xyXG5cclxuICAgICAgICAgICAgICAgIGxldCBwYXJlbnRzID0gW107XHJcbiAgICAgICAgICAgICAgICBpZiAocGFyZW50KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcGFyZW50SUQgPSBwYXJlbnQuZGF0YVtpZEZpZWxkXTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBfcGFyZW50cyA9IHBhcmVudElkcyB8fCBbXTtcclxuICAgICAgICAgICAgICAgICAgICBwYXJlbnRzID0gcGFyZW50cy5jb25jYXQoX3BhcmVudHMubWFwKG4gPT4gbikpO1xyXG4gICAgICAgICAgICAgICAgICAgIHBhcmVudHMucHVzaChwYXJlbnRJRCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBjb25zdCByb3dOb2RlID0ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlkOiBub2RlLmRhdGFbaWRGaWVsZF0sXHJcbiAgICAgICAgICAgICAgICAgICAgbm9kZSxcclxuICAgICAgICAgICAgICAgICAgICBsZXZlbCxcclxuICAgICAgICAgICAgICAgICAgICBwYXJlbnRzLFxyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgIGFyci5wdXNoKHJvd05vZGUpO1xyXG4gICAgICAgICAgICAgICAgYXJyID0gYXJyLmNvbmNhdCh0aGlzLnRyZWVEYXRhMkZsYXQobm9kZSwgbm9kZS5jaGlsZHJlbiwgbGV2ZWwgKyAxLCBwYXJlbnRzKSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gYXJyO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgc2hvdWRFeHBhbmQoZXhwYW5kTGV2ZWw6IG51bWJlciwgbm9kZUxheWVyOiBudW1iZXIpIHtcclxuICAgICAgICBpZiAoZXhwYW5kTGV2ZWwgPT09IC0xKSB7XHJcbiAgICAgICAgICAgIC8vIC0xIOS4uuS4jeWxleW8gFxyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfSBlbHNlIGlmIChleHBhbmRMZXZlbCA9PT0gMCkge1xyXG4gICAgICAgICAgICAvLyAwIOS4uuWFqOmDqOWxleW8gFxyXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAvLyDmsqHmnInlkK/nlKjliIblsYLliqDovb3vvIzpgJrov4flsZXlvIDlsYLnuqfnoa7lrprmmK/lkKblsZXlvIDor6XoioLngrlcclxuICAgICAgICAgICAgcmV0dXJuIG5vZGVMYXllciA8PSBleHBhbmRMZXZlbDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBpc1NlbGVjdE5vZGVQYXJlbnQodHJlZU5vZGUpIHtcclxuICAgICAgICBpZiAodGhpcy5pbnN0YW5jZS5uYXZTZWxlY3RlZElkcykge1xyXG4gICAgICAgICAgICBjb25zdCBhbGxQYXJlbnRJZHM6IHN0cmluZ1tdID0gdGhpcy5mbGF0QWxsTm9kZXMuZmluZChmID0+IGYuaWQgPT09IHRoaXMuaW5zdGFuY2UubmF2U2VsZWN0ZWRJZHMpLnBhcmVudHM7XHJcbiAgICAgICAgICAgIGlmIChhbGxQYXJlbnRJZHMgJiYgYWxsUGFyZW50SWRzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGFsbFBhcmVudElkcy5pbmNsdWRlcyh0cmVlTm9kZS5pZCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0TGVhZk5vZGUodHJlZU5vZGU6IFRyZWVOb2RlKSB7XHJcbiAgICAgICAgaWYgKHRyZWVOb2RlICYmICghdHJlZU5vZGUuY2hpbGRyZW4gfHwgIXRyZWVOb2RlLmNoaWxkcmVuLmxlbmd0aCkpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRyZWVOb2RlO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlmICh0cmVlTm9kZS5jaGlsZHJlbi5sZW5ndGggPT09IDEpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdldExlYWZOb2RlKHRyZWVOb2RlLmNoaWxkcmVuWzBdKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0cmVlTm9kZS5jaGlsZHJlbjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBmbGF0VHJlZU5vZGVzKGl0ZW1zLCByZXN1bHQgPSBbXSkge1xyXG4gICAgICAgIGl0ZW1zID0gaXRlbXMgfHwgW107XHJcbiAgICAgICAgcmV0dXJuICBpdGVtcy5yZWR1Y2UoKGMsIG4pID0+IHtcclxuICAgICAgICAgICAgYy5wdXNoKG4pO1xyXG4gICAgICAgICAgICBpZiAobi5jaGlsZHJlbiAmJiBuLmNoaWxkcmVuLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5mbGF0VHJlZU5vZGVzKG4uY2hpbGRyZW4sIGMpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBjO1xyXG4gICAgICAgIH0sIHJlc3VsdCk7XHJcbiAgICB9XHJcbn1cclxuIl19