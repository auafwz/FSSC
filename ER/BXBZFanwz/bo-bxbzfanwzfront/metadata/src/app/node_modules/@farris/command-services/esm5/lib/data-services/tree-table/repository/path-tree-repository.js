import { HttpHeaders } from '@angular/common/http';
import { of } from 'rxjs';
import { map, tap } from 'rxjs/operators';
import { FieldMetadataUtil } from '@farris/devkit';
/**
 * 路径树仓库
 */
var PathTreeRepository = /** @class */ (function () {
    function PathTreeRepository() {
    }
    /**
     * 添加兄弟节点
     */
    PathTreeRepository.prototype.addSibling = function (repository, id) {
        var restService = repository.restService;
        var baseUri = restService.baseUri;
        var addSiblingUri = baseUri + "/service/pathhierarchycreatesibling";
        var body = {
            dataID: id,
            requestInfo: restService.buildRequestInfo()
        };
        var options = {
            headers: new HttpHeaders({ 'Content-Type': 'application/json' }),
            body: body
        };
        return restService.invoke(addSiblingUri, 'PUT', null, options).pipe(map(function (responseInfo) {
            var entity = repository.buildEntity(responseInfo.returnValue);
            repository.entityCollection.addEntity(entity);
            return entity;
        }));
    };
    /**
     * 添加兄弟节点
     */
    PathTreeRepository.prototype.addChild = function (repository, parentId) {
        var restService = repository.restService;
        var baseUri = restService.baseUri;
        var addChildUri = baseUri + "/service/pathhierarchycreatechildlayer";
        var body = {
            dataID: parentId,
            requestInfo: restService.buildRequestInfo()
        };
        var options = {
            headers: new HttpHeaders({ 'Content-Type': 'application/json' }),
            body: body
        };
        return restService.invoke(addChildUri, 'PUT', null, options).pipe(map(function (responseInfo) {
            var entity = repository.buildEntity(responseInfo.returnValue);
            repository.entityCollection.addEntity(entity);
            return entity;
        }));
    };
    /**
     * 添加子表兄弟节点
     */
    PathTreeRepository.prototype.addSubSibling = function (repository, nodes, ids) {
        var _this = this;
        var restService = repository.restService;
        var baseUri = restService.baseUri;
        var addSubSiblingUri = baseUri + "/service/childnodepathhierarchycreatesibling";
        var body = {
            nodes: nodes,
            ids: ids,
            requestInfo: restService.buildRequestInfo()
        };
        var options = {
            headers: new HttpHeaders({ 'Content-Type': 'application/json' }),
            body: body
        };
        return restService.invoke(addSubSiblingUri, 'PUT', null, options).pipe(map(function (responseInfo) {
            var path = _this.getPaths(nodes, ids);
            var entity = repository.entityManager.appendEntityByPath(path, responseInfo.returnValue);
            return entity;
        }));
    };
    /**
    * 添加子表子节点
    */
    PathTreeRepository.prototype.addSubChild = function (repository, nodes, ids) {
        var _this = this;
        var restService = repository.restService;
        var baseUri = restService.baseUri;
        var addSubChildUri = baseUri + "/service/childnodepathhierarchycreatechildlayer";
        var body = {
            nodes: nodes,
            ids: ids,
            requestInfo: restService.buildRequestInfo()
        };
        var options = {
            headers: new HttpHeaders({ 'Content-Type': 'application/json' }),
            body: body
        };
        return restService.invoke(addSubChildUri, 'PUT', null, options).pipe(map(function (responseInfo) {
            var path = _this.getPaths(nodes, ids);
            var entity = repository.entityManager.appendEntityByPath(path, responseInfo.returnValue);
            return entity;
        }));
    };
    PathTreeRepository.prototype.getPaths = function (nodes, ids) {
        var paths = '';
        if (nodes && nodes.length > 0 && ids && ids.length > 0) {
            for (var i = 0; i < ids.length; i++) {
                if (nodes[i]) {
                    paths = paths + ("/" + ids[i]);
                    paths = paths + ("/" + nodes[i] + "s");
                }
            }
        }
        return paths;
    };
    /**
     * 加载父节点
     */
    // tslint:disable-next-line: max-line-length
    PathTreeRepository.prototype.loadByParentId = function (repository, hierarchyInfoKey, parentId, filters, sorts, frozenCurrentRow, pagination, frameContext, reload) {
        var _this = this;
        if (frozenCurrentRow === void 0) { frozenCurrentRow = false; }
        if (reload === void 0) { reload = false; }
        var localEntities = this.getChildren(repository, hierarchyInfoKey, parentId);
        if (localEntities && localEntities.length > 0 && !reload) {
            return of(localEntities);
        }
        var restService = repository.restService;
        var parentHierarchyInfo = this.getHierarchyInfoById(repository, hierarchyInfoKey, parentId);
        var originalHierarchyInfoKey = this.getOriginalHierarchyInfoKey(repository, hierarchyInfoKey);
        var filtersWithParent = this.buildFiltersWithParent(originalHierarchyInfoKey, parentHierarchyInfo, filters);
        var isUsePagination = pagination && pagination.pageSize > 0 || false;
        // 组织EntityFilter
        var entityFilter = {
            FilterConditions: filtersWithParent,
            SortConditions: sorts,
            IsUsePagination: isUsePagination,
            Pagination: { PageIndex: pagination && pagination.pageIndex || 0, PageSize: pagination && pagination.pageSize || 0, PageCount: 0, TotalCount: 0 }
        };
        var requestInfo = restService.buildRequestInfo();
        return restService.extendQuery(entityFilter, requestInfo).pipe(map(function (responseInfo) {
            var paginationInfo = _this.getPaginationInfo(responseInfo);
            if (parentId) {
                if (paginationInfo && paginationInfo.pageSize !== 0 && frameContext) {
                    frameContext.params.set("_NODE_" + parentId + "_PAGINATION_INFO_", paginationInfo);
                }
            }
            else {
                if (paginationInfo && paginationInfo.pageSize !== 0 && frameContext) {
                    frameContext.repository.entityCollection.updatePaginationInfoByPath('/', paginationInfo);
                }
            }
            // 先清空下级实体
            _this.clearDescendantEntities(repository, hierarchyInfoKey, parentHierarchyInfo, frozenCurrentRow);
            // 追加下级实体
            var listData = responseInfo.returnValue.result;
            var entities = repository.buildEntities(listData);
            if (frozenCurrentRow) {
                repository.entityCollection.addData(entities);
            }
            else {
                repository.entityCollection.addEntities(entities);
            }
            return entities;
        }));
    };
    // tslint:disable-next-line: max-line-length
    PathTreeRepository.prototype.loadFullTree = function (repository, hierarchyInfoKey, parentId, propertyName, fullTreeType, loadType, filters, context) {
        var _this = this;
        var restService = repository.restService;
        var baseUri = restService.baseUri;
        var queryUrl = baseUri + "/service/parentidfulltreequery";
        var pathHierarchyInfo = this.getHierarchyInfoById(repository, hierarchyInfoKey, parentId);
        var entityFilter = this.buildEntityFilter(filters, null, 0, 0);
        var body = {
            dataId: parentId || '',
            isUsePagination: false,
            virtualPropertyName: propertyName,
            pagination: {},
            fullTreeType: fullTreeType,
            loadType: loadType,
            filter: entityFilter,
            requestInfo: restService.buildRequestInfo()
        };
        var options = {
            body: body
        };
        return restService.invoke(queryUrl, 'PUT', null, options).pipe(tap(function (responseInfo) {
            // 保存展开的节点
            if (responseInfo.returnValue && responseInfo.returnValue.selectedRowId && context && context.frameContext) {
                var frameContext = context.frameContext;
                var virtualRootFrameContext = frameContext && frameContext.getVirtualRootFrameContext() || null;
                if (virtualRootFrameContext) {
                    var list = responseInfo.returnValue.result;
                    var selectedRowId_1 = responseInfo.returnValue.selectedRowId;
                    // 从顶层开始计算所有需要展开的节点
                    var leafNodeInfo = list.find(function (item) { return item[repository.primaryKey] === selectedRowId_1; });
                    var hierarchyInfo = leafNodeInfo[hierarchyInfoKey];
                    var ids = _this.getAllParentIds(hierarchyInfo, list, hierarchyInfoKey, repository);
                    virtualRootFrameContext.params.set('_DEVKIT_expandRowIds', ids.join(','));
                    virtualRootFrameContext.params.set('_DEVKIT_selectedRowId', selectedRowId_1);
                    virtualRootFrameContext.uiState.setPropertyValue('__DEVKIT__selectedRow', selectedRowId_1);
                }
            }
        }), map(function (responseInfo) {
            var frozenCurrentRow = context && context.frozenCurrentRow || false;
            // 先清空下级实体
            _this.clearDescendantEntities(repository, hierarchyInfoKey, pathHierarchyInfo, frozenCurrentRow);
            // 追加下级实体
            var listData = responseInfo.returnValue.result;
            var entities = repository.buildEntities(listData);
            if (frozenCurrentRow) {
                repository.entityCollection.addData(entities);
            }
            else {
                repository.entityCollection.addEntities(entities);
            }
            return entities;
        }));
    };
    /**
     * 插入对父节点的过滤
     */
    PathTreeRepository.prototype.buildFiltersWithParent = function (originalHierarchyInfoKey, parentHierarchyInfo, filterArray) {
        var relationType = filterArray && filterArray.length >= 1 ? 1 : 0;
        var parentLayer = parentHierarchyInfo ? parentHierarchyInfo['layer'] : 0;
        var parentFilterArray = [
            {
                "FilterField": originalHierarchyInfoKey + ".Layer",
                "Value": parentLayer + 1,
                "Lbracket": null,
                "Rbracket": null,
                "Relation": 1,
                "Expresstype": 0,
                "Compare": 0
            }
        ];
        // 父路径过滤，如果为空，则不添加（兼容oracle取数）
        var parentPath = parentHierarchyInfo ? parentHierarchyInfo['path'] : '';
        if (parentPath) {
            parentFilterArray.push({
                "FilterField": originalHierarchyInfoKey + ".Path",
                "Value": parentPath,
                "Lbracket": null,
                "Rbracket": null,
                "Relation": relationType,
                "Expresstype": 0,
                "Compare": 7
            });
        }
        else {
            parentFilterArray[0].Relation = relationType;
        }
        return parentFilterArray.concat(filterArray);
    };
    PathTreeRepository.prototype.buildEntityFilter = function (filter, sort, pageSize, pageIndex) {
        // @todo：临时兼容老代码，降低改动带来的风险
        if (!filter && !sort && !pageSize && !pageIndex) {
            return null;
        }
        if (!filter) {
            filter = [];
        }
        if (!sort) {
            sort = [];
        }
        // 纠正最后一个过滤条件的Relation
        if (filter && filter.length > 0) {
            filter[filter.length - 1].Relation = 0;
        }
        var entityFilter = {
            FilterConditions: filter,
            SortConditions: sort,
            IsUsePagination: pageSize === 0 ? false : true,
            Pagination: {
                PageIndex: pageIndex,
                PageSize: pageSize,
                PageCount: 0,
                TotalCount: 0
            }
        };
        return entityFilter;
    };
    /**
     * 清空后代实体
     */
    PathTreeRepository.prototype.clearDescendantEntities = function (repository, hierarchyInfokey, parentHierarchyInfo, frozenCurrentRow) {
        if (frozenCurrentRow === void 0) { frozenCurrentRow = false; }
        // 清空根节点
        if (!parentHierarchyInfo) {
            repository.entityCollection.clear();
            return;
        }
        var fPath = parentHierarchyInfo.path;
        var fLayer = parentHierarchyInfo.layer;
        if (frozenCurrentRow) {
            repository.entityCollection.removeData(function (entity) {
                var hierarchyInfo = entity[hierarchyInfokey];
                var path = hierarchyInfo.path;
                var layer = hierarchyInfo.layer;
                return layer > fLayer && path.startsWith(fPath);
            });
        }
        else {
            repository.entityCollection.removeEntities(function (entity) {
                var hierarchyInfo = entity[hierarchyInfokey];
                var path = hierarchyInfo.path;
                var layer = hierarchyInfo.layer;
                return layer > fLayer && path.startsWith(fPath);
            });
        }
    };
    /**
     * 获取实体的分级信息
     */
    PathTreeRepository.prototype.getHierarchyInfoById = function (repository, hierarchyInfokey, id) {
        if (!id) {
            return null;
        }
        var entity = repository.entityCollection.getEntityById(id);
        var hierarchyInfoEntity = entity[hierarchyInfokey];
        return hierarchyInfoEntity.toJSON();
    };
    /**
     * 获取分级码的原始的字段名
     */
    PathTreeRepository.prototype.getOriginalHierarchyInfoKey = function (repository, hierarchyInfokey) {
        var ngObjects = FieldMetadataUtil.getNgObjects(repository.entityType);
        var hierarchyInfoNgObject = ngObjects[hierarchyInfokey];
        return hierarchyInfoNgObject.originalDataField;
    };
    PathTreeRepository.prototype.getPaginationInfo = function (responseInfo) {
        return responseInfo && responseInfo.returnValue && responseInfo.returnValue.pagination || null;
    };
    PathTreeRepository.prototype.findParent = function (hierarchyInfo, list, hierarchyInfoKey) {
        return list.find(function (item) {
            var currentHierarchyInfo = item[hierarchyInfoKey];
            return currentHierarchyInfo.layer === hierarchyInfo.layer - 1 && hierarchyInfo.path.startsWith(currentHierarchyInfo.path);
        });
    };
    PathTreeRepository.prototype.getAllParentIds = function (hierarchyInfo, list, hierarchyInfoKey, repository) {
        var item = this.findParent(hierarchyInfo, list, hierarchyInfoKey);
        var ids = [];
        while (item) {
            ids.push(item[repository.primaryKey]);
            item = this.findParent(item[hierarchyInfoKey], list, hierarchyInfoKey);
        }
        return ids;
    };
    PathTreeRepository.prototype.getHierarchyInfo = function (entity, hierarchyInfoKey) {
        return entity[hierarchyInfoKey];
    };
    /**
     * 查找节点下所有子级（第一级）
     * @param repository repository
     * @param hierarchyInfoKey 分级码字段
     * @param id id
     * @returns
     */
    PathTreeRepository.prototype.getChildren = function (repository, hierarchyInfoKey, id) {
        var _this = this;
        var hierarchyInfo = this.getHierarchyInfoById(repository, hierarchyInfoKey, id);
        if (!hierarchyInfo) {
            return null;
        }
        var layer = hierarchyInfo.layer;
        var path = hierarchyInfo.path;
        var entities = repository.entityCollection.getEntities(function (entity) {
            var hierarchyInfo = _this.getHierarchyInfo(entity, hierarchyInfoKey);
            var matched = hierarchyInfo.layer === layer + 1 && hierarchyInfo.path.startsWith(path);
            if (matched) {
                return entity;
            }
            else {
                return null;
            }
        });
        return entities;
    };
    return PathTreeRepository;
}());
export { PathTreeRepository };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGF0aC10cmVlLXJlcG9zaXRvcnkuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMvIiwic291cmNlcyI6WyJsaWIvZGF0YS1zZXJ2aWNlcy90cmVlLXRhYmxlL3JlcG9zaXRvcnkvcGF0aC10cmVlLXJlcG9zaXRvcnkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ25ELE9BQU8sRUFBYyxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDdEMsT0FBTyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMxQyxPQUFPLEVBQVUsaUJBQWlCLEVBQTRCLE1BQU0sZ0JBQWdCLENBQUM7QUFHckY7O0dBRUc7QUFDSDtJQUFBO0lBNlhBLENBQUM7SUEzWEM7O09BRUc7SUFDSSx1Q0FBVSxHQUFqQixVQUFrQixVQUFpQyxFQUFFLEVBQVU7UUFDN0QsSUFBTSxXQUFXLEdBQUcsVUFBVSxDQUFDLFdBQVcsQ0FBQztRQUMzQyxJQUFNLE9BQU8sR0FBRyxXQUFXLENBQUMsT0FBTyxDQUFDO1FBQ3BDLElBQU0sYUFBYSxHQUFNLE9BQU8sd0NBQXFDLENBQUM7UUFDdEUsSUFBTSxJQUFJLEdBQUc7WUFDWCxNQUFNLEVBQUUsRUFBRTtZQUNWLFdBQVcsRUFBRSxXQUFXLENBQUMsZ0JBQWdCLEVBQUU7U0FDNUMsQ0FBQztRQUNGLElBQU0sT0FBTyxHQUFHO1lBQ2QsT0FBTyxFQUFFLElBQUksV0FBVyxDQUFDLEVBQUUsY0FBYyxFQUFFLGtCQUFrQixFQUFFLENBQUM7WUFDaEUsSUFBSSxFQUFFLElBQUk7U0FDWCxDQUFDO1FBQ0YsT0FBTyxXQUFXLENBQUMsTUFBTSxDQUFDLGFBQWEsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FDakUsR0FBRyxDQUFDLFVBQUMsWUFBMEI7WUFDN0IsSUFBTSxNQUFNLEdBQUcsVUFBVSxDQUFDLFdBQVcsQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDLENBQUM7WUFDaEUsVUFBVSxDQUFDLGdCQUFnQixDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUM5QyxPQUFPLE1BQU0sQ0FBQztRQUNoQixDQUFDLENBQUMsQ0FDSCxDQUFDO0lBQ0osQ0FBQztJQUVEOztPQUVHO0lBQ0kscUNBQVEsR0FBZixVQUFnQixVQUFpQyxFQUFFLFFBQWdCO1FBQ2pFLElBQU0sV0FBVyxHQUFHLFVBQVUsQ0FBQyxXQUFXLENBQUM7UUFDM0MsSUFBTSxPQUFPLEdBQUcsV0FBVyxDQUFDLE9BQU8sQ0FBQztRQUNwQyxJQUFNLFdBQVcsR0FBTSxPQUFPLDJDQUF3QyxDQUFDO1FBRXZFLElBQU0sSUFBSSxHQUFHO1lBQ1gsTUFBTSxFQUFFLFFBQVE7WUFDaEIsV0FBVyxFQUFFLFdBQVcsQ0FBQyxnQkFBZ0IsRUFBRTtTQUM1QyxDQUFDO1FBQ0YsSUFBTSxPQUFPLEdBQUc7WUFDZCxPQUFPLEVBQUUsSUFBSSxXQUFXLENBQUMsRUFBRSxjQUFjLEVBQUUsa0JBQWtCLEVBQUUsQ0FBQztZQUNoRSxJQUFJLEVBQUUsSUFBSTtTQUNYLENBQUM7UUFDRixPQUFPLFdBQVcsQ0FBQyxNQUFNLENBQUMsV0FBVyxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUMvRCxHQUFHLENBQUMsVUFBQyxZQUEwQjtZQUM3QixJQUFNLE1BQU0sR0FBRyxVQUFVLENBQUMsV0FBVyxDQUFDLFlBQVksQ0FBQyxXQUFXLENBQUMsQ0FBQztZQUNoRSxVQUFVLENBQUMsZ0JBQWdCLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQzlDLE9BQU8sTUFBTSxDQUFDO1FBQ2hCLENBQUMsQ0FBQyxDQUNILENBQUM7SUFDSixDQUFDO0lBRUQ7O09BRUc7SUFDSSwwQ0FBYSxHQUFwQixVQUFxQixVQUFpQyxFQUFFLEtBQW9CLEVBQUUsR0FBa0I7UUFBaEcsaUJBb0JDO1FBbkJDLElBQU0sV0FBVyxHQUFHLFVBQVUsQ0FBQyxXQUFXLENBQUM7UUFDM0MsSUFBTSxPQUFPLEdBQUcsV0FBVyxDQUFDLE9BQU8sQ0FBQztRQUNwQyxJQUFNLGdCQUFnQixHQUFNLE9BQU8saURBQThDLENBQUM7UUFDbEYsSUFBTSxJQUFJLEdBQUc7WUFDWCxLQUFLLEVBQUUsS0FBSztZQUNaLEdBQUcsRUFBRSxHQUFHO1lBQ1IsV0FBVyxFQUFFLFdBQVcsQ0FBQyxnQkFBZ0IsRUFBRTtTQUM1QyxDQUFDO1FBQ0YsSUFBTSxPQUFPLEdBQUc7WUFDZCxPQUFPLEVBQUUsSUFBSSxXQUFXLENBQUMsRUFBRSxjQUFjLEVBQUUsa0JBQWtCLEVBQUUsQ0FBQztZQUNoRSxJQUFJLEVBQUUsSUFBSTtTQUNYLENBQUM7UUFDRixPQUFPLFdBQVcsQ0FBQyxNQUFNLENBQUMsZ0JBQWdCLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQ3BFLEdBQUcsQ0FBQyxVQUFDLFlBQTBCO1lBQzdCLElBQUksSUFBSSxHQUFHLEtBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1lBQ3JDLElBQU0sTUFBTSxHQUFHLFVBQVUsQ0FBQyxhQUFhLENBQUMsa0JBQWtCLENBQUMsSUFBSSxFQUFFLFlBQVksQ0FBQyxXQUFXLENBQUMsQ0FBQTtZQUMxRixPQUFPLE1BQU0sQ0FBQztRQUNoQixDQUFDLENBQUMsQ0FDSCxDQUFDO0lBQ0osQ0FBQztJQUVEOztNQUVFO0lBQ0ssd0NBQVcsR0FBbEIsVUFBbUIsVUFBaUMsRUFBRSxLQUFvQixFQUFFLEdBQWtCO1FBQTlGLGlCQXFCQztRQXBCQyxJQUFNLFdBQVcsR0FBRyxVQUFVLENBQUMsV0FBVyxDQUFDO1FBQzNDLElBQU0sT0FBTyxHQUFHLFdBQVcsQ0FBQyxPQUFPLENBQUM7UUFDcEMsSUFBTSxjQUFjLEdBQU0sT0FBTyxvREFBaUQsQ0FBQztRQUVuRixJQUFNLElBQUksR0FBRztZQUNYLEtBQUssRUFBRSxLQUFLO1lBQ1osR0FBRyxFQUFFLEdBQUc7WUFDUixXQUFXLEVBQUUsV0FBVyxDQUFDLGdCQUFnQixFQUFFO1NBQzVDLENBQUM7UUFDRixJQUFNLE9BQU8sR0FBRztZQUNkLE9BQU8sRUFBRSxJQUFJLFdBQVcsQ0FBQyxFQUFFLGNBQWMsRUFBRSxrQkFBa0IsRUFBRSxDQUFDO1lBQ2hFLElBQUksRUFBRSxJQUFJO1NBQ1gsQ0FBQztRQUNGLE9BQU8sV0FBVyxDQUFDLE1BQU0sQ0FBQyxjQUFjLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQ2xFLEdBQUcsQ0FBQyxVQUFDLFlBQTBCO1lBQzdCLElBQUksSUFBSSxHQUFHLEtBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1lBQ3JDLElBQU0sTUFBTSxHQUFHLFVBQVUsQ0FBQyxhQUFhLENBQUMsa0JBQWtCLENBQUMsSUFBSSxFQUFFLFlBQVksQ0FBQyxXQUFXLENBQUMsQ0FBQTtZQUMxRixPQUFPLE1BQU0sQ0FBQztRQUNoQixDQUFDLENBQUMsQ0FDSCxDQUFDO0lBQ0osQ0FBQztJQUVPLHFDQUFRLEdBQWhCLFVBQWlCLEtBQWUsRUFBRSxHQUFhO1FBQzdDLElBQUksS0FBSyxHQUFHLEVBQUUsQ0FBQztRQUNmLElBQUksS0FBSyxJQUFJLEtBQUssQ0FBQyxNQUFNLEdBQUcsQ0FBQyxJQUFJLEdBQUcsSUFBSSxHQUFHLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUN0RCxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsR0FBRyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtnQkFDbkMsSUFBSSxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUU7b0JBQ1osS0FBSyxHQUFHLEtBQUssSUFBRyxNQUFJLEdBQUcsQ0FBQyxDQUFDLENBQUcsQ0FBQSxDQUFDO29CQUM3QixLQUFLLEdBQUcsS0FBSyxJQUFHLE1BQUksS0FBSyxDQUFDLENBQUMsQ0FBQyxNQUFHLENBQUEsQ0FBQztpQkFDakM7YUFDRjtTQUNGO1FBQ0QsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDO0lBRUQ7O09BRUc7SUFDSCw0Q0FBNEM7SUFDckMsMkNBQWMsR0FBckIsVUFBc0IsVUFBaUMsRUFBRSxnQkFBd0IsRUFBRSxRQUFnQixFQUFFLE9BQWMsRUFBRSxLQUFZLEVBQUUsZ0JBQWlDLEVBQUUsVUFBb0QsRUFBRSxZQUEyQixFQUFFLE1BQXVCO1FBQWhSLGlCQTRDQztRQTVDa0ksaUNBQUEsRUFBQSx3QkFBaUM7UUFBcUYsdUJBQUEsRUFBQSxjQUF1QjtRQUM5USxJQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLFVBQVUsRUFBRSxnQkFBZ0IsRUFBRSxRQUFRLENBQUMsQ0FBQztRQUMvRSxJQUFJLGFBQWEsSUFBSSxhQUFhLENBQUMsTUFBTSxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRTtZQUN4RCxPQUFPLEVBQUUsQ0FBQyxhQUFhLENBQUMsQ0FBQztTQUMxQjtRQUNELElBQU0sV0FBVyxHQUFHLFVBQVUsQ0FBQyxXQUFXLENBQUM7UUFDM0MsSUFBTSxtQkFBbUIsR0FBRyxJQUFJLENBQUMsb0JBQW9CLENBQUMsVUFBVSxFQUFFLGdCQUFnQixFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQzlGLElBQU0sd0JBQXdCLEdBQUcsSUFBSSxDQUFDLDJCQUEyQixDQUFDLFVBQVUsRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDO1FBQ2hHLElBQU0saUJBQWlCLEdBQUcsSUFBSSxDQUFDLHNCQUFzQixDQUFDLHdCQUF3QixFQUFFLG1CQUFtQixFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQzlHLElBQU0sZUFBZSxHQUFHLFVBQVUsSUFBSSxVQUFVLENBQUMsUUFBUSxHQUFHLENBQUMsSUFBSSxLQUFLLENBQUM7UUFDdkUsaUJBQWlCO1FBQ2pCLElBQU0sWUFBWSxHQUFHO1lBQ25CLGdCQUFnQixFQUFFLGlCQUFpQjtZQUNuQyxjQUFjLEVBQUUsS0FBSztZQUNyQixlQUFlLEVBQUUsZUFBZTtZQUNoQyxVQUFVLEVBQUUsRUFBRSxTQUFTLEVBQUUsVUFBVSxJQUFJLFVBQVUsQ0FBQyxTQUFTLElBQUksQ0FBQyxFQUFFLFFBQVEsRUFBRSxVQUFVLElBQUksVUFBVSxDQUFDLFFBQVEsSUFBSSxDQUFDLEVBQUUsU0FBUyxFQUFFLENBQUMsRUFBRSxVQUFVLEVBQUUsQ0FBQyxFQUFFO1NBQ2xKLENBQUM7UUFDRixJQUFNLFdBQVcsR0FBRyxXQUFXLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztRQUNuRCxPQUFPLFdBQVcsQ0FBQyxXQUFXLENBQUMsWUFBWSxFQUFFLFdBQVcsQ0FBQyxDQUFDLElBQUksQ0FDNUQsR0FBRyxDQUFDLFVBQUMsWUFBMEI7WUFDN0IsSUFBTSxjQUFjLEdBQUcsS0FBSSxDQUFDLGlCQUFpQixDQUFDLFlBQVksQ0FBQyxDQUFDO1lBQzVELElBQUksUUFBUSxFQUFFO2dCQUNaLElBQUksY0FBYyxJQUFJLGNBQWMsQ0FBQyxRQUFRLEtBQUssQ0FBQyxJQUFJLFlBQVksRUFBRTtvQkFDbkUsWUFBWSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsV0FBUyxRQUFRLHNCQUFtQixFQUFFLGNBQWMsQ0FBQyxDQUFDO2lCQUMvRTthQUNGO2lCQUFNO2dCQUNMLElBQUksY0FBYyxJQUFJLGNBQWMsQ0FBQyxRQUFRLEtBQUssQ0FBQyxJQUFJLFlBQVksRUFBRTtvQkFDbkUsWUFBWSxDQUFDLFVBQVUsQ0FBQyxnQkFBZ0IsQ0FBQywwQkFBMEIsQ0FBQyxHQUFHLEVBQUUsY0FBYyxDQUFDLENBQUM7aUJBQzFGO2FBQ0Y7WUFDRCxVQUFVO1lBQ1YsS0FBSSxDQUFDLHVCQUF1QixDQUFDLFVBQVUsRUFBRSxnQkFBZ0IsRUFBRSxtQkFBbUIsRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDO1lBQ2xHLFNBQVM7WUFDVCxJQUFNLFFBQVEsR0FBRyxZQUFZLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQztZQUNqRCxJQUFNLFFBQVEsR0FBRyxVQUFVLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ3BELElBQUksZ0JBQWdCLEVBQUU7Z0JBQ3BCLFVBQVUsQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7YUFDL0M7aUJBQU07Z0JBQ0wsVUFBVSxDQUFDLGdCQUFnQixDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsQ0FBQzthQUNuRDtZQUVELE9BQU8sUUFBUSxDQUFDO1FBQ2xCLENBQUMsQ0FBQyxDQUNILENBQUM7SUFDSixDQUFDO0lBQ0QsNENBQTRDO0lBQ3JDLHlDQUFZLEdBQW5CLFVBQW9CLFVBQWlDLEVBQUUsZ0JBQXdCLEVBQUUsUUFBZ0IsRUFBRSxZQUFvQixFQUFFLFlBQW9CLEVBQUUsUUFBZ0IsRUFBRSxPQUFlLEVBQUUsT0FBYTtRQUEvTCxpQkFxREM7UUFwREMsSUFBTSxXQUFXLEdBQUcsVUFBVSxDQUFDLFdBQVcsQ0FBQztRQUMzQyxJQUFNLE9BQU8sR0FBRyxXQUFXLENBQUMsT0FBTyxDQUFDO1FBQ3BDLElBQU0sUUFBUSxHQUFNLE9BQU8sbUNBQWdDLENBQUM7UUFDNUQsSUFBTSxpQkFBaUIsR0FBRyxJQUFJLENBQUMsb0JBQW9CLENBQUMsVUFBVSxFQUFFLGdCQUFnQixFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQzVGLElBQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxPQUFPLEVBQUUsSUFBSSxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUNqRSxJQUFNLElBQUksR0FBRztZQUNYLE1BQU0sRUFBRSxRQUFRLElBQUksRUFBRTtZQUN0QixlQUFlLEVBQUUsS0FBSztZQUN0QixtQkFBbUIsRUFBRSxZQUFZO1lBQ2pDLFVBQVUsRUFBRSxFQUFFO1lBQ2QsWUFBWSxjQUFBO1lBQ1osUUFBUSxVQUFBO1lBQ1IsTUFBTSxFQUFFLFlBQVk7WUFDcEIsV0FBVyxFQUFFLFdBQVcsQ0FBQyxnQkFBZ0IsRUFBRTtTQUM1QyxDQUFDO1FBQ0YsSUFBTSxPQUFPLEdBQUc7WUFDZCxJQUFJLEVBQUUsSUFBSTtTQUNYLENBQUM7UUFDRixPQUFPLFdBQVcsQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUM1RCxHQUFHLENBQUMsVUFBQyxZQUEwQjtZQUM3QixVQUFVO1lBQ1YsSUFBSSxZQUFZLENBQUMsV0FBVyxJQUFJLFlBQVksQ0FBQyxXQUFXLENBQUMsYUFBYSxJQUFJLE9BQU8sSUFBSSxPQUFPLENBQUMsWUFBWSxFQUFFO2dCQUN6RyxJQUFNLFlBQVksR0FBRyxPQUFPLENBQUMsWUFBNEIsQ0FBQztnQkFDMUQsSUFBTSx1QkFBdUIsR0FBRyxZQUFZLElBQUksWUFBWSxDQUFDLDBCQUEwQixFQUFFLElBQUksSUFBSSxDQUFDO2dCQUNsRyxJQUFJLHVCQUF1QixFQUFFO29CQUMzQixJQUFNLElBQUksR0FBRyxZQUFZLENBQUMsV0FBVyxDQUFDLE1BQWUsQ0FBQztvQkFDdEQsSUFBTSxlQUFhLEdBQUcsWUFBWSxDQUFDLFdBQVcsQ0FBQyxhQUFhLENBQUM7b0JBQzdELG1CQUFtQjtvQkFDbkIsSUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFBLElBQUksSUFBSSxPQUFBLElBQUksQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDLEtBQUssZUFBYSxFQUE3QyxDQUE2QyxDQUFDLENBQUM7b0JBQ3RGLElBQU0sYUFBYSxHQUFHLFlBQVksQ0FBQyxnQkFBZ0IsQ0FBdUQsQ0FBQztvQkFDM0csSUFBTSxHQUFHLEdBQUcsS0FBSSxDQUFDLGVBQWUsQ0FBQyxhQUFhLEVBQUUsSUFBSSxFQUFFLGdCQUFnQixFQUFFLFVBQVUsQ0FBQyxDQUFDO29CQUNwRix1QkFBdUIsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLHNCQUFzQixFQUFFLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztvQkFDMUUsdUJBQXVCLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyx1QkFBdUIsRUFBRSxlQUFhLENBQUMsQ0FBQztvQkFDM0UsdUJBQXVCLENBQUMsT0FBTyxDQUFDLGdCQUFnQixDQUFDLHVCQUF1QixFQUFFLGVBQWEsQ0FBQyxDQUFDO2lCQUMxRjthQUNGO1FBQ0gsQ0FBQyxDQUFDLEVBQ0YsR0FBRyxDQUFDLFVBQUMsWUFBMEI7WUFDN0IsSUFBTSxnQkFBZ0IsR0FBWSxPQUFPLElBQUksT0FBTyxDQUFDLGdCQUFnQixJQUFJLEtBQUssQ0FBQztZQUMvRSxVQUFVO1lBQ1YsS0FBSSxDQUFDLHVCQUF1QixDQUFDLFVBQVUsRUFBRSxnQkFBZ0IsRUFBRSxpQkFBaUIsRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDO1lBQ2hHLFNBQVM7WUFDVCxJQUFNLFFBQVEsR0FBRyxZQUFZLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQztZQUNqRCxJQUFNLFFBQVEsR0FBRyxVQUFVLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ3BELElBQUksZ0JBQWdCLEVBQUU7Z0JBQ3BCLFVBQVUsQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7YUFDL0M7aUJBQU07Z0JBQ0wsVUFBVSxDQUFDLGdCQUFnQixDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsQ0FBQzthQUNuRDtZQUNELE9BQU8sUUFBUSxDQUFDO1FBQ2xCLENBQUMsQ0FBQyxDQUNILENBQUM7SUFDSixDQUFDO0lBQ0Q7O09BRUc7SUFDSSxtREFBc0IsR0FBN0IsVUFBOEIsd0JBQWdDLEVBQUUsbUJBQXdCLEVBQUUsV0FBa0I7UUFDMUcsSUFBTSxZQUFZLEdBQUcsV0FBVyxJQUFJLFdBQVcsQ0FBQyxNQUFNLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUVwRSxJQUFNLFdBQVcsR0FBRyxtQkFBbUIsQ0FBQyxDQUFDLENBQUMsbUJBQW1CLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUMzRSxJQUFNLGlCQUFpQixHQUFHO1lBQ3hCO2dCQUNFLGFBQWEsRUFBSyx3QkFBd0IsV0FBUTtnQkFDbEQsT0FBTyxFQUFFLFdBQVcsR0FBRyxDQUFDO2dCQUN4QixVQUFVLEVBQUUsSUFBSTtnQkFDaEIsVUFBVSxFQUFFLElBQUk7Z0JBQ2hCLFVBQVUsRUFBRSxDQUFDO2dCQUNiLGFBQWEsRUFBRSxDQUFDO2dCQUNoQixTQUFTLEVBQUUsQ0FBQzthQUNiO1NBQ0YsQ0FBQztRQUVGLDhCQUE4QjtRQUM5QixJQUFNLFVBQVUsR0FBRyxtQkFBbUIsQ0FBQyxDQUFDLENBQUMsbUJBQW1CLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztRQUMxRSxJQUFJLFVBQVUsRUFBRTtZQUNkLGlCQUFpQixDQUFDLElBQUksQ0FBQztnQkFDckIsYUFBYSxFQUFLLHdCQUF3QixVQUFPO2dCQUNqRCxPQUFPLEVBQUUsVUFBVTtnQkFDbkIsVUFBVSxFQUFFLElBQUk7Z0JBQ2hCLFVBQVUsRUFBRSxJQUFJO2dCQUNoQixVQUFVLEVBQUUsWUFBWTtnQkFDeEIsYUFBYSxFQUFFLENBQUM7Z0JBQ2hCLFNBQVMsRUFBRSxDQUFDO2FBQ2IsQ0FBQyxDQUFDO1NBQ0o7YUFBTTtZQUNMLGlCQUFpQixDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsR0FBRyxZQUFZLENBQUM7U0FDOUM7UUFFRCxPQUFPLGlCQUFpQixDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUMvQyxDQUFDO0lBQ00sOENBQWlCLEdBQXhCLFVBQXlCLE1BQWEsRUFBRSxJQUFXLEVBQUUsUUFBZ0IsRUFBRSxTQUFpQjtRQUV0RiwwQkFBMEI7UUFDMUIsSUFBSSxDQUFDLE1BQU0sSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDLFFBQVEsSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUMvQyxPQUFPLElBQUksQ0FBQztTQUNiO1FBQ0QsSUFBSSxDQUFDLE1BQU0sRUFBRTtZQUNYLE1BQU0sR0FBRyxFQUFFLENBQUM7U0FDYjtRQUNELElBQUksQ0FBQyxJQUFJLEVBQUU7WUFDVCxJQUFJLEdBQUcsRUFBRSxDQUFDO1NBQ1g7UUFDRCxzQkFBc0I7UUFDdEIsSUFBSSxNQUFNLElBQUksTUFBTSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDL0IsTUFBTSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUMsUUFBUSxHQUFHLENBQUMsQ0FBQztTQUN4QztRQUNELElBQU0sWUFBWSxHQUFHO1lBQ25CLGdCQUFnQixFQUFFLE1BQU07WUFDeEIsY0FBYyxFQUFFLElBQUk7WUFDcEIsZUFBZSxFQUFFLFFBQVEsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsSUFBSTtZQUM5QyxVQUFVLEVBQUU7Z0JBQ1YsU0FBUyxFQUFFLFNBQVM7Z0JBQ3BCLFFBQVEsRUFBRSxRQUFRO2dCQUNsQixTQUFTLEVBQUUsQ0FBQztnQkFDWixVQUFVLEVBQUUsQ0FBQzthQUNkO1NBQ0YsQ0FBQztRQUNGLE9BQU8sWUFBWSxDQUFDO0lBQ3RCLENBQUM7SUFDRDs7T0FFRztJQUNJLG9EQUF1QixHQUE5QixVQUErQixVQUFpQyxFQUFFLGdCQUF3QixFQUFFLG1CQUF3QixFQUFFLGdCQUFpQztRQUFqQyxpQ0FBQSxFQUFBLHdCQUFpQztRQUVySixRQUFRO1FBQ1IsSUFBSSxDQUFDLG1CQUFtQixFQUFFO1lBQ3hCLFVBQVUsQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLEVBQUUsQ0FBQztZQUNwQyxPQUFPO1NBQ1I7UUFDRCxJQUFNLEtBQUssR0FBRyxtQkFBbUIsQ0FBQyxJQUFJLENBQUM7UUFDdkMsSUFBTSxNQUFNLEdBQUcsbUJBQW1CLENBQUMsS0FBSyxDQUFDO1FBQ3pDLElBQUksZ0JBQWdCLEVBQUU7WUFDcEIsVUFBVSxDQUFDLGdCQUFnQixDQUFDLFVBQVUsQ0FBQyxVQUFDLE1BQWM7Z0JBQ3BELElBQU0sYUFBYSxHQUFHLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO2dCQUMvQyxJQUFNLElBQUksR0FBRyxhQUFhLENBQUMsSUFBSSxDQUFDO2dCQUNoQyxJQUFNLEtBQUssR0FBRyxhQUFhLENBQUMsS0FBSyxDQUFDO2dCQUNsQyxPQUFPLEtBQUssR0FBRyxNQUFNLElBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUNsRCxDQUFDLENBQUMsQ0FBQztTQUNKO2FBQU07WUFDTCxVQUFVLENBQUMsZ0JBQWdCLENBQUMsY0FBYyxDQUFDLFVBQUMsTUFBYztnQkFDeEQsSUFBTSxhQUFhLEdBQUcsTUFBTSxDQUFDLGdCQUFnQixDQUFDLENBQUM7Z0JBQy9DLElBQU0sSUFBSSxHQUFHLGFBQWEsQ0FBQyxJQUFJLENBQUM7Z0JBQ2hDLElBQU0sS0FBSyxHQUFHLGFBQWEsQ0FBQyxLQUFLLENBQUM7Z0JBQ2xDLE9BQU8sS0FBSyxHQUFHLE1BQU0sSUFBSSxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ2xELENBQUMsQ0FBQyxDQUFDO1NBQ0o7SUFFSCxDQUFDO0lBRUQ7O09BRUc7SUFDSSxpREFBb0IsR0FBM0IsVUFBNEIsVUFBaUMsRUFBRSxnQkFBd0IsRUFBRSxFQUFVO1FBQ2pHLElBQUksQ0FBQyxFQUFFLEVBQUU7WUFDUCxPQUFPLElBQUksQ0FBQztTQUNiO1FBQ0QsSUFBTSxNQUFNLEdBQVcsVUFBVSxDQUFDLGdCQUFnQixDQUFDLGFBQWEsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUNyRSxJQUFNLG1CQUFtQixHQUFXLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1FBQzdELE9BQU8sbUJBQW1CLENBQUMsTUFBTSxFQUFFLENBQUM7SUFDdEMsQ0FBQztJQUVEOztPQUVHO0lBQ0ksd0RBQTJCLEdBQWxDLFVBQW1DLFVBQWlDLEVBQUUsZ0JBQXdCO1FBQzVGLElBQU0sU0FBUyxHQUFHLGlCQUFpQixDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDeEUsSUFBTSxxQkFBcUIsR0FBRyxTQUFTLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztRQUMxRCxPQUFPLHFCQUFxQixDQUFDLGlCQUEyQixDQUFDO0lBQzNELENBQUM7SUFDTyw4Q0FBaUIsR0FBekIsVUFBMEIsWUFBMEI7UUFDbEQsT0FBTyxZQUFZLElBQUksWUFBWSxDQUFDLFdBQVcsSUFBSSxZQUFZLENBQUMsV0FBVyxDQUFDLFVBQVUsSUFBSSxJQUFJLENBQUM7SUFDakcsQ0FBQztJQUNPLHVDQUFVLEdBQWxCLFVBQW1CLGFBQWlFLEVBQUUsSUFBVyxFQUFFLGdCQUF3QjtRQUN6SCxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBQSxJQUFJO1lBQ25CLElBQU0sb0JBQW9CLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUF1RCxDQUFDO1lBQzFHLE9BQU8sb0JBQW9CLENBQUMsS0FBSyxLQUFLLGFBQWEsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxJQUFJLGFBQWEsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLG9CQUFvQixDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzVILENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUNPLDRDQUFlLEdBQXZCLFVBQXdCLGFBQWlFLEVBQUUsSUFBVyxFQUFFLGdCQUF3QixFQUFFLFVBQTJCO1FBQzNKLElBQUksSUFBSSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsYUFBYSxFQUFFLElBQUksRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDO1FBQ2xFLElBQU0sR0FBRyxHQUFHLEVBQUUsQ0FBQztRQUNmLE9BQU8sSUFBSSxFQUFFO1lBQ1gsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7WUFDdEMsSUFBSSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEVBQUUsSUFBSSxFQUFFLGdCQUFnQixDQUFDLENBQUM7U0FDeEU7UUFDRCxPQUFPLEdBQUcsQ0FBQztJQUNiLENBQUM7SUFDTyw2Q0FBZ0IsR0FBeEIsVUFBeUIsTUFBYyxFQUFFLGdCQUF3QjtRQUMvRCxPQUFPLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO0lBQ2xDLENBQUM7SUFDRDs7Ozs7O09BTUc7SUFDSyx3Q0FBVyxHQUFuQixVQUFvQixVQUFpQyxFQUFFLGdCQUF3QixFQUFFLEVBQVU7UUFBM0YsaUJBaUJDO1FBaEJDLElBQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxVQUFVLEVBQUUsZ0JBQWdCLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDbEYsSUFBSSxDQUFDLGFBQWEsRUFBRTtZQUNsQixPQUFPLElBQUksQ0FBQztTQUNiO1FBQ0QsSUFBTSxLQUFLLEdBQUcsYUFBYSxDQUFDLEtBQUssQ0FBQztRQUNsQyxJQUFNLElBQUksR0FBRyxhQUFhLENBQUMsSUFBSSxDQUFDO1FBQ2hDLElBQU0sUUFBUSxHQUFhLFVBQVUsQ0FBQyxnQkFBZ0IsQ0FBQyxXQUFXLENBQUMsVUFBQyxNQUFjO1lBQ2hGLElBQU0sYUFBYSxHQUFHLEtBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQztZQUN0RSxJQUFNLE9BQU8sR0FBRyxhQUFhLENBQUMsS0FBSyxLQUFLLEtBQUssR0FBRyxDQUFDLElBQUksYUFBYSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDekYsSUFBSSxPQUFPLEVBQUU7Z0JBQ1gsT0FBTyxNQUFNLENBQUM7YUFDZjtpQkFBTTtnQkFDTCxPQUFPLElBQUksQ0FBQzthQUNiO1FBQ0gsQ0FBQyxDQUFDLENBQUM7UUFDSCxPQUFPLFFBQVEsQ0FBQztJQUNsQixDQUFDO0lBQ0gseUJBQUM7QUFBRCxDQUFDLEFBN1hELElBNlhDO0FBRUQsT0FBTyxFQUFFLGtCQUFrQixFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBIdHRwSGVhZGVycyB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcclxuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgb2YgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgbWFwLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IEVudGl0eSwgRmllbGRNZXRhZGF0YVV0aWwsIEZyYW1lQ29udGV4dCwgUmVwb3NpdG9yeSB9IGZyb20gJ0BmYXJyaXMvZGV2a2l0JztcclxuaW1wb3J0IHsgUmVzcG9uc2VJbmZvLCBCZWZSZXBvc2l0b3J5IH0gZnJvbSAnQGZhcnJpcy9iZWYnO1xyXG5cclxuLyoqXHJcbiAqIOi3r+W+hOagkeS7k+W6k1xyXG4gKi9cclxuY2xhc3MgUGF0aFRyZWVSZXBvc2l0b3J5IHtcclxuXHJcbiAgLyoqXHJcbiAgICog5re75Yqg5YWE5byf6IqC54K5XHJcbiAgICovXHJcbiAgcHVibGljIGFkZFNpYmxpbmcocmVwb3NpdG9yeTogQmVmUmVwb3NpdG9yeTxFbnRpdHk+LCBpZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxFbnRpdHk+IHtcclxuICAgIGNvbnN0IHJlc3RTZXJ2aWNlID0gcmVwb3NpdG9yeS5yZXN0U2VydmljZTtcclxuICAgIGNvbnN0IGJhc2VVcmkgPSByZXN0U2VydmljZS5iYXNlVXJpO1xyXG4gICAgY29uc3QgYWRkU2libGluZ1VyaSA9IGAke2Jhc2VVcml9L3NlcnZpY2UvcGF0aGhpZXJhcmNoeWNyZWF0ZXNpYmxpbmdgO1xyXG4gICAgY29uc3QgYm9keSA9IHtcclxuICAgICAgZGF0YUlEOiBpZCxcclxuICAgICAgcmVxdWVzdEluZm86IHJlc3RTZXJ2aWNlLmJ1aWxkUmVxdWVzdEluZm8oKVxyXG4gICAgfTtcclxuICAgIGNvbnN0IG9wdGlvbnMgPSB7XHJcbiAgICAgIGhlYWRlcnM6IG5ldyBIdHRwSGVhZGVycyh7ICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicgfSksXHJcbiAgICAgIGJvZHk6IGJvZHlcclxuICAgIH07XHJcbiAgICByZXR1cm4gcmVzdFNlcnZpY2UuaW52b2tlKGFkZFNpYmxpbmdVcmksICdQVVQnLCBudWxsLCBvcHRpb25zKS5waXBlKFxyXG4gICAgICBtYXAoKHJlc3BvbnNlSW5mbzogUmVzcG9uc2VJbmZvKSA9PiB7XHJcbiAgICAgICAgY29uc3QgZW50aXR5ID0gcmVwb3NpdG9yeS5idWlsZEVudGl0eShyZXNwb25zZUluZm8ucmV0dXJuVmFsdWUpO1xyXG4gICAgICAgIHJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi5hZGRFbnRpdHkoZW50aXR5KTtcclxuICAgICAgICByZXR1cm4gZW50aXR5O1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOa3u+WKoOWFhOW8n+iKgueCuVxyXG4gICAqL1xyXG4gIHB1YmxpYyBhZGRDaGlsZChyZXBvc2l0b3J5OiBCZWZSZXBvc2l0b3J5PEVudGl0eT4sIHBhcmVudElkOiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IHJlc3RTZXJ2aWNlID0gcmVwb3NpdG9yeS5yZXN0U2VydmljZTtcclxuICAgIGNvbnN0IGJhc2VVcmkgPSByZXN0U2VydmljZS5iYXNlVXJpO1xyXG4gICAgY29uc3QgYWRkQ2hpbGRVcmkgPSBgJHtiYXNlVXJpfS9zZXJ2aWNlL3BhdGhoaWVyYXJjaHljcmVhdGVjaGlsZGxheWVyYDtcclxuXHJcbiAgICBjb25zdCBib2R5ID0ge1xyXG4gICAgICBkYXRhSUQ6IHBhcmVudElkLFxyXG4gICAgICByZXF1ZXN0SW5mbzogcmVzdFNlcnZpY2UuYnVpbGRSZXF1ZXN0SW5mbygpXHJcbiAgICB9O1xyXG4gICAgY29uc3Qgb3B0aW9ucyA9IHtcclxuICAgICAgaGVhZGVyczogbmV3IEh0dHBIZWFkZXJzKHsgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyB9KSxcclxuICAgICAgYm9keTogYm9keVxyXG4gICAgfTtcclxuICAgIHJldHVybiByZXN0U2VydmljZS5pbnZva2UoYWRkQ2hpbGRVcmksICdQVVQnLCBudWxsLCBvcHRpb25zKS5waXBlKFxyXG4gICAgICBtYXAoKHJlc3BvbnNlSW5mbzogUmVzcG9uc2VJbmZvKSA9PiB7XHJcbiAgICAgICAgY29uc3QgZW50aXR5ID0gcmVwb3NpdG9yeS5idWlsZEVudGl0eShyZXNwb25zZUluZm8ucmV0dXJuVmFsdWUpO1xyXG4gICAgICAgIHJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi5hZGRFbnRpdHkoZW50aXR5KTtcclxuICAgICAgICByZXR1cm4gZW50aXR5O1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOa3u+WKoOWtkOihqOWFhOW8n+iKgueCuVxyXG4gICAqL1xyXG4gIHB1YmxpYyBhZGRTdWJTaWJsaW5nKHJlcG9zaXRvcnk6IEJlZlJlcG9zaXRvcnk8RW50aXR5Piwgbm9kZXM6IEFycmF5PHN0cmluZz4sIGlkczogQXJyYXk8c3RyaW5nPik6IE9ic2VydmFibGU8RW50aXR5PiB7XHJcbiAgICBjb25zdCByZXN0U2VydmljZSA9IHJlcG9zaXRvcnkucmVzdFNlcnZpY2U7XHJcbiAgICBjb25zdCBiYXNlVXJpID0gcmVzdFNlcnZpY2UuYmFzZVVyaTtcclxuICAgIGNvbnN0IGFkZFN1YlNpYmxpbmdVcmkgPSBgJHtiYXNlVXJpfS9zZXJ2aWNlL2NoaWxkbm9kZXBhdGhoaWVyYXJjaHljcmVhdGVzaWJsaW5nYDtcclxuICAgIGNvbnN0IGJvZHkgPSB7XHJcbiAgICAgIG5vZGVzOiBub2RlcyxcclxuICAgICAgaWRzOiBpZHMsXHJcbiAgICAgIHJlcXVlc3RJbmZvOiByZXN0U2VydmljZS5idWlsZFJlcXVlc3RJbmZvKClcclxuICAgIH07XHJcbiAgICBjb25zdCBvcHRpb25zID0ge1xyXG4gICAgICBoZWFkZXJzOiBuZXcgSHR0cEhlYWRlcnMoeyAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nIH0pLFxyXG4gICAgICBib2R5OiBib2R5XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIHJlc3RTZXJ2aWNlLmludm9rZShhZGRTdWJTaWJsaW5nVXJpLCAnUFVUJywgbnVsbCwgb3B0aW9ucykucGlwZShcclxuICAgICAgbWFwKChyZXNwb25zZUluZm86IFJlc3BvbnNlSW5mbykgPT4ge1xyXG4gICAgICAgIGxldCBwYXRoID0gdGhpcy5nZXRQYXRocyhub2RlcywgaWRzKTtcclxuICAgICAgICBjb25zdCBlbnRpdHkgPSByZXBvc2l0b3J5LmVudGl0eU1hbmFnZXIuYXBwZW5kRW50aXR5QnlQYXRoKHBhdGgsIHJlc3BvbnNlSW5mby5yZXR1cm5WYWx1ZSlcclxuICAgICAgICByZXR1cm4gZW50aXR5O1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICog5re75Yqg5a2Q6KGo5a2Q6IqC54K5XHJcbiAgKi9cclxuICBwdWJsaWMgYWRkU3ViQ2hpbGQocmVwb3NpdG9yeTogQmVmUmVwb3NpdG9yeTxFbnRpdHk+LCBub2RlczogQXJyYXk8c3RyaW5nPiwgaWRzOiBBcnJheTxzdHJpbmc+KSB7XHJcbiAgICBjb25zdCByZXN0U2VydmljZSA9IHJlcG9zaXRvcnkucmVzdFNlcnZpY2U7XHJcbiAgICBjb25zdCBiYXNlVXJpID0gcmVzdFNlcnZpY2UuYmFzZVVyaTtcclxuICAgIGNvbnN0IGFkZFN1YkNoaWxkVXJpID0gYCR7YmFzZVVyaX0vc2VydmljZS9jaGlsZG5vZGVwYXRoaGllcmFyY2h5Y3JlYXRlY2hpbGRsYXllcmA7XHJcblxyXG4gICAgY29uc3QgYm9keSA9IHtcclxuICAgICAgbm9kZXM6IG5vZGVzLFxyXG4gICAgICBpZHM6IGlkcyxcclxuICAgICAgcmVxdWVzdEluZm86IHJlc3RTZXJ2aWNlLmJ1aWxkUmVxdWVzdEluZm8oKVxyXG4gICAgfTtcclxuICAgIGNvbnN0IG9wdGlvbnMgPSB7XHJcbiAgICAgIGhlYWRlcnM6IG5ldyBIdHRwSGVhZGVycyh7ICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicgfSksXHJcbiAgICAgIGJvZHk6IGJvZHlcclxuICAgIH07XHJcbiAgICByZXR1cm4gcmVzdFNlcnZpY2UuaW52b2tlKGFkZFN1YkNoaWxkVXJpLCAnUFVUJywgbnVsbCwgb3B0aW9ucykucGlwZShcclxuICAgICAgbWFwKChyZXNwb25zZUluZm86IFJlc3BvbnNlSW5mbykgPT4ge1xyXG4gICAgICAgIGxldCBwYXRoID0gdGhpcy5nZXRQYXRocyhub2RlcywgaWRzKTtcclxuICAgICAgICBjb25zdCBlbnRpdHkgPSByZXBvc2l0b3J5LmVudGl0eU1hbmFnZXIuYXBwZW5kRW50aXR5QnlQYXRoKHBhdGgsIHJlc3BvbnNlSW5mby5yZXR1cm5WYWx1ZSlcclxuICAgICAgICByZXR1cm4gZW50aXR5O1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0UGF0aHMobm9kZXM6IHN0cmluZ1tdLCBpZHM6IHN0cmluZ1tdKSB7XHJcbiAgICBsZXQgcGF0aHMgPSAnJztcclxuICAgIGlmIChub2RlcyAmJiBub2Rlcy5sZW5ndGggPiAwICYmIGlkcyAmJiBpZHMubGVuZ3RoID4gMCkge1xyXG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGlkcy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgIGlmIChub2Rlc1tpXSkge1xyXG4gICAgICAgICAgcGF0aHMgPSBwYXRocyArIGAvJHtpZHNbaV19YDtcclxuICAgICAgICAgIHBhdGhzID0gcGF0aHMgKyBgLyR7bm9kZXNbaV19c2A7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcGF0aHM7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDliqDovb3niLboioLngrlcclxuICAgKi9cclxuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IG1heC1saW5lLWxlbmd0aFxyXG4gIHB1YmxpYyBsb2FkQnlQYXJlbnRJZChyZXBvc2l0b3J5OiBCZWZSZXBvc2l0b3J5PEVudGl0eT4sIGhpZXJhcmNoeUluZm9LZXk6IHN0cmluZywgcGFyZW50SWQ6IHN0cmluZywgZmlsdGVyczogYW55W10sIHNvcnRzOiBhbnlbXSwgZnJvemVuQ3VycmVudFJvdzogYm9vbGVhbiA9IGZhbHNlLCBwYWdpbmF0aW9uPzogeyBwYWdlU2l6ZTogbnVtYmVyLCBwYWdlSW5kZXg6IG51bWJlciB9LCBmcmFtZUNvbnRleHQ/OiBGcmFtZUNvbnRleHQsIHJlbG9hZDogYm9vbGVhbiA9IGZhbHNlKTogT2JzZXJ2YWJsZTxFbnRpdHlbXT4ge1xyXG4gICAgY29uc3QgbG9jYWxFbnRpdGllcyA9IHRoaXMuZ2V0Q2hpbGRyZW4ocmVwb3NpdG9yeSwgaGllcmFyY2h5SW5mb0tleSwgcGFyZW50SWQpO1xyXG4gICAgaWYgKGxvY2FsRW50aXRpZXMgJiYgbG9jYWxFbnRpdGllcy5sZW5ndGggPiAwICYmICFyZWxvYWQpIHtcclxuICAgICAgcmV0dXJuIG9mKGxvY2FsRW50aXRpZXMpO1xyXG4gICAgfVxyXG4gICAgY29uc3QgcmVzdFNlcnZpY2UgPSByZXBvc2l0b3J5LnJlc3RTZXJ2aWNlO1xyXG4gICAgY29uc3QgcGFyZW50SGllcmFyY2h5SW5mbyA9IHRoaXMuZ2V0SGllcmFyY2h5SW5mb0J5SWQocmVwb3NpdG9yeSwgaGllcmFyY2h5SW5mb0tleSwgcGFyZW50SWQpO1xyXG4gICAgY29uc3Qgb3JpZ2luYWxIaWVyYXJjaHlJbmZvS2V5ID0gdGhpcy5nZXRPcmlnaW5hbEhpZXJhcmNoeUluZm9LZXkocmVwb3NpdG9yeSwgaGllcmFyY2h5SW5mb0tleSk7XHJcbiAgICBjb25zdCBmaWx0ZXJzV2l0aFBhcmVudCA9IHRoaXMuYnVpbGRGaWx0ZXJzV2l0aFBhcmVudChvcmlnaW5hbEhpZXJhcmNoeUluZm9LZXksIHBhcmVudEhpZXJhcmNoeUluZm8sIGZpbHRlcnMpO1xyXG4gICAgY29uc3QgaXNVc2VQYWdpbmF0aW9uID0gcGFnaW5hdGlvbiAmJiBwYWdpbmF0aW9uLnBhZ2VTaXplID4gMCB8fCBmYWxzZTtcclxuICAgIC8vIOe7hOe7h0VudGl0eUZpbHRlclxyXG4gICAgY29uc3QgZW50aXR5RmlsdGVyID0ge1xyXG4gICAgICBGaWx0ZXJDb25kaXRpb25zOiBmaWx0ZXJzV2l0aFBhcmVudCxcclxuICAgICAgU29ydENvbmRpdGlvbnM6IHNvcnRzLFxyXG4gICAgICBJc1VzZVBhZ2luYXRpb246IGlzVXNlUGFnaW5hdGlvbixcclxuICAgICAgUGFnaW5hdGlvbjogeyBQYWdlSW5kZXg6IHBhZ2luYXRpb24gJiYgcGFnaW5hdGlvbi5wYWdlSW5kZXggfHwgMCwgUGFnZVNpemU6IHBhZ2luYXRpb24gJiYgcGFnaW5hdGlvbi5wYWdlU2l6ZSB8fCAwLCBQYWdlQ291bnQ6IDAsIFRvdGFsQ291bnQ6IDAgfVxyXG4gICAgfTtcclxuICAgIGNvbnN0IHJlcXVlc3RJbmZvID0gcmVzdFNlcnZpY2UuYnVpbGRSZXF1ZXN0SW5mbygpO1xyXG4gICAgcmV0dXJuIHJlc3RTZXJ2aWNlLmV4dGVuZFF1ZXJ5KGVudGl0eUZpbHRlciwgcmVxdWVzdEluZm8pLnBpcGUoXHJcbiAgICAgIG1hcCgocmVzcG9uc2VJbmZvOiBSZXNwb25zZUluZm8pID0+IHtcclxuICAgICAgICBjb25zdCBwYWdpbmF0aW9uSW5mbyA9IHRoaXMuZ2V0UGFnaW5hdGlvbkluZm8ocmVzcG9uc2VJbmZvKTtcclxuICAgICAgICBpZiAocGFyZW50SWQpIHtcclxuICAgICAgICAgIGlmIChwYWdpbmF0aW9uSW5mbyAmJiBwYWdpbmF0aW9uSW5mby5wYWdlU2l6ZSAhPT0gMCAmJiBmcmFtZUNvbnRleHQpIHtcclxuICAgICAgICAgICAgZnJhbWVDb250ZXh0LnBhcmFtcy5zZXQoYF9OT0RFXyR7cGFyZW50SWR9X1BBR0lOQVRJT05fSU5GT19gLCBwYWdpbmF0aW9uSW5mbyk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIGlmIChwYWdpbmF0aW9uSW5mbyAmJiBwYWdpbmF0aW9uSW5mby5wYWdlU2l6ZSAhPT0gMCAmJiBmcmFtZUNvbnRleHQpIHtcclxuICAgICAgICAgICAgZnJhbWVDb250ZXh0LnJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi51cGRhdGVQYWdpbmF0aW9uSW5mb0J5UGF0aCgnLycsIHBhZ2luYXRpb25JbmZvKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgLy8g5YWI5riF56m65LiL57qn5a6e5L2TXHJcbiAgICAgICAgdGhpcy5jbGVhckRlc2NlbmRhbnRFbnRpdGllcyhyZXBvc2l0b3J5LCBoaWVyYXJjaHlJbmZvS2V5LCBwYXJlbnRIaWVyYXJjaHlJbmZvLCBmcm96ZW5DdXJyZW50Um93KTtcclxuICAgICAgICAvLyDov73liqDkuIvnuqflrp7kvZNcclxuICAgICAgICBjb25zdCBsaXN0RGF0YSA9IHJlc3BvbnNlSW5mby5yZXR1cm5WYWx1ZS5yZXN1bHQ7XHJcbiAgICAgICAgY29uc3QgZW50aXRpZXMgPSByZXBvc2l0b3J5LmJ1aWxkRW50aXRpZXMobGlzdERhdGEpO1xyXG4gICAgICAgIGlmIChmcm96ZW5DdXJyZW50Um93KSB7XHJcbiAgICAgICAgICByZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24uYWRkRGF0YShlbnRpdGllcyk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi5hZGRFbnRpdGllcyhlbnRpdGllcyk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gZW50aXRpZXM7XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IG1heC1saW5lLWxlbmd0aFxyXG4gIHB1YmxpYyBsb2FkRnVsbFRyZWUocmVwb3NpdG9yeTogQmVmUmVwb3NpdG9yeTxFbnRpdHk+LCBoaWVyYXJjaHlJbmZvS2V5OiBzdHJpbmcsIHBhcmVudElkOiBzdHJpbmcsIHByb3BlcnR5TmFtZTogc3RyaW5nLCBmdWxsVHJlZVR5cGU6IHN0cmluZywgbG9hZFR5cGU6IHN0cmluZywgZmlsdGVycz86IGFueVtdLCBjb250ZXh0PzogYW55KTogT2JzZXJ2YWJsZTxFbnRpdHlbXT4ge1xyXG4gICAgY29uc3QgcmVzdFNlcnZpY2UgPSByZXBvc2l0b3J5LnJlc3RTZXJ2aWNlO1xyXG4gICAgY29uc3QgYmFzZVVyaSA9IHJlc3RTZXJ2aWNlLmJhc2VVcmk7XHJcbiAgICBjb25zdCBxdWVyeVVybCA9IGAke2Jhc2VVcml9L3NlcnZpY2UvcGFyZW50aWRmdWxsdHJlZXF1ZXJ5YDtcclxuICAgIGNvbnN0IHBhdGhIaWVyYXJjaHlJbmZvID0gdGhpcy5nZXRIaWVyYXJjaHlJbmZvQnlJZChyZXBvc2l0b3J5LCBoaWVyYXJjaHlJbmZvS2V5LCBwYXJlbnRJZCk7XHJcbiAgICBjb25zdCBlbnRpdHlGaWx0ZXIgPSB0aGlzLmJ1aWxkRW50aXR5RmlsdGVyKGZpbHRlcnMsIG51bGwsIDAsIDApO1xyXG4gICAgY29uc3QgYm9keSA9IHtcclxuICAgICAgZGF0YUlkOiBwYXJlbnRJZCB8fCAnJyxcclxuICAgICAgaXNVc2VQYWdpbmF0aW9uOiBmYWxzZSxcclxuICAgICAgdmlydHVhbFByb3BlcnR5TmFtZTogcHJvcGVydHlOYW1lLFxyXG4gICAgICBwYWdpbmF0aW9uOiB7fSxcclxuICAgICAgZnVsbFRyZWVUeXBlLFxyXG4gICAgICBsb2FkVHlwZSxcclxuICAgICAgZmlsdGVyOiBlbnRpdHlGaWx0ZXIsXHJcbiAgICAgIHJlcXVlc3RJbmZvOiByZXN0U2VydmljZS5idWlsZFJlcXVlc3RJbmZvKClcclxuICAgIH07XHJcbiAgICBjb25zdCBvcHRpb25zID0ge1xyXG4gICAgICBib2R5OiBib2R5XHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIHJlc3RTZXJ2aWNlLmludm9rZShxdWVyeVVybCwgJ1BVVCcsIG51bGwsIG9wdGlvbnMpLnBpcGUoXHJcbiAgICAgIHRhcCgocmVzcG9uc2VJbmZvOiBSZXNwb25zZUluZm8pID0+IHtcclxuICAgICAgICAvLyDkv53lrZjlsZXlvIDnmoToioLngrlcclxuICAgICAgICBpZiAocmVzcG9uc2VJbmZvLnJldHVyblZhbHVlICYmIHJlc3BvbnNlSW5mby5yZXR1cm5WYWx1ZS5zZWxlY3RlZFJvd0lkICYmIGNvbnRleHQgJiYgY29udGV4dC5mcmFtZUNvbnRleHQpIHtcclxuICAgICAgICAgIGNvbnN0IGZyYW1lQ29udGV4dCA9IGNvbnRleHQuZnJhbWVDb250ZXh0IGFzIEZyYW1lQ29udGV4dDtcclxuICAgICAgICAgIGNvbnN0IHZpcnR1YWxSb290RnJhbWVDb250ZXh0ID0gZnJhbWVDb250ZXh0ICYmIGZyYW1lQ29udGV4dC5nZXRWaXJ0dWFsUm9vdEZyYW1lQ29udGV4dCgpIHx8IG51bGw7XHJcbiAgICAgICAgICBpZiAodmlydHVhbFJvb3RGcmFtZUNvbnRleHQpIHtcclxuICAgICAgICAgICAgY29uc3QgbGlzdCA9IHJlc3BvbnNlSW5mby5yZXR1cm5WYWx1ZS5yZXN1bHQgYXMgYW55W107XHJcbiAgICAgICAgICAgIGNvbnN0IHNlbGVjdGVkUm93SWQgPSByZXNwb25zZUluZm8ucmV0dXJuVmFsdWUuc2VsZWN0ZWRSb3dJZDtcclxuICAgICAgICAgICAgLy8g5LuO6aG25bGC5byA5aeL6K6h566X5omA5pyJ6ZyA6KaB5bGV5byA55qE6IqC54K5XHJcbiAgICAgICAgICAgIGNvbnN0IGxlYWZOb2RlSW5mbyA9IGxpc3QuZmluZChpdGVtID0+IGl0ZW1bcmVwb3NpdG9yeS5wcmltYXJ5S2V5XSA9PT0gc2VsZWN0ZWRSb3dJZCk7XHJcbiAgICAgICAgICAgIGNvbnN0IGhpZXJhcmNoeUluZm8gPSBsZWFmTm9kZUluZm9baGllcmFyY2h5SW5mb0tleV0gYXMgeyBpc0RldGFpbDogYm9vbGVhbiwgbGF5ZXI6IG51bWJlciwgcGF0aDogc3RyaW5nIH07XHJcbiAgICAgICAgICAgIGNvbnN0IGlkcyA9IHRoaXMuZ2V0QWxsUGFyZW50SWRzKGhpZXJhcmNoeUluZm8sIGxpc3QsIGhpZXJhcmNoeUluZm9LZXksIHJlcG9zaXRvcnkpO1xyXG4gICAgICAgICAgICB2aXJ0dWFsUm9vdEZyYW1lQ29udGV4dC5wYXJhbXMuc2V0KCdfREVWS0lUX2V4cGFuZFJvd0lkcycsIGlkcy5qb2luKCcsJykpO1xyXG4gICAgICAgICAgICB2aXJ0dWFsUm9vdEZyYW1lQ29udGV4dC5wYXJhbXMuc2V0KCdfREVWS0lUX3NlbGVjdGVkUm93SWQnLCBzZWxlY3RlZFJvd0lkKTtcclxuICAgICAgICAgICAgdmlydHVhbFJvb3RGcmFtZUNvbnRleHQudWlTdGF0ZS5zZXRQcm9wZXJ0eVZhbHVlKCdfX0RFVktJVF9fc2VsZWN0ZWRSb3cnLCBzZWxlY3RlZFJvd0lkKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH0pLFxyXG4gICAgICBtYXAoKHJlc3BvbnNlSW5mbzogUmVzcG9uc2VJbmZvKSA9PiB7XHJcbiAgICAgICAgY29uc3QgZnJvemVuQ3VycmVudFJvdzogYm9vbGVhbiA9IGNvbnRleHQgJiYgY29udGV4dC5mcm96ZW5DdXJyZW50Um93IHx8IGZhbHNlO1xyXG4gICAgICAgIC8vIOWFiOa4heepuuS4i+e6p+WunuS9k1xyXG4gICAgICAgIHRoaXMuY2xlYXJEZXNjZW5kYW50RW50aXRpZXMocmVwb3NpdG9yeSwgaGllcmFyY2h5SW5mb0tleSwgcGF0aEhpZXJhcmNoeUluZm8sIGZyb3plbkN1cnJlbnRSb3cpO1xyXG4gICAgICAgIC8vIOi/veWKoOS4i+e6p+WunuS9k1xyXG4gICAgICAgIGNvbnN0IGxpc3REYXRhID0gcmVzcG9uc2VJbmZvLnJldHVyblZhbHVlLnJlc3VsdDtcclxuICAgICAgICBjb25zdCBlbnRpdGllcyA9IHJlcG9zaXRvcnkuYnVpbGRFbnRpdGllcyhsaXN0RGF0YSk7XHJcbiAgICAgICAgaWYgKGZyb3plbkN1cnJlbnRSb3cpIHtcclxuICAgICAgICAgIHJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi5hZGREYXRhKGVudGl0aWVzKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgcmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLmFkZEVudGl0aWVzKGVudGl0aWVzKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGVudGl0aWVzO1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5o+S5YWl5a+554i26IqC54K555qE6L+H5rukXHJcbiAgICovXHJcbiAgcHVibGljIGJ1aWxkRmlsdGVyc1dpdGhQYXJlbnQob3JpZ2luYWxIaWVyYXJjaHlJbmZvS2V5OiBzdHJpbmcsIHBhcmVudEhpZXJhcmNoeUluZm86IGFueSwgZmlsdGVyQXJyYXk6IGFueVtdKTogYW55IHtcclxuICAgIGNvbnN0IHJlbGF0aW9uVHlwZSA9IGZpbHRlckFycmF5ICYmIGZpbHRlckFycmF5Lmxlbmd0aCA+PSAxID8gMSA6IDA7XHJcblxyXG4gICAgY29uc3QgcGFyZW50TGF5ZXIgPSBwYXJlbnRIaWVyYXJjaHlJbmZvID8gcGFyZW50SGllcmFyY2h5SW5mb1snbGF5ZXInXSA6IDA7XHJcbiAgICBjb25zdCBwYXJlbnRGaWx0ZXJBcnJheSA9IFtcclxuICAgICAge1xyXG4gICAgICAgIFwiRmlsdGVyRmllbGRcIjogYCR7b3JpZ2luYWxIaWVyYXJjaHlJbmZvS2V5fS5MYXllcmAsXHJcbiAgICAgICAgXCJWYWx1ZVwiOiBwYXJlbnRMYXllciArIDEsXHJcbiAgICAgICAgXCJMYnJhY2tldFwiOiBudWxsLFxyXG4gICAgICAgIFwiUmJyYWNrZXRcIjogbnVsbCxcclxuICAgICAgICBcIlJlbGF0aW9uXCI6IDEsXHJcbiAgICAgICAgXCJFeHByZXNzdHlwZVwiOiAwLFxyXG4gICAgICAgIFwiQ29tcGFyZVwiOiAwXHJcbiAgICAgIH1cclxuICAgIF07XHJcblxyXG4gICAgLy8g54i26Lev5b6E6L+H5ruk77yM5aaC5p6c5Li656m677yM5YiZ5LiN5re75Yqg77yI5YW85a65b3JhY2xl5Y+W5pWw77yJXHJcbiAgICBjb25zdCBwYXJlbnRQYXRoID0gcGFyZW50SGllcmFyY2h5SW5mbyA/IHBhcmVudEhpZXJhcmNoeUluZm9bJ3BhdGgnXSA6ICcnO1xyXG4gICAgaWYgKHBhcmVudFBhdGgpIHtcclxuICAgICAgcGFyZW50RmlsdGVyQXJyYXkucHVzaCh7XHJcbiAgICAgICAgXCJGaWx0ZXJGaWVsZFwiOiBgJHtvcmlnaW5hbEhpZXJhcmNoeUluZm9LZXl9LlBhdGhgLFxyXG4gICAgICAgIFwiVmFsdWVcIjogcGFyZW50UGF0aCxcclxuICAgICAgICBcIkxicmFja2V0XCI6IG51bGwsXHJcbiAgICAgICAgXCJSYnJhY2tldFwiOiBudWxsLFxyXG4gICAgICAgIFwiUmVsYXRpb25cIjogcmVsYXRpb25UeXBlLFxyXG4gICAgICAgIFwiRXhwcmVzc3R5cGVcIjogMCxcclxuICAgICAgICBcIkNvbXBhcmVcIjogN1xyXG4gICAgICB9KTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHBhcmVudEZpbHRlckFycmF5WzBdLlJlbGF0aW9uID0gcmVsYXRpb25UeXBlO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBwYXJlbnRGaWx0ZXJBcnJheS5jb25jYXQoZmlsdGVyQXJyYXkpO1xyXG4gIH1cclxuICBwdWJsaWMgYnVpbGRFbnRpdHlGaWx0ZXIoZmlsdGVyOiBhbnlbXSwgc29ydDogYW55W10sIHBhZ2VTaXplOiBudW1iZXIsIHBhZ2VJbmRleDogbnVtYmVyKSB7XHJcblxyXG4gICAgLy8gQHRvZG/vvJrkuLTml7blhbzlrrnogIHku6PnoIHvvIzpmY3kvY7mlLnliqjluKbmnaXnmoTpo47pmalcclxuICAgIGlmICghZmlsdGVyICYmICFzb3J0ICYmICFwYWdlU2l6ZSAmJiAhcGFnZUluZGV4KSB7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gICAgaWYgKCFmaWx0ZXIpIHtcclxuICAgICAgZmlsdGVyID0gW107XHJcbiAgICB9XHJcbiAgICBpZiAoIXNvcnQpIHtcclxuICAgICAgc29ydCA9IFtdO1xyXG4gICAgfVxyXG4gICAgLy8g57qg5q2j5pyA5ZCO5LiA5Liq6L+H5ruk5p2h5Lu255qEUmVsYXRpb25cclxuICAgIGlmIChmaWx0ZXIgJiYgZmlsdGVyLmxlbmd0aCA+IDApIHtcclxuICAgICAgZmlsdGVyW2ZpbHRlci5sZW5ndGggLSAxXS5SZWxhdGlvbiA9IDA7XHJcbiAgICB9XHJcbiAgICBjb25zdCBlbnRpdHlGaWx0ZXIgPSB7XHJcbiAgICAgIEZpbHRlckNvbmRpdGlvbnM6IGZpbHRlcixcclxuICAgICAgU29ydENvbmRpdGlvbnM6IHNvcnQsXHJcbiAgICAgIElzVXNlUGFnaW5hdGlvbjogcGFnZVNpemUgPT09IDAgPyBmYWxzZSA6IHRydWUsXHJcbiAgICAgIFBhZ2luYXRpb246IHtcclxuICAgICAgICBQYWdlSW5kZXg6IHBhZ2VJbmRleCxcclxuICAgICAgICBQYWdlU2l6ZTogcGFnZVNpemUsXHJcbiAgICAgICAgUGFnZUNvdW50OiAwLFxyXG4gICAgICAgIFRvdGFsQ291bnQ6IDBcclxuICAgICAgfVxyXG4gICAgfTtcclxuICAgIHJldHVybiBlbnRpdHlGaWx0ZXI7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOa4heepuuWQjuS7o+WunuS9k1xyXG4gICAqL1xyXG4gIHB1YmxpYyBjbGVhckRlc2NlbmRhbnRFbnRpdGllcyhyZXBvc2l0b3J5OiBCZWZSZXBvc2l0b3J5PEVudGl0eT4sIGhpZXJhcmNoeUluZm9rZXk6IHN0cmluZywgcGFyZW50SGllcmFyY2h5SW5mbzogYW55LCBmcm96ZW5DdXJyZW50Um93OiBib29sZWFuID0gZmFsc2UpOiB2b2lkIHtcclxuXHJcbiAgICAvLyDmuIXnqbrmoLnoioLngrlcclxuICAgIGlmICghcGFyZW50SGllcmFyY2h5SW5mbykge1xyXG4gICAgICByZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24uY2xlYXIoKTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgY29uc3QgZlBhdGggPSBwYXJlbnRIaWVyYXJjaHlJbmZvLnBhdGg7XHJcbiAgICBjb25zdCBmTGF5ZXIgPSBwYXJlbnRIaWVyYXJjaHlJbmZvLmxheWVyO1xyXG4gICAgaWYgKGZyb3plbkN1cnJlbnRSb3cpIHtcclxuICAgICAgcmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLnJlbW92ZURhdGEoKGVudGl0eTogRW50aXR5KSA9PiB7XHJcbiAgICAgICAgY29uc3QgaGllcmFyY2h5SW5mbyA9IGVudGl0eVtoaWVyYXJjaHlJbmZva2V5XTtcclxuICAgICAgICBjb25zdCBwYXRoID0gaGllcmFyY2h5SW5mby5wYXRoO1xyXG4gICAgICAgIGNvbnN0IGxheWVyID0gaGllcmFyY2h5SW5mby5sYXllcjtcclxuICAgICAgICByZXR1cm4gbGF5ZXIgPiBmTGF5ZXIgJiYgcGF0aC5zdGFydHNXaXRoKGZQYXRoKTtcclxuICAgICAgfSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24ucmVtb3ZlRW50aXRpZXMoKGVudGl0eTogRW50aXR5KSA9PiB7XHJcbiAgICAgICAgY29uc3QgaGllcmFyY2h5SW5mbyA9IGVudGl0eVtoaWVyYXJjaHlJbmZva2V5XTtcclxuICAgICAgICBjb25zdCBwYXRoID0gaGllcmFyY2h5SW5mby5wYXRoO1xyXG4gICAgICAgIGNvbnN0IGxheWVyID0gaGllcmFyY2h5SW5mby5sYXllcjtcclxuICAgICAgICByZXR1cm4gbGF5ZXIgPiBmTGF5ZXIgJiYgcGF0aC5zdGFydHNXaXRoKGZQYXRoKTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6I635Y+W5a6e5L2T55qE5YiG57qn5L+h5oGvXHJcbiAgICovXHJcbiAgcHVibGljIGdldEhpZXJhcmNoeUluZm9CeUlkKHJlcG9zaXRvcnk6IEJlZlJlcG9zaXRvcnk8RW50aXR5PiwgaGllcmFyY2h5SW5mb2tleTogc3RyaW5nLCBpZDogc3RyaW5nKTogYW55IHtcclxuICAgIGlmICghaWQpIHtcclxuICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcbiAgICBjb25zdCBlbnRpdHk6IEVudGl0eSA9IHJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi5nZXRFbnRpdHlCeUlkKGlkKTtcclxuICAgIGNvbnN0IGhpZXJhcmNoeUluZm9FbnRpdHk6IEVudGl0eSA9IGVudGl0eVtoaWVyYXJjaHlJbmZva2V5XTtcclxuICAgIHJldHVybiBoaWVyYXJjaHlJbmZvRW50aXR5LnRvSlNPTigpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6I635Y+W5YiG57qn56CB55qE5Y6f5aeL55qE5a2X5q615ZCNXHJcbiAgICovXHJcbiAgcHVibGljIGdldE9yaWdpbmFsSGllcmFyY2h5SW5mb0tleShyZXBvc2l0b3J5OiBCZWZSZXBvc2l0b3J5PEVudGl0eT4sIGhpZXJhcmNoeUluZm9rZXk6IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICBjb25zdCBuZ09iamVjdHMgPSBGaWVsZE1ldGFkYXRhVXRpbC5nZXROZ09iamVjdHMocmVwb3NpdG9yeS5lbnRpdHlUeXBlKTtcclxuICAgIGNvbnN0IGhpZXJhcmNoeUluZm9OZ09iamVjdCA9IG5nT2JqZWN0c1toaWVyYXJjaHlJbmZva2V5XTtcclxuICAgIHJldHVybiBoaWVyYXJjaHlJbmZvTmdPYmplY3Qub3JpZ2luYWxEYXRhRmllbGQgYXMgc3RyaW5nO1xyXG4gIH1cclxuICBwcml2YXRlIGdldFBhZ2luYXRpb25JbmZvKHJlc3BvbnNlSW5mbzogUmVzcG9uc2VJbmZvKSB7XHJcbiAgICByZXR1cm4gcmVzcG9uc2VJbmZvICYmIHJlc3BvbnNlSW5mby5yZXR1cm5WYWx1ZSAmJiByZXNwb25zZUluZm8ucmV0dXJuVmFsdWUucGFnaW5hdGlvbiB8fCBudWxsO1xyXG4gIH1cclxuICBwcml2YXRlIGZpbmRQYXJlbnQoaGllcmFyY2h5SW5mbzogeyBpc0RldGFpbDogYm9vbGVhbiwgbGF5ZXI6IG51bWJlciwgcGF0aDogc3RyaW5nIH0sIGxpc3Q6IGFueVtdLCBoaWVyYXJjaHlJbmZvS2V5OiBzdHJpbmcpIHtcclxuICAgIHJldHVybiBsaXN0LmZpbmQoaXRlbSA9PiB7XHJcbiAgICAgIGNvbnN0IGN1cnJlbnRIaWVyYXJjaHlJbmZvID0gaXRlbVtoaWVyYXJjaHlJbmZvS2V5XSBhcyB7IGlzRGV0YWlsOiBib29sZWFuLCBsYXllcjogbnVtYmVyLCBwYXRoOiBzdHJpbmcgfTtcclxuICAgICAgcmV0dXJuIGN1cnJlbnRIaWVyYXJjaHlJbmZvLmxheWVyID09PSBoaWVyYXJjaHlJbmZvLmxheWVyIC0gMSAmJiBoaWVyYXJjaHlJbmZvLnBhdGguc3RhcnRzV2l0aChjdXJyZW50SGllcmFyY2h5SW5mby5wYXRoKTtcclxuICAgIH0pO1xyXG4gIH1cclxuICBwcml2YXRlIGdldEFsbFBhcmVudElkcyhoaWVyYXJjaHlJbmZvOiB7IGlzRGV0YWlsOiBib29sZWFuLCBsYXllcjogbnVtYmVyLCBwYXRoOiBzdHJpbmcgfSwgbGlzdDogYW55W10sIGhpZXJhcmNoeUluZm9LZXk6IHN0cmluZywgcmVwb3NpdG9yeTogUmVwb3NpdG9yeTxhbnk+KSB7XHJcbiAgICBsZXQgaXRlbSA9IHRoaXMuZmluZFBhcmVudChoaWVyYXJjaHlJbmZvLCBsaXN0LCBoaWVyYXJjaHlJbmZvS2V5KTtcclxuICAgIGNvbnN0IGlkcyA9IFtdO1xyXG4gICAgd2hpbGUgKGl0ZW0pIHtcclxuICAgICAgaWRzLnB1c2goaXRlbVtyZXBvc2l0b3J5LnByaW1hcnlLZXldKTtcclxuICAgICAgaXRlbSA9IHRoaXMuZmluZFBhcmVudChpdGVtW2hpZXJhcmNoeUluZm9LZXldLCBsaXN0LCBoaWVyYXJjaHlJbmZvS2V5KTtcclxuICAgIH1cclxuICAgIHJldHVybiBpZHM7XHJcbiAgfVxyXG4gIHByaXZhdGUgZ2V0SGllcmFyY2h5SW5mbyhlbnRpdHk6IEVudGl0eSwgaGllcmFyY2h5SW5mb0tleTogc3RyaW5nKTogeyBwYXRoOiBzdHJpbmcsIGxheWVyOiBudW1iZXIsIGlzRGV0YWlsOiBib29sZWFuIH0ge1xyXG4gICAgcmV0dXJuIGVudGl0eVtoaWVyYXJjaHlJbmZvS2V5XTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5p+l5om+6IqC54K55LiL5omA5pyJ5a2Q57qn77yI56ys5LiA57qn77yJXHJcbiAgICogQHBhcmFtIHJlcG9zaXRvcnkgcmVwb3NpdG9yeVxyXG4gICAqIEBwYXJhbSBoaWVyYXJjaHlJbmZvS2V5IOWIhue6p+eggeWtl+autVxyXG4gICAqIEBwYXJhbSBpZCBpZFxyXG4gICAqIEByZXR1cm5zIFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0Q2hpbGRyZW4ocmVwb3NpdG9yeTogQmVmUmVwb3NpdG9yeTxFbnRpdHk+LCBoaWVyYXJjaHlJbmZvS2V5OiBzdHJpbmcsIGlkOiBzdHJpbmcpOiBFbnRpdHlbXSB7XHJcbiAgICBjb25zdCBoaWVyYXJjaHlJbmZvID0gdGhpcy5nZXRIaWVyYXJjaHlJbmZvQnlJZChyZXBvc2l0b3J5LCBoaWVyYXJjaHlJbmZvS2V5LCBpZCk7XHJcbiAgICBpZiAoIWhpZXJhcmNoeUluZm8pIHtcclxuICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcbiAgICBjb25zdCBsYXllciA9IGhpZXJhcmNoeUluZm8ubGF5ZXI7XHJcbiAgICBjb25zdCBwYXRoID0gaGllcmFyY2h5SW5mby5wYXRoO1xyXG4gICAgY29uc3QgZW50aXRpZXM6IEVudGl0eVtdID0gcmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLmdldEVudGl0aWVzKChlbnRpdHk6IEVudGl0eSkgPT4ge1xyXG4gICAgICBjb25zdCBoaWVyYXJjaHlJbmZvID0gdGhpcy5nZXRIaWVyYXJjaHlJbmZvKGVudGl0eSwgaGllcmFyY2h5SW5mb0tleSk7XHJcbiAgICAgIGNvbnN0IG1hdGNoZWQgPSBoaWVyYXJjaHlJbmZvLmxheWVyID09PSBsYXllciArIDEgJiYgaGllcmFyY2h5SW5mby5wYXRoLnN0YXJ0c1dpdGgocGF0aCk7XHJcbiAgICAgIGlmIChtYXRjaGVkKSB7XHJcbiAgICAgICAgcmV0dXJuIGVudGl0eTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gZW50aXRpZXM7XHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgeyBQYXRoVHJlZVJlcG9zaXRvcnkgfTtcclxuIl19