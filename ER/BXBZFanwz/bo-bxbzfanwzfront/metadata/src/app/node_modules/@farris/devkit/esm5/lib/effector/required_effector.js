import * as tslib_1 from "tslib";
import { Inject, Injectable, Injector } from '@angular/core';
import { FrameContext, NAMESPACE } from "../frame/index";
import { TranslateToken } from '../i18n';
import { Repository } from '../repository/index';
/**
 * 必填副作用器
 * @description 当结算结果为true时设置必填校验，否则删除必填校验
 */
var RequiredEffector = /** @class */ (function () {
    function RequiredEffector(injector, repository, namespace, frameContext) {
        this.injector = injector;
        this.repository = repository;
        this.namespace = namespace;
        this.frameContext = frameContext;
        this.ns = namespace;
    }
    RequiredEffector.prototype.effect = function (path, value, options) {
        var _a;
        // 校验不通过时返回false
        var domInfo = this.getDomInfoByEntityPath(path);
        if (!domInfo) {
            return;
        }
        var frameContext = domInfo.frameContext;
        var rootFrameContext = frameContext && frameContext.getVirtualRootFrameContext();
        var rootViewModel = rootFrameContext.viewModel;
        var domPropertyName = domInfo.domPropertyName;
        var pathValue = this.frameContext.bindingData.getValue(path.split('/').filter(function (p) { return p; }));
        var expressionId = options.expressionId;
        if (expressionId) {
            // 增加校验规则
            frameContext.form.addFieldValidateRule(domPropertyName, options.message, expressionId, "require" /* Require */);
        }
        if (value === true) {
            if (options.message) {
                // 更新form错误信息
                // 不是grid，则认为是卡片
                if (!domInfo.isGridComponent) {
                    var message = options.message.replace(/\$property/g, domInfo.propertyName);
                    var formErrors = this.buildFormErrors(domPropertyName, message);
                    var isValidValue = this.isValidValue(path, pathValue);
                    if (!isValidValue) {
                        frameContext.form.updateFormErrors(formErrors);
                    }
                }
                else {
                    this.updateColumnValidators(frameContext, domInfo.binding, domInfo.datagridColumns, true);
                }
            }
        }
        else {
            // 返回非true值时认为非必填
            if (domInfo.isGridComponent) {
                this.updateColumnValidators(frameContext, domInfo.binding, domInfo.datagridColumns, false);
            }
            else {
                var currentErrors = frameContext.form.getFormControlErrors(domPropertyName) || null;
                if (currentErrors) {
                    if (currentErrors.hasOwnProperty('require')) {
                        // require合法，移除require校验提示
                        delete currentErrors.require;
                    }
                    frameContext.form.updateFormErrors((_a = {}, _a[domPropertyName] = { errors: currentErrors }, _a));
                }
                else {
                    var formErrors = this.buildFormErrors(domPropertyName, null);
                    frameContext.form.updateFormErrors(formErrors);
                }
            }
        }
    };
    RequiredEffector.prototype.updateColumnValidators = function (frameContext, field, datagridColumns, isRequired) {
        var frameId = frameContext.frameId;
        var componentRefs = frameContext.appContext.componentManager.get([frameId]);
        if (componentRefs && componentRefs.size > 0) {
            var datagrid = Array.from(componentRefs.values())[0];
            if (datagrid && typeof datagrid.updateColumn === 'function') {
                var columns = datagridColumns.find(function (array) {
                    return array.find(function (item) { return item.field === field; });
                });
                var column = columns && columns.find(function (item) { return item.field === field; }) || null;
                if (column) {
                    var validators = column.validators || [];
                    var index = validators.findIndex(function (item) { return item.type === 'required'; });
                    if (isRequired) {
                        if (index === -1) {
                            validators.push({ "type": "required", "message": "该字段不能为空！" });
                        }
                    }
                    else {
                        if (index !== -1) {
                            validators.splice(index, 1);
                        }
                    }
                    datagrid.updateColumn(field, { validators: tslib_1.__spread(validators) });
                    datagrid.columnsChanged();
                }
            }
        }
    };
    RequiredEffector.prototype.getDomInfoByEntityPath = function (entityPath) {
        var e_1, _a, e_2, _b;
        var result = null;
        if (!entityPath) {
            return result;
        }
        entityPath = entityPath.split('/').filter(function (p) { return p; }).join('.');
        var frameContexts = this.frameContext && this.frameContext.appContext.frameContextManager.getFrameContextsByNamespace(this.namespace) || null;
        if (frameContexts && frameContexts.length > 0) {
            try {
                for (var frameContexts_1 = tslib_1.__values(frameContexts), frameContexts_1_1 = frameContexts_1.next(); !frameContexts_1_1.done; frameContexts_1_1 = frameContexts_1.next()) {
                    var frameContext = frameContexts_1_1.value;
                    if (result) {
                        break;
                    }
                    if (frameContext && frameContext.form && frameContext.form.ngFormControls && Object.keys(frameContext.form.ngFormControls).length > 0) {
                        var keys = Object.keys(frameContext.form.ngFormControls);
                        try {
                            for (var keys_1 = tslib_1.__values(keys), keys_1_1 = keys_1.next(); !keys_1_1.done; keys_1_1 = keys_1.next()) {
                                var propertyName = keys_1_1.value;
                                var ngFormControl = frameContext.form.ngFormControls[propertyName];
                                var bindingPath = frameContext.viewModel.bindingPath || '/';
                                var bindingPaths = bindingPath.split('/').filter(function (p) { return p; });
                                var bindings = ngFormControl.binding.split('.');
                                bindings = bindingPaths.concat(bindings);
                                if (entityPath === bindings.join('.')) {
                                    // 判断对应的组件是什么类型
                                    var dgColumnNames = frameContext.viewModel['dataGridColumnsName'] || null;
                                    var dgColumnInfo = frameContext.viewModel[dgColumnNames] || null;
                                    if (dgColumnInfo && Array.isArray(dgColumnInfo) && dgColumnInfo.length > 0) {
                                        var isEditableGrid = dgColumnInfo.find(function (array) {
                                            var readonlyGroup = array.every(function (column) { return !(column.hasOwnProperty('editor') && column.editor); });
                                            if (!readonlyGroup) {
                                                return true;
                                            }
                                            else {
                                                return false;
                                            }
                                        });
                                        if (!isEditableGrid) {
                                            continue;
                                        }
                                    }
                                    var isGridComponent = false;
                                    if (dgColumnNames) {
                                        isGridComponent = true;
                                    }
                                    result = {
                                        domPropertyName: propertyName,
                                        propertyName: ngFormControl.name || ngFormControl.defaultI18nValue,
                                        frameContext: frameContext,
                                        id: ngFormControl.id,
                                        isGridComponent: isGridComponent,
                                        binding: ngFormControl.binding,
                                        datagridColumns: dgColumnInfo
                                    };
                                    break;
                                }
                            }
                        }
                        catch (e_2_1) { e_2 = { error: e_2_1 }; }
                        finally {
                            try {
                                if (keys_1_1 && !keys_1_1.done && (_b = keys_1.return)) _b.call(keys_1);
                            }
                            finally { if (e_2) throw e_2.error; }
                        }
                    }
                }
            }
            catch (e_1_1) { e_1 = { error: e_1_1 }; }
            finally {
                try {
                    if (frameContexts_1_1 && !frameContexts_1_1.done && (_a = frameContexts_1.return)) _a.call(frameContexts_1);
                }
                finally { if (e_1) throw e_1.error; }
            }
        }
        return result;
    };
    RequiredEffector.prototype.getDataPropInfo = function (path) {
        if (!path) {
            return null;
        }
        var paths = path.split('/').filter(function (p) { return p; });
        return this.frameContext.repository.entityTypeInfo.getPropInfoByPath(paths);
    };
    RequiredEffector.prototype.isValidValue = function (path, value) {
        var dataTypeInfo = this.getDataPropInfo(path);
        if (dataTypeInfo && dataTypeInfo.metadataInfo && dataTypeInfo.metadataInfo.enableMultiLangInput === true) {
            // 多语字段
            var translate = this.injector.get(TranslateToken, null);
            var currentLanguage = translate && translate.getCurrentLanguage() || 'zh-CHS';
            if (Object.keys(value).length < 1) {
                return false;
            }
            return !!value[currentLanguage];
        }
        else if (value === null || value === '' || value === undefined) {
            return false;
        }
        return true;
    };
    RequiredEffector.prototype.buildFormErrors = function (domPropertyName, message) {
        var _a, _b;
        if (message) {
            return _a = {},
                _a[domPropertyName] = {
                    errors: {
                        'require': {
                            name: message
                        }
                    }
                },
                _a;
        }
        else {
            return _b = {},
                _b[domPropertyName] = {
                    errors: {}
                },
                _b;
        }
    };
    RequiredEffector.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    RequiredEffector.ctorParameters = function () { return [
        { type: Injector },
        { type: Repository },
        { type: undefined, decorators: [{ type: Inject, args: [NAMESPACE,] }] },
        { type: FrameContext }
    ]; };
    return RequiredEffector;
}());
export { RequiredEffector };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVxdWlyZWRfZWZmZWN0b3IuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2RldmtpdC8iLCJzb3VyY2VzIjpbImxpYi9lZmZlY3Rvci9yZXF1aXJlZF9lZmZlY3Rvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBSTdELE9BQU8sRUFBRSxZQUFZLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDekQsT0FBTyxFQUFhLGNBQWMsRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUNwRCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFFakQ7OztHQUdHO0FBQ0g7SUFHRSwwQkFBb0IsUUFBa0IsRUFBVSxVQUE4QixFQUE2QixTQUFTLEVBQVUsWUFBMEI7UUFBcEksYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUFVLGVBQVUsR0FBVixVQUFVLENBQW9CO1FBQTZCLGNBQVMsR0FBVCxTQUFTLENBQUE7UUFBVSxpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUN0SixJQUFJLENBQUMsRUFBRSxHQUFHLFNBQVMsQ0FBQztJQUN0QixDQUFDO0lBQ00saUNBQU0sR0FBYixVQUFjLElBQVksRUFBRSxLQUFVLEVBQUUsT0FBaUM7O1FBQ3ZFLGdCQUFnQjtRQUNoQixJQUFNLE9BQU8sR0FBUSxJQUFJLENBQUMsc0JBQXNCLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDdkQsSUFBSSxDQUFDLE9BQU8sRUFBRTtZQUNaLE9BQU87U0FDUjtRQUNELElBQU0sWUFBWSxHQUFpQixPQUFPLENBQUMsWUFBWSxDQUFDO1FBQ3hELElBQU0sZ0JBQWdCLEdBQUcsWUFBWSxJQUFJLFlBQVksQ0FBQywwQkFBMEIsRUFBRSxDQUFDO1FBQ25GLElBQU0sYUFBYSxHQUFHLGdCQUFnQixDQUFDLFNBQVMsQ0FBQztRQUNqRCxJQUFNLGVBQWUsR0FBRyxPQUFPLENB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dG9yIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEVudGl0eSB9IGZyb20gJy4uL2VudGl0eS9pbmRleCc7XHJcbmltcG9ydCB7IEV4cHJlc3Npb24gfSBmcm9tICcuLi9leHByZXNzaW9uL2luZGV4JztcclxuaW1wb3J0IHsgTmdGb3JtQ29udHJvbCwgUnVsZVR5cGUgfSBmcm9tICcuLi9mb3JtL2luZGV4JztcclxuaW1wb3J0IHsgRnJhbWVDb250ZXh0LCBOQU1FU1BBQ0UgfSBmcm9tIFwiLi4vZnJhbWUvaW5kZXhcIjtcclxuaW1wb3J0IHsgVHJhbnNsYXRlLCBUcmFuc2xhdGVUb2tlbiB9IGZyb20gJy4uL2kxOG4nO1xyXG5pbXBvcnQgeyBSZXBvc2l0b3J5IH0gZnJvbSAnLi4vcmVwb3NpdG9yeS9pbmRleCc7XHJcblxyXG4vKipcclxuICog5b+F5aGr5Ymv5L2c55So5ZmoXHJcbiAqIEBkZXNjcmlwdGlvbiDlvZPnu5Pnrpfnu5PmnpzkuLp0cnVl5pe26K6+572u5b+F5aGr5qCh6aqM77yM5ZCm5YiZ5Yig6Zmk5b+F5aGr5qCh6aqMXHJcbiAqL1xyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBSZXF1aXJlZEVmZmVjdG9yIGltcGxlbWVudHMgRXhwcmVzc2lvbi5FZmZlY3RvciB7XHJcbiAgcHVibGljIG5zOiBzdHJpbmc7XHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IsIHByaXZhdGUgcmVwb3NpdG9yeTogUmVwb3NpdG9yeTxFbnRpdHk+LCBASW5qZWN0KE5BTUVTUEFDRSkgcHJpdmF0ZSBuYW1lc3BhY2UsIHByaXZhdGUgZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQpIHtcclxuICAgIHRoaXMubnMgPSBuYW1lc3BhY2U7XHJcbiAgfVxyXG4gIHB1YmxpYyBlZmZlY3QocGF0aDogc3RyaW5nLCB2YWx1ZTogYW55LCBvcHRpb25zOiBFeHByZXNzaW9uLkVmZmVjdE9wdGlvbnMpIHtcclxuICAgIC8vIOagoemqjOS4jemAmui/h+aXtui/lOWbnmZhbHNlXHJcbiAgICBjb25zdCBkb21JbmZvOiBhbnkgPSB0aGlzLmdldERvbUluZm9CeUVudGl0eVBhdGgocGF0aCk7XHJcbiAgICBpZiAoIWRvbUluZm8pIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgY29uc3QgZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQgPSBkb21JbmZvLmZyYW1lQ29udGV4dDtcclxuICAgIGNvbnN0IHJvb3RGcmFtZUNvbnRleHQgPSBmcmFtZUNvbnRleHQgJiYgZnJhbWVDb250ZXh0LmdldFZpcnR1YWxSb290RnJhbWVDb250ZXh0KCk7XHJcbiAgICBjb25zdCByb290Vmlld01vZGVsID0gcm9vdEZyYW1lQ29udGV4dC52aWV3TW9kZWw7XHJcbiAgICBjb25zdCBkb21Qcm9wZXJ0eU5hbWUgPSBkb21JbmZvLmRvbVByb3BlcnR5TmFtZTtcclxuICAgIGNvbnN0IHBhdGhWYWx1ZSA9IHRoaXMuZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhLmdldFZhbHVlKHBhdGguc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKSk7XHJcbiAgICBjb25zdCBleHByZXNzaW9uSWQgPSBvcHRpb25zLmV4cHJlc3Npb25JZDtcclxuICAgIGlmIChleHByZXNzaW9uSWQpIHtcclxuICAgICAgLy8g5aKe5Yqg5qCh6aqM6KeE5YiZXHJcbiAgICAgIGZyYW1lQ29udGV4dC5mb3JtLmFkZEZpZWxkVmFsaWRhdGVSdWxlKGRvbVByb3BlcnR5TmFtZSwgb3B0aW9ucy5tZXNzYWdlLCBleHByZXNzaW9uSWQsIFJ1bGVUeXBlLlJlcXVpcmUpO1xyXG4gICAgfVxyXG4gICAgaWYgKHZhbHVlID09PSB0cnVlKSB7XHJcbiAgICAgIGlmIChvcHRpb25zLm1lc3NhZ2UpIHtcclxuICAgICAgICAvLyDmm7TmlrBmb3Jt6ZSZ6K+v5L+h5oGvXHJcbiAgICAgICAgLy8g5LiN5pivZ3JpZO+8jOWImeiupOS4uuaYr+WNoeeJh1xyXG4gICAgICAgIGlmICghZG9tSW5mby5pc0dyaWRDb21wb25lbnQpIHtcclxuICAgICAgICAgIGNvbnN0IG1lc3NhZ2UgPSBvcHRpb25zLm1lc3NhZ2UucmVwbGFjZSgvXFwkcHJvcGVydHkvZywgZG9tSW5mby5wcm9wZXJ0eU5hbWUpO1xyXG4gICAgICAgICAgY29uc3QgZm9ybUVycm9ycyA9IHRoaXMuYnVpbGRGb3JtRXJyb3JzKGRvbVByb3BlcnR5TmFtZSwgbWVzc2FnZSk7XHJcbiAgICAgICAgICBjb25zdCBpc1ZhbGlkVmFsdWUgPSB0aGlzLmlzVmFsaWRWYWx1ZShwYXRoLCBwYXRoVmFsdWUpO1xyXG4gICAgICAgICAgaWYgKCFpc1ZhbGlkVmFsdWUpIHtcclxuICAgICAgICAgICAgZnJhbWVDb250ZXh0LmZvcm0udXBkYXRlRm9ybUVycm9ycyhmb3JtRXJyb3JzKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgdGhpcy51cGRhdGVDb2x1bW5WYWxpZGF0b3JzKGZyYW1lQ29udGV4dCwgZG9tSW5mby5iaW5kaW5nLCBkb21JbmZvLmRhdGFncmlkQ29sdW1ucywgdHJ1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAvLyDov5Tlm57pnZ50cnVl5YC85pe26K6k5Li66Z2e5b+F5aGrXHJcbiAgICAgIGlmIChkb21JbmZvLmlzR3JpZENvbXBvbmVudCkge1xyXG4gICAgICAgIHRoaXMudXBkYXRlQ29sdW1uVmFsaWRhdG9ycyhmcmFtZUNvbnRleHQsIGRvbUluZm8uYmluZGluZywgZG9tSW5mby5kYXRhZ3JpZENvbHVtbnMsIGZhbHNlKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBjb25zdCBjdXJyZW50RXJyb3JzID0gZnJhbWVDb250ZXh0LmZvcm0uZ2V0Rm9ybUNvbnRyb2xFcnJvcnMoZG9tUHJvcGVydHlOYW1lKSB8fCBudWxsO1xyXG4gICAgICAgIGlmIChjdXJyZW50RXJyb3JzKSB7XHJcbiAgICAgICAgICBpZiAoY3VycmVudEVycm9ycy5oYXNPd25Qcm9wZXJ0eSgncmVxdWlyZScpKSB7XHJcbiAgICAgICAgICAgIC8vIHJlcXVpcmXlkIjms5XvvIznp7vpmaRyZXF1aXJl5qCh6aqM5o+Q56S6XHJcbiAgICAgICAgICAgIGRlbGV0ZSBjdXJyZW50RXJyb3JzLnJlcXVpcmU7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBmcmFtZUNvbnRleHQuZm9ybS51cGRhdGVGb3JtRXJyb3JzKHsgW2RvbVByb3BlcnR5TmFtZV06IHsgZXJyb3JzOiBjdXJyZW50RXJyb3JzIH0gfSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIGNvbnN0IGZvcm1FcnJvcnMgPSB0aGlzLmJ1aWxkRm9ybUVycm9ycyhkb21Qcm9wZXJ0eU5hbWUsIG51bGwpO1xyXG4gICAgICAgICAgZnJhbWVDb250ZXh0LmZvcm0udXBkYXRlRm9ybUVycm9ycyhmb3JtRXJyb3JzKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG4gIHByaXZhdGUgdXBkYXRlQ29sdW1uVmFsaWRhdG9ycyhmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCwgZmllbGQ6IHN0cmluZywgZGF0YWdyaWRDb2x1bW5zOiBhbnlbXVtdLCBpc1JlcXVpcmVkOiBib29sZWFuKSB7XHJcbiAgICBjb25zdCBmcmFtZUlkID0gZnJhbWVDb250ZXh0LmZyYW1lSWQ7XHJcbiAgICBjb25zdCBjb21wb25lbnRSZWZzID0gZnJhbWVDb250ZXh0LmFwcENvbnRleHQuY29tcG9uZW50TWFuYWdlci5nZXQoW2ZyYW1lSWRdKSBhcyBNYXA8c3RyaW5nLCBhbnk+O1xyXG4gICAgaWYgKGNvbXBvbmVudFJlZnMgJiYgY29tcG9uZW50UmVmcy5zaXplID4gMCkge1xyXG4gICAgICBjb25zdCBkYXRhZ3JpZCA9IEFycmF5LmZyb20oY29tcG9uZW50UmVmcy52YWx1ZXMoKSlbMF07XHJcbiAgICAgIGlmIChkYXRhZ3JpZCAmJiB0eXBlb2YgZGF0YWdyaWQudXBkYXRlQ29sdW1uID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgICAgY29uc3QgY29sdW1ucyA9IGRhdGFncmlkQ29sdW1ucy5maW5kKChhcnJheTogYW55W10pID0+IHtcclxuICAgICAgICAgIHJldHVybiBhcnJheS5maW5kKGl0ZW0gPT4gaXRlbS5maWVsZCA9PT0gZmllbGQpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGNvbnN0IGNvbHVtbiA9IGNvbHVtbnMgJiYgY29sdW1ucy5maW5kKGl0ZW0gPT4gaXRlbS5maWVsZCA9PT0gZmllbGQpIHx8IG51bGw7XHJcbiAgICAgICAgaWYgKGNvbHVtbikge1xyXG4gICAgICAgICAgY29uc3QgdmFsaWRhdG9yczogYW55W10gPSBjb2x1bW4udmFsaWRhdG9ycyB8fCBbXTtcclxuICAgICAgICAgIGNvbnN0IGluZGV4ID0gdmFsaWRhdG9ycy5maW5kSW5kZXgoaXRlbSA9PiBpdGVtLnR5cGUgPT09ICdyZXF1aXJlZCcpO1xyXG4gICAgICAgICAgaWYgKGlzUmVxdWlyZWQpIHtcclxuICAgICAgICAgICAgaWYgKGluZGV4ID09PSAtMSkge1xyXG4gICAgICAgICAgICAgIHZhbGlkYXRvcnMucHVzaCh7IFwidHlwZVwiOiBcInJlcXVpcmVkXCIsIFwibWVzc2FnZVwiOiBcIuivpeWtl+auteS4jeiDveS4uuepuu+8gVwiIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBpZiAoaW5kZXggIT09IC0xKSB7XHJcbiAgICAgICAgICAgICAgdmFsaWRhdG9ycy5zcGxpY2UoaW5kZXgsIDEpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBkYXRhZ3JpZC51cGRhdGVDb2x1bW4oZmllbGQsIHsgdmFsaWRhdG9yczogWy4uLnZhbGlkYXRvcnNdIH0pO1xyXG4gICAgICAgICAgZGF0YWdyaWQuY29sdW1uc0NoYW5nZWQoKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcbiAgcHJpdmF0ZSBnZXREb21JbmZvQnlFbnRpdHlQYXRoKGVudGl0eVBhdGg6IHN0cmluZyk6IHsgZG9tUHJvcGVydHlOYW1lOiBzdHJpbmcsIGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0LCBpZDogc3RyaW5nLCBpc0dyaWRDb21wb25lbnQ6IGJvb2xlYW4sIGJpbmRpbmc6IHN0cmluZywgZGF0YWdyaWRDb2x1bW5zOiBhbnlbXVtdIH0ge1xyXG4gICAgbGV0IHJlc3VsdCA9IG51bGw7XHJcbiAgICBpZiAoIWVudGl0eVBhdGgpIHtcclxuICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH1cclxuICAgIGVudGl0eVBhdGggPSBlbnRpdHlQYXRoLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCkuam9pbignLicpO1xyXG4gICAgY29uc3QgZnJhbWVDb250ZXh0cyA9IHRoaXMuZnJhbWVDb250ZXh0ICYmIHRoaXMuZnJhbWVDb250ZXh0LmFwcENvbnRleHQuZnJhbWVDb250ZXh0TWFuYWdlci5nZXRGcmFtZUNvbnRleHRzQnlOYW1lc3BhY2UodGhpcy5uYW1lc3BhY2UpIHx8IG51bGw7XHJcbiAgICBpZiAoZnJhbWVDb250ZXh0cyAmJiBmcmFtZUNvbnRleHRzLmxlbmd0aCA+IDApIHtcclxuICAgICAgZm9yIChjb25zdCBmcmFtZUNvbnRleHQgb2YgZnJhbWVDb250ZXh0cykge1xyXG4gICAgICAgIGlmIChyZXN1bHQpIHtcclxuICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoZnJhbWVDb250ZXh0ICYmIGZyYW1lQ29udGV4dC5mb3JtICYmIGZyYW1lQ29udGV4dC5mb3JtLm5nRm9ybUNvbnRyb2xzICYmIE9iamVjdC5rZXlzKGZyYW1lQ29udGV4dC5mb3JtLm5nRm9ybUNvbnRyb2xzKS5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMoZnJhbWVDb250ZXh0LmZvcm0ubmdGb3JtQ29udHJvbHMpO1xyXG4gICAgICAgICAgZm9yIChjb25zdCBwcm9wZXJ0eU5hbWUgb2Yga2V5cykge1xyXG4gICAgICAgICAgICBjb25zdCBuZ0Zvcm1Db250cm9sOiBOZ0Zvcm1Db250cm9sID0gZnJhbWVDb250ZXh0LmZvcm0ubmdGb3JtQ29udHJvbHNbcHJvcGVydHlOYW1lXTtcclxuICAgICAgICAgICAgbGV0IGJpbmRpbmdQYXRoID0gZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5iaW5kaW5nUGF0aCB8fCAnLyc7XHJcbiAgICAgICAgICAgIGNvbnN0IGJpbmRpbmdQYXRocyA9IGJpbmRpbmdQYXRoLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCk7XHJcbiAgICAgICAgICAgIGxldCBiaW5kaW5ncyA9IG5nRm9ybUNvbnRyb2wuYmluZGluZy5zcGxpdCgnLicpO1xyXG4gICAgICAgICAgICBiaW5kaW5ncyA9IGJpbmRpbmdQYXRocy5jb25jYXQoYmluZGluZ3MpO1xyXG4gICAgICAgICAgICBpZiAoZW50aXR5UGF0aCA9PT0gYmluZGluZ3Muam9pbignLicpKSB7XHJcbiAgICAgICAgICAgICAgLy8g5Yik5pat5a+55bqU55qE57uE5Lu25piv5LuA5LmI57G75Z6LXHJcbiAgICAgICAgICAgICAgY29uc3QgZGdDb2x1bW5OYW1lcyA9IGZyYW1lQ29udGV4dC52aWV3TW9kZWxbJ2RhdGFHcmlkQ29sdW1uc05hbWUnXSB8fCBudWxsO1xyXG4gICAgICAgICAgICAgIGNvbnN0IGRnQ29sdW1uSW5mbzogQXJyYXk8QXJyYXk8YW55Pj4gPSBmcmFtZUNvbnRleHQudmlld01vZGVsW2RnQ29sdW1uTmFtZXNdIHx8IG51bGw7XHJcbiAgICAgICAgICAgICAgaWYgKGRnQ29sdW1uSW5mbyAmJiBBcnJheS5pc0FycmF5KGRnQ29sdW1uSW5mbykgJiYgZGdDb2x1bW5JbmZvLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGlzRWRpdGFibGVHcmlkID0gZGdDb2x1bW5JbmZvLmZpbmQoKGFycmF5OiBBcnJheTxhbnk+KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgIGNvbnN0IHJlYWRvbmx5R3JvdXAgPSBhcnJheS5ldmVyeSgoY29sdW1uOiBhbnkpID0+ICEoY29sdW1uLmhhc093blByb3BlcnR5KCdlZGl0b3InKSAmJiBjb2x1bW4uZWRpdG9yKSk7XHJcbiAgICAgICAgICAgICAgICAgIGlmICghcmVhZG9ubHlHcm91cCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICBpZiAoIWlzRWRpdGFibGVHcmlkKSB7XHJcbiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICBsZXQgaXNHcmlkQ29tcG9uZW50ID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgaWYgKGRnQ29sdW1uTmFtZXMpIHtcclxuICAgICAgICAgICAgICAgIGlzR3JpZENvbXBvbmVudCA9IHRydWU7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIHJlc3VsdCA9IHtcclxuICAgICAgICAgICAgICAgIGRvbVByb3BlcnR5TmFtZTogcHJvcGVydHlOYW1lLFxyXG4gICAgICAgICAgICAgICAgcHJvcGVydHlOYW1lOiBuZ0Zvcm1Db250cm9sLm5hbWUgfHwgbmdGb3JtQ29udHJvbC5kZWZhdWx0STE4blZhbHVlLFxyXG4gICAgICAgICAgICAgICAgZnJhbWVDb250ZXh0LFxyXG4gICAgICAgICAgICAgICAgaWQ6IG5nRm9ybUNvbnRyb2wuaWQsXHJcbiAgICAgICAgICAgICAgICBpc0dyaWRDb21wb25lbnQsXHJcbiAgICAgICAgICAgICAgICBiaW5kaW5nOiBuZ0Zvcm1Db250cm9sLmJpbmRpbmcsXHJcbiAgICAgICAgICAgICAgICBkYXRhZ3JpZENvbHVtbnM6IGRnQ29sdW1uSW5mb1xyXG4gICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiByZXN1bHQ7XHJcbiAgfVxyXG4gIHByaXZhdGUgZ2V0RGF0YVByb3BJbmZvKHBhdGg6IHN0cmluZykge1xyXG4gICAgaWYgKCFwYXRoKSB7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gICAgY29uc3QgcGF0aHMgPSBwYXRoLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCk7XHJcbiAgICByZXR1cm4gdGhpcy5mcmFtZUNvbnRleHQucmVwb3NpdG9yeS5lbnRpdHlUeXBlSW5mby5nZXRQcm9wSW5mb0J5UGF0aChwYXRocyk7XHJcbiAgfVxyXG4gIHByaXZhdGUgaXNWYWxpZFZhbHVlKHBhdGg6IHN0cmluZywgdmFsdWU6IGFueSkge1xyXG4gICAgY29uc3QgZGF0YVR5cGVJbmZvID0gdGhpcy5nZXREYXRhUHJvcEluZm8ocGF0aCk7XHJcbiAgICBpZiAoZGF0YVR5cGVJbmZvICYmIGRhdGFUeXBlSW5mby5tZXRhZGF0YUluZm8gJiYgZGF0YVR5cGVJbmZvLm1ldGFkYXRhSW5mby5lbmFibGVNdWx0aUxhbmdJbnB1dCA9PT0gdHJ1ZSkge1xyXG4gICAgICAvLyDlpJror63lrZfmrrVcclxuICAgICAgY29uc3QgdHJhbnNsYXRlID0gdGhpcy5pbmplY3Rvci5nZXQ8VHJhbnNsYXRlPihUcmFuc2xhdGVUb2tlbiwgbnVsbCk7XHJcbiAgICAgIGNvbnN0IGN1cnJlbnRMYW5ndWFnZSA9IHRyYW5zbGF0ZSAmJiB0cmFuc2xhdGUuZ2V0Q3VycmVudExhbmd1YWdlKCkgfHwgJ3poLUNIUyc7XHJcbiAgICAgIGlmIChPYmplY3Qua2V5cyh2YWx1ZSkubGVuZ3RoIDwgMSkge1xyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgfVxyXG4gICAgICByZXR1cm4gISF2YWx1ZVtjdXJyZW50TGFuZ3VhZ2VdO1xyXG4gICAgfSBlbHNlIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gJycgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdHJ1ZTtcclxuICB9XHJcbiAgcHJpdmF0ZSBidWlsZEZvcm1FcnJvcnMoZG9tUHJvcGVydHlOYW1lOiBzdHJpbmcsIG1lc3NhZ2U6IHN0cmluZykge1xyXG4gICAgaWYgKG1lc3NhZ2UpIHtcclxuICAgICAgcmV0dXJuIHtcclxuICAgICAgICBbZG9tUHJvcGVydHlOYW1lXToge1xyXG4gICAgICAgICAgZXJyb3JzOiB7XHJcbiAgICAgICAgICAgICdyZXF1aXJlJzoge1xyXG4gICAgICAgICAgICAgIG5hbWU6IG1lc3NhZ2VcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiB7XHJcbiAgICAgICAgW2RvbVByb3BlcnR5TmFtZV06IHtcclxuICAgICAgICAgIGVycm9yczoge31cclxuICAgICAgICB9XHJcbiAgICAgIH07XHJcbiAgICB9XHJcbiAgfVxyXG59Il19