!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@gsp-svc/file-viewer"),require("@gsp-svc/formdoc-upload"),require("@farris/extend-file-upload"),require("rxjs"),require("@angular/common")):"function"==typeof define&&define.amd?define("@farris/extend-fileupload-adapt-unifile",["exports","@angular/core","@gsp-svc/file-viewer","@gsp-svc/formdoc-upload","@farris/extend-file-upload","rxjs","@angular/common"],t):t(((e=e||self).farris=e.farris||{},e.farris["extend-fileupload-adapt-unifile"]={}),e.ng.core,e.fileViewer,e.formdocUpload,e.extendFileUpload,e.rxjs,e.ng.common)}(this,(function(e,t,i,n,r,o,a){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */var l=function(e,t){return(l=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)};var s=new t.InjectionToken("MFFileUploadAdaptUnifileConfig"),p=function(){function e(e){this.config={rootId:"",formId:"",mode:0},e&&Object.assign(this.config,e)}return e.prototype.getConfig=function(){return this.config},e.prototype.setConfig=function(e,t){this.config[e]=t},e.decorators=[{type:t.Injectable,args:[{providedIn:"root"}]}],e.ctorParameters=function(){return[{type:void 0,decorators:[{type:t.Optional},{type:t.Inject,args:[s]}]}]},e.ngInjectableDef=t.defineInjectable({factory:function(){return new e(t.inject(s,8))},token:e,providedIn:"root"}),e}();var f=function(){function e(e,t,i){this.fileviewSer=e,this.configSer=t,this.downloadSer=i,this.previewExtendServerConfig=null,this.extendData=this.configSer.getConfig()}return e.prototype.getFinallyConfig=function(e,t){return t&&t.hasOwnProperty(e)?t[e]:this.previewExtendServerConfig&&this.previewExtendServerConfig.hasOwnProperty(e)?this.previewExtendServerConfig[e]:this.extendData.hasOwnProperty(e)?this.extendData[e]:null},e.prototype.previewFile=function(e,t){return this.previewFileList([e],t)},e.prototype.previewFileList=function(e,t){var i=this.getFinallyConfig("rootId",t),n=[];e.forEach((function(e){n.push(e.extend.metadataId)}));var r=this.getFinallyConfig("options",t);return r?this.fileviewSer.viewerFileList(n,i,r):this.fileviewSer.viewerFileList(n,i)},e.prototype.downloadFile=function(e,t){if(!e.id)throw new Error("请设置要下载的附件");window.open(this.getImgSrc(e,t))},e.prototype.multiDownloadFiles=function(e,t){if(1==e.length)this.downloadFile(e[0],t);else{var i=this.getFinallyConfig("rootId",t),n=[];e.forEach((function(e){n.push(e.extend.metadataId)}));var r=this.downloadSer.getMultipleDownloadUrl(JSON.stringify(n),i);window.open(r)}},e.prototype.multiDownloadFilesWidthName=function(e,t,i){if(void 0===t&&(t=""),1==e.length)this.downloadFile(e[0],i);else{var n=this.getFinallyConfig("rootId",i),r=[];e.forEach((function(e){r.push(e.extend.metadataId)}));var o=this.downloadSer.getMultipleDownloadUrlWithName(JSON.stringify(r),n,t);window.open(o)}},e.prototype.getImgSrc=function(e,t){if(!e.id)throw new Error("请设置要下载的附件");var i="",n=e.extend.metadataId,r=this.getFinallyConfig("rootId",t);return this.downloadSer?r&&(i=this.downloadSer.getDownloadUrl(n,r)):r&&(console.warn("因为安全问题，附件下载提供安全校验机制，附件下载功能需要重新编译"),i="/api/runtime/dfs/v1.0/formdoc/filecontent?metadataid="+n+"&rootid="+r),i},e.prototype.setPreviwExtendServerConfig=function(e){this.previewExtendServerConfig=e},e.prototype.getPreviewExtendServerConfig=function(){return this.previewExtendServerConfig},e.decorators=[{type:t.Injectable,args:[{providedIn:"root"}]}],e.ctorParameters=function(){return[{type:i.FileViewerService},{type:p},{type:n.DownloadService,decorators:[{type:t.Optional}]}]},e.ngInjectableDef=t.defineInjectable({factory:function(){return new e(t.inject(i.FileViewerService),t.inject(p),t.inject(n.DownloadService,8))},token:e,providedIn:"root"}),e}();var d=function(){function e(e){this.previewSer=e,this.viewDisabled=!1,this.extendServerConfig=null}return e.prototype.filePreviewEventHandler=function(){this.fileInfo&&!this.viewDisabled&&this.previewSer.previewFile(this.fileInfo,this.extendServerConfig)},e.decorators=[{type:t.Directive,args:[{selector:"[fFileAdaptPreviewFile]"}]}],e.ctorParameters=function(){return[{type:f}]},e.propDecorators={fileInfo:[{type:t.Input,args:["fFileAdaptPreviewFile"]}],filePreviewEventHandler:[{type:t.HostListener,args:["click",["$event"]]}],viewDisabled:[{type:t.Input}],extendServerConfig:[{type:t.Input}]},e}();var u=function(){function e(e){this.previewSer=e,this.zipName="",this.downloadDisabled=!1,this.extendServerConfig=null,this.enableMulti=!1}return e.prototype.filePreviewEventHandler=function(){this.fileInfo&&!this.downloadDisabled&&(this.enableMulti&&this.fileInfo instanceof Array?this.previewSer.multiDownloadFilesWidthName(this.fileInfo,this.zipName,this.extendServerConfig):this.previewSer.downloadFile(this.fileInfo,this.extendServerConfig))},e.decorators=[{type:t.Directive,args:[{selector:"[fFileAdaptDownloadFile]"}]}],e.ctorParameters=function(){return[{type:f}]},e.propDecorators={fileInfo:[{type:t.Input,args:["fFileAdaptDownloadFile"]}],filePreviewEventHandler:[{type:t.HostListener,args:["click",["$event"]]}],zipName:[{type:t.Input}],downloadDisabled:[{type:t.Input}],extendServerConfig:[{type:t.Input}],enableMulti:[{type:t.Input}]},e}();var c=function(){function e(e,t){this.adpSer=e,this.elementRef=t,this.cls=!0,this.enableThumbnail=!1,this.clsPrefix="ffilepreview--filetype",this.supportImgSuffix="jpeg,jpg,gif,png,bmp",this.iconWidth=38,this.maxThumbnailWidth="100%",this.maxThumbnailHeight="100%",this.extendServerConfig=null}return e.prototype.ngOnInit=function(){},e.prototype.imgSrc=function(){return this.adpSer.getImgSrc(this.fileInfo,this.extendServerConfig)},e.prototype.isImage=function(){if(!this.fileInfo)return!1;var e=this.fileInfo.name;if(!e)return!1;var t=e.lastIndexOf("."),i="";return t>-1&&(i=e.substring(t+1).toLocaleLowerCase()),!!i&&this.supportImgSuffix.split(",").findIndex((function(e){return e==i}))>-1},e.prototype.getFileTypeClassName=function(){var e=this.clsPrefix;if(!this.fileInfo||!this.fileInfo.name)return e+"-any";var t=this.fileInfo.name,i=t.lastIndexOf("."),n="";switch(i>-1&&(n=t.substring(i+1).toLocaleLowerCase()),n){case"pdf":e+="-pdf";break;case"jpeg":case"jpg":case"gif":case"png":case"bmp":e+="-img";break;case"ppt":e+="-ppt";break;case"doc":case"docx":e+="-doc";break;case"xls":case"xlsx":e+="-xls";break;case"txt":e+="-txt";break;case"zip":e+="-zip";break;default:e+="-any"}return e},e.decorators=[{type:t.Component,args:[{selector:"ffilepreview-adapt-seeimg",template:'<div class="ffilepreview-seeimg--wrapper" [ngClass]="{\'ffilepreview-seeimg--thumbnail\':enableThumbnail}">\r\n  <ng-container *ngIf="enableThumbnail&&isImage();else notImage">\r\n    <img class="ffilepreview-seeimg--img" [src]="imgSrc()" [ngStyle]="{\'maxWidth\':maxThumbnailWidth,\'maxHeight\':maxThumbnailHeight}"/>\r\n  </ng-container>\r\n</div>\r\n<ng-template #notImage>\r\n  <span class="ffilepreview--filetype-icon" [ngClass]="getFileTypeClassName()" [ngStyle]="{\'width\':iconWidth+\'px\',\'height\':iconWidth+\'px\'}"></span>\r\n</ng-template>',styles:[":host{height:100%;width:100%;position:relative}.ffilepreview-seeimg--thumbnail{top:0;bottom:0;position:absolute;right:0;left:0;display:-webkit-box;display:flex;-webkit-box-align:center;align-items:center;-webkit-box-pack:center;justify-content:center}.ffilepreview-seeimg--wrapper:hover{opacity:.8}.ffilepreview-seeimg--img{max-width:100%;max-height:100%;border-radius:4px}"]}]}],e.ctorParameters=function(){return[{type:f},{type:t.ElementRef}]},e.propDecorators={cls:[{type:t.HostBinding,args:["class.ffilepreview-adapt-seeimg"]}],enableThumbnail:[{type:t.Input}],clsPrefix:[{type:t.Input}],supportImgSuffix:[{type:t.Input}],fileInfo:[{type:t.Input}],iconWidth:[{type:t.Input}],maxThumbnailWidth:[{type:t.Input}],maxThumbnailHeight:[{type:t.Input}],extendServerConfig:[{type:t.Input}]},e}();var g=function(e){function i(t,i){var n=e.call(this)||this;return n.uploadSer=t,n.configSer=i,n.bufferSize=1048576,n.uploadedChunk={},n.fileTotalChunk={},n.extendData=n.configSer.getConfig(),n}return function(e,t){function i(){this.constructor=e}l(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}(i,e),i.prototype.uuid=function(){var e=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)};return e()+e()+e()+e()+e()+e()+e()+e()},i.prototype.remove=function(e,t,i){return this.innerRemoveList(e,t,i)},i.prototype.innerRemoveList=function(e,t,i){var r=this;return void 0===i&&(i=null),new o.Observable((function(t){var o=new n.GspFormRemoveListEntity,a=[];e.forEach((function(e){e.response&&a.push(e.response.metadataId)})),o.mode=r.getFinallyConfig("mode",i);var l=r.getFinallyConfig("rootId",i);o.metadataIdList=[].concat(a),r.uploadSer.removeList(a,l).subscribe((function(i){t.next({type:"removed",files:e})}),(function(e){t.error(e),t.complete()}),(function(){t.complete()}))}))},i.prototype.upload=function(e,t,i){return this.innerUploadList(e,t,i)},i.prototype.innerUploadList=function(e,t,i){var a=this;return new o.Observable((function(l){var s=new n.GspFormUploadListEntity;s.formId=a.getFinallyConfig("formId",i),s.mode=a.getFinallyConfig("mode",i);var p=a.getFinallyConfig("rootId",i);s.docInfoList=[];var f=[];e.forEach((function(e){var i=new o.Observable((function(i){var n=new FileReader;n.readAsBinaryString(e.nativeFile),n.onload=function(r){var o={fileName:"",fileContent:""};o.fileName=e.name,o.fileContent=btoa(n.result.toString()),t.hasOwnProperty("data")&&t.data&&t.data.hasOwnProperty("extProperty")&&(o.extProperty=t.data.extProperty),s.docInfoList.push(o),i.next(),i.complete()}}));f.push(i)})),o.forkJoin(f).subscribe((function(t){a.uploadSer.uploadList(s,p).subscribe((function(t){if(t.error)return l.error(a.errorInfoFormat(t.error,e)),void l.complete();t.forEach((function(t){var i=a.findFileIndexByFileName(e,t.fileName);i>-1&&(e[i].response=t,e[i].progress.status=r.UploadStatus.Done)})),l.next({type:"done",files:e})}),(function(t){l.error(a.errorInfoFormat(t,e)),l.complete()}),(function(){l.complete()}))}))}))},i.prototype.multipartUpload=function(e,t,i){var a=this;return new o.Observable((function(o){var l=a.uuid(),s=e.name,p=Math.ceil(e.size/a.bufferSize);a.fileTotalChunk[l]=p;var f=0;a.uploadedChunk[l]=0;for(var d=function(){var d=new n.GspFormUploadEntity;d.mode=n.OperatingModes.Temp,d.formId=a.getFinallyConfig("formId",i),d.rootId=a.getFinallyConfig("rootId",i);var u=new n.GspFormDocInfo;u.fileName=s,u.metadataId=l,u.total=p,t.hasOwnProperty("data")&&t.data&&t.data.hasOwnProperty("extProperty")&&(u.extProperty=t.data.extProperty);var c=Math.min((f+1)*a.bufferSize,e.size),g=e.nativeFile.slice(f*a.bufferSize,c),v=new FileReader;v.readAsBinaryString(g);var h=f;v.onload=function(){u.fileContent=btoa(v.result.toString()),u.index=h,d.docInfo=u;var t=d;a.uploadSer.uploadFile(t).subscribe((function(t){if(t&&t.error)return o.error(a.errorInfoFormat(t.error,[e])),void o.complete();if(a.uploadedChunk[l]++,a.uploadedChunk[u.metadataId]==a.fileTotalChunk[u.metadataId])e.progress={status:r.UploadStatus.Done,data:{percentage:100}},e.response=u,delete a.uploadedChunk[l],delete a.fileTotalChunk[l],o.next({type:"done",files:[e]}),o.complete();else{var i=Number.parseInt((a.uploadedChunk[l]/a.fileTotalChunk[l]*100).toFixed(0));e.progress={status:r.UploadStatus.Uploading,data:{percentage:i}},o.next({type:"uploading",files:[e]})}}),(function(t){delete a.uploadedChunk[l],delete a.fileTotalChunk[l],o.error(a.errorInfoFormat(t,[e])),o.complete()}))},f+=1};f<p;)d()}))},i.prototype.formatFileSize=function(e){return e<102400?(e/1024).toFixed(1)+"K":e<1048576?(e/1024).toFixed(0)+"K":e<104857600?(e/1024/1024).toFixed(1)+"M":e<1073741824?(e/1024/1024).toFixed(0)+"M":(e/1024/1024/1024).toFixed(1)+"G"},i.prototype.getMultipartDisplayName=function(e){return e.length<=10?e:e.substring(0,2)+"…"+e.substring(e.lastIndexOf(".")-2)},i.prototype.errorInfoFormat=function(e,t){var i=t.map((function(e){return{id:e.id,name:e.name}}));return e?Object.assign(e,{files:i},{message:e.Message||e.extensionMessage||"上传失败",type:"error"}):Object.assign({files:i},{message:"上传失败",type:"error"})},i.prototype.getFinallyConfig=function(e,t){return t&&t.hasOwnProperty(e)?t[e]:this.extendData[e]},i.prototype.findFileIndexByFileName=function(e,t){return e.findIndex((function(e){return e.name==t}))},i.previous=0,i.decorators=[{type:t.Injectable,args:[{providedIn:"root"}]}],i.ctorParameters=function(){return[{type:n.UploadService},{type:p}]},i.ngInjectableDef=t.defineInjectable({factory:function(){return new i(t.inject(n.UploadService),t.inject(p))},token:i,providedIn:"root"}),i}(r.UploadServerService);var v=function(){function e(e){this.previewSer=e,this._extendServeConfig=null}return e.prototype.filePreviewEventHandler=function(e){this.previewSer.previewFile(e,this.extendServerConfig)},e.prototype.fileDownloadEventHandler=function(e){e&&e.fileInfos.length>0&&(e.fileInfos.length>1?this.previewSer.multiDownloadFilesWidthName(e.fileInfos,e.name,this.extendServerConfig):this.previewSer.downloadFile(e.fileInfos[0],this.extendServerConfig))},Object.defineProperty(e.prototype,"extendServerConfig",{get:function(){return this._extendServeConfig},set:function(e){this._extendServeConfig=e,this.previewSer.setPreviwExtendServerConfig(e)},enumerable:!0,configurable:!0}),e.decorators=[{type:t.Directive,args:[{selector:"[fFilePreviewAdaptUnifile]",providers:[f]}]}],e.ctorParameters=function(){return[{type:f}]},e.propDecorators={filePreviewEventHandler:[{type:t.HostListener,args:["filePreviewEvent",["$event"]]}],fileDownloadEventHandler:[{type:t.HostListener,args:["fileDownloadEvent",["$event"]]}],extendServerConfig:[{type:t.Input}]},e}();var h=function(){function e(){}return e.forRoot=function(t){return{ngModule:e,providers:[{provide:s,useValue:t},p,f,i.FileViewerService]}},e.decorators=[{type:t.NgModule,args:[{declarations:[v,c,u,d],imports:[a.CommonModule,n.UploadDialogMoudle,i.FileListModule,r.FFileUploadModule.forRoot(null,g)],exports:[r.FFileUploadModule,v,c,u,d],providers:[p,f,i.FileViewerService]}]}],e}();e.FFileAdaptDownloadFileDirective=u,e.FFileAdaptPreviewFileDirective=d,e.FFilePreviewAdaptUnifileDirective=v,e.FFileUploadAdaptUnifileConfigService=p,e.FFileUploadAdaptUnifileConfigToken=s,e.FfilepreviewAdaptSeeimgComponent=c,e.FfilepreviewAdaptUnifileService=f,e.FfileuploadAdaptUnifileModule=h,e.FfileuploadAdaptUnifileService=g,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=farris-extend-fileupload-adapt-unifile.umd.min.js.map