/**
 * @fileoverview added by tsickle
 * Generated from: lib/bif-manual-creation/service/bif-source-ui.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Injectable, Injector, ComponentFactoryResolver, NgModuleFactoryLoader, Inject, LOCALE_ID, Optional } from '@angular/core';
import { AbstractUiService } from './abstract-ui-service';
import { NavigationService, RuntimeFrameworkService } from '@farris/command-services';
import { FrameContext } from '@farris/devkit';
import { BsModalService } from '@farris/ui-modal';
import { FormGetBillCreationProcessEntityExArgs } from '../../entity/form-rest/FormGetBillCreationProcessEntityExArgs';
import { PushSelectorComponent } from '../components/push-selector/push-selector.component';
import { RpcCreationRuleExecutorResult } from '../../ref';
import { BIF_UISTATE_KEY_CREATION_RESULT } from '../config/bif-form-constants';
import { FormBillCreationProcessExecutorResult } from '../../entity/form-rest/FormBillCreationProcessExecutorResult';
import { ManualCreationMode } from '../../entity/form-rest/ManualCreationMode';
import { MessagerService } from '@farris/ui-messager';
import { judgeBrowserType } from "../../utils/BrowserUtil";
var BifSourceUiService = /** @class */ (function (_super) {
    tslib_1.__extends(BifSourceUiService, _super);
    function BifSourceUiService(navigationService, frameContext, modalService, messager, injector, cfr, loader, localeId, runtimeFrameworkService) {
        var _this = _super.call(this, frameContext, modalService, messager, injector, cfr, loader, localeId, runtimeFrameworkService) || this;
        _this.navigationService = navigationService;
        _this.frameContext = frameContext;
        _this.modalService = modalService;
        _this.messager = messager;
        _this.injector = injector;
        _this.cfr = cfr;
        _this.loader = loader;
        _this.localeId = localeId;
        _this.uiStateKeyCreationResult = BIF_UISTATE_KEY_CREATION_RESULT;
        return _this;
    }
    /**
     * 下推时打开生单规则选择器
     */
    /**
     * 下推时打开生单规则选择器
     * @param {?} upBillVoId
     * @param {?=} bizFlowchartId
     * @param {?=} modalOptions
     * @param {?=} customSelectorModuleUrl
     * @param {?=} extParams
     * @return {?}
     */
    BifSourceUiService.prototype.openBillCreationProcessSelector4Push = /**
     * 下推时打开生单规则选择器
     * @param {?} upBillVoId
     * @param {?=} bizFlowchartId
     * @param {?=} modalOptions
     * @param {?=} customSelectorModuleUrl
     * @param {?=} extParams
     * @return {?}
     */
    function (upBillVoId, bizFlowchartId, modalOptions, customSelectorModuleUrl, extParams) {
        /** @type {?} */
        var args = new FormGetBillCreationProcessEntityExArgs();
        args.upBillVoId = upBillVoId;
        args.manualCreationMode = ManualCreationMode.Push;
        return this.openBillCreationProcessSelector(args, PushSelectorComponent, modalOptions, customSelectorModuleUrl, extParams);
    };
    /**
     * 特定下推时打开生单规则选择器
     */
    /**
     * 特定下推时打开生单规则选择器
     * @param {?} upBillVoId
     * @param {?} downBillVoId
     * @param {?=} bizFlowchartId
     * @param {?=} modalOptions
     * @param {?=} customSelectorModuleUrl
     * @param {?=} extParams
     * @return {?}
     */
    BifSourceUiService.prototype.openBillCreationProcessSelector4SpecificPush = /**
     * 特定下推时打开生单规则选择器
     * @param {?} upBillVoId
     * @param {?} downBillVoId
     * @param {?=} bizFlowchartId
     * @param {?=} modalOptions
     * @param {?=} customSelectorModuleUrl
     * @param {?=} extParams
     * @return {?}
     */
    function (upBillVoId, downBillVoId, bizFlowchartId, modalOptions, customSelectorModuleUrl, extParams) {
        /** @type {?} */
        var args = new FormGetBillCreationProcessEntityExArgs();
        args.upBillVoId = upBillVoId;
        args.downBillVoId = downBillVoId;
        args.manualCreationMode = ManualCreationMode.SpecificPush;
        // args.bizFlowchartId = bizFlowchartId;
        return this.openBillCreationProcessSelector(args, PushSelectorComponent, modalOptions, customSelectorModuleUrl, extParams);
    };
    /**
     * 打开下游单据制单界面
     * @param formSettings
     * @param creationResult
     * @param extParams
     */
    /**
     * 打开下游单据制单界面
     * @param {?} formSettings
     * @param {?} creationResult
     * @param {?=} extParams
     * @return {?}
     */
    BifSourceUiService.prototype.openTargetForm = /**
     * 打开下游单据制单界面
     * @param {?} formSettings
     * @param {?} creationResult
     * @param {?=} extParams
     * @return {?}
     */
    function (formSettings, creationResult, extParams) {
        var e_1, _a;
        if (formSettings == null) {
            throw "参数formSettings不可为空";
        }
        if (creationResult == null) {
            throw "参数creationResult不可为空";
        }
        if (typeof creationResult == "string") {
            if (creationResult == "") {
                throw "参数creationResult不可为空";
            }
            /** @type {?} */
            var temp = new FormBillCreationProcessExecutorResult();
            temp.LoadFromJson(creationResult);
            creationResult = temp;
        }
        if ((creationResult instanceof FormBillCreationProcessExecutorResult) == false) {
            /** @type {?} */
            var res = new FormBillCreationProcessExecutorResult();
            res.LoadFromJsonObject(creationResult);
            creationResult = res;
        }
        if (creationResult.conditionResult.conditionExecutionResult == false) {
            this.messager.error(creationResult.conditionResult.message || this.localePipe.transform("creationExecutionError"));
            return;
        }
        if (creationResult.creationRuleExecutorResult == null || creationResult.creationRuleExecutorResult.mappingResults == null || creationResult.creationRuleExecutorResult.mappingResults.length == 0) {
            this.messager.error(this.localePipe.transform("creationResultEmpty"));
            return;
        }
        else if (creationResult.creationRuleExecutorResult.mappingResults.length == 1) {
            //只有一条数据则打开卡片
            this.openApp(creationResult.creationRuleExecutorResult.mappingResults[0].associations[0].tarDataId, formSettings.targetCardAppId, formSettings.targetCardAppEntrance, creationResult, extParams, false);
        }
        else {
            if (formSettings.targetListAppId != null) {
                // 多条数据且配置批量编辑界面
                throw "暂不支持打开批量编辑界面";
                this.openApp(creationResult.creationRuleExecutorResult.mappingResults[0].associations[0].tarDataId, formSettings.targetListAppId, formSettings.targetListAppEntrance, creationResult, extParams, false);
            }
            else {
                try {
                    //有多条数据但未配置批量编辑界面则打开多个卡片
                    for (var _b = tslib_1.__values(creationResult.creationRuleExecutorResult.mappingResults), _c = _b.next(); !_c.done; _c = _b.next()) {
                        var mappingResult = _c.value;
                        /** @type {?} */
                        var singleRes = new FormBillCreationProcessExecutorResult();
                        singleRes.conditionResult = creationResult.conditionResult;
                        singleRes.creationRuleExecutorResult = new RpcCreationRuleExecutorResult();
                        singleRes.creationRuleExecutorResult.bizFlowchartId = creationResult.creationRuleExecutorResult.bizFlowchartId;
                        singleRes.creationRuleExecutorResult.creationRuleId = creationResult.creationRuleExecutorResult.creationRuleId;
                        singleRes.creationRuleExecutorResult.creationRuleInstanceId = creationResult.creationRuleExecutorResult.creationRuleInstanceId;
                        singleRes.creationRuleExecutorResult.mappingResults = [mappingResult];
                        this.openApp(mappingResult.associations[0].tarDataId, formSettings.targetCardAppId, formSettings.targetCardAppEntrance, singleRes, extParams, false);
                    }
                }
                catch (e_1_1) { e_1 = { error: e_1_1 }; }
                finally {
                    try {
                        if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
                    }
                    finally { if (e_1) throw e_1.error; }
                }
            }
        }
    };
    /**
     * @private
     * @param {?} tabId
     * @param {?} appId
     * @param {?} appEntrance
     * @param {?} creationResult
     * @param {?=} extParams
     * @param {?=} reload
     * @param {?=} tabName
     * @param {?=} enableRefresh
     * @param {?=} destructuring
     * @return {?}
     */
    BifSourceUiService.prototype.openApp = /**
     * @private
     * @param {?} tabId
     * @param {?} appId
     * @param {?} appEntrance
     * @param {?} creationResult
     * @param {?=} extParams
     * @param {?=} reload
     * @param {?=} tabName
     * @param {?=} enableRefresh
     * @param {?=} destructuring
     * @return {?}
     */
    function (tabId, appId, appEntrance, creationResult, extParams, reload, tabName, enableRefresh, destructuring) {
        extParams == null ? {} : extParams;
        /** @type {?} */
        var browser = judgeBrowserType();
        if (browser.type == "IE" && browser.IEVersion == "IE11") {
            //IE11浏览器将生成结果转换为字符串存在top.localStorage，Id为tabId
            // console.log(tabId);
            window.top.localStorage.setItem(tabId, creationResult.ConvertToJson());
            this.navigationService.openApp(tabId, appId, appEntrance, extParams, reload, tabName, enableRefresh, destructuring);
        }
        else {
            this.navigationService.openApp(tabId, appId, appEntrance, this.buildRouteParams(creationResult, extParams), reload, tabName, enableRefresh, destructuring);
        }
    };
    /**
     *
     * @param action 目标App动作
     * @param pairs 其他实体参数键值对
     */
    /**
     *
     * @private
     * @param {?} creationResult
     * @param {?} extParams
     * @return {?}
     */
    BifSourceUiService.prototype.buildRouteParams = /**
     *
     * @private
     * @param {?} creationResult
     * @param {?} extParams
     * @return {?}
     */
    function (creationResult, extParams) {
        /** @type {?} */
        var params = extParams;
        params[this.uiStateKeyCreationResult] = creationResult.ConvertToJson();
        return params;
    };
    BifSourceUiService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    BifSourceUiService.ctorParameters = function () { return [
        { type: NavigationService },
        { type: FrameContext },
        { type: BsModalService },
        { type: MessagerService },
        { type: Injector },
        { type: ComponentFactoryResolver },
        { type: NgModuleFactoryLoader },
        { type: String, decorators: [{ type: Inject, args: [LOCALE_ID,] }] },
        { type: RuntimeFrameworkService, decorators: [{ type: Optional }] }
    ]; };
    return BifSourceUiService;
}(AbstractUiService));
export { BifSourceUiService };
if (false) {
    /**
     * @type {?}
     * @private
     */
    BifSourceUiService.prototype.uiStateKeyCreationResult;
    /**
     * @type {?}
     * @protected
     */
    BifSourceUiService.prototype.navigationService;
    /**
     * @type {?}
     * @protected
     */
    BifSourceUiService.prototype.frameContext;
    /**
     * @type {?}
     * @protected
     */
    BifSourceUiService.prototype.modalService;
    /**
     * @type {?}
     * @protected
     */
    BifSourceUiService.prototype.messager;
    /**
     * @type {?}
     * @protected
     */
    BifSourceUiService.prototype.injector;
    /**
     * @type {?}
     * @protected
     */
    BifSourceUiService.prototype.cfr;
    /**
     * @type {?}
     * @protected
     */
    BifSourceUiService.prototype.loader;
    /** @type {?} */
    BifSourceUiService.prototype.localeId;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmlmLXNvdXJjZS11aS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGVkcC1iaWYvcnVudGltZS1hcGkvIiwic291cmNlcyI6WyJsaWIvYmlmLW1hbnVhbC1jcmVhdGlvbi9zZXJ2aWNlL2JpZi1zb3VyY2UtdWkuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSx3QkFBd0IsRUFBRSxxQkFBcUIsRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNuSSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUMxRCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsdUJBQXVCLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUN0RixPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDOUMsT0FBTyxFQUFFLGNBQWMsRUFBZ0IsTUFBTSxrQkFBa0IsQ0FBQztBQUVoRSxPQUFPLEVBQUUsc0NBQXNDLEVBQUUsTUFBTSwrREFBK0QsQ0FBQztBQUV2SCxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSxxREFBcUQsQ0FBQztBQUU1RixPQUFPLEVBQUUsNkJBQTZCLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDMUQsT0FBTyxFQUFFLCtCQUErQixFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFDL0UsT0FBTyxFQUFFLHFDQUFxQyxFQUFFLE1BQU0sOERBQThELENBQUM7QUFDckgsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sMkNBQTJDLENBQUM7QUFDL0UsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3RELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHlCQUF5QixDQUFBO0FBRTFEO0lBQ3dDLDhDQUFpQjtJQUdyRCw0QkFDYyxpQkFBb0MsRUFDcEMsWUFBMEIsRUFDMUIsWUFBNEIs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eEpZLGtCQUFrQjs7Ozs7O0lBQzNCLHNEQUE0RTs7Ozs7SUFHeEUsK0NBQThDOzs7OztJQUM5QywwQ0FBb0M7Ozs7O0lBQ3BDLDBDQUFzQzs7Ozs7SUFDdEMsc0NBQW1DOzs7OztJQUNuQyxzQ0FBNEI7Ozs7O0lBQzVCLGlDQUF1Qzs7Ozs7SUFDdkMsb0NBQXVDOztJQUN2QyxzQ0FBMEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBJbmplY3RvciwgQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLCBOZ01vZHVsZUZhY3RvcnlMb2FkZXIsIEluamVjdCwgTE9DQUxFX0lELCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBBYnN0cmFjdFVpU2VydmljZSB9IGZyb20gJy4vYWJzdHJhY3QtdWktc2VydmljZSc7XHJcbmltcG9ydCB7IE5hdmlnYXRpb25TZXJ2aWNlLCBSdW50aW1lRnJhbWV3b3JrU2VydmljZSB9IGZyb20gJ0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcyc7XHJcbmltcG9ydCB7IEZyYW1lQ29udGV4dCB9IGZyb20gJ0BmYXJyaXMvZGV2a2l0JztcclxuaW1wb3J0IHsgQnNNb2RhbFNlcnZpY2UsIE1vZGFsT3B0aW9ucyB9IGZyb20gJ0BmYXJyaXMvdWktbW9kYWwnO1xyXG5pbXBvcnQgeyBJUnRTbGltQmlsbENyZWF0aW9uUHJvY2Vzc0VudGl0eUV4IH0gZnJvbSAnQGVkcC1iaWYvY29tbW9uLWFwaSc7XHJcbmltcG9ydCB7IEZvcm1HZXRCaWxsQ3JlYXRpb25Qcm9jZXNzRW50aXR5RXhBcmdzIH0gZnJvbSAnLi4vLi4vZW50aXR5L2Zvcm0tcmVzdC9Gb3JtR2V0QmlsbENyZWF0aW9uUHJvY2Vzc0VudGl0eUV4QXJncyc7XHJcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgUHVzaFNlbGVjdG9yQ29tcG9uZW50IH0gZnJvbSAnLi4vY29tcG9uZW50cy9wdXNoLXNlbGVjdG9yL3B1c2gtc2VsZWN0b3IuY29tcG9uZW50JztcclxuaW1wb3J0IHsgRm9ybVNldHRpbmdzIH0gZnJvbSAnQGVkcC1haWYvY29tbW9uLWFwaSc7XHJcbmltcG9ydCB7IFJwY0NyZWF0aW9uUnVsZUV4ZWN1dG9yUmVzdWx0IH0gZnJvbSAnLi4vLi4vcmVmJztcclxuaW1wb3J0IHsgQklGX1VJU1RBVEVfS0VZX0NSRUFUSU9OX1JFU1VMVCB9IGZyb20gJy4uL2NvbmZpZy9iaWYtZm9ybS1jb25zdGFudHMnO1xyXG5pbXBvcnQgeyBGb3JtQmlsbENyZWF0aW9uUHJvY2Vzc0V4ZWN1dG9yUmVzdWx0IH0gZnJvbSAnLi4vLi4vZW50aXR5L2Zvcm0tcmVzdC9Gb3JtQmlsbENyZWF0aW9uUHJvY2Vzc0V4ZWN1dG9yUmVzdWx0JztcclxuaW1wb3J0IHsgTWFudWFsQ3JlYXRpb25Nb2RlIH0gZnJvbSAnLi4vLi4vZW50aXR5L2Zvcm0tcmVzdC9NYW51YWxDcmVhdGlvbk1vZGUnO1xyXG5pbXBvcnQgeyBNZXNzYWdlclNlcnZpY2UgfSBmcm9tICdAZmFycmlzL3VpLW1lc3NhZ2VyJztcclxuaW1wb3J0IHsganVkZ2VCcm93c2VyVHlwZSB9IGZyb20gXCIuLi8uLi91dGlscy9Ccm93c2VyVXRpbFwiXHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBCaWZTb3VyY2VVaVNlcnZpY2UgZXh0ZW5kcyBBYnN0cmFjdFVpU2VydmljZSB7XHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IHVpU3RhdGVLZXlDcmVhdGlvblJlc3VsdCA9IEJJRl9VSVNUQVRFX0tFWV9DUkVBVElPTl9SRVNVTFQ7XHJcblxyXG4gICAgY29uc3RydWN0b3IoXHJcbiAgICAgICAgcHJvdGVjdGVkIG5hdmlnYXRpb25TZXJ2aWNlOiBOYXZpZ2F0aW9uU2VydmljZSxcclxuICAgICAgICBwcm90ZWN0ZWQgZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQsXHJcbiAgICAgICAgcHJvdGVjdGVkIG1vZGFsU2VydmljZTogQnNNb2RhbFNlcnZpY2UsXHJcbiAgICAgICAgcHJvdGVjdGVkIG1lc3NhZ2VyOiBNZXNzYWdlclNlcnZpY2UsXHJcbiAgICAgICAgcHJvdGVjdGVkIGluamVjdG9yOiBJbmplY3RvcixcclxuICAgICAgICBwcm90ZWN0ZWQgY2ZyOiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXHJcbiAgICAgICAgcHJvdGVjdGVkIGxvYWRlcjogTmdNb2R1bGVGYWN0b3J5TG9hZGVyLFxyXG4gICAgICAgIEBJbmplY3QoTE9DQUxFX0lEKSBwdWJsaWMgbG9jYWxlSWQ6IHN0cmluZyxcclxuICAgICAgICBAT3B0aW9uYWwoKSBydW50aW1lRnJhbWV3b3JrU2VydmljZTogUnVudGltZUZyYW1ld29ya1NlcnZpY2UsXHJcbiAgICApIHtcclxuICAgICAgICBzdXBlcihmcmFtZUNvbnRleHQsIG1vZGFsU2VydmljZSwgbWVzc2FnZXIsIGluamVjdG9yLCBjZnIsIGxvYWRlciwgbG9jYWxlSWQsIHJ1bnRpbWVGcmFtZXdvcmtTZXJ2aWNlKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOS4i+aOqOaXtuaJk+W8gOeUn+WNleinhOWImemAieaLqeWZqFxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgb3BlbkJpbGxDcmVhdGlvblByb2Nlc3NTZWxlY3RvcjRQdXNoKHVwQmlsbFZvSWQ6IHN0cmluZywgYml6Rmxvd2NoYXJ0SWQ/OiBzdHJpbmcsIG1vZGFsT3B0aW9ucz86IE1vZGFsT3B0aW9ucywgY3VzdG9tU2VsZWN0b3JNb2R1bGVVcmw/OiBzdHJpbmcsIGV4dFBhcmFtcz86IHt9KTogT2JzZXJ2YWJsZTxJUnRTbGltQmlsbENyZWF0aW9uUHJvY2Vzc0VudGl0eUV4PiB7XHJcbiAgICAgICAgY29uc3QgYXJncyA9IG5ldyBGb3JtR2V0QmlsbENyZWF0aW9uUHJvY2Vzc0VudGl0eUV4QXJncygpO1xyXG4gICAgICAgIGFyZ3MudXBCaWxsVm9JZCA9IHVwQmlsbFZvSWQ7XHJcbiAgICAgICAgYXJncy5tYW51YWxDcmVhdGlvbk1vZGUgPSBNYW51YWxDcmVhdGlvbk1vZGUuUHVzaDtcclxuXHJcbiAgICAgICAgcmV0dXJuIHRoaXMub3BlbkJpbGxDcmVhdGlvblByb2Nlc3NTZWxlY3RvcihhcmdzLCBQdXNoU2VsZWN0b3JDb21wb25lbnQsIG1vZGFsT3B0aW9ucywgY3VzdG9tU2VsZWN0b3JNb2R1bGVVcmwsIGV4dFBhcmFtcyk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDnibnlrprkuIvmjqjml7bmiZPlvIDnlJ/ljZXop4TliJnpgInmi6nlmahcclxuICAgICAqL1xyXG4gICAgcHVibGljIG9wZW5CaWxsQ3JlYXRpb25Qcm9jZXNzU2VsZWN0b3I0U3BlY2lmaWNQdXNoKHVwQmlsbFZvSWQ6IHN0cmluZywgZG93bkJpbGxWb0lkOiBzdHJpbmcsIGJpekZsb3djaGFydElkPzogc3RyaW5nLCBtb2RhbE9wdGlvbnM/OiBNb2RhbE9wdGlvbnMsIGN1c3RvbVNlbGVjdG9yTW9kdWxlVXJsPzogc3RyaW5nLCBleHRQYXJhbXM/OiB7fSk6IE9ic2VydmFibGU8SVJ0U2xpbUJpbGxDcmVhdGlvblByb2Nlc3NFbnRpdHlFeD4ge1xyXG4gICAgICAgIGNvbnN0IGFyZ3MgPSBuZXcgRm9ybUdldEJpbGxDcmVhdGlvblByb2Nlc3NFbnRpdHlFeEFyZ3MoKTtcclxuICAgICAgICBhcmdzLnVwQmlsbFZvSWQgPSB1cEJpbGxWb0lkO1xyXG4gICAgICAgIGFyZ3MuZG93bkJpbGxWb0lkID0gZG93bkJpbGxWb0lkO1xyXG4gICAgICAgIGFyZ3MubWFudWFsQ3JlYXRpb25Nb2RlID0gTWFudWFsQ3JlYXRpb25Nb2RlLlNwZWNpZmljUHVzaDtcclxuICAgICAgICAvLyBhcmdzLmJpekZsb3djaGFydElkID0gYml6Rmxvd2NoYXJ0SWQ7XHJcblxyXG4gICAgICAgIHJldHVybiB0aGlzLm9wZW5CaWxsQ3JlYXRpb25Qcm9jZXNzU2VsZWN0b3IoYXJncywgUHVzaFNlbGVjdG9yQ29tcG9uZW50LCBtb2RhbE9wdGlvbnMsIGN1c3RvbVNlbGVjdG9yTW9kdWxlVXJsLCBleHRQYXJhbXMpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5omT5byA5LiL5ri45Y2V5o2u5Yi25Y2V55WM6Z2iXHJcbiAgICAgKiBAcGFyYW0gZm9ybVNldHRpbmdzIFxyXG4gICAgICogQHBhcmFtIGNyZWF0aW9uUmVzdWx0IFxyXG4gICAgICogQHBhcmFtIGV4dFBhcmFtcyBcclxuICAgICAqL1xyXG4gICAgcHVibGljIG9wZW5UYXJnZXRGb3JtKGZvcm1TZXR0aW5nczogRm9ybVNldHRpbmdzLCBjcmVhdGlvblJlc3VsdDogRm9ybUJpbGxDcmVhdGlvblByb2Nlc3NFeGVjdXRvclJlc3VsdCwgZXh0UGFyYW1zPzoge30pOiB2b2lkIHtcclxuICAgICAgICBpZiAoZm9ybVNldHRpbmdzID09IG51bGwpIHtcclxuICAgICAgICAgICAgdGhyb3cgXCLlj4LmlbBmb3JtU2V0dGluZ3PkuI3lj6/kuLrnqbpcIjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGNyZWF0aW9uUmVzdWx0ID09IG51bGwpIHtcclxuICAgICAgICAgICAgdGhyb3cgXCLlj4LmlbBjcmVhdGlvblJlc3VsdOS4jeWPr+S4uuepulwiO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodHlwZW9mIGNyZWF0aW9uUmVzdWx0ID09IFwic3RyaW5nXCIpIHtcclxuICAgICAgICAgICAgaWYgKGNyZWF0aW9uUmVzdWx0ID09IFwiXCIpIHtcclxuICAgICAgICAgICAgICAgIHRocm93IFwi5Y+C5pWwY3JlYXRpb25SZXN1bHTkuI3lj6/kuLrnqbpcIjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zdCB0ZW1wID0gbmV3IEZvcm1CaWxsQ3JlYXRpb25Qcm9jZXNzRXhlY3V0b3JSZXN1bHQoKTtcclxuICAgICAgICAgICAgdGVtcC5Mb2FkRnJvbUpzb24oY3JlYXRpb25SZXN1bHQpO1xyXG4gICAgICAgICAgICBjcmVhdGlvblJlc3VsdCA9IHRlbXA7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICgoY3JlYXRpb25SZXN1bHQgaW5zdGFuY2VvZiBGb3JtQmlsbENyZWF0aW9uUHJvY2Vzc0V4ZWN1dG9yUmVzdWx0KSA9PSBmYWxzZSkge1xyXG4gICAgICAgICAgICBjb25zdCByZXMgPSBuZXcgRm9ybUJpbGxDcmVhdGlvblByb2Nlc3NFeGVjdXRvclJlc3VsdCgpO1xyXG4gICAgICAgICAgICByZXMuTG9hZEZyb21Kc29uT2JqZWN0KGNyZWF0aW9uUmVzdWx0KTtcclxuICAgICAgICAgICAgY3JlYXRpb25SZXN1bHQgPSByZXM7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoY3JlYXRpb25SZXN1bHQuY29uZGl0aW9uUmVzdWx0LmNvbmRpdGlvbkV4ZWN1dGlvblJlc3VsdCA9PSBmYWxzZSkge1xyXG4gICAgICAgICAgICB0aGlzLm1lc3NhZ2VyLmVycm9yKGNyZWF0aW9uUmVzdWx0LmNvbmRpdGlvblJlc3VsdC5tZXNzYWdlIHx8IHRoaXMubG9jYWxlUGlwZS50cmFuc2Zvcm0oXCJjcmVhdGlvbkV4ZWN1dGlvbkVycm9yXCIpKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKGNyZWF0aW9uUmVzdWx0LmNyZWF0aW9uUnVsZUV4ZWN1dG9yUmVzdWx0ID09IG51bGwgfHwgY3JlYXRpb25SZXN1bHQuY3JlYXRpb25SdWxlRXhlY3V0b3JSZXN1bHQubWFwcGluZ1Jlc3VsdHMgPT0gbnVsbCB8fCBjcmVhdGlvblJlc3VsdC5jcmVhdGlvblJ1bGVFeGVjdXRvclJlc3VsdC5tYXBwaW5nUmVzdWx0cy5sZW5ndGggPT0gMCkge1xyXG4gICAgICAgICAgICB0aGlzLm1lc3NhZ2VyLmVycm9yKHRoaXMubG9jYWxlUGlwZS50cmFuc2Zvcm0oXCJjcmVhdGlvblJlc3VsdEVtcHR5XCIpKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoY3JlYXRpb25SZXN1bHQuY3JlYXRpb25SdWxlRXhlY3V0b3JSZXN1bHQubWFwcGluZ1Jlc3VsdHMubGVuZ3RoID09IDEpIHtcclxuICAgICAgICAgICAgLy/lj6rmnInkuIDmnaHmlbDmja7liJnmiZPlvIDljaHniYdcclxuICAgICAgICAgICAgdGhpcy5vcGVuQXBwKFxyXG4gICAgICAgICAgICAgICAgY3JlYXRpb25SZXN1bHQuY3JlYXRpb25SdWxlRXhlY3V0b3JSZXN1bHQubWFwcGluZ1Jlc3VsdHNbMF0uYXNzb2NpYXRpb25zWzBdLnRhckRhdGFJZCxcclxuICAgICAgICAgICAgICAgIGZvcm1TZXR0aW5ncy50YXJnZXRDYXJkQXBwSWQsXHJcbiAgICAgICAgICAgICAgICBmb3JtU2V0dGluZ3MudGFyZ2V0Q2FyZEFwcEVudHJhbmNlLFxyXG4gICAgICAgICAgICAgICAgY3JlYXRpb25SZXN1bHQsXHJcbiAgICAgICAgICAgICAgICBleHRQYXJhbXMsXHJcbiAgICAgICAgICAgICAgICBmYWxzZVxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlmIChmb3JtU2V0dGluZ3MudGFyZ2V0TGlzdEFwcElkICE9IG51bGwpIHtcclxuICAgICAgICAgICAgICAgIC8vIOWkmuadoeaVsOaNruS4lOmFjee9ruaJuemHj+e8lui+keeVjOmdolxyXG4gICAgICAgICAgICAgICAgdGhyb3cgXCLmmoLkuI3mlK/mjIHmiZPlvIDmibnph4/nvJbovpHnlYzpnaJcIjtcclxuICAgICAgICAgICAgICAgIHRoaXMub3BlbkFwcChcclxuICAgICAgICAgICAgICAgICAgICBjcmVhdGlvblJlc3VsdC5jcmVhdGlvblJ1bGVFeGVjdXRvclJlc3VsdC5tYXBwaW5nUmVzdWx0c1swXS5hc3NvY2lhdGlvbnNbMF0udGFyRGF0YUlkLFxyXG4gICAgICAgICAgICAgICAgICAgIGZvcm1TZXR0aW5ncy50YXJnZXRMaXN0QXBwSWQsXHJcbiAgICAgICAgICAgICAgICAgICAgZm9ybVNldHRpbmdzLnRhcmdldExpc3RBcHBFbnRyYW5jZSxcclxuICAgICAgICAgICAgICAgICAgICBjcmVhdGlvblJlc3VsdCxcclxuICAgICAgICAgICAgICAgICAgICBleHRQYXJhbXMsXHJcbiAgICAgICAgICAgICAgICAgICAgZmFsc2VcclxuICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAvL+acieWkmuadoeaVsOaNruS9huacqumFjee9ruaJuemHj+e8lui+keeVjOmdouWImeaJk+W8gOWkmuS4quWNoeeJh1xyXG4gICAgICAgICAgICAgICAgZm9yIChsZXQgbWFwcGluZ1Jlc3VsdCBvZiBjcmVhdGlvblJlc3VsdC5jcmVhdGlvblJ1bGVFeGVjdXRvclJlc3VsdC5tYXBwaW5nUmVzdWx0cykge1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCBzaW5nbGVSZXMgPSBuZXcgRm9ybUJpbGxDcmVhdGlvblByb2Nlc3NFeGVjdXRvclJlc3VsdCgpO1xyXG4gICAgICAgICAgICAgICAgICAgIHNpbmdsZVJlcy5jb25kaXRpb25SZXN1bHQgPSBjcmVhdGlvblJlc3VsdC5jb25kaXRpb25SZXN1bHQ7XHJcbiAgICAgICAgICAgICAgICAgICAgc2luZ2xlUmVzLmNyZWF0aW9uUnVsZUV4ZWN1dG9yUmVzdWx0ID0gbmV3IFJwY0NyZWF0aW9uUnVsZUV4ZWN1dG9yUmVzdWx0KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgc2luZ2xlUmVzLmNyZWF0aW9uUnVsZUV4ZWN1dG9yUmVzdWx0LmJpekZsb3djaGFydElkID0gY3JlYXRpb25SZXN1bHQuY3JlYXRpb25SdWxlRXhlY3V0b3JSZXN1bHQuYml6Rmxvd2NoYXJ0SWQ7XHJcbiAgICAgICAgICAgICAgICAgICAgc2luZ2xlUmVzLmNyZWF0aW9uUnVsZUV4ZWN1dG9yUmVzdWx0LmNyZWF0aW9uUnVsZUlkID0gY3JlYXRpb25SZXN1bHQuY3JlYXRpb25SdWxlRXhlY3V0b3JSZXN1bHQuY3JlYXRpb25SdWxlSWQ7XHJcbiAgICAgICAgICAgICAgICAgICAgc2luZ2xlUmVzLmNyZWF0aW9uUnVsZUV4ZWN1dG9yUmVzdWx0LmNyZWF0aW9uUnVsZUluc3RhbmNlSWQgPSBjcmVhdGlvblJlc3VsdC5jcmVhdGlvblJ1bGVFeGVjdXRvclJlc3VsdC5jcmVhdGlvblJ1bGVJbnN0YW5jZUlkO1xyXG4gICAgICAgICAgICAgICAgICAgIHNpbmdsZVJlcy5jcmVhdGlvblJ1bGVFeGVjdXRvclJlc3VsdC5tYXBwaW5nUmVzdWx0cyA9IFttYXBwaW5nUmVzdWx0XTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5vcGVuQXBwKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBtYXBwaW5nUmVzdWx0LmFzc29jaWF0aW9uc1swXS50YXJEYXRhSWQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1TZXR0aW5ncy50YXJnZXRDYXJkQXBwSWQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1TZXR0aW5ncy50YXJnZXRDYXJkQXBwRW50cmFuY2UsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNpbmdsZVJlcyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgZXh0UGFyYW1zLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBmYWxzZVxyXG4gICAgICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBvcGVuQXBwKHRhYklkOiBzdHJpbmcsIGFwcElkOiBzdHJpbmcsIGFwcEVudHJhbmNlOiBzdHJpbmcsIGNyZWF0aW9uUmVzdWx0OiBGb3JtQmlsbENyZWF0aW9uUHJvY2Vzc0V4ZWN1dG9yUmVzdWx0LCBleHRQYXJhbXM/OiB7fSwgcmVsb2FkPzogYm9vbGVhbiwgdGFiTmFtZT86IHN0cmluZywgZW5hYmxlUmVmcmVzaD86IGFueSwgZGVzdHJ1Y3R1cmluZz86IGFueSk6IHZvaWQge1xyXG4gICAgICAgIGV4dFBhcmFtcyA9PSBudWxsID8ge30gOiBleHRQYXJhbXM7XHJcbiAgICAgICAgY29uc3QgYnJvd3NlciA9IGp1ZGdlQnJvd3NlclR5cGUoKTtcclxuICAgICAgICBpZiAoYnJvd3Nlci50eXBlID09IFwiSUVcIiAmJiBicm93c2VyLklFVmVyc2lvbiA9PSBcIklFMTFcIikge1xyXG4gICAgICAgICAgICAvL0lFMTHmtY/op4jlmajlsIbnlJ/miJDnu5PmnpzovazmjaLkuLrlrZfnrKbkuLLlrZjlnKh0b3AubG9jYWxTdG9yYWdl77yMSWTkuLp0YWJJZFxyXG4gICAgICAgICAgICAvLyBjb25zb2xlLmxvZyh0YWJJZCk7XHJcbiAgICAgICAgICAgIHdpbmRvdy50b3AubG9jYWxTdG9yYWdlLnNldEl0ZW0odGFiSWQsIGNyZWF0aW9uUmVzdWx0LkNvbnZlcnRUb0pzb24oKSk7XHJcbiAgICAgICAgICAgIHRoaXMubmF2aWdhdGlvblNlcnZpY2Uub3BlbkFwcChcclxuICAgICAgICAgICAgICAgIHRhYklkLCBhcHBJZCwgYXBwRW50cmFuY2UsIGV4dFBhcmFtcywgcmVsb2FkLCB0YWJOYW1lLCBlbmFibGVSZWZyZXNoLCBkZXN0cnVjdHVyaW5nXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5uYXZpZ2F0aW9uU2VydmljZS5vcGVuQXBwKFxyXG4gICAgICAgICAgICAgICAgdGFiSWQsIGFwcElkLCBhcHBFbnRyYW5jZSxcclxuICAgICAgICAgICAgICAgIHRoaXMuYnVpbGRSb3V0ZVBhcmFtcyhjcmVhdGlvblJlc3VsdCwgZXh0UGFyYW1zKSxcclxuICAgICAgICAgICAgICAgIHJlbG9hZCwgdGFiTmFtZSwgZW5hYmxlUmVmcmVzaCwgZGVzdHJ1Y3R1cmluZ1xyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIFxyXG4gICAgICogQHBhcmFtIGFjdGlvbiDnm67moIdBcHDliqjkvZxcclxuICAgICAqIEBwYXJhbSBwYWlycyDlhbbku5blrp7kvZPlj4LmlbDplK7lgLzlr7lcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBidWlsZFJvdXRlUGFyYW1zKGNyZWF0aW9uUmVzdWx0OiBGb3JtQmlsbENyZWF0aW9uUHJvY2Vzc0V4ZWN1dG9yUmVzdWx0LCBleHRQYXJhbXM6IHt9KToge30ge1xyXG4gICAgICAgIGNvbnN0IHBhcmFtcyA9IGV4dFBhcmFtcztcclxuICAgICAgICBwYXJhbXNbdGhpcy51aVN0YXRlS2V5Q3JlYXRpb25SZXN1bHRdID0gY3JlYXRpb25SZXN1bHQuQ29udmVydFRvSnNvbigpO1xyXG5cclxuICAgICAgICByZXR1cm4gcGFyYW1zO1xyXG4gICAgfVxyXG59Il19